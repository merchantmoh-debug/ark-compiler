var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function s(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var s=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};s.prototype=t.prototype}else s={};return Object.defineProperty(s,"__esModule",{value:!0}),Object.keys(e).forEach(function(t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(s,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})}),s}function r(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var n={exports:{}},i=s(Object.freeze({__proto__:null,default:{}}));!function(e){var t=function(e){var t,s=new Float64Array(16);if(e)for(t=0;t<e.length;t++)s[t]=e[t];return s},s=function(){throw new Error("no PRNG")},n=new Uint8Array(16),o=new Uint8Array(32);o[0]=9;var a=t(),c=t([1]),l=t([56129,1]),h=t([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),u=t([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),d=t([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),p=t([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),f=t([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function g(e,t,s,r){e[t]=s>>24&255,e[t+1]=s>>16&255,e[t+2]=s>>8&255,e[t+3]=255&s,e[t+4]=r>>24&255,e[t+5]=r>>16&255,e[t+6]=r>>8&255,e[t+7]=255&r}function m(e,t,s,r,n){var i,o=0;for(i=0;i<n;i++)o|=e[t+i]^s[r+i];return(1&o-1>>>8)-1}function y(e,t,s,r){return m(e,t,s,r,16)}function b(e,t,s,r){return m(e,t,s,r,32)}function w(e,t,s,r){!function(e,t,s,r){for(var n,i=255&r[0]|(255&r[1])<<8|(255&r[2])<<16|(255&r[3])<<24,o=255&s[0]|(255&s[1])<<8|(255&s[2])<<16|(255&s[3])<<24,a=255&s[4]|(255&s[5])<<8|(255&s[6])<<16|(255&s[7])<<24,c=255&s[8]|(255&s[9])<<8|(255&s[10])<<16|(255&s[11])<<24,l=255&s[12]|(255&s[13])<<8|(255&s[14])<<16|(255&s[15])<<24,h=255&r[4]|(255&r[5])<<8|(255&r[6])<<16|(255&r[7])<<24,u=255&t[0]|(255&t[1])<<8|(255&t[2])<<16|(255&t[3])<<24,d=255&t[4]|(255&t[5])<<8|(255&t[6])<<16|(255&t[7])<<24,p=255&t[8]|(255&t[9])<<8|(255&t[10])<<16|(255&t[11])<<24,f=255&t[12]|(255&t[13])<<8|(255&t[14])<<16|(255&t[15])<<24,g=255&r[8]|(255&r[9])<<8|(255&r[10])<<16|(255&r[11])<<24,m=255&s[16]|(255&s[17])<<8|(255&s[18])<<16|(255&s[19])<<24,y=255&s[20]|(255&s[21])<<8|(255&s[22])<<16|(255&s[23])<<24,b=255&s[24]|(255&s[25])<<8|(255&s[26])<<16|(255&s[27])<<24,w=255&s[28]|(255&s[29])<<8|(255&s[30])<<16|(255&s[31])<<24,v=255&r[12]|(255&r[13])<<8|(255&r[14])<<16|(255&r[15])<<24,S=i,E=o,D=a,_=c,T=l,I=h,C=u,P=d,x=p,A=f,k=g,N=m,R=y,M=b,L=w,O=v,B=0;B<20;B+=2)S^=(n=(R^=(n=(x^=(n=(T^=(n=S+R|0)<<7|n>>>25)+S|0)<<9|n>>>23)+T|0)<<13|n>>>19)+x|0)<<18|n>>>14,I^=(n=(E^=(n=(M^=(n=(A^=(n=I+E|0)<<7|n>>>25)+I|0)<<9|n>>>23)+A|0)<<13|n>>>19)+M|0)<<18|n>>>14,k^=(n=(C^=(n=(D^=(n=(L^=(n=k+C|0)<<7|n>>>25)+k|0)<<9|n>>>23)+L|0)<<13|n>>>19)+D|0)<<18|n>>>14,O^=(n=(N^=(n=(P^=(n=(_^=(n=O+N|0)<<7|n>>>25)+O|0)<<9|n>>>23)+_|0)<<13|n>>>19)+P|0)<<18|n>>>14,S^=(n=(_^=(n=(D^=(n=(E^=(n=S+_|0)<<7|n>>>25)+S|0)<<9|n>>>23)+E|0)<<13|n>>>19)+D|0)<<18|n>>>14,I^=(n=(T^=(n=(P^=(n=(C^=(n=I+T|0)<<7|n>>>25)+I|0)<<9|n>>>23)+C|0)<<13|n>>>19)+P|0)<<18|n>>>14,k^=(n=(A^=(n=(x^=(n=(N^=(n=k+A|0)<<7|n>>>25)+k|0)<<9|n>>>23)+N|0)<<13|n>>>19)+x|0)<<18|n>>>14,O^=(n=(L^=(n=(M^=(n=(R^=(n=O+L|0)<<7|n>>>25)+O|0)<<9|n>>>23)+R|0)<<13|n>>>19)+M|0)<<18|n>>>14;S=S+i|0,E=E+o|0,D=D+a|0,_=_+c|0,T=T+l|0,I=I+h|0,C=C+u|0,P=P+d|0,x=x+p|0,A=A+f|0,k=k+g|0,N=N+m|0,R=R+y|0,M=M+b|0,L=L+w|0,O=O+v|0,e[0]=S>>>0&255,e[1]=S>>>8&255,e[2]=S>>>16&255,e[3]=S>>>24&255,e[4]=E>>>0&255,e[5]=E>>>8&255,e[6]=E>>>16&255,e[7]=E>>>24&255,e[8]=D>>>0&255,e[9]=D>>>8&255,e[10]=D>>>16&255,e[11]=D>>>24&255,e[12]=_>>>0&255,e[13]=_>>>8&255,e[14]=_>>>16&255,e[15]=_>>>24&255,e[16]=T>>>0&255,e[17]=T>>>8&255,e[18]=T>>>16&255,e[19]=T>>>24&255,e[20]=I>>>0&255,e[21]=I>>>8&255,e[22]=I>>>16&255,e[23]=I>>>24&255,e[24]=C>>>0&255,e[25]=C>>>8&255,e[26]=C>>>16&255,e[27]=C>>>24&255,e[28]=P>>>0&255,e[29]=P>>>8&255,e[30]=P>>>16&255,e[31]=P>>>24&255,e[32]=x>>>0&255,e[33]=x>>>8&255,e[34]=x>>>16&255,e[35]=x>>>24&255,e[36]=A>>>0&255,e[37]=A>>>8&255,e[38]=A>>>16&255,e[39]=A>>>24&255,e[40]=k>>>0&255,e[41]=k>>>8&255,e[42]=k>>>16&255,e[43]=k>>>24&255,e[44]=N>>>0&255,e[45]=N>>>8&255,e[46]=N>>>16&255,e[47]=N>>>24&255,e[48]=R>>>0&255,e[49]=R>>>8&255,e[50]=R>>>16&255,e[51]=R>>>24&255,e[52]=M>>>0&255,e[53]=M>>>8&255,e[54]=M>>>16&255,e[55]=M>>>24&255,e[56]=L>>>0&255,e[57]=L>>>8&255,e[58]=L>>>16&255,e[59]=L>>>24&255,e[60]=O>>>0&255,e[61]=O>>>8&255,e[62]=O>>>16&255,e[63]=O>>>24&255}(e,t,s,r)}function v(e,t,s,r){!function(e,t,s,r){for(var n,i=255&r[0]|(255&r[1])<<8|(255&r[2])<<16|(255&r[3])<<24,o=255&s[0]|(255&s[1])<<8|(255&s[2])<<16|(255&s[3])<<24,a=255&s[4]|(255&s[5])<<8|(255&s[6])<<16|(255&s[7])<<24,c=255&s[8]|(255&s[9])<<8|(255&s[10])<<16|(255&s[11])<<24,l=255&s[12]|(255&s[13])<<8|(255&s[14])<<16|(255&s[15])<<24,h=255&r[4]|(255&r[5])<<8|(255&r[6])<<16|(255&r[7])<<24,u=255&t[0]|(255&t[1])<<8|(255&t[2])<<16|(255&t[3])<<24,d=255&t[4]|(255&t[5])<<8|(255&t[6])<<16|(255&t[7])<<24,p=255&t[8]|(255&t[9])<<8|(255&t[10])<<16|(255&t[11])<<24,f=255&t[12]|(255&t[13])<<8|(255&t[14])<<16|(255&t[15])<<24,g=255&r[8]|(255&r[9])<<8|(255&r[10])<<16|(255&r[11])<<24,m=255&s[16]|(255&s[17])<<8|(255&s[18])<<16|(255&s[19])<<24,y=255&s[20]|(255&s[21])<<8|(255&s[22])<<16|(255&s[23])<<24,b=255&s[24]|(255&s[25])<<8|(255&s[26])<<16|(255&s[27])<<24,w=255&s[28]|(255&s[29])<<8|(255&s[30])<<16|(255&s[31])<<24,v=255&r[12]|(255&r[13])<<8|(255&r[14])<<16|(255&r[15])<<24,S=0;S<20;S+=2)i^=(n=(y^=(n=(p^=(n=(l^=(n=i+y|0)<<7|n>>>25)+i|0)<<9|n>>>23)+l|0)<<13|n>>>19)+p|0)<<18|n>>>14,h^=(n=(o^=(n=(b^=(n=(f^=(n=h+o|0)<<7|n>>>25)+h|0)<<9|n>>>23)+f|0)<<13|n>>>19)+b|0)<<18|n>>>14,g^=(n=(u^=(n=(a^=(n=(w^=(n=g+u|0)<<7|n>>>25)+g|0)<<9|n>>>23)+w|0)<<13|n>>>19)+a|0)<<18|n>>>14,v^=(n=(m^=(n=(d^=(n=(c^=(n=v+m|0)<<7|n>>>25)+v|0)<<9|n>>>23)+c|0)<<13|n>>>19)+d|0)<<18|n>>>14,i^=(n=(c^=(n=(a^=(n=(o^=(n=i+c|0)<<7|n>>>25)+i|0)<<9|n>>>23)+o|0)<<13|n>>>19)+a|0)<<18|n>>>14,h^=(n=(l^=(n=(d^=(n=(u^=(n=h+l|0)<<7|n>>>25)+h|0)<<9|n>>>23)+u|0)<<13|n>>>19)+d|0)<<18|n>>>14,g^=(n=(f^=(n=(p^=(n=(m^=(n=g+f|0)<<7|n>>>25)+g|0)<<9|n>>>23)+m|0)<<13|n>>>19)+p|0)<<18|n>>>14,v^=(n=(w^=(n=(b^=(n=(y^=(n=v+w|0)<<7|n>>>25)+v|0)<<9|n>>>23)+y|0)<<13|n>>>19)+b|0)<<18|n>>>14;e[0]=i>>>0&255,e[1]=i>>>8&255,e[2]=i>>>16&255,e[3]=i>>>24&255,e[4]=h>>>0&255,e[5]=h>>>8&255,e[6]=h>>>16&255,e[7]=h>>>24&255,e[8]=g>>>0&255,e[9]=g>>>8&255,e[10]=g>>>16&255,e[11]=g>>>24&255,e[12]=v>>>0&255,e[13]=v>>>8&255,e[14]=v>>>16&255,e[15]=v>>>24&255,e[16]=u>>>0&255,e[17]=u>>>8&255,e[18]=u>>>16&255,e[19]=u>>>24&255,e[20]=d>>>0&255,e[21]=d>>>8&255,e[22]=d>>>16&255,e[23]=d>>>24&255,e[24]=p>>>0&255,e[25]=p>>>8&255,e[26]=p>>>16&255,e[27]=p>>>24&255,e[28]=f>>>0&255,e[29]=f>>>8&255,e[30]=f>>>16&255,e[31]=f>>>24&255}(e,t,s,r)}var S=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function E(e,t,s,r,n,i,o){var a,c,l=new Uint8Array(16),h=new Uint8Array(64);for(c=0;c<16;c++)l[c]=0;for(c=0;c<8;c++)l[c]=i[c];for(;n>=64;){for(w(h,l,o,S),c=0;c<64;c++)e[t+c]=s[r+c]^h[c];for(a=1,c=8;c<16;c++)a=a+(255&l[c])|0,l[c]=255&a,a>>>=8;n-=64,t+=64,r+=64}if(n>0)for(w(h,l,o,S),c=0;c<n;c++)e[t+c]=s[r+c]^h[c];return 0}function D(e,t,s,r,n){var i,o,a=new Uint8Array(16),c=new Uint8Array(64);for(o=0;o<16;o++)a[o]=0;for(o=0;o<8;o++)a[o]=r[o];for(;s>=64;){for(w(c,a,n,S),o=0;o<64;o++)e[t+o]=c[o];for(i=1,o=8;o<16;o++)i=i+(255&a[o])|0,a[o]=255&i,i>>>=8;s-=64,t+=64}if(s>0)for(w(c,a,n,S),o=0;o<s;o++)e[t+o]=c[o];return 0}function _(e,t,s,r,n){var i=new Uint8Array(32);v(i,r,n,S);for(var o=new Uint8Array(8),a=0;a<8;a++)o[a]=r[a+16];return D(e,t,s,o,i)}function T(e,t,s,r,n,i,o){var a=new Uint8Array(32);v(a,i,o,S);for(var c=new Uint8Array(8),l=0;l<8;l++)c[l]=i[l+16];return E(e,t,s,r,n,c,a)}var I=function(e){var t,s,r,n,i,o,a,c;this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.leftover=0,this.fin=0,t=255&e[0]|(255&e[1])<<8,this.r[0]=8191&t,s=255&e[2]|(255&e[3])<<8,this.r[1]=8191&(t>>>13|s<<3),r=255&e[4]|(255&e[5])<<8,this.r[2]=7939&(s>>>10|r<<6),n=255&e[6]|(255&e[7])<<8,this.r[3]=8191&(r>>>7|n<<9),i=255&e[8]|(255&e[9])<<8,this.r[4]=255&(n>>>4|i<<12),this.r[5]=i>>>1&8190,o=255&e[10]|(255&e[11])<<8,this.r[6]=8191&(i>>>14|o<<2),a=255&e[12]|(255&e[13])<<8,this.r[7]=8065&(o>>>11|a<<5),c=255&e[14]|(255&e[15])<<8,this.r[8]=8191&(a>>>8|c<<8),this.r[9]=c>>>5&127,this.pad[0]=255&e[16]|(255&e[17])<<8,this.pad[1]=255&e[18]|(255&e[19])<<8,this.pad[2]=255&e[20]|(255&e[21])<<8,this.pad[3]=255&e[22]|(255&e[23])<<8,this.pad[4]=255&e[24]|(255&e[25])<<8,this.pad[5]=255&e[26]|(255&e[27])<<8,this.pad[6]=255&e[28]|(255&e[29])<<8,this.pad[7]=255&e[30]|(255&e[31])<<8};function C(e,t,s,r,n,i){var o=new I(i);return o.update(s,r,n),o.finish(e,t),0}function P(e,t,s,r,n,i){var o=new Uint8Array(16);return C(o,0,s,r,n,i),y(e,t,o,0)}function x(e,t,s,r,n){var i;if(s<32)return-1;for(T(e,0,t,0,s,r,n),C(e,16,e,32,s-32,e),i=0;i<16;i++)e[i]=0;return 0}function A(e,t,s,r,n){var i,o=new Uint8Array(32);if(s<32)return-1;if(_(o,0,32,r,n),0!==P(t,16,t,32,s-32,o))return-1;for(T(e,0,t,0,s,r,n),i=0;i<32;i++)e[i]=0;return 0}function k(e,t){var s;for(s=0;s<16;s++)e[s]=0|t[s]}function N(e){var t,s,r=1;for(t=0;t<16;t++)s=e[t]+r+65535,r=Math.floor(s/65536),e[t]=s-65536*r;e[0]+=r-1+37*(r-1)}function R(e,t,s){for(var r,n=~(s-1),i=0;i<16;i++)r=n&(e[i]^t[i]),e[i]^=r,t[i]^=r}function M(e,s){var r,n,i,o=t(),a=t();for(r=0;r<16;r++)a[r]=s[r];for(N(a),N(a),N(a),n=0;n<2;n++){for(o[0]=a[0]-65517,r=1;r<15;r++)o[r]=a[r]-65535-(o[r-1]>>16&1),o[r-1]&=65535;o[15]=a[15]-32767-(o[14]>>16&1),i=o[15]>>16&1,o[14]&=65535,R(a,o,1-i)}for(r=0;r<16;r++)e[2*r]=255&a[r],e[2*r+1]=a[r]>>8}function L(e,t){var s=new Uint8Array(32),r=new Uint8Array(32);return M(s,e),M(r,t),b(s,0,r,0)}function O(e){var t=new Uint8Array(32);return M(t,e),1&t[0]}function B(e,t){var s;for(s=0;s<16;s++)e[s]=t[2*s]+(t[2*s+1]<<8);e[15]&=32767}function U(e,t,s){for(var r=0;r<16;r++)e[r]=t[r]+s[r]}function V(e,t,s){for(var r=0;r<16;r++)e[r]=t[r]-s[r]}function F(e,t,s){var r,n,i=0,o=0,a=0,c=0,l=0,h=0,u=0,d=0,p=0,f=0,g=0,m=0,y=0,b=0,w=0,v=0,S=0,E=0,D=0,_=0,T=0,I=0,C=0,P=0,x=0,A=0,k=0,N=0,R=0,M=0,L=0,O=s[0],B=s[1],U=s[2],V=s[3],F=s[4],z=s[5],$=s[6],q=s[7],W=s[8],K=s[9],j=s[10],H=s[11],G=s[12],Q=s[13],X=s[14],Y=s[15];i+=(r=t[0])*O,o+=r*B,a+=r*U,c+=r*V,l+=r*F,h+=r*z,u+=r*$,d+=r*q,p+=r*W,f+=r*K,g+=r*j,m+=r*H,y+=r*G,b+=r*Q,w+=r*X,v+=r*Y,o+=(r=t[1])*O,a+=r*B,c+=r*U,l+=r*V,h+=r*F,u+=r*z,d+=r*$,p+=r*q,f+=r*W,g+=r*K,m+=r*j,y+=r*H,b+=r*G,w+=r*Q,v+=r*X,S+=r*Y,a+=(r=t[2])*O,c+=r*B,l+=r*U,h+=r*V,u+=r*F,d+=r*z,p+=r*$,f+=r*q,g+=r*W,m+=r*K,y+=r*j,b+=r*H,w+=r*G,v+=r*Q,S+=r*X,E+=r*Y,c+=(r=t[3])*O,l+=r*B,h+=r*U,u+=r*V,d+=r*F,p+=r*z,f+=r*$,g+=r*q,m+=r*W,y+=r*K,b+=r*j,w+=r*H,v+=r*G,S+=r*Q,E+=r*X,D+=r*Y,l+=(r=t[4])*O,h+=r*B,u+=r*U,d+=r*V,p+=r*F,f+=r*z,g+=r*$,m+=r*q,y+=r*W,b+=r*K,w+=r*j,v+=r*H,S+=r*G,E+=r*Q,D+=r*X,_+=r*Y,h+=(r=t[5])*O,u+=r*B,d+=r*U,p+=r*V,f+=r*F,g+=r*z,m+=r*$,y+=r*q,b+=r*W,w+=r*K,v+=r*j,S+=r*H,E+=r*G,D+=r*Q,_+=r*X,T+=r*Y,u+=(r=t[6])*O,d+=r*B,p+=r*U,f+=r*V,g+=r*F,m+=r*z,y+=r*$,b+=r*q,w+=r*W,v+=r*K,S+=r*j,E+=r*H,D+=r*G,_+=r*Q,T+=r*X,I+=r*Y,d+=(r=t[7])*O,p+=r*B,f+=r*U,g+=r*V,m+=r*F,y+=r*z,b+=r*$,w+=r*q,v+=r*W,S+=r*K,E+=r*j,D+=r*H,_+=r*G,T+=r*Q,I+=r*X,C+=r*Y,p+=(r=t[8])*O,f+=r*B,g+=r*U,m+=r*V,y+=r*F,b+=r*z,w+=r*$,v+=r*q,S+=r*W,E+=r*K,D+=r*j,_+=r*H,T+=r*G,I+=r*Q,C+=r*X,P+=r*Y,f+=(r=t[9])*O,g+=r*B,m+=r*U,y+=r*V,b+=r*F,w+=r*z,v+=r*$,S+=r*q,E+=r*W,D+=r*K,_+=r*j,T+=r*H,I+=r*G,C+=r*Q,P+=r*X,x+=r*Y,g+=(r=t[10])*O,m+=r*B,y+=r*U,b+=r*V,w+=r*F,v+=r*z,S+=r*$,E+=r*q,D+=r*W,_+=r*K,T+=r*j,I+=r*H,C+=r*G,P+=r*Q,x+=r*X,A+=r*Y,m+=(r=t[11])*O,y+=r*B,b+=r*U,w+=r*V,v+=r*F,S+=r*z,E+=r*$,D+=r*q,_+=r*W,T+=r*K,I+=r*j,C+=r*H,P+=r*G,x+=r*Q,A+=r*X,k+=r*Y,y+=(r=t[12])*O,b+=r*B,w+=r*U,v+=r*V,S+=r*F,E+=r*z,D+=r*$,_+=r*q,T+=r*W,I+=r*K,C+=r*j,P+=r*H,x+=r*G,A+=r*Q,k+=r*X,N+=r*Y,b+=(r=t[13])*O,w+=r*B,v+=r*U,S+=r*V,E+=r*F,D+=r*z,_+=r*$,T+=r*q,I+=r*W,C+=r*K,P+=r*j,x+=r*H,A+=r*G,k+=r*Q,N+=r*X,R+=r*Y,w+=(r=t[14])*O,v+=r*B,S+=r*U,E+=r*V,D+=r*F,_+=r*z,T+=r*$,I+=r*q,C+=r*W,P+=r*K,x+=r*j,A+=r*H,k+=r*G,N+=r*Q,R+=r*X,M+=r*Y,v+=(r=t[15])*O,o+=38*(E+=r*U),a+=38*(D+=r*V),c+=38*(_+=r*F),l+=38*(T+=r*z),h+=38*(I+=r*$),u+=38*(C+=r*q),d+=38*(P+=r*W),p+=38*(x+=r*K),f+=38*(A+=r*j),g+=38*(k+=r*H),m+=38*(N+=r*G),y+=38*(R+=r*Q),b+=38*(M+=r*X),w+=38*(L+=r*Y),i=(r=(i+=38*(S+=r*B))+(n=1)+65535)-65536*(n=Math.floor(r/65536)),o=(r=o+n+65535)-65536*(n=Math.floor(r/65536)),a=(r=a+n+65535)-65536*(n=Math.floor(r/65536)),c=(r=c+n+65535)-65536*(n=Math.floor(r/65536)),l=(r=l+n+65535)-65536*(n=Math.floor(r/65536)),h=(r=h+n+65535)-65536*(n=Math.floor(r/65536)),u=(r=u+n+65535)-65536*(n=Math.floor(r/65536)),d=(r=d+n+65535)-65536*(n=Math.floor(r/65536)),p=(r=p+n+65535)-65536*(n=Math.floor(r/65536)),f=(r=f+n+65535)-65536*(n=Math.floor(r/65536)),g=(r=g+n+65535)-65536*(n=Math.floor(r/65536)),m=(r=m+n+65535)-65536*(n=Math.floor(r/65536)),y=(r=y+n+65535)-65536*(n=Math.floor(r/65536)),b=(r=b+n+65535)-65536*(n=Math.floor(r/65536)),w=(r=w+n+65535)-65536*(n=Math.floor(r/65536)),v=(r=v+n+65535)-65536*(n=Math.floor(r/65536)),i=(r=(i+=n-1+37*(n-1))+(n=1)+65535)-65536*(n=Math.floor(r/65536)),o=(r=o+n+65535)-65536*(n=Math.floor(r/65536)),a=(r=a+n+65535)-65536*(n=Math.floor(r/65536)),c=(r=c+n+65535)-65536*(n=Math.floor(r/65536)),l=(r=l+n+65535)-65536*(n=Math.floor(r/65536)),h=(r=h+n+65535)-65536*(n=Math.floor(r/65536)),u=(r=u+n+65535)-65536*(n=Math.floor(r/65536)),d=(r=d+n+65535)-65536*(n=Math.floor(r/65536)),p=(r=p+n+65535)-65536*(n=Math.floor(r/65536)),f=(r=f+n+65535)-65536*(n=Math.floor(r/65536)),g=(r=g+n+65535)-65536*(n=Math.floor(r/65536)),m=(r=m+n+65535)-65536*(n=Math.floor(r/65536)),y=(r=y+n+65535)-65536*(n=Math.floor(r/65536)),b=(r=b+n+65535)-65536*(n=Math.floor(r/65536)),w=(r=w+n+65535)-65536*(n=Math.floor(r/65536)),v=(r=v+n+65535)-65536*(n=Math.floor(r/65536)),i+=n-1+37*(n-1),e[0]=i,e[1]=o,e[2]=a,e[3]=c,e[4]=l,e[5]=h,e[6]=u,e[7]=d,e[8]=p,e[9]=f,e[10]=g,e[11]=m,e[12]=y,e[13]=b,e[14]=w,e[15]=v}function z(e,t){F(e,t,t)}function $(e,s){var r,n=t();for(r=0;r<16;r++)n[r]=s[r];for(r=253;r>=0;r--)z(n,n),2!==r&&4!==r&&F(n,n,s);for(r=0;r<16;r++)e[r]=n[r]}function q(e,s){var r,n=t();for(r=0;r<16;r++)n[r]=s[r];for(r=250;r>=0;r--)z(n,n),1!==r&&F(n,n,s);for(r=0;r<16;r++)e[r]=n[r]}function W(e,s,r){var n,i,o=new Uint8Array(32),a=new Float64Array(80),c=t(),h=t(),u=t(),d=t(),p=t(),f=t();for(i=0;i<31;i++)o[i]=s[i];for(o[31]=127&s[31]|64,o[0]&=248,B(a,r),i=0;i<16;i++)h[i]=a[i],d[i]=c[i]=u[i]=0;for(c[0]=d[0]=1,i=254;i>=0;--i)R(c,h,n=o[i>>>3]>>>(7&i)&1),R(u,d,n),U(p,c,u),V(c,c,u),U(u,h,d),V(h,h,d),z(d,p),z(f,c),F(c,u,c),F(u,h,p),U(p,c,u),V(c,c,u),z(h,c),V(u,d,f),F(c,u,l),U(c,c,d),F(u,u,c),F(c,d,f),F(d,h,a),z(h,p),R(c,h,n),R(u,d,n);for(i=0;i<16;i++)a[i+16]=c[i],a[i+32]=u[i],a[i+48]=h[i],a[i+64]=d[i];var g=a.subarray(32),m=a.subarray(16);return $(g,g),F(m,m,g),M(e,m),0}function K(e,t){return W(e,t,o)}function j(e,t){return s(t,32),K(e,t)}function H(e,t,s){var r=new Uint8Array(32);return W(r,s,t),v(e,n,r,S)}I.prototype.blocks=function(e,t,s){for(var r,n,i,o,a,c,l,h,u,d,p,f,g,m,y,b,w,v,S,E=this.fin?0:2048,D=this.h[0],_=this.h[1],T=this.h[2],I=this.h[3],C=this.h[4],P=this.h[5],x=this.h[6],A=this.h[7],k=this.h[8],N=this.h[9],R=this.r[0],M=this.r[1],L=this.r[2],O=this.r[3],B=this.r[4],U=this.r[5],V=this.r[6],F=this.r[7],z=this.r[8],$=this.r[9];s>=16;)d=u=0,d+=(D+=8191&(r=255&e[t+0]|(255&e[t+1])<<8))*R,d+=(_+=8191&(r>>>13|(n=255&e[t+2]|(255&e[t+3])<<8)<<3))*(5*$),d+=(T+=8191&(n>>>10|(i=255&e[t+4]|(255&e[t+5])<<8)<<6))*(5*z),d+=(I+=8191&(i>>>7|(o=255&e[t+6]|(255&e[t+7])<<8)<<9))*(5*F),u=(d+=(C+=8191&(o>>>4|(a=255&e[t+8]|(255&e[t+9])<<8)<<12))*(5*V))>>>13,d&=8191,d+=(P+=a>>>1&8191)*(5*U),d+=(x+=8191&(a>>>14|(c=255&e[t+10]|(255&e[t+11])<<8)<<2))*(5*B),d+=(A+=8191&(c>>>11|(l=255&e[t+12]|(255&e[t+13])<<8)<<5))*(5*O),d+=(k+=8191&(l>>>8|(h=255&e[t+14]|(255&e[t+15])<<8)<<8))*(5*L),p=u+=(d+=(N+=h>>>5|E)*(5*M))>>>13,p+=D*M,p+=_*R,p+=T*(5*$),p+=I*(5*z),u=(p+=C*(5*F))>>>13,p&=8191,p+=P*(5*V),p+=x*(5*U),p+=A*(5*B),p+=k*(5*O),u+=(p+=N*(5*L))>>>13,p&=8191,f=u,f+=D*L,f+=_*M,f+=T*R,f+=I*(5*$),u=(f+=C*(5*z))>>>13,f&=8191,f+=P*(5*F),f+=x*(5*V),f+=A*(5*U),f+=k*(5*B),g=u+=(f+=N*(5*O))>>>13,g+=D*O,g+=_*L,g+=T*M,g+=I*R,u=(g+=C*(5*$))>>>13,g&=8191,g+=P*(5*z),g+=x*(5*F),g+=A*(5*V),g+=k*(5*U),m=u+=(g+=N*(5*B))>>>13,m+=D*B,m+=_*O,m+=T*L,m+=I*M,u=(m+=C*R)>>>13,m&=8191,m+=P*(5*$),m+=x*(5*z),m+=A*(5*F),m+=k*(5*V),y=u+=(m+=N*(5*U))>>>13,y+=D*U,y+=_*B,y+=T*O,y+=I*L,u=(y+=C*M)>>>13,y&=8191,y+=P*R,y+=x*(5*$),y+=A*(5*z),y+=k*(5*F),b=u+=(y+=N*(5*V))>>>13,b+=D*V,b+=_*U,b+=T*B,b+=I*O,u=(b+=C*L)>>>13,b&=8191,b+=P*M,b+=x*R,b+=A*(5*$),b+=k*(5*z),w=u+=(b+=N*(5*F))>>>13,w+=D*F,w+=_*V,w+=T*U,w+=I*B,u=(w+=C*O)>>>13,w&=8191,w+=P*L,w+=x*M,w+=A*R,w+=k*(5*$),v=u+=(w+=N*(5*z))>>>13,v+=D*z,v+=_*F,v+=T*V,v+=I*U,u=(v+=C*B)>>>13,v&=8191,v+=P*O,v+=x*L,v+=A*M,v+=k*R,S=u+=(v+=N*(5*$))>>>13,S+=D*$,S+=_*z,S+=T*F,S+=I*V,u=(S+=C*U)>>>13,S&=8191,S+=P*B,S+=x*O,S+=A*L,S+=k*M,D=d=8191&(u=(u=((u+=(S+=N*R)>>>13)<<2)+u|0)+(d&=8191)|0),_=p+=u>>>=13,T=f&=8191,I=g&=8191,C=m&=8191,P=y&=8191,x=b&=8191,A=w&=8191,k=v&=8191,N=S&=8191,t+=16,s-=16;this.h[0]=D,this.h[1]=_,this.h[2]=T,this.h[3]=I,this.h[4]=C,this.h[5]=P,this.h[6]=x,this.h[7]=A,this.h[8]=k,this.h[9]=N},I.prototype.finish=function(e,t){var s,r,n,i,o=new Uint16Array(10);if(this.leftover){for(i=this.leftover,this.buffer[i++]=1;i<16;i++)this.buffer[i]=0;this.fin=1,this.blocks(this.buffer,0,16)}for(s=this.h[1]>>>13,this.h[1]&=8191,i=2;i<10;i++)this.h[i]+=s,s=this.h[i]>>>13,this.h[i]&=8191;for(this.h[0]+=5*s,s=this.h[0]>>>13,this.h[0]&=8191,this.h[1]+=s,s=this.h[1]>>>13,this.h[1]&=8191,this.h[2]+=s,o[0]=this.h[0]+5,s=o[0]>>>13,o[0]&=8191,i=1;i<10;i++)o[i]=this.h[i]+s,s=o[i]>>>13,o[i]&=8191;for(o[9]-=8192,r=(1^s)-1,i=0;i<10;i++)o[i]&=r;for(r=~r,i=0;i<10;i++)this.h[i]=this.h[i]&r|o[i];for(this.h[0]=65535&(this.h[0]|this.h[1]<<13),this.h[1]=65535&(this.h[1]>>>3|this.h[2]<<10),this.h[2]=65535&(this.h[2]>>>6|this.h[3]<<7),this.h[3]=65535&(this.h[3]>>>9|this.h[4]<<4),this.h[4]=65535&(this.h[4]>>>12|this.h[5]<<1|this.h[6]<<14),this.h[5]=65535&(this.h[6]>>>2|this.h[7]<<11),this.h[6]=65535&(this.h[7]>>>5|this.h[8]<<8),this.h[7]=65535&(this.h[8]>>>8|this.h[9]<<5),n=this.h[0]+this.pad[0],this.h[0]=65535&n,i=1;i<8;i++)n=(this.h[i]+this.pad[i]|0)+(n>>>16)|0,this.h[i]=65535&n;e[t+0]=this.h[0]>>>0&255,e[t+1]=this.h[0]>>>8&255,e[t+2]=this.h[1]>>>0&255,e[t+3]=this.h[1]>>>8&255,e[t+4]=this.h[2]>>>0&255,e[t+5]=this.h[2]>>>8&255,e[t+6]=this.h[3]>>>0&255,e[t+7]=this.h[3]>>>8&255,e[t+8]=this.h[4]>>>0&255,e[t+9]=this.h[4]>>>8&255,e[t+10]=this.h[5]>>>0&255,e[t+11]=this.h[5]>>>8&255,e[t+12]=this.h[6]>>>0&255,e[t+13]=this.h[6]>>>8&255,e[t+14]=this.h[7]>>>0&255,e[t+15]=this.h[7]>>>8&255},I.prototype.update=function(e,t,s){var r,n;if(this.leftover){for((n=16-this.leftover)>s&&(n=s),r=0;r<n;r++)this.buffer[this.leftover+r]=e[t+r];if(s-=n,t+=n,this.leftover+=n,this.leftover<16)return;this.blocks(this.buffer,0,16),this.leftover=0}if(s>=16&&(n=s-s%16,this.blocks(e,t,n),t+=n,s-=n),s){for(r=0;r<s;r++)this.buffer[this.leftover+r]=e[t+r];this.leftover+=s}};var G=x,Q=A,X=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591];function Y(e,t,s,r){for(var n,i,o,a,c,l,h,u,d,p,f,g,m,y,b,w,v,S,E,D,_,T,I,C,P,x,A=new Int32Array(16),k=new Int32Array(16),N=e[0],R=e[1],M=e[2],L=e[3],O=e[4],B=e[5],U=e[6],V=e[7],F=t[0],z=t[1],$=t[2],q=t[3],W=t[4],K=t[5],j=t[6],H=t[7],G=0;r>=128;){for(E=0;E<16;E++)D=8*E+G,A[E]=s[D+0]<<24|s[D+1]<<16|s[D+2]<<8|s[D+3],k[E]=s[D+4]<<24|s[D+5]<<16|s[D+6]<<8|s[D+7];for(E=0;E<80;E++)if(n=N,i=R,o=M,a=L,c=O,l=B,h=U,d=F,p=z,f=$,g=q,m=W,y=K,b=j,I=65535&(T=H),C=T>>>16,P=65535&(_=V),x=_>>>16,I+=65535&(T=(W>>>14|O<<18)^(W>>>18|O<<14)^(O>>>9|W<<23)),C+=T>>>16,P+=65535&(_=(O>>>14|W<<18)^(O>>>18|W<<14)^(W>>>9|O<<23)),x+=_>>>16,I+=65535&(T=W&K^~W&j),C+=T>>>16,P+=65535&(_=O&B^~O&U),x+=_>>>16,I+=65535&(T=X[2*E+1]),C+=T>>>16,P+=65535&(_=X[2*E]),x+=_>>>16,_=A[E%16],C+=(T=k[E%16])>>>16,P+=65535&_,x+=_>>>16,P+=(C+=(I+=65535&T)>>>16)>>>16,I=65535&(T=S=65535&I|C<<16),C=T>>>16,P=65535&(_=v=65535&P|(x+=P>>>16)<<16),x=_>>>16,I+=65535&(T=(F>>>28|N<<4)^(N>>>2|F<<30)^(N>>>7|F<<25)),C+=T>>>16,P+=65535&(_=(N>>>28|F<<4)^(F>>>2|N<<30)^(F>>>7|N<<25)),x+=_>>>16,C+=(T=F&z^F&$^z&$)>>>16,P+=65535&(_=N&R^N&M^R&M),x+=_>>>16,u=65535&(P+=(C+=(I+=65535&T)>>>16)>>>16)|(x+=P>>>16)<<16,w=65535&I|C<<16,I=65535&(T=g),C=T>>>16,P=65535&(_=a),x=_>>>16,C+=(T=S)>>>16,P+=65535&(_=v),x+=_>>>16,R=n,M=i,L=o,O=a=65535&(P+=(C+=(I+=65535&T)>>>16)>>>16)|(x+=P>>>16)<<16,B=c,U=l,V=h,N=u,z=d,$=p,q=f,W=g=65535&I|C<<16,K=m,j=y,H=b,F=w,E%16==15)for(D=0;D<16;D++)_=A[D],I=65535&(T=k[D]),C=T>>>16,P=65535&_,x=_>>>16,_=A[(D+9)%16],I+=65535&(T=k[(D+9)%16]),C+=T>>>16,P+=65535&_,x+=_>>>16,v=A[(D+1)%16],I+=65535&(T=((S=k[(D+1)%16])>>>1|v<<31)^(S>>>8|v<<24)^(S>>>7|v<<25)),C+=T>>>16,P+=65535&(_=(v>>>1|S<<31)^(v>>>8|S<<24)^v>>>7),x+=_>>>16,v=A[(D+14)%16],C+=(T=((S=k[(D+14)%16])>>>19|v<<13)^(v>>>29|S<<3)^(S>>>6|v<<26))>>>16,P+=65535&(_=(v>>>19|S<<13)^(S>>>29|v<<3)^v>>>6),x+=_>>>16,x+=(P+=(C+=(I+=65535&T)>>>16)>>>16)>>>16,A[D]=65535&P|x<<16,k[D]=65535&I|C<<16;I=65535&(T=F),C=T>>>16,P=65535&(_=N),x=_>>>16,_=e[0],C+=(T=t[0])>>>16,P+=65535&_,x+=_>>>16,x+=(P+=(C+=(I+=65535&T)>>>16)>>>16)>>>16,e[0]=N=65535&P|x<<16,t[0]=F=65535&I|C<<16,I=65535&(T=z),C=T>>>16,P=65535&(_=R),x=_>>>16,_=e[1],C+=(T=t[1])>>>16,P+=65535&_,x+=_>>>16,x+=(P+=(C+=(I+=65535&T)>>>16)>>>16)>>>16,e[1]=R=65535&P|x<<16,t[1]=z=65535&I|C<<16,I=65535&(T=$),C=T>>>16,P=65535&(_=M),x=_>>>16,_=e[2],C+=(T=t[2])>>>16,P+=65535&_,x+=_>>>16,x+=(P+=(C+=(I+=65535&T)>>>16)>>>16)>>>16,e[2]=M=65535&P|x<<16,t[2]=$=65535&I|C<<16,I=65535&(T=q),C=T>>>16,P=65535&(_=L),x=_>>>16,_=e[3],C+=(T=t[3])>>>16,P+=65535&_,x+=_>>>16,x+=(P+=(C+=(I+=65535&T)>>>16)>>>16)>>>16,e[3]=L=65535&P|x<<16,t[3]=q=65535&I|C<<16,I=65535&(T=W),C=T>>>16,P=65535&(_=O),x=_>>>16,_=e[4],C+=(T=t[4])>>>16,P+=65535&_,x+=_>>>16,x+=(P+=(C+=(I+=65535&T)>>>16)>>>16)>>>16,e[4]=O=65535&P|x<<16,t[4]=W=65535&I|C<<16,I=65535&(T=K),C=T>>>16,P=65535&(_=B),x=_>>>16,_=e[5],C+=(T=t[5])>>>16,P+=65535&_,x+=_>>>16,x+=(P+=(C+=(I+=65535&T)>>>16)>>>16)>>>16,e[5]=B=65535&P|x<<16,t[5]=K=65535&I|C<<16,I=65535&(T=j),C=T>>>16,P=65535&(_=U),x=_>>>16,_=e[6],C+=(T=t[6])>>>16,P+=65535&_,x+=_>>>16,x+=(P+=(C+=(I+=65535&T)>>>16)>>>16)>>>16,e[6]=U=65535&P|x<<16,t[6]=j=65535&I|C<<16,I=65535&(T=H),C=T>>>16,P=65535&(_=V),x=_>>>16,_=e[7],C+=(T=t[7])>>>16,P+=65535&_,x+=_>>>16,x+=(P+=(C+=(I+=65535&T)>>>16)>>>16)>>>16,e[7]=V=65535&P|x<<16,t[7]=H=65535&I|C<<16,G+=128,r-=128}return r}function J(e,t,s){var r,n=new Int32Array(8),i=new Int32Array(8),o=new Uint8Array(256),a=s;for(n[0]=1779033703,n[1]=3144134277,n[2]=1013904242,n[3]=2773480762,n[4]=1359893119,n[5]=2600822924,n[6]=528734635,n[7]=1541459225,i[0]=4089235720,i[1]=2227873595,i[2]=4271175723,i[3]=1595750129,i[4]=2917565137,i[5]=725511199,i[6]=4215389547,i[7]=327033209,Y(n,i,t,s),s%=128,r=0;r<s;r++)o[r]=t[a-s+r];for(o[s]=128,o[(s=256-128*(s<112?1:0))-9]=0,g(o,s-8,a/536870912|0,a<<3),Y(n,i,o,s),r=0;r<8;r++)g(e,8*r,n[r],i[r]);return 0}function Z(e,s){var r=t(),n=t(),i=t(),o=t(),a=t(),c=t(),l=t(),h=t(),d=t();V(r,e[1],e[0]),V(d,s[1],s[0]),F(r,r,d),U(n,e[0],e[1]),U(d,s[0],s[1]),F(n,n,d),F(i,e[3],s[3]),F(i,i,u),F(o,e[2],s[2]),U(o,o,o),V(a,n,r),V(c,o,i),U(l,o,i),U(h,n,r),F(e[0],a,c),F(e[1],h,l),F(e[2],l,c),F(e[3],a,h)}function ee(e,t,s){var r;for(r=0;r<4;r++)R(e[r],t[r],s)}function te(e,s){var r=t(),n=t(),i=t();$(i,s[2]),F(r,s[0],i),F(n,s[1],i),M(e,n),e[31]^=O(r)<<7}function se(e,t,s){var r,n;for(k(e[0],a),k(e[1],c),k(e[2],c),k(e[3],a),n=255;n>=0;--n)ee(e,t,r=s[n/8|0]>>(7&n)&1),Z(t,e),Z(e,e),ee(e,t,r)}function re(e,s){var r=[t(),t(),t(),t()];k(r[0],d),k(r[1],p),k(r[2],c),F(r[3],d,p),se(e,r,s)}function ne(e,r,n){var i,o=new Uint8Array(64),a=[t(),t(),t(),t()];for(n||s(r,32),J(o,r,32),o[0]&=248,o[31]&=127,o[31]|=64,re(a,o),te(e,a),i=0;i<32;i++)r[i+32]=e[i];return 0}var ie=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function oe(e,t){var s,r,n,i;for(r=63;r>=32;--r){for(s=0,n=r-32,i=r-12;n<i;++n)t[n]+=s-16*t[r]*ie[n-(r-32)],s=Math.floor((t[n]+128)/256),t[n]-=256*s;t[n]+=s,t[r]=0}for(s=0,n=0;n<32;n++)t[n]+=s-(t[31]>>4)*ie[n],s=t[n]>>8,t[n]&=255;for(n=0;n<32;n++)t[n]-=s*ie[n];for(r=0;r<32;r++)t[r+1]+=t[r]>>8,e[r]=255&t[r]}function ae(e){var t,s=new Float64Array(64);for(t=0;t<64;t++)s[t]=e[t];for(t=0;t<64;t++)e[t]=0;oe(e,s)}function ce(e,s,r,n){var i,o,a=new Uint8Array(64),c=new Uint8Array(64),l=new Uint8Array(64),h=new Float64Array(64),u=[t(),t(),t(),t()];J(a,n,32),a[0]&=248,a[31]&=127,a[31]|=64;var d=r+64;for(i=0;i<r;i++)e[64+i]=s[i];for(i=0;i<32;i++)e[32+i]=a[32+i];for(J(l,e.subarray(32),r+32),ae(l),re(u,l),te(e,u),i=32;i<64;i++)e[i]=n[i];for(J(c,e,r+64),ae(c),i=0;i<64;i++)h[i]=0;for(i=0;i<32;i++)h[i]=l[i];for(i=0;i<32;i++)for(o=0;o<32;o++)h[i+o]+=c[i]*a[o];return oe(e.subarray(32),h),d}function le(e,s,r,n){var i,o=new Uint8Array(32),l=new Uint8Array(64),u=[t(),t(),t(),t()],d=[t(),t(),t(),t()];if(r<64)return-1;if(function(e,s){var r=t(),n=t(),i=t(),o=t(),l=t(),u=t(),d=t();return k(e[2],c),B(e[1],s),z(i,e[1]),F(o,i,h),V(i,i,e[2]),U(o,e[2],o),z(l,o),z(u,l),F(d,u,l),F(r,d,i),F(r,r,o),q(r,r),F(r,r,i),F(r,r,o),F(r,r,o),F(e[0],r,o),z(n,e[0]),F(n,n,o),L(n,i)&&F(e[0],e[0],f),z(n,e[0]),F(n,n,o),L(n,i)?-1:(O(e[0])===s[31]>>7&&V(e[0],a,e[0]),F(e[3],e[0],e[1]),0)}(d,n))return-1;for(i=0;i<r;i++)e[i]=s[i];for(i=0;i<32;i++)e[i+32]=n[i];if(J(l,e,r),ae(l),se(u,d,l),re(d,s.subarray(32)),Z(u,d),te(o,u),r-=64,b(s,0,o,0)){for(i=0;i<r;i++)e[i]=0;return-1}for(i=0;i<r;i++)e[i]=s[i+64];return r}var he=16,ue=64,de=32,pe=64;function fe(e,t){if(32!==e.length)throw new Error("bad key size");if(24!==t.length)throw new Error("bad nonce size")}function ge(){for(var e=0;e<arguments.length;e++)if(!(arguments[e]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function me(e){for(var t=0;t<e.length;t++)e[t]=0}e.lowlevel={crypto_core_hsalsa20:v,crypto_stream_xor:T,crypto_stream:_,crypto_stream_salsa20_xor:E,crypto_stream_salsa20:D,crypto_onetimeauth:C,crypto_onetimeauth_verify:P,crypto_verify_16:y,crypto_verify_32:b,crypto_secretbox:x,crypto_secretbox_open:A,crypto_scalarmult:W,crypto_scalarmult_base:K,crypto_box_beforenm:H,crypto_box_afternm:G,crypto_box:function(e,t,s,r,n,i){var o=new Uint8Array(32);return H(o,n,i),G(e,t,s,r,o)},crypto_box_open:function(e,t,s,r,n,i){var o=new Uint8Array(32);return H(o,n,i),Q(e,t,s,r,o)},crypto_box_keypair:j,crypto_hash:J,crypto_sign:ce,crypto_sign_keypair:ne,crypto_sign_open:le,crypto_secretbox_KEYBYTES:32,crypto_secretbox_NONCEBYTES:24,crypto_secretbox_ZEROBYTES:32,crypto_secretbox_BOXZEROBYTES:he,crypto_scalarmult_BYTES:32,crypto_scalarmult_SCALARBYTES:32,crypto_box_PUBLICKEYBYTES:32,crypto_box_SECRETKEYBYTES:32,crypto_box_BEFORENMBYTES:32,crypto_box_NONCEBYTES:24,crypto_box_ZEROBYTES:32,crypto_box_BOXZEROBYTES:16,crypto_sign_BYTES:ue,crypto_sign_PUBLICKEYBYTES:de,crypto_sign_SECRETKEYBYTES:pe,crypto_sign_SEEDBYTES:32,crypto_hash_BYTES:64,gf:t,D:h,L:ie,pack25519:M,unpack25519:B,M:F,A:U,S:z,Z:V,pow2523:q,add:Z,set25519:k,modL:oe,scalarmult:se,scalarbase:re},e.randomBytes=function(e){var t=new Uint8Array(e);return s(t,e),t},e.secretbox=function(e,t,s){ge(e,t,s),fe(s,t);for(var r=new Uint8Array(32+e.length),n=new Uint8Array(r.length),i=0;i<e.length;i++)r[i+32]=e[i];return x(n,r,r.length,t,s),n.subarray(he)},e.secretbox.open=function(e,t,s){ge(e,t,s),fe(s,t);for(var r=new Uint8Array(he+e.length),n=new Uint8Array(r.length),i=0;i<e.length;i++)r[i+he]=e[i];return r.length<32||0!==A(n,r,r.length,t,s)?null:n.subarray(32)},e.secretbox.keyLength=32,e.secretbox.nonceLength=24,e.secretbox.overheadLength=he,e.scalarMult=function(e,t){if(ge(e,t),32!==e.length)throw new Error("bad n size");if(32!==t.length)throw new Error("bad p size");var s=new Uint8Array(32);return W(s,e,t),s},e.scalarMult.base=function(e){if(ge(e),32!==e.length)throw new Error("bad n size");var t=new Uint8Array(32);return K(t,e),t},e.scalarMult.scalarLength=32,e.scalarMult.groupElementLength=32,e.box=function(t,s,r,n){var i=e.box.before(r,n);return e.secretbox(t,s,i)},e.box.before=function(e,t){ge(e,t),function(e,t){if(32!==e.length)throw new Error("bad public key size");if(32!==t.length)throw new Error("bad secret key size")}(e,t);var s=new Uint8Array(32);return H(s,e,t),s},e.box.after=e.secretbox,e.box.open=function(t,s,r,n){var i=e.box.before(r,n);return e.secretbox.open(t,s,i)},e.box.open.after=e.secretbox.open,e.box.keyPair=function(){var e=new Uint8Array(32),t=new Uint8Array(32);return j(e,t),{publicKey:e,secretKey:t}},e.box.keyPair.fromSecretKey=function(e){if(ge(e),32!==e.length)throw new Error("bad secret key size");var t=new Uint8Array(32);return K(t,e),{publicKey:t,secretKey:new Uint8Array(e)}},e.box.publicKeyLength=32,e.box.secretKeyLength=32,e.box.sharedKeyLength=32,e.box.nonceLength=24,e.box.overheadLength=e.secretbox.overheadLength,e.sign=function(e,t){if(ge(e,t),t.length!==pe)throw new Error("bad secret key size");var s=new Uint8Array(ue+e.length);return ce(s,e,e.length,t),s},e.sign.open=function(e,t){if(ge(e,t),t.length!==de)throw new Error("bad public key size");var s=new Uint8Array(e.length),r=le(s,e,e.length,t);if(r<0)return null;for(var n=new Uint8Array(r),i=0;i<n.length;i++)n[i]=s[i];return n},e.sign.detached=function(t,s){for(var r=e.sign(t,s),n=new Uint8Array(ue),i=0;i<n.length;i++)n[i]=r[i];return n},e.sign.detached.verify=function(e,t,s){if(ge(e,t,s),t.length!==ue)throw new Error("bad signature size");if(s.length!==de)throw new Error("bad public key size");var r,n=new Uint8Array(ue+e.length),i=new Uint8Array(ue+e.length);for(r=0;r<ue;r++)n[r]=t[r];for(r=0;r<e.length;r++)n[r+ue]=e[r];return le(i,n,n.length,s)>=0},e.sign.keyPair=function(){var e=new Uint8Array(de),t=new Uint8Array(pe);return ne(e,t),{publicKey:e,secretKey:t}},e.sign.keyPair.fromSecretKey=function(e){if(ge(e),e.length!==pe)throw new Error("bad secret key size");for(var t=new Uint8Array(de),s=0;s<t.length;s++)t[s]=e[32+s];return{publicKey:t,secretKey:new Uint8Array(e)}},e.sign.keyPair.fromSeed=function(e){if(ge(e),32!==e.length)throw new Error("bad seed size");for(var t=new Uint8Array(de),s=new Uint8Array(pe),r=0;r<32;r++)s[r]=e[r];return ne(t,s,!0),{publicKey:t,secretKey:s}},e.sign.publicKeyLength=de,e.sign.secretKeyLength=pe,e.sign.seedLength=32,e.sign.signatureLength=ue,e.hash=function(e){ge(e);var t=new Uint8Array(64);return J(t,e,e.length),t},e.hash.hashLength=64,e.verify=function(e,t){return ge(e,t),0!==e.length&&0!==t.length&&e.length===t.length&&0===m(e,0,t,0,e.length)},e.setPRNG=function(e){s=e},function(){var t="undefined"!=typeof self?self.crypto||self.msCrypto:null;t&&t.getRandomValues?e.setPRNG(function(e,s){var r,n=new Uint8Array(s);for(r=0;r<s;r+=65536)t.getRandomValues(n.subarray(r,r+Math.min(s-r,65536)));for(r=0;r<s;r++)e[r]=n[r];me(n)}):void 0!==r&&(t=i)&&t.randomBytes&&e.setPRNG(function(e,s){var r,n=t.randomBytes(s);for(r=0;r<s;r++)e[r]=n[r];me(n)})}()}(n.exports?n.exports:self.nacl=self.nacl||{});var o=t(n.exports);function a(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let s=0;s<e.byteLength;s++)if(e[s]!==t[s])return!1;return!0}function c(e=0){return new Uint8Array(e)}function l(e=0){return new Uint8Array(e)}function h(e,t){if(e.length!==t.length)throw new Error("Inputs should have the same length");const s=l(e.length);for(let r=0;r<e.length;r++)s[r]=e[r]^t[r];return s}function u(e,t){null==t&&(t=e.reduce((e,t)=>e+t.length,0));const s=l(t);let r=0;for(const t of e)s.set(t,r),r+=t.length;return s}function d(e){if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")}var p=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var s=new Uint8Array(256),r=0;r<s.length;r++)s[r]=255;for(var n=0;n<e.length;n++){var i=e.charAt(n),o=i.charCodeAt(0);if(255!==s[o])throw new TypeError(i+" is ambiguous");s[o]=n}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),h=Math.log(256)/Math.log(a);function u(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,n=0;e[t]===c;)r++,t++;for(var i=(e.length-t)*l+1>>>0,o=new Uint8Array(i);e[t];){var h=s[e.charCodeAt(t)];if(255===h)return;for(var u=0,d=i-1;(0!==h||u<n)&&-1!==d;d--,u++)h+=a*o[d]>>>0,o[d]=h%256>>>0,h=h/256>>>0;if(0!==h)throw new Error("Non-zero carry");n=u,t++}if(" "!==e[t]){for(var p=i-n;p!==i&&0===o[p];)p++;for(var f=new Uint8Array(r+(i-p)),g=r;p!==i;)f[g++]=o[p++];return f}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var s=0,r=0,n=0,i=t.length;n!==i&&0===t[n];)n++,s++;for(var o=(i-n)*h+1>>>0,l=new Uint8Array(o);n!==i;){for(var u=t[n],d=0,p=o-1;(0!==u||d<r)&&-1!==p;p--,d++)u+=256*l[p]>>>0,l[p]=u%a>>>0,u=u/a>>>0;if(0!==u)throw new Error("Non-zero carry");r=d,n++}for(var f=o-r;f!==o&&0===l[f];)f++;for(var g=c.repeat(s);f<o;++f)g+=e.charAt(l[f]);return g},decodeUnsafe:u,decode:function(e){var s=u(e);if(s)return s;throw new Error(`Non-${t} character`)}}},f=p;let g=class{name;prefix;baseEncode;constructor(e,t,s){this.name=e,this.prefix=t,this.baseEncode=s}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},m=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,s){this.name=e,this.prefix=t;const r=t.codePointAt(0);if(void 0===r)throw new Error("Invalid prefix character");this.prefixCodePoint=r,this.baseDecode=s}decode(e){if("string"==typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return b(this,e)}};class y{decoders;constructor(e){this.decoders=e}or(e){return b(this,e)}decode(e){const t=e[0],s=this.decoders[t];if(null!=s)return s.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function b(e,t){return new y({...e.decoders??{[e.prefix]:e},...t.decoders??{[t.prefix]:t}})}let w=class{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,s,r){this.name=e,this.prefix=t,this.baseEncode=s,this.baseDecode=r,this.encoder=new g(e,t,s),this.decoder=new m(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}};function v({name:e,prefix:t,encode:s,decode:r}){return new w(e,t,s,r)}function S({name:e,prefix:t,alphabet:s}){const{encode:r,decode:n}=f(s,e);return v({prefix:t,name:e,encode:r,decode:e=>d(n(e))})}function E({name:e,prefix:t,bitsPerChar:s,alphabet:r}){const n=function(e){const t={};for(let s=0;s<e.length;++s)t[e[s]]=s;return t}(r);return v({prefix:t,name:e,encode:e=>function(e,t,s){const r="="===t[t.length-1],n=(1<<s)-1;let i="",o=0,a=0;for(let r=0;r<e.length;++r)for(a=a<<8|e[r],o+=8;o>s;)o-=s,i+=t[n&a>>o];if(0!==o&&(i+=t[n&a<<s-o]),r)for(;i.length*s&7;)i+="=";return i}(e,r,s),decode:t=>function(e,t,s,r){let n=e.length;for(;"="===e[n-1];)--n;const i=new Uint8Array(n*s/8|0);let o=0,a=0,c=0;for(let l=0;l<n;++l){const n=t[e[l]];if(void 0===n)throw new SyntaxError(`Non-${r} character`);a=a<<s|n,o+=s,o>=8&&(o-=8,i[c++]=255&a>>o)}if(o>=s||255&a<<8-o)throw new SyntaxError("Unexpected end of data");return i}(t,n,s,e)})}const D=S({prefix:"9",name:"base10",alphabet:"0123456789"});var _=Object.freeze({__proto__:null,base10:D});const T=E({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),I=E({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4});var C=Object.freeze({__proto__:null,base16:T,base16upper:I});const P=E({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1});var x=Object.freeze({__proto__:null,base2:P});const A=Array.from("ðŸš€ðŸªâ˜„ðŸ›°ðŸŒŒðŸŒ‘ðŸŒ’ðŸŒ“ðŸŒ”ðŸŒ•ðŸŒ–ðŸŒ—ðŸŒ˜ðŸŒðŸŒðŸŒŽðŸ‰â˜€ðŸ’»ðŸ–¥ðŸ’¾ðŸ’¿ðŸ˜‚â¤ðŸ˜ðŸ¤£ðŸ˜ŠðŸ™ðŸ’•ðŸ˜­ðŸ˜˜ðŸ‘ðŸ˜…ðŸ‘ðŸ˜ðŸ”¥ðŸ¥°ðŸ’”ðŸ’–ðŸ’™ðŸ˜¢ðŸ¤”ðŸ˜†ðŸ™„ðŸ’ªðŸ˜‰â˜ºðŸ‘ŒðŸ¤—ðŸ’œðŸ˜”ðŸ˜ŽðŸ˜‡ðŸŒ¹ðŸ¤¦ðŸŽ‰ðŸ’žâœŒâœ¨ðŸ¤·ðŸ˜±ðŸ˜ŒðŸŒ¸ðŸ™ŒðŸ˜‹ðŸ’—ðŸ’šðŸ˜ðŸ’›ðŸ™‚ðŸ’“ðŸ¤©ðŸ˜„ðŸ˜€ðŸ–¤ðŸ˜ƒðŸ’¯ðŸ™ˆðŸ‘‡ðŸŽ¶ðŸ˜’ðŸ¤­â£ðŸ˜œðŸ’‹ðŸ‘€ðŸ˜ªðŸ˜‘ðŸ’¥ðŸ™‹ðŸ˜žðŸ˜©ðŸ˜¡ðŸ¤ªðŸ‘ŠðŸ¥³ðŸ˜¥ðŸ¤¤ðŸ‘‰ðŸ’ƒðŸ˜³âœ‹ðŸ˜šðŸ˜ðŸ˜´ðŸŒŸðŸ˜¬ðŸ™ƒðŸ€ðŸŒ·ðŸ˜»ðŸ˜“â­âœ…ðŸ¥ºðŸŒˆðŸ˜ˆðŸ¤˜ðŸ’¦âœ”ðŸ˜£ðŸƒðŸ’â˜¹ðŸŽŠðŸ’˜ðŸ˜ â˜ðŸ˜•ðŸŒºðŸŽ‚ðŸŒ»ðŸ˜ðŸ–•ðŸ’ðŸ™ŠðŸ˜¹ðŸ—£ðŸ’«ðŸ’€ðŸ‘‘ðŸŽµðŸ¤žðŸ˜›ðŸ”´ðŸ˜¤ðŸŒ¼ðŸ˜«âš½ðŸ¤™â˜•ðŸ†ðŸ¤«ðŸ‘ˆðŸ˜®ðŸ™†ðŸ»ðŸƒðŸ¶ðŸ’ðŸ˜²ðŸŒ¿ðŸ§¡ðŸŽâš¡ðŸŒžðŸŽˆâŒâœŠðŸ‘‹ðŸ˜°ðŸ¤¨ðŸ˜¶ðŸ¤ðŸš¶ðŸ’°ðŸ“ðŸ’¢ðŸ¤ŸðŸ™ðŸš¨ðŸ’¨ðŸ¤¬âœˆðŸŽ€ðŸºðŸ¤“ðŸ˜™ðŸ’ŸðŸŒ±ðŸ˜–ðŸ‘¶ðŸ¥´â–¶âž¡â“ðŸ’ŽðŸ’¸â¬‡ðŸ˜¨ðŸŒšðŸ¦‹ðŸ˜·ðŸ•ºâš ðŸ™…ðŸ˜ŸðŸ˜µðŸ‘ŽðŸ¤²ðŸ¤ ðŸ¤§ðŸ“ŒðŸ”µðŸ’…ðŸ§ðŸ¾ðŸ’ðŸ˜—ðŸ¤‘ðŸŒŠðŸ¤¯ðŸ·â˜ŽðŸ’§ðŸ˜¯ðŸ’†ðŸ‘†ðŸŽ¤ðŸ™‡ðŸ‘â„ðŸŒ´ðŸ’£ðŸ¸ðŸ’ŒðŸ“ðŸ¥€ðŸ¤¢ðŸ‘…ðŸ’¡ðŸ’©ðŸ‘ðŸ“¸ðŸ‘»ðŸ¤ðŸ¤®ðŸŽ¼ðŸ¥µðŸš©ðŸŽðŸŠðŸ‘¼ðŸ’ðŸ“£ðŸ¥‚"),k=A.reduce((e,t,s)=>(e[s]=t,e),[]),N=A.reduce((e,t,s)=>{const r=t.codePointAt(0);if(null==r)throw new Error(`Invalid character: ${t}`);return e[r]=s,e},[]);const R=v({prefix:"ðŸš€",name:"base256emoji",encode:function(e){return e.reduce((e,t)=>e+=k[t],"")},decode:function(e){const t=[];for(const s of e){const e=s.codePointAt(0);if(null==e)throw new Error(`Invalid character: ${s}`);const r=N[e];if(null==r)throw new Error(`Non-base256emoji character: ${s}`);t.push(r)}return new Uint8Array(t)}});var M=Object.freeze({__proto__:null,base256emoji:R});const L=E({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),O=E({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),B=E({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),U=E({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),V=E({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),F=E({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),z=E({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),$=E({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),q=E({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var W=Object.freeze({__proto__:null,base32:L,base32hex:V,base32hexpad:z,base32hexpadupper:$,base32hexupper:F,base32pad:B,base32padupper:U,base32upper:O,base32z:q});const K=S({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),j=S({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"});var H=Object.freeze({__proto__:null,base36:K,base36upper:j});const G=S({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Q=S({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var X=Object.freeze({__proto__:null,base58btc:G,base58flickr:Q});const Y=E({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),J=E({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Z=E({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),ee=E({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});var te=Object.freeze({__proto__:null,base64:Y,base64pad:J,base64url:Z,base64urlpad:ee});const se=E({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3});var re=Object.freeze({__proto__:null,base8:se});const ne=v({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>function(e){return(new TextEncoder).encode(e)}(e)});var ie=Object.freeze({__proto__:null,identity:ne});new TextEncoder,new TextDecoder;var oe=function e(t,s,r){s=s||[];var n=r=r||0;for(;t>=le;)s[r++]=255&t|ae,t/=128;for(;t&ce;)s[r++]=255&t|ae,t>>>=7;return s[r]=0|t,e.bytes=r-n+1,s},ae=128,ce=-128,le=Math.pow(2,31);var he=function e(t,s){var r,n=0,i=0,o=s=s||0,a=t.length;do{if(o>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[o++],n+=i<28?(r&de)<<i:(r&de)*Math.pow(2,i),i+=7}while(r>=ue);return e.bytes=o-s,n},ue=128,de=127;var pe=Math.pow(2,7),fe=Math.pow(2,14),ge=Math.pow(2,21),me=Math.pow(2,28),ye=Math.pow(2,35),be=Math.pow(2,42),we=Math.pow(2,49),ve=Math.pow(2,56),Se=Math.pow(2,63),Ee={encode:oe,decode:he,encodingLength:function(e){return e<pe?1:e<fe?2:e<ge?3:e<me?4:e<ye?5:e<be?6:e<we?7:e<ve?8:e<Se?9:10}},De=Ee;function _e(e,t=0){return[De.decode(e,t),De.decode.bytes]}function Te(e,t,s=0){return De.encode(e,t,s),t}function Ie(e){return De.encodingLength(e)}function Ce(e,t){const s=t.byteLength,r=Ie(e),n=r+Ie(s),i=new Uint8Array(n+s);return Te(e,i,0),Te(s,i,r),i.set(t,n),new xe(e,s,t,i)}function Pe(e){const t=d(e),[s,r]=_e(t),[n,i]=_e(t.subarray(r)),o=t.subarray(r+i);if(o.byteLength!==n)throw new Error("Incorrect length");return new xe(s,n,o,t)}class xe{code;size;digest;bytes;constructor(e,t,s,r){this.code=e,this.size=t,this.digest=s,this.bytes=r}}const Ae=d;const ke={code:0,name:"identity",encode:Ae,digest:function(e,t){if(null!=t?.truncate&&t.truncate!==e.byteLength){if(t.truncate<0||t.truncate>e.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${e.byteLength}`);e=e.subarray(0,t.truncate)}return Ce(0,Ae(e))}};class Ne{name;code;encode;minDigestLength;maxDigestLength;constructor(e,t,s,r,n){this.name=e,this.code=t,this.encode=s,this.minDigestLength=r??20,this.maxDigestLength=n}digest(e,t){if(null!=t?.truncate){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(null!=this.maxDigestLength&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){const s=this.encode(e);return s instanceof Uint8Array?Re(s,this.code,t?.truncate):s.then(e=>Re(e,this.code,t?.truncate))}throw Error("Unknown type, must be binary type")}}function Re(e,t,s){if(null!=s&&s!==e.byteLength){if(s>e.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${e.byteLength}`);e=e.subarray(0,s)}return Ce(t,e)}const Me=function({name:e,code:t,encode:s,minDigestLength:r,maxDigestLength:n}){return new Ne(e,t,s,r,n)}({name:"sha2-256",code:18,encode:function(e){return async t=>new Uint8Array(await crypto.subtle.digest(e,t))}("SHA-256")});function Le(e,t){const{bytes:s,version:r}=e;return 0===r?function(e,t,s){const{prefix:r}=s;if(r!==G.prefix)throw Error(`Cannot string encode V0 in ${s.name} encoding`);const n=t.get(r);if(null==n){const n=s.encode(e).slice(1);return t.set(r,n),n}return n}(s,Be(e),t??G.encoder):function(e,t,s){const{prefix:r}=s,n=t.get(r);if(null==n){const n=s.encode(e);return t.set(r,n),n}return n}(s,Be(e),t??L.encoder)}const Oe=new WeakMap;function Be(e){const t=Oe.get(e);if(null==t){const t=new Map;return Oe.set(e,t),t}return t}class Ue{code;version;multihash;bytes;"/";constructor(e,t,s,r){this.code=t,this.version=e,this.multihash=s,this.bytes=r,this["/"]=r}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==Ve)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==Fe)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Ue.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,s=Ce(e,t);return Ue.createV1(this.code,s)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Ue.equals(this,e)}static equals(e,t){const s=t;return null!=s&&e.code===s.code&&e.version===s.version&&function(e,t){if(e===t)return!0;{const s=t;return e.code===s.code&&e.size===s.size&&s.bytes instanceof Uint8Array&&function(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let s=0;s<e.byteLength;s++)if(e[s]!==t[s])return!1;return!0}(e.bytes,s.bytes)}}(e.multihash,s.multihash)}toString(e){return Le(this,e)}toJSON(){return{"/":Le(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(null==e)return null;const t=e;if(t instanceof Ue)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:s,multihash:r,bytes:n}=t;return new Ue(e,s,r,n??ze(e,s,r.bytes))}if(!0===t[$e]){const{version:e,multihash:s,code:r}=t,n=Pe(s);return Ue.create(e,r,n)}return null}static create(e,t,s){if("number"!=typeof t)throw new Error("String codecs are no longer supported");if(!(s.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==Ve)throw new Error(`Version 0 CID must use dag-pb (code: ${Ve}) block encoding`);return new Ue(e,t,s,s.bytes);case 1:{const r=ze(e,t,s.bytes);return new Ue(e,t,s,r)}default:throw new Error("Invalid version")}}static createV0(e){return Ue.create(0,Ve,e)}static createV1(e,t){return Ue.create(1,e,t)}static decode(e){const[t,s]=Ue.decodeFirst(e);if(0!==s.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Ue.inspectBytes(e),s=t.size-t.multihashSize,r=d(e.subarray(s,s+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const n=r.subarray(t.multihashSize-t.digestSize),i=new xe(t.multihashCode,t.digestSize,n,r);return[0===t.version?Ue.createV0(i):Ue.createV1(t.codec,i),e.subarray(t.size)]}static inspectBytes(e){let t=0;const s=()=>{const[s,r]=_e(e.subarray(t));return t+=r,s};let r=s(),n=Ve;if(18===r?(r=0,t=0):n=s(),0!==r&&1!==r)throw new RangeError(`Invalid CID version ${r}`);const i=t,o=s(),a=s(),c=t+a;return{version:r,codec:n,multihashCode:o,digestSize:a,multihashSize:c-i,size:c}}static parse(e,t){const[s,r]=function(e,t){switch(e[0]){case"Q":{const s=t??G;return[G.prefix,s.decode(`${G.prefix}${e}`)]}case G.prefix:{const s=t??G;return[G.prefix,s.decode(e)]}case L.prefix:{const s=t??L;return[L.prefix,s.decode(e)]}case K.prefix:{const s=t??K;return[K.prefix,s.decode(e)]}default:if(null==t)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}}(e,t),n=Ue.decode(r);if(0===n.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return Be(n).set(s,e),n}}const Ve=112,Fe=18;function ze(e,t,s){const r=Ie(e),n=r+Ie(t),i=new Uint8Array(n+s.byteLength);return Te(e,i,0),Te(t,i,r),i.set(s,n),i}const $e=Symbol.for("@ipld/js-cid/CID"),qe={...ie,...x,...re,..._,...C,...W,...H,...X,...te,...M};function We(e,t,s,r){return{name:e,prefix:t,encoder:{name:e,prefix:t,encode:s},decoder:{decode:r}}}const Ke=We("utf8","u",e=>"u"+new TextDecoder("utf8").decode(e),e=>(new TextEncoder).encode(e.substring(1))),je=We("ascii","a",e=>{let t="a";for(let s=0;s<e.length;s++)t+=String.fromCharCode(e[s]);return t},e=>{const t=l((e=e.substring(1)).length);for(let s=0;s<e.length;s++)t[s]=e.charCodeAt(s);return t}),He={utf8:Ke,"utf-8":Ke,hex:qe.base16,latin1:je,ascii:je,binary:je,...qe};function Ge(e,t="utf8"){const s=He[t];if(null==s)throw new Error(`Unsupported encoding "${t}"`);return s.decoder.decode(`${s.prefix}${e}`)}function Qe(e,t="utf8"){const s=He[t];if(null==s)throw new Error(`Unsupported encoding "${t}"`);return s.encoder.encode(e).substring(1)}const Xe=["/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa","/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p/QmbLHAnMoJPWSCR5Zhtx6BHJX9KiKNN6tpvbUcqanj75Nb"],Ye={SIGNAL:"/konomi/signal/1.0.0",SYNC:"/konomi/sync/1.0.0",BLOB:"/konomi/blob/1.0.0",RPC:"/konomi/rpc/1.0.0",RELAY:"/konomi/relay/1.0.0"},Je={DISCOVERY:"konomi:discovery:v1",ROOM_PREFIX:"konomi:room:",SIGNAL_PREFIX:"konomi:signal:"},Ze={D:6,Dlo:4,Dhi:12,heartbeatInterval:1e3,mcacheLength:5,mcacheGossip:3,emitSelf:!1,gossipIncoming:!0,fallbackToFloodsub:!0,floodPublish:!0},et={minConnections:5,maxConnections:50,pollInterval:2e3,autoDialInterval:1e4},tt={name:"konomi-p2p",version:1,stores:{identity:"identity",peers:"peers",rooms:"rooms",messages:"messages",blobs:"blobs"}},st={maxSize:52428800,strategy:"lru"},rt={awarenessInterval:3e4,awarenessTimeout:6e4,syncRequestDebounce:100,updateDebounce:50},nt={algorithm:"ed25519",nonceLength:24,keyLength:32};function it(e={}){return{bootstrap:Xe,protocols:Ye,topics:Je,gossipsub:{...Ze,...e.gossipsub},connection:{...et,...e.connection},db:{...tt,...e.db},cache:{...st,...e.cache},sync:{...rt,...e.sync},crypto:{...nt,...e.crypto},...e}}function ot(){return o.sign.keyPair()}function at(){return o.box.keyPair()}function ct(e,t){return o.scalarMult(e,t)}function lt(){return o.randomBytes(nt.nonceLength)}function ht(e,t){const s="string"==typeof e?Ge(e):e,r=lt(),n=o.secretbox(s,r,t);if(!n)throw new Error("Encryption failed");return{nonce:r,ciphertext:n}}function ut(e,t){const{nonce:s,ciphertext:r}=e;return o.secretbox.open(r,s,t)}function dt(e,t){const s="string"==typeof e?Ge(e):e;return o.sign.detached(s,t)}function pt(e,t,s){const r="string"==typeof e?Ge(e):e;return o.sign.detached.verify(r,t,s)}function ft(e){const t="string"==typeof e?Ge(e):e;return o.hash(t)}function gt(e){return o.randomBytes(e)}function mt(e){return Qe(e,"base64")}function yt(e){return Ge(e,"base64")}function bt(e){return Qe(e,"base16")}function wt(e){return Ge(e,"base16")}class vt{constructor(e,t=null){this.signing=e,this.box=t||at()}static generate(){return new vt(ot(),at())}static fromSecretKey(e,t=null){const s=o.sign.keyPair.fromSecretKey(e),r=t?o.box.keyPair.fromSecretKey(t):at();return new vt(s,r)}sign(e){return dt(e,this.signing.secretKey)}verify(e,t,s){return pt(e,t,s||this.signing.publicKey)}encrypt(e,t){return function(e,t,s){const r="string"==typeof e?Ge(e):e,n=lt(),i=o.box(r,n,t,s);if(!i)throw new Error("Box encryption failed");return{nonce:n,ciphertext:i}}(e,t,this.box.secretKey)}decrypt(e,t){return function(e,t,s){const{nonce:r,ciphertext:n}=e;return o.box.open(n,r,t,s)}(e,t,this.box.secretKey)}deriveSecret(e){return ct(this.box.secretKey,e)}toJSON(){return{signing:{publicKey:mt(this.signing.publicKey),secretKey:mt(this.signing.secretKey)},box:{publicKey:mt(this.box.publicKey),secretKey:mt(this.box.secretKey)}}}static fromJSON(e){return new vt({publicKey:yt(e.signing.publicKey),secretKey:yt(e.signing.secretKey)},{publicKey:yt(e.box.publicKey),secretKey:yt(e.box.secretKey)})}}function St(e){return Dt(ft(e).slice(0,32))}const Et="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";function Dt(e){if(0===e.length)return"";let t=0;for(let s=0;s<e.length&&0===e[s];s++)t++;const s=Math.ceil(138*e.length/100)+1,r=new Uint8Array(s);for(let n=t;n<e.length;n++){let t=e[n];for(let e=s-1;e>=0;e--)t+=256*r[e],r[e]=t%58,t=Math.floor(t/58)}let n=0;for(;n<s&&0===r[n];)n++;let i="1".repeat(t);for(let e=n;e<s;e++)i+=Et[r[e]];return i}function _t(e){if(0===e.length)return new Uint8Array(0);let t=0;for(let s=0;s<e.length&&"1"===e[s];s++)t++;const s=Math.ceil(733*e.length/1e3)+1,r=new Uint8Array(s);for(let n=t;n<e.length;n++){const t=Et.indexOf(e[n]);if(-1===t)throw new Error(`Invalid base58 character: ${e[n]}`);let i=t;for(let e=s-1;e>=0;e--)i+=58*r[e],r[e]=i%256,i=Math.floor(i/256)}let n=0;for(;n<s&&0===r[n];)n++;const i=new Uint8Array(t+(s-n));for(let e=n;e<s;e++)i[t+(e-n)]=r[e];return i}let Tt=class e{constructor(e){this.id=e.id,this.publicKey=e.publicKey||null,this.addrs=e.addrs||[],this.protocols=e.protocols||[],this.seen=e.seen||Date.now(),this.latency=e.latency||-1,this.score=e.score||0,this.trusted=e.trusted||!1,this.blocked=e.blocked||!1,this.metadata=e.metadata||{}}touch(){this.seen=Date.now()}updateLatency(e){this.latency<0?this.latency=e:this.latency=Math.round(.8*this.latency+.2*e)}addScore(e){this.score=Math.max(-1e3,Math.min(1e3,this.score+e))}isStale(e=6e4){return Date.now()-this.seen>e}addAddr(e){this.addrs.includes(e)||this.addrs.push(e)}addProtocol(e){this.protocols.includes(e)||this.protocols.push(e)}supportsProtocol(e){return this.protocols.includes(e)}toJSON(){return{id:this.id,publicKey:this.publicKey?mt(this.publicKey):null,addrs:this.addrs,protocols:this.protocols,seen:this.seen,latency:this.latency,score:this.score,trusted:this.trusted,blocked:this.blocked,metadata:this.metadata}}static fromJSON(t){return new e({...t,publicKey:t.publicKey?yt(t.publicKey):null})}};class It{constructor(){this.peers=new Map}add(e){const t=this.peers.get(e.id);t?(t.touch(),e.addrs.forEach(e=>t.addAddr(e)),e.protocols.forEach(e=>t.addProtocol(e)),e.latency>=0&&t.updateLatency(e.latency)):this.peers.set(e.id,e)}get(e){return this.peers.get(e)}remove(e){this.peers.delete(e)}has(e){return this.peers.has(e)}all(){return Array.from(this.peers.values())}topPeers(e=10){return this.all().filter(e=>!e.blocked&&e.score>-100).sort((e,t)=>t.score-e.score).slice(0,e)}trustedPeers(){return this.all().filter(e=>e.trusted&&!e.blocked)}pruneStale(e=36e5){for(const[t,s]of this.peers)s.isStale(e)&&!s.trusted&&this.peers.delete(t)}get size(){return this.peers.size}toJSON(){return Array.from(this.peers.values()).map(e=>e.toJSON())}static fromJSON(e){const t=new It;return e.forEach(e=>t.add(Tt.fromJSON(e))),t}}let Ct,Pt;const xt=new WeakMap,At=new WeakMap,kt=new WeakMap,Nt=new WeakMap,Rt=new WeakMap;let Mt={get(e,t,s){if(e instanceof IDBTransaction){if("done"===t)return At.get(e);if("objectStoreNames"===t)return e.objectStoreNames||kt.get(e);if("store"===t)return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return Bt(e[t])},set:(e,t,s)=>(e[t]=s,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function Lt(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(Pt||(Pt=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(Ut(this),t),Bt(xt.get(this))}:function(...t){return Bt(e.apply(Ut(this),t))}:function(t,...s){const r=e.call(Ut(this),t,...s);return kt.set(r,t.sort?t.sort():[t]),Bt(r)}}function Ot(e){return"function"==typeof e?Lt(e):(e instanceof IDBTransaction&&function(e){if(At.has(e))return;const t=new Promise((t,s)=>{const r=()=>{e.removeEventListener("complete",n),e.removeEventListener("error",i),e.removeEventListener("abort",i)},n=()=>{t(),r()},i=()=>{s(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",n),e.addEventListener("error",i),e.addEventListener("abort",i)});At.set(e,t)}(e),t=e,(Ct||(Ct=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some(e=>t instanceof e)?new Proxy(e,Mt):e);var t}function Bt(e){if(e instanceof IDBRequest)return function(e){const t=new Promise((t,s)=>{const r=()=>{e.removeEventListener("success",n),e.removeEventListener("error",i)},n=()=>{t(Bt(e.result)),r()},i=()=>{s(e.error),r()};e.addEventListener("success",n),e.addEventListener("error",i)});return t.then(t=>{t instanceof IDBCursor&&xt.set(t,e)}).catch(()=>{}),Rt.set(t,e),t}(e);if(Nt.has(e))return Nt.get(e);const t=Ot(e);return t!==e&&(Nt.set(e,t),Rt.set(t,e)),t}const Ut=e=>Rt.get(e);const Vt=["get","getKey","getAll","getAllKeys","count"],Ft=["put","add","delete","clear"],zt=new Map;function $t(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(zt.get(t))return zt.get(t);const s=t.replace(/FromIndex$/,""),r=t!==s,n=Ft.includes(s);if(!(s in(r?IDBIndex:IDBObjectStore).prototype)||!n&&!Vt.includes(s))return;const i=async function(e,...t){const i=this.transaction(e,n?"readwrite":"readonly");let o=i.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[s](...t),n&&i.done]))[0]};return zt.set(t,i),i}Mt=(e=>({...e,get:(t,s,r)=>$t(t,s)||e.get(t,s,r),has:(t,s)=>!!$t(t,s)||e.has(t,s)}))(Mt);class qt{constructor(e=tt.name,t=tt.version){this.dbName=e,this.version=t,this._db=null,this._ready=!1}async init(){this._ready||(this._db=await function(e,t,{blocked:s,upgrade:r,blocking:n,terminated:i}={}){const o=indexedDB.open(e,t),a=Bt(o);return r&&o.addEventListener("upgradeneeded",e=>{r(Bt(o.result),e.oldVersion,e.newVersion,Bt(o.transaction),e)}),s&&o.addEventListener("blocked",e=>s(e.oldVersion,e.newVersion,e)),a.then(e=>{i&&e.addEventListener("close",()=>i()),n&&e.addEventListener("versionchange",e=>n(e.oldVersion,e.newVersion,e))}).catch(()=>{}),a}(this.dbName,this.version,{upgrade(e,t,s,r){if(e.objectStoreNames.contains("identity")||e.createObjectStore("identity",{keyPath:"id"}),!e.objectStoreNames.contains("peers")){const t=e.createObjectStore("peers",{keyPath:"id"});t.createIndex("by-score","score"),t.createIndex("by-seen","seen"),t.createIndex("by-trusted","trusted")}if(!e.objectStoreNames.contains("rooms")){const t=e.createObjectStore("rooms",{keyPath:"id"});t.createIndex("by-lastSync","lastSync"),t.createIndex("by-name","name")}if(!e.objectStoreNames.contains("messages")){const t=e.createObjectStore("messages",{keyPath:"id"});t.createIndex("by-room","room"),t.createIndex("by-from","from"),t.createIndex("by-ts","ts"),t.createIndex("by-room-ts",["room","ts"])}if(!e.objectStoreNames.contains("blobs")){const t=e.createObjectStore("blobs",{keyPath:"hash"});t.createIndex("by-refs","refs"),t.createIndex("by-pinned","pinned")}if(!e.objectStoreNames.contains("offline-queue")){e.createObjectStore("offline-queue",{keyPath:"id",autoIncrement:!0}).createIndex("by-ts","ts")}}}),this._ready=!0)}async get(e,t){return await this.init(),this._db.get(e,t)}async getAll(e){return await this.init(),this._db.getAll(e)}async getAllByIndex(e,t,s){return await this.init(),this._db.getAllFromIndex(e,t,s)}async getRange(e,t,s){return await this.init(),this._db.getAllFromIndex(e,t,s)}async put(e,t){return await this.init(),this._db.put(e,t)}async putMany(e,t){await this.init();const s=this._db.transaction(e,"readwrite");await Promise.all([...t.map(e=>s.store.put(e)),s.done])}async delete(e,t){return await this.init(),this._db.delete(e,t)}async clear(e){return await this.init(),this._db.clear(e)}async count(e){return await this.init(),this._db.count(e)}async keys(e){return await this.init(),this._db.getAllKeys(e)}async has(e,t){return void 0!==await this.get(e,t)}async transaction(e,t,s){await this.init();const r=this._db.transaction(e,t);await s(r),await r.done}close(){this._db&&(this._db.close(),this._db=null,this._ready=!1)}}class Wt{constructor(e=st.maxSize){this.maxSize=e,this.cache=new Map,this.size=0}get(e){if(!this.cache.has(e))return;const t=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,t),t.value}set(e,t,s=0){if(this.cache.has(e)){const t=this.cache.get(e);this.size-=t.size,this.cache.delete(e)}for(;this.size+s>this.maxSize&&this.cache.size>0;){const e=this.cache.keys().next().value,t=this.cache.get(e);this.size-=t.size,this.cache.delete(e)}this.cache.set(e,{value:t,size:s}),this.size+=s}delete(e){if(this.cache.has(e)){const t=this.cache.get(e);this.size-=t.size,this.cache.delete(e)}}clear(){this.cache.clear(),this.size=0}has(e){return this.cache.has(e)}}class Kt{constructor(e){this._store=e,this._cache=new Wt}async put(e,t=!1){const s=await crypto.subtle.digest("SHA-256",e),r=Array.from(new Uint8Array(s)).map(e=>e.toString(16).padStart(2,"0")).join(""),n=await this._store.get("blobs",r);return n?await this._store.put("blobs",{...n,refs:n.refs+1,pinned:n.pinned||t}):await this._store.put("blobs",{hash:r,data:Array.from(e),refs:1,pinned:t,created:Date.now()}),this._cache.set(r,e,e.length),r}async get(e){const t=this._cache.get(e);if(t)return t;const s=await this._store.get("blobs",e);if(!s)return null;const r=new Uint8Array(s.data);return this._cache.set(e,r,r.length),r}async release(e){const t=await this._store.get("blobs",e);t&&(t.refs<=1&&!t.pinned?(await this._store.delete("blobs",e),this._cache.delete(e)):await this._store.put("blobs",{...t,refs:t.refs-1}))}async pin(e){const t=await this._store.get("blobs",e);t&&await this._store.put("blobs",{...t,pinned:!0})}async unpin(e){const t=await this._store.get("blobs",e);t&&await this._store.put("blobs",{...t,pinned:!1})}async has(e){return await this._store.has("blobs",e)}async getStorageUsed(){return(await this._store.getAll("blobs")).reduce((e,t)=>e+t.data.length,0)}async gc(){const e=await this._store.getAll("blobs");for(const t of e)t.refs<=0&&!t.pinned&&(await this._store.delete("blobs",t.hash),this._cache.delete(t.hash))}}let jt=null;async function Ht(){return jt||(jt=new qt,await jt.init()),jt}async function Gt(){const e=await Ht();return new Kt(e)}const Qt="self";class Xt{constructor(e,t={}){this.keyPair=e,this.peerId=St(e.signing.publicKey),this.created=t.created||Date.now(),this.name=t.name||null,this.avatar=t.avatar||null}static generate(e={}){const t=vt.generate();return new Xt(t,{...e,created:Date.now()})}get publicKey(){return this.keyPair.signing.publicKey}get boxPublicKey(){return this.keyPair.box.publicKey}sign(e){return this.keyPair.sign(e)}verify(e,t,s){return this.keyPair.verify(e,t,s)}encrypt(e,t){return this.keyPair.encrypt(e,t)}decrypt(e,t){return this.keyPair.decrypt(e,t)}deriveSecret(e){return this.keyPair.deriveSecret(e)}toJSON(){return{keyPair:this.keyPair.toJSON(),peerId:this.peerId,created:this.created,name:this.name,avatar:this.avatar}}static fromJSON(e){const t=vt.fromJSON(e.keyPair);return new Xt(t,{created:e.created,name:e.name,avatar:e.avatar})}toPublic(){return{peerId:this.peerId,publicKey:mt(this.publicKey),boxPublicKey:mt(this.boxPublicKey),name:this.name,avatar:this.avatar}}}class Yt{constructor(e=null){this._store=e,this._identity=null,this._initialized=!1}async init(e=null){return this._initialized||(this._store=e||await Ht(),this._identity=await this._load(),this._initialized=!0),this._identity}async _load(){try{const e=await this._store.get("identity",Qt);if(e)return Xt.fromJSON(e)}catch(e){console.warn("Failed to load identity:",e)}const e=Xt.generate();return await this._save(e),e}async _save(e){await this._store.put("identity",{id:Qt,...e.toJSON()})}get identity(){if(!this._initialized)throw new Error("IdentityManager not initialized. Call init() first.");return this._identity}get peerId(){return this.identity.peerId}async update(e){void 0!==e.name&&(this._identity.name=e.name),void 0!==e.avatar&&(this._identity.avatar=e.avatar),await this._save(this._identity)}async reset(){return this._identity=Xt.generate(),await this._save(this._identity),this._identity}export(){return JSON.stringify(this._identity.toJSON())}async import(e){const t="string"==typeof e?JSON.parse(e):e;return this._identity=Xt.fromJSON(t),await this._save(this._identity),this._identity}}let Jt=null;function Zt(){return Jt||(Jt=new Yt),Jt}async function es(){const e=Zt();return await e.init()}let ts=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},ss=class extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}},rs=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};class ns extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){const t=this.#e.get(e);return null==t?0:t.length}addEventListener(e,t,s){super.addEventListener(e,t,s);let r=this.#e.get(e);null==r&&(r=[],this.#e.set(e,r)),r.push({callback:t,once:(!0!==s&&!1!==s&&s?.once)??!1})}removeEventListener(e,t,s){super.removeEventListener(e.toString(),t??null,s);let r=this.#e.get(e);null!=r&&(r=r.filter(({callback:e})=>e!==t),this.#e.set(e,r))}dispatchEvent(e){const t=super.dispatchEvent(e);let s=this.#e.get(e.type);return null==s||(s=s.filter(({once:e})=>!e),this.#e.set(e.type,s)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}}const is=Symbol.for("@achingbrain/uint8arraylist");function os(e,t){if(null==t||t<0)throw new RangeError("index is out of bounds");let s=0;for(const r of e){const e=s+r.byteLength;if(t<e)return{buf:r,index:t-s};s=e}throw new RangeError("index is out of bounds")}function as(e){return Boolean(e?.[is])}class cs{bufs;length;[is]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const s of e)if(s instanceof Uint8Array)t+=s.byteLength,this.bufs.push(s);else{if(!as(s))throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");t+=s.byteLength,this.bufs.push(...s.bufs)}this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const s of e.reverse())if(s instanceof Uint8Array)t+=s.byteLength,this.bufs.unshift(s);else{if(!as(s))throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");t+=s.byteLength,this.bufs.unshift(...s.bufs)}this.length+=t}get(e){const t=os(this.bufs,e);return t.buf[t.index]}set(e,t){const s=os(this.bufs,e);s.buf[s.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let s=0;s<e.length;s++)this.set(t+s,e[s]);else{if(!as(e))throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList");for(let s=0;s<e.length;s++)this.set(t+s,e.get(s))}}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength)return this.bufs=[],void(this.length=0);for(;this.bufs.length>0;){if(!(e>=this.bufs[0].byteLength)){this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift()}}}slice(e,t){const{bufs:s,length:r}=this._subList(e,t);return u(s,r)}subarray(e,t){const{bufs:s,length:r}=this._subList(e,t);return 1===s.length?s[0]:u(s,r)}sublist(e,t){const{bufs:s,length:r}=this._subList(e,t),n=new cs;return n.length=r,n.bufs=[...s],n}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(0===e&&t===this.length)return{bufs:this.bufs,length:this.length};const s=[];let r=0;for(let n=0;n<this.bufs.length;n++){const i=this.bufs[n],o=r,a=o+i.byteLength;if(r=a,e>=a)continue;const c=e>=o&&e<a,l=t>o&&t<=a;if(c&&l){if(e===o&&t===a){s.push(i);break}const r=e-o;s.push(i.subarray(r,r+(t-e)));break}if(c){if(0===e){s.push(i);continue}s.push(i.subarray(e-o))}else{if(l){if(t===a){s.push(i);break}s.push(i.subarray(0,t-o));break}s.push(i)}}return{bufs:s,length:t-e}}indexOf(e,t=0){if(!(as(e)||e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const s=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),0===e.length)return t>this.length?this.length:t;const r=s.byteLength;if(0===r)throw new TypeError("search must be at least 1 byte long");const n=new Int32Array(256);for(let e=0;e<256;e++)n[e]=-1;for(let e=0;e<r;e++)n[s[e]]=e;const i=n,o=this.byteLength-s.byteLength,a=s.byteLength-1;let c;for(let e=t;e<=o;e+=c){c=0;for(let t=a;t>=0;t--){const r=this.get(e+t);if(s[t]!==r){c=Math.max(1,t-i[r]);break}}if(0===c)return e}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const s=l(1);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt8(0,t),this.write(s,e)}getInt16(e,t){const s=this.subarray(e,e+2);return new DataView(s.buffer,s.byteOffset,s.byteLength).getInt16(0,t)}setInt16(e,t,s){const r=c(2);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt16(0,t,s),this.write(r,e)}getInt32(e,t){const s=this.subarray(e,e+4);return new DataView(s.buffer,s.byteOffset,s.byteLength).getInt32(0,t)}setInt32(e,t,s){const r=c(4);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt32(0,t,s),this.write(r,e)}getBigInt64(e,t){const s=this.subarray(e,e+8);return new DataView(s.buffer,s.byteOffset,s.byteLength).getBigInt64(0,t)}setBigInt64(e,t,s){const r=c(8);new DataView(r.buffer,r.byteOffset,r.byteLength).setBigInt64(0,t,s),this.write(r,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const s=l(1);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint8(0,t),this.write(s,e)}getUint16(e,t){const s=this.subarray(e,e+2);return new DataView(s.buffer,s.byteOffset,s.byteLength).getUint16(0,t)}setUint16(e,t,s){const r=c(2);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint16(0,t,s),this.write(r,e)}getUint32(e,t){const s=this.subarray(e,e+4);return new DataView(s.buffer,s.byteOffset,s.byteLength).getUint32(0,t)}setUint32(e,t,s){const r=c(4);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint32(0,t,s),this.write(r,e)}getBigUint64(e,t){const s=this.subarray(e,e+8);return new DataView(s.buffer,s.byteOffset,s.byteLength).getBigUint64(0,t)}setBigUint64(e,t,s){const r=c(8);new DataView(r.buffer,r.byteOffset,r.byteLength).setBigUint64(0,t,s),this.write(r,e)}getFloat32(e,t){const s=this.subarray(e,e+4);return new DataView(s.buffer,s.byteOffset,s.byteLength).getFloat32(0,t)}setFloat32(e,t,s){const r=c(4);new DataView(r.buffer,r.byteOffset,r.byteLength).setFloat32(0,t,s),this.write(r,e)}getFloat64(e,t){const s=this.subarray(e,e+8);return new DataView(s.buffer,s.byteOffset,s.byteLength).getFloat64(0,t)}setFloat64(e,t,s){const r=c(8);new DataView(r.buffer,r.byteOffset,r.byteLength).setFloat64(0,t,s),this.write(r,e)}equals(e){if(null==e)return!1;if(!(e instanceof cs))return!1;if(e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!a(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const s=new cs;return s.bufs=e,null==t&&(t=e.reduce((e,t)=>e+t.byteLength,0)),s.length=t,s}}const ls=parseInt("11111",2),hs=parseInt("10000000",2),us=parseInt("01111111",2),ds={0:gs,1:gs,2:function(e,t){const s=fs(e,t),r=t.offset,n=t.offset+s,i=[];for(let t=r;t<n;t++)t===r&&0===e[t]||i.push(e[t]);return t.offset+=s,Uint8Array.from(i)},3:function(e,t){const s=fs(e,t),r=e[t.offset];t.offset++;const n=e.subarray(t.offset,t.offset+s-1);if(t.offset+=s,0!==r)throw new Error("Unused bits in bit string is unimplemented");return n},4:function(e,t){const s=fs(e,t),r=e.subarray(t.offset,t.offset+s);return t.offset+=s,r},5:function(e,t){return t.offset++,null},6:function(e,t){const s=fs(e,t),r=t.offset+s,n=e[t.offset];t.offset++;let i=0,o=0;n<40?(i=0,o=n):n<80?(i=1,o=n-40):(i=2,o=n-80);let a=`${i}.${o}`,c=[];for(;t.offset<r;){const s=e[t.offset];if(t.offset++,c.push(127&s),s<128){c.reverse();let e=0;for(let t=0;t<c.length;t++)e+=c[t]<<7*t;a+=`.${e}`,c=[]}}return a},16:gs,22:gs,48:gs};function ps(e,t={offset:0}){const s=e[t.offset]&ls;if(t.offset++,null!=ds[s])return ds[s](e,t);throw new Error("No decoder for tag "+s)}function fs(e,t){let s=0;if((e[t.offset]&hs)===hs){const r=e[t.offset]&us;let n="0x";t.offset++;for(let s=0;s<r;s++,t.offset++)n+=e[t.offset].toString(16).padStart(2,"0");s=parseInt(n,16)}else s=e[t.offset],t.offset++;return s}function gs(e,t){fs(e,t);const s=[];for(;!(t.offset>=e.byteLength);){const r=ps(e,t);if(null===r)break;s.push(r)}return s}function ms(e){if(e.byteLength<128)return Uint8Array.from([e.byteLength]);const t=function(e){let t=e.toString(16);t.length%2==1&&(t="0"+t);const s=new cs;for(let e=0;e<t.length;e+=2)s.append(Uint8Array.from([parseInt(`${t[e]}${t[e+1]}`,16)]));return s}(e.byteLength);return new cs(Uint8Array.from([t.byteLength|hs]),t)}function ys(e){const t=new cs;return!(128&~e.subarray()[0])&&t.append(Uint8Array.from([0])),t.append(e),new cs(Uint8Array.from([2]),ms(t),t)}function bs(e){const t=Uint8Array.from([0]),s=new cs(t,e);return new cs(Uint8Array.from([3]),ms(s),s)}function ws(e,t=48){const s=new cs;for(const t of e)s.append(t);return new cs(Uint8Array.from([t]),ms(s),s)}const vs=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),Ss=Uint8Array.from([6,5,43,129,4,0,34]),Es=Uint8Array.from([6,5,43,129,4,0,35]),Ds={ext:!0,kty:"EC",crv:"P-256"},_s={ext:!0,kty:"EC",crv:"P-384"},Ts={ext:!0,kty:"EC",crv:"P-521"},Is=32,Cs=48,Ps=66;function xs(e){return function(e){const t=e[1][1][0],s=1;let r,n;if(65===t.byteLength)return r=Qe(t.subarray(s,s+Is),"base64url"),n=Qe(t.subarray(s+Is),"base64url"),new ks({...Ds,key_ops:["verify"],x:r,y:n});if(97===t.byteLength)return r=Qe(t.subarray(s,s+Cs),"base64url"),n=Qe(t.subarray(s+Cs),"base64url"),new ks({..._s,key_ops:["verify"],x:r,y:n});if(133===t.byteLength)return r=Qe(t.subarray(s,s+Ps),"base64url"),n=Qe(t.subarray(s+Ps),"base64url"),new ks({...Ts,key_ops:["verify"],x:r,y:n});throw new ts(`coordinates were wrong length, got ${t.byteLength}, expected 65, 97 or 133`)}(ps(e))}function As(e){if("P-256"===e)return vs;if("P-384"===e)return Ss;if("P-521"===e)return Es;throw new ts(`Invalid curve ${e}`)}class ks{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return null==this._raw&&(this._raw=function(e){return ws([ys(Uint8Array.from([1])),ws([As(e.crv)],160),ws([bs(new cs(Uint8Array.from([4]),Ge(e.x??"","base64url"),Ge(e.y??"","base64url")))],161)]).subarray()}(this.jwk)),this._raw}toMultihash(){return ke.digest(Ho(this))}toCID(){return Ue.createV1(114,this.toMultihash())}toString(){return G.encode(this.toMultihash().bytes).substring(1)}equals(e){return null!=e&&e.raw instanceof Uint8Array&&a(this.raw,e.raw)}async verify(e,t,s){return async function(e,t,s,r){const n=await crypto.subtle.importKey("jwk",e,{name:"ECDSA",namedCurve:e.crv??"P-256"},!1,["verify"]);r?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},n,t,s.subarray());return r?.signal?.throwIfAborted(),i}(this.jwk,t,e,s)}}
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Ns(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&"Uint8Array"===e.constructor.name}function Rs(e,t=""){if(!Number.isSafeInteger(e)||e<0){throw new Error(`${t&&`"${t}" `}expected integer >= 0, got ${e}`)}}function Ms(e,t,s=""){const r=Ns(e),n=e?.length,i=void 0!==t;if(!r||i&&n!==t){throw new Error((s&&`"${s}" `)+"expected Uint8Array"+(i?` of length ${t}`:"")+", got "+(r?`length=${n}`:"type="+typeof e))}return e}function Ls(e){if("function"!=typeof e||"function"!=typeof e.create)throw new Error("Hash must wrapped by utils.createHasher");Rs(e.outputLen),Rs(e.blockLen)}function Os(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Bs(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function Us(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function Vs(e,t){return e<<32-t|e>>>t}const Fs=(()=>"function"==typeof Uint8Array.from([]).toHex&&"function"==typeof Uint8Array.fromHex)(),zs=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));function $s(e){if(Ms(e),Fs)return e.toHex();let t="";for(let s=0;s<e.length;s++)t+=zs[e[s]];return t}const qs=48,Ws=57,Ks=65,js=70,Hs=97,Gs=102;function Qs(e){return e>=qs&&e<=Ws?e-qs:e>=Ks&&e<=js?e-(Ks-10):e>=Hs&&e<=Gs?e-(Hs-10):void 0}function Xs(e){if("string"!=typeof e)throw new Error("hex string expected, got "+typeof e);if(Fs)return Uint8Array.fromHex(e);const t=e.length,s=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);const r=new Uint8Array(s);for(let t=0,n=0;t<s;t++,n+=2){const s=Qs(e.charCodeAt(n)),i=Qs(e.charCodeAt(n+1));if(void 0===s||void 0===i){const t=e[n]+e[n+1];throw new Error('hex string expected, got non-hex character "'+t+'" at index '+n)}r[t]=16*s+i}return r}function Ys(...e){let t=0;for(let s=0;s<e.length;s++){const r=e[s];Ms(r),t+=r.length}const s=new Uint8Array(t);for(let t=0,r=0;t<e.length;t++){const n=e[t];s.set(n,r),r+=n.length}return s}function Js(e,t={}){const s=(t,s)=>e(s).update(t).digest(),r=e(void 0);return s.outputLen=r.outputLen,s.blockLen=r.blockLen,s.create=t=>e(t),Object.assign(s,t),Object.freeze(s)}function Zs(e=32){const t="object"==typeof globalThis?globalThis.crypto:null;if("function"!=typeof t?.getRandomValues)throw new Error("crypto.getRandomValues must be defined");return t.getRandomValues(new Uint8Array(e))}const er=e=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,e])});function tr(e,t,s){return e&t^~e&s}function sr(e,t,s){return e&t^e&s^t&s}let rr=class{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,s,r){this.blockLen=e,this.outputLen=t,this.padOffset=s,this.isLE=r,this.buffer=new Uint8Array(e),this.view=Us(this.buffer)}update(e){Os(this),Ms(e);const{view:t,buffer:s,blockLen:r}=this,n=e.length;for(let i=0;i<n;){const o=Math.min(r-this.pos,n-i);if(o===r){const t=Us(e);for(;r<=n-i;i+=r)this.process(t,i);continue}s.set(e.subarray(i,i+o),this.pos),this.pos+=o,i+=o,this.pos===r&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Os(this),function(e,t){Ms(e,void 0,"digestInto() output");const s=t.outputLen;if(e.length<s)throw new Error('"digestInto() output" expected to be of length >='+s)}(e,this),this.finished=!0;const{buffer:t,view:s,blockLen:r,isLE:n}=this;let{pos:i}=this;t[i++]=128,Bs(this.buffer.subarray(i)),this.padOffset>r-i&&(this.process(s,0),i=0);for(let e=i;e<r;e++)t[e]=0;s.setBigUint64(r-8,BigInt(8*this.length),n),this.process(s,0);const o=Us(e),a=this.outputLen;if(a%4)throw new Error("_sha2: outputLen must be aligned to 32bit");const c=a/4,l=this.get();if(c>l.length)throw new Error("_sha2: outputLen bigger than state");for(let e=0;e<c;e++)o.setUint32(4*e,l[e],n)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const s=e.slice(0,t);return this.destroy(),s}_cloneInto(e){e||=new this.constructor,e.set(...this.get());const{blockLen:t,buffer:s,length:r,finished:n,destroyed:i,pos:o}=this;return e.destroyed=i,e.finished=n,e.length=r,e.pos=o,r%t&&e.buffer.set(s),e}clone(){return this._cloneInto()}};const nr=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),ir=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),or=BigInt(2**32-1),ar=BigInt(32);function cr(e,t=!1){return t?{h:Number(e&or),l:Number(e>>ar&or)}:{h:0|Number(e>>ar&or),l:0|Number(e&or)}}const lr=(e,t,s)=>e>>>s,hr=(e,t,s)=>e<<32-s|t>>>s,ur=(e,t,s)=>e>>>s|t<<32-s,dr=(e,t,s)=>e<<32-s|t>>>s,pr=(e,t,s)=>e<<64-s|t>>>s-32,fr=(e,t,s)=>e>>>s-32|t<<64-s;function gr(e,t,s,r){const n=(t>>>0)+(r>>>0);return{h:e+s+(n/2**32|0)|0,l:0|n}}const mr=(e,t,s)=>(e>>>0)+(t>>>0)+(s>>>0),yr=(e,t,s,r)=>t+s+r+(e/2**32|0)|0,br=(e,t,s,r)=>(e>>>0)+(t>>>0)+(s>>>0)+(r>>>0),wr=(e,t,s,r,n)=>t+s+r+n+(e/2**32|0)|0,vr=(e,t,s,r,n)=>(e>>>0)+(t>>>0)+(s>>>0)+(r>>>0)+(n>>>0),Sr=(e,t,s,r,n,i)=>t+s+r+n+i+(e/2**32|0)|0,Er=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Dr=new Uint32Array(64);let _r=class extends rr{constructor(e){super(64,e,8,!1)}get(){const{A:e,B:t,C:s,D:r,E:n,F:i,G:o,H:a}=this;return[e,t,s,r,n,i,o,a]}set(e,t,s,r,n,i,o,a){this.A=0|e,this.B=0|t,this.C=0|s,this.D=0|r,this.E=0|n,this.F=0|i,this.G=0|o,this.H=0|a}process(e,t){for(let s=0;s<16;s++,t+=4)Dr[s]=e.getUint32(t,!1);for(let e=16;e<64;e++){const t=Dr[e-15],s=Dr[e-2],r=Vs(t,7)^Vs(t,18)^t>>>3,n=Vs(s,17)^Vs(s,19)^s>>>10;Dr[e]=n+Dr[e-7]+r+Dr[e-16]|0}let{A:s,B:r,C:n,D:i,E:o,F:a,G:c,H:l}=this;for(let e=0;e<64;e++){const t=l+(Vs(o,6)^Vs(o,11)^Vs(o,25))+tr(o,a,c)+Er[e]+Dr[e]|0,h=(Vs(s,2)^Vs(s,13)^Vs(s,22))+sr(s,r,n)|0;l=c,c=a,a=o,o=i+t|0,i=n,n=r,r=s,s=t+h|0}s=s+this.A|0,r=r+this.B|0,n=n+this.C|0,i=i+this.D|0,o=o+this.E|0,a=a+this.F|0,c=c+this.G|0,l=l+this.H|0,this.set(s,r,n,i,o,a,c,l)}roundClean(){Bs(Dr)}destroy(){this.set(0,0,0,0,0,0,0,0),Bs(this.buffer)}},Tr=class extends _r{A=0|nr[0];B=0|nr[1];C=0|nr[2];D=0|nr[3];E=0|nr[4];F=0|nr[5];G=0|nr[6];H=0|nr[7];constructor(){super(32)}};const Ir=(()=>function(e,t=!1){const s=e.length;let r=new Uint32Array(s),n=new Uint32Array(s);for(let i=0;i<s;i++){const{h:s,l:o}=cr(e[i],t);[r[i],n[i]]=[s,o]}return[r,n]}(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(e=>BigInt(e))))(),Cr=(()=>Ir[0])(),Pr=(()=>Ir[1])(),xr=new Uint32Array(80),Ar=new Uint32Array(80);class kr extends rr{constructor(e){super(128,e,16,!1)}get(){const{Ah:e,Al:t,Bh:s,Bl:r,Ch:n,Cl:i,Dh:o,Dl:a,Eh:c,El:l,Fh:h,Fl:u,Gh:d,Gl:p,Hh:f,Hl:g}=this;return[e,t,s,r,n,i,o,a,c,l,h,u,d,p,f,g]}set(e,t,s,r,n,i,o,a,c,l,h,u,d,p,f,g){this.Ah=0|e,this.Al=0|t,this.Bh=0|s,this.Bl=0|r,this.Ch=0|n,this.Cl=0|i,this.Dh=0|o,this.Dl=0|a,this.Eh=0|c,this.El=0|l,this.Fh=0|h,this.Fl=0|u,this.Gh=0|d,this.Gl=0|p,this.Hh=0|f,this.Hl=0|g}process(e,t){for(let s=0;s<16;s++,t+=4)xr[s]=e.getUint32(t),Ar[s]=e.getUint32(t+=4);for(let e=16;e<80;e++){const t=0|xr[e-15],s=0|Ar[e-15],r=ur(t,s,1)^ur(t,s,8)^lr(t,0,7),n=dr(t,s,1)^dr(t,s,8)^hr(t,s,7),i=0|xr[e-2],o=0|Ar[e-2],a=ur(i,o,19)^pr(i,o,61)^lr(i,0,6),c=dr(i,o,19)^fr(i,o,61)^hr(i,o,6),l=br(n,c,Ar[e-7],Ar[e-16]),h=wr(l,r,a,xr[e-7],xr[e-16]);xr[e]=0|h,Ar[e]=0|l}let{Ah:s,Al:r,Bh:n,Bl:i,Ch:o,Cl:a,Dh:c,Dl:l,Eh:h,El:u,Fh:d,Fl:p,Gh:f,Gl:g,Hh:m,Hl:y}=this;for(let e=0;e<80;e++){const t=ur(h,u,14)^ur(h,u,18)^pr(h,u,41),b=dr(h,u,14)^dr(h,u,18)^fr(h,u,41),w=h&d^~h&f,v=vr(y,b,u&p^~u&g,Pr[e],Ar[e]),S=Sr(v,m,t,w,Cr[e],xr[e]),E=0|v,D=ur(s,r,28)^pr(s,r,34)^pr(s,r,39),_=dr(s,r,28)^fr(s,r,34)^fr(s,r,39),T=s&n^s&o^n&o,I=r&i^r&a^i&a;m=0|f,y=0|g,f=0|d,g=0|p,d=0|h,p=0|u,({h:h,l:u}=gr(0|c,0|l,0|S,0|E)),c=0|o,l=0|a,o=0|n,a=0|i,n=0|s,i=0|r;const C=mr(E,_,I);s=yr(C,S,D,T),r=0|C}({h:s,l:r}=gr(0|this.Ah,0|this.Al,0|s,0|r)),({h:n,l:i}=gr(0|this.Bh,0|this.Bl,0|n,0|i)),({h:o,l:a}=gr(0|this.Ch,0|this.Cl,0|o,0|a)),({h:c,l:l}=gr(0|this.Dh,0|this.Dl,0|c,0|l)),({h:h,l:u}=gr(0|this.Eh,0|this.El,0|h,0|u)),({h:d,l:p}=gr(0|this.Fh,0|this.Fl,0|d,0|p)),({h:f,l:g}=gr(0|this.Gh,0|this.Gl,0|f,0|g)),({h:m,l:y}=gr(0|this.Hh,0|this.Hl,0|m,0|y)),this.set(s,r,n,i,o,a,c,l,h,u,d,p,f,g,m,y)}roundClean(){Bs(xr,Ar)}destroy(){Bs(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}class Nr extends kr{Ah=0|ir[0];Al=0|ir[1];Bh=0|ir[2];Bl=0|ir[3];Ch=0|ir[4];Cl=0|ir[5];Dh=0|ir[6];Dl=0|ir[7];Eh=0|ir[8];El=0|ir[9];Fh=0|ir[10];Fl=0|ir[11];Gh=0|ir[12];Gl=0|ir[13];Hh=0|ir[14];Hl=0|ir[15];constructor(){super(64)}}const Rr=Js(()=>new Tr,er(1)),Mr=Js(()=>new Nr,er(3)),Lr=BigInt(0),Or=BigInt(1);function Br(e,t=""){if("boolean"!=typeof e){throw new Error((t&&`"${t}" `)+"expected boolean, got type="+typeof e)}return e}function Ur(e){if("bigint"==typeof e){if(!jr(e))throw new Error("positive bigint expected, got "+e)}else Rs(e);return e}function Vr(e){const t=Ur(e).toString(16);return 1&t.length?"0"+t:t}function Fr(e){if("string"!=typeof e)throw new Error("hex string expected, got "+typeof e);return""===e?Lr:BigInt("0x"+e)}function zr(e){return Fr($s(e))}function $r(e){return Fr($s(Kr(Ms(e)).reverse()))}function qr(e,t){Rs(t);const s=Xs((e=Ur(e)).toString(16).padStart(2*t,"0"));if(s.length!==t)throw new Error("number too large");return s}function Wr(e,t){return qr(e,t).reverse()}function Kr(e){return Uint8Array.from(e)}const jr=e=>"bigint"==typeof e&&Lr<=e;function Hr(e,t,s,r){if(!function(e,t,s){return jr(e)&&jr(t)&&jr(s)&&t<=e&&e<s}(t,s,r))throw new Error("expected valid "+e+": "+s+" <= n < "+r+", got "+t)}const Gr=e=>(Or<<BigInt(e))-Or;function Qr(e,t={},s={}){if(!e||"object"!=typeof e)throw new Error("expected valid options object");const r=(t,s)=>Object.entries(t).forEach(([t,r])=>function(t,s,r){const n=e[t];if(r&&void 0===n)return;const i=typeof n;if(i!==s||null===n)throw new Error(`param "${t}" is invalid: expected ${s}, got ${i}`)}(t,r,s));r(t,!1),r(s,!0)}function Xr(e){const t=new WeakMap;return(s,...r)=>{const n=t.get(s);if(void 0!==n)return n;const i=e(s,...r);return t.set(s,i),i}}
/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Yr=BigInt(0),Jr=BigInt(1),Zr=BigInt(2),en=BigInt(3),tn=BigInt(4),sn=BigInt(5),rn=BigInt(7),nn=BigInt(8),on=BigInt(9),an=BigInt(16);function cn(e,t){const s=e%t;return s>=Yr?s:t+s}function ln(e,t,s){let r=e;for(;t-- >Yr;)r*=r,r%=s;return r}function hn(e,t){if(e===Yr)throw new Error("invert: expected non-zero number");if(t<=Yr)throw new Error("invert: expected positive modulus, got "+t);let s=cn(e,t),r=t,n=Yr,i=Jr;for(;s!==Yr;){const e=r%s,t=n-i*(r/s);r=s,s=e,n=i,i=t}if(r!==Jr)throw new Error("invert: does not exist");return cn(n,t)}function un(e,t,s){if(!e.eql(e.sqr(t),s))throw new Error("Cannot find square root")}function dn(e,t){const s=(e.ORDER+Jr)/tn,r=e.pow(t,s);return un(e,r,t),r}function pn(e,t){const s=(e.ORDER-sn)/nn,r=e.mul(t,Zr),n=e.pow(r,s),i=e.mul(t,n),o=e.mul(e.mul(i,Zr),n),a=e.mul(i,e.sub(o,e.ONE));return un(e,a,t),a}function fn(e){if(e<en)throw new Error("sqrt is not defined for small field");let t=e-Jr,s=0;for(;t%Zr===Yr;)t/=Zr,s++;let r=Zr;const n=vn(e);for(;1===bn(n,r);)if(r++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(1===s)return dn;let i=n.pow(r,t);const o=(t+Jr)/Zr;return function(e,r){if(e.is0(r))return r;if(1!==bn(e,r))throw new Error("Cannot find square root");let n=s,a=e.mul(e.ONE,i),c=e.pow(r,t),l=e.pow(r,o);for(;!e.eql(c,e.ONE);){if(e.is0(c))return e.ZERO;let t=1,s=e.sqr(c);for(;!e.eql(s,e.ONE);)if(t++,s=e.sqr(s),t===n)throw new Error("Cannot find square root");const r=Jr<<BigInt(n-t-1),i=e.pow(a,r);n=t,a=e.sqr(i),c=e.mul(c,a),l=e.mul(l,i)}return l}}function gn(e){return e%tn===en?dn:e%nn===sn?pn:e%an===on?function(e){const t=vn(e),s=fn(e),r=s(t,t.neg(t.ONE)),n=s(t,r),i=s(t,t.neg(r)),o=(e+rn)/an;return(e,t)=>{let s=e.pow(t,o),a=e.mul(s,r);const c=e.mul(s,n),l=e.mul(s,i),h=e.eql(e.sqr(a),t),u=e.eql(e.sqr(c),t);s=e.cmov(s,a,h),a=e.cmov(l,c,u);const d=e.eql(e.sqr(a),t),p=e.cmov(s,a,d);return un(e,p,t),p}}(e):fn(e)}const mn=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function yn(e,t,s=!1){const r=new Array(t.length).fill(s?e.ZERO:void 0),n=t.reduce((t,s,n)=>e.is0(s)?t:(r[n]=t,e.mul(t,s)),e.ONE),i=e.inv(n);return t.reduceRight((t,s,n)=>e.is0(s)?t:(r[n]=e.mul(t,r[n]),e.mul(t,s)),i),r}function bn(e,t){const s=(e.ORDER-Jr)/Zr,r=e.pow(t,s),n=e.eql(r,e.ONE),i=e.eql(r,e.ZERO),o=e.eql(r,e.neg(e.ONE));if(!n&&!i&&!o)throw new Error("invalid Legendre symbol result");return n?1:i?0:-1}class wn{ORDER;BITS;BYTES;isLE;ZERO=Yr;ONE=Jr;_lengths;_sqrt;_mod;constructor(e,t={}){if(e<=Yr)throw new Error("invalid field: expected ORDER > 0, got "+e);let s;this.isLE=!1,null!=t&&"object"==typeof t&&("number"==typeof t.BITS&&(s=t.BITS),"function"==typeof t.sqrt&&(this.sqrt=t.sqrt),"boolean"==typeof t.isLE&&(this.isLE=t.isLE),t.allowedLengths&&(this._lengths=t.allowedLengths?.slice()),"boolean"==typeof t.modFromBytes&&(this._mod=t.modFromBytes));const{nBitLength:r,nByteLength:n}=function(e,t){void 0!==t&&Rs(t);const s=void 0!==t?t:e.toString(2).length;return{nBitLength:s,nByteLength:Math.ceil(s/8)}}(e,s);if(n>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");this.ORDER=e,this.BITS=r,this.BYTES=n,this._sqrt=void 0,Object.preventExtensions(this)}create(e){return cn(e,this.ORDER)}isValid(e){if("bigint"!=typeof e)throw new Error("invalid field element: expected bigint, got "+typeof e);return Yr<=e&&e<this.ORDER}is0(e){return e===Yr}isValidNot0(e){return!this.is0(e)&&this.isValid(e)}isOdd(e){return(e&Jr)===Jr}neg(e){return cn(-e,this.ORDER)}eql(e,t){return e===t}sqr(e){return cn(e*e,this.ORDER)}add(e,t){return cn(e+t,this.ORDER)}sub(e,t){return cn(e-t,this.ORDER)}mul(e,t){return cn(e*t,this.ORDER)}pow(e,t){return function(e,t,s){if(s<Yr)throw new Error("invalid exponent, negatives unsupported");if(s===Yr)return e.ONE;if(s===Jr)return t;let r=e.ONE,n=t;for(;s>Yr;)s&Jr&&(r=e.mul(r,n)),n=e.sqr(n),s>>=Jr;return r}(this,e,t)}div(e,t){return cn(e*hn(t,this.ORDER),this.ORDER)}sqrN(e){return e*e}addN(e,t){return e+t}subN(e,t){return e-t}mulN(e,t){return e*t}inv(e){return hn(e,this.ORDER)}sqrt(e){return this._sqrt||(this._sqrt=gn(this.ORDER)),this._sqrt(this,e)}toBytes(e){return this.isLE?Wr(e,this.BYTES):qr(e,this.BYTES)}fromBytes(e,t=!1){Ms(e);const{_lengths:s,BYTES:r,isLE:n,ORDER:i,_mod:o}=this;if(s){if(!s.includes(e.length)||e.length>r)throw new Error("Field.fromBytes: expected "+s+" bytes, got "+e.length);const t=new Uint8Array(r);t.set(e,n?0:t.length-e.length),e=t}if(e.length!==r)throw new Error("Field.fromBytes: expected "+r+" bytes, got "+e.length);let a=n?$r(e):zr(e);if(o&&(a=cn(a,i)),!t&&!this.isValid(a))throw new Error("invalid field element: outside of range 0..ORDER");return a}invertBatch(e){return yn(this,e)}cmov(e,t,s){return s?t:e}}function vn(e,t={}){return new wn(e,t)}function Sn(e){if("bigint"!=typeof e)throw new Error("field order must be bigint");const t=e.toString(2).length;return Math.ceil(t/8)}function En(e){const t=Sn(e);return t+Math.ceil(t/2)}
/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */
const Dn=BigInt(0),_n=BigInt(1);function Tn(e,t){const s=t.negate();return e?s:t}function In(e,t){const s=yn(e.Fp,t.map(e=>e.Z));return t.map((t,r)=>e.fromAffine(t.toAffine(s[r])))}function Cn(e,t){if(!Number.isSafeInteger(e)||e<=0||e>t)throw new Error("invalid window size, expected [1.."+t+"], got W="+e)}function Pn(e,t){Cn(e,t);const s=2**e;return{windows:Math.ceil(t/e)+1,windowSize:2**(e-1),mask:Gr(e),maxNumber:s,shiftBy:BigInt(e)}}function xn(e,t,s){const{windowSize:r,mask:n,maxNumber:i,shiftBy:o}=s;let a=Number(e&n),c=e>>o;a>r&&(a-=i,c+=_n);const l=t*r;return{nextN:c,offset:l+Math.abs(a)-1,isZero:0===a,isNeg:a<0,isNegF:t%2!=0,offsetF:l}}const An=new WeakMap,kn=new WeakMap;function Nn(e){return kn.get(e)||1}function Rn(e){if(e!==Dn)throw new Error("invalid wNAF")}class Mn{BASE;ZERO;Fn;bits;constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,s=this.ZERO){let r=e;for(;t>Dn;)t&_n&&(s=s.add(r)),r=r.double(),t>>=_n;return s}precomputeWindow(e,t){const{windows:s,windowSize:r}=Pn(t,this.bits),n=[];let i=e,o=i;for(let e=0;e<s;e++){o=i,n.push(o);for(let e=1;e<r;e++)o=o.add(i),n.push(o);i=o.double()}return n}wNAF(e,t,s){if(!this.Fn.isValid(s))throw new Error("invalid scalar");let r=this.ZERO,n=this.BASE;const i=Pn(e,this.bits);for(let e=0;e<i.windows;e++){const{nextN:o,offset:a,isZero:c,isNeg:l,isNegF:h,offsetF:u}=xn(s,e,i);s=o,c?n=n.add(Tn(h,t[u])):r=r.add(Tn(l,t[a]))}return Rn(s),{p:r,f:n}}wNAFUnsafe(e,t,s,r=this.ZERO){const n=Pn(e,this.bits);for(let e=0;e<n.windows&&s!==Dn;e++){const{nextN:i,offset:o,isZero:a,isNeg:c}=xn(s,e,n);if(s=i,!a){const e=t[o];r=r.add(c?e.negate():e)}}return Rn(s),r}getPrecomputes(e,t,s){let r=An.get(t);return r||(r=this.precomputeWindow(t,e),1!==e&&("function"==typeof s&&(r=s(r)),An.set(t,r))),r}cached(e,t,s){const r=Nn(e);return this.wNAF(r,this.getPrecomputes(r,e,s),t)}unsafe(e,t,s,r){const n=Nn(e);return 1===n?this._unsafeLadder(e,t,r):this.wNAFUnsafe(n,this.getPrecomputes(n,e,s),t,r)}createCache(e,t){Cn(t,this.bits),kn.set(e,t),An.delete(e)}hasCache(e){return 1!==Nn(e)}}function Ln(e,t,s){if(t){if(t.ORDER!==e)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return function(e){const t=mn.reduce((e,t)=>(e[t]="function",e),{ORDER:"bigint",BYTES:"number",BITS:"number"});Qr(e,t)}(t),t}return vn(e,{isLE:s})}function On(e,t,s={},r){if(void 0===r&&(r="edwards"===e),!t||"object"!=typeof t)throw new Error(`expected valid ${e} CURVE object`);for(const e of["p","n","h"]){const s=t[e];if(!("bigint"==typeof s&&s>Dn))throw new Error(`CURVE.${e} must be positive bigint`)}const n=Ln(t.p,s.Fp,r),i=Ln(t.n,s.Fn,r),o=["Gx","Gy","a","weierstrass"===e?"b":"d"];for(const e of o)if(!n.isValid(t[e]))throw new Error(`CURVE.${e} must be valid field element of CURVE.Fp`);return{CURVE:t=Object.freeze(Object.assign({},t)),Fp:n,Fn:i}}function Bn(e,t){return function(s){const r=e(s);return{secretKey:r,publicKey:t(r)}}}
/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Un=BigInt(0),Vn=BigInt(1),Fn=BigInt(2),zn=BigInt(8);function $n(e,t={}){const s=On("edwards",e,t,t.FpFnLE),{Fp:r,Fn:n}=s;let i=s.CURVE;const{h:o}=i;Qr(t,{},{uvRatio:"function"});const a=Fn<<BigInt(8*n.BYTES)-Vn,c=e=>r.create(e),l=t.uvRatio||((e,t)=>{try{return{isValid:!0,value:r.sqrt(r.div(e,t))}}catch(e){return{isValid:!1,value:Un}}});if(!function(e,t,s,r){const n=e.sqr(s),i=e.sqr(r),o=e.add(e.mul(t.a,n),i),a=e.add(e.ONE,e.mul(t.d,e.mul(n,i)));return e.eql(o,a)}(r,i,i.Gx,i.Gy))throw new Error("bad curve params: generator point");function h(e,t,s=!1){return Hr("coordinate "+e,t,s?Vn:Un,a),t}function u(e){if(!(e instanceof f))throw new Error("EdwardsPoint expected")}const d=Xr((e,t)=>{const{X:s,Y:n,Z:i}=e,o=e.is0();null==t&&(t=o?zn:r.inv(i));const a=c(s*t),l=c(n*t),h=r.mul(i,t);if(o)return{x:Un,y:Vn};if(h!==Vn)throw new Error("invZ was invalid");return{x:a,y:l}}),p=Xr(e=>{const{a:t,d:s}=i;if(e.is0())throw new Error("bad point: ZERO");const{X:r,Y:n,Z:o,T:a}=e,l=c(r*r),h=c(n*n),u=c(o*o),d=c(u*u),p=c(l*t);if(c(u*c(p+h))!==c(d+c(s*c(l*h))))throw new Error("bad point: equation left != right (1)");if(c(r*n)!==c(o*a))throw new Error("bad point: equation left != right (2)");return!0});class f{static BASE=new f(i.Gx,i.Gy,Vn,c(i.Gx*i.Gy));static ZERO=new f(Un,Vn,Vn,Un);static Fp=r;static Fn=n;X;Y;Z;T;constructor(e,t,s,r){this.X=h("x",e),this.Y=h("y",t),this.Z=h("z",s,!0),this.T=h("t",r),Object.freeze(this)}static CURVE(){return i}static fromAffine(e){if(e instanceof f)throw new Error("extended point not allowed");const{x:t,y:s}=e||{};return h("x",t),h("y",s),new f(t,s,Vn,c(t*s))}static fromBytes(e,t=!1){const s=r.BYTES,{a:n,d:o}=i;e=Kr(Ms(e,s,"point")),Br(t,"zip215");const h=Kr(e),u=e[s-1];h[s-1]=-129&u;const d=$r(h),p=t?a:r.ORDER;Hr("point.y",d,Un,p);const g=c(d*d),m=c(g-Vn),y=c(o*g-n);let{isValid:b,value:w}=l(m,y);if(!b)throw new Error("bad point: invalid y coordinate");const v=(w&Vn)===Vn,S=!!(128&u);if(!t&&w===Un&&S)throw new Error("bad point: x=0 and x_0=1");return S!==v&&(w=c(-w)),f.fromAffine({x:w,y:d})}static fromHex(e,t=!1){return f.fromBytes(Xs(e),t)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(e=8,t=!0){return g.createCache(this,e),t||this.multiply(Fn),this}assertValidity(){p(this)}equals(e){u(e);const{X:t,Y:s,Z:r}=this,{X:n,Y:i,Z:o}=e,a=c(t*o),l=c(n*r),h=c(s*o),d=c(i*r);return a===l&&h===d}is0(){return this.equals(f.ZERO)}negate(){return new f(c(-this.X),this.Y,this.Z,c(-this.T))}double(){const{a:e}=i,{X:t,Y:s,Z:r}=this,n=c(t*t),o=c(s*s),a=c(Fn*c(r*r)),l=c(e*n),h=t+s,u=c(c(h*h)-n-o),d=l+o,p=d-a,g=l-o,m=c(u*p),y=c(d*g),b=c(u*g),w=c(p*d);return new f(m,y,w,b)}add(e){u(e);const{a:t,d:s}=i,{X:r,Y:n,Z:o,T:a}=this,{X:l,Y:h,Z:d,T:p}=e,g=c(r*l),m=c(n*h),y=c(a*s*p),b=c(o*d),w=c((r+n)*(l+h)-g-m),v=b-y,S=b+y,E=c(m-t*g),D=c(w*v),_=c(S*E),T=c(w*E),I=c(v*S);return new f(D,_,I,T)}subtract(e){return this.add(e.negate())}multiply(e){if(!n.isValidNot0(e))throw new Error("invalid scalar: expected 1 <= sc < curve.n");const{p:t,f:s}=g.cached(this,e,e=>In(f,e));return In(f,[t,s])[0]}multiplyUnsafe(e,t=f.ZERO){if(!n.isValid(e))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return e===Un?f.ZERO:this.is0()||e===Vn?this:g.unsafe(this,e,e=>In(f,e),t)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}isTorsionFree(){return g.unsafe(this,i.n).is0()}toAffine(e){return d(this,e)}clearCofactor(){return o===Vn?this:this.multiplyUnsafe(o)}toBytes(){const{x:e,y:t}=this.toAffine(),s=r.toBytes(t);return s[s.length-1]|=e&Vn?128:0,s}toHex(){return $s(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const g=new Mn(f,n.BITS);return f.BASE.precompute(8),f}function qn(e,t,s={}){if("function"!=typeof t)throw new Error('"hash" function param is required');Qr(s,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:r}=s,{BASE:n,Fp:i,Fn:o}=e,a=s.randomBytes||Zs,c=s.adjustScalarBytes||(e=>e),l=s.domain||((e,t,s)=>{if(Br(s,"phflag"),t.length||s)throw new Error("Contexts/pre-hash are not supported");return e});function h(e){return o.create($r(e))}function u(e){const{head:s,prefix:r,scalar:i}=function(e){const s=m.secretKey;Ms(e,m.secretKey,"secretKey");const r=Ms(t(e),2*s,"hashedSecretKey"),n=c(r.slice(0,s));return{head:n,prefix:r.slice(s,2*s),scalar:h(n)}}(e),o=n.multiply(i),a=o.toBytes();return{head:s,prefix:r,scalar:i,point:o,pointBytes:a}}function d(e){return u(e).pointBytes}function p(e=Uint8Array.of(),...s){const n=Ys(...s);return h(t(l(n,Ms(e,void 0,"context"),!!r)))}const f={zip215:!0};const g=i.BYTES,m={secretKey:g,publicKey:g,signature:2*g,seed:g};function y(e=a(m.seed)){return Ms(e,m.seed,"seed")}const b={getExtendedPublicKey:u,randomSecretKey:y,isValidSecretKey:function(e){return Ns(e)&&e.length===o.BYTES},isValidPublicKey:function(t,s){try{return!!e.fromBytes(t,s)}catch(e){return!1}},toMontgomery(t){const{y:s}=e.fromBytes(t),r=m.publicKey,n=32===r;if(!n&&57!==r)throw new Error("only defined for 25519 and 448");const o=n?i.div(Vn+s,Vn-s):i.div(s-Vn,s+Vn);return i.toBytes(o)},toMontgomerySecret(e){const s=m.secretKey;Ms(e,s);const r=t(e.subarray(0,s));return c(r).subarray(0,s)}};return Object.freeze({keygen:Bn(y,d),getPublicKey:d,sign:function(e,t,s={}){e=Ms(e,void 0,"message"),r&&(e=r(e));const{prefix:i,scalar:a,pointBytes:c}=u(t),l=p(s.context,i,e),h=n.multiply(l).toBytes(),d=p(s.context,h,c,e),f=o.create(l+d*a);if(!o.isValid(f))throw new Error("sign failed: invalid s");return Ms(Ys(h,o.toBytes(f)),m.signature,"result")},verify:function(t,s,i,o=f){const{context:a,zip215:c}=o,l=m.signature;t=Ms(t,l,"signature"),s=Ms(s,void 0,"message"),i=Ms(i,m.publicKey,"publicKey"),void 0!==c&&Br(c,"zip215"),r&&(s=r(s));const h=l/2,u=t.subarray(0,h),d=$r(t.subarray(h,l));let g,y,b;try{g=e.fromBytes(i,c),y=e.fromBytes(u,c),b=n.multiplyUnsafe(d)}catch(e){return!1}if(!c&&g.isSmallOrder())return!1;const w=p(a,y.toBytes(),g.toBytes(),s);return y.add(g.multiplyUnsafe(w)).subtract(b).clearCofactor().is0()},utils:b,Point:e,lengths:m})}
/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Wn=BigInt(1),Kn=BigInt(2),jn=BigInt(5),Hn=BigInt(8),Gn=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),Qn=(()=>({p:Gn,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:Hn,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")}))();function Xn(e){return e[0]&=248,e[31]&=127,e[31]|=64,e}const Yn=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");const Jn=$n(Qn,{uvRatio:function(e,t){const s=Gn,r=cn(t*t*t,s),n=function(e){const t=BigInt(10),s=BigInt(20),r=BigInt(40),n=BigInt(80),i=Gn,o=e*e%i*e%i,a=ln(o,Kn,i)*o%i,c=ln(a,Wn,i)*e%i,l=ln(c,jn,i)*c%i,h=ln(l,t,i)*l%i,u=ln(h,s,i)*h%i,d=ln(u,r,i)*u%i,p=ln(d,n,i)*d%i,f=ln(p,n,i)*d%i,g=ln(f,t,i)*l%i;return{pow_p_5_8:ln(g,Kn,i)*e%i,b2:o}}(e*cn(r*r*t,s)).pow_p_5_8;let i=cn(e*r*n,s);const o=cn(t*i*i,s),a=i,c=cn(i*Yn,s),l=o===e,h=o===cn(-e,s),u=o===cn(-e*Yn,s);return l&&(i=a),(h||u)&&(i=c),(cn(i,s)&Jr)===Jr&&(i=cn(-i,s)),{isValid:l||h,value:i}}});function Zn(e){return qn(Jn,Mr,Object.assign({adjustScalarBytes:Xn},e))}const ei=Zn({});class ti extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}}class si extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}}var ri={get(e=globalThis){const t=e.crypto;if(null==t?.subtle)throw new si("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return t}};let ni;const ii=(async()=>{try{return await ri.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function oi(){const e=ei.utils.randomSecretKey(),t=ei.getPublicKey(e),s=function(e,t){const s=new Uint8Array(64);for(let r=0;r<32;r++)s[r]=e[r],s[32+r]=t[r];return s}(e,t);return{privateKey:s,publicKey:t}}async function ai(e,t){return null==ni&&(ni=await ii),ni?async function(e,t){let s;s=64===e.length?e.subarray(0,32):e;const r={crv:"Ed25519",kty:"OKP",x:Qe(e.subarray(32),"base64url"),d:Qe(s,"base64url"),ext:!0,key_ops:["sign"]},n=await ri.get().subtle.importKey("jwk",r,{name:"Ed25519"},!0,["sign"]),i=await ri.get().subtle.sign({name:"Ed25519"},n,t instanceof Uint8Array?t:t.subarray());return new Uint8Array(i,0,i.byteLength)}(e,t):function(e,t){const s=e.subarray(0,32);return ei.sign(t instanceof Uint8Array?t:t.subarray(),s)}(e,t)}async function ci(e,t,s){return null==ni&&(ni=await ii),ni?async function(e,t,s){if(e.buffer instanceof ArrayBuffer){const r=await ri.get().subtle.importKey("raw",e.buffer,{name:"Ed25519"},!1,["verify"]);return await ri.get().subtle.verify({name:"Ed25519"},r,t,s instanceof Uint8Array?s:s.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}(e,t,s):function(e,t,s){return ei.verify(t,s instanceof Uint8Array?s:s.subarray(),e)}(e,t,s)}function li(e){return null!=e&&("function"==typeof e.then&&"function"==typeof e.catch&&"function"==typeof e.finally)}class hi{type="Ed25519";raw;constructor(e){this.raw=pi(e,32)}toMultihash(){return ke.digest(Ho(this))}toCID(){return Ue.createV1(114,this.toMultihash())}toString(){return G.encode(this.toMultihash().bytes).substring(1)}equals(e){return null!=e&&e.raw instanceof Uint8Array&&a(this.raw,e.raw)}verify(e,t,s){s?.signal?.throwIfAborted();const r=ci(this.raw,t,e);return li(r)?r.then(e=>(s?.signal?.throwIfAborted(),e)):r}}class ui{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=pi(e,64),this.publicKey=new hi(t)}equals(e){return null!=e&&e.raw instanceof Uint8Array&&a(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();const s=ai(this.raw,e);return li(s)?s.then(e=>(t?.signal?.throwIfAborted(),e)):(t?.signal?.throwIfAborted(),s)}}function di(e){return e=pi(e,32),new hi(e)}function pi(e,t){if((e=Uint8Array.from(e??[])).length!==t)throw new ts(`Key must be a Uint8Array of length ${t}, got ${e.length}`);return e}const fi=Math.pow(2,7),gi=Math.pow(2,14),mi=Math.pow(2,21),yi=Math.pow(2,28),bi=Math.pow(2,35),wi=Math.pow(2,42),vi=Math.pow(2,49),Si=128,Ei=127;function Di(e){if(e<fi)return 1;if(e<gi)return 2;if(e<mi)return 3;if(e<yi)return 4;if(e<bi)return 5;if(e<wi)return 6;if(e<vi)return 7;if(null!=Number.MAX_SAFE_INTEGER&&e>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function _i(e,t,s=0){switch(Di(e)){case 8:t[s++]=255&e|Si,e/=128;case 7:t[s++]=255&e|Si,e/=128;case 6:t[s++]=255&e|Si,e/=128;case 5:t[s++]=255&e|Si,e/=128;case 4:t[s++]=255&e|Si,e>>>=7;case 3:t[s++]=255&e|Si,e>>>=7;case 2:t[s++]=255&e|Si,e>>>=7;case 1:t[s++]=255&e,e>>>=7;break;default:throw new Error("unreachable")}return t}function Ti(e,t){let s=e[t],r=0;if(r+=s&Ei,s<Si)return r;if(s=e[t+1],r+=(s&Ei)<<7,s<Si)return r;if(s=e[t+2],r+=(s&Ei)<<14,s<Si)return r;if(s=e[t+3],r+=(s&Ei)<<21,s<Si)return r;if(s=e[t+4],r+=(s&Ei)*yi,s<Si)return r;if(s=e[t+5],r+=(s&Ei)*bi,s<Si)return r;if(s=e[t+6],r+=(s&Ei)*wi,s<Si)return r;if(s=e[t+7],r+=(s&Ei)*vi,s<Si)return r;throw new RangeError("Could not decode varint")}function Ii(e,t,s=0){return null==t&&(t=l(Di(e))),t instanceof Uint8Array?_i(e,t,s):function(e,t,s=0){switch(Di(e)){case 8:t.set(s++,255&e|Si),e/=128;case 7:t.set(s++,255&e|Si),e/=128;case 6:t.set(s++,255&e|Si),e/=128;case 5:t.set(s++,255&e|Si),e/=128;case 4:t.set(s++,255&e|Si),e>>>=7;case 3:t.set(s++,255&e|Si),e>>>=7;case 2:t.set(s++,255&e|Si),e>>>=7;case 1:t.set(s++,255&e),e>>>=7;break;default:throw new Error("unreachable")}return t}(e,t,s)}function Ci(e,t=0){return e instanceof Uint8Array?Ti(e,t):function(e,t){let s=e.get(t),r=0;if(r+=s&Ei,s<Si)return r;if(s=e.get(t+1),r+=(s&Ei)<<7,s<Si)return r;if(s=e.get(t+2),r+=(s&Ei)<<14,s<Si)return r;if(s=e.get(t+3),r+=(s&Ei)<<21,s<Si)return r;if(s=e.get(t+4),r+=(s&Ei)*yi,s<Si)return r;if(s=e.get(t+5),r+=(s&Ei)*bi,s<Si)return r;if(s=e.get(t+6),r+=(s&Ei)*wi,s<Si)return r;if(s=e.get(t+7),r+=(s&Ei)*vi,s<Si)return r;throw new RangeError("Could not decode varint")}(e,t)}const Pi=new Float32Array([-0]),xi=new Uint8Array(Pi.buffer);function Ai(e,t,s){Pi[0]=e,t[s]=xi[0],t[s+1]=xi[1],t[s+2]=xi[2],t[s+3]=xi[3]}const ki=new Float64Array([-0]),Ni=new Uint8Array(ki.buffer);function Ri(e,t,s){ki[0]=e,t[s]=Ni[0],t[s+1]=Ni[1],t[s+2]=Ni[2],t[s+3]=Ni[3],t[s+4]=Ni[4],t[s+5]=Ni[5],t[s+6]=Ni[6],t[s+7]=Ni[7]}const Mi=BigInt(Number.MAX_SAFE_INTEGER),Li=BigInt(Number.MIN_SAFE_INTEGER);class Oi{lo;hi;constructor(e,t){this.lo=0|e,this.hi=0|t}toNumber(e=!1){if(!e&&this.hi>>>31>0){const e=1+~this.lo>>>0;let t=~this.hi>>>0;return 0===e&&(t=t+1>>>0),-(e+4294967296*t)}return this.lo+4294967296*this.hi}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31!=0){const e=1+~this.lo>>>0;let t=~this.hi>>>0;return 0===e&&(t=t+1>>>0),-(BigInt(e)+(BigInt(t)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,s=this.hi>>>24;return 0===s?0===t?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:s<128?9:10}static fromBigInt(e){if(0n===e)return Bi;if(e<Mi&&e>Li)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let s=e>>32n,r=e-(s<<32n);return t&&(s=0n|~s,r=0n|~r,++r>Ui&&(r=0n,++s>Ui&&(s=0n))),new Oi(Number(r),Number(s))}static fromNumber(e){if(0===e)return Bi;const t=e<0;t&&(e=-e);let s=e>>>0,r=(e-s)/4294967296>>>0;return t&&(r=~r>>>0,s=~s>>>0,++s>4294967295&&(s=0,++r>4294967295&&(r=0))),new Oi(s,r)}static from(e){return"number"==typeof e?Oi.fromNumber(e):"bigint"==typeof e?Oi.fromBigInt(e):"string"==typeof e?Oi.fromBigInt(BigInt(e)):null!=e.low||null!=e.high?new Oi(e.low>>>0,e.high>>>0):Bi}}const Bi=new Oi(0,0);Bi.toBigInt=function(){return 0n},Bi.zzEncode=Bi.zzDecode=function(){return this},Bi.length=function(){return 1};const Ui=4294967296n;function Vi(e,t,s){const r=s;let n,i;for(let r=0;r<e.length;++r)n=e.charCodeAt(r),n<128?t[s++]=n:n<2048?(t[s++]=n>>6|192,t[s++]=63&n|128):55296==(64512&n)&&56320==(64512&(i=e.charCodeAt(r+1)))?(n=65536+((1023&n)<<10)+(1023&i),++r,t[s++]=n>>18|240,t[s++]=n>>12&63|128,t[s++]=n>>6&63|128,t[s++]=63&n|128):(t[s++]=n>>12|224,t[s++]=n>>6&63|128,t[s++]=63&n|128);return s-r}function Fi(e,t){return RangeError(`index out of range: ${e.pos} + ${t??1} > ${e.len}`)}function zi(e,t){return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0}class $i{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)return e;if(e=(e|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)return e;if((this.pos+=5)>this.len)throw this.pos=this.len,Fi(this,10);return e}int32(){return 0|this.uint32()}sint32(){const e=this.uint32();return e>>>1^-(1&e)}bool(){return 0!==this.uint32()}fixed32(){if(this.pos+4>this.len)throw Fi(this,4);return zi(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw Fi(this,4);return 0|zi(this.buf,this.pos+=4)}float(){if(this.pos+4>this.len)throw Fi(this,4);const e=(t=this.buf,s=this.pos,xi[0]=t[s],xi[1]=t[s+1],xi[2]=t[s+2],xi[3]=t[s+3],Pi[0]);var t,s;return this.pos+=4,e}double(){if(this.pos+8>this.len)throw Fi(this,4);const e=(t=this.buf,s=this.pos,Ni[0]=t[s],Ni[1]=t[s+1],Ni[2]=t[s+2],Ni[3]=t[s+3],Ni[4]=t[s+4],Ni[5]=t[s+5],Ni[6]=t[s+6],Ni[7]=t[s+7],ki[0]);var t,s;return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,s=this.pos+e;if(s>this.len)throw Fi(this,e);return this.pos+=e,t===s?new Uint8Array(0):this.buf.subarray(t,s)}string(){const e=this.bytes();return function(e,t,s){if(s-t<1)return"";let r;const n=[];let i,o=0;for(;t<s;)i=e[t++],i<128?n[o++]=i:i>191&&i<224?n[o++]=(31&i)<<6|63&e[t++]:i>239&&i<365?(i=((7&i)<<18|(63&e[t++])<<12|(63&e[t++])<<6|63&e[t++])-65536,n[o++]=55296+(i>>10),n[o++]=56320+(1023&i)):n[o++]=(15&i)<<12|(63&e[t++])<<6|63&e[t++],o>8191&&((r??(r=[])).push(String.fromCharCode.apply(String,n)),o=0);return null!=r?(o>0&&r.push(String.fromCharCode.apply(String,n.slice(0,o))),r.join("")):String.fromCharCode.apply(String,n.slice(0,o))}(e,0,e.length)}skip(e){if("number"==typeof e){if(this.pos+e>this.len)throw Fi(this,e);this.pos+=e}else do{if(this.pos>=this.len)throw Fi(this)}while(128&this.buf[this.pos++]);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(e=7&this.uint32());)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new Oi(0,0);let t=0;if(!(this.len-this.pos>4)){for(;t<3;++t){if(this.pos>=this.len)throw Fi(this);if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(127&this.buf[this.pos++])<<7*t)>>>0,e}for(;t<4;++t)if(e.lo=(e.lo|(127&this.buf[this.pos])<<7*t)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(127&this.buf[this.pos])<<28)>>>0,e.hi=(e.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return e;if(t=0,this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw Fi(this);if(e.hi=(e.hi|(127&this.buf[this.pos])<<7*t+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw Fi(this,8);const e=zi(this.buf,this.pos+=4),t=zi(this.buf,this.pos+=4);return new Oi(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=Ti(this.buf,this.pos);return this.pos+=Di(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function qi(e,t,s){const r=function(e){return new $i(e instanceof Uint8Array?e:e.subarray())}(e);return t.decode(r,void 0,s)}class Wi{fn;len;next;val;constructor(e,t,s){this.fn=e,this.len=t,this.next=void 0,this.val=s}}function Ki(){}class ji{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const Hi=function(){const e=8192;let t,s=e;return function(r){if(r<1||r>4096)return l(r);s+r>e&&(t=l(e),s=0);const n=t.subarray(s,s+=r);return 7&s&&(s=1+(7|s)),n}}();class Gi{len;head;tail;states;constructor(){this.len=0,this.head=new Wi(Ki,0,0),this.tail=this.head,this.states=null}_push(e,t,s){return this.tail=this.tail.next=new Wi(e,t,s),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new Yi((e>>>=0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(Ji,10,Oi.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=Oi.fromBigInt(e);return this._push(Ji,t.length(),t)}uint64Number(e){return this._push(_i,Di(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=Oi.fromBigInt(e).zzEncode();return this._push(Ji,t.length(),t)}sint64Number(e){const t=Oi.fromNumber(e).zzEncode();return this._push(Ji,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(Qi,1,e?1:0)}fixed32(e){return this._push(Zi,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=Oi.fromBigInt(e);return this._push(Zi,4,t.lo)._push(Zi,4,t.hi)}fixed64Number(e){const t=Oi.fromNumber(e);return this._push(Zi,4,t.lo)._push(Zi,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(Ai,4,e)}double(e){return this._push(Ri,8,e)}bytes(e){const t=e.length>>>0;return 0===t?this._push(Qi,1,0):this.uint32(t)._push(eo,t,e)}string(e){const t=function(e){let t=0,s=0;for(let r=0;r<e.length;++r)s=e.charCodeAt(r),s<128?t+=1:s<2048?t+=2:55296==(64512&s)&&56320==(64512&e.charCodeAt(r+1))?(++r,t+=4):t+=3;return t}(e);return 0!==t?this.uint32(t)._push(Vi,t,e):this._push(Qi,1,0)}fork(){return this.states=new ji(this),this.head=this.tail=new Wi(Ki,0,0),this.len=0,this}reset(){return null!=this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Wi(Ki,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,s=this.len;return this.reset().uint32(s),0!==s&&(this.tail.next=e.next,this.tail=t,this.len+=s),this}finish(){let e=this.head.next;const t=function(e){return null!=globalThis.Buffer?l(e):Hi(e)}(this.len);let s=0;for(;null!=e;)e.fn(e.val,t,s),s+=e.len,e=e.next;return t}}function Qi(e,t,s){t[s]=255&e}function Xi(e,t,s){for(;e>127;)t[s++]=127&e|128,e>>>=7;t[s]=e}class Yi extends Wi{next;constructor(e,t){super(Xi,e,t),this.next=void 0}}function Ji(e,t,s){for(;0!==e.hi;)t[s++]=127&e.lo|128,e.lo=(e.lo>>>7|e.hi<<25)>>>0,e.hi>>>=7;for(;e.lo>127;)t[s++]=127&e.lo|128,e.lo=e.lo>>>7;t[s++]=e.lo}function Zi(e,t,s){t[s]=255&e,t[s+1]=e>>>8&255,t[s+2]=e>>>16&255,t[s+3]=e>>>24}function eo(e,t,s){t.set(e,s)}function to(e,t,s){t.set(e,s)}function so(e,t,s){e.length<40?Vi(e,t,s):null!=t.utf8Write?t.utf8Write(e,s):t.set(Ge(e),s)}function ro(e,t){const s=new Gi;return t.encode(e,s,{lengthDelimited:!1}),s.finish()}var no,io,oo,ao,co;function lo(e,t,s,r){return{name:e,type:t,encode:s,decode:r}}function ho(e){function t(t){if(null==e[t.toString()])throw new Error("Invalid enum value");return e[t]}return lo("enum",no.VARINT,function(e,s){const r=t(e);s.int32(r)},function(e){return t(e.int32())})}function uo(e,t){return lo("message",no.LENGTH_DELIMITED,e,t)}null!=globalThis.Buffer&&(Gi.prototype.bytes=function(e){const t=e.length>>>0;return this.uint32(t),t>0&&this._push(to,t,e),this},Gi.prototype.string=function(e){const t=globalThis.Buffer.byteLength(e);return this.uint32(t),t>0&&this._push(so,t,e),this}),function(e){e[e.VARINT=0]="VARINT",e[e.BIT64=1]="BIT64",e[e.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",e[e.START_GROUP=3]="START_GROUP",e[e.END_GROUP=4]="END_GROUP",e[e.BIT32=5]="BIT32"}(no||(no={}));class po extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"}class fo extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"}function go(e){if(isNaN(e)||e<=0)throw new ts("random bytes length must be a Number bigger than 0");return Zs(e)}!function(e){e.RSA="RSA",e.Ed25519="Ed25519",e.secp256k1="secp256k1",e.ECDSA="ECDSA"}(io||(io={})),function(e){e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.secp256k1=2]="secp256k1",e[e.ECDSA=3]="ECDSA"}(oo||(oo={})),function(e){e.codec=()=>ho(oo)}(io||(io={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),io.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.Type=io.codec().decode(e);break;case 2:r.Data=e.bytes();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(ao||(ao={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),io.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.Type=io.codec().decode(e);break;case 2:r.Data=e.bytes();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(co||(co={}));class mo{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return null==this._raw&&(this._raw=function(e){if(null==e.n||null==e.e)throw new ts("JWK was missing components");return ws([yo,bs(ws([ys(Ge(e.n,"base64url")),ys(Ge(e.e,"base64url"))]))]).subarray()}(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return Ue.createV1(114,this._multihash)}toString(){return G.encode(this.toMultihash().bytes).substring(1)}equals(e){return null!=e&&e.raw instanceof Uint8Array&&a(this.raw,e.raw)}verify(e,t,s){return async function(e,t,s,r){const n=await ri.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);r?.signal?.throwIfAborted();const i=await ri.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},n,t,s instanceof Uint8Array?s:s.subarray());return r?.signal?.throwIfAborted(),i}(this.jwk,t,e,s)}}const yo=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function bo(e,t){if(e.byteLength>=1062)throw new ss("Key size is too large");return function(e,t,s){const r=function(e){const t=ps(e[1],{offset:0});return{kty:"RSA",n:Qe(t[0],"base64url"),e:Qe(t[1],"base64url")}}(e);if(null==s){s=Ce(18,Rr(ao.encode({Type:io.RSA,Data:t})))}return new mo(r,s)}(ps(e,{offset:0}),e,t)}let wo=class{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(Ls(e),Ms(t,void 0,"key"),this.iHash=e.create(),"function"!=typeof this.iHash.update)throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,r=new Uint8Array(s);r.set(t.length>s?e.create().update(t).digest():t);for(let e=0;e<r.length;e++)r[e]^=54;this.iHash.update(r),this.oHash=e.create();for(let e=0;e<r.length;e++)r[e]^=106;this.oHash.update(r),Bs(r)}update(e){return Os(this),this.iHash.update(e),this}digestInto(e){Os(this),Ms(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});const{oHash:t,iHash:s,finished:r,destroyed:n,blockLen:i,outputLen:o}=this;return e.finished=r,e.destroyed=n,e.blockLen=i,e.outputLen=o,e.oHash=t._cloneInto(e.oHash),e.iHash=s._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const vo=(e,t,s)=>new wo(e,t).update(s).digest();vo.create=(e,t)=>new wo(e,t);
/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */
const So=(e,t)=>(e+(e>=0?t:-t)/xo)/t;function Eo(e,t,s){const[[r,n],[i,o]]=t,a=So(o*e,s),c=So(-n*e,s);let l=e-a*r-c*i,h=-a*n-c*o;const u=l<Co,d=h<Co;u&&(l=-l),d&&(h=-h);const p=Gr(Math.ceil(function(e){let t;for(t=0;e>Lr;e>>=Or,t+=1);return t}(s)/2))+Po;if(l<Co||l>=p||h<Co||h>=p)throw new Error("splitScalar (endomorphism): failed, k="+e);return{k1neg:u,k1:l,k2neg:d,k2:h}}function Do(e){if(!["compact","recovered","der"].includes(e))throw new Error('Signature format must be "compact", "recovered", or "der"');return e}function _o(e,t){const s={};for(let r of Object.keys(t))s[r]=void 0===e[r]?t[r]:e[r];return Br(s.lowS,"lowS"),Br(s.prehash,"prehash"),void 0!==s.format&&Do(s.format),s}class To extends Error{constructor(e=""){super(e)}}const Io={Err:To,_tlv:{encode:(e,t)=>{const{Err:s}=Io;if(e<0||e>256)throw new s("tlv.encode: wrong tag");if(1&t.length)throw new s("tlv.encode: unpadded data");const r=t.length/2,n=Vr(r);if(n.length/2&128)throw new s("tlv.encode: long form length too big");const i=r>127?Vr(n.length/2|128):"";return Vr(e)+i+n+t},decode(e,t){const{Err:s}=Io;let r=0;if(e<0||e>256)throw new s("tlv.encode: wrong tag");if(t.length<2||t[r++]!==e)throw new s("tlv.decode: wrong tlv");const n=t[r++];let i=0;if(!!(128&n)){const e=127&n;if(!e)throw new s("tlv.decode(long): indefinite length not supported");if(e>4)throw new s("tlv.decode(long): byte length is too big");const o=t.subarray(r,r+e);if(o.length!==e)throw new s("tlv.decode: length bytes not complete");if(0===o[0])throw new s("tlv.decode(long): zero leftmost byte");for(const e of o)i=i<<8|e;if(r+=e,i<128)throw new s("tlv.decode(long): not minimal encoding")}else i=n;const o=t.subarray(r,r+i);if(o.length!==i)throw new s("tlv.decode: wrong value length");return{v:o,l:t.subarray(r+i)}}},_int:{encode(e){const{Err:t}=Io;if(e<Co)throw new t("integer: negative integers are not allowed");let s=Vr(e);if(8&Number.parseInt(s[0],16)&&(s="00"+s),1&s.length)throw new t("unexpected DER parsing assertion: unpadded hex");return s},decode(e){const{Err:t}=Io;if(128&e[0])throw new t("invalid signature integer: negative");if(0===e[0]&&!(128&e[1]))throw new t("invalid signature integer: unnecessary leading zero");return zr(e)}},toSig(e){const{Err:t,_int:s,_tlv:r}=Io,n=Ms(e,void 0,"signature"),{v:i,l:o}=r.decode(48,n);if(o.length)throw new t("invalid signature: left bytes after parsing");const{v:a,l:c}=r.decode(2,i),{v:l,l:h}=r.decode(2,c);if(h.length)throw new t("invalid signature: left bytes after parsing");return{r:s.decode(a),s:s.decode(l)}},hexFromSig(e){const{_tlv:t,_int:s}=Io,r=t.encode(2,s.encode(e.r))+t.encode(2,s.encode(e.s));return t.encode(48,r)}},Co=BigInt(0),Po=BigInt(1),xo=BigInt(2),Ao=BigInt(3),ko=BigInt(4);function No(e,t={}){const s=On("weierstrass",e,t),{Fp:r,Fn:n}=s;let i=s.CURVE;const{h:o,n:a}=i;Qr(t,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object"});const{endo:c}=t;if(c&&(!r.is0(i.a)||"bigint"!=typeof c.beta||!Array.isArray(c.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const l=Mo(r,n);function h(){if(!r.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}const u=t.toBytes||function(e,t,s){const{x:n,y:i}=t.toAffine(),o=r.toBytes(n);if(Br(s,"isCompressed"),s){h();return Ys(Ro(!r.isOdd(i)),o)}return Ys(Uint8Array.of(4),o,r.toBytes(i))},d=t.fromBytes||function(e){Ms(e,void 0,"Point");const{publicKey:t,publicKeyUncompressed:s}=l,n=e.length,i=e[0],o=e.subarray(1);if(n!==t||2!==i&&3!==i){if(n===s&&4===i){const e=r.BYTES,t=r.fromBytes(o.subarray(0,e)),s=r.fromBytes(o.subarray(e,2*e));if(!f(t,s))throw new Error("bad point: is not on curve");return{x:t,y:s}}throw new Error(`bad point: got length ${n}, expected compressed=${t} or uncompressed=${s}`)}{const e=r.fromBytes(o);if(!r.isValid(e))throw new Error("bad point: is not on curve, wrong x");const t=p(e);let s;try{s=r.sqrt(t)}catch(e){const t=e instanceof Error?": "+e.message:"";throw new Error("bad point: is not on curve, sqrt error"+t)}h();return!(1&~i)!==r.isOdd(s)&&(s=r.neg(s)),{x:e,y:s}}};function p(e){const t=r.sqr(e),s=r.mul(t,e);return r.add(r.add(s,r.mul(e,i.a)),i.b)}function f(e,t){const s=r.sqr(t),n=p(e);return r.eql(s,n)}if(!f(i.Gx,i.Gy))throw new Error("bad curve params: generator point");const g=r.mul(r.pow(i.a,Ao),ko),m=r.mul(r.sqr(i.b),BigInt(27));if(r.is0(r.add(g,m)))throw new Error("bad curve params: a or b");function y(e,t,s=!1){if(!r.isValid(t)||s&&r.is0(t))throw new Error(`bad point coordinate ${e}`);return t}function b(e){if(!(e instanceof D))throw new Error("Weierstrass Point expected")}function w(e){if(!c||!c.basises)throw new Error("no endo");return Eo(e,c.basises,n.ORDER)}const v=Xr((e,t)=>{const{X:s,Y:n,Z:i}=e;if(r.eql(i,r.ONE))return{x:s,y:n};const o=e.is0();null==t&&(t=o?r.ONE:r.inv(i));const a=r.mul(s,t),c=r.mul(n,t),l=r.mul(i,t);if(o)return{x:r.ZERO,y:r.ZERO};if(!r.eql(l,r.ONE))throw new Error("invZ was invalid");return{x:a,y:c}}),S=Xr(e=>{if(e.is0()){if(t.allowInfinityPoint&&!r.is0(e.Y))return;throw new Error("bad point: ZERO")}const{x:s,y:n}=e.toAffine();if(!r.isValid(s)||!r.isValid(n))throw new Error("bad point: x or y not field elements");if(!f(s,n))throw new Error("bad point: equation left != right");if(!e.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function E(e,t,s,n,i){return s=new D(r.mul(s.X,e),s.Y,s.Z),t=Tn(n,t),s=Tn(i,s),t.add(s)}class D{static BASE=new D(i.Gx,i.Gy,r.ONE);static ZERO=new D(r.ZERO,r.ONE,r.ZERO);static Fp=r;static Fn=n;X;Y;Z;constructor(e,t,s){this.X=y("x",e),this.Y=y("y",t,!0),this.Z=y("z",s),Object.freeze(this)}static CURVE(){return i}static fromAffine(e){const{x:t,y:s}=e||{};if(!e||!r.isValid(t)||!r.isValid(s))throw new Error("invalid affine point");if(e instanceof D)throw new Error("projective point not allowed");return r.is0(t)&&r.is0(s)?D.ZERO:new D(t,s,r.ONE)}static fromBytes(e){const t=D.fromAffine(d(Ms(e,void 0,"point")));return t.assertValidity(),t}static fromHex(e){return D.fromBytes(Xs(e))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(e=8,t=!0){return T.createCache(this,e),t||this.multiply(Ao),this}assertValidity(){S(this)}hasEvenY(){const{y:e}=this.toAffine();if(!r.isOdd)throw new Error("Field doesn't support isOdd");return!r.isOdd(e)}equals(e){b(e);const{X:t,Y:s,Z:n}=this,{X:i,Y:o,Z:a}=e,c=r.eql(r.mul(t,a),r.mul(i,n)),l=r.eql(r.mul(s,a),r.mul(o,n));return c&&l}negate(){return new D(this.X,r.neg(this.Y),this.Z)}double(){const{a:e,b:t}=i,s=r.mul(t,Ao),{X:n,Y:o,Z:a}=this;let c=r.ZERO,l=r.ZERO,h=r.ZERO,u=r.mul(n,n),d=r.mul(o,o),p=r.mul(a,a),f=r.mul(n,o);return f=r.add(f,f),h=r.mul(n,a),h=r.add(h,h),c=r.mul(e,h),l=r.mul(s,p),l=r.add(c,l),c=r.sub(d,l),l=r.add(d,l),l=r.mul(c,l),c=r.mul(f,c),h=r.mul(s,h),p=r.mul(e,p),f=r.sub(u,p),f=r.mul(e,f),f=r.add(f,h),h=r.add(u,u),u=r.add(h,u),u=r.add(u,p),u=r.mul(u,f),l=r.add(l,u),p=r.mul(o,a),p=r.add(p,p),u=r.mul(p,f),c=r.sub(c,u),h=r.mul(p,d),h=r.add(h,h),h=r.add(h,h),new D(c,l,h)}add(e){b(e);const{X:t,Y:s,Z:n}=this,{X:o,Y:a,Z:c}=e;let l=r.ZERO,h=r.ZERO,u=r.ZERO;const d=i.a,p=r.mul(i.b,Ao);let f=r.mul(t,o),g=r.mul(s,a),m=r.mul(n,c),y=r.add(t,s),w=r.add(o,a);y=r.mul(y,w),w=r.add(f,g),y=r.sub(y,w),w=r.add(t,n);let v=r.add(o,c);return w=r.mul(w,v),v=r.add(f,m),w=r.sub(w,v),v=r.add(s,n),l=r.add(a,c),v=r.mul(v,l),l=r.add(g,m),v=r.sub(v,l),u=r.mul(d,w),l=r.mul(p,m),u=r.add(l,u),l=r.sub(g,u),u=r.add(g,u),h=r.mul(l,u),g=r.add(f,f),g=r.add(g,f),m=r.mul(d,m),w=r.mul(p,w),g=r.add(g,m),m=r.sub(f,m),m=r.mul(d,m),w=r.add(w,m),f=r.mul(g,w),h=r.add(h,f),f=r.mul(v,w),l=r.mul(y,l),l=r.sub(l,f),f=r.mul(y,g),u=r.mul(v,u),u=r.add(u,f),new D(l,h,u)}subtract(e){return this.add(e.negate())}is0(){return this.equals(D.ZERO)}multiply(e){const{endo:s}=t;if(!n.isValidNot0(e))throw new Error("invalid scalar: out of range");let r,i;const o=e=>T.cached(this,e,e=>In(D,e));if(s){const{k1neg:t,k1:n,k2neg:a,k2:c}=w(e),{p:l,f:h}=o(n),{p:u,f:d}=o(c);i=h.add(d),r=E(s.beta,l,u,t,a)}else{const{p:t,f:s}=o(e);r=t,i=s}return In(D,[r,i])[0]}multiplyUnsafe(e){const{endo:s}=t,r=this;if(!n.isValid(e))throw new Error("invalid scalar: out of range");if(e===Co||r.is0())return D.ZERO;if(e===Po)return r;if(T.hasCache(this))return this.multiply(e);if(s){const{k1neg:t,k1:n,k2neg:i,k2:o}=w(e),{p1:a,p2:c}=function(e,t,s,r){let n=t,i=e.ZERO,o=e.ZERO;for(;s>Dn||r>Dn;)s&_n&&(i=i.add(n)),r&_n&&(o=o.add(n)),n=n.double(),s>>=_n,r>>=_n;return{p1:i,p2:o}}(D,r,n,o);return E(s.beta,a,c,t,i)}return T.unsafe(r,e)}toAffine(e){return v(this,e)}isTorsionFree(){const{isTorsionFree:e}=t;return o===Po||(e?e(D,this):T.unsafe(this,a).is0())}clearCofactor(){const{clearCofactor:e}=t;return o===Po?this:e?e(D,this):this.multiplyUnsafe(o)}isSmallOrder(){return this.multiplyUnsafe(o).is0()}toBytes(e=!0){return Br(e,"isCompressed"),this.assertValidity(),u(D,this,e)}toHex(e=!0){return $s(this.toBytes(e))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}}const _=n.BITS,T=new Mn(D,t.endo?Math.ceil(_/2):_);return D.BASE.precompute(8),D}function Ro(e){return Uint8Array.of(e?2:3)}function Mo(e,t){return{secretKey:t.BYTES,publicKey:1+e.BYTES,publicKeyUncompressed:1+2*e.BYTES,publicKeyHasPrefix:!0,signature:2*t.BYTES}}function Lo(e,t={}){const{Fn:s}=e,r=t.randomBytes||Zs,n=Object.assign(Mo(e.Fp,s),{seed:En(s.ORDER)});function i(e=r(n.seed)){return function(e,t,s=!1){Ms(e);const r=e.length,n=Sn(t),i=En(t);if(r<16||r<i||r>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+r);const o=cn(s?$r(e):zr(e),t-Jr)+Jr;return s?Wr(o,n):qr(o,n)}(Ms(e,n.seed,"seed"),s.ORDER)}function o(t,r=!0){return e.BASE.multiply(s.fromBytes(t)).toBytes(r)}function a(e){const{secretKey:t,publicKey:r,publicKeyUncompressed:i}=n;if(!Ns(e))return;if("_lengths"in s&&s._lengths||t===r)return;const o=Ms(e,void 0,"key").length;return o===r||o===i}const c={isValidSecretKey:function(e){try{const t=s.fromBytes(e);return s.isValidNot0(t)}catch(e){return!1}},isValidPublicKey:function(t,s){const{publicKey:r,publicKeyUncompressed:i}=n;try{const n=t.length;return(!0!==s||n===r)&&((!1!==s||n===i)&&!!e.fromBytes(t))}catch(e){return!1}},randomSecretKey:i},l=Bn(i,o);return Object.freeze({getPublicKey:o,getSharedSecret:function(t,r,n=!0){if(!0===a(t))throw new Error("first arg must be private key");if(!1===a(r))throw new Error("second arg must be public key");const i=s.fromBytes(t);return e.fromBytes(r).multiply(i).toBytes(n)},keygen:l,Point:e,utils:c,lengths:n})}function Oo(e,t,s={}){Ls(t),Qr(s,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const r=(s=Object.assign({},s)).randomBytes||Zs,n=s.hmac||((e,s)=>vo(t,e,s)),{Fp:i,Fn:o}=e,{ORDER:a,BITS:c}=o,{keygen:l,getPublicKey:h,getSharedSecret:u,utils:d,lengths:p}=Lo(e,s),f={prehash:!0,lowS:"boolean"!=typeof s.lowS||s.lowS,format:"compact",extraEntropy:!1},g=a*xo<i.ORDER;function m(e){return e>a>>Po}function y(e,t){if(!o.isValidNot0(t))throw new Error(`invalid signature ${e}: out of range 1..Point.Fn.ORDER`);return t}function b(){if(g)throw new Error('"recovered" sig type is not supported for cofactor >2 curves')}function w(e,t){Do(t);const s=p.signature;return Ms(e,"compact"===t?s:"recovered"===t?s+1:void 0)}class v{r;s;recovery;constructor(e,t,s){if(this.r=y("r",e),this.s=y("s",t),null!=s){if(b(),![0,1,2,3].includes(s))throw new Error("invalid recovery id");this.recovery=s}Object.freeze(this)}static fromBytes(e,t=f.format){let s;if(w(e,t),"der"===t){const{r:t,s:s}=Io.toSig(Ms(e));return new v(t,s)}"recovered"===t&&(s=e[0],t="compact",e=e.subarray(1));const r=p.signature/2,n=e.subarray(0,r),i=e.subarray(r,2*r);return new v(o.fromBytes(n),o.fromBytes(i),s)}static fromHex(e,t){return this.fromBytes(Xs(e),t)}assertRecovery(){const{recovery:e}=this;if(null==e)throw new Error("invalid recovery id: must be present");return e}addRecoveryBit(e){return new v(this.r,this.s,e)}recoverPublicKey(t){const{r:s,s:r}=this,n=this.assertRecovery(),c=2===n||3===n?s+a:s;if(!i.isValid(c))throw new Error("invalid recovery id: sig.r+curve.n != R.x");const l=i.toBytes(c),h=e.fromBytes(Ys(Ro(!(1&n)),l)),u=o.inv(c),d=E(Ms(t,void 0,"msgHash")),p=o.create(-d*u),f=o.create(r*u),g=e.BASE.multiplyUnsafe(p).add(h.multiplyUnsafe(f));if(g.is0())throw new Error("invalid recovery: point at infinify");return g.assertValidity(),g}hasHighS(){return m(this.s)}toBytes(e=f.format){if(Do(e),"der"===e)return Xs(Io.hexFromSig(this));const{r:t,s:s}=this,r=o.toBytes(t),n=o.toBytes(s);return"recovered"===e?(b(),Ys(Uint8Array.of(this.assertRecovery()),r,n)):Ys(r,n)}toHex(e){return $s(this.toBytes(e))}}const S=s.bits2int||function(e){if(e.length>8192)throw new Error("input is too large");const t=zr(e),s=8*e.length-c;return s>0?t>>BigInt(s):t},E=s.bits2int_modN||function(e){return o.create(S(e))},D=Gr(c);function _(e){return Hr("num < 2^"+c,e,Co,D),o.toBytes(e)}function T(e,s){return Ms(e,void 0,"message"),s?Ms(t(e),void 0,"prehashed message"):e}return Object.freeze({keygen:l,getPublicKey:h,getSharedSecret:u,utils:d,lengths:p,Point:e,sign:function(s,i,a={}){const{seed:c,k2sig:l}=function(t,s,n){const{lowS:i,prehash:a,extraEntropy:c}=_o(n,f);t=T(t,a);const l=E(t),h=o.fromBytes(s);if(!o.isValidNot0(h))throw new Error("invalid private key");const u=[_(h),_(l)];if(null!=c&&!1!==c){const e=!0===c?r(p.secretKey):c;u.push(Ms(e,void 0,"extraEntropy"))}const d=Ys(...u),y=l;return{seed:d,k2sig:function(t){const s=S(t);if(!o.isValidNot0(s))return;const r=o.inv(s),n=e.BASE.multiply(s).toAffine(),a=o.create(n.x);if(a===Co)return;const c=o.create(r*o.create(y+a*h));if(c===Co)return;let l=(n.x===a?0:2)|Number(n.y&Po),u=c;return i&&m(c)&&(u=o.neg(c),l^=1),new v(a,u,g?void 0:l)}}}(s,i,a),h=function(e,t,s){if(Rs(e,"hashLen"),Rs(t,"qByteLen"),"function"!=typeof s)throw new Error("hmacFn must be a function");const r=e=>new Uint8Array(e),n=Uint8Array.of(),i=Uint8Array.of(0),o=Uint8Array.of(1);let a=r(e),c=r(e),l=0;const h=()=>{a.fill(1),c.fill(0),l=0},u=(...e)=>s(c,Ys(a,...e)),d=(e=n)=>{c=u(i,e),a=u(),0!==e.length&&(c=u(o,e),a=u())},p=()=>{if(l++>=1e3)throw new Error("drbg: tried max amount of iterations");let e=0;const s=[];for(;e<t;){a=u();const t=a.slice();s.push(t),e+=a.length}return Ys(...s)};return(e,t)=>{let s;for(h(),d(e);!(s=t(p()));)d();return h(),s}}(t.outputLen,o.BYTES,n);return h(c,l).toBytes(a.format)},verify:function(t,s,r,n={}){const{lowS:i,prehash:a,format:c}=_o(n,f);if(r=Ms(r,void 0,"publicKey"),s=T(s,a),!Ns(t)){throw new Error("verify expects Uint8Array signature"+(t instanceof v?", use sig.toBytes()":""))}w(t,c);try{const n=v.fromBytes(t,c),a=e.fromBytes(r);if(i&&n.hasHighS())return!1;const{r:l,s:h}=n,u=E(s),d=o.inv(h),p=o.create(u*d),f=o.create(l*d),g=e.BASE.multiplyUnsafe(p).add(a.multiplyUnsafe(f));if(g.is0())return!1;return o.create(g.x)===l}catch(e){return!1}},recoverPublicKey:function(e,t,s={}){const{prehash:r}=_o(s,f);return t=T(t,r),v.fromBytes(e,"recovered").recoverPublicKey(t).toBytes()},Signature:v,hash:t})}
/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Bo={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},Uo={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},Vo=BigInt(2);const Fo=vn(Bo.p,{sqrt:function(e){const t=Bo.p,s=BigInt(3),r=BigInt(6),n=BigInt(11),i=BigInt(22),o=BigInt(23),a=BigInt(44),c=BigInt(88),l=e*e*e%t,h=l*l*e%t,u=ln(h,s,t)*h%t,d=ln(u,s,t)*h%t,p=ln(d,Vo,t)*l%t,f=ln(p,n,t)*p%t,g=ln(f,i,t)*f%t,m=ln(g,a,t)*g%t,y=ln(m,c,t)*m%t,b=ln(y,a,t)*g%t,w=ln(b,s,t)*h%t,v=ln(w,o,t)*f%t,S=ln(v,r,t)*l%t,E=ln(S,Vo,t);if(!Fo.eql(Fo.sqr(E),e))throw new Error("Cannot find square root");return E}}),zo=Oo(No(Bo,{Fp:Fo,endo:Uo}),Rr);class $o{type="secp256k1";raw;_key;constructor(e){this._key=function(e){try{return zo.Point.fromBytes(e),e}catch(e){throw new ss(String(e))}}(e),this.raw=function(e){return zo.Point.fromBytes(e).toBytes()}(this._key)}toMultihash(){return ke.digest(Ho(this))}toCID(){return Ue.createV1(114,this.toMultihash())}toString(){return G.encode(this.toMultihash().bytes).substring(1)}equals(e){return null!=e&&e.raw instanceof Uint8Array&&a(this.raw,e.raw)}verify(e,t,s){return function(e,t,s,r){const n=Me.digest(s instanceof Uint8Array?s:s.subarray());if(li(n))return n.then(({digest:s})=>(r?.signal?.throwIfAborted(),zo.verify(t,s,e,{prehash:!1,format:"der"}))).catch(e=>{if("AbortError"===e.name)throw e;throw new ti(String(e))});try{return r?.signal?.throwIfAborted(),zo.verify(t,n.digest,e,{prehash:!1,format:"der"})}catch(e){throw new ti(String(e))}}(this._key,t,e,s)}}function qo(e){return new $o(e)}async function Wo(e,t){return async function(){const{privateKey:e,publicKey:t}=oi();return new ui(e,t)}()}function Ko(e,t){const{Type:s,Data:r}=ao.decode(e),n=r??new Uint8Array;switch(s){case io.RSA:return bo(n,t);case io.Ed25519:return di(n);case io.secp256k1:return qo(n);case io.ECDSA:return xs(n);default:throw new rs}}function jo(e){const{Type:t,Data:s}=ao.decode(e.digest),r=s??new Uint8Array;switch(t){case io.Ed25519:return di(r);case io.secp256k1:return qo(r);case io.ECDSA:return xs(r);default:throw new rs}}function Ho(e){return ao.encode({Type:io[e.type],Data:e.raw})}const Go=Symbol.for("@libp2p/connection"),Qo=Symbol.for("@libp2p/content-routing"),Xo=Symbol.for("@libp2p/peer-discovery"),Yo=Symbol.for("@libp2p/peer-id");function Jo(e){return Boolean(e?.[Yo])}const Zo=Symbol.for("@libp2p/peer-routing"),ea="keep-alive";var ta;!function(e){e[e.FATAL_ALL=0]="FATAL_ALL",e[e.NO_FATAL=1]="NO_FATAL"}(ta||(ta={}));let sa=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}},ra=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};class na extends Error{static name="ConnectionClosingError";constructor(e="The connection is closing"){super(e),this.name="ConnectionClosingError"}}class ia extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}}let oa=class extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}};class aa extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}}let ca=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}},la=class extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}},ha=class extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}};class ua extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}}let da=class extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}},pa=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}};class fa extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}}let ga=class extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}};class ma extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}}class ya extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}}let ba=class extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}},wa=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};function va(e){return null!=e&&"function"==typeof e.start&&"function"==typeof e.stop}const Sa=Symbol.for("@libp2p/service-capabilities"),Ea=Symbol.for("@libp2p/service-dependencies"),Da=Symbol.for("nodejs.util.inspect.custom");let _a=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[Yo]=!0;toString(){return null==this.string&&(this.string=G.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Ue.createV1(114,this.multihash)}toJSON(){return this.toString()}equals(e){if(null==e)return!1;if(e instanceof Uint8Array)return a(this.multihash.bytes,e);if("string"==typeof e)return this.toString()===e;if(null!=e?.toMultihash()?.bytes)return a(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[Da](){return`PeerId(${this.toString()})`}},Ta=class extends _a{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},Ia=class extends _a{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},Ca=class extends _a{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};let Pa=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=ke.digest(Ge(this.url))}[Da](){return`PeerId(${this.url})`}[Yo]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return Ue.createV1(2336,this.toMultihash())}toJSON(){return this.toString()}equals(e){return null!=e&&(e instanceof Uint8Array&&(e=Qe(e)),e.toString()===this.toString())}};function xa(e,t){let s;if("1"!==e.charAt(0)&&"Q"!==e.charAt(0)){if(e.startsWith("k51qzi5uqu5")||e.startsWith("kzwfwjn5ji4")||e.startsWith("k2k4r8")||e.startsWith("bafz"))return Na(Ue.parse(e));throw new ra('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return s=Pe(G.decode(`z${e}`)),ka(s)}function Aa(e){if("Ed25519"===e.type)return new Ia({multihash:e.toCID().multihash,publicKey:e});if("secp256k1"===e.type)return new Ca({multihash:e.toCID().multihash,publicKey:e});if("RSA"===e.type)return new Ta({multihash:e.toCID().multihash,publicKey:e});throw new wa}function ka(e){if(function(e){return e.code===Me.code}(e))return new Ta({multihash:e});if(function(e){return e.code===ke.code}(e))try{const t=jo(e);if("Ed25519"===t.type)return new Ia({multihash:e,publicKey:t});if("secp256k1"===t.type)return new Ca({multihash:e,publicKey:t})}catch(t){const s=Qe(e.digest);return new Pa(new URL(s))}throw new ha("Supplied PeerID Multihash is invalid")}function Na(e){if(null==e?.multihash||null==e.version||1===e.version&&114!==e.code&&2336!==e.code)throw new la("Supplied PeerID CID is invalid");if(2336===e.code){const t=Qe(e.multihash.digest);return new Pa(new URL(t))}return ka(e.multihash)}function Ra(e){if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||Symbol.toStringTag in e||Symbol.iterator in e)}const{hasOwnProperty:Ma}=Object.prototype,{propertyIsEnumerable:La}=Object,Oa=(e,t,s)=>{Object.defineProperty(e,t,{value:s,writable:!0,enumerable:!0,configurable:!0})},Ba={concatArrays:!1,ignoreUndefined:!1},Ua=e=>{const t=[];for(const s in e)Ma.call(e,s)&&t.push(s);if(Object.getOwnPropertySymbols){const s=Object.getOwnPropertySymbols(e);for(const r of s)La.call(e,r)&&t.push(r)}return t};function Va(e){return Array.isArray(e)?function(e){const t=e.slice(0,0);return Ua(e).forEach(s=>{Oa(t,s,Va(e[s]))}),t}(e):Ra(e)?function(e){const t=null===Object.getPrototypeOf(e)?Object.create(null):{};return Ua(e).forEach(s=>{Oa(t,s,Va(e[s]))}),t}(e):e}const Fa=(e,t,s,r)=>(s.forEach(s=>{void 0===t[s]&&r.ignoreUndefined||(s in e&&e[s]!==Object.getPrototypeOf(e)?Oa(e,s,$a(e[s],t[s],r)):Oa(e,s,Va(t[s])))}),e),za=(e,t,s)=>{let r=e.slice(0,0),n=0;return[e,t].forEach(t=>{const i=[];for(let s=0;s<t.length;s++)Ma.call(t,s)&&(i.push(String(s)),Oa(r,n++,t===e?t[s]:Va(t[s])));r=Fa(r,t,Ua(t).filter(e=>!i.includes(e)),s)}),r};function $a(e,t,s){return s.concatArrays&&Array.isArray(e)&&Array.isArray(t)?za(e,t,s):Ra(t)&&Ra(e)?Fa(e,t,Ua(t),s):Va(t)}function qa(...e){const t=$a(Va(Ba),undefined!==this&&this||{},Ba);let s={_:{}};for(const r of e)if(void 0!==r){if(!Ra(r))throw new TypeError("`"+r+"` is not an Option Object");s=$a(s,{_:r},t)}return s._}class Wa extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}}class Ka extends AggregateError{static name="DNSQueryFailedError";name="DNSQueryFailedError"}var ja={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,s="~";function r(){}function n(e,t,s){this.fn=e,this.context=t,this.once=s||!1}function i(e,t,r,i,o){if("function"!=typeof r)throw new TypeError("The listener must be a function");var a=new n(r,i||e,o),c=s?s+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function o(e,t){0===--e._eventsCount?e._events=new r:delete e._events[t]}function a(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(s=!1)),a.prototype.eventNames=function(){var e,r,n=[];if(0===this._eventsCount)return n;for(r in e=this._events)t.call(e,r)&&n.push(s?r.slice(1):r);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},a.prototype.listeners=function(e){var t=s?s+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var n=0,i=r.length,o=new Array(i);n<i;n++)o[n]=r[n].fn;return o},a.prototype.listenerCount=function(e){var t=s?s+e:e,r=this._events[t];return r?r.fn?1:r.length:0},a.prototype.emit=function(e,t,r,n,i,o){var a=s?s+e:e;if(!this._events[a])return!1;var c,l,h=this._events[a],u=arguments.length;if(h.fn){switch(h.once&&this.removeListener(e,h.fn,void 0,!0),u){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,t),!0;case 3:return h.fn.call(h.context,t,r),!0;case 4:return h.fn.call(h.context,t,r,n),!0;case 5:return h.fn.call(h.context,t,r,n,i),!0;case 6:return h.fn.call(h.context,t,r,n,i,o),!0}for(l=1,c=new Array(u-1);l<u;l++)c[l-1]=arguments[l];h.fn.apply(h.context,c)}else{var d,p=h.length;for(l=0;l<p;l++)switch(h[l].once&&this.removeListener(e,h[l].fn,void 0,!0),u){case 1:h[l].fn.call(h[l].context);break;case 2:h[l].fn.call(h[l].context,t);break;case 3:h[l].fn.call(h[l].context,t,r);break;case 4:h[l].fn.call(h[l].context,t,r,n);break;default:if(!c)for(d=1,c=new Array(u-1);d<u;d++)c[d-1]=arguments[d];h[l].fn.apply(h[l].context,c)}}return!0},a.prototype.on=function(e,t,s){return i(this,e,t,s,!1)},a.prototype.once=function(e,t,s){return i(this,e,t,s,!0)},a.prototype.removeListener=function(e,t,r,n){var i=s?s+e:e;if(!this._events[i])return this;if(!t)return o(this,i),this;var a=this._events[i];if(a.fn)a.fn!==t||n&&!a.once||r&&a.context!==r||o(this,i);else{for(var c=0,l=[],h=a.length;c<h;c++)(a[c].fn!==t||n&&!a[c].once||r&&a[c].context!==r)&&l.push(a[c]);l.length?this._events[i]=1===l.length?l[0]:l:o(this,i)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&o(this,t)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=s,a.EventEmitter=a,e.exports=a}(ja);var Ha=t(ja.exports);let Ga=class e extends Error{name="TimeoutError";constructor(t,s){super(t,s),Error.captureStackTrace?.(this,e)}};const Qa=e=>e.reason??new DOMException("This operation was aborted.","AbortError");function Xa(e,t){const{milliseconds:s,fallback:r,message:n,customTimers:i={setTimeout:setTimeout,clearTimeout:clearTimeout},signal:o}=t;let a,c;const l=new Promise((t,l)=>{if("number"!=typeof s||1!==Math.sign(s))throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${s}\``);if(o?.aborted)return void l(Qa(o));if(o&&(c=()=>{l(Qa(o))},o.addEventListener("abort",c,{once:!0})),e.then(t,l),s===Number.POSITIVE_INFINITY)return;const h=new Ga;a=i.setTimeout.call(void 0,()=>{if(r)try{t(r())}catch(e){l(e)}else"function"==typeof e.cancel&&e.cancel(),!1===n?t():n instanceof Error?l(n):(h.message=n??`Promise timed out after ${s} milliseconds`,l(h))},s)}).finally(()=>{l.clear(),c&&o&&o.removeEventListener("abort",c)});return l.clear=()=>{i.clearTimeout.call(void 0,a),a=void 0},l}let Ya=class{#t=[];enqueue(e,t){const{priority:s=0,id:r}=t??{},n={priority:s,id:r,run:e};if(0===this.size||this.#t[this.size-1].priority>=s)return void this.#t.push(n);const i=function(e,t,s){let r=0,n=e.length;for(;n>0;){const i=Math.trunc(n/2);let o=r+i;s(e[o],t)<=0?(r=++o,n-=i+1):n=i}return r}(this.#t,n,(e,t)=>t.priority-e.priority);this.#t.splice(i,0,n)}setPriority(e,t){const s=this.#t.findIndex(t=>t.id===e);if(-1===s)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[r]=this.#t.splice(s,1);this.enqueue(r.run,{priority:t,id:e})}dequeue(){const e=this.#t.shift();return e?.run}filter(e){return this.#t.filter(t=>t.priority===e.priority).map(e=>e.run)}get size(){return this.#t.length}};class Ja extends Ha{#s;#r;#n=0;#i;#o=!1;#a=!1;#c;#l=0;#h=0;#u;#d;#t;#p;#f=0;#g;#m;#y=1n;#b=new Map;timeout;constructor(e){if(super(),!("number"==typeof(e={carryoverIntervalCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:Ya,...e}).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);if(this.#s=e.carryoverIntervalCount??e.carryoverConcurrencyCount??!1,this.#r=e.intervalCap===Number.POSITIVE_INFINITY||0===e.interval,this.#i=e.intervalCap,this.#c=e.interval,this.#t=new e.queueClass,this.#p=e.queueClass,this.concurrency=e.concurrency,void 0!==e.timeout&&!(Number.isFinite(e.timeout)&&e.timeout>0))throw new TypeError(`Expected \`timeout\` to be a positive finite number, got \`${e.timeout}\` (${typeof e.timeout})`);this.timeout=e.timeout,this.#m=!1===e.autoStart,this.#w()}get#v(){return this.#r||this.#n<this.#i}get#S(){return this.#f<this.#g}#E(){this.#f--,0===this.#f&&this.emit("pendingZero"),this.#D(),this.emit("next")}#_(){this.#T(),this.#I(),this.#d=void 0}get#C(){const e=Date.now();if(void 0===this.#u){const t=this.#l-e;if(!(t<0))return this.#P(t),!0;if(this.#h>0){const t=e-this.#h;if(t<this.#c)return this.#P(this.#c-t),!0}this.#n=this.#s?this.#f:0}return!1}#P(e){void 0===this.#d&&(this.#d=setTimeout(()=>{this.#_()},e))}#x(){this.#u&&(clearInterval(this.#u),this.#u=void 0)}#A(){this.#d&&(clearTimeout(this.#d),this.#d=void 0)}#D(){if(0===this.#t.size)return this.#x(),this.emit("empty"),0===this.#f&&(this.#A(),this.emit("idle")),!1;let e=!1;if(!this.#m){const t=!this.#C;if(this.#v&&this.#S){const s=this.#t.dequeue();this.#r||(this.#n++,this.#k()),this.emit("active"),this.#h=Date.now(),s(),t&&this.#I(),e=!0}}return e}#I(){this.#r||void 0!==this.#u||(this.#u=setInterval(()=>{this.#T()},this.#c),this.#l=Date.now()+this.#c)}#T(){0===this.#n&&0===this.#f&&this.#u&&this.#x(),this.#n=this.#s?this.#f:0,this.#N(),this.#k()}#N(){for(;this.#D(););}get concurrency(){return this.#g}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#g=e,this.#N()}setPriority(e,t){if("number"!=typeof t||!Number.isFinite(t))throw new TypeError(`Expected \`priority\` to be a finite number, got \`${t}\` (${typeof t})`);this.#t.setPriority(e,t)}async add(e,t={}){return t.id??=(this.#y++).toString(),t={timeout:this.timeout,...t},new Promise((s,r)=>{const n=Symbol(`task-${t.id}`);this.#t.enqueue(async()=>{let i;this.#f++,this.#b.set(n,{id:t.id,priority:t.priority??0,startTime:Date.now(),timeout:t.timeout});try{try{t.signal?.throwIfAborted()}catch(e){throw this.#r||this.#n--,this.#b.delete(n),e}let r=e({signal:t.signal});if(t.timeout&&(r=Xa(Promise.resolve(r),{milliseconds:t.timeout,message:`Task timed out after ${t.timeout}ms (queue has ${this.#f} running, ${this.#t.size} waiting)`})),t.signal){const{signal:e}=t;r=Promise.race([r,new Promise((t,s)=>{i=()=>{s(e.reason)},e.addEventListener("abort",i,{once:!0})})])}const o=await r;s(o),this.emit("completed",o)}catch(e){r(e),this.emit("error",e)}finally{i&&t.signal?.removeEventListener("abort",i),this.#b.delete(n),queueMicrotask(()=>{this.#E()})}},t),this.emit("add"),this.#D()})}async addAll(e,t){return Promise.all(e.map(async e=>this.add(e,t)))}start(){return this.#m?(this.#m=!1,this.#N(),this):this}pause(){this.#m=!0}clear(){this.#t=new this.#p,this.#R()}async onEmpty(){0!==this.#t.size&&await this.#M("empty")}async onSizeLessThan(e){this.#t.size<e||await this.#M("next",()=>this.#t.size<e)}async onIdle(){0===this.#f&&0===this.#t.size||await this.#M("idle")}async onPendingZero(){0!==this.#f&&await this.#M("pendingZero")}async onRateLimit(){this.isRateLimited||await this.#M("rateLimit")}async onRateLimitCleared(){this.isRateLimited&&await this.#M("rateLimitCleared")}async onError(){return new Promise((e,t)=>{const s=e=>{this.off("error",s),t(e)};this.on("error",s)})}async#M(e,t){return new Promise(s=>{const r=()=>{t&&!t()||(this.off(e,r),s())};this.on(e,r)})}get size(){return this.#t.size}sizeBy(e){return this.#t.filter(e).length}get pending(){return this.#f}get isPaused(){return this.#m}#w(){this.#r||(this.on("add",()=>{this.#t.size>0&&this.#k()}),this.on("next",()=>{this.#k()}))}#k(){this.#r||this.#a||(this.#a=!0,queueMicrotask(()=>{this.#a=!1,this.#R()}))}#R(){const e=this.#o,t=!this.#r&&this.#n>=this.#i&&this.#t.size>0;t!==e&&(this.#o=t,this.emit(t?"rateLimit":"rateLimitCleared"))}get isRateLimited(){return this.#o}get isSaturated(){return this.#f===this.#g&&this.#t.size>0||this.isRateLimited&&this.#t.size>0}get runningTasks(){return[...this.#b.values()].map(e=>({...e}))}}function Za(e){const t=[oc.A];return null==e?t:Array.isArray(e)?0===e.length?t:e:[e]}function ec(e){return{Status:e.Status??0,TC:e.TC??e.flag_tc??!1,RD:e.RD??e.flag_rd??!1,RA:e.RA??e.flag_ra??!1,AD:e.AD??e.flag_ad??!1,CD:e.CD??e.flag_cd??!1,Question:(e.Question??e.questions??[]).map(e=>({name:e.name,type:oc[e.type]})),Answer:(e.Answer??e.answers??[]).map(e=>({name:e.name,type:oc[e.type],TTL:e.TTL??e.ttl??60,data:e.data instanceof Uint8Array?Qe(e.data):e.data}))}}function tc(e,t={}){const s=new Ja({concurrency:t.queryConcurrency??4});return async(t,r={})=>{const n=new URLSearchParams;n.set("name",t),Za(r.types).forEach(e=>{n.append("type",oc[e])}),r.onProgress?.(new Wa("dns:query",t));const i=await s.add(async()=>{const t=await fetch(`${e}?${n}`,{headers:{accept:"application/dns-json"},signal:r?.signal});if(200!==t.status)throw new Error(`Unexpected HTTP status: ${t.status} - ${t.statusText}`);const s=ec(await t.json());return r.onProgress?.(new Wa("dns:response",s)),s},{signal:r.signal});if(null==i)throw new Error("No DNS response received");return i}}var sc=function(e){if(!e)throw Error("hashlru must have a max value, of type number, greater than 0");var t=0,s=Object.create(null),r=Object.create(null);function n(n,i){s[n]=i,++t>=e&&(t=0,r=s,s=Object.create(null))}return{has:function(e){return void 0!==s[e]||void 0!==r[e]},remove:function(e){void 0!==s[e]&&(s[e]=void 0),void 0!==r[e]&&(r[e]=void 0)},get:function(e){var t=s[e];return void 0!==t?t:void 0!==(t=r[e])?(n(e,t),t):void 0},set:function(e,t){void 0!==s[e]?s[e]=t:n(e,t)},clear:function(){s=Object.create(null),r=Object.create(null)}}},rc=t(sc);class nc{lru;constructor(e){this.lru=rc(e)}get(e,t){let s=!0;const r=[];for(const n of t){const t=this.getAnswers(e,n);if(0===t.length){s=!1;break}r.push(...t)}if(s)return ec({answers:r})}getAnswers(e,t){const s=`${e.toLowerCase()}-${t}`,r=this.lru.get(s);if(null!=r){const e=r.filter(e=>e.expires>Date.now()).map(({expires:e,value:t})=>({...t,TTL:Math.round((e-Date.now())/1e3),type:oc[t.type]}));return 0===e.length&&this.lru.remove(s),e}return[]}add(e,t){const s=`${e.toLowerCase()}-${t.type}`,r=this.lru.get(s)??[];r.push({expires:Date.now()+1e3*(t.TTL??60),value:t}),this.lru.set(s,r)}remove(e,t){const s=`${e.toLowerCase()}-${t}`;this.lru.remove(s)}clear(){this.lru.clear()}}class ic{resolvers;cache;constructor(e){this.resolvers={},this.cache=function(e){return new nc(e)}(e.cacheSize??1e3),Object.entries(e.resolvers??{}).forEach(([e,t])=>{Array.isArray(t)||(t=[t]),e.endsWith(".")||(e=`${e}.`),this.resolvers[e]=t}),null==this.resolvers["."]&&(this.resolvers["."]=[tc("https://cloudflare-dns.com/dns-query"),tc("https://dns.google/resolve")])}async query(e,t={}){const s=Za(t.types),r=!1!==t.cached?this.cache.get(e,s):void 0;if(null!=r)return t.onProgress?.(new Wa("dns:cache",r)),r;const n=`${e.split(".").pop()}.`,i=(this.resolvers[n]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),o=[];for(const r of i){if(!0===t.signal?.aborted)break;try{const n=await r(e,{...t,types:s});for(const t of n.Answer)this.cache.add(e,t);return n}catch(e){o.push(e),t.onProgress?.(new Wa("dns:error",e))}}throw new Ka(o,`DNS lookup of ${e} ${s} failed`)}}var oc;!function(e){e[e.A=1]="A",e[e.CNAME=5]="CNAME",e[e.TXT=16]="TXT",e[e.AAAA=28]="AAAA"}(oc||(oc={}));let ac=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},cc=class extends Error{static name="ValidationError";name="ValidationError"},lc=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"},hc=class extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"};const uc=new class{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,s=e();return void 0===s&&(this.index=t),s}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,s){return this.readAtomically(()=>{if(!(t>0&&void 0===this.readGivenChar(e)))return s()})}readNumber(e,t,s,r){return this.readAtomically(()=>{let n=0,i=0;const o=this.peekChar();if(void 0===o)return;const a="0"===o,c=2**(8*r)-1;for(;;){const s=this.readAtomically(()=>{const t=this.readChar();if(void 0===t)return;const s=Number.parseInt(t,e);return Number.isNaN(s)?void 0:s});if(void 0===s)break;if(n*=e,n+=s,n>c)return;if(i+=1,void 0!==t&&i>t)return}return 0===i||!s&&a&&i>1?void 0:n})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const s=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(void 0===s)return;e[t]=s}return e})}readIPv6Addr(){const e=e=>{for(let t=0;t<e.length/2;t++){const s=2*t;if(t<e.length-3){const r=this.readSeparator(":",t,()=>this.readIPv4Addr());if(void 0!==r)return e[s]=r[0],e[s+1]=r[1],e[s+2]=r[2],e[s+3]=r[3],[s+4,!0]}const r=this.readSeparator(":",t,()=>this.readNumber(16,4,!0,2));if(void 0===r)return[s,!1];e[s]=r>>8,e[s+1]=255&r}return[e.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[s,r]=e(t);if(16===s)return t;if(r)return;if(void 0===this.readGivenChar(":"))return;if(void 0===this.readGivenChar(":"))return;const n=new Uint8Array(14),i=16-(s+2),[o]=e(n.subarray(0,i));return t.set(n.subarray(0,o),16-o),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}};function dc(e){if(!(e.length>15))return uc.new(e).parseWith(()=>uc.readIPv4Addr())}function pc(e){if(e.includes("%")&&(e=e.split("%")[0]),!(e.length>45))return uc.new(e).parseWith(()=>uc.readIPv6Addr())}function fc(e,t=!1){if(e.includes("%")&&(e=e.split("%")[0]),e.length>45)return;const s=uc.new(e).parseWith(()=>uc.readIPAddr());return s?t&&4===s.length?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,s[0],s[1],s[2],s[3]]):s:void 0}function gc(e){return Boolean(dc(e))}function mc(e){return Boolean(pc(e))}const yc=41;function bc(e){return t=>Qe(t,e)}function wc(e){return t=>Ge(t,e)}function vc(e){return new DataView(e.buffer).getUint16(e.byteOffset).toString()}function Sc(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,"string"==typeof e?parseInt(e):e),new Uint8Array(t)}function Ec(e){const t=e.subarray(0,e.length-2),s=e.subarray(e.length-2);return`${Qe(t,"base32")}:${vc(s)}`}const Dc=function(e){e=e.toString().trim();const t=new Uint8Array(4);return e.split(/\./g).forEach((e,s)=>{const r=parseInt(e,10);if(isNaN(r)||r<0||r>255)throw new ac("Invalid byte value in IP address");t[s]=r}),t};const _c=Object.values(qe).map(e=>e.decoder),Tc=function(){let e=_c[0].or(_c[1]);return _c.slice(2).forEach(t=>e=e.or(t)),e}();const Ic=function(...e){return t=>{for(const s of e)s(t)}}(function(e){if(parseInt(e).toString()!==e)throw new cc("Value must be an integer")},function(e){if(e<0)throw new cc("Value must be a positive integer, or zero")},function(e){return t=>{if(t>e)throw new cc(`Value must be smaller than or equal to ${e}`)}}(65535)),Cc=-1;const Pc=new class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(t="string"==typeof e?this.protocolsByName.get(e):this.protocolsByCode.get(e),null==t)throw new hc(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);null!=t&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(e=>{this.protocolsByName.delete(e)}))}},xc=[{code:4,name:"ip4",size:32,valueToBytes:Dc,bytesToValue:function(e){if(4!==e.byteLength)throw new ac("IPv4 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s++)t.push(e[s]);return t.join(".")},validate:e=>{if(!gc(e))throw new cc(`Invalid IPv4 address "${e}"`)}},{code:6,name:"tcp",size:16,valueToBytes:Sc,bytesToValue:vc,validate:Ic},{code:273,name:"udp",size:16,valueToBytes:Sc,bytesToValue:vc,validate:Ic},{code:33,name:"dccp",size:16,valueToBytes:Sc,bytesToValue:vc,validate:Ic},{code:yc,name:"ip6",size:128,valueToBytes:function(e){let t=0;const s=(e=e.toString().trim()).split(":",8);let r;for(r=0;r<s.length;r++){let e;gc(s[r])&&(e=Dc(s[r]),s[r]=Qe(e.subarray(0,2),"base16")),null!=e&&++r<8&&s.splice(r,0,Qe(e.subarray(2,4),"base16"))}if(""===s[0])for(;s.length<8;)s.unshift("0");else if(""===s[s.length-1])for(;s.length<8;)s.push("0");else if(s.length<8){for(r=0;r<s.length&&""!==s[r];r++);const e=[r,1];for(r=9-s.length;r>0;r--)e.push("0");s.splice.apply(s,e)}const n=new Uint8Array(t+16);for(r=0;r<s.length;r++){""===s[r]&&(s[r]="0");const e=parseInt(s[r],16);if(isNaN(e)||e<0||e>65535)throw new ac("Invalid byte value in IP address");n[t++]=e>>8&255,n[t++]=255&e}return n},bytesToValue:function(e){if(16!==e.byteLength)throw new ac("IPv6 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s+=2){const r=e[s],n=e[s+1],i=`${r.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}`;t.push(i)}const s=t.join(":");try{const e=new URL(`http://[${s}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new ac(`Invalid IPv6 address "${s}"`)}},stringToValue:function(e){try{const t=new URL(`http://[${e}]`);return t.hostname.substring(1,t.hostname.length-1)}catch{throw new ac(`Invalid IPv6 address "${e}"`)}},validate:e=>{if(!mc(e))throw new cc(`Invalid IPv6 address "${e}"`)}},{code:42,name:"ip6zone",size:Cc},{code:43,name:"ipcidr",size:8,bytesToValue:bc("base10"),valueToBytes:wc("base10")},{code:53,name:"dns",size:Cc,resolvable:!0},{code:54,name:"dns4",size:Cc,resolvable:!0},{code:55,name:"dns6",size:Cc,resolvable:!0},{code:56,name:"dnsaddr",size:Cc,resolvable:!0},{code:132,name:"sctp",size:16,valueToBytes:Sc,bytesToValue:vc,validate:Ic},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:Cc,path:!0,stringToValue:e=>decodeURIComponent(e),valueToString:e=>encodeURIComponent(e)},{code:421,name:"p2p",aliases:["ipfs"],size:Cc,bytesToValue:bc("base58btc"),valueToBytes:e=>e.startsWith("Q")||e.startsWith("1")?wc("base58btc")(e):Ue.parse(e).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:Ec,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const s=Ge(t[0],"base32"),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=Sc(r);return u([s,n],s.length+n.length)}},{code:445,name:"onion3",size:296,bytesToValue:Ec,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const s=L.decode(`b${t[0]}`),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=Sc(r);return u([s,n],s.length+n.length)}},{code:446,name:"garlic64",size:Cc},{code:447,name:"garlic32",size:Cc},{code:448,name:"tls"},{code:449,name:"sni",size:Cc},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:Cc,bytesToValue:function(e){return t=>e.encoder.encode(t)}(Z),valueToBytes:function(e){return Tc.decode(e)}},{code:480,name:"http"},{code:481,name:"http-path",size:Cc,stringToValue:e=>`/${decodeURIComponent(e)}`,valueToString:e=>encodeURIComponent(e.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:Cc}];function Ac(e,t,s){return null==e.size||0===e.size?0:e.size>0?e.size/8:Ci(t,s)}xc.forEach(e=>{Pc.addProtocol(e)});const kc=Symbol.for("nodejs.util.inspect.custom"),Nc=Symbol.for("@multiformats/multiaddr"),Rc=[53,54,55,56];class Mc extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}}function Lc(e){if(null==e&&(e="/"),Wc(e))return e.getComponents();if(e instanceof Uint8Array)return function(e){const t=[];let s=0;for(;s<e.length;){const r=Ci(e,s),n=Pc.getProtocol(r),i=Di(r),o=Ac(n,e,s+i);let a=0;o>0&&n.size===Cc&&(a=Di(o));const c=i+a+o,l={code:r,name:n.name,bytes:e.subarray(s,s+c)};if(o>0){const t=s+i+a,r=e.subarray(t,t+o);l.value=n.bytesToValue?.(r)??Qe(r)}t.push(l),s+=c}return t}(e);if("string"==typeof e)return""===(e=e.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""))&&(e="/"),function(e){if("/"!==e.charAt(0))throw new ac('String multiaddr must start with "/"');const t=[];let s="protocol",r="",n="";for(let i=1;i<e.length;i++){const o=e.charAt(i);"/"!==o&&("protocol"===s?n+=e.charAt(i):r+=e.charAt(i));const a=i===e.length-1;if("/"===o||a){const e=Pc.getProtocol(n);if("protocol"===s){if(null==e.size||0===e.size){t.push({code:e.code,name:e.name}),r="",n="",s="protocol";continue}if(a)throw new ac(`Component ${n} was missing value`);s="value"}else if("value"===s){const i={code:e.code,name:e.name};if(null!=e.size&&0!==e.size){if(""===r)throw new ac(`Component ${n} was missing value`);i.value=e.stringToValue?.(r)??r}t.push(i),r="",n="",s="protocol"}}}if(""!==n&&""!==r)throw new ac("Incomplete multiaddr");return t}(e);if(Array.isArray(e))return e;throw new ac("Must be a string, Uint8Array, Component[], or another Multiaddr")}let Oc=class e{[Nc]=!0;#L;#O;#B;constructor(e="/",t={}){this.#L=Lc(e),!1!==t.validate&&function(e){e.getComponents().forEach(e=>{const t=Pc.getProtocol(e.code);null!=e.value&&t.validate?.(e.value)})}(this)}get bytes(){return null==this.#B&&(this.#B=function(e){let t=0;const s=[];for(const r of e){if(null==r.bytes){const e=Pc.getProtocol(r.code),t=Di(r.code);let s,n=0,i=0;null!=r.value&&(s=e.valueToBytes?.(r.value)??Ge(r.value),n=s.byteLength,e.size===Cc&&(i=Di(n)));const o=new Uint8Array(t+i+n);let a=0;_i(r.code,o,a),a+=t,null!=s&&(e.size===Cc&&(_i(n,o,a),a+=i),o.set(s,a)),r.bytes=o}s.push(r.bytes),t+=r.bytes.byteLength}return u(s,t)}(this.#L)),this.#B}toString(){return null==this.#O&&(this.#O=`/${this.#L.flatMap(e=>{if(null==e.value)return e.name;const t=Pc.getProtocol(e.code);if(null==t)throw new ac(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`),this.#O}toJSON(){return this.toString()}toOptions(){let e,t,s,r,n="";for(const{code:i,name:o,value:a}of this.#L)42===i&&(n=`%${a??""}`),Rc.includes(i)&&(t="tcp",r=443,s=`${a??""}${n}`,e=55===i?6:4),6!==i&&273!==i||(t="tcp"===o?"tcp":"udp",r=parseInt(a??"")),4!==i&&i!==yc||(t="tcp",s=`${a??""}${n}`,e=i===yc?6:4);if(null==e||null==t||null==s||null==r)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:s,transport:t,port:r}}getComponents(){return[...this.#L]}protos(){return this.#L.map(({code:e,value:t})=>{const s=Pc.getProtocol(e);return{code:e,size:s.size??0,name:s.name,resolvable:Boolean(s.resolvable),path:Boolean(s.path)}})}protoCodes(){return this.#L.map(({code:e})=>e)}protoNames(){return this.#L.map(({name:e})=>e)}tuples(){return this.#L.map(({code:e,value:t})=>{if(null==t)return[e];const s=Pc.getProtocol(e),r=[e];return null!=t&&r.push(s.valueToBytes?.(t)??Ge(t)),r})}stringTuples(){return this.#L.map(({code:e,value:t})=>null==t?[e]:[e,t])}encapsulate(t){const s=new e(t);return new e([...this.#L,...s.getComponents()],{validate:!1})}decapsulate(t){const s=t.toString(),r=this.toString(),n=r.lastIndexOf(s);if(n<0)throw new lc(`Address ${this.toString()} does not contain subaddress: ${t.toString()}`);return new e(r.slice(0,n),{validate:!1})}decapsulateCode(t){let s;for(let e=this.#L.length-1;e>-1;e--)if(this.#L[e].code===t){s=e;break}return new e(this.#L.slice(0,s),{validate:!1})}getPeerId(){try{let e=[];this.#L.forEach(({code:t,value:s})=>{421===t&&e.push([t,s]),290===t&&(e=[])});const t=e.pop();if(null!=t?.[1]){const e=t[1];return"Q"===e[0]||"1"===e[0]?Qe(G.decode(`z${e}`),"base58btc"):Qe(Ue.parse(e).multihash.bytes,"base58btc")}return null}catch(e){return null}}getPath(){for(const e of this.#L){if(Pc.getProtocol(e.code).path)return e.value??null}return null}equals(e){return a(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(e=>e.resolvable);if(null==t)return[this];const s=qc.get(t.name);if(null==s)throw new Mc(`no available resolver for ${t.name}`);return(await s(this,e)).map(e=>Kc(e))}nodeAddress(){const e=this.toOptions();if("tcp"!==e.transport&&"udp"!==e.transport)throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(){return 2===this.#L.length&&((4===this.#L[0].code||this.#L[0].code===yc)&&(6===this.#L[1].code||273===this.#L[1].code))}[kc](){return`Multiaddr(${this.toString()})`}};const Bc=4,Uc=16,Vc=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function Fc(e,t){t.length===Uc&&e.length===Bc&&function(e,t,s){let r=0;for(const n of e)if(!(r<t)){if(r>s)break;if(255!==n)return!1;r++}return!0}(t,0,11)&&(t=t.slice(12)),t.length===Bc&&e.length===Uc&&function(e,t,s,r){let n=0;for(const i of e)if(!(n<s)){if(n>r)break;if(i!==t[n])return!1;n++}return!0}(e,Vc,0,11)&&(e=e.slice(12));const s=e.length;if(s!=t.length)throw new Error("Failed to mask ip");const r=new Uint8Array(s);for(let n=0;n<s;n++)r[n]=e[n]&t[n];return r}function zc(e,t){if(t!==8*Bc&&t!==8*Uc)throw new Error("Invalid CIDR mask");if(e<0||e>t)throw new Error("Invalid CIDR mask");const s=t/8,r=new Uint8Array(s);for(let t=0;t<s;t++)e>=8?(r[t]=255,e-=8):(r[t]=255-(255>>e),e=0);return r}class $c{constructor(e,t){if(null==t)({network:this.network,mask:this.mask}=function(e){const[t,s]=e.split("/");if(!t||!s)throw new Error("Failed to parse given CIDR: "+e);let r=Bc,n=dc(t);if(null==n&&(r=Uc,n=pc(t),null==n))throw new Error("Failed to parse given CIDR: "+e);const i=parseInt(s,10);if(Number.isNaN(i)||String(i).length!==s.length||i<0||i>8*r)throw new Error("Failed to parse given CIDR: "+e);const o=zc(i,8*r);return{network:Fc(n,o),mask:o}}(e));else{const s=fc(e);if(null==s)throw new Error("Failed to parse network");t=String(t);const r=parseInt(t,10);if(Number.isNaN(r)||String(r).length!==t.length||r<0||r>8*s.length){const e=fc(t);if(null==e)throw new Error("Failed to parse mask");this.mask=e}else this.mask=zc(r,8*s.length);this.network=Fc(s,this.mask)}}contains(e){return function(e,t){if("string"==typeof t&&(t=fc(t)),null==t)throw new Error("Invalid ip");if(t.length!==e.network.length)return!1;for(let s=0;s<t.length;s++)if((e.network[s]&e.mask[s])!==(t[s]&e.mask[s]))return!1;return!0}({network:this.network,mask:this.mask},e)}toString(){const e=function(e){let t=0;for(let[s,r]of e.entries()){if(255!==r){for(;128&r;)t++,r<<=1;if(128&r)return-1;for(let t=s+1;t<e.length;t++)if(0!=e[t])return-1;break}t+=8}return t}(this.mask),t=-1!==e?String(e):function(e){let t="0x";for(const s of e)t+=(s>>4).toString(16)+(15&s).toString(16);return t}(this.mask);return function(e){switch(e.length){case Bc:return e.join(".");case Uc:{const t=[];for(let s=0;s<e.length;s++)s%2==0&&t.push(e[s].toString(16).padStart(2,"0")+e[s+1].toString(16).padStart(2,"0"));return t.join(":")}default:throw new Error("Invalid ip length")}}(this.network)+"/"+t}}const qc=new Map;function Wc(e){return Boolean(e?.[Nc])}function Kc(e){return new Oc(e)}function jc(e){const t=Pc.getProtocol(e);return{code:t.code,size:t.size??0,name:t.name,resolvable:Boolean(t.resolvable),path:Boolean(t.path)}}const Hc=-1,Gc={},Qc={};[[4,32,"ip4"],[6,16,"tcp"],[33,16,"dccp"],[41,128,"ip6"],[42,Hc,"ip6zone"],[43,8,"ipcidr"],[53,Hc,"dns",!0],[54,Hc,"dns4",!0],[55,Hc,"dns6",!0],[56,Hc,"dnsaddr",!0],[132,16,"sctp"],[273,16,"udp"],[275,0,"p2p-webrtc-star"],[276,0,"p2p-webrtc-direct"],[277,0,"p2p-stardust"],[280,0,"webrtc-direct"],[281,0,"webrtc"],[290,0,"p2p-circuit"],[301,0,"udt"],[302,0,"utp"],[400,Hc,"unix",!1,!0],[421,Hc,"ipfs"],[421,Hc,"p2p"],[443,0,"https"],[444,96,"onion"],[445,296,"onion3"],[446,Hc,"garlic64"],[448,0,"tls"],[449,Hc,"sni"],[460,0,"quic"],[461,0,"quic-v1"],[465,0,"webtransport"],[466,Hc,"certhash"],[477,0,"ws"],[478,0,"wss"],[479,0,"p2p-websocket-star"],[480,0,"http"],[481,Hc,"http-path"],[777,Hc,"memory"]].forEach(e=>{const t=function(e,t,s,r,n){return{code:e,size:t,name:s,resolvable:Boolean(r),path:Boolean(n)}}(...e);Qc[t.code]=t,Gc[t.name]=t});const{code:Xc}=function(e){if(null!=Gc[e])return Gc[e];throw new Error(`no protocol with name: ${e}`)}("dnsaddr");class Yc extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}const Jc=async function(e,t={}){const s=t.maxRecursiveDepth??32;if(0===s)throw new Yc("Max recursive depth reached");const[,r]=e.stringTuples().find(([e])=>e===Xc)??[],n=t?.dns??function(e={}){return new ic(e)}(),i=await n.query(`_dnsaddr.${r}`,{signal:t?.signal,types:[oc.TXT]}),o=e.getPeerId(),a=[];for(const e of i.Answer){const r=e.data.replace(/["']/g,"").trim().split("=")[1];if(null==r)continue;if(null!=o&&!r.includes(o))continue;const n=Kc(r);if(r.startsWith("/dnsaddr")){const e=await n.resolve({...t,maxRecursiveDepth:s-1});a.push(...e.map(e=>e.toString()))}else a.push(n.toString())}return a},Zc={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:e=>e},connectionManager:{resolvers:{dnsaddr:Jc}},transportManager:{faultTolerance:ta.FATAL_ALL}};async function el(e){const t=qa(Zc,e);if(null===t.connectionProtector&&null!=globalThis.process?.env?.LIBP2P_FORCE_PNET)throw new ra("Private network is enforced, but no protector was provided");return t}const tl=1e3,sl=60*tl,rl=60*sl,nl=24*rl,il=7*nl,ol=365.25*nl,al=ol/12;var cl=function(e,t){if("string"==typeof e)return ll(e);if("number"==typeof e)return function(e,t){if("number"!=typeof e||!Number.isFinite(e))throw Error("Value provided to ms.format() must be of type number.");return t?.long?ul(e):hl(e)}(e,t);throw Error(`Value provided to ms() must be a string or number. value=${JSON.stringify(e)}`)};function ll(e){if("string"!=typeof e||0===e.length||e.length>100)throw Error(`Value provided to ms.parse() must be a string with length between 1 and 99. value=${JSON.stringify(e)}`);let t=/^(?<value>-?\d*\.?\d+) *(?<unit>milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|months?|mo|years?|yrs?|y)?$/i.exec(e);if(!t?.groups)return NaN;let{value:s,unit:r="ms"}=t.groups,n=parseFloat(s),i=r.toLowerCase();switch(i){case"years":case"year":case"yrs":case"yr":case"y":return n*ol;case"months":case"month":case"mo":return n*al;case"weeks":case"week":case"w":return n*il;case"days":case"day":case"d":return n*nl;case"hours":case"hour":case"hrs":case"hr":case"h":return n*rl;case"minutes":case"minute":case"mins":case"min":case"m":return n*sl;case"seconds":case"second":case"secs":case"sec":case"s":return n*tl;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:throw Error(`Unknown unit "${i}" provided to ms.parse(). value=${JSON.stringify(e)}`)}}function hl(e){let t=Math.abs(e);return t>=ol?`${Math.round(e/ol)}y`:t>=al?`${Math.round(e/al)}mo`:t>=il?`${Math.round(e/il)}w`:t>=nl?`${Math.round(e/nl)}d`:t>=rl?`${Math.round(e/rl)}h`:t>=sl?`${Math.round(e/sl)}m`:t>=tl?`${Math.round(e/tl)}s`:`${e}ms`}function ul(e){let t=Math.abs(e);return t>=ol?dl(e,t,ol,"year"):t>=al?dl(e,t,al,"month"):t>=il?dl(e,t,il,"week"):t>=nl?dl(e,t,nl,"day"):t>=rl?dl(e,t,rl,"hour"):t>=sl?dl(e,t,sl,"minute"):t>=tl?dl(e,t,tl,"second"):`${e} ms`}function dl(e,t,s,r){let n=t>=1.5*s;return`${Math.round(e/s)} ${r}${n?"s":""}`}const pl=function(){try{return localStorage}catch(e){}}();const fl=console.debug??console.log??(()=>{});var gl=function(e){function t(e,r){let n,i,o,a=null;function c(...e){if(!c.enabled)return;const s=c,i=Number(new Date),o=i-(n||i);s.diff=o,s.prev=n,s.curr=i,n=i,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let a=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,(r,n)=>{if("%%"===r)return"%";a++;const i=t.formatters[n];if("function"==typeof i){const t=e[a];r=i.call(s,t),e.splice(a,1),a--}return r}),t.formatArgs.call(s,e),null!=r?.onLog&&r.onLog(...e);(s.log||t.log).apply(s,e)}return c.namespace=e,c.useColors=t.useColors(),c.color=t.selectColor(e),c.extend=s,c.destroy=t.destroy,Object.defineProperty(c,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==a?a:(i!==t.namespaces&&(i=t.namespaces,o=t.enabled(e)),o),set:e=>{a=e}}),"function"==typeof t.init&&t.init(c),c}function s(e,s){const r=t(this.namespace+(void 0===s?":":s)+e);return r.log=this.log,r}function r(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack??e.message;return e},t.disable=function(){const e=[...t.names.map(r),...t.skips.map(r).map(e=>"-"+e)].join(",");return t.enable(""),e},t.enable=function(e){let s;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const r=("string"==typeof e?e:"").split(/[\s,]+/),n=r.length;for(s=0;s<n;s++)r[s]&&("-"===(e=r[s].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let s,r;for(s=0,r=t.skips.length;s<r;s++)if(t.skips[s].test(e))return!1;for(s=0,r=t.names.length;s<r;s++)if(t.names[s].test(e))return!0;return!1},t.humanize=cl,t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach(s=>{t[s]=e[s]}),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let s=0;for(let t=0;t<e.length;t++)s=(s<<5)-s+e.charCodeAt(t),s|=0;return t.colors[Math.abs(s)%t.colors.length]},t.setupFormatters(t.formatters),t.enable(t.load()),t}({formatArgs:function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+cl(this.diff),!this.useColors)return;const t="color: "+this.color;e.splice(1,0,t,"color: inherit");let s=0,r=0;e[0].replace(/%[a-zA-Z%]/g,e=>{"%%"!==e&&(s++,"%c"===e&&(r=s))}),e.splice(r,0,t)},save:function(e){try{e?pl?.setItem("debug",e):pl?.removeItem("debug")}catch(e){}},load:function(){let e;try{e=pl?.getItem("debug")}catch(e){}return!e&&void 0!==globalThis.process&&"env"in globalThis.process&&(e=globalThis.process.env.DEBUG),e},useColors:function(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||null==navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement?.style?.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&null!=navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/))},setupFormatters:function(e){e.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}},colors:["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],storage:pl,log:fl});function ml(){return{forComponent:e=>yl(e)}}function yl(e){let t=function(e){const t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=e,t.destroy=()=>!0,t.extend=()=>t,t}(`${e}:trace`);return gl.enabled(`${e}:trace`)&&null!=gl.names.map(e=>e.toString()).find(e=>e.includes(":trace"))&&(t=gl(`${e}:trace`)),Object.assign(gl(e),{error:gl(`${e}:error`),trace:t,newScope:t=>yl(`${e}:${t}`)})}function bl(e){if(null!=e&&0!==(e=e.trim()).length)return e}function wl(e,t){const s={[Symbol.iterator]:()=>s,next:()=>{const s=e.next(),r=s.value;if(!0===s.done||null==r){return{done:!0,value:void 0}}return{done:!1,value:t(r)}}};return s}function vl(e){return ka(Pe(G.decode(`z${e}`)))}gl.formatters.b=e=>null==e?"undefined":G.baseEncode(e),gl.formatters.t=e=>null==e?"undefined":L.baseEncode(e),gl.formatters.m=e=>null==e?"undefined":Y.baseEncode(e),gl.formatters.p=e=>null==e?"undefined":e.toString(),gl.formatters.c=e=>null==e?"undefined":e.toString(),gl.formatters.k=e=>null==e?"undefined":e.toString(),gl.formatters.a=e=>null==e?"undefined":e.toString(),gl.formatters.e=e=>null==e?"undefined":bl(e.stack)??bl(e.message)??e.toString();let Sl=class{map;constructor(e){if(this.map=new Map,null!=e)for(const[t,s]of e.entries())this.map.set(t.toString(),{key:t,value:s})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return wl(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,s)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return wl(this.map.values(),e=>e.key)}values(){return wl(this.map.values(),e=>e.value)}get size(){return this.map.size}},El=class e{set;constructor(e){if(this.set=new Set,null!=e)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return wl(this.set.entries(),e=>{const t=vl(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const s=vl(t);e(s,s,this)})}has(e){return this.set.has(e.toString())}values(){return wl(this.set.values(),e=>vl(e))}intersection(t){const s=new e;for(const e of t)this.has(e)&&s.add(e);return s}difference(t){const s=new e;for(const e of this)t.has(e)||s.add(e);return s}union(t){const s=new e;for(const e of t)s.add(e);for(const e of this)s.add(e);return s}};const Dl={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},_l={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},Tl=new globalThis.TextEncoder;function Il(e,{size:t=32,utf8Buffer:s}={}){if(!Dl[t])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if("string"==typeof e){if(s)return function(e,t,s){if(0===s.length)throw new Error("The `utf8Buffer` option must have a length greater than zero");const r=Dl[t];let n=_l[t],i=e;for(;i.length>0;){const e=Tl.encodeInto(i,s);i=i.slice(e.read);for(let i=0;i<e.written;i++)n^=BigInt(s[i]),n=BigInt.asUintN(t,n*r)}return n}(e,t,s);e=Tl.encode(e)}return function(e,t){const s=Dl[t];let r=_l[t];for(let n=0;n<e.length;n++)r^=BigInt(e[n]),r=BigInt.asUintN(t,r*s);return r}(e,t)}const Cl={hash:e=>Number(Il(e,{size:32})),hashV:(e,t)=>function(e){let t=e.toString(16);t.length%2==1&&(t=`0${t}`);return Ge(t,"base16")}(Cl.hash(e,t))};let Pl=class{fp;h;seed;constructor(e,t,s,r=2){if(r>64)throw new TypeError("Invalid Fingerprint Size");const n=t.hashV(e,s),i=c(r);for(let e=0;e<i.length;e++)i[e]=n[e];0===i.length&&(i[0]=7),this.fp=i,this.h=t,this.seed=s}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array&&a(this.fp,e.fp)}};function xl(e,t){return Math.floor(Math.random()*(t-e))+e}let Al=class{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof Pl))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof Pl))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(null==this.contents[t])return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof Pl))throw new TypeError("Invalid Fingerprint");const t=xl(0,this.contents.length-1),s=this.contents[t];return this.contents[t]=e,s}remove(e){if(!(e instanceof Pl))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(t=>e.equals(t));return t>-1&&(this.contents[t]=null,!0)}};let kl=class{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??Cl,this.seed=e.seed??xl(0,Math.pow(2,10))}add(e){"string"==typeof e&&(e=Ge(e));const t=new Pl(e,this.hash,this.seed,this.fingerprintSize),s=this.hash.hash(e,this.seed)%this.filterSize,r=(s^t.hash())%this.filterSize;if(null==this.buckets[s]&&(this.buckets[s]=new Al(this.bucketSize)),null==this.buckets[r]&&(this.buckets[r]=new Al(this.bucketSize)),this.buckets[s].add(t)||this.buckets[r].add(t))return this.count++,!0;const n=[s,r];let i=n[xl(0,n.length-1)];null==this.buckets[i]&&(this.buckets[i]=new Al(this.bucketSize));for(let e=0;e<500;e++){const e=this.buckets[i].swap(t);if(null!=e&&(i=(i^e.hash())%this.filterSize,null==this.buckets[i]&&(this.buckets[i]=new Al(this.bucketSize)),this.buckets[i].add(e)))return this.count++,!0}return!1}has(e){"string"==typeof e&&(e=Ge(e));const t=new Pl(e,this.hash,this.seed,this.fingerprintSize),s=this.hash.hash(e,this.seed)%this.filterSize,r=this.buckets[s]?.has(t)??!1;if(r)return r;const n=(s^t.hash())%this.filterSize;return this.buckets[n]?.has(t)??!1}remove(e){"string"==typeof e&&(e=Ge(e));const t=new Pl(e,this.hash,this.seed,this.fingerprintSize),s=this.hash.hash(e,this.seed)%this.filterSize,r=this.buckets[s]?.remove(t)??!1;if(r)return this.count--,r;const n=(s^t.hash())%this.filterSize,i=this.buckets[n]?.remove(t)??!1;return i&&this.count--,i}get reliable(){return Math.floor(this.count/this.filterSize*100)<=90}};const Nl={1:.5,2:.84,4:.95,8:.98};function Rl(e,t=.001){const s=function(e=.001){return e>.002?2:e>1e-5?4:8}(t),r=Nl[s];return{filterSize:Math.round(e/r),bucketSize:s,fingerprintSize:Math.min(Math.ceil(Math.log2(1/t)+Math.log2(2*s)),64)}}let Ml=class{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??Cl,this.seed=e.seed??xl(0,Math.pow(2,10)),this.filterSeries=[new kl({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if("string"==typeof e&&(e=Ge(e)),this.has(e))return!0;let t=this.filterSeries.find(e=>e.reliable);if(null==t){const e=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new kl({filterSize:e,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){"string"==typeof e&&(e=Ge(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){"string"==typeof e&&(e=Ge(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}};function Ll(e,t=.001,s){return new Ml({...Rl(e,t)})}let Ol=class extends Sl{metric;constructor(e){super();const{name:t,metrics:s}=e;this.metric=s.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}};var Bl;!function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.publicKey&&e.publicKey.byteLength>0&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.payloadType&&e.payloadType.byteLength>0&&(t.uint32(18),t.bytes(e.payloadType)),null!=e.payload&&e.payload.byteLength>0&&(t.uint32(26),t.bytes(e.payload)),null!=e.signature&&e.signature.byteLength>0&&(t.uint32(42),t.bytes(e.signature)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={publicKey:c(0),payloadType:c(0),payload:c(0),signature:c(0)},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.publicKey=e.bytes();break;case 2:r.payloadType=e.bytes();break;case 3:r.payload=e.bytes();break;case 5:r.signature=e.bytes();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(Bl||(Bl={}));let Ul=class extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}},Vl=class e{static createFromProtobuf=t=>{const s=Bl.decode(t),r=Ko(s.publicKey);return new e({publicKey:r,payloadType:s.payloadType,payload:s.payload,signature:s.signature})};static seal=async(t,s,r)=>{if(null==s)throw new Error("Missing private key");const n=t.domain,i=t.codec,o=t.marshal(),a=Fl(n,i,o),c=await s.sign(a.subarray(),r);return new e({publicKey:s.publicKey,payloadType:i,payload:o,signature:c})};static openAndCertify=async(t,s,r)=>{const n=e.createFromProtobuf(t);if(!await n.validate(s,r))throw new Ul("Envelope signature is not valid for the given domain");return n};publicKey;payloadType;payload;signature;marshaled;constructor(e){const{publicKey:t,payloadType:s,payload:r,signature:n}=e;this.publicKey=t,this.payloadType=s,this.payload=r,this.signature=n}marshal(){return null==this.marshaled&&(this.marshaled=Bl.encode({publicKey:Ho(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return null!=e&&a(this.marshal(),e.marshal())}async validate(e,t){const s=Fl(e,this.payloadType,this.payload);return this.publicKey.verify(s.subarray(),this.signature,t)}};const Fl=(e,t,s)=>{const r=Ge(e),n=Ii(r.byteLength),i=Ii(t.length),o=Ii(s.length);return new cs(n,r,i,t,o,s)};const zl=Uint8Array.from([3,1]);var $l;!function(e){let t;!function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={multiaddr:c(0)},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();if(t>>>3==1)r.multiaddr=e.bytes();else e.skipType(7&t)}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(e.AddressInfo||(e.AddressInfo={})),e.codec=()=>(null==t&&(t=uo((t,s,r={})=>{if(!1!==r.lengthDelimited&&s.fork(),null!=t.peerId&&t.peerId.byteLength>0&&(s.uint32(10),s.bytes(t.peerId)),null!=t.seq&&0n!==t.seq&&(s.uint32(16),s.uint64(t.seq)),null!=t.addresses)for(const r of t.addresses)s.uint32(26),e.AddressInfo.codec().encode(r,s);!1!==r.lengthDelimited&&s.ldelim()},(t,s,r={})=>{const n={peerId:c(0),seq:0n,addresses:[]},i=null==s?t.len:t.pos+s;for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:n.peerId=t.bytes();break;case 2:n.seq=t.uint64();break;case 3:if(null!=r.limits?.addresses&&n.addresses.length===r.limits.addresses)throw new po('Decode error - map field "addresses" had too many elements');n.addresses.push(e.AddressInfo.codec().decode(t,t.uint32(),{limits:r.limits?.addresses$}));break;default:t.skipType(7&s)}}return n})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}($l||($l={}));let ql=class e{static createFromProtobuf=t=>{const s=$l.decode(t),r=ka(Pe(s.peerId)),n=(s.addresses??[]).map(e=>Kc(e.multiaddr)),i=s.seq;return new e({peerId:r,multiaddrs:n,seqNumber:i})};static DOMAIN="libp2p-peer-record";static CODEC=zl;peerId;multiaddrs;seqNumber;domain=e.DOMAIN;codec=e.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:s,seqNumber:r}=e;this.peerId=t,this.multiaddrs=s??[],this.seqNumber=r??BigInt(Date.now())}marshal(){return null==this.marshaled&&(this.marshaled=$l.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(t){return t instanceof e&&(!!this.peerId.equals(t.peerId)&&(this.seqNumber===t.seqNumber&&!!function(e,t){const s=(e,t)=>e.toString().localeCompare(t.toString());return e.length===t.length&&(t.sort(s),e.sort(s).every((e,s)=>t[s].equals(e)))}(this.multiaddrs,t.multiaddrs)))}};function Wl(e){if(null!=e[Symbol.asyncIterator])return(async()=>{const t=[];for await(const s of e)t.push(s);return t})();const t=[];for(const s of e)t.push(s);return t}let Kl=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};function jl(){const e={};return e.promise=new Promise((t,s)=>{e.resolve=t,e.reject=s}),e}class Hl{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||e-1&e)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return void 0===this.buffer[this.btm]}}class Gl{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new Hl(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return null!=e?.byteLength?e.byteLength:1}push(e){if(null!=e?.value&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new Hl(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(void 0===e&&null!=this.tail.next){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return null!=e?.value&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let Ql=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function Xl(e={}){return function(e,t){t=t??{};let s,r,n,i=t.onEnd,o=new Gl,a=jl();const c=async()=>{try{return o.isEmpty()?n?{done:!0}:await new Promise((t,n)=>{r=i=>{r=null,o.push(i);try{t(e(o))}catch(e){n(e)}return s}}):e(o)}finally{o.isEmpty()&&queueMicrotask(()=>{a.resolve(),a=jl()})}},l=e=>null!=r?r(e):(o.push(e),s),h=e=>(o=new Gl,null!=r?r({error:e}):(o.push({error:e}),s)),u=e=>{if(n)return s;if(!0!==t?.objectMode&&null==e?.byteLength)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:e})},d=e=>n?s:(n=!0,null!=e?h(e):l({done:!0})),p=()=>(o=new Gl,d(),{done:!0}),f=e=>(d(e),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:c,return:p,throw:f,push:u,end:d,get readableLength(){return o.size},onEmpty:async e=>{const t=e?.signal;if(t?.throwIfAborted(),o.isEmpty())return;let s,r;null!=t&&(s=new Promise((e,s)=>{r=()=>{s(new Ql)},t.addEventListener("abort",r)}));try{await Promise.race([a.promise,s])}finally{null!=r&&null!=t&&t?.removeEventListener("abort",r)}}},null==i)return s;const g=s;return s={[Symbol.asyncIterator](){return this},next:()=>g.next(),throw:e=>(g.throw(e),null!=i&&(i(e),i=void 0),{done:!0}),return:()=>(g.return(),null!=i&&(i(),i=void 0),{done:!0}),push:u,end:e=>(g.end(e),null!=i&&(i(e),i=void 0),s),get readableLength(){return g.readableLength},onEmpty:e=>g.onEmpty(e)},s}(e=>{const t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}},e)}async function Yl(e,t,s,r){const n=new Kl(r?.errorMessage);null!=r?.errorCode&&(n.code=r.errorCode);const i=r?.errorEvent??"error";return!0===s?.aborted?Promise.reject(n):new Promise((o,a)=>{function c(){Zl(s,"abort",u),Zl(e,t,l),Zl(e,i,h)}const l=e=>{try{if(!1===r?.filter?.(e))return}catch(e){return c(),void a(e)}c(),o(e)},h=e=>{c(),e instanceof Error?a(e):a(e.detail??r?.error??new Error(`The "${r?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},u=()=>{c(),a(n)};Jl(s,"abort",u),Jl(e,t,l),Jl(e,i,h)})}function Jl(e,t,s){null!=e&&(eh(e)?e.addEventListener(t,s):e.addListener(t,s))}function Zl(e,t,s){null!=e&&(eh(e)?e.removeEventListener(t,s):e.removeListener(t,s))}function eh(e){return"function"==typeof e.addEventListener&&"function"==typeof e.removeEventListener}let th=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};function sh(e){return e.reason}let rh=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Kl)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};let nh=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=`${parseInt(String(1e9*Math.random()),10).toString()}${Date.now()}`,this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((e,t)=>e&&!0===t.signal?.aborted,!0)&&(this.controller.abort(new Kl),this.cleanup())}async join(e={}){const t=new rh(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await async function(e,t){if(null==t)return e;const s=sh;if(t.aborted)return e.catch(()=>{}),Promise.reject(s(t));let r;try{return await Promise.race([e,new Promise((e,n)=>{r=()=>{n(s(t))},t.addEventListener("abort",r)})])}finally{null!=r&&t.removeEventListener("abort",r)}}(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};function ih(e,t){let s;const r=function(){clearTimeout(s),s=setTimeout(function(){s=void 0,e()},t)};return r.start=()=>{},r.stop=()=>{clearTimeout(s)},r}let oh=class extends ns{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=ih(this.emitEmpty.bind(this),1),this.emitIdle=ih(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){0===this.size&&this.safeDispatchEvent("empty")}emitIdle(){0===this.running&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(0===this.size)return this.emitEmpty(),0===this.running&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if("queued"===t.status){e=t;break}return null!=e&&(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),null!=this.sort&&this.queue.sort(this.sort)}start(){!1===this.autoStart&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new th;const s=new nh(e,t);return this.enqueue(s),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),s.join(t).then(e=>(this.safeDispatchEvent("success",{detail:{job:s,result:e}}),e)).catch(e=>{if("queued"===s.status)for(let e=0;e<this.queue.length;e++)if(this.queue[e]===s){this.queue.splice(e,1);break}throw this.safeDispatchEvent("failure",{detail:{job:s,error:e}}),e})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Kl)}),this.clear()}async onEmpty(e){0!==this.size&&await Yl(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Yl(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){0===this.pending&&0===this.size||await Yl(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=Xl({objectMode:!0}),s=e=>{null!=e?this.abort():this.clear(),t.end(e)},r=e=>{null!=e.detail&&t.push(e.detail.result)},n=e=>{s(e.detail.error)},i=()=>{s()},o=()=>{s(new Kl("Queue aborted"))};this.addEventListener("success",r),this.addEventListener("failure",n),this.addEventListener("idle",i),e?.signal?.addEventListener("abort",o);try{yield*t}finally{this.removeEventListener("success",r),this.removeEventListener("failure",n),this.removeEventListener("idle",i),e?.signal?.removeEventListener("abort",o),s()}}};const ah="lock:worker:request-read",ch="lock:worker:abort-read-request",lh="lock:worker:release-read",hh="lock:master:grant-read",uh="lock:master:error-read",dh="lock:worker:request-write",ph="lock:worker:abort-write-request",fh="lock:worker:release-write",gh="lock:master:grant-write",mh="lock:master:error-write",yh="lock:worker:finalize",bh="mortice",wh={singleProcess:!1},vh=(e,t,s,r,n,i,o,a,c)=>l=>{if(null==l.data)return;const h={type:l.data.type,name:l.data.name,identifier:l.data.identifier};h.type===n&&e.safeDispatchEvent(s,{detail:{name:h.name,identifier:h.identifier,handler:async()=>{t.postMessage({type:c,name:h.name,identifier:h.identifier}),await new Promise(e=>{const s=r=>{if(null==r?.data)return;const n=r.data.type,i=(r.data.name,r.data.identifier);n===a&&i===h.identifier&&(t.removeEventListener("message",s),e())};t.addEventListener("message",s)})},onError:e=>{t.postMessage({type:o,name:h.name,identifier:h.identifier,error:{message:e.message,name:e.name,stack:e.stack}})}}}),h.type===i&&e.safeDispatchEvent(r,{detail:{name:h.name,identifier:h.identifier}}),h.type===yh&&e.safeDispatchEvent("finalizeRequest",{detail:{name:h.name}})};class Sh{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(bh)}readLock(e){return this.sendRequest(ah,ch,hh,uh,lh,e)}writeLock(e){return this.sendRequest(dh,ph,gh,mh,fh,e)}finalize(){this.channel.postMessage({type:yh,name:this.name}),this.channel.close()}async sendRequest(e,t,s,r,n,i){i?.signal?.throwIfAborted();const o=((e=10)=>Math.random().toString().substring(2,e+2))();return this.channel.postMessage({type:e,identifier:o,name:this.name}),new Promise((e,a)=>{const c=()=>{this.channel.postMessage({type:t,identifier:o,name:this.name})};i?.signal?.addEventListener("abort",c,{once:!0});const l=t=>{if(t.data?.identifier===o&&(t.data?.type===s&&(this.channel.removeEventListener("message",l),i?.signal?.removeEventListener("abort",c),e(()=>{this.channel.postMessage({type:n,identifier:o,name:this.name})})),t.data.type===r)){this.channel.removeEventListener("message",l),i?.signal?.removeEventListener("abort",c);const e=new Error;null!=t.data.error&&(e.message=t.data.error.message,e.name=t.data.error.name,e.stack=t.data.error.stack),a(e)}};this.channel.addEventListener("message",l)})}}const Eh=new Map;let Dh;function _h(e){return"function"==typeof e?.readLock&&"function"==typeof e?.writeLock}function Th(e){if(null==Dh&&(Dh=(e=>{if(e=Object.assign({},wh,e),Boolean(globalThis.document)||e.singleProcess){const e=new BroadcastChannel(bh),t=new ns;return e.addEventListener("message",vh(t,e,"requestReadLock","abortReadLockRequest",ah,ch,uh,lh,hh)),e.addEventListener("message",vh(t,e,"requestWriteLock","abortWriteLockRequest",dh,ph,mh,fh,gh)),t}return new Sh(e.name)})(e),!_h(Dh))){const e=Dh;e.addEventListener("requestReadLock",t=>{const s=t.detail.name,r=t.detail.identifier,n=Eh.get(s);if(null==n)return;const i=new AbortController,o=e=>{e.detail.name===s&&e.detail.identifier===r&&i.abort()};e.addEventListener("abortReadLockRequest",o),n.readLock({signal:i.signal}).then(async e=>{await t.detail.handler().finally(()=>{e()})}).catch(e=>{t.detail.onError(e)}).finally(()=>{e.removeEventListener("abortReadLockRequest",o)})}),e.addEventListener("requestWriteLock",t=>{const s=t.detail.name,r=t.detail.identifier,n=Eh.get(s);if(null==n)return;const i=new AbortController,o=e=>{e.detail.name===s&&e.detail.identifier===r&&i.abort()};e.addEventListener("abortWriteLockRequest",o),n.writeLock({signal:i.signal}).then(async e=>{await t.detail.handler().finally(()=>{e()})}).catch(e=>{t.detail.onError(e)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",o)})}),e.addEventListener("finalizeRequest",e=>{const t=e.detail.name,s=Eh.get(t);null!=s&&s.finalize()})}return Dh}async function Ih(e,t){let s,r;const n=new Promise((e,t)=>{s=e,r=t}),i=()=>{r(new Kl)};return t?.signal?.addEventListener("abort",i,{once:!0}),e.add(async()=>{await new Promise(e=>{s(()=>{t?.signal?.removeEventListener("abort",i),e()})})},{signal:t?.signal}).catch(e=>{r(e)}),n}const Ch={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function Ph(e){const t=Object.assign({},Ch,e);return((e,t)=>{let s=Eh.get(e);if(null!=s)return s;const r=Th(t);if(_h(r))return s=r,Eh.set(e,s),s;const n=new oh({concurrency:1});let i;return s={async readLock(e){if(null!=i)return Ih(i,e);i=new oh({concurrency:t.concurrency,autoStart:!1});const s=i,r=Ih(i,e);return n.add(async()=>{s.start(),await s.onIdle().then(()=>{i===s&&(i=null)})}),r},writeLock:async e=>(i=null,Ih(n,e)),finalize:()=>{Eh.delete(e)},queue:n},Eh.set(e,s),!0===t.autoFinalize&&n.addEventListener("idle",()=>{s.finalize()},{once:!0}),s})(t.name,t)}var xh,Ah,kh;function Nh(e,t){if(null!=e.publicKey||null==t.publicKey)return e;let s;"RSA"===e.type&&(s=e.toMultihash());return Aa(Ko(t.publicKey,s))}function Rh(e,t,s){const r=new Map,n=BigInt(Date.now());for(const[e,s]of t.tags.entries())null!=s.expiry&&s.expiry<n||r.set(e,s);return{...t,id:Nh(e,t),addresses:t.addresses.filter(({observed:e})=>null!=e&&e>Date.now()-s).map(({multiaddr:e,isCertified:t})=>({multiaddr:Kc(e),isCertified:t??!1})),metadata:t.metadata,peerRecordEnvelope:t.peerRecordEnvelope??void 0,tags:r}}function Mh(e,t){return u=e.addresses,d=t.addresses,Oh(u,d,(e,t)=>e.isCertified===t.isCertified&&!!a(e.multiaddr,t.multiaddr))&&(l=e.protocols,h=t.protocols,Oh(l,h,(e,t)=>e===t))&&(o=e.publicKey,c=t.publicKey,Lh(o,c))&&(n=e.peerRecordEnvelope,i=t.peerRecordEnvelope,Lh(n,i))&&(s=e.metadata,r=t.metadata,Bh(s,r,(e,t)=>a(e,t)))&&function(e,t){return Bh(e,t,(e,t)=>e.value===t.value&&e.expiry===t.expiry)}(e.tags,t.tags);var s,r,n,i,o,c,l,h,u,d}function Lh(e,t){return null==e&&null==t||null!=e&&null!=t&&a(e,t)}function Oh(e,t,s){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!s(e[r],t[r]))return!1;return!0}function Bh(e,t,s){if(e.size!==t.size)return!1;for(const[r,n]of e.entries()){const e=t.get(r);if(null==e)return!1;if(!s(n,e))return!1}return!0}!function(e){let t;!function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&e.value.byteLength>0&&(t.uint32(18),t.bytes(e.value)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={key:"",value:c(0)},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.key=e.string();break;case 2:r.value=e.bytes();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(e.Peer$metadataEntry||(e.Peer$metadataEntry={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&(t.uint32(18),kh.codec().encode(e.value,t)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={key:""},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.key=e.string();break;case 2:r.value=kh.codec().decode(e,e.uint32(),{limits:s.limits?.value});break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(e.Peer$tagsEntry||(e.Peer$tagsEntry={})),e.codec=()=>(null==t&&(t=uo((t,s,r={})=>{if(!1!==r.lengthDelimited&&s.fork(),null!=t.addresses)for(const e of t.addresses)s.uint32(10),Ah.codec().encode(e,s);if(null!=t.protocols)for(const e of t.protocols)s.uint32(18),s.string(e);if(null!=t.publicKey&&(s.uint32(34),s.bytes(t.publicKey)),null!=t.peerRecordEnvelope&&(s.uint32(42),s.bytes(t.peerRecordEnvelope)),null!=t.metadata&&0!==t.metadata.size)for(const[r,n]of t.metadata.entries())s.uint32(50),e.Peer$metadataEntry.codec().encode({key:r,value:n},s);if(null!=t.tags&&0!==t.tags.size)for(const[r,n]of t.tags.entries())s.uint32(58),e.Peer$tagsEntry.codec().encode({key:r,value:n},s);null!=t.updated&&(s.uint32(64),s.uint64Number(t.updated)),!1!==r.lengthDelimited&&s.ldelim()},(t,s,r={})=>{const n={addresses:[],protocols:[],metadata:new Map,tags:new Map},i=null==s?t.len:t.pos+s;for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(null!=r.limits?.addresses&&n.addresses.length===r.limits.addresses)throw new po('Decode error - map field "addresses" had too many elements');n.addresses.push(Ah.codec().decode(t,t.uint32(),{limits:r.limits?.addresses$}));break;case 2:if(null!=r.limits?.protocols&&n.protocols.length===r.limits.protocols)throw new po('Decode error - map field "protocols" had too many elements');n.protocols.push(t.string());break;case 4:n.publicKey=t.bytes();break;case 5:n.peerRecordEnvelope=t.bytes();break;case 6:{if(null!=r.limits?.metadata&&n.metadata.size===r.limits.metadata)throw new fo('Decode error - map field "metadata" had too many elements');const s=e.Peer$metadataEntry.codec().decode(t,t.uint32());n.metadata.set(s.key,s.value);break}case 7:{if(null!=r.limits?.tags&&n.tags.size===r.limits.tags)throw new fo('Decode error - map field "tags" had too many elements');const s=e.Peer$tagsEntry.codec().decode(t,t.uint32(),{limits:{value:r.limits?.tags$value}});n.tags.set(s.key,s.value);break}case 8:n.updated=t.uint64Number();break;default:t.skipType(7&s)}}return n})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(xh||(xh={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),null!=e.isCertified&&(t.uint32(16),t.bool(e.isCertified)),null!=e.observed&&(t.uint32(24),t.uint64Number(e.observed)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={multiaddr:c(0)},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.multiaddr=e.bytes();break;case 2:r.isCertified=e.bool();break;case 3:r.observed=e.uint64Number();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(Ah||(Ah={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.value&&0!==e.value&&(t.uint32(8),t.uint32(e.value)),null!=e.expiry&&(t.uint32(16),t.uint64(e.expiry)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={value:0},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.value=e.uint32();break;case 2:r.expiry=e.uint64();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(kh||(kh={}));const Uh="/",Vh=(new TextEncoder).encode(Uh),Fh=Vh[0];let zh=class e{_buf;constructor(e,t){if("string"==typeof e)this._buf=Ge(e);else{if(!(e instanceof Uint8Array))throw new Error("Invalid key, should be String of Uint8Array");this._buf=e}if(null==t&&(t=!0),t&&this.clean(),0===this._buf.byteLength||this._buf[0]!==Fh)throw new Error("Invalid key")}toString(e="utf8"){return Qe(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(t){return new e(t.join(Uh))}static random(){return new e(Math.random().toString().substring(2))}static asKey(t){return t instanceof Uint8Array||"string"==typeof t?new e(t):"function"==typeof t.uint8Array?new e(t.uint8Array()):null}clean(){if(null!=this._buf&&0!==this._buf.byteLength||(this._buf=Vh),this._buf[0]!==Fh){const e=new Uint8Array(this._buf.byteLength+1);e.fill(Fh,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Fh;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),s=e.list();for(let e=0;e<t.length;e++){if(s.length<e+1)return!1;const r=t[e],n=s[e];if(r<n)return!0;if(r>n)return!1}return t.length<s.length}reverse(){return e.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Uh).slice(1)}type(){return function(e){const t=e.split(":");if(t.length<2)return"";return t.slice(0,-1).join(":")}(this.baseNamespace())}name(){return function(e){const t=e.split(":");return t[t.length-1]}(this.baseNamespace())}instance(t){return new e(this.toString()+":"+t)}path(){let t=this.parent().toString();return t.endsWith(Uh)||(t+=Uh),t+=this.type(),new e(t)}parent(){const t=this.list();return 1===t.length?new e(Uh):new e(t.slice(0,-1).join(Uh))}child(t){return this.toString()===Uh?t:t.toString()===Uh?this:new e(this.toString()+t.toString(),!1)}isAncestorOf(e){return e.toString()!==this.toString()&&e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()!==this.toString()&&this.toString().startsWith(e.toString())}isTopLevel(){return 1===this.list().length}concat(...t){return e.withNamespaces([...this.namespaces(),...(s=t.map(e=>e.namespaces()),[].concat(...s))]);var s}};const $h="/peers/";function qh(e){if(!Jo(e)||null==e.type)throw new ra("Invalid PeerId");const t=e.toCID().toString();return new zh(`${$h}${t}`)}async function Wh(e,t,s,r,n){const i=new Map;for(const r of s){if(null==r)continue;if(r.multiaddr instanceof Uint8Array&&(r.multiaddr=Kc(r.multiaddr)),!Wc(r.multiaddr))throw new ra("Multiaddr was invalid");if(!await t(e,r.multiaddr,n))continue;const s=r.isCertified??!1,o=r.multiaddr.toString(),a=i.get(o);null!=a?r.isCertified=a.isCertified||s:i.set(o,{multiaddr:r.multiaddr,isCertified:s})}return[...i.values()].sort((e,t)=>e.multiaddr.toString().localeCompare(t.multiaddr.toString())).map(({isCertified:t,multiaddr:s})=>{const r=s.getPeerId();return e.equals(r)&&(s=s.decapsulate(Kc(`/p2p/${e}`))),{isCertified:t,multiaddr:s.bytes}})}async function Kh(e,t,s,r){if(null==t)throw new ra("Invalid PeerData");if(null!=t.publicKey&&null!=e.publicKey&&!t.publicKey.equals(e.publicKey))throw new ra("publicKey bytes do not match peer id publicKey bytes");const n=r.existingPeer?.peer;if(null!=n&&!e.equals(n.id))throw new ra("peer id did not match existing peer id");let i,o=n?.addresses??[],c=new Set(n?.protocols??[]),l=n?.metadata??new Map,h=n?.tags??new Map,u=n?.peerRecordEnvelope;if("patch"===s){if(null==t.multiaddrs&&null==t.addresses||(o=[],null!=t.multiaddrs&&o.push(...t.multiaddrs.map(e=>({isCertified:!1,multiaddr:e}))),null!=t.addresses&&o.push(...t.addresses)),null!=t.protocols&&(c=new Set(t.protocols)),null!=t.metadata){l=jh(t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata),{validate:Hh})}if(null!=t.tags){h=jh(t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),{validate:Gh,map:Qh})}null!=t.peerRecordEnvelope&&(u=t.peerRecordEnvelope)}if("merge"===s){if(null!=t.multiaddrs&&o.push(...t.multiaddrs.map(e=>({isCertified:!1,multiaddr:e}))),null!=t.addresses&&o.push(...t.addresses),null!=t.protocols&&(c=new Set([...c,...t.protocols])),null!=t.metadata){const e=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);for(const[t,s]of e)null==s?l.delete(t):l.set(t,s);l=jh([...l.entries()],{validate:Hh})}if(null!=t.tags){const e=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),s=new Map(h);for(const[t,r]of e)null==r?s.delete(t):s.set(t,r);h=jh([...s.entries()],{validate:Gh,map:Qh})}null!=t.peerRecordEnvelope&&(u=t.peerRecordEnvelope)}null!=n?.id.publicKey?i=Ho(n.id.publicKey):null!=t.publicKey?i=Ho(t.publicKey):null!=e.publicKey&&(i=Ho(e.publicKey));const d={addresses:await Wh(e,r.addressFilter??(async()=>!0),o,r.existingPeer?.peerPB.addresses,r),protocols:[...c.values()].sort((e,t)=>e.localeCompare(t)),metadata:l,tags:h,publicKey:i,peerRecordEnvelope:u};return d.addresses.forEach(e=>{e.observed=r.existingPeer?.peerPB.addresses?.find(e=>a(e.multiaddr,e.multiaddr))?.observed??Date.now()}),"RSA"!==e.type&&delete d.publicKey,d}function jh(e,t){const s=new Map;for(const[s,r]of e)null!=r&&t.validate(s,r);for(const[r,n]of e.sort(([e],[t])=>e.localeCompare(t)))null!=n&&s.set(r,t.map?.(r,n)??n);return s}function Hh(e,t){if("string"!=typeof e)throw new ra("Metadata key must be a string");if(!(t instanceof Uint8Array))throw new ra("Metadata value must be a Uint8Array")}function Gh(e,t){if("string"!=typeof e)throw new ra("Tag name must be a string");if(null!=t.value){if(parseInt(`${t.value}`,10)!==t.value)throw new ra("Tag value must be an integer");if(t.value<0||t.value>100)throw new ra("Tag value must be between 0-100")}if(null!=t.ttl){if(parseInt(`${t.ttl}`,10)!==t.ttl)throw new ra("Tag ttl must be an integer");if(t.ttl<0)throw new ra("Tag ttl must be between greater than 0")}}function Qh(e,t){let s;null!=t.expiry&&(s=t.expiry),null!=t.ttl&&(s=BigInt(Date.now()+Number(t.ttl)));const r={value:t.value??0};return null!=s&&(r.expiry=s),r}function Xh(e){const t=e.toString().split("/")[2];return Na(Ue.parse(t,L))}function Yh(e,t,s){return function(e,t,s){return Rh(e,xh.decode(t),s)}(Xh(e),t,s)}class Jh{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=function(e){const{name:t,metrics:s}=e;let r;return r=null!=s?new Ol({name:t,metrics:s}):new Sl,r}({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??36e5,this.maxPeerAge=t.maxPeerAge??216e5}getLock(e){let t=this.locks.get(e);return null==t&&(t={refs:0,lock:Ph({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,0===t.refs&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){const s=this.getLock(e);try{const r=await s.lock.readLock(t);return()=>{r(),this.maybeRemoveLock(e,s)}}catch(t){throw this.maybeRemoveLock(e,s),t}}async getWriteLock(e,t){const s=this.getLock(e);try{const r=await s.lock.writeLock(t);return()=>{r(),this.maybeRemoveLock(e,s)}}catch(t){throw this.maybeRemoveLock(e,s),t}}async has(e,t){try{return await this.load(e,t),!0}catch(e){if("NotFoundError"!==e.name)throw e}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(qh(e),t)}async load(e,t){const s=qh(e),r=await this.datastore.get(s,t),n=xh.decode(r);if(this.#U(e,n))throw await this.datastore.delete(s,t),new oa;return Rh(e,n,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,s){const r=await this.#V(e,s),n=await Kh(e,t,"patch",{...s,addressFilter:this.addressFilter});return this.#F(e,n,r)}async patch(e,t,s){const r=await this.#V(e,s),n=await Kh(e,t,"patch",{...s,addressFilter:this.addressFilter,existingPeer:r});return this.#F(e,n,r)}async merge(e,t,s){const r=await this.#V(e,s),n=await Kh(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:r});return this.#F(e,n,r)}async*all(e){for await(const{key:t,value:s}of this.datastore.query(function(e,t){return{prefix:$h,filters:(e.filters??[]).map(e=>({key:s,value:r})=>e(Yh(s,r,t))),orders:(e.orders??[]).map(e=>(s,r)=>e(Yh(s.key,s.value,t),Yh(r.key,r.value,t)))}}(e??{},this.maxAddressAge),e)){const r=Xh(t);if(r.equals(this.peerId))continue;const n=xh.decode(s);this.#U(r,n)?await this.datastore.delete(t,e):yield Rh(r,n,this.peerId.equals(r)?1/0:this.maxAddressAge)}}async#V(e,t){try{const s=qh(e),r=await this.datastore.get(s,t),n=xh.decode(r);if(this.#U(e,n))throw await this.datastore.delete(s,t),new oa;return{peerPB:n,peer:Rh(e,n,this.maxAddressAge)}}catch(e){"NotFoundError"!==e.name&&this.log.error("invalid peer data found in peer store - %e",e)}}async#F(e,t,s,r){t.updated=Date.now();const n=xh.encode(t);return await this.datastore.put(qh(e),n,r),{peer:Rh(e,t,this.maxAddressAge),previous:s?.peer,updated:null==s||!Mh(t,s.peerPB)}}#U(e,t){if(null==t.updated)return!0;if(this.peerId.equals(e))return!1;const s=t.updated<Date.now()-this.maxPeerAge,r=Date.now()-this.maxAddressAge,n=t.addresses.filter(e=>null!=e.observed&&e.observed>r);return s&&0===n.length}}class Zh{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new Jh(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(const s of this.store.all(t))e(s)}async all(e){return Wl(this.store.all(e))}async delete(e,t){const s=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{s()}}async has(e,t){const s=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),s?.()}}async get(e,t){const s=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{s?.()}}async getInfo(e,t){const s=await this.get(e,t);return{id:s.id,multiaddrs:s.addresses.map(({multiaddr:e})=>e)}}async save(e,t,s){const r=await this.store.getWriteLock(e,s);try{const r=await this.store.save(e,t,s);return this.#z(e,r),r.peer}finally{r?.()}}async patch(e,t,s){const r=await this.store.getWriteLock(e,s);try{const r=await this.store.patch(e,t,s);return this.#z(e,r),r.peer}finally{r?.()}}async merge(e,t,s){const r=await this.store.getWriteLock(e,s);try{const r=await this.store.merge(e,t,s);return this.#z(e,r),r.peer}finally{r?.()}}async consumePeerRecord(e,t,s){const r=Jo(t)?t:Jo(t?.expectedPeer)?t.expectedPeer:void 0,n=Jo(t)||void 0===t?s:t,i=await Vl.openAndCertify(e,ql.DOMAIN,n),o=Na(i.publicKey.toCID());if(!1===r?.equals(o))return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",r,o),!1;const a=ql.createFromProtobuf(i.payload);let c;try{c=await this.get(o,n)}catch(e){if("NotFoundError"!==e.name)throw e}if(null!=c?.peerRecordEnvelope){const e=Vl.createFromProtobuf(c.peerRecordEnvelope),t=ql.createFromProtobuf(e.payload);if(t.seqNumber>=a.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",t.seqNumber,a.seqNumber),!1}return await this.patch(a.peerId,{peerRecordEnvelope:e,addresses:a.multiaddrs.map(e=>({isCertified:!0,multiaddr:e}))},n),!0}#z(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}}let eu=class e extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=e.name;code=e.code;constructor(e="Not Found"){super(e)}};function tu(e){if(null!=e[Symbol.asyncIterator])return(async()=>{for await(const t of e);})();for(const t of e);}function su(e){const[t,s]=null!=e[Symbol.asyncIterator]?[e[Symbol.asyncIterator](),Symbol.asyncIterator]:[e[Symbol.iterator](),Symbol.iterator],r=[];return{peek:()=>t.next(),push:e=>{r.push(e)},next:()=>r.length>0?{done:!1,value:r.shift()}:t.next(),[s](){return this}}}function ru(e,t){let s=0;if(null!=e[Symbol.asyncIterator])return async function*(){for await(const r of e)await t(r,s++)&&(yield r)}();const r=su(e),{value:n,done:i}=r.next();if(!0===i)return function*(){}();const o=t(n,s++);if("function"==typeof o.then)return async function*(){await o&&(yield n);for(const e of r)await t(e,s++)&&(yield e)}();const a=t;return function*(){!0===o&&(yield n);for(const e of r)a(e,s++)&&(yield e)}()}function nu(e,t){return null!=e[Symbol.asyncIterator]?async function*(){const s=await Wl(e);yield*s.sort(t)}():function*(){const s=Wl(e);yield*s.sort(t)}()}function iu(e,t){return null!=e[Symbol.asyncIterator]?async function*(){let s=0;if(!(t<1))for await(const r of e)if(yield r,s++,s===t)return}():function*(){let s=0;if(!(t<1))for(const r of e)if(yield r,s++,s===t)return}()}class ou{put(e,t,s){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:s,value:r}of e)await this.put(s,r,t),yield s}async*getMany(e,t={}){for await(const s of e)yield{key:s,value:await this.get(s,t)}}async*deleteMany(e,t={}){for await(const s of e)await this.delete(s,t),yield s}batch(){let e=[],t=[];return{put(t,s){e.push({key:t,value:s})},delete(e){t.push(e)},commit:async s=>{await tu(this.putMany(e,s)),e=[],await tu(this.deleteMany(t,s)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let s=this._all(e,t);if(null!=e.prefix){const t=e.prefix;s=ru(s,e=>e.key.toString().startsWith(t))}if(Array.isArray(e.filters)&&(s=e.filters.reduce((e,t)=>ru(e,t),s)),Array.isArray(e.orders)&&(s=e.orders.reduce((e,t)=>nu(e,t),s)),null!=e.offset){let t=0;const r=e.offset;s=ru(s,()=>t++>=r)}return null!=e.limit&&(s=iu(s,e.limit)),s}queryKeys(e,t){let s=this._allKeys(e,t);if(null!=e.prefix){const t=e.prefix;s=ru(s,e=>e.toString().startsWith(t))}if(Array.isArray(e.filters)&&(s=e.filters.reduce((e,t)=>ru(e,t),s)),Array.isArray(e.orders)&&(s=e.orders.reduce((e,t)=>nu(e,t),s)),null!=e.offset){const t=e.offset;let r=0;s=ru(s,()=>r++>=t)}return null!=e.limit&&(s=iu(s,e.limit)),s}}class au extends ou{data;constructor(){super(),this.data=new Map}put(e,t,s){return s?.signal?.throwIfAborted(),this.data.set(e.toString(),t),e}get(e,t){t?.signal?.throwIfAborted();const s=this.data.get(e.toString());if(null==s)throw new eu;return s}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(e.toString())}delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(e.toString())}*_all(e,t){t?.signal?.throwIfAborted();for(const[e,s]of this.data.entries())yield{key:new zh(e),value:s},t?.signal?.throwIfAborted()}*_allKeys(e,t){t?.signal?.throwIfAborted();for(const e of this.data.keys())yield new zh(e),t?.signal?.throwIfAborted()}}function cu(e,t){let s;const r=function(){clearTimeout(s),s=setTimeout(function(){s=void 0,e()},t)};return r.start=()=>{},r.stop=()=>{clearTimeout(s)},r}var lu;(function(){var e,t,s,r,n,i,o,a;a=function(e){return[(e&255<<24)>>>24,(e&255<<16)>>>16,(65280&e)>>>8,255&e].join(".")},o=function(e){var s,r,n,i,o,a;for(s=[],n=i=0;i<=3&&0!==e.length;n=++i){if(n>0){if("."!==e[0])throw new Error("Invalid IP");e=e.substring(1)}o=(a=t(e))[0],r=a[1],e=e.substring(r),s.push(o)}if(0!==e.length)throw new Error("Invalid IP");switch(s.length){case 1:if(s[0]>4294967295)throw new Error("Invalid IP");return s[0]>>>0;case 2:if(s[0]>255||s[1]>16777215)throw new Error("Invalid IP");return(s[0]<<24|s[1])>>>0;case 3:if(s[0]>255||s[1]>255||s[2]>65535)throw new Error("Invalid IP");return(s[0]<<24|s[1]<<16|s[2])>>>0;case 4:if(s[0]>255||s[1]>255||s[2]>255||s[3]>255)throw new Error("Invalid IP");return(s[0]<<24|s[1]<<16|s[2]<<8|s[3])>>>0;default:throw new Error("Invalid IP")}},r=(s=function(e){return e.charCodeAt(0)})("0"),i=s("a"),n=s("A"),t=function(e){var t,o,a,c,l;for(c=0,t=10,o="9",a=0,e.length>1&&"0"===e[a]&&("x"===e[a+1]||"X"===e[a+1]?(a+=2,t=16):"0"<=e[a+1]&&e[a+1]<="9"&&(a++,t=8,o="7")),l=a;a<e.length;){if("0"<=e[a]&&e[a]<=o)c=c*t+(s(e[a])-r)>>>0;else{if(16!==t)break;if("a"<=e[a]&&e[a]<="f")c=c*t+(10+s(e[a])-i)>>>0;else{if(!("A"<=e[a]&&e[a]<="F"))break;c=c*t+(10+s(e[a])-n)>>>0}}if(c>4294967295)throw new Error("too large");a++}if(a===l)throw new Error("empty octet");return[c,a]},e=function(){function e(e,t){var s,r,n;if("string"!=typeof e)throw new Error("Missing `net' parameter");if(t||(n=e.split("/",2),e=n[0],t=n[1]),t||(t=32),"string"==typeof t&&t.indexOf(".")>-1){try{this.maskLong=o(t)}catch(e){throw new Error("Invalid mask: "+t)}for(s=r=32;r>=0;s=--r)if(this.maskLong===4294967295<<32-s>>>0){this.bitmask=s;break}}else{if(!t&&0!==t)throw new Error("Invalid mask: empty");this.bitmask=parseInt(t,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0)}try{this.netLong=(o(e)&this.maskLong)>>>0}catch(t){throw new Error("Invalid net address: "+e)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+t);this.size=Math.pow(2,32-this.bitmask),this.base=a(this.netLong),this.mask=a(this.maskLong),this.hostmask=a(~this.maskLong),this.first=this.bitmask<=30?a(this.netLong+1):this.base,this.last=this.bitmask<=30?a(this.netLong+this.size-2):a(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?a(this.netLong+this.size-1):void 0}return e.prototype.contains=function(t){return"string"==typeof t&&(t.indexOf("/")>0||4!==t.split(".").length)&&(t=new e(t)),t instanceof e?this.contains(t.base)&&this.contains(t.broadcast||t.last):(o(t)&this.maskLong)>>>0==(this.netLong&this.maskLong)>>>0},e.prototype.next=function(t){return null==t&&(t=1),new e(a(this.netLong+this.size*t),this.mask)},e.prototype.forEach=function(e){var t,s,r;for(r=o(this.first),s=o(this.last),t=0;r<=s;)e(a(r),r,t),t++,r++},e.prototype.toString=function(){return this.base+"/"+this.bitmask},e}(),lu=e}).call(e);const hu=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"].map(e=>new lu(e));function uu(e){for(const t of hu)if(t.contains(e))return!0;return!1}function du(e){return gc(e)?uu(e):/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(e)?function(e){const t=e.split(":");if(t.length<2)return!1;const s=t[t.length-1].padStart(4,"0"),r=t[t.length-2].padStart(4,"0");return uu(`${parseInt(r.substring(0,2),16)}.${parseInt(r.substring(2),16)}.${parseInt(s.substring(0,2),16)}.${parseInt(s.substring(2),16)}`)}(e):function(e){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)}(e)?function(e){const t=e.split(":");return uu(t[t.length-1])}(e):mc(e)?function(e){return/^::$/.test(e)||/^::1$/.test(e)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(e)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(e)||/^ff([0-9a-fA-F]{2,2}):/i.test(e)}(e):void 0}const pu=e=>({match:t=>!(t.length<1)&&(!!e(t[0])&&t.slice(1)),pattern:"fn"}),fu=e=>({match:t=>pu(t=>t===e).match(t),pattern:e}),gu=()=>({match:e=>pu(e=>"string"==typeof e).match(e),pattern:"{string}"}),mu=()=>({match:e=>pu(e=>!isNaN(parseInt(e))).match(e),pattern:"{number}"}),yu=()=>({match:e=>{if(e.length<2)return!1;if("p2p"!==e[0]&&"ipfs"!==e[0])return!1;if(!e[1].startsWith("Q")&&!e[1].startsWith("1"))return!1;try{G.decode(`z${e[1]}`)}catch(e){return!1}return e.slice(2)},pattern:"/p2p/{peerid}"}),bu=()=>({match:e=>{if(e.length<2)return!1;if("certhash"!==e[0])return!1;try{Z.decode(e[1])}catch{return!1}return e.slice(2)},pattern:"/certhash/{certhash}"}),wu=e=>({match:t=>{const s=e.match(t);return!1===s?t:s},pattern:`optional(${e.pattern})`}),vu=(...e)=>({match:t=>{let s;for(const r of e){const e=r.match(t);!1!==e&&((null==s||e.length<s.length)&&(s=e))}return null!=s&&s},pattern:`or(${e.map(e=>e.pattern).join(", ")})`}),Su=(...e)=>({match:t=>{for(const s of e){const e=s.match(t);if(!1===e)return!1;t=e}return t},pattern:`and(${e.map(e=>e.pattern).join(", ")})`});function Eu(...e){function t(t){let s=(e=>e.toString().split("/").slice(1))(t);for(const t of e){const e=t.match(s);if(!1===e)return!1;s=e}return s}return{matchers:e,matches:function(e){return!1!==t(e)},exactMatch:function(e){const s=t(e);return!1!==s&&0===s.length}}}const Du=Eu(yu()),_u=Su(fu("dns4"),gu()),Tu=Su(fu("dns6"),gu()),Iu=Su(fu("dnsaddr"),gu()),Cu=Su(fu("dns"),gu());Eu(_u,wu(yu())),Eu(Tu,wu(yu())),Eu(Iu,wu(yu())),Eu(vu(Cu,Iu,_u,Tu),wu(yu()));const Pu=Su(fu("ip4"),pu(gc)),xu=Su(fu("ip6"),pu(mc)),Au=vu(Pu,xu),ku=vu(Au,Cu,_u,Tu,Iu);Eu(vu(Au,Su(vu(Cu,Iu,_u,Tu),wu(yu()))));const Nu=Eu(Pu),Ru=Eu(xu);Eu(Au);const Mu=Su(ku,fu("tcp"),mu()),Lu=Su(ku,fu("udp"),mu()),Ou=Eu(Su(Mu,wu(yu())));Eu(Lu);const Bu=Su(Lu,fu("quic"),wu(yu())),Uu=Su(Lu,fu("quic-v1"),wu(yu())),Vu=vu(Bu,Uu);Eu(Bu);const Fu=Eu(Uu),zu=vu(ku,Mu,Lu,Bu,Uu),$u=vu(Su(zu,fu("ws"),wu(yu()))),qu=Eu($u),Wu=vu(Su(zu,fu("wss"),wu(yu())),Su(zu,fu("tls"),wu(Su(fu("sni"),gu())),fu("ws"),wu(yu()))),Ku=Eu(Wu),ju=Su(Lu,fu("webrtc-direct"),wu(bu()),wu(bu()),wu(yu())),Hu=Eu(ju),Gu=Su(Uu,fu("webtransport"),wu(bu()),wu(bu()),wu(yu())),Qu=Eu(Gu),Xu=vu($u,Wu,Su(Mu,wu(yu())),Su(Vu,wu(yu())),Su(ku,wu(yu())),ju,Gu,yu());Eu(Xu);const Yu=Eu(Su(Xu,fu("p2p-circuit"),yu())),Ju=Eu(vu(Su(Xu,fu("p2p-circuit"),fu("webrtc"),wu(yu())),Su(Xu,fu("webrtc"),wu(yu())),Su(fu("webrtc"),wu(yu()))));Eu(vu(Su(ku,fu("tcp"),mu(),fu("http"),wu(yu())),Su(ku,fu("http"),wu(yu()))));Eu(vu(Su(ku,fu("tcp"),vu(Su(fu("443"),fu("http")),Su(mu(),fu("https")),Su(mu(),fu("tls"),fu("http"))),wu(yu())),Su(ku,fu("tls"),fu("http"),wu(yu())),Su(ku,fu("https"),wu(yu()))));Eu(vu(Su(fu("memory"),gu(),wu(yu()))));Eu(vu(Su(fu("unix"),gu(),wu(yu()))));class Zu extends Map{metric;constructor(e){super();const{name:t,metrics:s}=e;this.metric=s.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function ed(e){const{name:t,metrics:s}=e;let r;return r=null!=s?new Zu({name:t,metrics:s}):new Map,r}const td=864e13;class sd{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=ed({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){const t=this.findHost(e);for(const e of this.mappings.values())if(e.domain===t)return!0;return!1}add(e,t){t.forEach(t=>{this.log("add DNS mapping %s to %s",t,e);const s=!0===du(t);this.mappings.set(t,{domain:e,verified:s,expires:s?td-Date.now():0,lastVerified:s?td-Date.now():void 0})})}remove(e){const t=this.findHost(e);let s=!1;for(const[e,r]of this.mappings.entries())r.domain===t&&(this.log("removing %s to %s DNS mapping %e",e,r.domain,new Error("where")),this.mappings.delete(e),s=s||r.verified);return s}getAll(e){const t=[];for(let s=0;s<e.length;s++){const r=e[s].multiaddr.stringTuples(),n=r[0][1];if(null!=n)for(const[i,o]of this.mappings.entries()){if(n!==i)continue;this.maybeAddSNITuple(r,o.domain)&&(e.splice(s,1),s--,t.push({multiaddr:Kc(`/${r.map(e=>[jc(e[0]).name,e[1]].join("/")).join("/")}`),verified:o.verified,type:"dns-mapping",expires:o.expires,lastVerified:o.lastVerified}))}}return t}maybeAddSNITuple(e,t){for(let s=0;s<e.length;s++)if(448===e[s][0]&&449!==e[s+1]?.[0])return e.splice(s+1,0,[449,t]),!0;return!1}confirm(e,t){const s=this.findHost(e);let r=!1;for(const[e,n]of this.mappings.entries())n.domain===s&&(this.log("marking %s to %s DNS mapping as verified",e,n.domain),r=n.verified,n.verified=!0,n.expires=Date.now()+t,n.lastVerified=Date.now());return r}unconfirm(e,t){const s=this.findHost(e);let r=!1;for(const[e,n]of this.mappings.entries())n.domain===s&&(this.log("removing verification of %s to %s DNS mapping",e,n.domain),r=r||n.verified,n.verified=!1,n.expires=Date.now()+t);return r}findHost(e){for(const t of e.stringTuples()){if(449===t[0])return t[1];if(53===t[0]||54===t[0]||55===t[0]||56===t[0])return t[1]}}}class rd{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=ed({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){const t=e.stringTuples();for(const e of this.mappings.values())for(const s of e)if(s.externalIp===t[0][1])return!0;return!1}add(e,t,s,r=t,n="tcp"){const i=`${e}-${t}-${n}`,o=this.mappings.get(i)??[],a={internalIp:e,internalPort:t,externalIp:s,externalPort:r,externalFamily:gc(s)?4:6,protocol:n,verified:!1,expires:0};o.push(a),this.mappings.set(i,o)}remove(e){const t=e.stringTuples(),s=t[0][1]??"",r=6===t[1][0]?"tcp":"udp",n=parseInt(t[1][1]??"0");let i=!1;for(const[e,t]of this.mappings.entries()){for(let e=0;e<t.length;e++){const o=t[e];o.externalIp===s&&o.externalPort===n&&o.protocol===r&&(this.log("removing %s:%s to %s:%s %s IP mapping",o.externalIp,o.externalPort,s,n,r),i=i||o.verified,t.splice(e,1),e--)}0===t.length&&this.mappings.delete(e)}return i}getAll(e){const t=[];for(const{multiaddr:s}of e){const e=s.stringTuples();let r;if(4!==e[0][0]&&41!==e[0][0]||6!==e[1][0]?4!==e[0][0]&&41!==e[0][0]||273!==e[1][0]||(r=`${e[0][1]}-${e[1][1]}-udp`):r=`${e[0][1]}-${e[1][1]}-tcp`,null==r)continue;const n=this.mappings.get(r);if(null!=n)for(const s of n)e[0][0]=4===s.externalFamily?4:41,e[0][1]=s.externalIp,e[1][1]=`${s.externalPort}`,t.push({multiaddr:Kc(`/${e.map(e=>[jc(e[0]).name,e[1]].join("/")).join("/")}`),verified:s.verified,type:"ip-mapping",expires:s.expires,lastVerified:s.lastVerified})}return t}confirm(e,t){const s=e.stringTuples()[0][1];let r=!1;for(const e of this.mappings.values())for(const n of e)n.externalIp===s&&(this.log("marking %s to %s IP mapping as verified",n.internalIp,n.externalIp),r=n.verified,n.verified=!0,n.expires=Date.now()+t,n.lastVerified=Date.now());return r}unconfirm(e,t){const s=e.stringTuples(),r=s[0][1]??"",n=6===s[1][0]?"tcp":"udp",i=parseInt(s[1][1]??"0");let o=!1;for(const e of this.mappings.values())for(let s=0;s<e.length;s++){const a=e[s];a.externalIp===r&&a.externalPort===i&&a.protocol===n&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",a.externalIp,a.externalPort,r,i,n),o=o||a.verified,a.verified=!1,a.expires=Date.now()+t)}return o}}function nd(e){try{for(const{code:t}of e.getComponents())if(42!==t)return 4===t||t===yc}catch{}return!1}function id(e){try{if(!nd(e))return!1;const[[,t]]=e.stringTuples();return null!=t&&(du(t)??!1)}catch{}return!0}const od=10;class ad{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=ed({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??od}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(id(e)||function(e){try{for(const{code:t,value:s}of e.getComponents())if(42!==t&&null!=s){if(4===t)return s.startsWith("169.254.");if(t===yc)return s.toLowerCase().startsWith("fe80")}}catch{}return!1}(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:Kc(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){const t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const s=e.toString(),r=this.addresses.get(s)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},n=r.verified;return r.verified=!0,r.expires=Date.now()+t,r.lastVerified=Date.now(),this.log("marking observed address %a as verified",s),this.addresses.set(s,r),n}}const cd=[4,yc,53,54,55,56];function ld(e){try{for(const{code:t}of e.getComponents())if(42!==t)return cd.includes(t)}catch{}return!1}const hd=10;class ud{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=ed({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??hd}get(e,t){if(id(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const s=this.toKey(e);let r=this.addresses.get(s);return null==r&&(r={verified:!ld(e),expires:0},this.addresses.set(s,r)),{multiaddr:e,verified:r.verified,type:"transport",expires:r.expires,lastVerified:r.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){const t=this.toKey(e),s=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),s}confirm(e,t){const s=this.toKey(e),r=this.addresses.get(s)??{verified:!1,expires:0,lastVerified:0},n=r.verified;return r.verified=!0,r.expires=Date.now()+t,r.lastVerified=Date.now(),this.addresses.set(s,r),n}unconfirm(e,t){const s=this.toKey(e),r=this.addresses.get(s)??{verified:!1,expires:0},n=r.verified;return r.verified=!1,r.expires=Date.now()+t,this.addresses.set(s,r),n}toKey(e){if(ld(e)){const t=e.toOptions();return`${t.host}-${t.port}-${t.transport}`}return e.toString()}}const dd={addressVerificationTTL:6e5,addressVerificationRetry:3e5},pd=e=>e;function fd(e,t){const s=e.getPeerId();if(null!=s){xa(s).equals(t)&&(e=e.decapsulate(Kc(`/p2p/${t.toString()}`)))}return e}class gd{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){const{listen:s=[],announce:r=[],appendAnnounce:n=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=s.map(e=>e.toString()),this.announce=new Set(r.map(e=>e.toString())),this.appendAnnounce=new Set(n.map(e=>e.toString())),this.observed=new ad(e,t),this.dnsMappings=new sd(e,t),this.ipMappings=new rd(e,t),this.transportAddresses=new ud(e,t),this.announceFilter=t.announceFilter??pd,this.observedAddressFilter=Ll(1024),this.addressVerificationTTL=t.addressVerificationTTL??dd.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??dd.addressVerificationRetry,this._updatePeerStoreAddresses=cu(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){const e=this.getAddresses().map(e=>e.getPeerId()===this.components.peerId.toString()?e.decapsulate(`/p2p/${this.components.peerId.toString()}`):e);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(e=>{this.log.error("error updating addresses",e)})}getListenAddrs(){return Array.from(this.listen).map(e=>Kc(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>Kc(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>Kc(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){const t=e.stringTuples(),s=`${t[0][1]}:${t[1][1]}`;this.observedAddressFilter.has(s)||(this.observedAddressFilter.add(s),e=fd(e,this.components.peerId),this.ipMappings.has(e)||this.dnsMappings.has(e)||this.observed.add(e))}confirmObservedAddr(e,t){e=fd(e,this.components.peerId);let s=!0;if("transport"===t?.type||this.transportAddresses.has(e)){!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&s&&(s=!1)}if("dns-mapping"===t?.type||this.dnsMappings.has(e)){!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&s&&(s=!1)}if("ip-mapping"===t?.type||this.ipMappings.has(e)){!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&s&&(s=!1)}if("observed"===t?.type||this.observed.has(e))if(this.maybeUpgradeToIPMapping(e))this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),s=!1;else{!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&s&&(s=!1)}s||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=fd(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter(t=>{if(!t.verified)return!1;const s=t.multiaddr.toString();return!e.has(s)&&(e.add(s),!0)}).map(e=>e.multiaddr);return this.announceFilter(t.map(e=>{const t=Kc(e),s=t.getComponents().pop();return s?.value===this.components.peerId.toString()?t:t.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(t=>{t.updateAnnounceAddrs(e)}),e.map(e=>({multiaddr:e,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(e=>this.transportAddresses.get(e,this.addressVerificationTTL)));const s=this.getAppendAnnounceAddrs();return s.length>0&&(this.components.transportManager.getListeners().forEach(e=>{e.updateAnnounceAddrs(s)}),t=t.concat(s.map(e=>({multiaddr:e,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(Kc(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,s,r=t,n="tcp"){this.ipMappings.add(e,t,s,r,n),this.observed.removePrefixed(`/ip${gc(s)?4:6}/${s}/${n}/${r}`)}removePublicAddressMapping(e,t,s,r=t,n="tcp"){this.ipMappings.remove(Kc(`/ip${gc(s)?4:6}/${s}/${n}/${r}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e))return!1;const t=e.toOptions();if(6===t.family||"127.0.0.1"===t.host||!0===du(t.host))return!1;const s=this.components.transportManager.getListeners(),r=[e=>qu.exactMatch(e)||Ku.exactMatch(e),e=>Ou.exactMatch(e),e=>Fu.exactMatch(e)];for(const n of r){if(!n(e))continue;const r=s.filter(e=>e.getAddrs().filter(e=>4===e.toOptions().family&&n(e)).length>0);if(1!==r.length)continue;const i=r[0].getAddrs().filter(e=>"127.0.0.1"!==e.toOptions().host).pop();if(null==i)continue;const o=i.toOptions();return this.observed.remove(e),this.ipMappings.add(o.host,o.port,t.host,t.port,t.transport),!0}return!1}}var md;!function(e){e.NOT_STARTED_YET="The libp2p node is not started yet",e.NOT_FOUND="Not found"}(md||(md={}));class yd extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class bd extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class wd extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class vd extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class Sd extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class Ed extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class Dd extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class _d extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class Td extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class Id extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class Cd extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class Pd extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class xd extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class Ad extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class kd extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class Nd extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class Rd{components={};_started=!1;constructor(e={}){this.components={};for(const[t,s]of Object.entries(e))this.components[t]=s;null==this.components.logger&&(this.components.logger=ml())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(e=>va(e)).map(async t=>{await(t[e]?.())}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const Md=["metrics","connectionProtector","dns"],Ld=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function Od(e){return Array.isArray(e?.[Sa])?e[Sa]:[]}function Bd(e){return Array.isArray(e?.[Ea])?e[Ea]:[]}function Ud(e){return e?.[Symbol.toStringTag]??e?.toString()??"unknown"}function Vd(e={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{if(qu.matches(e))return!1;const t=e.stringTuples();return(4===t[0][0]||41===t[0][0])&&Boolean(du(`${t[0][1]}`))},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...e}}const Fd=()=>{const e=new Error("Delay aborted");return e.name="AbortError",e},zd=new WeakMap;const $d=function({clearTimeout:e,setTimeout:t}={}){return(s,{value:r,signal:n}={})=>{if(n?.aborted)return Promise.reject(Fd());let i,o,a;const c=e??clearTimeout,l=()=>{c(i),a(Fd())},h=new Promise((e,c)=>{o=()=>{n&&n.removeEventListener("abort",l),e(r)},a=c,i=(t??setTimeout)(o,s)});return n&&n.addEventListener("abort",l,{once:!0}),zd.set(h,()=>{c(i),i=null,o()}),h}}();class qd extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}}let Wd=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}};class Kd{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??1e3*this.duration/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new jd}async consume(e,t=1,s={}){const r=this.getKey(e),n=this._getKeySecDuration(s);let i=this.memoryStorage.incrby(r,t,n);if(i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i.consumedPoints>this.points)throw this.blockDuration>0&&i.consumedPoints<=this.points+t&&(i=this.memoryStorage.set(r,i.consumedPoints,this.blockDuration)),new qd("Rate limit exceeded",i);if(this.execEvenly&&i.msBeforeNext>0&&!i.isFirstInDuration){let e=Math.ceil(i.msBeforeNext/(i.remainingPoints+2));e<this.execEvenlyMinDelayMs&&(e=i.consumedPoints*this.execEvenlyMinDelayMs),await $d(e)}return i}penalty(e,t=1,s={}){const r=this.getKey(e),n=this._getKeySecDuration(s),i=this.memoryStorage.incrby(r,t,n);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}reward(e,t=1,s={}){const r=this.getKey(e),n=this._getKeySecDuration(s),i=this.memoryStorage.incrby(r,-t,n);return i.remainingPoints=Math.max(this.points-i.consumedPoints,0),i}block(e,t){const s=1e3*t,r=this.points+1;return this.memoryStorage.set(this.getKey(e),r,t),{remainingPoints:0,msBeforeNext:0===s?-1:s,consumedPoints:r,isFirstInDuration:!1}}set(e,t,s=0){const r=1e3*(s>=0?s:this.duration);return this.memoryStorage.set(this.getKey(e),t,s),{remainingPoints:0,msBeforeNext:0===r?-1:r,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return null!=t&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return null!=e?.customDuration&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class jd{storage;constructor(){this.storage=new Map}incrby(e,t,s){const r=this.storage.get(e);if(null!=r){const n=null!=r.expiresAt?r.expiresAt.getTime()-(new Date).getTime():-1;return null==r.expiresAt||n>0?(r.value+=t,{remainingPoints:0,msBeforeNext:n,consumedPoints:r.value,isFirstInDuration:!1}):this.set(e,t,s)}return this.set(e,t,s)}set(e,t,s){const r=1e3*s,n=this.storage.get(e);null!=n&&clearTimeout(n.timeoutId);const i={value:t,expiresAt:r>0?new Date(Date.now()+r):void 0};return this.storage.set(e,i),r>0&&(i.timeoutId=setTimeout(()=>{this.storage.delete(e)},r),null!=i.timeoutId.unref&&i.timeoutId.unref()),{remainingPoints:0,msBeforeNext:0===r?-1:r,consumedPoints:i.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(null!=t){return{remainingPoints:0,msBeforeNext:null!=t.expiresAt?t.expiresAt.getTime()-(new Date).getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}}delete(e){const t=this.storage.get(e);return null!=t&&(null!=t.timeoutId&&clearTimeout(t.timeoutId),this.storage.delete(e),!0)}}function Hd(e){if(Jo(e))return{peerId:e,multiaddrs:[]};let t,s=Array.isArray(e)?e:[e];if(s.length>0){const e=s[0].getPeerId();t=null==e?void 0:xa(e),s.forEach(e=>{if(!Wc(e))throw new ca("Invalid multiaddr");const s=e.getPeerId();if(null==s){if(null!=t)throw new ra("Multiaddrs must all have the same peer id or have no peer id")}else{const e=xa(s);if(!0!==t?.equals(e))throw new ra("Multiaddrs must all have the same peer id or have no peer id")}})}return s=s.filter(e=>!Du.exactMatch(e)),{peerId:t,multiaddrs:s}}const Gd=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];function Qd(e){try{let t;if(t="string"==typeof e?Kc(e):e,!t.protoNames().includes("ipcidr")){const e=t.protoNames().includes("ip6")?"/ipcidr/128":"/ipcidr/32";t=t.encapsulate(e)}return function(e){let t,s;if(e.getComponents().forEach(e=>{"ip4"!==e.name&&"ip6"!==e.name||(s=e.value),"ipcidr"===e.name&&(t=e.value)}),null==t||null==s)throw new Error("Invalid multiaddr");return new $c(s,t)}(t)}catch(t){throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${e}`)}}class Xd{connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map(e=>Qd(e)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections %e",e)})}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,s=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,s),t<=s)return;const r=new Sl;for(const t of e){const e=t.remotePeer;if(!r.has(e)){r.set(e,0);try{const t=await this.peerStore.get(e);r.set(e,[...t.tags.values()].reduce((e,t)=>e+t.value,0))}catch(e){"NotFoundError"!==e.name&&this.log.error("error loading peer tags",e)}}}const n=this.sortConnections(e,r),i=Math.max(t-s,0),o=[];for(const e of n){this.log("too many connections open - closing a connection to %p",e.remotePeer);if(this.allow.some(t=>t.contains(e.remoteAddr.nodeAddress().address))||o.push(e),o.length===i)break}await Promise.all(o.map(async e=>{await async function(e,t){const s=e?.streams?.map(e=>e.protocol)??[],r=t?.closableProtocols??Gd;if(!(s.filter(e=>null!=e&&!r.includes(e)).length>0))try{await(e?.close(t))}catch(t){e?.abort(t)}}(e,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:o})}sortConnections(e,t){return e.sort((e,t)=>{const s=e.timeline.open,r=t.timeline.open;return s<r?1:s>r?-1:0}).sort((e,t)=>"outbound"===e.direction&&"inbound"===t.direction?1:"inbound"===e.direction&&"outbound"===t.direction?-1:0).sort((e,t)=>e.streams.length>t.streams.length?1:e.streams.length<t.streams.length?-1:0).sort((e,s)=>{const r=t.get(e.remotePeer)??0,n=t.get(s.remotePeer)??0;return r>n?1:r<n?-1:0})}}const Yd="last-dial-failure",Jd="last-dial-success";let Zd=class extends Error{type;code;constructor(e,t,s){super(e??"The operation was aborted"),this.type="aborted",this.name=s??"AbortError",this.code=t??"ABORT_ERR"}};async function ep(e,t,s){if(null==t)return e;if(t.aborted)return e.catch(()=>{}),Promise.reject(new Zd(s?.errorMessage,s?.errorCode,s?.errorName));let r;const n=new Zd(s?.errorMessage,s?.errorCode,s?.errorName);try{return await Promise.race([e,new Promise((e,s)=>{r=()=>{s(n)},t.addEventListener("abort",r)})])}finally{null!=r&&t.removeEventListener("abort",r)}}let tp=class{deferred;signal;constructor(e){this.signal=e,this.deferred=jl(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new sa)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};let sp=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=`${parseInt(String(1e9*Math.random()),10).toString()}${Date.now()}`,this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((e,t)=>e&&!0===t.signal?.aborted,!0)&&(this.controller.abort(new sa),this.cleanup())}async join(e={}){const t=new tp(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await ep(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}},rp=class extends ns{concurrency;maxSize;queue;pending;sort;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,null!=e.metricName&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=cu(this.emitEmpty.bind(this),1),this.emitIdle=cu(this.emitIdle.bind(this),1)}emitEmpty(){0===this.size&&this.safeDispatchEvent("empty")}emitIdle(){0===this.running&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(0===this.size)return this.emitEmpty(),0===this.running&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if("queued"===t.status){e=t;break}return null!=e&&(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),null!=this.sort&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new Wd;const s=new sp(e,t);return this.enqueue(s),this.safeDispatchEvent("add"),this.tryToStartAnother(),s.join(t).then(e=>(this.safeDispatchEvent("completed",{detail:e}),this.safeDispatchEvent("success",{detail:{job:s,result:e}}),e)).catch(e=>{if("queued"===s.status)for(let e=0;e<this.queue.length;e++)if(this.queue[e]===s){this.queue.splice(e,1);break}throw this.safeDispatchEvent("failure",{detail:{job:s,error:e}}),e})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new sa)}),this.clear()}async onEmpty(e){0!==this.size&&await Yl(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Yl(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){0===this.pending&&0===this.size||await Yl(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=Xl({objectMode:!0}),s=e=>{null!=e?this.abort():this.clear(),t.end(e)},r=e=>{null!=e.detail&&t.push(e.detail)},n=e=>{s(e.detail.error)},i=()=>{s()},o=()=>{s(new sa("Queue aborted"))};this.addEventListener("completed",r),this.addEventListener("failure",n),this.addEventListener("idle",i),e?.signal?.addEventListener("abort",o);try{yield*t}finally{this.removeEventListener("completed",r),this.removeEventListener("failure",n),this.removeEventListener("idle",i),e?.signal?.removeEventListener("abort",o),s()}}};class np extends rp{constructor(e={}){super({...e,sort:(e,t)=>e.options.priority>t.options.priority?-1:e.options.priority<t.options.priority?1:0})}}function ip(e){const t=new globalThis.AbortController;function s(){const r=e.filter(e=>!0===e?.aborted).map(e=>e?.reason).pop();t.abort(r);for(const t of e)null!=t?.removeEventListener&&t.removeEventListener("abort",s)}for(const t of e){if(!0===t?.aborted){s();break}null!=t?.addEventListener&&t.addEventListener("abort",s)}const r=t.signal;return r.clear=function(){for(const t of e)null!=t?.removeEventListener&&t.removeEventListener("abort",s)},r}function op(e){if(!nd(e))return!1;const{address:t}=e.nodeAddress();return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(s=t)||/^::1$/.test(s);var s}function ap(e,t){const s=Ou.exactMatch(e.multiaddr),r=Ou.exactMatch(t.multiaddr);if(s&&!r)return-1;if(!s&&r)return 1;const n=Ku.exactMatch(e.multiaddr),i=Ku.exactMatch(t.multiaddr);if(n&&!i)return-1;if(!n&&i)return 1;const o=qu.exactMatch(e.multiaddr),a=qu.exactMatch(t.multiaddr);if(o&&!a)return-1;if(!o&&a)return 1;const c=Ju.exactMatch(e.multiaddr),l=Ju.exactMatch(t.multiaddr);if(c&&!l)return-1;if(!c&&l)return 1;const h=Hu.exactMatch(e.multiaddr),u=Hu.exactMatch(t.multiaddr);if(h&&!u)return-1;if(!h&&u)return 1;const d=Qu.exactMatch(e.multiaddr),p=Qu.exactMatch(t.multiaddr);return d&&!p?-1:!d&&p?1:0}function cp(e,t){const s=op(e.multiaddr),r=op(t.multiaddr);return s&&!r?1:!s&&r?-1:0}function lp(e,t){const s=id(e.multiaddr),r=id(t.multiaddr);return s&&!r?1:!s&&r?-1:0}function hp(e,t){return e.isCertified&&!t.isCertified?-1:!e.isCertified&&t.isCertified?1:0}function up(e,t){const s=Yu.exactMatch(e.multiaddr),r=Yu.exactMatch(t.multiaddr);return s&&!r?1:!s&&r?-1:0}const dp=50,pp=500,fp=25,gp=1e4;class mp{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??fp,this.maxDialQueueLength=t.maxDialQueueLength??pp,this.dialTimeout=t.dialTimeout??gp,this.connections=t.connections??new Sl,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.shutDownController=new AbortController,this.shutDownController.signal;for(const[e,s]of Object.entries(t.resolvers??{}))qc.set(e,s);this.queue=new np({concurrency:t.maxParallelDials??dp,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",e=>{e.detail?.name!==sa.name&&this.log.error("error in dial queue - %e",e.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){const{peerId:s,multiaddrs:r}=Hd(e),n=Array.from(this.connections.values()).flat().find(e=>!0!==t.force&&(!!e.remotePeer.equals(s)||r.find(t=>t.equals(e.remoteAddr))));if("open"===n?.status)return this.log("already connected to %a",n.remoteAddr),t.onProgress?.(new Wa("dial-queue:already-connected")),n;const i=this.queue.queue.find(e=>{if(!0===s?.equals(e.options.peerId))return!0;const t=e.options.multiaddrs;if(null==t)return!1;for(const e of r)if(t.has(e.toString()))return!0;return!1});if(null!=i){this.log("joining existing dial target for %p",s);for(const e of r)i.options.multiaddrs.add(e.toString());return t.onProgress?.(new Wa("dial-queue:already-in-dial-queue")),i.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new ga("Dial queue is full");return this.log("creating dial target for %p",s,r.map(e=>e.toString())),t.onProgress?.(new Wa("dial-queue:add-to-dial-queue")),this.queue.add(async e=>{e.onProgress?.(new Wa("dial-queue:start-dial"));const t=ip([this.shutDownController.signal,e.signal]);try{return await this.dialPeer(e,t)}finally{t.clear()}},{peerId:s,priority:t.priority??xp,multiaddrs:new Set(r.map(e=>e.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){const s=e.peerId,r=e.multiaddrs,n=new Set;let i=0===e.multiaddrs.size,o=0,a=0;const c=[];for(this.log("starting dial to %p",s);i||r.size>0;){a++,i=!1;const l=[],h=new Set(e.multiaddrs);r.clear(),this.log("calculating addrs to dial %p from %s",s,[...h]);const u=await this.calculateMultiaddrs(s,h,{...e,signal:t});for(const e of u)n.has(e.multiaddr.toString())?this.log.trace("skipping previously failed multiaddr %a while dialing %p",e.multiaddr,s):l.push(e);this.log("%s dial to %p with %s",1===a?"starting":"continuing",s,l.map(e=>e.multiaddr.toString())),e?.onProgress?.(new Wa("dial-queue:calculated-addresses",l));for(const r of l){if(o===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",o,e.peerId),new ga("Peer had more than maxPeerAddrsToDial");o++;try{const n=await this.components.transportManager.dial(r.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",r.multiaddr);try{await this.components.peerStore.merge(n.remotePeer,{multiaddrs:[n.remoteAddr],metadata:{[Jd]:Ge(Date.now().toString())}})}catch(e){this.log.error("could not update last dial failure key for %p",s,e)}return n}catch(e){if(this.log.error("dial failed to %a",r.multiaddr,e),n.add(r.multiaddr.toString()),null!=s)try{await this.components.peerStore.merge(s,{metadata:{[Yd]:Ge(Date.now().toString())}})}catch(e){this.log.error("could not update last dial failure key for %p",s,e)}if(t.aborted)throw new pa(e.message);c.push(e)}}}if(1===c.length)throw c[0];throw new AggregateError(c,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,s={}){const r=[...t].map(e=>({multiaddr:Kc(e),isCertified:!1}));if(null!=e){if(this.components.peerId.equals(e))throw new ga("Tried to dial self");if(!0===await(this.components.connectionGater.denyDialPeer?.(e)))throw new _d("The dial request is blocked by gater.allowDialPeer");if(0===r.length){this.log("loading multiaddrs for %p",e);try{const t=await this.components.peerStore.get(e);r.push(...t.addresses),this.log("loaded multiaddrs for %p",e,r.map(({multiaddr:e})=>e.toString()))}catch(e){if("NotFoundError"!==e.name)throw e}}if(0===r.length){this.log("looking up multiaddrs for %p in the peer routing",e);try{const t=await this.components.peerRouting.findPeer(e,s);this.log("found multiaddrs for %p in the peer routing",e,r.map(({multiaddr:e})=>e.toString())),r.push(...t.multiaddrs.map(e=>({multiaddr:e,isCertified:!1})))}catch(t){"NoPeerRoutersError"===t.name?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,t)}}}let n=(await Promise.all(r.map(async e=>{const t=await async function(e,t){let s=!1;for(const t of qc.keys())if(s=e.protoNames().includes(t),s)break;if(!s)return[e];const r=await e.resolve(t);return t.log("resolved %s to",e,r.map(e=>e.toString())),r}(e.multiaddr,{dns:this.components.dns,...s,log:this.log});return 1===t.length&&t[0].equals(e.multiaddr)?e:t.map(e=>({multiaddr:e,isCertified:!1}))}))).flat();if(null!=e){const t=`/p2p/${e.toString()}`;n=n.map(e=>{const s=e.multiaddr.getComponents().pop();return"p2p"!==s?.name?{multiaddr:e.multiaddr.encapsulate(t),isCertified:e.isCertified}:e})}const i=n.filter(t=>{if(null==this.components.transportManager.dialTransportForMultiaddr(t.multiaddr))return!1;const s=t.multiaddr.getPeerId();return null==e||null==s||e.equals(s)}),o=new Map;for(const e of i){const t=e.multiaddr.toString(),s=o.get(t);null==s?o.set(t,e):s.isCertified=s.isCertified||e.isCertified||!1}const a=[...o.values()];if(0===a.length)throw new Cd("The dial request has no valid addresses");const c=[];for(const e of a)null!=this.components.connectionGater.denyDialMultiaddr&&await this.components.connectionGater.denyDialMultiaddr(e.multiaddr)||c.push(e);const l=null==this.addressSorter?c.sort(ap).sort(hp).sort(up).sort(lp).sort(cp):c.sort(this.addressSorter);if(0===l.length)throw new _d("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",n.map(({multiaddr:e})=>e.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",l.map(({multiaddr:e})=>e.toString())),l}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const s=await this.calculateMultiaddrs(void 0,new Set(e.map(e=>e.toString())),t);return!1!==t.runOnLimitedConnection||null!=s.find(e=>!Yu.matches(e.multiaddr))}catch(e){this.log.trace("error calculating if multiaddr(s) were dialable",e)}return!1}}let yp=class extends rp{has(e){return null!=this.find(e)}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}};var bp={};function wp(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var vp=wp;wp.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},wp.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},wp.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var s=this._timeouts.shift();if(void 0===s){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),s=this._cachedTimeouts.slice(-1)}var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},s),this._options.unref&&this._timer.unref(),!0},wp.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var s=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){s._operationTimeoutCb()},s._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},wp.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},wp.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},wp.prototype.start=wp.prototype.try,wp.prototype.errors=function(){return this._errors},wp.prototype.attempts=function(){return this._attempts},wp.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,s=0,r=0;r<this._errors.length;r++){var n=this._errors[r],i=n.message,o=(e[i]||0)+1;e[i]=o,o>=s&&(t=n,s=o)}return t},function(e){var t=vp;e.operation=function(s){var r=e.timeouts(s);return new t(r,{forever:s&&(s.forever||s.retries===1/0),unref:s&&s.unref,maxRetryTime:s&&s.maxRetryTime})},e.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var s in e)t[s]=e[s];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],n=0;n<t.retries;n++)r.push(this.createTimeout(n,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(n,t)),r.sort(function(e,t){return e-t}),r},e.createTimeout=function(e,t){var s=t.randomize?Math.random()+1:1,r=Math.round(s*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return r=Math.min(r,t.maxTimeout)},e.wrap=function(t,s,r){if(s instanceof Array&&(r=s,s=null),!r)for(var n in r=[],t)"function"==typeof t[n]&&r.push(n);for(var i=0;i<r.length;i++){var o=r[i],a=t[o];t[o]=function(r){var n=e.operation(s),i=Array.prototype.slice.call(arguments,1),o=i.pop();i.push(function(e){n.retry(e)||(e&&(arguments[0]=n.mainError()),o.apply(this,arguments))}),n.attempt(function(){r.apply(t,i)})}.bind(t,a),t[o].options=s}}}(bp);var Sp=t(bp);const Ep=Object.prototype.toString,Dp=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function _p(e){const t=e&&(e=>"[object Error]"===Ep.call(e))(e)&&"TypeError"===e.name&&"string"==typeof e.message;if(!t)return!1;const{message:s,stack:r}=e;return"Load failed"===s?void 0===r||"__sentry_captured__"in e:!!s.startsWith("error sending request for url")||Dp.has(s)}let Tp=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}};const Ip=(e,t,s)=>{const r=s.retries-(t-1);return e.attemptNumber=t,e.retriesLeft=r,e};class Cp{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new yp({concurrency:t.maxParallelReconnects??5,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",e=>{this.maybeReconnect(e.detail).catch(t=>{this.log.error("failed to maybe reconnect to %p - %e",e.detail,t)})})}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);Pp(t)&&(this.queue.has(e)||this.queue.add(async t=>{await async function(e,t){return new Promise((s,r)=>{t={...t},t.onFailedAttempt??=()=>{},t.shouldRetry??=()=>!0,t.retries??=10;const n=Sp.operation(t),i=()=>{n.stop(),r(t.signal?.reason)};t.signal&&!t.signal.aborted&&t.signal.addEventListener("abort",i,{once:!0});const o=()=>{t.signal?.removeEventListener("abort",i),n.stop()};n.attempt(async i=>{try{const t=await e(i);o(),s(t)}catch(e){try{if(!(e instanceof Error))throw new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`);if(e instanceof Tp)throw e.originalError;if(e instanceof TypeError&&!_p(e))throw e;if(Ip(e,i,t),await t.shouldRetry(e)||(n.stop(),r(e)),await t.onFailedAttempt(e),!n.retry(e))throw n.mainError()}catch(e){Ip(e,i,t),o(),r(e)}}})})}(async s=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:t?.signal})}catch(t){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,s,this.retries,t),t}},{signal:t?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async s=>{this.log.error("failed to reconnect to %p - %e",e,s);const r={};[...t.tags.keys()].forEach(e=>{e.startsWith(ea)&&(r[e]=void 0)}),await this.peerStore.merge(e,{tags:r}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async t=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,t)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[e=>Pp(e)]});await Promise.all(e.map(async e=>{await this.connectionManager.openConnection(e.id).catch(e=>{this.log.error(e)})}))}).catch(e=>{this.log.error(e)})}stop(){this.started=!1,this.queue.abort()}}function Pp(e){for(const t of e.tags.keys())if(t.startsWith(ea))return!0;return!1}const xp=50,Ap=100,kp=5,Np=10;class Rp{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??Ap,this.maxConnections<1)throw new ra("Connection Manager maxConnections must be greater than 0");this.connections=new Sl,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(e=>Qd(e)),this.deny=(t.deny??[]).map(e=>Qd(e)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??Np,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new Kd({points:t.inboundConnectionThreshold??kp,duration:1}),this.connectionPruner=new Xd({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(e=>Kc(e))}),this.dialQueue=new mp(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??50,maxDialQueueLength:t.maxDialQueueLength??500,maxPeerAddrsToDial:t.maxPeerAddrsToDial??25,dialTimeout:t.dialTimeout??1e4,resolvers:t.resolvers??{dnsaddr:Jc},connections:this.connections}),this.reconnectQueue=new Cp({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const t of this.connections.values())for(const s of t)e[s.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const s of t)for(const t of s.streams){const s=`${t.direction} ${t.protocol??"unnegotiated"}`;e[s]=(e[s]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const s of t){const t={};for(const e of s.streams){const s=`${e.direction} ${e.protocol??"unnegotiated"}`;t[s]=(t[s]??0)+1}for(const[s,r]of Object.entries(t))e[s]=e[s]??[],e[s].push(r)}const t={};for(let[s,r]of Object.entries(e)){r=r.sort((e,t)=>e-t);const e=Math.floor(.9*r.length);t[s]=r[e]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await async function(...e){const t=[];for(const s of e)va(s)&&t.push(s);await Promise.all(t.map(async e=>{null!=e.beforeStart&&await e.beforeStart()})),await Promise.all(t.map(async e=>{await e.start()})),await Promise.all(t.map(async e=>{null!=e.afterStart&&await e.afterStart()}))}(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await async function(...e){const t=[];for(const s of e)va(s)&&t.push(s);await Promise.all(t.map(async e=>{null!=e.beforeStop&&await e.beforeStop()})),await Promise.all(t.map(async e=>{await e.stop()})),await Promise.all(t.map(async e=>{null!=e.afterStop&&await e.afterStop()}))}(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const s of t)e.push((async()=>{try{await s.close()}catch(e){this.log.error(e)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new ra("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(e=>{this.log.error(e)})}async _onConnect(e){const{detail:t}=e;if(!this.started)return void await t.close();if("open"!==t.status)return;const s=t.remotePeer,r=!this.connections.has(s),n=this.connections.get(s)??[];n.push(t),this.connections.set(s,n),null!=s.publicKey&&"RSA"===s.type&&await this.peerStore.patch(s,{publicKey:s.publicKey}),r&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,s=t.remotePeer,r=(this.connections.get(s)??[]).filter(e=>e.id!==t.id);this.connections.set(s,r),0===r.length&&(this.log("onDisconnect remove all connections for peer %p",s),this.connections.delete(s),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(null!=e)return this.connections.get(e)??[];let t=[];for(const e of this.connections.values())t=t.concat(e);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new fa("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();const{peerId:s}=Hd(e);if(this.peerId.equals(s))throw new aa("Can not dial self");if(null!=s&&!0!==t.force){this.log("dial %p",s);const e=this.getConnections(s).find(e=>null==e.limits);if(null!=e)return this.log("had an existing non-limited connection to %p",s),t.onProgress?.(new Wa("dial-queue:already-connected")),e}const r=await this.dialQueue.dial(e,{...t,priority:t.priority??xp});if("open"!==r.status)throw new ia("Remote closed connection during opening");let n=this.connections.get(r.remotePeer);null==n&&(n=[],this.connections.set(r.remotePeer,n));let i=!1;for(const e of n)if(e.id===r.id&&(i=!0),!0!==t.force&&e.id!==r.id&&e.remoteAddr.equals(r.remoteAddr))return r.abort(new ca("Duplicate multiaddr connection")),e;return i||n.push(r),r}finally{this.outboundPendingConnections--}}async closeConnections(e,t={}){const s=this.connections.get(e)??[];await Promise.all(s.map(async e=>{try{await e.close(t)}catch(t){e.abort(t)}}))}async acceptIncomingConnection(e){if(this.deny.some(t=>t.contains(e.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(t=>t.contains(e.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const t=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(t,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,t),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(e=>Kc(e))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}let Mp=class{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(null!=this.previousTime){const s=this.alpha(t,this.previousTime),r=e-this.movingAverage,n=s*r;this.movingAverage=s*e+(1-s)*this.movingAverage,this.variance=(1-s)*(this.variance+r*n),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+s*r}else this.movingAverage=e;this.previousTime=t}};let Lp=class{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){const t=e.interval??5e3;this.success=new Mp(t),this.failure=new Mp(t),this.next=new Mp(t),this.failureMultiplier=e.failureMultiplier??2,this.timeoutMultiplier=e.timeoutMultiplier??1.2,this.minTimeout=e.minTimeout??5e3,this.maxTimeout=e.maxTimeout??6e4,null!=e.metricName&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);const s=AbortSignal.timeout(t),r=ip([e.signal,s]);return r.start=Date.now(),r.timeout=t,r}cleanUp(e){const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}};function Op(e){return e.reason}class Bp{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=jl(),this.haveNext=jl()}[Symbol.asyncIterator](){return this}async next(){if(null==this.nextResult&&await this.haveNext.promise,null==this.nextResult)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=jl(),e}async throw(e){this.ended=!0,this.error=e,null!=e&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e));return{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){null!=e?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(null!=e&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;null!=this.nextResult;)await this.readNext.promise;null!=e?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=jl(),await async function(e,t,s){if(null==t)return e;const r=s?.translateError??Op;if(t.aborted)return e.catch(()=>{}),Promise.reject(r(t));let n;try{return await Promise.race([e,new Promise((e,s)=>{n=()=>{s(r(t))},t.addEventListener("abort",n)})])}finally{null!=n&&t.removeEventListener("abort",n)}}(this.readNext.promise,t?.signal,t)}}function Up(){return new Bp}function Vp(e){return e.reason}async function Fp(e,t,s){if(null==t)return e;const r=Vp;if(t.aborted)return e.catch(()=>{}),Promise.reject(r(t));let n;try{return await Promise.race([e,new Promise((e,s)=>{n=()=>{s(r(t))},t.addEventListener("abort",n)})])}finally{null!=n&&t.removeEventListener("abort",n)}}let zp=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function $p(e,t){const s=Up();e.sink(s).catch(async e=>{await s.end(e)}),e.sink=async e=>{for await(const t of e)await s.push(t);await s.end()};let r=e.source;null!=e.source[Symbol.iterator]?r=e.source[Symbol.iterator]():null!=e.source[Symbol.asyncIterator]&&(r=e.source[Symbol.asyncIterator]());const n=new cs,i={read:async e=>{if(e?.signal?.throwIfAborted(),null==e?.bytes){const{done:t,value:s}=await Fp(r.next(),e?.signal);return!0===t?null:s}for(;n.byteLength<e.bytes;){const{value:t,done:s}=await Fp(r.next(),e?.signal);if(!0===s)throw new zp("unexpected end of input");n.append(t)}const t=n.sublist(0,e.bytes);return n.consume(e.bytes),t},write:async(e,t)=>{t?.signal?.throwIfAborted(),e instanceof Uint8Array?await s.push(e,t):await s.push(e.subarray(),t)},unwrap:()=>{if(n.byteLength>0){const s=e.source;e.source=async function*(){!1===t?.yieldBytes?yield n:yield*n,yield*s}()}return e}};return i}class qp{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??"ipfs"}/ping/1.0.0`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??1e4,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??true,this.timeout=new Lp({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[Sa]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{const s=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),r=$p(await e.newStream(this.protocol,{signal:s,runOnLimitedConnection:!0}));t=Date.now(),await Promise.all([r.write(go(32),{signal:s}),r.read({bytes:32,signal:s})]),e.rtt=Date.now()-t,await r.unwrap().close({signal:s})}catch(s){if("UnsupportedProtocolError"!==s.name)throw s;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),null!=this.heartbeatInterval&&clearInterval(this.heartbeatInterval)}}function Wp(e){return null!=e[Symbol.asyncIterator]}async function*Kp(e){const t=new AbortController,s=Up();(async function(e,t,s){try{await Promise.all(e.map(async e=>{for await(const r of e)await t.push(r,{signal:s}),s.throwIfAborted()})),await t.end(void 0,{signal:s})}catch(e){await t.end(e,{signal:s}).catch(()=>{})}})(e,s,t.signal).catch(()=>{});try{yield*s}finally{t.abort()}}function jp(...e){const t=[];for(const s of e)Wp(s)||t.push(s);return t.length===e.length?function*(e){for(const t of e)yield*t}(t):Kp(e)}class Hp{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([e],t)=>({...t,cid:e.toString()}),getAttributesFromYieldedValue:(e,t)=>({...t,providers:[...Array.isArray(t.providers)?t.providers:[],e.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([e],t)=>({...t,cid:e.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([e],t)=>({...t,cid:e.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([e])=>({key:Qe(e,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([e])=>({key:Qe(e,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(0===this.routers.length)throw new wd("No content routers available");const s=this,r=new El;for await(const n of jp(...s.routers.filter(e=>e.findProviders instanceof Function).map(s=>s.findProviders(e,t))))null!=n&&(n.multiaddrs.length>0&&await this.components.peerStore.merge(n.id,{multiaddrs:n.multiaddrs},t),r.has(n.id)||(r.add(n.id),yield n))}async provide(e,t={}){if(0===this.routers.length)throw new wd("No content routers available");await Promise.all(this.routers.filter(e=>e.provide instanceof Function).map(async s=>{await s.provide(e,t)}))}async cancelReprovide(e,t={}){if(0===this.routers.length)throw new wd("No content routers available");await Promise.all(this.routers.filter(e=>e.cancelReprovide instanceof Function).map(async s=>{await s.cancelReprovide(e,t)}))}async put(e,t,s){if(!this.isStarted())throw new fa;await Promise.all(this.routers.filter(e=>e.put instanceof Function).map(async r=>{await r.put(e,t,s)}))}async get(e,t){if(!this.isStarted())throw new fa;return Promise.any(this.routers.filter(e=>e.get instanceof Function).map(async s=>s.get(e,t)))}}const Gp=globalThis.CustomEvent??Event;async function*Qp(e,t={}){let s=t.concurrency??1/0;s<1&&(s=1/0);const r=t.ordered??!1,n=new EventTarget,i=[];let o,a=jl(),c=jl(),l=!1,h=!1;function u(){return r?i[0]?.done:Boolean(i.find(e=>e.done))}function*d(){for(;i.length>0&&i[0].done;){const e=i[0];if(i.shift(),!e.ok)throw h=!0,a.resolve(),e.err;yield e.value,a.resolve()}}function*p(){for(;u();)for(let e=0;e<i.length;e++)if(i[e].done){const t=i[e];if(i.splice(e,1),e--,!t.ok)throw h=!0,a.resolve(),t.err;yield t.value,a.resolve()}}for(n.addEventListener("task-complete",()=>{c.resolve()}),Promise.resolve().then(async()=>{try{for await(const t of e){if(i.length===s&&(a=jl(),await a.promise),h)break;const e={done:!1};i.push(e),t().then(t=>{e.done=!0,e.ok=!0,e.value=t,n.dispatchEvent(new Gp("task-complete"))},t=>{e.done=!0,e.err=t,n.dispatchEvent(new Gp("task-complete"))})}l=!0,n.dispatchEvent(new Gp("task-complete"))}catch(e){o=e,n.dispatchEvent(new Gp("task-complete"))}});;){if(u()||(c=jl(),await c.promise),null!=o)throw o;if(r?yield*d():yield*p(),null!=o)throw o;if(l&&0===i.length)break}}class Xp{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([e],t)=>({...t,peer:e.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([e],t)=>({...t,key:Qe(e,"base36")}),getAttributesFromYieldedValue:(e,t)=>({...t,peers:[...Array.isArray(t.peers)?t.peers:[],e.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(0===this.routers.length)throw new vd("No peer routers available");if(e.toString()===this.peerId.toString())throw new Sd("Should not try to find self");const s=this,r=jp(...this.routers.filter(e=>e.findPeer instanceof Function).map(r=>async function*(){try{yield await r.findPeer(e,t)}catch(e){s.log.error(e)}}()));for await(const e of r)if(null!=e)return e.multiaddrs.length>0&&await this.peerStore.merge(e.id,{multiaddrs:e.multiaddrs},t),e;throw new oa}async*getClosestPeers(e,t={}){if(0===this.routers.length)throw new vd("No peer routers available");const s=this,r=Ll(1024);for await(const n of Qp(async function*(){const r=jp(...s.routers.filter(e=>e.getClosestPeers instanceof Function).map(s=>s.getClosestPeers(e,t)));for await(let e of r)yield async()=>{if(0===e.multiaddrs.length)try{e=await s.findPeer(e.id,{...t,useCache:!1})}catch(e){return void s.log.error("could not find peer multiaddrs",e)}return e}}()))null!=n&&(n.multiaddrs.length>0&&await this.peerStore.merge(n.id,{multiaddrs:n.multiaddrs},t),r.has(n.id.toMultihash().bytes)||(r.add(n.id.toMultihash().bytes),yield n))}}class Yp extends ns{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const t=ip([this.shutdownController.signal,e?.signal]);try{for(;;){this.needNext?.resolve(),this.needNext=jl();const e=await Yl(this,"walk:peer",t,{errorEvent:"walk:error"});yield e.detail}}finally{t.clear(),this.walkers--,0===this.walkers&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=ip([this.walkController.signal,this.shutdownController.signal]),t=Date.now();let s=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const t=go(32);let r=Date.now();for await(const n of this.peerRouting.getClosestPeers(t,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",n.id,Date.now()-r,this.walkers),s++,this.safeDispatchEvent("walk:peer",{detail:n}),1===this.walkers&&null!=this.needNext&&(this.log("wait for need next"),await ep(this.needNext.promise,e)),r=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",t,this.walkers,s)}catch(e){this.log.error("random walk errored",e),this.safeDispatchEvent("walk:error",{detail:e})}this.log("no walkers left, ended walk")}).catch(e=>{this.log.error("random walk errored",e)}).finally(()=>{this.log("finished walk, found %d peers after %dms",s,Date.now()-t),this.walking=!1})}}class Jp{log;topologies;handlers;components;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{const e={};for(const[t,s]of this.topologies)e[t]=s.size;return e}}),this.handlers=ed({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(null==t)throw new Ed(`No handler registered for protocol ${e}`);return t}getTopologies(e){const t=this.topologies.get(e);return null==t?[]:[...t.values()]}async handle(e,t,s){if(this.handlers.has(e)&&!0!==s?.force)throw new Dd(`Handler already registered for protocol ${e}`);const r=qa.bind({ignoreUndefined:!0})({maxInboundStreams:32,maxOutboundStreams:64},s);this.handlers.set(e,{handler:t,options:r}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},s)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(e=>{this.handlers.delete(e)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(null==t)throw new ra("invalid topology");const s=`${(1e9*Math.random()).toString(36)}${Date.now()}`;let r=this.topologies.get(e);return null==r&&(r=new Map,this.topologies.set(e,r)),r.set(s,t),s}unregister(e){for(const[t,s]of this.topologies.entries())s.has(e)&&(s.delete(e),0===s.size&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail,s={signal:AbortSignal.timeout(5e3)};this.components.peerStore.get(t,s).then(e=>{for(const s of e.protocols){const e=this.topologies.get(s);if(null!=e)for(const s of e.values())!1!==s.filter?.has(t)&&(s.filter?.remove(t),s.onDisconnect?.(t))}}).catch(e=>{"NotFoundError"!==e.name&&this.log.error("could not inform topologies of disconnecting peer %p",t,e)})}_onPeerUpdate(e){const{peer:t,previous:s}=e.detail,r=(s?.protocols??[]).filter(e=>!t.protocols.includes(e));for(const e of r){const s=this.topologies.get(e);if(null!=s)for(const e of s.values())!1!==e.filter?.has(t.id)&&(e.filter?.remove(t.id),e.onDisconnect?.(t.id))}}_onPeerIdentify(e){const t=e.detail.protocols,s=e.detail.connection,r=e.detail.peerId;for(const e of t){const t=this.topologies.get(e);if(null!=t)for(const e of t.values())null!=s.limits&&!0!==e.notifyOnLimitedConnection||!0!==e.filter?.has(r)&&(e.filter?.add(r),e.onConnect?.(r,s))}}}class Zp{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=ed({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=ed({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??ta.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){const t=e[Symbol.toStringTag];if(null==t)throw new ra("Transport must have a valid tag");if(this.transports.has(t))throw new ra(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,s]of this.listeners)for(this.log("closing listeners for %s",t);s.length>0;){const t=s.pop();null!=t&&e.push(t.close())}await Promise.all(e),this.log("all listeners closed");for(const e of this.listeners.keys())this.listeners.set(e,[]);this.started=!1}async dial(e,t){const s=this.dialTransportForMultiaddr(e);if(null==s)throw new Nd(`No transport available for address ${String(e)}`);return t?.onProgress?.(new Wa("transport-manager:selected-transport",s[Symbol.toStringTag])),s.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const s of t)e=[...e,...s.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values()){if(t.dialFilter([e]).length>0)return t}}listenTransportForMultiaddr(e){for(const t of this.transports.values()){if(t.listenFilter([e]).length>0)return t}}async listen(e){if(!this.isStarted())throw new fa("Not started");if(null==e||0===e.length)return void this.log("no addresses were provided for listening, this node is dial only");const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(e=>{t.errors.set(e.toString(),new Td)});const s=[];for(const[r,n]of this.transports.entries()){const i=n.listenFilter(e);for(const e of i){this.log("creating listener for %s on %a",r,e);const i=n.createListener({upgrader:this.components.upgrader});let o=this.listeners.get(r)??[];null==o&&(o=[],this.listeners.set(r,o)),o.push(i),i.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:i})}),i.addEventListener("close",()=>{const e=o.findIndex(e=>e===i);o.splice(e,1),this.components.events.safeDispatchEvent("transport:close",{detail:i})}),Nu.matches(e)?t.ipv4.attempts++:Ru.matches(e)&&t.ipv6.attempts++,s.push(i.listen(e).then(()=>{t.errors.delete(e.toString()),Nu.matches(e)&&t.ipv4.success++,Ru.matches(e)&&t.ipv6.success++},s=>{throw this.log.error("transport %s could not listen on address %a - %e",r,e,s),t.errors.set(e.toString(),s),s}))}}const r=await Promise.allSettled(s);if(!(r.length>0&&r.every(e=>"fulfilled"===e.status)))if(this.ipv6Unsupported(t))this.log("all IPv4 addresses succeed but all IPv6 failed");else{if(this.faultTolerance!==ta.NO_FATAL)throw new Id(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:\n${[...t.errors.entries()].map(([e,t])=>`\n  ${e}: ${`${t.stack??t}`.split("\n").join("\n  ")}\n`).join("")}`);this.log("failed to listen on any address but fault tolerance allows this")}}ipv6Unsupported(e){if(0===e.ipv4.attempts||0===e.ipv6.attempts)return!1;const t=e.ipv4.attempts===e.ipv4.success,s=0===e.ipv6.success;return t&&s}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const s=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const e=t.pop();null!=e&&s.push(e.close())}await Promise.all(s),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const ef="/multistream/1.0.0",tf=1024;let sf=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},rf=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},nf=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function of(e,t={}){const s=$p(e,t);null!=t.maxDataLength&&null==t.maxLengthLength&&(t.maxLengthLength=Di(t.maxDataLength));const r=t?.lengthDecoder??Ci,n=t?.lengthEncoder??Ii;return{read:async e=>{let n=-1;const i=new cs;for(;;){i.append(await s.read({...e,bytes:1}));try{n=r(i)}catch(e){if(e instanceof RangeError)continue;throw e}if(n<0)throw new sf("Invalid message length");if(null!=t?.maxLengthLength&&i.byteLength>t.maxLengthLength)throw new nf("message length length too long");if(n>-1)break}if(null!=t?.maxDataLength&&n>t.maxDataLength)throw new rf("message length too long");return s.read({...e,bytes:n})},write:async(e,t)=>{await s.write(new cs(n(e.byteLength),e),t)},writeV:async(e,t)=>{const r=new cs(...e.flatMap(e=>[n(e.byteLength),e]));await s.write(r,t)},unwrap:()=>s.unwrap()}}const af=Ge("\n");async function cf(e,t,s){await e.write(t,s)}async function lf(e,t){const s=await async function(e,t){const s=await e.read(t);if(0===s.byteLength||s.get(s.byteLength-1)!==af[0])throw t.log.error("Invalid mss message - missing newline",s),new da("Missing newline");return s.sublist(0,-1)}(e,t);return Qe(s.subarray())}async function hf(e,t,s){if(1===(t=Array.isArray(t)?[...t]:[t]).length&&!1===s.negotiateFully)return function(e,t,s){const r=e.sink.bind(e),n=e.source;let i=!1,o=!1;const a=jl();let c=!1,l=!1;const h=jl();let u=!1,d=!1;const p=jl(),f=of({sink:r,source:n},{...s,maxDataLength:tf});async function g(){if(o)return s.log.trace("optimistic: already negotiating %s stream",t),void await a.promise;o=!0;try{c||(s.log.trace("optimistic: doing send protocol for %s stream",t),await m()),u||(s.log.trace("optimistic: doing read protocol for %s stream",t),await y())}finally{o=!1,i=!0,a.resolve()}}async function m(){if(l)await h.promise;else{l=!0;try{s.log.trace('optimistic: write ["%s", "%s", data] in source',ef,t),await f.writeV([Ge(`${ef}\n`),Ge(`${t}\n`)]),s.log.trace('optimistic: wrote ["%s", "%s", data] in source',ef,t)}finally{c=!0,l=!1,h.resolve()}}}async function y(){if(d)await p.promise;else{d=!0;try{s.log.trace("optimistic: reading multistream select header");let e=await lf(f,s);if(s.log.trace('optimistic: read multistream select header "%s"',e),e===ef&&(e=await lf(f,s)),s.log.trace('optimistic: read protocol "%s", expecting "%s"',e,t),e!==t)throw new ua("protocol selection failed")}finally{u=!0,d=!1,p.resolve()}}}if(e.sink=async e=>{const{sink:r}=f.unwrap();await r(async function*(){let r=!1;for await(const n of e){if(l&&await h.promise,c)yield n;else{l=!0,s.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',ef,t,n.byteLength);const e=`${t}\n`;yield new cs(Uint8Array.from([19]),Ge(`${ef}\n`),Ii(e.length),Ge(e),n).subarray(),s.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',ef,t,n.byteLength),c=!0,l=!1,h.resolve(),g().catch(e=>{s.log.error("could not finish optimistic protocol negotiation of %s",t,e)})}r=!0}r||await g()}())},e.source=async function*(){await g(),s.log.trace('optimistic: reading data from "%s" stream',t),yield*f.unwrap().source}(),null!=e.closeRead){const t=e.closeRead.bind(e);e.closeRead=async e=>{i||await g().catch(e=>{s.log.error("could not negotiate protocol before close read",e)}),await t(e)}}if(null!=e.closeWrite){const t=e.closeWrite.bind(e);e.closeWrite=async e=>{i||await g().catch(e=>{s.log.error("could not negotiate protocol before close write",e)}),await t(e)}}if(null!=e.close){const t=e.close.bind(e);e.close=async e=>{const s=[];l&&s.push(h.promise),d&&s.push(p.promise),s.length>0?await ep(Promise.all(s),e?.signal):(i=!0,o=!1,a.resolve()),await t(e)}}return{stream:e,protocol:t}}(e,t[0],s);const r=of(e,{...s,maxDataLength:tf}),n=t.shift();if(null==n)throw new Error("At least one protocol must be specified");s.log.trace('select: write ["%s", "%s"]',ef,n);const i=Ge(`${ef}\n`),o=Ge(`${n}\n`);await async function(e,t,s){await e.writeV(t,s)}(r,[i,o],s),s.log.trace("select: reading multistream-select header");let a=await lf(r,s);if(s.log.trace('select: read "%s"',a),a===ef&&(s.log.trace("select: reading protocol response"),a=await lf(r,s),s.log.trace('select: read "%s"',a)),a===n)return{stream:r.unwrap(),protocol:n};for(const e of t){s.log.trace('select: write "%s"',e),await cf(r,Ge(`${e}\n`),s),s.log.trace("select: reading protocol response");const t=await lf(r,s);if(s.log.trace('select: read "%s" for "%s"',t,e),t===e)return{stream:r.unwrap(),protocol:e}}throw new ua("protocol selection failed")}const uf=4194304;let df=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},pf=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},ff=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},gf=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function mf(e){return null!=e[Symbol.asyncIterator]}function yf(e,t){if(e.byteLength>t)throw new pf("Message length too long")}const bf=e=>{const t=Di(e),s=l(t);return Ii(e,s),bf.bytes=t,s};function wf(e,t){const s=(t=t??{}).lengthEncoder??bf,r=t?.maxDataLength??uf;function*n(e){yf(e,r);const t=s(e.byteLength);t instanceof Uint8Array?yield t:yield*t,e instanceof Uint8Array?yield e:yield*e}return mf(e)?async function*(){for await(const t of e)yield*n(t)}():function*(){for(const t of e)yield*n(t)}()}var vf;bf.bytes=0,wf.single=(e,t)=>{const s=(t=t??{}).lengthEncoder??bf;return yf(e,t?.maxDataLength??uf),new cs(s(e.byteLength),e)},function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(vf||(vf={}));const Sf=e=>{const t=Ci(e);return Sf.bytes=Di(t),t};function Ef(e,t){const s=new cs;let r=vf.LENGTH,n=-1;const i=t?.lengthDecoder??Sf,o=t?.maxLengthLength??8,a=t?.maxDataLength??uf;function*c(){for(;s.byteLength>0;){if(r===vf.LENGTH)try{if(n=i(s),n<0)throw new df("Invalid message length");if(n>a)throw new pf("Message length too long");const e=i.bytes;s.consume(e),null!=t?.onLength&&t.onLength(n),r=vf.DATA}catch(e){if(e instanceof RangeError){if(s.byteLength>o)throw new ff("Message length length too long");break}throw e}if(r===vf.DATA){if(s.byteLength<n)break;const e=s.sublist(0,n);s.consume(n),null!=t?.onData&&t.onData(e),yield e,r=vf.LENGTH}}}return mf(e)?async function*(){for await(const t of e)s.append(t),yield*c();if(s.byteLength>0)throw new gf("Unexpected end of input")}():function*(){for(const t of e)s.append(t),yield*c();if(s.byteLength>0)throw new gf("Unexpected end of input")}()}async function Df(e,t,s){t=Array.isArray(t)?t:[t],s.log.trace("handle: available protocols %s",t);const r=of(e,{...s,maxDataLength:tf,maxLengthLength:2});for(;;){s.log.trace("handle: reading incoming string");const e=await lf(r,s);if(s.log.trace('handle: read "%s"',e),e!==ef){if(t.includes(e))return s.log.trace('handle: respond with "%s" for "%s"',e,e),await cf(r,Ge(`${e}\n`),s),s.log.trace('handle: responded with "%s" for "%s"',e,e),{stream:r.unwrap(),protocol:e};if("ls"===e){const n=new cs(...t.map(e=>wf.single(Ge(`${e}\n`))),Ge("\n"));s.log.trace('handle: respond with "%s" for %s',t,e),await cf(r,n,s),s.log.trace('handle: responded with "%s" for %s',t,e);continue}s.log.trace('handle: respond with "na" for "%s"',e),await cf(r,Ge("na\n"),s),s.log('handle: responded with "na" for "%s"',e)}else s.log.trace('handle: respond with "%s" for "%s"',ef,e),await cf(r,Ge(`${ef}\n`),s),s.log.trace('handle: responded with "%s" for "%s"',ef,e)}}Sf.bytes=0,Ef.fromReader=(e,t)=>{let s=1;const r=async function*(){for(;;)try{const{done:t,value:r}=await e.next(s);if(!0===t)return;null!=r&&(yield r)}catch(e){if("ERR_UNDER_READ"===e.code)return{done:!0,value:null};throw e}finally{s=1}}();return Ef(r,{...t??{},onLength:e=>{s=e}})};class _f{id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;limits;log;tags;_newStream;_close;_abort;_getStreams;constructor(e){const{remoteAddr:t,remotePeer:s,newStream:r,close:n,abort:i,getStreams:o}=e;this.id=`${parseInt(String(1e9*Math.random())).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=s,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.limits=e.limits,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),null==this.remoteAddr.getPeerId()&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=r,this._close=n,this._abort=i,this._getStreams=o,this.tags=[]}[Symbol.toStringTag]="Connection";[Go]=!0;get streams(){return this._getStreams()}async newStream(e,t){if("closing"===this.status)throw new na("the connection is being closed");if("closed"===this.status)throw new ia("the connection is closed");if(Array.isArray(e)||(e=[e]),null!=this.limits&&!0!==t?.runOnLimitedConnection)throw new ma("Cannot open protocol stream on limited connection");const s=await this._newStream(e,t);return s.direction="outbound",s}async close(e={}){if("closed"!==this.status&&"closing"!==this.status){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",null==e.signal){const t=AbortSignal.timeout(500);e={...e,signal:t}}try{this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(e){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,e),this.abort(e)}}}abort(e){"closed"!==this.status&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this._abort(e),this.status="closed",this.timeline.close=Date.now())}}function Tf(e,t,s){let r=0;return s.streams.forEach(s=>{s.direction===t&&s.protocol===e&&r++}),r}class If{components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;constructor(e,t){this.components=e,this.connectionEncrypters=ed({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(e=>{this.connectionEncrypters.set(e.protocol,e)}),this.streamMuxers=ed({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(e=>{this.streamMuxers.set(e.protocol,e)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??1e4,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??1e4,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??1e4,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){const s=this.components.connectionGater[e];if(null==s)return;if(!0===await s.apply(this.components.connectionGater,t))throw new Pd(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){return ip([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){let s=!1;const r=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),s=await ep(this.components.connectionManager.acceptIncomingConnection(e),r),!s)throw new xd("Connection denied");await ep(this.shouldBlockConnection("denyInboundConnection",e),r),await this._performUpgrade(e,"inbound",{...t,signal:r})}catch(e){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[e.name??"Error"]:!0}),e}finally{r.clear(),s&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});const s=e.remoteAddr.getPeerId();let r;null!=s&&(r=xa(s),await ep(this.shouldBlockConnection("denyOutboundConnection",r,e),t.signal));let n="outbound";return!1===t.initiator&&(n="inbound"),await this._performUpgrade(e,n,t)}catch(e){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[e.name??"Error"]:!0}),e}}async _performUpgrade(e,t,s){let r,n,i,o,a;this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t);let c=e;if(!0!==s?.skipProtection){const r=this.components.connectionProtector;null!=r&&(e.log("protecting the %s connection",t),c=await r.protect(e,s))}try{if(r=c,!0!==s?.skipEncryption){s?.onProgress?.(new Wa(`upgrader:encrypt-${t}-connection`)),({conn:r,remotePeer:n,protocol:a,streamMuxer:o}=await("inbound"===t?this._encryptInbound(c,s):this._encryptOutbound(c,s)));const e={...c,...r};await this.shouldBlockConnection("inbound"===t?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",n,e)}else{const s=e.remoteAddr.getPeerId();if(null==s)throw new ca(`${t} connection that skipped encryption must have a peer id`);const r=xa(s);a="native",n=r}if(n.equals(this.components.peerId)){const t=new aa("Can not dial self");throw e.abort(t),t}if(i=r,null!=s?.muxerFactory)o=s.muxerFactory;else if(null==o&&this.streamMuxers.size>0){s?.onProgress?.(new Wa(`upgrader:multiplex-${t}-connection`));const e=await("inbound"===t?this._multiplexInbound({...c,...r},this.streamMuxers,s):this._multiplexOutbound({...c,...r},this.streamMuxers,s));o=e.muxerFactory,i=e.stream}}catch(s){throw e.log.error("failed to upgrade inbound connection %s %a - %e","inbound"===t?"from":"to",e.remoteAddr,s),s}return await this.shouldBlockConnection("inbound"===t?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",n,e),e.log("successfully upgraded %s connection",t),this._createConnection({cryptoProtocol:a,direction:t,maConn:e,upgradedConn:i,muxerFactory:o,remotePeer:n,limits:s?.limits})}_createConnection(e){const{cryptoProtocol:t,direction:s,maConn:r,upgradedConn:n,remotePeer:i,muxerFactory:o,limits:a}=e;let c,l,h;null!=o&&(c=o.createStreamMuxer({direction:s,onIncomingStream:e=>{if(null==h)return;const t=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);Promise.resolve().then(async()=>{const s=this.components.registrar.getProtocols(),{stream:r,protocol:n}=await Df(e,s,{signal:t,log:e.log,yieldBytes:!1});if(null==h)return;h.log("incoming stream opened on %s",n);const o=function(e,t){try{const{options:s}=t.getHandler(e);return s.maxInboundStreams}catch(e){if("UnhandledProtocolError"!==e.name)throw e}return 32}(n,this.components.registrar);if(Tf(n,"inbound",h)===o){const t=new ya(`Too many inbound protocol streams for protocol "${n}" - limit ${o}`);throw e.abort(t),t}e.source=r.source,e.sink=r.sink,e.protocol=n,null!=r.closeWrite&&(e.closeWrite=r.closeWrite),null!=r.closeRead&&(e.closeRead=r.closeRead),null!=r.close&&(e.close=r.close),await this.components.peerStore.merge(i,{protocols:[n]},{signal:t}),this.components.metrics?.trackProtocolStream(e,h),this._onStream({connection:h,stream:e,protocol:n})}).catch(async s=>{h.log.error("error handling incoming stream id %s - %e",e.id,s),null==e.timeline.close&&await e.close({signal:t}).catch(t=>e.abort(t))})}}),l=async(t,r={})=>{if(null==c)throw new Ad("Connection is not multiplexed");h.log.trace("starting new stream for protocols %s",t);const n=await c.newStream();h.log.trace("started new stream %s for protocols %s",n.id,t);try{if(null==r.signal){n.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",t);const e=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);r={...r,signal:e}}n.log.trace("selecting protocol from protocols %s",t);const{stream:e,protocol:s}=await hf(n,t,{...r,log:n.log,yieldBytes:!0});n.log.trace("selected protocol %s",s);const o=function(e,t,s={}){try{const{options:s}=t.getHandler(e);if(null!=s.maxOutboundStreams)return s.maxOutboundStreams}catch(e){if("UnhandledProtocolError"!==e.name)throw e}return s.maxOutboundStreams??64}(s,this.components.registrar,r),a=Tf(s,"outbound",h);if(a>=o){const e=new ba(`Too many outbound protocol streams for protocol "${s}" - ${a}/${o}`);throw n.abort(e),e}return await this.components.peerStore.merge(i,{protocols:[s]}),n.source=e.source,n.sink=e.sink,n.protocol=s,null!=e.closeWrite&&(n.closeWrite=e.closeWrite),null!=e.closeRead&&(n.closeRead=e.closeRead),null!=e.close&&(n.close=e.close),this.components.metrics?.trackProtocolStream(n,h),n}catch(r){throw h.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e","inbound"===s?"from":"to",e.maConn.remoteAddr,t,r),null==n.timeline.close&&n.abort(r),r}},Promise.all([c.sink(n.source),n.sink(c.source)]).catch(e=>{h.log.error("error piping data through muxer - %e",e)}));const u=r.timeline;r.timeline=new Proxy(u,{set:(...e)=>("close"===e[1]&&null!=e[2]&&null==u.close&&(async()=>{try{"open"===h.status&&await h.close()}catch(e){h.log.error("error closing connection after timeline close %e",e)}finally{this.events.safeDispatchEvent("connection:close",{detail:h})}})().catch(e=>{h.log.error("error thrown while dispatching connection:close event %e",e)}),Reflect.set(...e))}),r.timeline.upgraded=Date.now();var d;return d={remoteAddr:r.remoteAddr,remotePeer:i,status:"open",direction:s,timeline:r.timeline,multiplexer:c?.protocol,encryption:t,limits:a,logger:this.components.logger,newStream:l??(()=>{throw new Ad("Connection is not multiplexed")}),getStreams:()=>c?.streams??[],close:async e=>{await(c?.close(e)),await r.close(e)},abort:e=>{r.abort(e),c?.abort(e)}},h=new _f(d),this.events.safeDispatchEvent("connection:open",{detail:h}),h.__maConnTimeline=u,h}_onStream(e){const{connection:t,stream:s,protocol:r}=e,{handler:n,options:i}=this.components.registrar.getHandler(r);if(null!=t.limits&&!0!==i.runOnLimitedConnection)throw new ma("Cannot open protocol stream on limited connection");n({connection:t,stream:s})}async _encryptInbound(e,t){const s=Array.from(this.connectionEncrypters.keys());try{const{stream:r,protocol:n}=await Df(e,s,{...t,log:e.log}),i=this.connectionEncrypters.get(n);if(null==i)throw new kd(`no crypto module found for ${n}`);return e.log("encrypting inbound connection to %a using %s",e.remoteAddr,n),{...await i.secureInbound(r,t),protocol:n}}catch(t){throw e.log.error("encrypting inbound connection from %a failed",e.remoteAddr,t),new kd(t.message)}}async _encryptOutbound(e,t){const s=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",s);const{stream:r,protocol:n}=await hf(e,s,{...t,log:e.log,yieldBytes:!0}),i=this.connectionEncrypters.get(n);if(null==i)throw new kd(`no crypto module found for ${n}`);return e.log("encrypting outbound connection to %a using %s",e.remoteAddr,n),{...await i.secureOutbound(r,t),protocol:n}}catch(t){throw e.log.error("encrypting outbound connection to %a failed",e.remoteAddr,t),new kd(t.message)}}async _multiplexOutbound(e,t,s){const r=Array.from(t.keys());e.log("outbound selecting muxer %s",r);try{e.log.trace("selecting stream muxer from %s",r);const{stream:n,protocol:i}=await hf(e,r,{...s,log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",i);return{stream:n,muxerFactory:t.get(i)}}catch(t){throw e.log.error("error multiplexing outbound connection",t),new Ad(String(t))}}async _multiplexInbound(e,t,s){const r=Array.from(t.keys());e.log("inbound handling muxers %s",r);try{const{stream:n,protocol:i}=await Df(e,r,{...s,log:e.log});return{stream:n,muxerFactory:t.get(i)}}catch(t){throw e.log.error("error multiplexing inbound connection",t),new Ad(String(t))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}const Cf="2.8.11",Pf="js-libp2p";function xf(e,t){return`${e??Pf}/${t??Cf} browser/${globalThis.navigator.userAgent}`}class Af extends ns{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";const t=new ns,s=t.dispatchEvent.bind(t);t.dispatchEvent=e=>{const t=s(e),r=this.dispatchEvent(new CustomEvent(e.type,{detail:e.detail}));return t||r},this.peerId=e.peerId,this.logger=e.logger??ml(),this.log=this.logger.forComponent("libp2p"),this.services={};const r=e.nodeInfo?.name??Pf,n=e.nodeInfo?.version??Cf,i=this.components=function(e={}){const t=new Rd(e),s=new Proxy(t,{get(e,s,r){if("string"==typeof s&&!Ld.includes(s)){const e=t.components[s];if(null==e&&!Md.includes(s))throw new yd(`${s} not set`);return e}return Reflect.get(e,s,r)},set:(e,s,r)=>("string"==typeof s?t.components[s]=r:Reflect.set(e,s,r),!0)});return s}({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:r,version:n,userAgent:e.nodeInfo?.userAgent??xf(r,n)},logger:this.logger,events:t,datastore:e.datastore??new au,connectionGater:Vd(e.connectionGater),dns:e.dns});null!=e.metrics&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",function(e,t={}){return new Zh(e,t)}(i,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),i.events.addEventListener("peer:update",e=>{if(null==e.detail.previous){const t={id:e.detail.peer.id,multiaddrs:e.detail.peer.addresses.map(e=>e.multiaddr)};i.events.safeDispatchEvent("peer:discovery",{detail:t})}}),null!=e.connectionProtector&&this.configureComponent("connectionProtector",e.connectionProtector(i)),this.components.upgrader=new If(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((e,t)=>this.configureComponent(`connection-encryption-${t}`,e(this.components))),streamMuxers:(e.streamMuxers??[]).map((e,t)=>this.configureComponent(`stream-muxers-${t}`,e(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout}),this.configureComponent("transportManager",new Zp(this.components,e.transportManager)),this.configureComponent("connectionManager",new Rp(this.components,e.connectionManager)),!1!==e.connectionMonitor?.enabled&&this.configureComponent("connectionMonitor",new qp(this.components,e.connectionMonitor)),this.configureComponent("registrar",new Jp(this.components)),this.configureComponent("addressManager",new gd(this.components,e.addresses));const o=(e.peerRouters??[]).map((e,t)=>this.configureComponent(`peer-router-${t}`,e(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new Xp(this.components,{routers:o}));const a=(e.contentRouters??[]).map((e,t)=>this.configureComponent(`content-router-${t}`,e(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new Hp(this.components,{routers:a})),this.configureComponent("randomWalk",new Yp(this.components)),(e.peerDiscovery??[]).forEach((e,t)=>{this.configureComponent(`peer-discovery-${t}`,e(this.components)).addEventListener("peer",e=>{this.#$(e)})}),e.transports?.forEach((e,t)=>{this.components.transportManager.add(this.configureComponent(`transport-${t}`,e(this.components)))}),null!=e.services)for(const t of Object.keys(e.services)){const s=(0,e.services[t])(this.components);null!=s?(this.services[t]=s,this.configureComponent(t,s),null!=s[Qo]&&(this.log("registering service %s for content routing",t),a.push(s[Qo])),null!=s[Zo]&&(this.log("registering service %s for peer routing",t),o.push(s[Zo])),null!=s[Xo]&&(this.log("registering service %s for peer discovery",t),s[Xo].addEventListener?.("peer",e=>{this.#$(e)}))):this.log.error("service factory %s returned null or undefined instance",t)}!function(e){const t={};for(const s of Object.values(e.components))for(const e of Od(s))t[e]=!0;for(const s of Object.values(e.components))for(const e of Bd(s))if(!0!==t[e])throw new bd(`Service "${Ud(s)}" required capability "${e}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}(i)}configureComponent(e,t){return null==t&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if("stopped"===this.status){this.status="starting",this.log("libp2p is starting");try{await(this.components.beforeStart?.()),await this.components.start(),await(this.components.afterStart?.()),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){"started"===this.status&&(this.log("libp2p is stopping"),this.status="stopping",await(this.components.beforeStop?.()),await this.components.stop(),await(this.components.afterStop?.()),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new El;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,s={}){if(null==t)throw new ra("no protocols were provided to open a stream");if(0===(t=Array.isArray(t)?t:[t]).length)throw new ra("no protocols were provided to open a stream");return(await this.dial(e,s)).newStream(t,s)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){Wc(e)&&(e=xa(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),null!=e.publicKey)return e.publicKey;try{const s=await this.peerStore.get(e,t);if(null!=s.id.publicKey)return s.id.publicKey}catch(e){if("NotFoundError"!==e.name)throw e}const s=u([Ge("/pk/"),e.toMultihash().bytes]),r=Ko(await this.contentRouting.get(s,t));return await this.peerStore.patch(e,{publicKey:r},t),r}async handle(e,t,s){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async e=>{await this.components.registrar.handle(e,t,s)}))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async e=>{await this.components.registrar.unhandle(e,t)}))}async register(e,t,s){return this.components.registrar.register(e,t,s)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#$(e){const{detail:t}=e;t.id.toString()!==this.peerId.toString()?this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(e=>{this.log.error(e)}):this.log.error("peer discovery mechanism discovered self")}}let kf=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},Nf=class extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}},Rf=class extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}},Mf=class extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}},Lf=class extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}},Of=class extends Error{static name="StreamBufferError";constructor(e="The stream buffer was full"){super(e),this.name="StreamBufferError"}},Bf=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}},Uf=class extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}},Vf=class extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}},Ff=class extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}},zf=class extends Event{data;constructor(e,t){super("message",t),this.data=e}},$f=class extends Event{error;local;constructor(e,t,s){super("close",s),this.error=t,this.local=e}},qf=class extends $f{constructor(e,t){super(!0,e,t)}},Wf=class extends $f{constructor(e,t){super(!1,e,t)}};const Kf=Symbol.for("@libp2p/peer-id"),jf=Symbol.for("@libp2p/transport");var Hf;!function(e){e[e.FATAL_ALL=0]="FATAL_ALL",e[e.NO_FATAL=1]="NO_FATAL"}(Hf||(Hf={}));const Gf=Symbol.for("@libp2p/service-capabilities"),Qf=Symbol.for("@libp2p/service-dependencies"),Xf=Symbol.for("nodejs.util.inspect.custom");let Yf=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[Kf]=!0;toString(){return null==this.string&&(this.string=G.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Ue.createV1(114,this.multihash)}toJSON(){return this.toString()}equals(e){if(null==e)return!1;if(e instanceof Uint8Array)return a(this.multihash.bytes,e);if("string"==typeof e)return this.toString()===e;if(null!=e?.toMultihash()?.bytes)return a(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[Xf](){return`PeerId(${this.toString()})`}},Jf=class extends Yf{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},Zf=class extends Yf{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},eg=class extends Yf{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};let tg=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=ke.digest(Ge(this.url))}[Xf](){return`PeerId(${this.url})`}[Kf]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return Ue.createV1(2336,this.toMultihash())}toJSON(){return this.toString()}equals(e){return null!=e&&(e instanceof Uint8Array&&(e=Qe(e)),e.toString()===this.toString())}};const sg=2336;function rg(e,t){let s;if("1"!==e.charAt(0)&&"Q"!==e.charAt(0)){if(e.startsWith("k51qzi5uqu5")||e.startsWith("kzwfwjn5ji4")||e.startsWith("k2k4r8")||e.startsWith("bafz"))return function(e){if(null==e?.multihash||null==e.version||1===e.version&&114!==e.code&&e.code!==sg)throw new Uf("Supplied PeerID CID is invalid");if(e.code===sg){const t=Qe(e.multihash.digest);return new tg(new URL(t))}return ng(e.multihash)}(Ue.parse(e));throw new kf('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return s=Pe(G.decode(`z${e}`)),ng(s)}function ng(e){if(function(e){return e.code===Me.code}(e))return new Jf({multihash:e});if(function(e){return e.code===ke.code}(e))try{const t=jo(e);if("Ed25519"===t.type)return new Zf({multihash:e,publicKey:t});if("secp256k1"===t.type)return new eg({multihash:e,publicKey:t})}catch(t){const s=Qe(e.digest);return new tg(new URL(s))}throw new Vf("Supplied PeerID Multihash is invalid")}let ig=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},og=class extends Error{static name="ValidationError";name="ValidationError"},ag=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"},cg=class extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"};function lg(e){return t=>Qe(t,e)}function hg(e){return t=>Ge(t,e)}function ug(e){return new DataView(e.buffer).getUint16(e.byteOffset).toString()}function dg(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,"string"==typeof e?parseInt(e):e),new Uint8Array(t)}function pg(e){const t=e.subarray(0,e.length-2),s=e.subarray(e.length-2);return`${Qe(t,"base32")}:${ug(s)}`}const fg=function(e){e=e.toString().trim();const t=new Uint8Array(4);return e.split(/\./g).forEach((e,s)=>{const r=parseInt(e,10);if(isNaN(r)||r<0||r>255)throw new ig("Invalid byte value in IP address");t[s]=r}),t};const gg=Object.values(qe).map(e=>e.decoder),mg=function(){let e=gg[0].or(gg[1]);return gg.slice(2).forEach(t=>e=e.or(t)),e}();const yg=function(...e){return t=>{for(const s of e)s(t)}}(function(e){if(parseInt(e).toString()!==e)throw new og("Value must be an integer")},function(e){if(e<0)throw new og("Value must be a positive integer, or zero")},function(e){return t=>{if(t>e)throw new og(`Value must be smaller than or equal to ${e}`)}}(65535)),bg=-1;const wg=new class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(t="string"==typeof e?this.protocolsByName.get(e):this.protocolsByCode.get(e),null==t)throw new cg(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);null!=t&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(e=>{this.protocolsByName.delete(e)}))}},vg=[{code:4,name:"ip4",size:32,valueToBytes:fg,bytesToValue:function(e){if(4!==e.byteLength)throw new ig("IPv4 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s++)t.push(e[s]);return t.join(".")},validate:e=>{if(!gc(e))throw new og(`Invalid IPv4 address "${e}"`)}},{code:6,name:"tcp",size:16,valueToBytes:dg,bytesToValue:ug,validate:yg},{code:273,name:"udp",size:16,valueToBytes:dg,bytesToValue:ug,validate:yg},{code:33,name:"dccp",size:16,valueToBytes:dg,bytesToValue:ug,validate:yg},{code:41,name:"ip6",size:128,valueToBytes:function(e){let t=0;const s=(e=e.toString().trim()).split(":",8);let r;for(r=0;r<s.length;r++){let e;gc(s[r])&&(e=fg(s[r]),s[r]=Qe(e.subarray(0,2),"base16")),null!=e&&++r<8&&s.splice(r,0,Qe(e.subarray(2,4),"base16"))}if(""===s[0])for(;s.length<8;)s.unshift("0");else if(""===s[s.length-1])for(;s.length<8;)s.push("0");else if(s.length<8){for(r=0;r<s.length&&""!==s[r];r++);const e=[r,1];for(r=9-s.length;r>0;r--)e.push("0");s.splice.apply(s,e)}const n=new Uint8Array(t+16);for(r=0;r<s.length;r++){""===s[r]&&(s[r]="0");const e=parseInt(s[r],16);if(isNaN(e)||e<0||e>65535)throw new ig("Invalid byte value in IP address");n[t++]=e>>8&255,n[t++]=255&e}return n},bytesToValue:function(e){if(16!==e.byteLength)throw new ig("IPv6 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s+=2){const r=e[s],n=e[s+1],i=`${r.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}`;t.push(i)}const s=t.join(":");try{const e=new URL(`http://[${s}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new ig(`Invalid IPv6 address "${s}"`)}},stringToValue:function(e){try{const t=new URL(`http://[${e}]`);return t.hostname.substring(1,t.hostname.length-1)}catch{throw new ig(`Invalid IPv6 address "${e}"`)}},validate:e=>{if(!mc(e))throw new og(`Invalid IPv6 address "${e}"`)}},{code:42,name:"ip6zone",size:bg},{code:43,name:"ipcidr",size:8,bytesToValue:lg("base10"),valueToBytes:hg("base10")},{code:53,name:"dns",size:bg},{code:54,name:"dns4",size:bg},{code:55,name:"dns6",size:bg},{code:56,name:"dnsaddr",size:bg},{code:132,name:"sctp",size:16,valueToBytes:dg,bytesToValue:ug,validate:yg},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:bg,stringToValue:e=>decodeURIComponent(e),valueToString:e=>encodeURIComponent(e)},{code:421,name:"p2p",aliases:["ipfs"],size:bg,bytesToValue:lg("base58btc"),valueToBytes:e=>e.startsWith("Q")||e.startsWith("1")?hg("base58btc")(e):Ue.parse(e).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:pg,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const s=Ge(t[0],"base32"),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=dg(r);return u([s,n],s.length+n.length)}},{code:445,name:"onion3",size:296,bytesToValue:pg,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const s=L.decode(`b${t[0]}`),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=dg(r);return u([s,n],s.length+n.length)}},{code:446,name:"garlic64",size:bg},{code:447,name:"garlic32",size:bg},{code:448,name:"tls"},{code:449,name:"sni",size:bg},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:bg,bytesToValue:function(e){return t=>e.encoder.encode(t)}(Z),valueToBytes:function(e){return mg.decode(e)}},{code:480,name:"http"},{code:481,name:"http-path",size:bg,stringToValue:e=>`/${decodeURIComponent(e)}`,valueToString:e=>encodeURIComponent(e.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:bg}];function Sg(e,t,s){return null==e.size||0===e.size?0:e.size>0?e.size/8:Ci(t,s)}vg.forEach(e=>{wg.addProtocol(e)});const Eg=Symbol.for("nodejs.util.inspect.custom"),Dg=Symbol.for("@multiformats/multiaddr");function _g(e){if(null==e&&(e="/"),function(e){return Boolean(e?.[Dg])}(e))return e.getComponents();if(e instanceof Uint8Array)return function(e){const t=[];let s=0;for(;s<e.length;){const r=Ci(e,s),n=wg.getProtocol(r),i=Di(r),o=Sg(n,e,s+i);let a=0;o>0&&n.size===bg&&(a=Di(o));const c=i+a+o,l={code:r,name:n.name,bytes:e.subarray(s,s+c)};if(o>0){const t=s+i+a,r=e.subarray(t,t+o);l.value=n.bytesToValue?.(r)??Qe(r)}t.push(l),s+=c}return t}(e);if("string"==typeof e)return""===(e=e.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""))&&(e="/"),function(e){if("/"!==e.charAt(0))throw new ig('String multiaddr must start with "/"');const t=[];let s="protocol",r="",n="";for(let i=1;i<e.length;i++){const o=e.charAt(i);"/"!==o&&("protocol"===s?n+=e.charAt(i):r+=e.charAt(i));const a=i===e.length-1;if("/"===o||a){const e=wg.getProtocol(n);if("protocol"===s){if(null==e.size||0===e.size){t.push({code:e.code,name:e.name}),r="",n="",s="protocol";continue}if(a)throw new ig(`Component ${n} was missing value`);s="value"}else if("value"===s){const i={code:e.code,name:e.name};if(null!=e.size&&0!==e.size){if(""===r)throw new ig(`Component ${n} was missing value`);i.value=e.stringToValue?.(r)??r}t.push(i),r="",n="",s="protocol"}}}if(""!==n&&""!==r)throw new ig("Incomplete multiaddr");return t}(e);if(Array.isArray(e))return e;throw new ig("Must be a string, Uint8Array, Component[], or another Multiaddr")}let Tg=class e{[Dg]=!0;#L;#O;#B;constructor(e="/",t={}){this.#L=_g(e),!1!==t.validate&&function(e){e.getComponents().forEach(e=>{const t=wg.getProtocol(e.code);null!=e.value&&t.validate?.(e.value)})}(this)}get bytes(){return null==this.#B&&(this.#B=function(e){let t=0;const s=[];for(const r of e){if(null==r.bytes){const e=wg.getProtocol(r.code),t=Di(r.code);let s,n=0,i=0;null!=r.value&&(s=e.valueToBytes?.(r.value)??Ge(r.value),n=s.byteLength,e.size===bg&&(i=Di(n)));const o=new Uint8Array(t+i+n);let a=0;_i(r.code,o,a),a+=t,null!=s&&(e.size===bg&&(_i(n,o,a),a+=i),o.set(s,a)),r.bytes=o}s.push(r.bytes),t+=r.bytes.byteLength}return u(s,t)}(this.#L)),this.#B}toString(){return null==this.#O&&(this.#O=`/${this.#L.flatMap(e=>{if(null==e.value)return e.name;const t=wg.getProtocol(e.code);if(null==t)throw new ig(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`),this.#O}toJSON(){return this.toString()}getComponents(){return[...this.#L.map(e=>({...e}))]}encapsulate(t){const s=new e(t);return new e([...this.#L,...s.getComponents()],{validate:!1})}decapsulate(t){const s=t.toString(),r=this.toString(),n=r.lastIndexOf(s);if(n<0)throw new ag(`Address ${this.toString()} does not contain subaddress: ${s}`);return new e(r.slice(0,n),{validate:!1})}decapsulateCode(t){let s;for(let e=this.#L.length-1;e>-1;e--)if(this.#L[e].code===t){s=e;break}return new e(this.#L.slice(0,s),{validate:!1})}equals(e){return a(this.bytes,e.bytes)}[Eg](){return`Multiaddr(${this.toString()})`}};function Ig(e){return new Tg(e)}let Cg=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},Pg=class extends Error{static name="ValidationError";name="ValidationError"},xg=class extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"};const Ag=421,kg=448,Ng=466,Rg=480,Mg=281;function Lg(e){return t=>Qe(t,e)}function Og(e){return t=>Ge(t,e)}function Bg(e){return new DataView(e.buffer).getUint16(e.byteOffset).toString()}function Ug(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,"string"==typeof e?parseInt(e):e),new Uint8Array(t)}function Vg(e){const t=e.subarray(0,e.length-2),s=e.subarray(e.length-2);return`${Qe(t,"base32")}:${Bg(s)}`}const Fg=function(e){e=e.toString().trim();const t=new Uint8Array(4);return e.split(/\./g).forEach((e,s)=>{const r=parseInt(e,10);if(isNaN(r)||r<0||r>255)throw new Cg("Invalid byte value in IP address");t[s]=r}),t};const zg=Object.values(qe).map(e=>e.decoder),$g=function(){let e=zg[0].or(zg[1]);return zg.slice(2).forEach(t=>e=e.or(t)),e}();const qg=function(...e){return t=>{for(const s of e)s(t)}}(function(e){if(parseInt(e).toString()!==e)throw new Pg("Value must be an integer")},function(e){if(e<0)throw new Pg("Value must be a positive integer, or zero")},function(e){return t=>{if(t>e)throw new Pg(`Value must be smaller than or equal to ${e}`)}}(65535)),Wg=-1;const Kg=new class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(t="string"==typeof e?this.protocolsByName.get(e):this.protocolsByCode.get(e),null==t)throw new xg(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);null!=t&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(e=>{this.protocolsByName.delete(e)}))}},jg=[{code:4,name:"ip4",size:32,valueToBytes:Fg,bytesToValue:function(e){if(4!==e.byteLength)throw new Cg("IPv4 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s++)t.push(e[s]);return t.join(".")},validate:e=>{if(!gc(e))throw new Pg(`Invalid IPv4 address "${e}"`)}},{code:6,name:"tcp",size:16,valueToBytes:Ug,bytesToValue:Bg,validate:qg},{code:273,name:"udp",size:16,valueToBytes:Ug,bytesToValue:Bg,validate:qg},{code:33,name:"dccp",size:16,valueToBytes:Ug,bytesToValue:Bg,validate:qg},{code:41,name:"ip6",size:128,valueToBytes:function(e){let t=0;const s=(e=e.toString().trim()).split(":",8);let r;for(r=0;r<s.length;r++){let e;gc(s[r])&&(e=Fg(s[r]),s[r]=Qe(e.subarray(0,2),"base16")),null!=e&&++r<8&&s.splice(r,0,Qe(e.subarray(2,4),"base16"))}if(""===s[0])for(;s.length<8;)s.unshift("0");else if(""===s[s.length-1])for(;s.length<8;)s.push("0");else if(s.length<8){for(r=0;r<s.length&&""!==s[r];r++);const e=[r,1];for(r=9-s.length;r>0;r--)e.push("0");s.splice.apply(s,e)}const n=new Uint8Array(t+16);for(r=0;r<s.length;r++){""===s[r]&&(s[r]="0");const e=parseInt(s[r],16);if(isNaN(e)||e<0||e>65535)throw new Cg("Invalid byte value in IP address");n[t++]=e>>8&255,n[t++]=255&e}return n},bytesToValue:function(e){if(16!==e.byteLength)throw new Cg("IPv6 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s+=2){const r=e[s],n=e[s+1],i=`${r.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}`;t.push(i)}const s=t.join(":");try{const e=new URL(`http://[${s}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new Cg(`Invalid IPv6 address "${s}"`)}},stringToValue:function(e){try{const t=new URL(`http://[${e}]`);return t.hostname.substring(1,t.hostname.length-1)}catch{throw new Cg(`Invalid IPv6 address "${e}"`)}},validate:e=>{if(!mc(e))throw new Pg(`Invalid IPv6 address "${e}"`)}},{code:42,name:"ip6zone",size:Wg},{code:43,name:"ipcidr",size:8,bytesToValue:Lg("base10"),valueToBytes:Og("base10")},{code:53,name:"dns",size:Wg},{code:54,name:"dns4",size:Wg},{code:55,name:"dns6",size:Wg},{code:56,name:"dnsaddr",size:Wg},{code:132,name:"sctp",size:16,valueToBytes:Ug,bytesToValue:Bg,validate:qg},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:Wg,stringToValue:e=>decodeURIComponent(e),valueToString:e=>encodeURIComponent(e)},{code:Ag,name:"p2p",aliases:["ipfs"],size:Wg,bytesToValue:Lg("base58btc"),valueToBytes:e=>e.startsWith("Q")||e.startsWith("1")?Og("base58btc")(e):Ue.parse(e).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:Vg,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const s=Ge(t[0],"base32"),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=Ug(r);return u([s,n],s.length+n.length)}},{code:445,name:"onion3",size:296,bytesToValue:Vg,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const s=L.decode(`b${t[0]}`),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=Ug(r);return u([s,n],s.length+n.length)}},{code:446,name:"garlic64",size:Wg},{code:447,name:"garlic32",size:Wg},{code:kg,name:"tls"},{code:449,name:"sni",size:Wg},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:Ng,name:"certhash",size:Wg,bytesToValue:function(e){return t=>e.encoder.encode(t)}(Z),valueToBytes:function(e){return $g.decode(e)}},{code:Rg,name:"http"},{code:481,name:"http-path",size:Wg,stringToValue:e=>`/${decodeURIComponent(e)}`,valueToString:e=>encodeURIComponent(e.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:Mg,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:Wg}];jg.forEach(e=>{Kg.addProtocol(e)});const Hg=e=>({match:t=>{const s=t[0];return null!=s&&(s.code===e&&(null==s.value&&t.slice(1)))}}),Gg=(e,t)=>({match:s=>{const r=s[0];return r?.code===e&&(null!=r.value&&((null==t||r.value===t)&&s.slice(1)))}}),Qg=e=>({match:t=>{const s=e.match(t);return!1===s?t:s}}),Xg=(...e)=>({match:t=>{let s;for(const r of e){const e=r.match(t);!1!==e&&((null==s||e.length<s.length)&&(s=e))}return null!=s&&s}}),Yg=(...e)=>({match:t=>{for(const s of e){const e=s.match(t);if(!1===e)return!1;t=e}return t}});function Jg(...e){function t(t){if(null==t)return!1;let s=t.getComponents();for(const t of e){const e=t.match(s);if(!1===e)return!1;s=e}return s}return{matchers:e,matches:function(e){return!1!==t(e)},exactMatch:function(e){const s=t(e);return!1!==s&&0===s.length}}}Jg(Gg(Ag));const Zg=Gg(54),em=Gg(55),tm=Gg(56),sm=Gg(53);Jg(Zg,Qg(Gg(Ag))),Jg(em,Qg(Gg(Ag))),Jg(tm,Qg(Gg(Ag))),Jg(Xg(sm,tm,Zg,em),Qg(Gg(Ag)));const rm=Yg(Gg(4),Qg(Gg(43))),nm=Yg(Qg(Gg(42)),Gg(41),Qg(Gg(43))),im=Xg(rm,nm),om=Xg(im,sm,Zg,em,tm),am=Jg(Xg(im,Yg(Xg(sm,tm,Zg,em),Qg(Gg(Ag)))));Jg(rm),Jg(nm),Jg(im);const cm=Yg(om,Gg(6)),lm=Yg(om,Gg(273)),hm=Jg(Yg(cm,Qg(Gg(Ag))));Jg(lm);const um=Yg(lm,Hg(460),Qg(Gg(Ag))),dm=Yg(lm,Hg(461),Qg(Gg(Ag))),pm=Xg(um,dm);Jg(um),Jg(dm);const fm=Xg(om,cm,lm,um,dm),gm=Xg(Yg(fm,Hg(477),Qg(Gg(Ag)))),mm=Jg(gm),ym=Xg(Yg(fm,Hg(478),Qg(Gg(Ag))),Yg(fm,Hg(kg),Qg(Gg(449)),Hg(477),Qg(Gg(Ag)))),bm=Jg(ym),wm=Yg(lm,Hg(280),Qg(Gg(Ng)),Qg(Gg(Ng)),Qg(Gg(Ag)));Jg(wm);const vm=Yg(dm,Hg(465),Qg(Gg(Ng)),Qg(Gg(Ng)),Qg(Gg(Ag)));Jg(vm);const Sm=Xg(gm,ym,Yg(cm,Qg(Gg(Ag))),Yg(pm,Qg(Gg(Ag))),Yg(om,Qg(Gg(Ag))),wm,vm,Gg(Ag)),Em=Jg(Sm);var Dm;const _m=Jg(Yg(Qg(Sm),Hg(290),(Dm=Hg(Mg),{match:e=>!1===Dm.match(e)&&e}),Qg(Gg(Ag)))),Tm=Jg(Xg(Yg(Sm,Hg(290),Hg(Mg),Qg(Gg(Ag))),Yg(Sm,Hg(Mg),Qg(Gg(Ag))),Yg(Hg(Mg),Qg(Gg(Ag)))));Jg(Xg(Yg(om,Gg(6),Hg(Rg),Qg(Gg(Ag))),Yg(om,Hg(Rg),Qg(Gg(Ag)))));Jg(Yg(om,Xg(Yg(Gg(6,"443"),Hg(Rg)),Yg(Gg(6),Hg(443)),Yg(Gg(6),Hg(kg),Hg(Rg)),Yg(Hg(kg),Hg(Rg)),Hg(kg),Hg(443)),Qg(Gg(Ag))));Jg(Xg(Yg(Gg(777),Qg(Gg(Ag)))));var Im;Jg(Xg(Yg(Gg(400),Qg(Gg(Ag))))),function(e){let t,s;!function(e){e.FIN="FIN",e.STOP_SENDING="STOP_SENDING",e.RESET="RESET",e.FIN_ACK="FIN_ACK"}(e.Flag||(e.Flag={})),function(e){e[e.FIN=0]="FIN",e[e.STOP_SENDING=1]="STOP_SENDING",e[e.RESET=2]="RESET",e[e.FIN_ACK=3]="FIN_ACK"}(t||(t={})),function(e){e.codec=()=>ho(t)}(e.Flag||(e.Flag={})),e.codec=()=>(null==s&&(s=uo((t,s,r={})=>{!1!==r.lengthDelimited&&s.fork(),null!=t.flag&&(s.uint32(8),e.Flag.codec().encode(t.flag,s)),null!=t.message&&(s.uint32(18),s.bytes(t.message)),!1!==r.lengthDelimited&&s.ldelim()},(t,s,r={})=>{const n={},i=null==s?t.len:t.pos+s;for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:n.flag=e.Flag.codec().decode(t);break;case 2:n.message=t.bytes();break;default:t.skipType(7&s)}}return n})),s),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(Im||(Im={}));const Cm=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"];Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890");const Pm=function(e=16384){const t=Di(e-Di(e)),s=1+Di(Object.keys(Im.Flag).length-1);return t+s+1+Di(e-t-s-1)}(),xm="/webrtc",Am="/webrtc-signaling/0.0.1";function km(e,t,s){let r;const n=new Promise((n,i)=>{if(!((s={rejectionEvents:["error"],multiArgs:!1,rejectionMultiArgs:!1,resolveImmediately:!1,...s}).count>=0)||s.count!==Number.POSITIVE_INFINITY&&!Number.isInteger(s.count))throw new TypeError("The `count` option should be at least 0 or more");s.signal?.throwIfAborted();const o=[t].flat(),a=[],{addListener:c,removeListener:l}=(e=>{const t=e.addEventListener||e.on||e.addListener,s=e.removeEventListener||e.off||e.removeListener;if(!t||!s)throw new TypeError("Emitter is not compatible");return{addListener:t.bind(e),removeListener:s.bind(e)}})(e),h=async(...e)=>{const t=s.multiArgs?e:e[0];if(s.filter)try{if(!await s.filter(t))return}catch(e){return r(),void i(e)}a.push(t),s.count===a.length&&(r(),n(a))},u=(...e)=>{r(),i(s.rejectionMultiArgs?e:e[0])};r=()=>{for(const e of o)l(e,h);for(const e of s.rejectionEvents)o.includes(e)||l(e,u)};for(const e of o)c(e,h);for(const e of s.rejectionEvents)o.includes(e)||c(e,u);s.signal&&s.signal.addEventListener("abort",()=>{u(s.signal.reason)},{once:!0}),s.resolveImmediately&&n(a)});if(n.cancel=r,"number"==typeof s.timeout){const e=Xa(n,{milliseconds:s.timeout});return e.cancel=()=>{r(),e.clear()},e}return n}function Nm(e,t,s){"function"==typeof s&&(s={filter:s});const r=km(e,t,s={...s,count:1,resolveImmediately:!1}),n=r.then(e=>e[0]);return n.cancel=r.cancel,n}let Rm=class extends Error{static name="UnexpectedEOFError";name="UnexpectedEOFError"},Mm=class extends Error{static name="MaxEarlyStreamsError";name="MaxEarlyStreamsError"},Lm=class extends Error{static name="StreamClosedError";name="StreamClosedError"};function Om(e){return e.reason}async function Bm(e,t,s){if(null==t)return e;const r=Om;if(t.aborted)return e.catch(()=>{}),Promise.reject(r(t));let n;try{return await Promise.race([e,new Promise((e,s)=>{n=()=>{s(r(t))},t.addEventListener("abort",n)})])}finally{null!=n&&t.removeEventListener("abort",n)}}const Um=4*Math.pow(2,20);let Vm=class extends ns{status;timeline;inactivityTimeout;maxReadBufferLength;maxWriteBufferLength;log;direction;maxMessageSize;readStatus;writeStatus;remoteReadStatus;remoteWriteStatus;writableNeedsDrain;readBuffer;writeBuffer;sendingData;onDrainPromise;constructor(e){super(),this.status="open",this.log=e.log,this.direction=e.direction??"outbound",this.inactivityTimeout=e.inactivityTimeout??12e4,this.maxReadBufferLength=e.maxReadBufferLength??Um,this.maxWriteBufferLength=e.maxWriteBufferLength,this.maxMessageSize=e.maxMessageSize,this.readBuffer=new cs,this.writeBuffer=new cs,this.readStatus="readable",this.remoteReadStatus="readable",this.writeStatus="writable",this.remoteWriteStatus="writable",this.sendingData=!1,this.writableNeedsDrain=!1,this.timeline={open:Date.now()},this.processSendQueue=this.processSendQueue.bind(this);this.addEventListener("drain",()=>{this.writableNeedsDrain&&(this.log.trace("drain event received, continue sending data"),this.writableNeedsDrain=!1,this.processSendQueue()),this.onDrainPromise?.resolve()});this.addEventListener("close",e=>{this.onDrainPromise?.reject(e.error??new Lm)})}get readBufferLength(){return this.readBuffer.byteLength}get writeBufferLength(){return this.writeBuffer.byteLength}async onDrain(e){return!0!==this.writableNeedsDrain?Promise.resolve():(null==this.onDrainPromise&&(this.onDrainPromise=Promise.withResolvers()),Bm(this.onDrainPromise.promise,e?.signal))}async*[Symbol.asyncIterator](){if("readable"!==this.readStatus&&"paused"!==this.readStatus)return;const e=Xl(),t=t=>{e.push(t.data)};this.addEventListener("message",t);const s=t=>{e.end(t.error)};this.addEventListener("close",s);const r=()=>{e.end()};this.addEventListener("remoteCloseWrite",r);try{yield*e}finally{this.removeEventListener("message",t),this.removeEventListener("close",s),this.removeEventListener("remoteCloseWrite",r)}}isReadable(){return"open"===this.status}send(e){if("closed"===this.writeStatus||"closing"===this.writeStatus)throw new Lf(`Cannot write to a stream that is ${this.writeStatus}`);return this.log.trace("append %d bytes to write buffer",e.byteLength),this.writeBuffer.append(e),this.processSendQueue()}abort(e){if("aborted"!==this.status&&"reset"!==this.status&&"closed"!==this.status){this.log.error("abort with error - %e",e),this.status="aborted",this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle")),this.writeStatus="closed",this.remoteWriteStatus="closed",this.readStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now();try{this.sendReset(e)}catch(e){this.log("failed to send reset to remote - %e",e)}this.dispatchEvent(new qf(e))}}pause(){if("closed"===this.readStatus||"closing"===this.readStatus)throw new Lf("Cannot pause a stream that is closing/closed");"paused"!==this.readStatus&&(this.readStatus="paused",this.sendPause())}resume(){if("closed"===this.readStatus||"closing"===this.readStatus)throw new Lf("Cannot resume a stream that is closing/closed");"readable"!==this.readStatus&&(this.readStatus="readable",this.dispatchReadBuffer(),this.sendResume())}push(e){if("closed"===this.readStatus||"closing"===this.readStatus)throw new Lf(`Cannot push data onto a stream that is ${this.readStatus}`);0!==e.byteLength&&(this.readBuffer.append(e),"paused"!==this.readStatus&&0!==this.listenerCount("message")?setTimeout(()=>{this.dispatchReadBuffer()},0):this.checkReadBufferLength())}unshift(e){if("closed"===this.readStatus||"closing"===this.readStatus)throw new Lf(`Cannot push data onto a stream that is ${this.readStatus}`);0!==e.byteLength&&(this.readBuffer.prepend(e),"paused"!==this.readStatus&&0!==this.listenerCount("message")?setTimeout(()=>{this.dispatchReadBuffer()},0):this.checkReadBufferLength())}onData(e){0!==e.byteLength&&("closing"!==this.readStatus&&"closed"!==this.readStatus?(this.readBuffer.append(e),this.dispatchReadBuffer()):this.log("ignoring data - read status %s",this.readStatus))}addEventListener(...e){super.addEventListener.apply(this,e),"message"===e[0]&&this.readBuffer.byteLength>0&&queueMicrotask(()=>{this.dispatchReadBuffer()})}onRemoteReset(){this.log("remote reset"),this.status="reset",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now(),0===this.readBuffer.byteLength&&(this.readStatus="closed");const e=new Mf;this.dispatchEvent(new Wf(e))}onTransportClosed(e){this.log("transport closed"),"readable"===this.readStatus&&0===this.readBuffer.byteLength&&(this.log("close readable end after transport closed and read buffer is empty"),this.readStatus="closed"),"closed"!==this.remoteReadStatus&&(this.remoteReadStatus="closed"),"closed"!==this.remoteWriteStatus&&(this.remoteWriteStatus="closed"),"closed"!==this.writeStatus&&(this.writeStatus="closed"),null!=e?this.abort(e):"open"!==this.status&&"closing"!==this.status||(this.timeline.close=Date.now(),this.status="closed",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.dispatchEvent(new $f))}onRemoteCloseWrite(){"closed"!==this.remoteWriteStatus&&(this.log.trace("on remote close write"),this.remoteWriteStatus="closed",this.safeDispatchEvent("remoteCloseWrite"),"closed"===this.writeStatus&&this.onTransportClosed())}onRemoteCloseRead(){this.log.trace("on remote close read"),this.remoteReadStatus="closed",this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle"))}processSendQueue(){if(this.writableNeedsDrain)return this.log.trace("not processing send queue as drain is required"),this.checkWriteBufferLength(),!1;if(0===this.writeBuffer.byteLength)return this.log.trace("not processing send queue as no bytes to send"),!0;if(this.sendingData)return this.log.trace("not processing send queue as already sending data"),!0;this.sendingData=!0,this.log.trace("processing send queue with %d queued bytes",this.writeBuffer.byteLength);try{let e=!0;const t=this.writeBuffer.byteLength;let s=0;for(;this.writeBuffer.byteLength>0;){const t=Math.min(this.maxMessageSize??this.writeBuffer.byteLength,this.writeBuffer.byteLength);if(0===t){e=!1;break}const r=this.writeBuffer.sublist(0,t),n=new cs(r);this.writeBuffer.consume(r.byteLength);const i=this.sendData(r);if(e=i.canSendMore,s+=i.sentBytes,i.sentBytes!==n.byteLength&&(n.consume(i.sentBytes),this.writeBuffer.prepend(n)),!e)break}return e||(this.log.trace("sent %d/%d bytes, pausing sending because underlying stream is full, %d bytes left in the write buffer",s,t,this.writeBuffer.byteLength),this.writableNeedsDrain=!0,this.checkWriteBufferLength()),0===this.writeBuffer.byteLength&&this.safeDispatchEvent("idle"),e}finally{this.sendingData=!1}}dispatchReadBuffer(){try{if(0===this.listenerCount("message"))return void this.log.trace("not dispatching pause buffer as there are no listeners for the message event");if(0===this.readBuffer.byteLength)return void this.log.trace("not dispatching pause buffer as there is no data to dispatch");if("paused"===this.readStatus)return void this.log.trace("not dispatching pause buffer we are paused");if("closing"===this.readStatus||"closed"===this.readStatus)return this.log("dropping %d bytes because the readable end is %s",this.readBuffer.byteLength,this.readStatus),void this.readBuffer.consume(this.readBuffer.byteLength);const e=this.readBuffer.sublist();this.readBuffer.consume(e.byteLength),this.dispatchEvent(new zf(e))}finally{0===this.readBuffer.byteLength&&"closed"===this.remoteWriteStatus&&(this.log("close readable end after dispatching read buffer and remote writable end is closed"),this.readStatus="closed"),this.checkReadBufferLength()}}checkReadBufferLength(){this.readBuffer.byteLength>this.maxReadBufferLength&&this.abort(new Of(`Read buffer length of ${this.readBuffer.byteLength} exceeded limit of ${this.maxReadBufferLength}, read status is ${this.readStatus}`))}checkWriteBufferLength(){null!=this.maxWriteBufferLength&&this.writeBuffer.byteLength>this.maxWriteBufferLength&&this.abort(new Of(`Write buffer length of ${this.writeBuffer.byteLength} exceeded limit of ${this.maxWriteBufferLength}, write status is ${this.writeStatus}`))}onMuxerNeedsDrain(){this.writableNeedsDrain=!0}onMuxerDrain(){this.safeDispatchEvent("drain")}},Fm=class extends Vm{remoteAddr;metricPrefix;metrics;constructor(e){super(e),this.metricPrefix=e.metricPrefix??"",this.metrics=e.metrics,this.remoteAddr=e.remoteAddr,this.addEventListener("close",e=>{this.metrics?.increment({[`${this.metricPrefix}end`]:!0}),null!=e.error?e.local?this.metrics?.increment({[`${this.metricPrefix}abort`]:!0}):this.metrics?.increment({[`${this.metricPrefix}reset`]:!0}):e.local?this.metrics?.increment({[`${this.metricPrefix}_local_close`]:!0}):this.metrics?.increment({[`${this.metricPrefix}_remote_close`]:!0})})}async close(e){"open"===this.status&&(this.status="closing",this.writeStatus="closing",this.remoteWriteStatus="closing",this.remoteReadStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await Nm(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await Nm(this,"drain",{...e,rejectionEvents:["close"]})),await this.sendClose(e),this.onTransportClosed())}};let zm=class extends ns{streams;protocol;status;log;maConn;streamOptions;earlyStreams;maxEarlyStreams;metrics;constructor(e,t){super(),this.maConn=e,this.protocol=t.protocol,this.streams=[],this.earlyStreams=[],this.status="open",this.log=e.log.newScope(t.name),this.streamOptions=t.streamOptions,this.maxEarlyStreams=t.maxEarlyStreams??10,this.metrics=t.metrics;this.maConn.addEventListener("message",e=>{try{this.onData(e.data)}catch(e){this.abort(e),this.maConn.abort(e)}});this.maConn.addEventListener("drain",()=>{this.log("underlying stream drained, signal %d streams to continue writing",this.streams.length),this.streams.forEach(e=>{e.onMuxerDrain()})});this.maConn.addEventListener("close",()=>{this.log("underlying stream closed with status %s and %d streams",this.status,this.streams.length),this.onTransportClosed()})}send(e){const t=this.maConn.send(e);return!1===t&&(this.log("underlying stream saturated, signal %d streams to pause writing",this.streams.length),this.streams.forEach(e=>{e.onMuxerNeedsDrain()})),t}async close(e){"closed"!==this.status&&"closing"!==this.status&&(this.status="closing",await Bm(Promise.all([...this.streams].map(async t=>{await t.close(e)})),e?.signal),this.status="closed")}abort(e){"closed"!==this.status&&(this.status="closing",[...this.streams].forEach(t=>{t.abort(e)}),this.status="closed")}onTransportClosed(e){this.status="closing";try{[...this.streams].forEach(t=>{t.onTransportClosed(e)})}catch(e){this.abort(e)}this.status="closed"}async createStream(e){if("open"!==this.status)throw new Rf;let t=this.onCreateStream({...this.streamOptions,...e});var s;return null!=(s=t)&&"function"==typeof s.then&&"function"==typeof s.catch&&"function"==typeof s.finally&&(t=await t),this.streams.push(t),this.cleanUpStream(t),t}onRemoteStream(e){if(this.streams.push(e),this.cleanUpStream(e),0===this.listenerCount("stream"))return this.earlyStreams.push(e),void(this.earlyStreams.length>this.maxEarlyStreams&&this.abort(new Mm(`Too many early streams were opened - ${this.earlyStreams.length}/${this.maxEarlyStreams}`)));this.safeDispatchEvent("stream",{detail:e})}cleanUpStream(e){e.addEventListener("close",t=>{const s=this.streams.findIndex(t=>t===e);-1!==s&&this.streams.splice(s,1),null!=t.error?t.local?this.metrics?.increment({[`${e.direction}_stream_reset`]:!0}):this.metrics?.increment({[`${e.direction}_stream_abort`]:!0}):this.metrics?.increment({[`${e.direction}_stream_end`]:!0})}),this.metrics?.increment({[`${e.direction}_stream`]:!0})}addEventListener(...e){super.addEventListener.apply(this,e),"stream"===e[0]&&this.earlyStreams.length>0&&queueMicrotask(()=>{this.earlyStreams.forEach(e=>{this.safeDispatchEvent("stream",{detail:e})}),this.earlyStreams=[]})}},$m=class extends Vm{id;protocol;constructor(e){super(e),this.id=e.id,this.protocol=e.protocol??""}async close(e){"closing"!==this.writeStatus&&"closed"!==this.writeStatus&&(this.writeStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await Nm(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData),await Nm(this,"drain",{...e,rejectionEvents:["close"]}),this.log("write queue drained, closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData)),await this.sendCloseWrite(e),this.writeStatus="closed",this.log("closed writable end gracefully"),"closed"===this.remoteWriteStatus&&this.onTransportClosed())}async closeRead(e){"closing"!==this.readStatus&&"closed"!==this.readStatus&&(this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.readStatus="closing",await this.sendCloseRead(e),this.readStatus="closed",this.log("closed readable end gracefully"))}};function qm(e,...t){if(null==e)throw new Error("Empty pipeline");if(Hm(e)){const t=e;e=()=>t.source}else if(jm(e)||Km(e)){const t=e;e=()=>t}const s=[e,...t];if(s.length>1&&Hm(s[s.length-1])&&(s[s.length-1]=s[s.length-1].sink),s.length>2)for(let e=1;e<s.length-1;e++)Hm(s[e])&&(s[e]=Gm(s[e]));return Wm(...s)}const Wm=(...e)=>{let t;for(;e.length>0;)t=e.shift()(t);return t},Km=e=>null!=e?.[Symbol.asyncIterator],jm=e=>null!=e?.[Symbol.iterator],Hm=e=>null!=e&&(null!=e.sink&&null!=e.source),Gm=e=>t=>{const s=e.sink(t);if(null!=s?.then){const t=Xl({objectMode:!0});let r;s.then(()=>{t.end()},e=>{t.end(e)});const n=e.source;if(Km(n))r=async function*(){yield*n,t.end()};else{if(!jm(n))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");r=function*(){yield*n,t.end()}}return jp(t,r())}return e.source};let Qm=class extends Error{static name="UnwrappedError";name="UnwrappedError"},Xm=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},Ym=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},Jm=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function Zm(e){return function(e){return"function"==typeof e?.closeRead}(e)?"writable"!==e.remoteWriteStatus&&0===e.readBufferLength:!!function(e){return"function"==typeof e?.close}(e)&&"open"!==e.status}function ey(e,t={}){const s=function(e,t){const s=t?.maxBufferSize??4194304,r=new cs;let n,i=!1;if(o=e,null==o?.addEventListener||null==o?.removeEventListener||null==o?.send||null==o?.push||null==o?.log)throw new kf("Argument should be a Stream or a Multiaddr");var o;const a=e=>{if(r.append(e.data),r.byteLength>s){const e=r.byteLength;r.consume(r.byteLength),n?.reject(new Error(`Read buffer overflow - ${e} > ${s}`))}n?.resolve()};e.addEventListener("message",a);const c=e=>{null!=e.error?n?.reject(e.error):n?.resolve()};e.addEventListener("close",c);const l=()=>{n?.resolve()};e.addEventListener("remoteCloseWrite",l);const h={readBuffer:r,async read(t){if(!0===i)throw new Qm("Stream was unwrapped");if(Zm(e)){if(null==t?.bytes)return null;if(r.byteLength<t.bytes)throw e.log.error("closed after reading %d/%d bytes",r.byteLength,t.bytes),new Rm(`Unexpected EOF - stream closed after reading ${r.byteLength}/${t.bytes} bytes`)}const s=t?.bytes??1;for(n=Promise.withResolvers();;){if(r.byteLength>=s){n.resolve();break}if(await Bm(n.promise,t?.signal),Zm(e)){if(0===r.byteLength&&null==t?.bytes)return null;break}n=Promise.withResolvers()}const o=t?.bytes??r.byteLength;if(r.byteLength<o){if(Zm(e))throw e.log.error("closed while reading %d/%d bytes",r.byteLength,o),new Rm(`Unexpected EOF - stream closed while reading ${r.byteLength}/${o} bytes`);return h.read(t)}const a=r.sublist(0,o);return r.consume(o),a},async write(t,s){if(!0===i)throw new Qm("Stream was unwrapped");e.send(t)||await Nm(e,"drain",{signal:s?.signal,rejectionEvents:["close"]})},unwrap:()=>(i||(i=!0,e.removeEventListener("message",a),e.removeEventListener("close",c),e.removeEventListener("remoteCloseWrite",l),r.byteLength>0&&(e.log("stream unwrapped with %d unread bytes",r.byteLength),e.push(r))),e)};return h}(e,t);null!=t.maxDataLength&&null==t.maxLengthLength&&(t.maxLengthLength=Di(t.maxDataLength));const r=t?.lengthDecoder??Ci,n=t?.lengthEncoder??Ii;return{async read(n){let i=-1;const o=new cs;for(;;){const e=await s.read({...n,bytes:1});if(null==e)break;o.append(e);try{i=r(o)}catch(e){if(e instanceof RangeError)continue;throw e}if(i<0)throw new Xm("Invalid message length");if(null!=t?.maxLengthLength&&o.byteLength>t.maxLengthLength)throw new Jm(`Message length length too long - ${o.byteLength} > ${t.maxLengthLength}`);if(i>-1)break}if(null!=t?.maxDataLength&&i>t.maxDataLength)throw new Ym(`Message length too long - ${i} > ${t.maxDataLength}`);const a=await s.read({...n,bytes:i});if(null==a)throw e.log.error("tried to read %d bytes but the stream closed",i),new Rm(`Unexpected EOF - tried to read ${i} bytes but the stream closed`);if(a.byteLength!==i)throw e.log.error("read %d/%d bytes before the stream closed",a.byteLength,i),new Rm(`Unexpected EOF - read ${a.byteLength}/${i} bytes before the stream closed`);return a},async write(e,t){await s.write(new cs(n(e.byteLength),e),t)},async writeV(e,t){const r=new cs(...e.flatMap(e=>[n(e.byteLength),e]));await s.write(r,t)},unwrap:()=>s.unwrap()}}function ty(e,t){const s=ey(e,t),r={read:async(e,t)=>{const r=await s.read(t);return e.decode(r)},write:async(e,t,r)=>{await s.write(t.encode(e),r)},writeV:async(e,t,r)=>{await s.writeV(e.map(e=>t.encode(e)),r)},pb:e=>({read:async t=>r.read(e,t),write:async(t,s)=>r.write(t,e,s),writeV:async(t,s)=>r.writeV(t,e,s),unwrap:()=>r}),unwrap:()=>s.unwrap()};return r}var sy=function(e,t,s){if(s||2===arguments.length)for(var r,n=0,i=t.length;n<i;n++)!r&&n in t||(r||(r=Array.prototype.slice.call(t,0,n)),r[n]=t[n]);return e.concat(r||Array.prototype.slice.call(t))},ry=function(e,t,s){this.name=e,this.version=t,this.os=s,this.type="browser"},ny=function(e){this.version=e,this.type="node",this.name="node",this.os=process.platform},iy=function(e,t,s,r){this.name=e,this.version=t,this.os=s,this.bot=r,this.type="bot-device"},oy=function(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null},ay=function(){this.type="react-native",this.name="react-native",this.version=null,this.os=null},cy=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,ly=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/]],hy=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];const uy="undefined"==typeof document&&"undefined"!=typeof navigator&&"ReactNative"===navigator.product?new ay:"undefined"!=typeof navigator?function(e){var t=function(e){return""!==e&&ly.reduce(function(t,s){var r=s[0],n=s[1];if(t)return t;var i=n.exec(e);return!!i&&[r,i]},!1)}(e);if(!t)return null;var s=t[0],r=t[1];if("searchbot"===s)return new oy;var n=r[1]&&r[1].split(".").join("_").split("_").slice(0,3);n?n.length<3&&(n=sy(sy([],n,!0),function(e){for(var t=[],s=0;s<e;s++)t.push("0");return t}(3-n.length),!0)):n=[];var i=n.join("."),o=function(e){for(var t=0,s=hy.length;t<s;t++){var r=hy[t],n=r[0];if(r[1].exec(e))return n}return null}(e),a=cy.exec(e);return a&&a[1]?new iy(s,i,o,a[1]):new ry(s,i,o)}(navigator.userAgent):function(){var e="undefined"!=typeof process&&process.version;return e?new ny(process.version.slice(1)):null}(),dy=null!=uy&&"firefox"===uy.name;async function py(e){return"function"==typeof(e=e??{})&&(e=await e()),e.iceServers=e.iceServers??Cm.map(e=>({urls:[e]})),e}class fy extends $m{channel;incomingData;maxBufferedAmount;receivedFinAck;finAckTimeout;constructor(e){super({...e,maxMessageSize:(e.maxMessageSize??16384)-Pm}),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=Xl(),this.maxBufferedAmount=e.maxBufferedAmount??2097152,this.finAckTimeout=e.finAckTimeout??1e4,this.channel.onclose=()=>{this.log.trace("received datachannel close event"),this.onRemoteCloseWrite(),this.onTransportClosed()},this.channel.onerror=e=>{const t=e.error;this.log.trace("received datachannel error event - %e",t),this.abort(t)},this.channel.onmessage=async e=>{this.log("incoming message %d bytes",e.data.byteLength);const{data:t}=e;null!==t&&0!==t.byteLength&&this.incomingData.push(new Uint8Array(t,0,t.byteLength))},this.channel.bufferedAmountLowThreshold=0,this.channel.onbufferedamountlow=()=>{this.writableNeedsDrain&&this.safeDispatchEvent("drain")},Promise.resolve().then(async()=>{for await(const e of Ef(this.incomingData))this.processIncomingProtobuf(e)}).catch(e=>{this.log.error("error processing incoming data channel messages - %e",e)});this.addEventListener("close",()=>{"open"===this.channel.readyState&&(this.log.trace("stream closed, closing underlying datachannel"),this.channel.close())}),"open"!==this.channel.readyState&&(this.log('channel ready state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),Nm(this.channel,"open",{rejectionEvents:["close","error"]}).then(()=>{this.log('channel ready state is now "%s", dispatching drain',this.channel.readyState),this.safeDispatchEvent("drain")}).catch(e=>{this.abort(e.error??e)}))}sendNewStream(){}_sendMessage(e){if("open"!==this.channel.readyState)throw new Lf(`Invalid datachannel state - ${this.channel.readyState}`);if(this.log.trace('sending message, channel state "%s"',this.channel.readyState),dy)this.channel.send(e.subarray());else for(const t of e)this.channel.send(t)}sendData(e){return"open"!==this.channel.readyState?{sentBytes:0,canSendMore:!1}:(this._sendMessage(wf.single(Im.encode({message:e.subarray()}))),{sentBytes:e.byteLength,canSendMore:this.channel.bufferedAmount<this.maxBufferedAmount})}sendReset(e){try{this.log.error("sending reset - %e",e),this._sendFlag(Im.Flag.RESET),this.receivedFinAck?.reject(e)}catch(e){this.log.error("failed to send reset - %e",e)}}async sendCloseWrite(e){this._sendFlag(Im.Flag.FIN),e?.signal?.throwIfAborted(),this.receivedFinAck=Promise.withResolvers();const t=e?.signal??AbortSignal.timeout(this.finAckTimeout),s=[Nm(this.channel,"close",{signal:t}),Nm(this.channel,"error",{signal:t})];await Promise.any([Bm(this.receivedFinAck.promise,t),...s]).finally(()=>{s.forEach(e=>e.cancel())})}async sendCloseRead(e){this._sendFlag(Im.Flag.STOP_SENDING),e?.signal?.throwIfAborted()}processIncomingProtobuf(e){const t=Im.decode(e);null==t.message||"readable"!==this.readStatus&&"paused"!==this.readStatus||this.onData(new cs(t.message)),void 0!==t.flag&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===Im.Flag.FIN&&(this._sendFlag(Im.Flag.FIN_ACK),this.onRemoteCloseWrite()),t.flag===Im.Flag.RESET&&(this.receivedFinAck?.reject(new Mf("The stream was reset")),this.onRemoteReset()),t.flag===Im.Flag.STOP_SENDING&&this.onRemoteCloseRead(),t.flag===Im.Flag.FIN_ACK&&this.receivedFinAck?.resolve())}_sendFlag(e){if("open"!==this.channel.readyState)return this.log.trace('not sending flag %s because channel is "%s" and not "open"',e.toString(),this.channel.readyState),!1;this.log.trace("sending flag %s",e.toString());const t=Im.encode({flag:e}),s=wf.single(t);try{return this._sendMessage(s),!0}catch(t){this.log.error("could not send flag %s - %e",e.toString(),t)}return!1}sendPause(){}sendResume(){}}function gy(e){const{channel:t,direction:s,isHandshake:r}=e;return new fy({...e,id:`${t.id}`,log:e.log.newScope(`${!0===r?"handshake":s}:${t.id}`),protocol:""})}class my{protocol;peerConnection;metrics;dataChannelOptions;earlyDataChannels;constructor(e){this.onEarlyDataChannel=this.onEarlyDataChannel.bind(this),this.peerConnection=e.peerConnection,this.metrics=e.metrics,this.protocol=e.protocol??xm,this.dataChannelOptions=e.dataChannelOptions??{},this.peerConnection.addEventListener("datachannel",this.onEarlyDataChannel),this.earlyDataChannels=[]}onEarlyDataChannel(e){this.earlyDataChannels.push(e.channel)}createStreamMuxer(e){return this.peerConnection.removeEventListener("datachannel",this.onEarlyDataChannel),new yy(e,{peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,protocol:this.protocol,earlyDataChannels:this.earlyDataChannels})}}class yy extends zm{peerConnection;dataChannelOptions;constructor(e,t){super(e,{...t,name:"muxer"}),this.peerConnection=t.peerConnection,this.protocol=t.protocol??xm,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:e})=>{this.onDataChannel(e)},queueMicrotask(()=>{"open"===this.status?t.earlyDataChannels.forEach(e=>{this.onDataChannel(e)}):t.earlyDataChannels.forEach(e=>{e.close()})})}onDataChannel(e){if(this.log("incoming datachannel with channel id %d, protocol %s and status %s",e.id,e.protocol,e.readyState),"init"===e.label)return this.log.trace("closing init channel %d",e.id),void e.close();const t=gy({...this.streamOptions,...this.dataChannelOptions,channel:e,direction:"inbound",log:this.log});this.onRemoteStream(t)}async onCreateStream(e){const t=this.peerConnection.createDataChannel("",{});this.log("open channel %d for protocol %s",t.id,e?.protocol);return gy({...e,...this.dataChannelOptions,channel:t,direction:"outbound",log:this.log})}onData(){}}class by extends Fm{peerConnection;constructor(e){super(e),this.peerConnection=e.peerConnection;const t=e.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change %s initial state %s",this.peerConnection.connectionState,t),"disconnected"!==this.peerConnection.connectionState&&"failed"!==this.peerConnection.connectionState&&"closed"!==this.peerConnection.connectionState||(this.onTransportClosed(),this.peerConnection.close())}}sendData(e){return{sentBytes:e.byteLength,canSendMore:!0}}async sendClose(e){this.peerConnection.close(),e?.signal?.throwIfAborted()}sendReset(){this.peerConnection.close()}sendPause(){}sendResume(){}}const wy=e=>new by(e),vy=globalThis.RTCPeerConnection,Sy=globalThis.RTCSessionDescription,Ey=globalThis.RTCIceCandidate;class Dy extends Error{constructor(e){super(`WebRTC transport error: ${e}`),this.name="WebRTCTransportError"}}class _y extends Dy{constructor(e="SDP handshake failed"){super(e),this.name="SDPHandshakeFailedError"}}var Ty;!function(e){var t;let s,r;(t=e.Type||(e.Type={})).SDP_OFFER="SDP_OFFER",t.SDP_ANSWER="SDP_ANSWER",t.ICE_CANDIDATE="ICE_CANDIDATE",function(e){e[e.SDP_OFFER=0]="SDP_OFFER",e[e.SDP_ANSWER=1]="SDP_ANSWER",e[e.ICE_CANDIDATE=2]="ICE_CANDIDATE"}(s||(s={})),function(e){e.codec=()=>ho(s)}(e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=uo((t,s,r={})=>{!1!==r.lengthDelimited&&s.fork(),null!=t.type&&(s.uint32(8),e.Type.codec().encode(t.type,s)),null!=t.data&&(s.uint32(18),s.string(t.data)),!1!==r.lengthDelimited&&s.ldelim()},(t,s,r={})=>{const n={},i=null==s?t.len:t.pos+s;for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:n.type=e.Type.codec().decode(t);break;case 2:n.data=t.string();break;default:t.skipType(7&s)}}return n})),r),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(Ty||(Ty={}));const Iy=async(e,t,s)=>{try{const r=Promise.withResolvers();for(!function(e,t){if("connected"===e.connectionState)return void t.resolve();e.onconnectionstatechange=s=>{switch(e.connectionState){case"connected":t.resolve();break;case"failed":case"disconnected":case"closed":t.reject(new Nf(`RTCPeerConnection connection state became "${e.connectionState}"`))}}}(e,r);;){const n=await Promise.race([r.promise,t.read({signal:s.signal})]);if(null==n){s.signal?.throwIfAborted();break}if(n.type!==Ty.Type.ICE_CANDIDATE)throw new Ff("ICE candidate message expected");const i=JSON.parse(n.data??"null");if(""===i||null===i){s.onProgress?.(new Wa("webrtc:end-of-ice-candidates")),s.log.trace("end-of-candidates received");continue}const o=new Ey(i);s.log.trace("%s received new ICE candidate %o",s.direction,i);try{s.onProgress?.(new Wa("webrtc:add-ice-candidate",o.candidate)),await e.addIceCandidate(o)}catch(e){s.log.error("%s bad candidate received %o - %e",s.direction,i,e)}}}catch(t){if(s.log.error("%s error parsing ICE candidate - %e",s.direction,t),!0===s.signal?.aborted&&"connected"!==e.connectionState)throw t}};function Cy(e){let t;for(const s of e.getComponents())"p2p"===s.name&&(t=rg(s.value??""));if(null==t)throw new Bf("Remote peerId must be present in multiaddr");return t}async function Py({rtcConfiguration:e,dataChannel:t,signal:s,metrics:r,multiaddr:n,connectionManager:i,transportManager:o,log:a,logger:c,onProgress:l}){const{circuitAddress:h,targetPeer:u}=function(e){const t=e.getComponents().filter(({name:e})=>"p2p"===e).map(({value:e})=>e).pop();if(null==t)throw new kf("Destination peer id was missing");const s=Ig(e.getComponents().filter(({name:e})=>"webrtc"!==e));return{circuitAddress:s,targetPeer:rg(t)}}(n);r?.dialerEvents.increment({open:!0}),a.trace("dialing circuit address: %a",h);const d=i.getConnections(u);let p;0===d.length?(l?.(new Wa("webrtc:dial-relay")),p=await o.dial(h,{signal:s,onProgress:l})):(l?.(new Wa("webrtc:reuse-relay-connection")),p=d[0]),l?.(new Wa("webrtc:open-signaling-stream"));const f=await p.newStream(Am,{signal:s,runOnLimitedConnection:!0}),g=ty(f).pb(Ty),m=new vy(e);m.addEventListener("connectionstatechange",()=>{if("closed"===m.connectionState)m.close()});const y=new my({peerConnection:m,dataChannelOptions:t});try{const e=m.createDataChannel("init");m.onicecandidate=({candidate:e})=>{if("connected"===m.connectionState)return void a.trace("ignore new ice candidate as peer connection is already connected");if(null==e||""===e?.candidate)return void a.trace("initiator detected end of ICE candidates");const t=JSON.stringify(e?.toJSON()??null);a.trace("initiator sending ICE candidate %o",e),g.write({type:Ty.Type.ICE_CANDIDATE,data:t},{signal:s}).catch(e=>{a.error("error sending ICE candidate - %e",e)})},m.onicecandidateerror=e=>{a.error("initiator ICE candidate error",e)};const t=await m.createOffer().catch(e=>{throw a.error("could not execute createOffer - %e",e),new _y("Failed to set createOffer")});a.trace("initiator send SDP offer %s",t.sdp),l?.(new Wa("webrtc:send-sdp-offer")),await g.write({type:Ty.Type.SDP_OFFER,data:t.sdp},{signal:s}),await m.setLocalDescription(t).catch(e=>{throw a.error("could not execute setLocalDescription - %e",e),new _y("Failed to set localDescription")}),l?.(new Wa("webrtc:read-sdp-answer")),a.trace("initiator read SDP answer");const r=await g.read({signal:s});if(r.type!==Ty.Type.SDP_ANSWER)throw new _y("Remote should send an SDP answer");a.trace("initiator received SDP answer %s",r.data);const i=new Sy({type:"answer",sdp:r.data});return await m.setRemoteDescription(i).catch(e=>{throw a.error("could not execute setRemoteDescription - %e",e),new _y("Failed to set remoteDescription")}),a.trace("initiator read candidates until connected"),l?.(new Wa("webrtc:read-ice-candidates")),await Iy(m,g,{direction:"initiator",signal:s,log:a,onProgress:l}),a.trace("initiator connected"),"open"!==e.readyState&&(a.trace("wait for init channel to open"),await Nm(e,"open",{signal:s})),a.trace("closing init channel"),e.close(),a.trace("waiting for init channel to close"),await Nm(e,"close",{signal:s}),l?.(new Wa("webrtc:close-signaling-stream")),a.trace("closing signaling channel"),await f.close({signal:s}),a.trace("initiator connected to remote address %s",n),{remoteAddress:n,peerConnection:m,muxerFactory:y}}catch(e){throw a.error("outgoing signaling error - %e",e),m.close(),f.abort(e),e}finally{m.onicecandidate=null,m.onicecandidateerror=null}}const xy=Jg(Em.matchers[0],Hg(290));class Ay extends ns{transportManager;shutdownController;events;constructor(e,t){super(),this.transportManager=e.transportManager,this.events=e.events,this.shutdownController=t.shutdownController,this.onTransportListening=this.onTransportListening.bind(this)}async listen(){this.events.addEventListener("transport:listening",this.onTransportListening)}onTransportListening(e){e.detail.getAddrs().filter(e=>xy.exactMatch(e)).map(e=>e.encapsulate("/webrtc")).length>0&&this.safeDispatchEvent("listening")}getAddrs(){return this.transportManager.getListeners().filter(e=>!(e instanceof Ay)).map(e=>e.getAddrs().filter(e=>xy.exactMatch(e)).map(e=>e.encapsulate("/webrtc"))).flat()}updateAnnounceAddrs(){}async close(){this.events.removeEventListener("transport:listening",this.onTransportListening),this.shutdownController.abort(),queueMicrotask(()=>{this.safeDispatchEvent("close")})}}class ky{components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}[jf]=!0;[Symbol.toStringTag]="@libp2p/webrtc";[Gf]=["@libp2p/transport"];[Qf]=["@libp2p/identify","@libp2p/circuit-relay-v2-transport"];isStarted(){return this._started}async start(){await this.components.registrar.handle(Am,(e,t)=>{const s=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);this._onProtocol(e,t,s).catch(e=>{this.log.error("failed to handle incoming connect from %p - %e",t.remotePeer,e)}).finally(()=>{s.clear()})},{runOnLimitedConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(Am),this._started=!1}createListener(e){return new Ay(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(Tm.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);const{remoteAddress:s,peerConnection:r,muxerFactory:n}=await Py({rtcConfiguration:await py(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),i=wy({peerConnection:r,remoteAddr:s,metrics:this.metrics?.dialerEvents,direction:"outbound",log:this.components.logger.forComponent("libp2p:webrtc:connection")}),o=await t.upgrader.upgradeOutbound(i,{skipProtection:!0,skipEncryption:!0,remotePeer:Cy(e),muxerFactory:n,onProgress:t.onProgress,signal:t.signal});return this._closeOnShutdown(r,i),o}async _onProtocol(e,t,s){const r=new vy(await py(this.init.rtcConfiguration));r.addEventListener("connectionstatechange",()=>{if("closed"===r.connectionState)r.close()});const n=new my({peerConnection:r,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:i,remotePeer:o}=await async function(e,t,{peerConnection:s,signal:r,log:n}){n.trace("new inbound signaling stream");const i=ty(e).pb(Ty);try{s.onicecandidate=({candidate:e})=>{if("connected"===s.connectionState)return void n.trace("ignore new ice candidate as peer connection is already connected");if(null==e||""===e?.candidate)return void n.trace("recipient detected end of ICE candidates");const t=JSON.stringify(e?.toJSON()??null);n.trace("recipient sending ICE candidate %s",t),i.write({type:Ty.Type.ICE_CANDIDATE,data:t},{signal:r}).catch(e=>{n.error("error sending ICE candidate - %e",e)})},n.trace("recipient read SDP offer");const e=await i.read({signal:r});if(e.type!==Ty.Type.SDP_OFFER)throw new _y(`expected message type SDP_OFFER, received: ${e.type??"undefined"} `);n.trace("recipient received SDP offer %s",e.data);const t=new Sy({type:"offer",sdp:e.data});await s.setRemoteDescription(t).catch(e=>{throw n.error("could not execute setRemoteDescription - %e",e),new _y("Failed to set remoteDescription")});const o=await s.createAnswer().catch(e=>{throw n.error("could not execute createAnswer - %e",e),new _y("Failed to create answer")});n.trace("recipient send SDP answer %s",o.sdp),await i.write({type:Ty.Type.SDP_ANSWER,data:o.sdp},{signal:r}),await s.setLocalDescription(o).catch(e=>{throw n.error("could not execute setLocalDescription - %e",e),new _y("Failed to set localDescription")}),n.trace("recipient read candidates until connected"),await Iy(s,i,{direction:"recipient",signal:r,log:n})}catch(e){if("connected"!==s.connectionState)throw n.error("error while handling signaling stream from peer %a - %e",t.remoteAddr,e),s.close(),e;n("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",t.remoteAddr,e)}const o=Cy(t.remoteAddr),a=Ig(`/webrtc/p2p/${o}`);return n.trace("recipient connected to remote address %s",a),{remoteAddress:a,remotePeer:o}}(e,t,{peerConnection:r,signal:s,log:this.log});await e.close({signal:s});const a=wy({peerConnection:r,remoteAddr:i,metrics:this.metrics?.listenerEvents,direction:"inbound",log:this.components.logger.forComponent("libp2p:webrtc:connection")});await this.components.upgrader.upgradeInbound(a,{skipEncryption:!0,skipProtection:!0,remotePeer:o,muxerFactory:n,signal:s}),this._closeOnShutdown(r,a)}catch(t){throw this.log.error("incoming signaling error - %e",t),r.close(),e.abort(t),t}}_closeOnShutdown(e,t){const s=()=>{t.close().catch(e=>{this.log.error("could not close WebRTCMultiaddrConnection - %e",e)})};this.shutdownController.signal.addEventListener("abort",s),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",s)})}}class Ny extends Error{static name="UnexpectedPeerError";constructor(e="Unexpected Peer"){super(e),this.name="UnexpectedPeerError"}}let Ry=class extends Error{static name="InvalidCryptoExchangeError";constructor(e="Invalid crypto exchange"){super(e),this.name="InvalidCryptoExchangeError"}},My=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},Ly=class extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}},Oy=class extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}},By=class extends Error{static name="StreamBufferError";constructor(e="The stream buffer was full"){super(e),this.name="StreamBufferError"}},Uy=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}},Vy=class extends Event{data;constructor(e,t){super("message",t),this.data=e}},Fy=class extends Event{error;local;constructor(e,t,s){super("close",s),this.error=t,this.local=e}},zy=class extends Fy{constructor(e,t){super(!0,e,t)}},$y=class extends Fy{constructor(e,t){super(!1,e,t)}};const qy=Symbol.for("@libp2p/peer-id"),Wy=Symbol.for("@libp2p/service-capabilities"),Ky=Symbol.for("nodejs.util.inspect.custom");let jy=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[qy]=!0;toString(){return null==this.string&&(this.string=G.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Ue.createV1(114,this.multihash)}toJSON(){return this.toString()}equals(e){if(null==e)return!1;if(e instanceof Uint8Array)return a(this.multihash.bytes,e);if("string"==typeof e)return this.toString()===e;if(null!=e?.toMultihash()?.bytes)return a(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[Ky](){return`PeerId(${this.toString()})`}},Hy=class extends jy{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},Gy=class extends jy{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},Qy=class extends jy{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};function Xy(e){if("Ed25519"===e.type)return new Gy({multihash:e.toCID().multihash,publicKey:e});if("secp256k1"===e.type)return new Qy({multihash:e.toCID().multihash,publicKey:e});if("RSA"===e.type)return new Hy({multihash:e.toCID().multihash,publicKey:e});throw new Uy}let Yy=class extends Error{static name="UnexpectedEOFError";name="UnexpectedEOFError"},Jy=class extends Error{static name="StreamClosedError";name="StreamClosedError"};function Zy(e){return e.reason}async function eb(e,t,s){if(null==t)return e;const r=Zy;if(t.aborted)return e.catch(()=>{}),Promise.reject(r(t));let n;try{return await Promise.race([e,new Promise((e,s)=>{n=()=>{s(r(t))},t.addEventListener("abort",n)})])}finally{null!=n&&t.removeEventListener("abort",n)}}const tb=4*Math.pow(2,20);let sb=class extends ns{status;timeline;inactivityTimeout;maxReadBufferLength;maxWriteBufferLength;log;direction;maxMessageSize;readStatus;writeStatus;remoteReadStatus;remoteWriteStatus;writableNeedsDrain;readBuffer;writeBuffer;sendingData;onDrainPromise;constructor(e){super(),this.status="open",this.log=e.log,this.direction=e.direction??"outbound",this.inactivityTimeout=e.inactivityTimeout??12e4,this.maxReadBufferLength=e.maxReadBufferLength??tb,this.maxWriteBufferLength=e.maxWriteBufferLength,this.maxMessageSize=e.maxMessageSize,this.readBuffer=new cs,this.writeBuffer=new cs,this.readStatus="readable",this.remoteReadStatus="readable",this.writeStatus="writable",this.remoteWriteStatus="writable",this.sendingData=!1,this.writableNeedsDrain=!1,this.timeline={open:Date.now()},this.processSendQueue=this.processSendQueue.bind(this);this.addEventListener("drain",()=>{this.writableNeedsDrain&&(this.log.trace("drain event received, continue sending data"),this.writableNeedsDrain=!1,this.processSendQueue()),this.onDrainPromise?.resolve()});this.addEventListener("close",e=>{this.onDrainPromise?.reject(e.error??new Jy)})}get readBufferLength(){return this.readBuffer.byteLength}get writeBufferLength(){return this.writeBuffer.byteLength}async onDrain(e){return!0!==this.writableNeedsDrain?Promise.resolve():(null==this.onDrainPromise&&(this.onDrainPromise=Promise.withResolvers()),eb(this.onDrainPromise.promise,e?.signal))}async*[Symbol.asyncIterator](){if("readable"!==this.readStatus&&"paused"!==this.readStatus)return;const e=Xl(),t=t=>{e.push(t.data)};this.addEventListener("message",t);const s=t=>{e.end(t.error)};this.addEventListener("close",s);const r=()=>{e.end()};this.addEventListener("remoteCloseWrite",r);try{yield*e}finally{this.removeEventListener("message",t),this.removeEventListener("close",s),this.removeEventListener("remoteCloseWrite",r)}}isReadable(){return"open"===this.status}send(e){if("closed"===this.writeStatus||"closing"===this.writeStatus)throw new Oy(`Cannot write to a stream that is ${this.writeStatus}`);return this.log.trace("append %d bytes to write buffer",e.byteLength),this.writeBuffer.append(e),this.processSendQueue()}abort(e){if("aborted"!==this.status&&"reset"!==this.status&&"closed"!==this.status){this.log.error("abort with error - %e",e),this.status="aborted",this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle")),this.writeStatus="closed",this.remoteWriteStatus="closed",this.readStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now();try{this.sendReset(e)}catch(e){this.log("failed to send reset to remote - %e",e)}this.dispatchEvent(new zy(e))}}pause(){if("closed"===this.readStatus||"closing"===this.readStatus)throw new Oy("Cannot pause a stream that is closing/closed");"paused"!==this.readStatus&&(this.readStatus="paused",this.sendPause())}resume(){if("closed"===this.readStatus||"closing"===this.readStatus)throw new Oy("Cannot resume a stream that is closing/closed");"readable"!==this.readStatus&&(this.readStatus="readable",this.dispatchReadBuffer(),this.sendResume())}push(e){if("closed"===this.readStatus||"closing"===this.readStatus)throw new Oy(`Cannot push data onto a stream that is ${this.readStatus}`);0!==e.byteLength&&(this.readBuffer.append(e),"paused"!==this.readStatus&&0!==this.listenerCount("message")?setTimeout(()=>{this.dispatchReadBuffer()},0):this.checkReadBufferLength())}unshift(e){if("closed"===this.readStatus||"closing"===this.readStatus)throw new Oy(`Cannot push data onto a stream that is ${this.readStatus}`);0!==e.byteLength&&(this.readBuffer.prepend(e),"paused"!==this.readStatus&&0!==this.listenerCount("message")?setTimeout(()=>{this.dispatchReadBuffer()},0):this.checkReadBufferLength())}onData(e){0!==e.byteLength&&("closing"!==this.readStatus&&"closed"!==this.readStatus?(this.readBuffer.append(e),this.dispatchReadBuffer()):this.log("ignoring data - read status %s",this.readStatus))}addEventListener(...e){super.addEventListener.apply(this,e),"message"===e[0]&&this.readBuffer.byteLength>0&&queueMicrotask(()=>{this.dispatchReadBuffer()})}onRemoteReset(){this.log("remote reset"),this.status="reset",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now(),0===this.readBuffer.byteLength&&(this.readStatus="closed");const e=new Ly;this.dispatchEvent(new $y(e))}onTransportClosed(e){this.log("transport closed"),"readable"===this.readStatus&&0===this.readBuffer.byteLength&&(this.log("close readable end after transport closed and read buffer is empty"),this.readStatus="closed"),"closed"!==this.remoteReadStatus&&(this.remoteReadStatus="closed"),"closed"!==this.remoteWriteStatus&&(this.remoteWriteStatus="closed"),"closed"!==this.writeStatus&&(this.writeStatus="closed"),null!=e?this.abort(e):"open"!==this.status&&"closing"!==this.status||(this.timeline.close=Date.now(),this.status="closed",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.dispatchEvent(new Fy))}onRemoteCloseWrite(){"closed"!==this.remoteWriteStatus&&(this.log.trace("on remote close write"),this.remoteWriteStatus="closed",this.safeDispatchEvent("remoteCloseWrite"),"closed"===this.writeStatus&&this.onTransportClosed())}onRemoteCloseRead(){this.log.trace("on remote close read"),this.remoteReadStatus="closed",this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle"))}processSendQueue(){if(this.writableNeedsDrain)return this.log.trace("not processing send queue as drain is required"),this.checkWriteBufferLength(),!1;if(0===this.writeBuffer.byteLength)return this.log.trace("not processing send queue as no bytes to send"),!0;if(this.sendingData)return this.log.trace("not processing send queue as already sending data"),!0;this.sendingData=!0,this.log.trace("processing send queue with %d queued bytes",this.writeBuffer.byteLength);try{let e=!0;const t=this.writeBuffer.byteLength;let s=0;for(;this.writeBuffer.byteLength>0;){const t=Math.min(this.maxMessageSize??this.writeBuffer.byteLength,this.writeBuffer.byteLength);if(0===t){e=!1;break}const r=this.writeBuffer.sublist(0,t),n=new cs(r);this.writeBuffer.consume(r.byteLength);const i=this.sendData(r);if(e=i.canSendMore,s+=i.sentBytes,i.sentBytes!==n.byteLength&&(n.consume(i.sentBytes),this.writeBuffer.prepend(n)),!e)break}return e||(this.log.trace("sent %d/%d bytes, pausing sending because underlying stream is full, %d bytes left in the write buffer",s,t,this.writeBuffer.byteLength),this.writableNeedsDrain=!0,this.checkWriteBufferLength()),0===this.writeBuffer.byteLength&&this.safeDispatchEvent("idle"),e}finally{this.sendingData=!1}}dispatchReadBuffer(){try{if(0===this.listenerCount("message"))return void this.log.trace("not dispatching pause buffer as there are no listeners for the message event");if(0===this.readBuffer.byteLength)return void this.log.trace("not dispatching pause buffer as there is no data to dispatch");if("paused"===this.readStatus)return void this.log.trace("not dispatching pause buffer we are paused");if("closing"===this.readStatus||"closed"===this.readStatus)return this.log("dropping %d bytes because the readable end is %s",this.readBuffer.byteLength,this.readStatus),void this.readBuffer.consume(this.readBuffer.byteLength);const e=this.readBuffer.sublist();this.readBuffer.consume(e.byteLength),this.dispatchEvent(new Vy(e))}finally{0===this.readBuffer.byteLength&&"closed"===this.remoteWriteStatus&&(this.log("close readable end after dispatching read buffer and remote writable end is closed"),this.readStatus="closed"),this.checkReadBufferLength()}}checkReadBufferLength(){this.readBuffer.byteLength>this.maxReadBufferLength&&this.abort(new By(`Read buffer length of ${this.readBuffer.byteLength} exceeded limit of ${this.maxReadBufferLength}, read status is ${this.readStatus}`))}checkWriteBufferLength(){null!=this.maxWriteBufferLength&&this.writeBuffer.byteLength>this.maxWriteBufferLength&&this.abort(new By(`Write buffer length of ${this.writeBuffer.byteLength} exceeded limit of ${this.maxWriteBufferLength}, write status is ${this.writeStatus}`))}onMuxerNeedsDrain(){this.writableNeedsDrain=!0}onMuxerDrain(){this.safeDispatchEvent("drain")}};let rb=class extends Error{static name="UnwrappedError";name="UnwrappedError"},nb=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},ib=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},ob=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function ab(e){return function(e){return"function"==typeof e?.closeRead}(e)?"writable"!==e.remoteWriteStatus&&0===e.readBufferLength:!!function(e){return"function"==typeof e?.close}(e)&&"open"!==e.status}function cb(e,t={}){const s=function(e,t){const s=t?.maxBufferSize??4194304,r=new cs;let n,i=!1;if(o=e,null==o?.addEventListener||null==o?.removeEventListener||null==o?.send||null==o?.push||null==o?.log)throw new My("Argument should be a Stream or a Multiaddr");var o;const a=e=>{if(r.append(e.data),r.byteLength>s){const e=r.byteLength;r.consume(r.byteLength),n?.reject(new Error(`Read buffer overflow - ${e} > ${s}`))}n?.resolve()};e.addEventListener("message",a);const c=e=>{null!=e.error?n?.reject(e.error):n?.resolve()};e.addEventListener("close",c);const l=()=>{n?.resolve()};e.addEventListener("remoteCloseWrite",l);const h={readBuffer:r,async read(t){if(!0===i)throw new rb("Stream was unwrapped");if(ab(e)){if(null==t?.bytes)return null;if(r.byteLength<t.bytes)throw e.log.error("closed after reading %d/%d bytes",r.byteLength,t.bytes),new Yy(`Unexpected EOF - stream closed after reading ${r.byteLength}/${t.bytes} bytes`)}const s=t?.bytes??1;for(n=Promise.withResolvers();;){if(r.byteLength>=s){n.resolve();break}if(await eb(n.promise,t?.signal),ab(e)){if(0===r.byteLength&&null==t?.bytes)return null;break}n=Promise.withResolvers()}const o=t?.bytes??r.byteLength;if(r.byteLength<o){if(ab(e))throw e.log.error("closed while reading %d/%d bytes",r.byteLength,o),new Yy(`Unexpected EOF - stream closed while reading ${r.byteLength}/${o} bytes`);return h.read(t)}const a=r.sublist(0,o);return r.consume(o),a},async write(t,s){if(!0===i)throw new rb("Stream was unwrapped");e.send(t)||await Nm(e,"drain",{signal:s?.signal,rejectionEvents:["close"]})},unwrap:()=>(i||(i=!0,e.removeEventListener("message",a),e.removeEventListener("close",c),e.removeEventListener("remoteCloseWrite",l),r.byteLength>0&&(e.log("stream unwrapped with %d unread bytes",r.byteLength),e.push(r))),e)};return h}(e,t);null!=t.maxDataLength&&null==t.maxLengthLength&&(t.maxLengthLength=Di(t.maxDataLength));const r=t?.lengthDecoder??Ci,n=t?.lengthEncoder??Ii;return{async read(n){let i=-1;const o=new cs;for(;;){const e=await s.read({...n,bytes:1});if(null==e)break;o.append(e);try{i=r(o)}catch(e){if(e instanceof RangeError)continue;throw e}if(i<0)throw new nb("Invalid message length");if(null!=t?.maxLengthLength&&o.byteLength>t.maxLengthLength)throw new ob(`Message length length too long - ${o.byteLength} > ${t.maxLengthLength}`);if(i>-1)break}if(null!=t?.maxDataLength&&i>t.maxDataLength)throw new ib(`Message length too long - ${i} > ${t.maxDataLength}`);const a=await s.read({...n,bytes:i});if(null==a)throw e.log.error("tried to read %d bytes but the stream closed",i),new Yy(`Unexpected EOF - tried to read ${i} bytes but the stream closed`);if(a.byteLength!==i)throw e.log.error("read %d/%d bytes before the stream closed",a.byteLength,i),new Yy(`Unexpected EOF - read ${a.byteLength}/${i} bytes before the stream closed`);return a},async write(e,t){await s.write(new cs(n(e.byteLength),e),t)},async writeV(e,t){const r=new cs(...e.flatMap(e=>[n(e.byteLength),e]));await s.write(r,t)},unwrap:()=>s.unwrap()}}class lb{buffer;maxBufferSize;lengthDecoder;maxDataLength;encodingLength;constructor(e={}){this.buffer=new cs,this.maxBufferSize=e.maxBufferSize??4194304,this.maxDataLength=e.maxDataLength??4194304,this.lengthDecoder=e.lengthDecoder??Ci,this.encodingLength=e.encodingLength??Di}*decode(e){if(this.buffer.append(e),this.buffer.byteLength>this.maxBufferSize)throw new My(`Buffer length limit exceeded - ${this.buffer.byteLength}/${this.maxBufferSize}`);for(;;){let e;try{e=this.lengthDecoder(this.buffer)}catch(e){if(e instanceof RangeError)break;throw e}if(e<0||e>this.maxDataLength)throw new nb("Invalid message length");const t=this.encodingLength(e),s=t+e;if(!(this.buffer.byteLength>=s))break;{const e=this.buffer.sublist(t,s);this.buffer.consume(s),e.byteLength>0&&(yield e)}}}}const hb=65535,ub=Boolean(globalThis.process?.env?.DUMP_SESSION_KEYS);function db(e){if("boolean"!=typeof e)throw new Error(`boolean expected, not ${e}`)}function pb(e){if(!Number.isSafeInteger(e)||e<0)throw new Error("positive integer expected, got "+e)}function fb(e,t,s=""){const r=
/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */
function(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&"Uint8Array"===e.constructor.name}(e),n=e?.length,i=void 0!==t;if(!r||i&&n!==t){throw new Error((s&&`"${s}" `)+"expected Uint8Array"+(i?` of length ${t}`:"")+", got "+(r?`length=${n}`:"type="+typeof e))}return e}function gb(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function mb(e){return new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4))}function yb(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}const bb=(()=>68===new Uint8Array(new Uint32Array([287454020]).buffer)[0])();const wb=(e,t)=>{function s(s,...r){if(fb(s,void 0,"key"),!bb)throw new Error("Non little-endian hardware is not yet supported");if(void 0!==e.nonceLength){fb(r[0],e.varSizeNonce?void 0:e.nonceLength,"nonce")}const n=e.tagLength;n&&void 0!==r[1]&&fb(r[1],void 0,"AAD");const i=t(s,...r),o=(e,t)=>{if(void 0!==t){if(2!==e)throw new Error("cipher output not supported");fb(t,void 0,"output")}};let a=!1;return{encrypt(e,t){if(a)throw new Error("cannot encrypt() twice with same key + nonce");return a=!0,fb(e),o(i.encrypt.length,t),i.encrypt(e,t)},decrypt(e,t){if(fb(e),n&&e.length<n)throw new Error('"ciphertext" expected length bigger than tagLength='+n);return o(i.decrypt.length,t),i.decrypt(e,t)}}}return Object.assign(s,e),s};function vb(e,t,s=!0){if(void 0===t)return new Uint8Array(e);if(t.length!==e)throw new Error('"output" expected Uint8Array of length '+e+", got: "+t.length);if(s&&t.byteOffset%4!=0)throw new Error("invalid output, must be aligned");return t}function Sb(e,t,s){db(s);const r=new Uint8Array(16),n=(i=r,new DataView(i.buffer,i.byteOffset,i.byteLength));var i;return n.setBigUint64(0,BigInt(t),s),n.setBigUint64(8,BigInt(e),s),r}function Eb(e){return Uint8Array.from(e)}const Db=e=>Uint8Array.from(e.split(""),e=>e.charCodeAt(0)),_b=Db("expand 16-byte k"),Tb=Db("expand 32-byte k"),Ib=mb(_b),Cb=mb(Tb);function Pb(e,t){return e<<t|e>>>32-t}function xb(e){return e.byteOffset%4==0}const Ab=2**32-1,kb=Uint32Array.of();function Nb(e,t){const{allowShortKeys:s,extendNonceFn:r,counterLength:n,counterRight:i,rounds:o}=function(e,t){if(null==t||"object"!=typeof t)throw new Error("options must be defined");return Object.assign(e,t)}({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},t);if("function"!=typeof e)throw new Error("core must be a function");return pb(n),pb(o),db(i),db(s),(t,a,c,l,h=0)=>{fb(t,void 0,"key"),fb(a,void 0,"nonce"),fb(c,void 0,"data");const u=c.length;if(void 0===l&&(l=new Uint8Array(u)),fb(l,void 0,"output"),pb(h),h<0||h>=Ab)throw new Error("arx: counter overflow");if(l.length<u)throw new Error(`arx: output (${l.length}) is shorter than data (${u})`);const d=[];let p,f,g=t.length;if(32===g)d.push(p=Eb(t)),f=Cb;else{if(16!==g||!s)throw fb(t,32,"arx key"),new Error("invalid key size");p=new Uint8Array(32),p.set(t),p.set(t,16),f=Ib,d.push(p)}xb(a)||d.push(a=Eb(a));const m=mb(p);if(r){if(24!==a.length)throw new Error("arx: extended nonce must be 24 bytes");r(f,m,mb(a.subarray(0,16)),m),a=a.subarray(16)}const y=16-n;if(y!==a.length)throw new Error(`arx: nonce must be ${y} or 16 bytes`);if(12!==y){const e=new Uint8Array(12);e.set(a,i?0:12-a.length),a=e,d.push(a)}const b=mb(a);return function(e,t,s,r,n,i,o,a){const c=n.length,l=new Uint8Array(64),h=mb(l),u=xb(n)&&xb(i),d=u?mb(n):kb,p=u?mb(i):kb;for(let f=0;f<c;o++){if(e(t,s,r,h,o,a),o>=Ab)throw new Error("arx: counter overflow");const g=Math.min(64,c-f);if(u&&64===g){const e=f/4;if(f%4!=0)throw new Error("arx: invalid block position");for(let t,s=0;s<16;s++)t=e+s,p[t]=d[t]^h[s];f+=64;continue}for(let e,t=0;t<g;t++)e=f+t,i[e]=n[e]^l[t];f+=g}}(e,f,m,b,c,l,h,o),yb(...d),l}}function Rb(e,t){return 255&e[t++]|(255&e[t++])<<8}class Mb{blockLen=16;outputLen=16;buffer=new Uint8Array(16);r=new Uint16Array(10);h=new Uint16Array(10);pad=new Uint16Array(8);pos=0;finished=!1;constructor(e){const t=Rb(e=Eb(fb(e,32,"key")),0),s=Rb(e,2),r=Rb(e,4),n=Rb(e,6),i=Rb(e,8),o=Rb(e,10),a=Rb(e,12),c=Rb(e,14);this.r[0]=8191&t,this.r[1]=8191&(t>>>13|s<<3),this.r[2]=7939&(s>>>10|r<<6),this.r[3]=8191&(r>>>7|n<<9),this.r[4]=255&(n>>>4|i<<12),this.r[5]=i>>>1&8190,this.r[6]=8191&(i>>>14|o<<2),this.r[7]=8065&(o>>>11|a<<5),this.r[8]=8191&(a>>>8|c<<8),this.r[9]=c>>>5&127;for(let t=0;t<8;t++)this.pad[t]=Rb(e,16+2*t)}process(e,t,s=!1){const r=s?0:2048,{h:n,r:i}=this,o=i[0],a=i[1],c=i[2],l=i[3],h=i[4],u=i[5],d=i[6],p=i[7],f=i[8],g=i[9],m=Rb(e,t+0),y=Rb(e,t+2),b=Rb(e,t+4),w=Rb(e,t+6),v=Rb(e,t+8),S=Rb(e,t+10),E=Rb(e,t+12),D=Rb(e,t+14);let _=n[0]+(8191&m),T=n[1]+(8191&(m>>>13|y<<3)),I=n[2]+(8191&(y>>>10|b<<6)),C=n[3]+(8191&(b>>>7|w<<9)),P=n[4]+(8191&(w>>>4|v<<12)),x=n[5]+(v>>>1&8191),A=n[6]+(8191&(v>>>14|S<<2)),k=n[7]+(8191&(S>>>11|E<<5)),N=n[8]+(8191&(E>>>8|D<<8)),R=n[9]+(D>>>5|r),M=0,L=M+_*o+T*(5*g)+I*(5*f)+C*(5*p)+P*(5*d);M=L>>>13,L&=8191,L+=x*(5*u)+A*(5*h)+k*(5*l)+N*(5*c)+R*(5*a),M+=L>>>13,L&=8191;let O=M+_*a+T*o+I*(5*g)+C*(5*f)+P*(5*p);M=O>>>13,O&=8191,O+=x*(5*d)+A*(5*u)+k*(5*h)+N*(5*l)+R*(5*c),M+=O>>>13,O&=8191;let B=M+_*c+T*a+I*o+C*(5*g)+P*(5*f);M=B>>>13,B&=8191,B+=x*(5*p)+A*(5*d)+k*(5*u)+N*(5*h)+R*(5*l),M+=B>>>13,B&=8191;let U=M+_*l+T*c+I*a+C*o+P*(5*g);M=U>>>13,U&=8191,U+=x*(5*f)+A*(5*p)+k*(5*d)+N*(5*u)+R*(5*h),M+=U>>>13,U&=8191;let V=M+_*h+T*l+I*c+C*a+P*o;M=V>>>13,V&=8191,V+=x*(5*g)+A*(5*f)+k*(5*p)+N*(5*d)+R*(5*u),M+=V>>>13,V&=8191;let F=M+_*u+T*h+I*l+C*c+P*a;M=F>>>13,F&=8191,F+=x*o+A*(5*g)+k*(5*f)+N*(5*p)+R*(5*d),M+=F>>>13,F&=8191;let z=M+_*d+T*u+I*h+C*l+P*c;M=z>>>13,z&=8191,z+=x*a+A*o+k*(5*g)+N*(5*f)+R*(5*p),M+=z>>>13,z&=8191;let $=M+_*p+T*d+I*u+C*h+P*l;M=$>>>13,$&=8191,$+=x*c+A*a+k*o+N*(5*g)+R*(5*f),M+=$>>>13,$&=8191;let q=M+_*f+T*p+I*d+C*u+P*h;M=q>>>13,q&=8191,q+=x*l+A*c+k*a+N*o+R*(5*g),M+=q>>>13,q&=8191;let W=M+_*g+T*f+I*p+C*d+P*u;M=W>>>13,W&=8191,W+=x*h+A*l+k*c+N*a+R*o,M+=W>>>13,W&=8191,M=(M<<2)+M|0,M=M+L|0,L=8191&M,M>>>=13,O+=M,n[0]=L,n[1]=O,n[2]=B,n[3]=U,n[4]=V,n[5]=F,n[6]=z,n[7]=$,n[8]=q,n[9]=W}finalize(){const{h:e,pad:t}=this,s=new Uint16Array(10);let r=e[1]>>>13;e[1]&=8191;for(let t=2;t<10;t++)e[t]+=r,r=e[t]>>>13,e[t]&=8191;e[0]+=5*r,r=e[0]>>>13,e[0]&=8191,e[1]+=r,r=e[1]>>>13,e[1]&=8191,e[2]+=r,s[0]=e[0]+5,r=s[0]>>>13,s[0]&=8191;for(let t=1;t<10;t++)s[t]=e[t]+r,r=s[t]>>>13,s[t]&=8191;s[9]-=8192;let n=(1^r)-1;for(let e=0;e<10;e++)s[e]&=n;n=~n;for(let t=0;t<10;t++)e[t]=e[t]&n|s[t];e[0]=65535&(e[0]|e[1]<<13),e[1]=65535&(e[1]>>>3|e[2]<<10),e[2]=65535&(e[2]>>>6|e[3]<<7),e[3]=65535&(e[3]>>>9|e[4]<<4),e[4]=65535&(e[4]>>>12|e[5]<<1|e[6]<<14),e[5]=65535&(e[6]>>>2|e[7]<<11),e[6]=65535&(e[7]>>>5|e[8]<<8),e[7]=65535&(e[8]>>>8|e[9]<<5);let i=e[0]+t[0];e[0]=65535&i;for(let s=1;s<8;s++)i=(e[s]+t[s]|0)+(i>>>16)|0,e[s]=65535&i;yb(s)}update(e){gb(this),fb(e),e=Eb(e);const{buffer:t,blockLen:s}=this,r=e.length;for(let n=0;n<r;){const i=Math.min(s-this.pos,r-n);if(i!==s)t.set(e.subarray(n,n+i),this.pos),this.pos+=i,n+=i,this.pos===s&&(this.process(t,0,!1),this.pos=0);else for(;s<=r-n;n+=s)this.process(e,n)}return this}destroy(){yb(this.h,this.r,this.buffer,this.pad)}digestInto(e){gb(this),function(e,t){fb(e,void 0,"output");const s=t.outputLen;if(e.length<s)throw new Error("digestInto() expects output buffer of length at least "+s)}(e,this),this.finished=!0;const{buffer:t,h:s}=this;let{pos:r}=this;if(r){for(t[r++]=1;r<16;r++)t[r]=0;this.process(t,0,!0)}this.finalize();let n=0;for(let t=0;t<8;t++)e[n++]=s[t]>>>0,e[n++]=s[t]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const s=e.slice(0,t);return this.destroy(),s}}const Lb=(()=>function(e){const t=(t,s)=>e(s).update(t).digest(),s=e(new Uint8Array(32));return t.outputLen=s.outputLen,t.blockLen=s.blockLen,t.create=t=>e(t),t}(e=>new Mb(e)))();function Ob(e,t,s,r,n,i=20){let o=e[0],a=e[1],c=e[2],l=e[3],h=t[0],u=t[1],d=t[2],p=t[3],f=t[4],g=t[5],m=t[6],y=t[7],b=n,w=s[0],v=s[1],S=s[2],E=o,D=a,_=c,T=l,I=h,C=u,P=d,x=p,A=f,k=g,N=m,R=y,M=b,L=w,O=v,B=S;for(let e=0;e<i;e+=2)E=E+I|0,M=Pb(M^E,16),A=A+M|0,I=Pb(I^A,12),E=E+I|0,M=Pb(M^E,8),A=A+M|0,I=Pb(I^A,7),D=D+C|0,L=Pb(L^D,16),k=k+L|0,C=Pb(C^k,12),D=D+C|0,L=Pb(L^D,8),k=k+L|0,C=Pb(C^k,7),_=_+P|0,O=Pb(O^_,16),N=N+O|0,P=Pb(P^N,12),_=_+P|0,O=Pb(O^_,8),N=N+O|0,P=Pb(P^N,7),T=T+x|0,B=Pb(B^T,16),R=R+B|0,x=Pb(x^R,12),T=T+x|0,B=Pb(B^T,8),R=R+B|0,x=Pb(x^R,7),E=E+C|0,B=Pb(B^E,16),N=N+B|0,C=Pb(C^N,12),E=E+C|0,B=Pb(B^E,8),N=N+B|0,C=Pb(C^N,7),D=D+P|0,M=Pb(M^D,16),R=R+M|0,P=Pb(P^R,12),D=D+P|0,M=Pb(M^D,8),R=R+M|0,P=Pb(P^R,7),_=_+x|0,L=Pb(L^_,16),A=A+L|0,x=Pb(x^A,12),_=_+x|0,L=Pb(L^_,8),A=A+L|0,x=Pb(x^A,7),T=T+I|0,O=Pb(O^T,16),k=k+O|0,I=Pb(I^k,12),T=T+I|0,O=Pb(O^T,8),k=k+O|0,I=Pb(I^k,7);let U=0;r[U++]=o+E|0,r[U++]=a+D|0,r[U++]=c+_|0,r[U++]=l+T|0,r[U++]=h+I|0,r[U++]=u+C|0,r[U++]=d+P|0,r[U++]=p+x|0,r[U++]=f+A|0,r[U++]=g+k|0,r[U++]=m+N|0,r[U++]=y+R|0,r[U++]=b+M|0,r[U++]=w+L|0,r[U++]=v+O|0,r[U++]=S+B|0}const Bb=Nb(Ob,{counterRight:!1,counterLength:4,allowShortKeys:!1}),Ub=new Uint8Array(16),Vb=(e,t)=>{e.update(t);const s=t.length%16;s&&e.update(Ub.subarray(s))},Fb=new Uint8Array(32);function zb(e,t,s,r,n){void 0!==n&&fb(n,void 0,"AAD");const i=e(t,s,Fb),o=Sb(r.length,n?n.length:0,!0),a=Lb.create(i);n&&Vb(a,n),Vb(a,r),a.update(o);const c=a.digest();return yb(i,o),c}const $b=wb({blockSize:64,nonceLength:12,tagLength:16},(qb=Bb,(e,t,s)=>{const r=16;return{encrypt(n,i){const o=n.length;(i=vb(o+r,i,!1)).set(n);const a=i.subarray(0,-16);qb(e,t,a,a,1);const c=zb(qb,e,t,a,s);return i.set(c,o),yb(c),i},decrypt(n,i){i=vb(n.length-r,i,!1);const o=n.subarray(0,-16),a=n.subarray(-16),c=zb(qb,e,t,o,s);if(!function(e,t){if(e.length!==t.length)return!1;let s=0;for(let r=0;r<e.length;r++)s|=e[r]^t[r];return 0===s}(a,c))throw new Error("invalid tag");return i.set(n.subarray(0,-16)),qb(e,t,i,i,1),yb(c),i}}}));var qb;function Wb(e,t=""){if(!Number.isSafeInteger(e)||e<0){throw new Error(`${t&&`"${t}" `}expected integer >= 0, got ${e}`)}}function Kb(e,t,s=""){const r=
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
function(e){return e instanceof Uint8Array||ArrayBuffer.isView(e)&&"Uint8Array"===e.constructor.name}(e),n=e?.length,i=void 0!==t;if(!r||i&&n!==t){throw new Error((s&&`"${s}" `)+"expected Uint8Array"+(i?` of length ${t}`:"")+", got "+(r?`length=${n}`:"type="+typeof e))}return e}function jb(e){if("function"!=typeof e||"function"!=typeof e.create)throw new Error("Hash must wrapped by utils.createHasher");Wb(e.outputLen),Wb(e.blockLen)}function Hb(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Gb(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function Qb(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function Xb(e,t){return e<<32-t|e>>>t}const Yb=(()=>"function"==typeof Uint8Array.from([]).toHex&&"function"==typeof Uint8Array.fromHex)(),Jb=Array.from({length:256},(e,t)=>t.toString(16).padStart(2,"0"));const Zb=48,ew=57,tw=65,sw=70,rw=97,nw=102;function iw(e){return e>=Zb&&e<=ew?e-Zb:e>=tw&&e<=sw?e-(tw-10):e>=rw&&e<=nw?e-(rw-10):void 0}function ow(e,t={}){const s=(t,s)=>e(s).update(t).digest(),r=e(void 0);return s.outputLen=r.outputLen,s.blockLen=r.blockLen,s.create=t=>e(t),Object.assign(s,t),Object.freeze(s)}function aw(e=32){const t="object"==typeof globalThis?globalThis.crypto:null;if("function"!=typeof t?.getRandomValues)throw new Error("crypto.getRandomValues must be defined");return t.getRandomValues(new Uint8Array(e))}const cw=e=>({oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,e])});function lw(e,t,s){return e&t^~e&s}function hw(e,t,s){return e&t^e&s^t&s}class uw{blockLen;outputLen;padOffset;isLE;buffer;view;finished=!1;length=0;pos=0;destroyed=!1;constructor(e,t,s,r){this.blockLen=e,this.outputLen=t,this.padOffset=s,this.isLE=r,this.buffer=new Uint8Array(e),this.view=Qb(this.buffer)}update(e){Hb(this),Kb(e);const{view:t,buffer:s,blockLen:r}=this,n=e.length;for(let i=0;i<n;){const o=Math.min(r-this.pos,n-i);if(o===r){const t=Qb(e);for(;r<=n-i;i+=r)this.process(t,i);continue}s.set(e.subarray(i,i+o),this.pos),this.pos+=o,i+=o,this.pos===r&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Hb(this),function(e,t){Kb(e,void 0,"digestInto() output");const s=t.outputLen;if(e.length<s)throw new Error('"digestInto() output" expected to be of length >='+s)}(e,this),this.finished=!0;const{buffer:t,view:s,blockLen:r,isLE:n}=this;let{pos:i}=this;t[i++]=128,Gb(this.buffer.subarray(i)),this.padOffset>r-i&&(this.process(s,0),i=0);for(let e=i;e<r;e++)t[e]=0;s.setBigUint64(r-8,BigInt(8*this.length),n),this.process(s,0);const o=Qb(e),a=this.outputLen;if(a%4)throw new Error("_sha2: outputLen must be aligned to 32bit");const c=a/4,l=this.get();if(c>l.length)throw new Error("_sha2: outputLen bigger than state");for(let e=0;e<c;e++)o.setUint32(4*e,l[e],n)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const s=e.slice(0,t);return this.destroy(),s}_cloneInto(e){e||=new this.constructor,e.set(...this.get());const{blockLen:t,buffer:s,length:r,finished:n,destroyed:i,pos:o}=this;return e.destroyed=i,e.finished=n,e.length=r,e.pos=o,r%t&&e.buffer.set(s),e}clone(){return this._cloneInto()}}const dw=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),pw=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),fw=new Uint32Array(64);class gw extends uw{constructor(e){super(64,e,8,!1)}get(){const{A:e,B:t,C:s,D:r,E:n,F:i,G:o,H:a}=this;return[e,t,s,r,n,i,o,a]}set(e,t,s,r,n,i,o,a){this.A=0|e,this.B=0|t,this.C=0|s,this.D=0|r,this.E=0|n,this.F=0|i,this.G=0|o,this.H=0|a}process(e,t){for(let s=0;s<16;s++,t+=4)fw[s]=e.getUint32(t,!1);for(let e=16;e<64;e++){const t=fw[e-15],s=fw[e-2],r=Xb(t,7)^Xb(t,18)^t>>>3,n=Xb(s,17)^Xb(s,19)^s>>>10;fw[e]=n+fw[e-7]+r+fw[e-16]|0}let{A:s,B:r,C:n,D:i,E:o,F:a,G:c,H:l}=this;for(let e=0;e<64;e++){const t=l+(Xb(o,6)^Xb(o,11)^Xb(o,25))+lw(o,a,c)+pw[e]+fw[e]|0,h=(Xb(s,2)^Xb(s,13)^Xb(s,22))+hw(s,r,n)|0;l=c,c=a,a=o,o=i+t|0,i=n,n=r,r=s,s=t+h|0}s=s+this.A|0,r=r+this.B|0,n=n+this.C|0,i=i+this.D|0,o=o+this.E|0,a=a+this.F|0,c=c+this.G|0,l=l+this.H|0,this.set(s,r,n,i,o,a,c,l)}roundClean(){Gb(fw)}destroy(){this.set(0,0,0,0,0,0,0,0),Gb(this.buffer)}}class mw extends gw{A=0|dw[0];B=0|dw[1];C=0|dw[2];D=0|dw[3];E=0|dw[4];F=0|dw[5];G=0|dw[6];H=0|dw[7];constructor(){super(32)}}const yw=ow(()=>new mw,cw(1)),bw=BigInt(0);
/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function ww(e){return function(e){if("string"!=typeof e)throw new Error("hex string expected, got "+typeof e);return""===e?bw:BigInt("0x"+e)}(function(e){if(Kb(e),Yb)return e.toHex();let t="";for(let s=0;s<e.length;s++)t+=Jb[e[s]];return t}(Sw(Kb(e)).reverse()))}function vw(e,t){Wb(t);const s=function(e){if("string"!=typeof e)throw new Error("hex string expected, got "+typeof e);if(Yb)return Uint8Array.fromHex(e);const t=e.length,s=t/2;if(t%2)throw new Error("hex string expected, got unpadded hex of length "+t);const r=new Uint8Array(s);for(let t=0,n=0;t<s;t++,n+=2){const s=iw(e.charCodeAt(n)),i=iw(e.charCodeAt(n+1));if(void 0===s||void 0===i){const t=e[n]+e[n+1];throw new Error('hex string expected, got non-hex character "'+t+'" at index '+n)}r[t]=16*s+i}return r}((e=function(e){if("bigint"==typeof e){if(!Ew(e))throw new Error("positive bigint expected, got "+e)}else Wb(e);return e}(e)).toString(16).padStart(2*t,"0"));if(s.length!==t)throw new Error("number too large");return s}function Sw(e){return Uint8Array.from(e)}const Ew=e=>"bigint"==typeof e&&bw<=e;function Dw(e,t,s,r){if(!function(e,t,s){return Ew(e)&&Ew(t)&&Ew(s)&&t<=e&&e<s}(t,s,r))throw new Error("expected valid "+e+": "+s+" <= n < "+r+", got "+t)}function _w(e,t={},s={}){if(!e||"object"!=typeof e)throw new Error("expected valid options object");const r=(t,s)=>Object.entries(t).forEach(([t,r])=>function(t,s,r){const n=e[t];if(r&&void 0===n)return;const i=typeof n;if(i!==s||null===n)throw new Error(`param "${t}" is invalid: expected ${s}, got ${i}`)}(t,r,s));r(t,!1),r(s,!0)}
/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Tw=BigInt(0);function Iw(e,t){const s=e%t;return s>=Tw?s:t+s}function Cw(e,t,s){let r=e;for(;t-- >Tw;)r*=r,r%=s;return r}
/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Pw(e,t){return function(s){const r=e(s);return{secretKey:r,publicKey:t(r)}}}
/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */BigInt(0),BigInt(1),BigInt(2),BigInt(8);
/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */
const xw=BigInt(0),Aw=BigInt(1),kw=BigInt(2);function Nw(e){const t=(_w(s=e,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...s}));var s;const{P:r,type:n,adjustScalarBytes:i,powPminus2:o,randomBytes:a}=t,c="x25519"===n;if(!c&&"x448"!==n)throw new Error("invalid type");const l=a||aw,h=c?255:448,u=c?32:56,d=c?BigInt(9):BigInt(5),p=c?BigInt(121665):BigInt(39081),f=c?kw**BigInt(254):kw**BigInt(447),g=c?BigInt(8)*kw**BigInt(251)-Aw:BigInt(4)*kw**BigInt(445)-Aw,m=f+g+Aw,y=e=>Iw(e,r),b=w(d);function w(e){return function(e,t){return vw(e,t).reverse()}(y(e),u)}function v(e,t){const s=function(e,t){Dw("u",e,xw,r),Dw("scalar",t,f,m);const s=t,n=e;let i=Aw,a=xw,c=e,l=Aw,u=xw;for(let e=BigInt(h-1);e>=xw;e--){const t=s>>e&Aw;u^=t,({x_2:i,x_3:c}=_(u,i,c)),({x_2:a,x_3:l}=_(u,a,l)),u=t;const r=i+a,o=y(r*r),h=i-a,d=y(h*h),f=o-d,g=c+l,m=y((c-l)*r),b=y(g*h),w=m+b,v=m-b;c=y(w*w),l=y(n*y(v*v)),i=y(o*d),a=y(f*(o+y(p*f)))}({x_2:i,x_3:c}=_(u,i,c)),({x_2:a,x_3:l}=_(u,a,l));const d=o(a);return y(i*d)}(function(e){const t=Sw(Kb(e,u,"uCoordinate"));return c&&(t[31]&=127),y(ww(t))}(t),function(e){return ww(i(Sw(Kb(e,u,"scalar"))))}(e));if(s===xw)throw new Error("invalid private or public key received");return w(s)}function S(e){return v(e,b)}const E=S,D=v;function _(e,t,s){const r=y(e*(t-s));return{x_2:t=y(t-r),x_3:s=y(s+r)}}const T={secretKey:u,publicKey:u,seed:u},I=(e=l(u))=>(Kb(e,T.seed,"seed"),e),C={randomSecretKey:I};return Object.freeze({keygen:Pw(I,E),getSharedSecret:D,getPublicKey:E,scalarMult:v,scalarMultBase:S,utils:C,GuBytes:b.slice(),lengths:T})}
/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Rw=BigInt(1),Mw=BigInt(2),Lw=BigInt(3),Ow=BigInt(5);BigInt(8);const Bw=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed");function Uw(e){return e[0]&=248,e[31]&=127,e[31]|=64,e}const Vw=(()=>{const e=Bw;return Nw({P:e,type:"x25519",powPminus2:t=>{const{pow_p_5_8:s,b2:r}=function(e){const t=BigInt(10),s=BigInt(20),r=BigInt(40),n=BigInt(80),i=Bw,o=e*e%i*e%i,a=Cw(o,Mw,i)*o%i,c=Cw(a,Rw,i)*e%i,l=Cw(c,Ow,i)*c%i,h=Cw(l,t,i)*l%i,u=Cw(h,s,i)*h%i,d=Cw(u,r,i)*u%i,p=Cw(d,n,i)*d%i,f=Cw(p,n,i)*d%i,g=Cw(f,t,i)*l%i;return{pow_p_5_8:Cw(g,Mw,i)*e%i,b2:o}}(t);return Iw(Cw(s,Lw,e)*r,e)},adjustScalarBytes:Uw})})();class Fw{oHash;iHash;blockLen;outputLen;finished=!1;destroyed=!1;constructor(e,t){if(jb(e),Kb(t,void 0,"key"),this.iHash=e.create(),"function"!=typeof this.iHash.update)throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,r=new Uint8Array(s);r.set(t.length>s?e.create().update(t).digest():t);for(let e=0;e<r.length;e++)r[e]^=54;this.iHash.update(r),this.oHash=e.create();for(let e=0;e<r.length;e++)r[e]^=106;this.oHash.update(r),Gb(r)}update(e){return Hb(this),this.iHash.update(e),this}digestInto(e){Hb(this),Kb(e,this.outputLen,"output"),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||=Object.create(Object.getPrototypeOf(this),{});const{oHash:t,iHash:s,finished:r,destroyed:n,blockLen:i,outputLen:o}=this;return e.finished=r,e.destroyed=n,e.blockLen=i,e.outputLen=o,e.oHash=t._cloneInto(e.oHash),e.iHash=s._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const zw=(e,t,s)=>new Fw(e,t).update(s).digest();zw.create=(e,t)=>new Fw(e,t);const $w=Uint8Array.of(0),qw=Uint8Array.of();const Ww={hashSHA256:e=>yw(e.subarray()),getHKDF(e,t){const s=function(e,t,s){return jb(e),void 0===s&&(s=new Uint8Array(e.outputLen)),zw(e,s,t)}(yw,t,e),r=function(e,t,s,r=32){jb(e),Wb(r,"length");const n=e.outputLen;if(r>255*n)throw new Error("Length must be <= 255*HashLen");const i=Math.ceil(r/n);void 0===s?s=qw:Kb(s,void 0,"info");const o=new Uint8Array(i*n),a=zw.create(e,t),c=a._cloneInto(),l=new Uint8Array(a.outputLen);for(let e=0;e<i;e++)$w[0]=e+1,c.update(0===e?qw:l).update(s).update($w).digestInto(l),o.set(l,n*e),a._cloneInto(c);return a.destroy(),c.destroy(),Gb(l,$w),o.slice(0,r)}(yw,s,void 0,96),n=r;return[n.subarray(0,32),n.subarray(32,64),n.subarray(64,96)]},generateX25519KeyPair(){const e=Vw.utils.randomSecretKey();return{publicKey:Vw.getPublicKey(e),privateKey:e}},generateX25519KeyPairFromSeed:e=>({publicKey:Vw.getPublicKey(e),privateKey:e}),generateX25519SharedKey:(e,t)=>Vw.getSharedSecret(e.subarray(),t.subarray()),chaCha20Poly1305Encrypt:(e,t,s,r)=>$b(r,t,s).encrypt(e.subarray()),chaCha20Poly1305Decrypt:(e,t,s,r,n)=>$b(r,t,s).decrypt(e.subarray(),n)},Kw=Ww;const jw=e=>{const t=l(2);return t[0]=e>>8,t[1]=e,t};jw.bytes=2;const Hw=e=>{if(e.length<2)throw RangeError("Could not decode int16BE");if(e instanceof Uint8Array){let t=0;return t+=e[0]<<8,t+=e[1],t}return e.getUint16(0)};function Gw(e,t){t.enabled&&ub&&(e?(t(`LOCAL_STATIC_PUBLIC_KEY ${Qe(e.publicKey,"hex")}`),t(`LOCAL_STATIC_PRIVATE_KEY ${Qe(e.privateKey,"hex")}`)):t("Missing local static keys."))}function Qw(e,t){t.enabled&&ub&&(e?(t(`LOCAL_PUBLIC_EPHEMERAL_KEY ${Qe(e.publicKey,"hex")}`),t(`LOCAL_PRIVATE_EPHEMERAL_KEY ${Qe(e.privateKey,"hex")}`)):t("Missing local ephemeral keys."))}function Xw(e,t){t.enabled&&ub&&t(e?`REMOTE_EPHEMERAL_PUBLIC_KEY ${Qe(e.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function Yw(e,t,s){s.enabled&&ub&&(s(`CIPHER_STATE_1 ${e.n.getUint64()} ${e.k&&Qe(e.k,"hex")}`),s(`CIPHER_STATE_2 ${t.n.getUint64()} ${t.k&&Qe(t.k,"hex")}`))}Hw.bytes=2;class Jw extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=Jw.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"}class Zw{n;bytes;view;constructor(e=0){this.n=e,this.bytes=c(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>4294967295)throw new Error("Cipherstate has reached maximum n, a new handshake must be performed")}}const ev=c(0);class tv{k;n;crypto;constructor(e,t=void 0,s=0){this.crypto=e,this.k=t,this.n=new Zw(s)}hasKey(){return Boolean(this.k)}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();const s=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),s}decryptWithAd(e,t,s){if(!this.hasKey())return t;this.n.assertValue();const r=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,s);return this.n.increment(),r}}class sv{cs;ck;h;crypto;constructor(e,t){this.crypto=e;const s=Ge(t,"utf-8");this.h=function(e,t){if(t.length<=32){const e=c(32);return e.set(t),e}return e.hash(t)}(e,s),this.ck=this.h,this.cs=new tv(e)}mixKey(e){const[t,s]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new tv(this.crypto,s)}mixHash(e){this.h=this.crypto.hash(new cs(this.h,e))}encryptAndHash(e){const t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){const t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){const[e,t]=this.crypto.hkdf(this.ck,ev);return[new tv(this.crypto,e),new tv(this.crypto,t)]}}class rv{ss;s;e;rs;re;initiator;crypto;constructor(e){const{crypto:t,protocolName:s,prologue:r,initiator:n,s:i,e:o,rs:a,re:c}=e;this.crypto=t,this.ss=new sv(t,s),this.ss.mixHash(r),this.initiator=n,this.s=i,this.e=o,this.rs=a,this.re=c}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");const s=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+s)throw new Error("message is not long enough");const r=e.sublist(t,t+s);return this.rs=this.ss.decryptAndHash(r),s}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class nv extends rv{writeMessageA(e){return new cs(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){const t=this.writeE();this.writeEE();const s=this.writeS();return this.writeES(),new cs(t,s,this.ss.encryptAndHash(e))}writeMessageC(e){const t=this.writeS();return this.writeSE(),new cs(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(e){throw new Jw(`handshake stage 0 validation fail: ${e.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();const t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(e){throw new Jw(`handshake stage 1 validation fail: ${e.message}`)}}readMessageC(e){try{const t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(e){throw new Jw(`handshake stage 2 validation fail: ${e.message}`)}}}var iv,ov;async function av(e,t,s){const r=await e.sign(lv(t));return ov.encode({identityKey:Ho(e.publicKey),identitySig:r,extensions:s})}async function cv(e,t,s){try{const r=ov.decode(e),n=Ko(r.identityKey);if(!1===s?.equals(n))throw new Error(`Payload identity key ${n} does not match expected remote identity key ${s}`);if(!t)throw new Error("Remote static does not exist");const i=lv(t);if(!await n.verify(i,r.identitySig))throw new Error("Invalid payload signature");return r}catch(e){throw new Ny(e.message)}}function lv(e){const t=Ge("noise-libp2p-static-key:");return e instanceof Uint8Array?u([t,e],t.length+e.length):(e.prepend(t),e)}!function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{if(!1!==s.lengthDelimited&&t.fork(),null!=e.webtransportCerthashes)for(const s of e.webtransportCerthashes)t.uint32(10),t.bytes(s);if(null!=e.streamMuxers)for(const s of e.streamMuxers)t.uint32(18),t.string(s);!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={webtransportCerthashes:[],streamMuxers:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:if(null!=s.limits?.webtransportCerthashes&&r.webtransportCerthashes.length===s.limits.webtransportCerthashes)throw new po('Decode error - map field "webtransportCerthashes" had too many elements');r.webtransportCerthashes.push(e.bytes());break;case 2:if(null!=s.limits?.streamMuxers&&r.streamMuxers.length===s.limits.streamMuxers)throw new po('Decode error - map field "streamMuxers" had too many elements');r.streamMuxers.push(e.string());break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(iv||(iv={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.identityKey&&e.identityKey.byteLength>0&&(t.uint32(10),t.bytes(e.identityKey)),null!=e.identitySig&&e.identitySig.byteLength>0&&(t.uint32(18),t.bytes(e.identitySig)),null!=e.extensions&&(t.uint32(34),iv.codec().encode(e.extensions,t)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={identityKey:c(0),identitySig:c(0)},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.identityKey=e.bytes();break;case 2:r.identitySig=e.bytes();break;case 4:r.extensions=iv.codec().decode(e,e.uint32(),{limits:s.limits?.extensions});break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(ov||(ov={}));class hv extends sb{stream;handshake;metrics;decoder;constructor(e,t,s){super({log:e.log,inactivityTimeout:e.inactivityTimeout,maxReadBufferLength:e.maxReadBufferLength,direction:e.direction}),this.stream=e,this.handshake=t,this.metrics=s,this.decoder=new lb({lengthDecoder:Hw,maxBufferSize:16777216,encodingLength:()=>2});this.stream.addEventListener("message",e=>{try{for(const t of this.decoder.decode(e.data))this.onData(this.decrypt(t))}catch(e){this.abort(e)}});this.stream.addEventListener("close",e=>{null!=e.error?!0===e.local?this.abort(e.error):this.onRemoteReset():this.onTransportClosed()});this.stream.addEventListener("drain",()=>{this.safeDispatchEvent("drain")});this.stream.addEventListener("remoteCloseWrite",()=>{this.onRemoteCloseWrite()})}encrypt(e){const t=new cs;for(let s=0;s<e.byteLength;s+=65519){let r,n=s+65519;n>e.byteLength&&(n=e.byteLength),r=e instanceof Uint8Array?this.handshake.encrypt(e.subarray(s,n)):this.handshake.encrypt(e.sublist(s,n)),this.metrics?.encryptedPackets.increment(),t.append(jw(r.byteLength)),t.append(r)}return t}decrypt(e){const t=new cs;for(let s=0;s<e.byteLength;s+=hb){let r,n=s+hb;if(n>e.byteLength&&(n=e.byteLength),n-16<s)throw new Error("Invalid chunk");r=e instanceof Uint8Array?e.subarray(s,n):e.sublist(s,n);const i=e.subarray(s,n-16);try{const e=this.handshake.decrypt(r,i);this.metrics?.decryptedPackets.increment(),t.append(e)}catch(e){throw this.metrics?.decryptErrors.increment(),e}}return t}close(e){return this.stream.close(e)}sendPause(){this.stream.pause()}sendResume(){this.stream.resume()}sendReset(e){this.stream.abort(e)}sendData(e){return{sentBytes:e.byteLength,canSendMore:this.stream.send(this.encrypt(e))}}}function uv(e,t,s){return new hv(e,t,s)}async function dv(e,t){const{log:s,connection:r,crypto:n,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=e,h=await av(i,a.publicKey,l),u=new nv({crypto:n,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:o,s:a});Gw(u.s,s),s.trace("Stage 0 - Initiator starting to send first message."),await r.write(u.writeMessageA(ev),t),s.trace("Stage 0 - Initiator finished sending first message."),Qw(u.e,s),s.trace("Stage 1 - Initiator waiting to receive first message from responder...");const d=u.readMessageB(await r.read(t));var p,f;s.trace("Stage 1 - Initiator received the message."),Xw(u.re,s),p=u.rs,(f=s).enabled&&ub&&f(p?`REMOTE_STATIC_PUBLIC_KEY ${Qe(p.subarray(),"hex")}`:"Missing remote static public key."),s.trace("Initiator going to check remote's signature...");const g=await cv(d,u.rs,c);s.trace("All good with the signature!"),s.trace("Stage 2 - Initiator sending third handshake message."),await r.write(u.writeMessageC(h),t),s.trace("Stage 2 - Initiator sent message with signed payload.");const[m,y]=u.ss.split();return Yw(m,y,s),{payload:g,encrypt:e=>m.encryptWithAd(ev,e),decrypt:(e,t)=>y.decryptWithAd(ev,e,t)}}class pv{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;log;constructor(e,t={}){const{staticNoiseKey:s,extensions:r,crypto:n,prologueBytes:i}=t,{metrics:o}=e;this.components=e,this.log=e.logger.forComponent("libp2p:noise");const a=n??Kw;this.crypto=function(e){return{generateKeypair:e.generateX25519KeyPair,dh:(t,s)=>e.generateX25519SharedKey(t.privateKey,s).subarray(0,32),encrypt:e.chaCha20Poly1305Encrypt,decrypt:e.chaCha20Poly1305Decrypt,hash:e.hashSHA256,hkdf:e.getHKDF}}(a),this.extensions={webtransportCerthashes:[],...r},this.metrics=o?function(e){return{xxHandshakeSuccesses:e.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:e.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:e.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:e.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:e.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}(o):void 0,this.staticKey=s?a.generateX25519KeyPairFromSeed(s):a.generateX25519KeyPair(),this.prologue=i??c(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[Wy]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(e,t){const s=e.log?.newScope("noise")??this.log,r=cb(e,{lengthEncoder:jw,lengthDecoder:Hw,maxDataLength:hb}),n=await this.performHandshakeInitiator(r,this.components.privateKey,s,t?.remotePeer?.publicKey,t),i=Ko(n.payload.identityKey);return{connection:uv(r.unwrap(),n,this.metrics),remoteExtensions:n.payload.extensions,remotePeer:Xy(i),streamMuxer:!0===t?.skipStreamMuxerNegotiation?void 0:this.getStreamMuxer(n.payload.extensions?.streamMuxers)}}getStreamMuxer(e){if(null==e||0===e.length)return;const t=this.components.upgrader.getStreamMuxers();if(null!=t)for(const s of e){const e=t.get(s);if(null!=e)return e}if(e.length)throw new Ry("Early muxer negotiation was requested but the initiator and responder had no common muxers")}async secureInbound(e,t){const s=e.log?.newScope("noise")??this.log,r=cb(e,{lengthEncoder:jw,lengthDecoder:Hw,maxDataLength:hb}),n=await this.performHandshakeResponder(r,this.components.privateKey,s,t?.remotePeer?.publicKey,t),i=Ko(n.payload.identityKey);return{connection:uv(r.unwrap(),n,this.metrics),remoteExtensions:n.payload.extensions,remotePeer:Xy(i),streamMuxer:!0===t?.skipStreamMuxerNegotiation?void 0:this.getStreamMuxer(n.payload.extensions?.streamMuxers)}}async performHandshakeInitiator(e,t,s,r,n){let i;const o=!0===n?.skipStreamMuxerNegotiation?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await dv({connection:e,privateKey:t,remoteIdentityKey:r,log:s.newScope("xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:o,webtransportCerthashes:[],...this.extensions}},n),this.metrics?.xxHandshakeSuccesses.increment()}catch(e){throw this.metrics?.xxHandshakeErrors.increment(),e}return i}async performHandshakeResponder(e,t,s,r,n){let i;const o=!0===n?.skipStreamMuxerNegotiation?[]:[...this.components.upgrader.getStreamMuxers().keys()];try{i=await async function(e,t){const{log:s,connection:r,crypto:n,privateKey:i,prologue:o,s:a,remoteIdentityKey:c,extensions:l}=e,h=await av(i,a.publicKey,l),u=new nv({crypto:n,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:o,s:a});Gw(u.s,s),s.trace("Stage 0 - Responder waiting to receive first message."),u.readMessageA(await r.read(t)),s.trace("Stage 0 - Responder received first message."),Xw(u.re,s),s.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await r.write(u.writeMessageB(h),t),s.trace("Stage 1 - Responder sent the second handshake message with signed payload."),Qw(u.e,s),s.trace("Stage 2 - Responder waiting for third handshake message...");const d=u.readMessageC(await r.read(t));s.trace("Stage 2 - Responder received the message, finished handshake.");const p=await cv(d,u.rs,c),[f,g]=u.ss.split();return Yw(f,g,s),{payload:p,encrypt:e=>g.encryptWithAd(ev,e),decrypt:(e,t)=>f.decryptWithAd(ev,e,t)}}({connection:e,privateKey:t,remoteIdentityKey:r,log:s.newScope("xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:{streamMuxers:o,webtransportCerthashes:[],...this.extensions}},n),this.metrics?.xxHandshakeSuccesses.increment()}catch(e){throw this.metrics?.xxHandshakeErrors.increment(),e}return i}}function fv(e={}){return t=>new pv(t,e)}class gv extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}}let mv=class extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}},yv=class extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}},bv=class extends Error{static name="StreamBufferError";constructor(e="The stream buffer was full"){super(e),this.name="StreamBufferError"}},wv=class extends Event{data;constructor(e,t){super("message",t),this.data=e}},vv=class extends Event{error;local;constructor(e,t,s){super("close",s),this.error=t,this.local=e}},Sv=class extends vv{constructor(e,t){super(!0,e,t)}},Ev=class extends vv{constructor(e,t){super(!1,e,t)}};const Dv=Symbol.for("@libp2p/transport");var _v;!function(e){e[e.FATAL_ALL=0]="FATAL_ALL",e[e.NO_FATAL=1]="NO_FATAL"}(_v||(_v={}));const Tv=Symbol.for("@libp2p/service-capabilities");let Iv=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},Cv=class extends Error{static name="ValidationError";name="ValidationError"},Pv=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"},xv=class extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"};function Av(e){return t=>Qe(t,e)}function kv(e){return t=>Ge(t,e)}function Nv(e){return new DataView(e.buffer).getUint16(e.byteOffset).toString()}function Rv(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,"string"==typeof e?parseInt(e):e),new Uint8Array(t)}function Mv(e){const t=e.subarray(0,e.length-2),s=e.subarray(e.length-2);return`${Qe(t,"base32")}:${Nv(s)}`}const Lv=function(e){e=e.toString().trim();const t=new Uint8Array(4);return e.split(/\./g).forEach((e,s)=>{const r=parseInt(e,10);if(isNaN(r)||r<0||r>255)throw new Iv("Invalid byte value in IP address");t[s]=r}),t};const Ov=Object.values(qe).map(e=>e.decoder),Bv=function(){let e=Ov[0].or(Ov[1]);return Ov.slice(2).forEach(t=>e=e.or(t)),e}();const Uv=function(...e){return t=>{for(const s of e)s(t)}}(function(e){if(parseInt(e).toString()!==e)throw new Cv("Value must be an integer")},function(e){if(e<0)throw new Cv("Value must be a positive integer, or zero")},function(e){return t=>{if(t>e)throw new Cv(`Value must be smaller than or equal to ${e}`)}}(65535)),Vv=-1;const Fv=new class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(t="string"==typeof e?this.protocolsByName.get(e):this.protocolsByCode.get(e),null==t)throw new xv(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);null!=t&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(e=>{this.protocolsByName.delete(e)}))}},zv=[{code:4,name:"ip4",size:32,valueToBytes:Lv,bytesToValue:function(e){if(4!==e.byteLength)throw new Iv("IPv4 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s++)t.push(e[s]);return t.join(".")},validate:e=>{if(!gc(e))throw new Cv(`Invalid IPv4 address "${e}"`)}},{code:6,name:"tcp",size:16,valueToBytes:Rv,bytesToValue:Nv,validate:Uv},{code:273,name:"udp",size:16,valueToBytes:Rv,bytesToValue:Nv,validate:Uv},{code:33,name:"dccp",size:16,valueToBytes:Rv,bytesToValue:Nv,validate:Uv},{code:41,name:"ip6",size:128,valueToBytes:function(e){let t=0;const s=(e=e.toString().trim()).split(":",8);let r;for(r=0;r<s.length;r++){let e;gc(s[r])&&(e=Lv(s[r]),s[r]=Qe(e.subarray(0,2),"base16")),null!=e&&++r<8&&s.splice(r,0,Qe(e.subarray(2,4),"base16"))}if(""===s[0])for(;s.length<8;)s.unshift("0");else if(""===s[s.length-1])for(;s.length<8;)s.push("0");else if(s.length<8){for(r=0;r<s.length&&""!==s[r];r++);const e=[r,1];for(r=9-s.length;r>0;r--)e.push("0");s.splice.apply(s,e)}const n=new Uint8Array(t+16);for(r=0;r<s.length;r++){""===s[r]&&(s[r]="0");const e=parseInt(s[r],16);if(isNaN(e)||e<0||e>65535)throw new Iv("Invalid byte value in IP address");n[t++]=e>>8&255,n[t++]=255&e}return n},bytesToValue:function(e){if(16!==e.byteLength)throw new Iv("IPv6 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s+=2){const r=e[s],n=e[s+1],i=`${r.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}`;t.push(i)}const s=t.join(":");try{const e=new URL(`http://[${s}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new Iv(`Invalid IPv6 address "${s}"`)}},stringToValue:function(e){try{const t=new URL(`http://[${e}]`);return t.hostname.substring(1,t.hostname.length-1)}catch{throw new Iv(`Invalid IPv6 address "${e}"`)}},validate:e=>{if(!mc(e))throw new Cv(`Invalid IPv6 address "${e}"`)}},{code:42,name:"ip6zone",size:Vv},{code:43,name:"ipcidr",size:8,bytesToValue:Av("base10"),valueToBytes:kv("base10")},{code:53,name:"dns",size:Vv},{code:54,name:"dns4",size:Vv},{code:55,name:"dns6",size:Vv},{code:56,name:"dnsaddr",size:Vv},{code:132,name:"sctp",size:16,valueToBytes:Rv,bytesToValue:Nv,validate:Uv},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:Vv,stringToValue:e=>decodeURIComponent(e),valueToString:e=>encodeURIComponent(e)},{code:421,name:"p2p",aliases:["ipfs"],size:Vv,bytesToValue:Av("base58btc"),valueToBytes:e=>e.startsWith("Q")||e.startsWith("1")?kv("base58btc")(e):Ue.parse(e).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:Mv,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const s=Ge(t[0],"base32"),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=Rv(r);return u([s,n],s.length+n.length)}},{code:445,name:"onion3",size:296,bytesToValue:Mv,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const s=L.decode(`b${t[0]}`),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=Rv(r);return u([s,n],s.length+n.length)}},{code:446,name:"garlic64",size:Vv},{code:447,name:"garlic32",size:Vv},{code:448,name:"tls"},{code:449,name:"sni",size:Vv},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:Vv,bytesToValue:function(e){return t=>e.encoder.encode(t)}(Z),valueToBytes:function(e){return Bv.decode(e)}},{code:480,name:"http"},{code:481,name:"http-path",size:Vv,stringToValue:e=>`/${decodeURIComponent(e)}`,valueToString:e=>encodeURIComponent(e.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:Vv}];function $v(e,t,s){return null==e.size||0===e.size?0:e.size>0?e.size/8:Ci(t,s)}zv.forEach(e=>{Fv.addProtocol(e)});const qv=Symbol.for("nodejs.util.inspect.custom"),Wv=Symbol.for("@multiformats/multiaddr");function Kv(e){if(null==e&&(e="/"),function(e){return Boolean(e?.[Wv])}(e))return e.getComponents();if(e instanceof Uint8Array)return function(e){const t=[];let s=0;for(;s<e.length;){const r=Ci(e,s),n=Fv.getProtocol(r),i=Di(r),o=$v(n,e,s+i);let a=0;o>0&&n.size===Vv&&(a=Di(o));const c=i+a+o,l={code:r,name:n.name,bytes:e.subarray(s,s+c)};if(o>0){const t=s+i+a,r=e.subarray(t,t+o);l.value=n.bytesToValue?.(r)??Qe(r)}t.push(l),s+=c}return t}(e);if("string"==typeof e)return""===(e=e.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""))&&(e="/"),function(e){if("/"!==e.charAt(0))throw new Iv('String multiaddr must start with "/"');const t=[];let s="protocol",r="",n="";for(let i=1;i<e.length;i++){const o=e.charAt(i);"/"!==o&&("protocol"===s?n+=e.charAt(i):r+=e.charAt(i));const a=i===e.length-1;if("/"===o||a){const e=Fv.getProtocol(n);if("protocol"===s){if(null==e.size||0===e.size){t.push({code:e.code,name:e.name}),r="",n="",s="protocol";continue}if(a)throw new Iv(`Component ${n} was missing value`);s="value"}else if("value"===s){const i={code:e.code,name:e.name};if(null!=e.size&&0!==e.size){if(""===r)throw new Iv(`Component ${n} was missing value`);i.value=e.stringToValue?.(r)??r}t.push(i),r="",n="",s="protocol"}}}if(""!==n&&""!==r)throw new Iv("Incomplete multiaddr");return t}(e);if(Array.isArray(e))return e;throw new Iv("Must be a string, Uint8Array, Component[], or another Multiaddr")}let jv=class e{[Wv]=!0;#L;#O;#B;constructor(e="/",t={}){this.#L=Kv(e),!1!==t.validate&&function(e){e.getComponents().forEach(e=>{const t=Fv.getProtocol(e.code);null!=e.value&&t.validate?.(e.value)})}(this)}get bytes(){return null==this.#B&&(this.#B=function(e){let t=0;const s=[];for(const r of e){if(null==r.bytes){const e=Fv.getProtocol(r.code),t=Di(r.code);let s,n=0,i=0;null!=r.value&&(s=e.valueToBytes?.(r.value)??Ge(r.value),n=s.byteLength,e.size===Vv&&(i=Di(n)));const o=new Uint8Array(t+i+n);let a=0;_i(r.code,o,a),a+=t,null!=s&&(e.size===Vv&&(_i(n,o,a),a+=i),o.set(s,a)),r.bytes=o}s.push(r.bytes),t+=r.bytes.byteLength}return u(s,t)}(this.#L)),this.#B}toString(){return null==this.#O&&(this.#O=`/${this.#L.flatMap(e=>{if(null==e.value)return e.name;const t=Fv.getProtocol(e.code);if(null==t)throw new Iv(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`),this.#O}toJSON(){return this.toString()}getComponents(){return[...this.#L.map(e=>({...e}))]}encapsulate(t){const s=new e(t);return new e([...this.#L,...s.getComponents()],{validate:!1})}decapsulate(t){const s=t.toString(),r=this.toString(),n=r.lastIndexOf(s);if(n<0)throw new Pv(`Address ${this.toString()} does not contain subaddress: ${s}`);return new e(r.slice(0,n),{validate:!1})}decapsulateCode(t){let s;for(let e=this.#L.length-1;e>-1;e--)if(this.#L[e].code===t){s=e;break}return new e(this.#L.slice(0,s),{validate:!1})}equals(e){return a(this.bytes,e.bytes)}[qv](){return`Multiaddr(${this.toString()})`}};const Hv=[6,53,56,54,55];function Gv(e){return Xv("sni",e)?.value}function Qv(e){const t=Xv("tcp",e)?.value;return null==t?"":`:${t}`}function Xv(e,t){return t.find(t=>t.name===e)}function Yv(e){return e.some(({code:e})=>448===e)}function Jv(e,t){const s=Zv[e.name];if(null==s)throw new Error(`Can't interpret protocol ${e.name}`);const r=s(e,t);return 41===e.code?`[${r}]`:r}const Zv={ip4:(e,t)=>e.value,ip6:(e,t)=>0===t.length?e.value:`[${e.value}]`,tcp:(e,t)=>{const s=t.pop();if(null==s)throw new Error("Unexpected end of multiaddr");return`tcp://${Jv(s,t)}:${e.value}`},udp:(e,t)=>{const s=t.pop();if(null==s)throw new Error("Unexpected end of multiaddr");return`udp://${Jv(s,t)}:${e.value}`},dnsaddr:(e,t)=>e.value,dns4:(e,t)=>e.value,dns6:(e,t)=>e.value,dns:(e,t)=>e.value,ipfs:(e,t)=>{const s=t.pop();if(null==s)throw new Error("Unexpected end of multiaddr");return`${Jv(s,t)}`},p2p:(e,t)=>{const s=t.pop();if(null==s)throw new Error("Unexpected end of multiaddr");return`${Jv(s,t)}`},http:(e,t)=>{const s=Yv(t),r=Gv(t),n=Qv(t);if(s&&null!=r)return`https://${r}${n}`;const i=s?"https://":"http://",o=t.pop();if(null==o)throw new Error("Unexpected end of multiaddr");let a=Jv(o,t);return a=a?.replace("tcp://",""),`${i}${a}`},"http-path":(e,t)=>{const s=t.pop();if(null==s)throw new Error("Unexpected end of multiaddr");return`${Jv(s,t)}${decodeURIComponent(e.value??"")}`},tls:(e,t)=>{const s=t.pop();if(null==s)throw new Error("Unexpected end of multiaddr");return Jv(s,t)},sni:(e,t)=>{const s=t.pop();if(null==s)throw new Error("Unexpected end of multiaddr");return Jv(s,t)},https:(e,t)=>{const s=t.pop();if(null==s)throw new Error("Unexpected end of multiaddr");let r=Jv(s,t);return r=r?.replace("tcp://",""),`https://${r}`},ws:(e,t)=>{const s=Yv(t),r=Gv(t),n=Qv(t);if(s&&null!=r)return`wss://${r}${n}`;const i=s?"wss://":"ws://",o=t.pop();if(null==o)throw new Error("Unexpected end of multiaddr");let a=Jv(o,t);return a=a?.replace("tcp://",""),`${i}${a}`},wss:(e,t)=>{const s=t.pop();if(null==s)throw new Error("Unexpected end of multiaddr");let r=Jv(s,t);return r=r?.replace("tcp://",""),`wss://${r}`}};function eS(e,t){const s=new jv(e).getComponents(),r=s.pop();if(null==r)throw new Error("Unexpected end of multiaddr");const n=Zv[r.name];if(null==n)throw new Error(`No interpreter found for ${r.name}`);let i=n(r,s)??"";return Hv.includes(r.code)&&(i=i.replace(/^.*:\/\//,""),i="443"===r.value?`https://${i}`:`http://${i}`),(i.startsWith("http://")||i.startsWith("https://")||i.startsWith("ws://")||i.startsWith("wss://"))&&(i=new URL(i).toString(),i.endsWith("/")&&(i=i.substring(0,i.length-1))),i}let tS=class extends Error{static name="StreamClosedError";name="StreamClosedError"};function sS(e){return e.reason}const rS=4*Math.pow(2,20);let nS=class extends ns{status;timeline;inactivityTimeout;maxReadBufferLength;maxWriteBufferLength;log;direction;maxMessageSize;readStatus;writeStatus;remoteReadStatus;remoteWriteStatus;writableNeedsDrain;readBuffer;writeBuffer;sendingData;onDrainPromise;constructor(e){super(),this.status="open",this.log=e.log,this.direction=e.direction??"outbound",this.inactivityTimeout=e.inactivityTimeout??12e4,this.maxReadBufferLength=e.maxReadBufferLength??rS,this.maxWriteBufferLength=e.maxWriteBufferLength,this.maxMessageSize=e.maxMessageSize,this.readBuffer=new cs,this.writeBuffer=new cs,this.readStatus="readable",this.remoteReadStatus="readable",this.writeStatus="writable",this.remoteWriteStatus="writable",this.sendingData=!1,this.writableNeedsDrain=!1,this.timeline={open:Date.now()},this.processSendQueue=this.processSendQueue.bind(this);this.addEventListener("drain",()=>{this.writableNeedsDrain&&(this.log.trace("drain event received, continue sending data"),this.writableNeedsDrain=!1,this.processSendQueue()),this.onDrainPromise?.resolve()});this.addEventListener("close",e=>{this.onDrainPromise?.reject(e.error??new tS)})}get readBufferLength(){return this.readBuffer.byteLength}get writeBufferLength(){return this.writeBuffer.byteLength}async onDrain(e){return!0!==this.writableNeedsDrain?Promise.resolve():(null==this.onDrainPromise&&(this.onDrainPromise=Promise.withResolvers()),async function(e,t){if(null==t)return e;const s=sS;if(t.aborted)return e.catch(()=>{}),Promise.reject(s(t));let r;try{return await Promise.race([e,new Promise((e,n)=>{r=()=>{n(s(t))},t.addEventListener("abort",r)})])}finally{null!=r&&t.removeEventListener("abort",r)}}(this.onDrainPromise.promise,e?.signal))}async*[Symbol.asyncIterator](){if("readable"!==this.readStatus&&"paused"!==this.readStatus)return;const e=Xl(),t=t=>{e.push(t.data)};this.addEventListener("message",t);const s=t=>{e.end(t.error)};this.addEventListener("close",s);const r=()=>{e.end()};this.addEventListener("remoteCloseWrite",r);try{yield*e}finally{this.removeEventListener("message",t),this.removeEventListener("close",s),this.removeEventListener("remoteCloseWrite",r)}}isReadable(){return"open"===this.status}send(e){if("closed"===this.writeStatus||"closing"===this.writeStatus)throw new yv(`Cannot write to a stream that is ${this.writeStatus}`);return this.log.trace("append %d bytes to write buffer",e.byteLength),this.writeBuffer.append(e),this.processSendQueue()}abort(e){if("aborted"!==this.status&&"reset"!==this.status&&"closed"!==this.status){this.log.error("abort with error - %e",e),this.status="aborted",this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle")),this.writeStatus="closed",this.remoteWriteStatus="closed",this.readStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now();try{this.sendReset(e)}catch(e){this.log("failed to send reset to remote - %e",e)}this.dispatchEvent(new Sv(e))}}pause(){if("closed"===this.readStatus||"closing"===this.readStatus)throw new yv("Cannot pause a stream that is closing/closed");"paused"!==this.readStatus&&(this.readStatus="paused",this.sendPause())}resume(){if("closed"===this.readStatus||"closing"===this.readStatus)throw new yv("Cannot resume a stream that is closing/closed");"readable"!==this.readStatus&&(this.readStatus="readable",this.dispatchReadBuffer(),this.sendResume())}push(e){if("closed"===this.readStatus||"closing"===this.readStatus)throw new yv(`Cannot push data onto a stream that is ${this.readStatus}`);0!==e.byteLength&&(this.readBuffer.append(e),"paused"!==this.readStatus&&0!==this.listenerCount("message")?setTimeout(()=>{this.dispatchReadBuffer()},0):this.checkReadBufferLength())}unshift(e){if("closed"===this.readStatus||"closing"===this.readStatus)throw new yv(`Cannot push data onto a stream that is ${this.readStatus}`);0!==e.byteLength&&(this.readBuffer.prepend(e),"paused"!==this.readStatus&&0!==this.listenerCount("message")?setTimeout(()=>{this.dispatchReadBuffer()},0):this.checkReadBufferLength())}onData(e){0!==e.byteLength&&("closing"!==this.readStatus&&"closed"!==this.readStatus?(this.readBuffer.append(e),this.dispatchReadBuffer()):this.log("ignoring data - read status %s",this.readStatus))}addEventListener(...e){super.addEventListener.apply(this,e),"message"===e[0]&&this.readBuffer.byteLength>0&&queueMicrotask(()=>{this.dispatchReadBuffer()})}onRemoteReset(){this.log("remote reset"),this.status="reset",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now(),0===this.readBuffer.byteLength&&(this.readStatus="closed");const e=new mv;this.dispatchEvent(new Ev(e))}onTransportClosed(e){this.log("transport closed"),"readable"===this.readStatus&&0===this.readBuffer.byteLength&&(this.log("close readable end after transport closed and read buffer is empty"),this.readStatus="closed"),"closed"!==this.remoteReadStatus&&(this.remoteReadStatus="closed"),"closed"!==this.remoteWriteStatus&&(this.remoteWriteStatus="closed"),"closed"!==this.writeStatus&&(this.writeStatus="closed"),null!=e?this.abort(e):"open"!==this.status&&"closing"!==this.status||(this.timeline.close=Date.now(),this.status="closed",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.dispatchEvent(new vv))}onRemoteCloseWrite(){"closed"!==this.remoteWriteStatus&&(this.log.trace("on remote close write"),this.remoteWriteStatus="closed",this.safeDispatchEvent("remoteCloseWrite"),"closed"===this.writeStatus&&this.onTransportClosed())}onRemoteCloseRead(){this.log.trace("on remote close read"),this.remoteReadStatus="closed",this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle"))}processSendQueue(){if(this.writableNeedsDrain)return this.log.trace("not processing send queue as drain is required"),this.checkWriteBufferLength(),!1;if(0===this.writeBuffer.byteLength)return this.log.trace("not processing send queue as no bytes to send"),!0;if(this.sendingData)return this.log.trace("not processing send queue as already sending data"),!0;this.sendingData=!0,this.log.trace("processing send queue with %d queued bytes",this.writeBuffer.byteLength);try{let e=!0;const t=this.writeBuffer.byteLength;let s=0;for(;this.writeBuffer.byteLength>0;){const t=Math.min(this.maxMessageSize??this.writeBuffer.byteLength,this.writeBuffer.byteLength);if(0===t){e=!1;break}const r=this.writeBuffer.sublist(0,t),n=new cs(r);this.writeBuffer.consume(r.byteLength);const i=this.sendData(r);if(e=i.canSendMore,s+=i.sentBytes,i.sentBytes!==n.byteLength&&(n.consume(i.sentBytes),this.writeBuffer.prepend(n)),!e)break}return e||(this.log.trace("sent %d/%d bytes, pausing sending because underlying stream is full, %d bytes left in the write buffer",s,t,this.writeBuffer.byteLength),this.writableNeedsDrain=!0,this.checkWriteBufferLength()),0===this.writeBuffer.byteLength&&this.safeDispatchEvent("idle"),e}finally{this.sendingData=!1}}dispatchReadBuffer(){try{if(0===this.listenerCount("message"))return void this.log.trace("not dispatching pause buffer as there are no listeners for the message event");if(0===this.readBuffer.byteLength)return void this.log.trace("not dispatching pause buffer as there is no data to dispatch");if("paused"===this.readStatus)return void this.log.trace("not dispatching pause buffer we are paused");if("closing"===this.readStatus||"closed"===this.readStatus)return this.log("dropping %d bytes because the readable end is %s",this.readBuffer.byteLength,this.readStatus),void this.readBuffer.consume(this.readBuffer.byteLength);const e=this.readBuffer.sublist();this.readBuffer.consume(e.byteLength),this.dispatchEvent(new wv(e))}finally{0===this.readBuffer.byteLength&&"closed"===this.remoteWriteStatus&&(this.log("close readable end after dispatching read buffer and remote writable end is closed"),this.readStatus="closed"),this.checkReadBufferLength()}}checkReadBufferLength(){this.readBuffer.byteLength>this.maxReadBufferLength&&this.abort(new bv(`Read buffer length of ${this.readBuffer.byteLength} exceeded limit of ${this.maxReadBufferLength}, read status is ${this.readStatus}`))}checkWriteBufferLength(){null!=this.maxWriteBufferLength&&this.writeBuffer.byteLength>this.maxWriteBufferLength&&this.abort(new bv(`Write buffer length of ${this.writeBuffer.byteLength} exceeded limit of ${this.maxWriteBufferLength}, write status is ${this.writeStatus}`))}onMuxerNeedsDrain(){this.writableNeedsDrain=!0}onMuxerDrain(){this.safeDispatchEvent("drain")}},iS=class extends nS{remoteAddr;metricPrefix;metrics;constructor(e){super(e),this.metricPrefix=e.metricPrefix??"",this.metrics=e.metrics,this.remoteAddr=e.remoteAddr,this.addEventListener("close",e=>{this.metrics?.increment({[`${this.metricPrefix}end`]:!0}),null!=e.error?e.local?this.metrics?.increment({[`${this.metricPrefix}abort`]:!0}):this.metrics?.increment({[`${this.metricPrefix}reset`]:!0}):e.local?this.metrics?.increment({[`${this.metricPrefix}_local_close`]:!0}):this.metrics?.increment({[`${this.metricPrefix}_remote_close`]:!0})})}async close(e){"open"===this.status&&(this.status="closing",this.writeStatus="closing",this.remoteWriteStatus="closing",this.remoteReadStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await Nm(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await Nm(this,"drain",{...e,rejectionEvents:["close"]})),await this.sendClose(e),this.onTransportClosed())}};function oS(e,t,s){let r,n,i=!1;function o(){const a={signal:n.signal};if(null!=s?.timeout){const e=ip([n.signal,AbortSignal.timeout(s.timeout)]);a.signal=e}i=!0,Promise.resolve().then(async()=>{await e(a)}).catch(()=>{}).finally(()=>{i=!1,n.signal.aborted||(r=setTimeout(o,t))})}const a=function(e,t){let s;const r=function(){clearTimeout(s),s=setTimeout(function(){s=void 0,e()},t)};return r.start=()=>{},r.stop=()=>{clearTimeout(s)},r}(o,s?.debounce??100);let c=!1;return{setInterval:e=>{t!==e&&(t=e,null!=r&&(clearTimeout(r),r=setTimeout(o,t)))},setTimeout:e=>{s??={},s.timeout=e},run:()=>{i||(clearTimeout(r),a())},start:()=>{c||(c=!0,n=new AbortController,n.signal,!0===s?.runImmediately?queueMicrotask(()=>{o()}):r=setTimeout(o,t))},stop:()=>{clearTimeout(r),n?.abort(),c=!1}}}class aS extends iS{websocket;maxBufferedAmount;checkBufferedAmountTask;constructor(e){super(e),this.websocket=e.websocket,this.maxBufferedAmount=e.maxBufferedAmount??4194304,this.checkBufferedAmountTask=oS(this.checkBufferedAmount.bind(this),e.bufferedAmountPollInterval??10),this.websocket.addEventListener("close",e=>{this.log('closed - code %d, reason "%s", wasClean %s',e.code,e.reason,e.wasClean),this.checkBufferedAmountTask.stop(),e.wasClean?this.onTransportClosed():this.onRemoteReset()},{once:!0}),this.websocket.addEventListener("message",e=>{try{let t;if("string"==typeof e.data)t=Ge(e.data);else{if(!(e.data instanceof ArrayBuffer))return void this.abort(new Error("Incorrect binary type"));t=new Uint8Array(e.data,0,e.data.byteLength)}this.onData(t)}catch(e){this.log.error("error receiving data - %e",e)}})}sendData(e){for(const t of e)this.websocket.send(t);const t=this.websocket.bufferedAmount<this.maxBufferedAmount;return t||this.checkBufferedAmountTask.start(),{sentBytes:e.byteLength,canSendMore:t}}sendReset(){this.websocket.close(1006)}async sendClose(e){this.websocket.close(),e?.signal?.throwIfAborted()}sendPause(){}sendResume(){}checkBufferedAmount(){this.log("buffered amount now %d",this.websocket.bufferedAmount),0===this.websocket.bufferedAmount&&(this.checkBufferedAmountTask.stop(),this.safeDispatchEvent("drain"))}}class cS{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[Dv]=!0;[Symbol.toStringTag]="@libp2p/websockets";[Tv]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};const s=(r={websocket:await this._connect(e,t),remoteAddr:e,metrics:this.metrics?.dialerEvents,direction:"outbound",log:this.components.logger.forComponent("libp2p:websockets:connection"),maxBufferedAmount:this.init.maxBufferedAmount,bufferedAmountPollInterval:this.init.bufferedAmountPollInterval},new aS(r));var r;this.log("new outbound connection %s",s.remoteAddr);const n=await t.upgrader.upgradeOutbound(s,t);return this.log("outbound connection %s upgraded",s.remoteAddr),n}async _connect(e,t){t?.signal?.throwIfAborted();const s=eS(e);this.log("create websocket connection to %s",s);const r=new WebSocket(s);r.binaryType="arraybuffer";try{t.onProgress?.(new Wa("websockets:open-connection")),await Nm(r,"open",t)}catch(e){if(t.signal?.aborted)throw this.metrics?.dialerEvents.increment({abort:!0}),new gv(`Could not connect to ${s}`);this.metrics?.dialerEvents.increment({error:!0});try{r.close()}catch{}throw e}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),r}createListener(e){return function(){throw new Error("WebSocket Servers can not be created in the browser!")}((this.logger,this.components.events,this.components.metrics),this.init)}listenFilter(e){return e.filter(e=>mm.exactMatch(e)||bm.exactMatch(e))}dialFilter(e){return this.listenFilter(e)}}function lS(e={}){return t=>new cS(t,e)}let hS=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}},uS=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},dS=class extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}},pS=class extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}},fS=class extends Error{static name="StreamBufferError";constructor(e="The stream buffer was full"){super(e),this.name="StreamBufferError"}},gS=class extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}},mS=class extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}},yS=class extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}};class bS extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}}class wS extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}}let vS=class extends Event{data;constructor(e,t){super("message",t),this.data=e}},SS=class extends Event{error;local;constructor(e,t,s){super("close",s),this.error=t,this.local=e}},ES=class extends SS{constructor(e,t){super(!0,e,t)}},DS=class extends SS{constructor(e,t){super(!1,e,t)}};const _S=Symbol.for("@libp2p/peer-id");function TS(e){return null!=e&&"function"==typeof e.start&&"function"==typeof e.stop}const IS=Symbol.for("@libp2p/transport");var CS;!function(e){e[e.FATAL_ALL=0]="FATAL_ALL",e[e.NO_FATAL=1]="NO_FATAL"}(CS||(CS={}));const PS=Symbol.for("@libp2p/service-capabilities"),xS=Symbol.for("@libp2p/service-dependencies"),AS=Symbol.for("nodejs.util.inspect.custom");let kS=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[_S]=!0;toString(){return null==this.string&&(this.string=G.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Ue.createV1(114,this.multihash)}toJSON(){return this.toString()}equals(e){if(null==e)return!1;if(e instanceof Uint8Array)return a(this.multihash.bytes,e);if("string"==typeof e)return this.toString()===e;if(null!=e?.toMultihash()?.bytes)return a(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[AS](){return`PeerId(${this.toString()})`}},NS=class extends kS{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},RS=class extends kS{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},MS=class extends kS{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};let LS=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=ke.digest(Ge(this.url))}[AS](){return`PeerId(${this.url})`}[_S]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return Ue.createV1(2336,this.toMultihash())}toJSON(){return this.toString()}equals(e){return null!=e&&(e instanceof Uint8Array&&(e=Qe(e)),e.toString()===this.toString())}};const OS=2336;function BS(e,t){let s;if("1"!==e.charAt(0)&&"Q"!==e.charAt(0)){if(e.startsWith("k51qzi5uqu5")||e.startsWith("kzwfwjn5ji4")||e.startsWith("k2k4r8")||e.startsWith("bafz"))return function(e){if(null==e?.multihash||null==e.version||1===e.version&&114!==e.code&&e.code!==OS)throw new gS("Supplied PeerID CID is invalid");if(e.code===OS){const t=Qe(e.multihash.digest);return new LS(new URL(t))}return US(e.multihash)}(Ue.parse(e));throw new uS('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return s=Pe(G.decode(`z${e}`)),US(s)}function US(e){if(function(e){return e.code===Me.code}(e))return new NS({multihash:e});if(function(e){return e.code===ke.code}(e))try{const t=jo(e);if("Ed25519"===t.type)return new RS({multihash:e,publicKey:t});if("secp256k1"===t.type)return new MS({multihash:e,publicKey:t})}catch(t){const s=Qe(e.digest);return new LS(new URL(s))}throw new mS("Supplied PeerID Multihash is invalid")}var VS;!function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.publicKey&&e.publicKey.byteLength>0&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.payloadType&&e.payloadType.byteLength>0&&(t.uint32(18),t.bytes(e.payloadType)),null!=e.payload&&e.payload.byteLength>0&&(t.uint32(26),t.bytes(e.payload)),null!=e.signature&&e.signature.byteLength>0&&(t.uint32(42),t.bytes(e.signature)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={publicKey:c(0),payloadType:c(0),payload:c(0),signature:c(0)},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.publicKey=e.bytes();break;case 2:r.payloadType=e.bytes();break;case 3:r.payload=e.bytes();break;case 5:r.signature=e.bytes();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(VS||(VS={}));class FS extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}class zS{static createFromProtobuf=e=>{const t=VS.decode(e),s=Ko(t.publicKey);return new zS({publicKey:s,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,s)=>{if(null==t)throw new Error("Missing private key");const r=e.domain,n=e.codec,i=e.marshal(),o=$S(r,n,i),a=await t.sign(o.subarray(),s);return new zS({publicKey:t.publicKey,payloadType:n,payload:i,signature:a})};static openAndCertify=async(e,t,s)=>{const r=zS.createFromProtobuf(e);if(!await r.validate(t,s))throw new FS("Envelope signature is not valid for the given domain");return r};publicKey;payloadType;payload;signature;marshaled;constructor(e){const{publicKey:t,payloadType:s,payload:r,signature:n}=e;this.publicKey=t,this.payloadType=s,this.payload=r,this.signature=n}marshal(){return null==this.marshaled&&(this.marshaled=VS.encode({publicKey:Ho(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return null!=e&&a(this.marshal(),e.marshal())}async validate(e,t){const s=$S(e,this.payloadType,this.payload);return this.publicKey.verify(s.subarray(),this.signature,t)}}const $S=(e,t,s)=>{const r=Ge(e),n=Ii(r.byteLength),i=Ii(t.length),o=Ii(s.length);return new cs(n,r,i,t,o,s)};let qS=class extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}};const WS=Symbol.for("@libp2p/peer-id"),KS=Symbol.for("nodejs.util.inspect.custom");let jS=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[WS]=!0;toString(){return null==this.string&&(this.string=G.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Ue.createV1(114,this.multihash)}toJSON(){return this.toString()}equals(e){if(null==e)return!1;if(e instanceof Uint8Array)return a(this.multihash.bytes,e);if("string"==typeof e)return this.toString()===e;if(null!=e?.toMultihash()?.bytes)return a(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[KS](){return`PeerId(${this.toString()})`}},HS=class extends jS{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},GS=class extends jS{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},QS=class extends jS{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};let XS=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=ke.digest(Ge(this.url))}[KS](){return`PeerId(${this.url})`}[WS]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return Ue.createV1(2336,this.toMultihash())}toJSON(){return this.toString()}equals(e){return null!=e&&(e instanceof Uint8Array&&(e=Qe(e)),e.toString()===this.toString())}};function YS(e){if(function(e){return e.code===Me.code}(e))return new HS({multihash:e});if(function(e){return e.code===ke.code}(e))try{const t=jo(e);if("Ed25519"===t.type)return new GS({multihash:e,publicKey:t});if("secp256k1"===t.type)return new QS({multihash:e,publicKey:t})}catch(t){const s=Qe(e.digest);return new XS(new URL(s))}throw new qS("Supplied PeerID Multihash is invalid")}let JS=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},ZS=class extends Error{static name="ValidationError";name="ValidationError"},eE=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"},tE=class extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"};function sE(e){return t=>Qe(t,e)}function rE(e){return t=>Ge(t,e)}function nE(e){return new DataView(e.buffer).getUint16(e.byteOffset).toString()}function iE(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,"string"==typeof e?parseInt(e):e),new Uint8Array(t)}function oE(e){const t=e.subarray(0,e.length-2),s=e.subarray(e.length-2);return`${Qe(t,"base32")}:${nE(s)}`}const aE=function(e){e=e.toString().trim();const t=new Uint8Array(4);return e.split(/\./g).forEach((e,s)=>{const r=parseInt(e,10);if(isNaN(r)||r<0||r>255)throw new JS("Invalid byte value in IP address");t[s]=r}),t};const cE=Object.values(qe).map(e=>e.decoder),lE=function(){let e=cE[0].or(cE[1]);return cE.slice(2).forEach(t=>e=e.or(t)),e}();const hE=function(...e){return t=>{for(const s of e)s(t)}}(function(e){if(parseInt(e).toString()!==e)throw new ZS("Value must be an integer")},function(e){if(e<0)throw new ZS("Value must be a positive integer, or zero")},function(e){return t=>{if(t>e)throw new ZS(`Value must be smaller than or equal to ${e}`)}}(65535)),uE=-1;const dE=new class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(t="string"==typeof e?this.protocolsByName.get(e):this.protocolsByCode.get(e),null==t)throw new tE(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);null!=t&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(e=>{this.protocolsByName.delete(e)}))}},pE=[{code:4,name:"ip4",size:32,valueToBytes:aE,bytesToValue:function(e){if(4!==e.byteLength)throw new JS("IPv4 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s++)t.push(e[s]);return t.join(".")},validate:e=>{if(!gc(e))throw new ZS(`Invalid IPv4 address "${e}"`)}},{code:6,name:"tcp",size:16,valueToBytes:iE,bytesToValue:nE,validate:hE},{code:273,name:"udp",size:16,valueToBytes:iE,bytesToValue:nE,validate:hE},{code:33,name:"dccp",size:16,valueToBytes:iE,bytesToValue:nE,validate:hE},{code:41,name:"ip6",size:128,valueToBytes:function(e){let t=0;const s=(e=e.toString().trim()).split(":",8);let r;for(r=0;r<s.length;r++){let e;gc(s[r])&&(e=aE(s[r]),s[r]=Qe(e.subarray(0,2),"base16")),null!=e&&++r<8&&s.splice(r,0,Qe(e.subarray(2,4),"base16"))}if(""===s[0])for(;s.length<8;)s.unshift("0");else if(""===s[s.length-1])for(;s.length<8;)s.push("0");else if(s.length<8){for(r=0;r<s.length&&""!==s[r];r++);const e=[r,1];for(r=9-s.length;r>0;r--)e.push("0");s.splice.apply(s,e)}const n=new Uint8Array(t+16);for(r=0;r<s.length;r++){""===s[r]&&(s[r]="0");const e=parseInt(s[r],16);if(isNaN(e)||e<0||e>65535)throw new JS("Invalid byte value in IP address");n[t++]=e>>8&255,n[t++]=255&e}return n},bytesToValue:function(e){if(16!==e.byteLength)throw new JS("IPv6 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s+=2){const r=e[s],n=e[s+1],i=`${r.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}`;t.push(i)}const s=t.join(":");try{const e=new URL(`http://[${s}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new JS(`Invalid IPv6 address "${s}"`)}},stringToValue:function(e){try{const t=new URL(`http://[${e}]`);return t.hostname.substring(1,t.hostname.length-1)}catch{throw new JS(`Invalid IPv6 address "${e}"`)}},validate:e=>{if(!mc(e))throw new ZS(`Invalid IPv6 address "${e}"`)}},{code:42,name:"ip6zone",size:uE},{code:43,name:"ipcidr",size:8,bytesToValue:sE("base10"),valueToBytes:rE("base10")},{code:53,name:"dns",size:uE},{code:54,name:"dns4",size:uE},{code:55,name:"dns6",size:uE},{code:56,name:"dnsaddr",size:uE},{code:132,name:"sctp",size:16,valueToBytes:iE,bytesToValue:nE,validate:hE},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:uE,stringToValue:e=>decodeURIComponent(e),valueToString:e=>encodeURIComponent(e)},{code:421,name:"p2p",aliases:["ipfs"],size:uE,bytesToValue:sE("base58btc"),valueToBytes:e=>e.startsWith("Q")||e.startsWith("1")?rE("base58btc")(e):Ue.parse(e).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:oE,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const s=Ge(t[0],"base32"),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=iE(r);return u([s,n],s.length+n.length)}},{code:445,name:"onion3",size:296,bytesToValue:oE,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const s=L.decode(`b${t[0]}`),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=iE(r);return u([s,n],s.length+n.length)}},{code:446,name:"garlic64",size:uE},{code:447,name:"garlic32",size:uE},{code:448,name:"tls"},{code:449,name:"sni",size:uE},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:uE,bytesToValue:function(e){return t=>e.encoder.encode(t)}(Z),valueToBytes:function(e){return lE.decode(e)}},{code:480,name:"http"},{code:481,name:"http-path",size:uE,stringToValue:e=>`/${decodeURIComponent(e)}`,valueToString:e=>encodeURIComponent(e.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:uE}];function fE(e,t,s){return null==e.size||0===e.size?0:e.size>0?e.size/8:Ci(t,s)}pE.forEach(e=>{dE.addProtocol(e)});const gE=Symbol.for("nodejs.util.inspect.custom"),mE=Symbol.for("@multiformats/multiaddr");function yE(e){if(null==e&&(e="/"),function(e){return Boolean(e?.[mE])}(e))return e.getComponents();if(e instanceof Uint8Array)return function(e){const t=[];let s=0;for(;s<e.length;){const r=Ci(e,s),n=dE.getProtocol(r),i=Di(r),o=fE(n,e,s+i);let a=0;o>0&&n.size===uE&&(a=Di(o));const c=i+a+o,l={code:r,name:n.name,bytes:e.subarray(s,s+c)};if(o>0){const t=s+i+a,r=e.subarray(t,t+o);l.value=n.bytesToValue?.(r)??Qe(r)}t.push(l),s+=c}return t}(e);if("string"==typeof e)return""===(e=e.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""))&&(e="/"),function(e){if("/"!==e.charAt(0))throw new JS('String multiaddr must start with "/"');const t=[];let s="protocol",r="",n="";for(let i=1;i<e.length;i++){const o=e.charAt(i);"/"!==o&&("protocol"===s?n+=e.charAt(i):r+=e.charAt(i));const a=i===e.length-1;if("/"===o||a){const e=dE.getProtocol(n);if("protocol"===s){if(null==e.size||0===e.size){t.push({code:e.code,name:e.name}),r="",n="",s="protocol";continue}if(a)throw new JS(`Component ${n} was missing value`);s="value"}else if("value"===s){const i={code:e.code,name:e.name};if(null!=e.size&&0!==e.size){if(""===r)throw new JS(`Component ${n} was missing value`);i.value=e.stringToValue?.(r)??r}t.push(i),r="",n="",s="protocol"}}}if(""!==n&&""!==r)throw new JS("Incomplete multiaddr");return t}(e);if(Array.isArray(e))return e;throw new JS("Must be a string, Uint8Array, Component[], or another Multiaddr")}let bE=class e{[mE]=!0;#L;#O;#B;constructor(e="/",t={}){this.#L=yE(e),!1!==t.validate&&function(e){e.getComponents().forEach(e=>{const t=dE.getProtocol(e.code);null!=e.value&&t.validate?.(e.value)})}(this)}get bytes(){return null==this.#B&&(this.#B=function(e){let t=0;const s=[];for(const r of e){if(null==r.bytes){const e=dE.getProtocol(r.code),t=Di(r.code);let s,n=0,i=0;null!=r.value&&(s=e.valueToBytes?.(r.value)??Ge(r.value),n=s.byteLength,e.size===uE&&(i=Di(n)));const o=new Uint8Array(t+i+n);let a=0;_i(r.code,o,a),a+=t,null!=s&&(e.size===uE&&(_i(n,o,a),a+=i),o.set(s,a)),r.bytes=o}s.push(r.bytes),t+=r.bytes.byteLength}return u(s,t)}(this.#L)),this.#B}toString(){return null==this.#O&&(this.#O=`/${this.#L.flatMap(e=>{if(null==e.value)return e.name;const t=dE.getProtocol(e.code);if(null==t)throw new JS(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`),this.#O}toJSON(){return this.toString()}getComponents(){return[...this.#L.map(e=>({...e}))]}encapsulate(t){const s=new e(t);return new e([...this.#L,...s.getComponents()],{validate:!1})}decapsulate(t){const s=t.toString(),r=this.toString(),n=r.lastIndexOf(s);if(n<0)throw new eE(`Address ${this.toString()} does not contain subaddress: ${s}`);return new e(r.slice(0,n),{validate:!1})}decapsulateCode(t){let s;for(let e=this.#L.length-1;e>-1;e--)if(this.#L[e].code===t){s=e;break}return new e(this.#L.slice(0,s),{validate:!1})}equals(e){return a(this.bytes,e.bytes)}[gE](){return`Multiaddr(${this.toString()})`}};const wE=Uint8Array.from([3,1]);var vE;!function(e){let t;!function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={multiaddr:c(0)},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();if(t>>>3==1)r.multiaddr=e.bytes();else e.skipType(7&t)}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(e.AddressInfo||(e.AddressInfo={})),e.codec=()=>(null==t&&(t=uo((t,s,r={})=>{if(!1!==r.lengthDelimited&&s.fork(),null!=t.peerId&&t.peerId.byteLength>0&&(s.uint32(10),s.bytes(t.peerId)),null!=t.seq&&0n!==t.seq&&(s.uint32(16),s.uint64(t.seq)),null!=t.addresses)for(const r of t.addresses)s.uint32(26),e.AddressInfo.codec().encode(r,s);!1!==r.lengthDelimited&&s.ldelim()},(t,s,r={})=>{const n={peerId:c(0),seq:0n,addresses:[]},i=null==s?t.len:t.pos+s;for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:n.peerId=t.bytes();break;case 2:n.seq=t.uint64();break;case 3:if(null!=r.limits?.addresses&&n.addresses.length===r.limits.addresses)throw new po('Decode error - map field "addresses" had too many elements');n.addresses.push(e.AddressInfo.codec().decode(t,t.uint32(),{limits:r.limits?.addresses$}));break;default:t.skipType(7&s)}}return n})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(vE||(vE={}));class SE{static createFromProtobuf=e=>{const t=vE.decode(e),s=YS(Pe(t.peerId)),r=(t.addresses??[]).map(e=>{return t=e.multiaddr,new bE(t);var t}),n=t.seq;return new SE({peerId:s,multiaddrs:r,seqNumber:n})};static DOMAIN="libp2p-peer-record";static CODEC=wE;peerId;multiaddrs;seqNumber;domain=SE.DOMAIN;codec=SE.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:s,seqNumber:r}=e;this.peerId=t,this.multiaddrs=s??[],this.seqNumber=r??BigInt(Date.now())}marshal(){return null==this.marshaled&&(this.marshaled=vE.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return e instanceof SE&&(!!this.peerId.equals(e.peerId)&&(this.seqNumber===e.seqNumber&&!!function(e,t){const s=(e,t)=>e.toString().localeCompare(t.toString());return e.length===t.length&&(t.sort(s),e.sort(s).every((e,s)=>t[s].equals(e)))}(this.multiaddrs,e.multiaddrs)))}}const EE={hash:e=>Number(Il(e,{size:32})),hashV:(e,t)=>function(e){let t=e.toString(16);t.length%2==1&&(t=`0${t}`);return Ge(t,"base16")}(EE.hash(e,t))};let DE=class{fp;h;seed;constructor(e,t,s,r=2){if(r>64)throw new TypeError("Invalid Fingerprint Size");const n=t.hashV(e,s),i=c(r);for(let e=0;e<i.length;e++)i[e]=n[e];0===i.length&&(i[0]=7),this.fp=i,this.h=t,this.seed=s}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array&&a(this.fp,e.fp)}};function _E(e,t){return Math.floor(Math.random()*(t-e))+e}let TE=class{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof DE))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof DE))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(null==this.contents[t])return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof DE))throw new TypeError("Invalid Fingerprint");const t=_E(0,this.contents.length-1),s=this.contents[t];return this.contents[t]=e,s}remove(e){if(!(e instanceof DE))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(t=>e.equals(t));return t>-1&&(this.contents[t]=null,!0)}};let IE=class{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??EE,this.seed=e.seed??_E(0,Math.pow(2,10))}add(e){"string"==typeof e&&(e=Ge(e));const t=new DE(e,this.hash,this.seed,this.fingerprintSize),s=this.hash.hash(e,this.seed)%this.filterSize,r=(s^t.hash())%this.filterSize;if(null==this.buckets[s]&&(this.buckets[s]=new TE(this.bucketSize)),null==this.buckets[r]&&(this.buckets[r]=new TE(this.bucketSize)),this.buckets[s].add(t)||this.buckets[r].add(t))return this.count++,!0;const n=[s,r];let i=n[_E(0,n.length-1)];null==this.buckets[i]&&(this.buckets[i]=new TE(this.bucketSize));for(let e=0;e<500;e++){const e=this.buckets[i].swap(t);if(null!=e&&(i=(i^e.hash())%this.filterSize,null==this.buckets[i]&&(this.buckets[i]=new TE(this.bucketSize)),this.buckets[i].add(e)))return this.count++,!0}return!1}has(e){"string"==typeof e&&(e=Ge(e));const t=new DE(e,this.hash,this.seed,this.fingerprintSize),s=this.hash.hash(e,this.seed)%this.filterSize,r=this.buckets[s]?.has(t)??!1;if(r)return r;const n=(s^t.hash())%this.filterSize;return this.buckets[n]?.has(t)??!1}remove(e){"string"==typeof e&&(e=Ge(e));const t=new DE(e,this.hash,this.seed,this.fingerprintSize),s=this.hash.hash(e,this.seed)%this.filterSize,r=this.buckets[s]?.remove(t)??!1;if(r)return this.count--,r;const n=(s^t.hash())%this.filterSize,i=this.buckets[n]?.remove(t)??!1;return i&&this.count--,i}get reliable(){return Math.floor(this.count/this.filterSize*100)<=90}};const CE={1:.5,2:.84,4:.95,8:.98};function PE(e,t=.001){const s=function(e=.001){return e>.002?2:e>1e-5?4:8}(t),r=CE[s];return{filterSize:Math.round(e/r),bucketSize:s,fingerprintSize:Math.min(Math.ceil(Math.log2(1/t)+Math.log2(2*s)),64)}}let xE=class{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??EE,this.seed=e.seed??_E(0,Math.pow(2,10)),this.filterSeries=[new IE({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if("string"==typeof e&&(e=Ge(e)),this.has(e))return!0;let t=this.filterSeries.find(e=>e.reliable);if(null==t){const e=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new IE({filterSize:e,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){"string"==typeof e&&(e=Ge(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){"string"==typeof e&&(e=Ge(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}};function AE(e,t=.001,s){return new xE({...PE(e,t)})}function kE(e,t){let s;const r=function(){clearTimeout(s),s=setTimeout(function(){s=void 0,e()},t)};return r.start=()=>{},r.stop=()=>{clearTimeout(s)},r}let NE=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}},RE=class extends Error{static name="UnexpectedEOFError";name="UnexpectedEOFError"},ME=class extends Error{static name="StreamClosedError";name="StreamClosedError"};function LE(e){return e.reason}async function OE(e,t,s){if(null==t)return e;const r=LE;if(t.aborted)return e.catch(()=>{}),Promise.reject(r(t));let n;try{return await Promise.race([e,new Promise((e,s)=>{n=()=>{s(r(t))},t.addEventListener("abort",n)})])}finally{null!=n&&t.removeEventListener("abort",n)}}let BE=class{deferred;signal;constructor(e){this.signal=e,this.deferred=jl(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new hS)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};let UE=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=`${parseInt(String(1e9*Math.random()),10).toString()}${Date.now()}`,this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((e,t)=>e&&!0===t.signal?.aborted,!0)&&(this.controller.abort(new hS),this.cleanup())}async join(e={}){const t=new BE(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await OE(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}},VE=class extends ns{concurrency;maxSize;queue;pending;sort;paused;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.paused=!1,null!=e.metricName&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=kE(this.emitEmpty.bind(this),1),this.emitIdle=kE(this.emitIdle.bind(this),1)}emitEmpty(){0===this.size&&this.safeDispatchEvent("empty")}emitIdle(){0===this.running&&this.safeDispatchEvent("idle")}pause(){this.paused=!0}resume(){this.paused&&(this.paused=!1,this.tryToStartAnother())}tryToStartAnother(){if(this.paused)return!1;if(0===this.size)return this.emitEmpty(),0===this.running&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if("queued"===t.status){e=t;break}return null!=e&&(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),null!=this.sort&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new NE;const s=new UE(e,t);return this.enqueue(s),this.safeDispatchEvent("add"),this.tryToStartAnother(),s.join(t).then(e=>(this.safeDispatchEvent("completed",{detail:e}),this.safeDispatchEvent("success",{detail:{job:s,result:e}}),e)).catch(e=>{if("queued"===s.status)for(let e=0;e<this.queue.length;e++)if(this.queue[e]===s){this.queue.splice(e,1);break}throw this.safeDispatchEvent("failure",{detail:{job:s,error:e}}),e})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new hS)}),this.clear()}async onEmpty(e){0!==this.size&&await Nm(this,"empty",e)}async onSizeLessThan(e,t){this.size<e||await Nm(this,"next",{...t,filter:()=>this.size<e})}async onIdle(e){0===this.pending&&0===this.size||await Nm(this,"idle",e)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=Xl({objectMode:!0}),s=e=>{null!=e?this.abort():this.clear(),t.end(e)},r=e=>{null!=e.detail&&t.push(e.detail)},n=e=>{s(e.detail.error)},i=()=>{s()},o=()=>{s(new hS("Queue aborted"))};this.addEventListener("completed",r),this.addEventListener("failure",n),this.addEventListener("idle",i),e?.signal?.addEventListener("abort",o);try{yield*t}finally{this.removeEventListener("completed",r),this.removeEventListener("failure",n),this.removeEventListener("idle",i),e?.signal?.removeEventListener("abort",o),s()}}};const FE=4*Math.pow(2,20);let zE=class extends ns{status;timeline;inactivityTimeout;maxReadBufferLength;maxWriteBufferLength;log;direction;maxMessageSize;readStatus;writeStatus;remoteReadStatus;remoteWriteStatus;writableNeedsDrain;readBuffer;writeBuffer;sendingData;onDrainPromise;constructor(e){super(),this.status="open",this.log=e.log,this.direction=e.direction??"outbound",this.inactivityTimeout=e.inactivityTimeout??12e4,this.maxReadBufferLength=e.maxReadBufferLength??FE,this.maxWriteBufferLength=e.maxWriteBufferLength,this.maxMessageSize=e.maxMessageSize,this.readBuffer=new cs,this.writeBuffer=new cs,this.readStatus="readable",this.remoteReadStatus="readable",this.writeStatus="writable",this.remoteWriteStatus="writable",this.sendingData=!1,this.writableNeedsDrain=!1,this.timeline={open:Date.now()},this.processSendQueue=this.processSendQueue.bind(this);this.addEventListener("drain",()=>{this.writableNeedsDrain&&(this.log.trace("drain event received, continue sending data"),this.writableNeedsDrain=!1,this.processSendQueue()),this.onDrainPromise?.resolve()});this.addEventListener("close",e=>{this.onDrainPromise?.reject(e.error??new ME)})}get readBufferLength(){return this.readBuffer.byteLength}get writeBufferLength(){return this.writeBuffer.byteLength}async onDrain(e){return!0!==this.writableNeedsDrain?Promise.resolve():(null==this.onDrainPromise&&(this.onDrainPromise=Promise.withResolvers()),OE(this.onDrainPromise.promise,e?.signal))}async*[Symbol.asyncIterator](){if("readable"!==this.readStatus&&"paused"!==this.readStatus)return;const e=Xl(),t=t=>{e.push(t.data)};this.addEventListener("message",t);const s=t=>{e.end(t.error)};this.addEventListener("close",s);const r=()=>{e.end()};this.addEventListener("remoteCloseWrite",r);try{yield*e}finally{this.removeEventListener("message",t),this.removeEventListener("close",s),this.removeEventListener("remoteCloseWrite",r)}}isReadable(){return"open"===this.status}send(e){if("closed"===this.writeStatus||"closing"===this.writeStatus)throw new pS(`Cannot write to a stream that is ${this.writeStatus}`);return this.log.trace("append %d bytes to write buffer",e.byteLength),this.writeBuffer.append(e),this.processSendQueue()}abort(e){if("aborted"!==this.status&&"reset"!==this.status&&"closed"!==this.status){this.log.error("abort with error - %e",e),this.status="aborted",this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle")),this.writeStatus="closed",this.remoteWriteStatus="closed",this.readStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now();try{this.sendReset(e)}catch(e){this.log("failed to send reset to remote - %e",e)}this.dispatchEvent(new ES(e))}}pause(){if("closed"===this.readStatus||"closing"===this.readStatus)throw new pS("Cannot pause a stream that is closing/closed");"paused"!==this.readStatus&&(this.readStatus="paused",this.sendPause())}resume(){if("closed"===this.readStatus||"closing"===this.readStatus)throw new pS("Cannot resume a stream that is closing/closed");"readable"!==this.readStatus&&(this.readStatus="readable",this.dispatchReadBuffer(),this.sendResume())}push(e){if("closed"===this.readStatus||"closing"===this.readStatus)throw new pS(`Cannot push data onto a stream that is ${this.readStatus}`);0!==e.byteLength&&(this.readBuffer.append(e),"paused"!==this.readStatus&&0!==this.listenerCount("message")?setTimeout(()=>{this.dispatchReadBuffer()},0):this.checkReadBufferLength())}unshift(e){if("closed"===this.readStatus||"closing"===this.readStatus)throw new pS(`Cannot push data onto a stream that is ${this.readStatus}`);0!==e.byteLength&&(this.readBuffer.prepend(e),"paused"!==this.readStatus&&0!==this.listenerCount("message")?setTimeout(()=>{this.dispatchReadBuffer()},0):this.checkReadBufferLength())}onData(e){0!==e.byteLength&&("closing"!==this.readStatus&&"closed"!==this.readStatus?(this.readBuffer.append(e),this.dispatchReadBuffer()):this.log("ignoring data - read status %s",this.readStatus))}addEventListener(...e){super.addEventListener.apply(this,e),"message"===e[0]&&this.readBuffer.byteLength>0&&queueMicrotask(()=>{this.dispatchReadBuffer()})}onRemoteReset(){this.log("remote reset"),this.status="reset",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now(),0===this.readBuffer.byteLength&&(this.readStatus="closed");const e=new dS;this.dispatchEvent(new DS(e))}onTransportClosed(e){this.log("transport closed"),"readable"===this.readStatus&&0===this.readBuffer.byteLength&&(this.log("close readable end after transport closed and read buffer is empty"),this.readStatus="closed"),"closed"!==this.remoteReadStatus&&(this.remoteReadStatus="closed"),"closed"!==this.remoteWriteStatus&&(this.remoteWriteStatus="closed"),"closed"!==this.writeStatus&&(this.writeStatus="closed"),null!=e?this.abort(e):"open"!==this.status&&"closing"!==this.status||(this.timeline.close=Date.now(),this.status="closed",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.dispatchEvent(new SS))}onRemoteCloseWrite(){"closed"!==this.remoteWriteStatus&&(this.log.trace("on remote close write"),this.remoteWriteStatus="closed",this.safeDispatchEvent("remoteCloseWrite"),"closed"===this.writeStatus&&this.onTransportClosed())}onRemoteCloseRead(){this.log.trace("on remote close read"),this.remoteReadStatus="closed",this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle"))}processSendQueue(){if(this.writableNeedsDrain)return this.log.trace("not processing send queue as drain is required"),this.checkWriteBufferLength(),!1;if(0===this.writeBuffer.byteLength)return this.log.trace("not processing send queue as no bytes to send"),!0;if(this.sendingData)return this.log.trace("not processing send queue as already sending data"),!0;this.sendingData=!0,this.log.trace("processing send queue with %d queued bytes",this.writeBuffer.byteLength);try{let e=!0;const t=this.writeBuffer.byteLength;let s=0;for(;this.writeBuffer.byteLength>0;){const t=Math.min(this.maxMessageSize??this.writeBuffer.byteLength,this.writeBuffer.byteLength);if(0===t){e=!1;break}const r=this.writeBuffer.sublist(0,t),n=new cs(r);this.writeBuffer.consume(r.byteLength);const i=this.sendData(r);if(e=i.canSendMore,s+=i.sentBytes,i.sentBytes!==n.byteLength&&(n.consume(i.sentBytes),this.writeBuffer.prepend(n)),!e)break}return e||(this.log.trace("sent %d/%d bytes, pausing sending because underlying stream is full, %d bytes left in the write buffer",s,t,this.writeBuffer.byteLength),this.writableNeedsDrain=!0,this.checkWriteBufferLength()),0===this.writeBuffer.byteLength&&this.safeDispatchEvent("idle"),e}finally{this.sendingData=!1}}dispatchReadBuffer(){try{if(0===this.listenerCount("message"))return void this.log.trace("not dispatching pause buffer as there are no listeners for the message event");if(0===this.readBuffer.byteLength)return void this.log.trace("not dispatching pause buffer as there is no data to dispatch");if("paused"===this.readStatus)return void this.log.trace("not dispatching pause buffer we are paused");if("closing"===this.readStatus||"closed"===this.readStatus)return this.log("dropping %d bytes because the readable end is %s",this.readBuffer.byteLength,this.readStatus),void this.readBuffer.consume(this.readBuffer.byteLength);const e=this.readBuffer.sublist();this.readBuffer.consume(e.byteLength),this.dispatchEvent(new vS(e))}finally{0===this.readBuffer.byteLength&&"closed"===this.remoteWriteStatus&&(this.log("close readable end after dispatching read buffer and remote writable end is closed"),this.readStatus="closed"),this.checkReadBufferLength()}}checkReadBufferLength(){this.readBuffer.byteLength>this.maxReadBufferLength&&this.abort(new fS(`Read buffer length of ${this.readBuffer.byteLength} exceeded limit of ${this.maxReadBufferLength}, read status is ${this.readStatus}`))}checkWriteBufferLength(){null!=this.maxWriteBufferLength&&this.writeBuffer.byteLength>this.maxWriteBufferLength&&this.abort(new fS(`Write buffer length of ${this.writeBuffer.byteLength} exceeded limit of ${this.maxWriteBufferLength}, write status is ${this.writeStatus}`))}onMuxerNeedsDrain(){this.writableNeedsDrain=!0}onMuxerDrain(){this.safeDispatchEvent("drain")}};class $E extends zE{remoteAddr;metricPrefix;metrics;constructor(e){super(e),this.metricPrefix=e.metricPrefix??"",this.metrics=e.metrics,this.remoteAddr=e.remoteAddr,this.addEventListener("close",e=>{this.metrics?.increment({[`${this.metricPrefix}end`]:!0}),null!=e.error?e.local?this.metrics?.increment({[`${this.metricPrefix}abort`]:!0}):this.metrics?.increment({[`${this.metricPrefix}reset`]:!0}):e.local?this.metrics?.increment({[`${this.metricPrefix}_local_close`]:!0}):this.metrics?.increment({[`${this.metricPrefix}_remote_close`]:!0})})}async close(e){"open"===this.status&&(this.status="closing",this.writeStatus="closing",this.remoteWriteStatus="closing",this.remoteReadStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await Nm(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await Nm(this,"drain",{...e,rejectionEvents:["close"]})),await this.sendClose(e),this.onTransportClosed())}}let qE=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},WE=class extends Error{static name="ValidationError";name="ValidationError"},KE=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"},jE=class extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"};const HE=421;function GE(e){return t=>Qe(t,e)}function QE(e){return t=>Ge(t,e)}function XE(e){return new DataView(e.buffer).getUint16(e.byteOffset).toString()}function YE(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,"string"==typeof e?parseInt(e):e),new Uint8Array(t)}function JE(e){const t=e.subarray(0,e.length-2),s=e.subarray(e.length-2);return`${Qe(t,"base32")}:${XE(s)}`}const ZE=function(e){e=e.toString().trim();const t=new Uint8Array(4);return e.split(/\./g).forEach((e,s)=>{const r=parseInt(e,10);if(isNaN(r)||r<0||r>255)throw new qE("Invalid byte value in IP address");t[s]=r}),t};const eD=Object.values(qe).map(e=>e.decoder),tD=function(){let e=eD[0].or(eD[1]);return eD.slice(2).forEach(t=>e=e.or(t)),e}();const sD=function(...e){return t=>{for(const s of e)s(t)}}(function(e){if(parseInt(e).toString()!==e)throw new WE("Value must be an integer")},function(e){if(e<0)throw new WE("Value must be a positive integer, or zero")},function(e){return t=>{if(t>e)throw new WE(`Value must be smaller than or equal to ${e}`)}}(65535)),rD=-1;const nD=new class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(t="string"==typeof e?this.protocolsByName.get(e):this.protocolsByCode.get(e),null==t)throw new jE(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);null!=t&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(e=>{this.protocolsByName.delete(e)}))}},iD=[{code:4,name:"ip4",size:32,valueToBytes:ZE,bytesToValue:function(e){if(4!==e.byteLength)throw new qE("IPv4 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s++)t.push(e[s]);return t.join(".")},validate:e=>{if(!gc(e))throw new WE(`Invalid IPv4 address "${e}"`)}},{code:6,name:"tcp",size:16,valueToBytes:YE,bytesToValue:XE,validate:sD},{code:273,name:"udp",size:16,valueToBytes:YE,bytesToValue:XE,validate:sD},{code:33,name:"dccp",size:16,valueToBytes:YE,bytesToValue:XE,validate:sD},{code:41,name:"ip6",size:128,valueToBytes:function(e){let t=0;const s=(e=e.toString().trim()).split(":",8);let r;for(r=0;r<s.length;r++){let e;gc(s[r])&&(e=ZE(s[r]),s[r]=Qe(e.subarray(0,2),"base16")),null!=e&&++r<8&&s.splice(r,0,Qe(e.subarray(2,4),"base16"))}if(""===s[0])for(;s.length<8;)s.unshift("0");else if(""===s[s.length-1])for(;s.length<8;)s.push("0");else if(s.length<8){for(r=0;r<s.length&&""!==s[r];r++);const e=[r,1];for(r=9-s.length;r>0;r--)e.push("0");s.splice.apply(s,e)}const n=new Uint8Array(t+16);for(r=0;r<s.length;r++){""===s[r]&&(s[r]="0");const e=parseInt(s[r],16);if(isNaN(e)||e<0||e>65535)throw new qE("Invalid byte value in IP address");n[t++]=e>>8&255,n[t++]=255&e}return n},bytesToValue:function(e){if(16!==e.byteLength)throw new qE("IPv6 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s+=2){const r=e[s],n=e[s+1],i=`${r.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}`;t.push(i)}const s=t.join(":");try{const e=new URL(`http://[${s}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new qE(`Invalid IPv6 address "${s}"`)}},stringToValue:function(e){try{const t=new URL(`http://[${e}]`);return t.hostname.substring(1,t.hostname.length-1)}catch{throw new qE(`Invalid IPv6 address "${e}"`)}},validate:e=>{if(!mc(e))throw new WE(`Invalid IPv6 address "${e}"`)}},{code:42,name:"ip6zone",size:rD},{code:43,name:"ipcidr",size:8,bytesToValue:GE("base10"),valueToBytes:QE("base10")},{code:53,name:"dns",size:rD},{code:54,name:"dns4",size:rD},{code:55,name:"dns6",size:rD},{code:56,name:"dnsaddr",size:rD},{code:132,name:"sctp",size:16,valueToBytes:YE,bytesToValue:XE,validate:sD},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:rD,stringToValue:e=>decodeURIComponent(e),valueToString:e=>encodeURIComponent(e)},{code:HE,name:"p2p",aliases:["ipfs"],size:rD,bytesToValue:GE("base58btc"),valueToBytes:e=>e.startsWith("Q")||e.startsWith("1")?QE("base58btc")(e):Ue.parse(e).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:JE,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const s=Ge(t[0],"base32"),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=YE(r);return u([s,n],s.length+n.length)}},{code:445,name:"onion3",size:296,bytesToValue:JE,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const s=L.decode(`b${t[0]}`),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=YE(r);return u([s,n],s.length+n.length)}},{code:446,name:"garlic64",size:rD},{code:447,name:"garlic32",size:rD},{code:448,name:"tls"},{code:449,name:"sni",size:rD},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:rD,bytesToValue:function(e){return t=>e.encoder.encode(t)}(Z),valueToBytes:function(e){return tD.decode(e)}},{code:480,name:"http"},{code:481,name:"http-path",size:rD,stringToValue:e=>`/${decodeURIComponent(e)}`,valueToString:e=>encodeURIComponent(e.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:rD}];function oD(e,t,s){return null==e.size||0===e.size?0:e.size>0?e.size/8:Ci(t,s)}iD.forEach(e=>{nD.addProtocol(e)});const aD=Symbol.for("nodejs.util.inspect.custom"),cD=Symbol.for("@multiformats/multiaddr");function lD(e){if(null==e&&(e="/"),function(e){return Boolean(e?.[cD])}(e))return e.getComponents();if(e instanceof Uint8Array)return function(e){const t=[];let s=0;for(;s<e.length;){const r=Ci(e,s),n=nD.getProtocol(r),i=Di(r),o=oD(n,e,s+i);let a=0;o>0&&n.size===rD&&(a=Di(o));const c=i+a+o,l={code:r,name:n.name,bytes:e.subarray(s,s+c)};if(o>0){const t=s+i+a,r=e.subarray(t,t+o);l.value=n.bytesToValue?.(r)??Qe(r)}t.push(l),s+=c}return t}(e);if("string"==typeof e)return""===(e=e.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""))&&(e="/"),function(e){if("/"!==e.charAt(0))throw new qE('String multiaddr must start with "/"');const t=[];let s="protocol",r="",n="";for(let i=1;i<e.length;i++){const o=e.charAt(i);"/"!==o&&("protocol"===s?n+=e.charAt(i):r+=e.charAt(i));const a=i===e.length-1;if("/"===o||a){const e=nD.getProtocol(n);if("protocol"===s){if(null==e.size||0===e.size){t.push({code:e.code,name:e.name}),r="",n="",s="protocol";continue}if(a)throw new qE(`Component ${n} was missing value`);s="value"}else if("value"===s){const i={code:e.code,name:e.name};if(null!=e.size&&0!==e.size){if(""===r)throw new qE(`Component ${n} was missing value`);i.value=e.stringToValue?.(r)??r}t.push(i),r="",n="",s="protocol"}}}if(""!==n&&""!==r)throw new qE("Incomplete multiaddr");return t}(e);if(Array.isArray(e))return e;throw new qE("Must be a string, Uint8Array, Component[], or another Multiaddr")}let hD=class e{[cD]=!0;#L;#O;#B;constructor(e="/",t={}){this.#L=lD(e),!1!==t.validate&&function(e){e.getComponents().forEach(e=>{const t=nD.getProtocol(e.code);null!=e.value&&t.validate?.(e.value)})}(this)}get bytes(){return null==this.#B&&(this.#B=function(e){let t=0;const s=[];for(const r of e){if(null==r.bytes){const e=nD.getProtocol(r.code),t=Di(r.code);let s,n=0,i=0;null!=r.value&&(s=e.valueToBytes?.(r.value)??Ge(r.value),n=s.byteLength,e.size===rD&&(i=Di(n)));const o=new Uint8Array(t+i+n);let a=0;_i(r.code,o,a),a+=t,null!=s&&(e.size===rD&&(_i(n,o,a),a+=i),o.set(s,a)),r.bytes=o}s.push(r.bytes),t+=r.bytes.byteLength}return u(s,t)}(this.#L)),this.#B}toString(){return null==this.#O&&(this.#O=`/${this.#L.flatMap(e=>{if(null==e.value)return e.name;const t=nD.getProtocol(e.code);if(null==t)throw new qE(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`),this.#O}toJSON(){return this.toString()}getComponents(){return[...this.#L.map(e=>({...e}))]}encapsulate(t){const s=new e(t);return new e([...this.#L,...s.getComponents()],{validate:!1})}decapsulate(t){const s=t.toString(),r=this.toString(),n=r.lastIndexOf(s);if(n<0)throw new KE(`Address ${this.toString()} does not contain subaddress: ${s}`);return new e(r.slice(0,n),{validate:!1})}decapsulateCode(t){let s;for(let e=this.#L.length-1;e>-1;e--)if(this.#L[e].code===t){s=e;break}return new e(this.#L.slice(0,s),{validate:!1})}equals(e){return a(this.bytes,e.bytes)}[aD](){return`Multiaddr(${this.toString()})`}};function uD(e){return new hD(e)}let dD=class extends Error{static name="UnwrappedError";name="UnwrappedError"},pD=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},fD=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},gD=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function mD(e){return function(e){return"function"==typeof e?.closeRead}(e)?"writable"!==e.remoteWriteStatus&&0===e.readBufferLength:!!function(e){return"function"==typeof e?.close}(e)&&"open"!==e.status}function yD(e,t={}){const s=function(e,t){const s=t?.maxBufferSize??4194304,r=new cs;let n,i=!1;if(o=e,null==o?.addEventListener||null==o?.removeEventListener||null==o?.send||null==o?.push||null==o?.log)throw new uS("Argument should be a Stream or a Multiaddr");var o;const a=e=>{if(r.append(e.data),r.byteLength>s){const e=r.byteLength;r.consume(r.byteLength),n?.reject(new Error(`Read buffer overflow - ${e} > ${s}`))}n?.resolve()};e.addEventListener("message",a);const c=e=>{null!=e.error?n?.reject(e.error):n?.resolve()};e.addEventListener("close",c);const l=()=>{n?.resolve()};e.addEventListener("remoteCloseWrite",l);const h={readBuffer:r,async read(t){if(!0===i)throw new dD("Stream was unwrapped");if(mD(e)){if(null==t?.bytes)return null;if(r.byteLength<t.bytes)throw e.log.error("closed after reading %d/%d bytes",r.byteLength,t.bytes),new RE(`Unexpected EOF - stream closed after reading ${r.byteLength}/${t.bytes} bytes`)}const s=t?.bytes??1;for(n=Promise.withResolvers();;){if(r.byteLength>=s){n.resolve();break}if(await OE(n.promise,t?.signal),mD(e)){if(0===r.byteLength&&null==t?.bytes)return null;break}n=Promise.withResolvers()}const o=t?.bytes??r.byteLength;if(r.byteLength<o){if(mD(e))throw e.log.error("closed while reading %d/%d bytes",r.byteLength,o),new RE(`Unexpected EOF - stream closed while reading ${r.byteLength}/${o} bytes`);return h.read(t)}const a=r.sublist(0,o);return r.consume(o),a},async write(t,s){if(!0===i)throw new dD("Stream was unwrapped");e.send(t)||await Nm(e,"drain",{signal:s?.signal,rejectionEvents:["close"]})},unwrap:()=>(i||(i=!0,e.removeEventListener("message",a),e.removeEventListener("close",c),e.removeEventListener("remoteCloseWrite",l),r.byteLength>0&&(e.log("stream unwrapped with %d unread bytes",r.byteLength),e.push(r))),e)};return h}(e,t);null!=t.maxDataLength&&null==t.maxLengthLength&&(t.maxLengthLength=Di(t.maxDataLength));const r=t?.lengthDecoder??Ci,n=t?.lengthEncoder??Ii;return{async read(n){let i=-1;const o=new cs;for(;;){const e=await s.read({...n,bytes:1});if(null==e)break;o.append(e);try{i=r(o)}catch(e){if(e instanceof RangeError)continue;throw e}if(i<0)throw new pD("Invalid message length");if(null!=t?.maxLengthLength&&o.byteLength>t.maxLengthLength)throw new gD(`Message length length too long - ${o.byteLength} > ${t.maxLengthLength}`);if(i>-1)break}if(null!=t?.maxDataLength&&i>t.maxDataLength)throw new fD(`Message length too long - ${i} > ${t.maxDataLength}`);const a=await s.read({...n,bytes:i});if(null==a)throw e.log.error("tried to read %d bytes but the stream closed",i),new RE(`Unexpected EOF - tried to read ${i} bytes but the stream closed`);if(a.byteLength!==i)throw e.log.error("read %d/%d bytes before the stream closed",a.byteLength,i),new RE(`Unexpected EOF - read ${a.byteLength}/${i} bytes before the stream closed`);return a},async write(e,t){await s.write(new cs(n(e.byteLength),e),t)},async writeV(e,t){const r=new cs(...e.flatMap(e=>[n(e.byteLength),e]));await s.write(r,t)},unwrap:()=>s.unwrap()}}function bD(e,t){const s=yD(e,t),r={read:async(e,t)=>{const r=await s.read(t);return e.decode(r)},write:async(e,t,r)=>{await s.write(t.encode(e),r)},writeV:async(e,t,r)=>{await s.writeV(e.map(e=>t.encode(e)),r)},pb:e=>({read:async t=>r.read(e,t),write:async(t,s)=>r.write(t,e,s),writeV:async(t,s)=>r.writeV(t,e,s),unwrap:()=>r}),unwrap:()=>s.unwrap()};return r}let wD=class extends VE{has(e){return null!=this.find(e)}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}};const vD="keep-alive-circuit-relay";BigInt(1<<17);const SD="/libp2p/circuit/relay/0.2.0/hop",ED="/libp2p/circuit/relay/0.2.0/stop";var DD,_D,TD,ID,CD,PD,xD,AD,kD;!function(e){var t;let s,r;(t=e.Type||(e.Type={})).RESERVE="RESERVE",t.CONNECT="CONNECT",t.STATUS="STATUS",function(e){e[e.RESERVE=0]="RESERVE",e[e.CONNECT=1]="CONNECT",e[e.STATUS=2]="STATUS"}(s||(s={})),function(e){e.codec=()=>ho(s)}(e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=uo((t,s,r={})=>{!1!==r.lengthDelimited&&s.fork(),null!=t.type&&(s.uint32(8),e.Type.codec().encode(t.type,s)),null!=t.peer&&(s.uint32(18),TD.codec().encode(t.peer,s)),null!=t.reservation&&(s.uint32(26),ID.codec().encode(t.reservation,s)),null!=t.limit&&(s.uint32(34),CD.codec().encode(t.limit,s)),null!=t.status&&(s.uint32(40),PD.codec().encode(t.status,s)),!1!==r.lengthDelimited&&s.ldelim()},(t,s,r={})=>{const n={},i=null==s?t.len:t.pos+s;for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:n.type=e.Type.codec().decode(t);break;case 2:n.peer=TD.codec().decode(t,t.uint32(),{limits:r.limits?.peer});break;case 3:n.reservation=ID.codec().decode(t,t.uint32(),{limits:r.limits?.reservation});break;case 4:n.limit=CD.codec().decode(t,t.uint32(),{limits:r.limits?.limit});break;case 5:n.status=PD.codec().decode(t);break;default:t.skipType(7&s)}}return n})),r),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(DD||(DD={})),function(e){var t;let s,r;(t=e.Type||(e.Type={})).CONNECT="CONNECT",t.STATUS="STATUS",function(e){e[e.CONNECT=0]="CONNECT",e[e.STATUS=1]="STATUS"}(s||(s={})),function(e){e.codec=()=>ho(s)}(e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=uo((t,s,r={})=>{!1!==r.lengthDelimited&&s.fork(),null!=t.type&&(s.uint32(8),e.Type.codec().encode(t.type,s)),null!=t.peer&&(s.uint32(18),TD.codec().encode(t.peer,s)),null!=t.limit&&(s.uint32(26),CD.codec().encode(t.limit,s)),null!=t.status&&(s.uint32(32),PD.codec().encode(t.status,s)),!1!==r.lengthDelimited&&s.ldelim()},(t,s,r={})=>{const n={},i=null==s?t.len:t.pos+s;for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:n.type=e.Type.codec().decode(t);break;case 2:n.peer=TD.codec().decode(t,t.uint32(),{limits:r.limits?.peer});break;case 3:n.limit=CD.codec().decode(t,t.uint32(),{limits:r.limits?.limit});break;case 4:n.status=PD.codec().decode(t);break;default:t.skipType(7&s)}}return n})),r),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(_D||(_D={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{if(!1!==s.lengthDelimited&&t.fork(),null!=e.id&&e.id.byteLength>0&&(t.uint32(10),t.bytes(e.id)),null!=e.addrs)for(const s of e.addrs)t.uint32(18),t.bytes(s);!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={id:c(0),addrs:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.id=e.bytes();break;case 2:if(null!=s.limits?.addrs&&r.addrs.length===s.limits.addrs)throw new po('Decode error - map field "addrs" had too many elements');r.addrs.push(e.bytes());break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(TD||(TD={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{if(!1!==s.lengthDelimited&&t.fork(),null!=e.expire&&0n!==e.expire&&(t.uint32(8),t.uint64(e.expire)),null!=e.addrs)for(const s of e.addrs)t.uint32(18),t.bytes(s);null!=e.voucher&&(t.uint32(26),kD.codec().encode(e.voucher,t)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={expire:0n,addrs:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.expire=e.uint64();break;case 2:if(null!=s.limits?.addrs&&r.addrs.length===s.limits.addrs)throw new po('Decode error - map field "addrs" had too many elements');r.addrs.push(e.bytes());break;case 3:r.voucher=kD.codec().decode(e,e.uint32(),{limits:s.limits?.voucher});break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(ID||(ID={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.duration&&(t.uint32(8),t.uint32(e.duration)),null!=e.data&&(t.uint32(16),t.uint64(e.data)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.duration=e.uint32();break;case 2:r.data=e.uint64();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(CD||(CD={})),function(e){e.UNUSED="UNUSED",e.OK="OK",e.RESERVATION_REFUSED="RESERVATION_REFUSED",e.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONNECTION_FAILED="CONNECTION_FAILED",e.NO_RESERVATION="NO_RESERVATION",e.MALFORMED_MESSAGE="MALFORMED_MESSAGE",e.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"}(PD||(PD={})),function(e){e[e.UNUSED=0]="UNUSED",e[e.OK=100]="OK",e[e.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",e[e.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",e[e.PERMISSION_DENIED=202]="PERMISSION_DENIED",e[e.CONNECTION_FAILED=203]="CONNECTION_FAILED",e[e.NO_RESERVATION=204]="NO_RESERVATION",e[e.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",e[e.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"}(xD||(xD={})),function(e){e.codec=()=>ho(xD)}(PD||(PD={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.relay&&e.relay.byteLength>0&&(t.uint32(10),t.bytes(e.relay)),null!=e.peer&&e.peer.byteLength>0&&(t.uint32(18),t.bytes(e.peer)),null!=e.expiration&&0n!==e.expiration&&(t.uint32(24),t.uint64(e.expiration)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={relay:c(0),peer:c(0),expiration:0n},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.relay=e.bytes();break;case 2:r.peer=e.bytes();break;case 3:r.expiration=e.uint64();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(AD||(AD={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.publicKey&&e.publicKey.byteLength>0&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.payloadType&&e.payloadType.byteLength>0&&(t.uint32(18),t.bytes(e.payloadType)),null!=e.payload&&(t.uint32(26),AD.codec().encode(e.payload,t)),null!=e.signature&&e.signature.byteLength>0&&(t.uint32(42),t.bytes(e.signature)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={publicKey:c(0),payloadType:c(0),signature:c(0)},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.publicKey=e.bytes();break;case 2:r.payloadType=e.bytes();break;case 3:r.payload=AD.codec().decode(e,e.uint32(),{limits:s.limits?.payload});break;case 5:r.signature=e.bytes();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(kD||(kD={}));class ND extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"}class RD extends Error{static name="DoubleRelayError";name="DoubleRelayError"}class MD extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"}function LD(e){const t=e*BigInt(1e3),s=(new Date).getTime();return Number(t-BigInt(s))}class OD{expires;bytes;constructor(e){null!=e?.duration&&0!==e?.duration&&(this.expires=Date.now()+1e3*e.duration),this.bytes=e?.data,0n===this.bytes&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){null!=this.bytes&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(null==this.expires&&null==this.bytes)return;const e={};if(null!=this.bytes){const t=this;Object.defineProperty(e,"bytes",{get:()=>t.bytes})}if(null!=this.expires){const t=this;Object.defineProperty(e,"seconds",{get:()=>Math.round(((t.expires??0)-Date.now())/1e3)})}return e}}const BD=Jg(Yg(Em.matchers[0],Hg(290))),UD=Jg(Hg(290));function VD(e,t){const s={[Symbol.iterator]:()=>s,next:()=>{const s=e.next(),r=s.value;if(!0===s.done||null==r){return{done:!0,value:void 0}}return{done:!1,value:t(r)}}};return s}let FD=class{map;constructor(e){if(this.map=new Map,null!=e)for(const[t,s]of e.entries())this.map.set(t.toString(),{key:t,value:s})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return VD(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,s)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return VD(this.map.values(),e=>e.key)}values(){return VD(this.map.values(),e=>e.value)}get size(){return this.map.size}};class zD{filter;constructor(e,t){this.filter=AE(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}}function $D(e,t=.001){return new zD(e,t)}class qD extends ns{components;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=e,this.started=!1,this.running=!1,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(SD,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){null!=this.topologyId&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{this.log("searching peer store for relays");const e=await this.components.peerStore.all({filters:[e=>e.protocols.includes(SD)],orders:[()=>Math.random()<.5?1:-1,(e,t)=>{const s=WD(e),r=WD(t);return s>r?-1:r>s?1:0}]});for(const t of e)this.log.trace("found relay peer %p in peer store",t.id),this.safeDispatchEvent("relay:discover",{detail:t.id});this.log("found %d relay peers in peer store",e.length);const t=this.queue=new wD({concurrency:5});this.log("start random walk");for await(const e of this.components.randomWalk.walk({signal:this.discoveryController.signal}))this.log.trace("found random peer %p",e.id),t.has(e.id)?this.log.trace("random peer %p was already in queue",e.id):this.components.connectionManager.getConnections(e.id)?.length>0?this.log.trace("random peer %p was already connected",e.id):await this.components.connectionManager.isDialable(e.multiaddrs)?(t.queued>10&&(this.log.trace("wait for space in queue for %p",e.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",e.id,t.size,t.running),t.add(this.dialPeer,{peerId:e.id,signal:this.discoveryController.signal}).catch(t=>{this.log.error("error opening connection to random peer %p - %e",e.id,t)})):this.log.trace("random peer %p was not dialable",e.id,e.multiaddrs.map(e=>e.toString()));this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network - %e",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort(),this.queue?.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(e){this.log.trace("maybe dialing discovered peer %p",e.detail.id),this.maybeDialPeer(e).catch(t=>{this.log.trace("error dialing discovered peer %p - %e",e.detail.id,t)})}async maybeDialPeer(e){if(null==this.queue)return;const t=e.detail.id,s=e.detail.multiaddrs;this.queue.has(t)?this.log.trace("random peer %p was already in queue",t):this.components.connectionManager.getConnections(t)?.length>0?this.log.trace("random peer %p was already connected",t):await this.components.connectionManager.isDialable(s)?this.queue?.add(this.dialPeer,{peerId:e.detail.id,signal:this.discoveryController.signal}).catch(t=>{this.log.error("error opening connection to discovered peer %p - %e",e.detail.id,t)}):this.log.trace("random peer %p was not dialable",t)}async dialPeer({peerId:e,signal:t}){const s=ip([AbortSignal.timeout(5e3),t]);try{await this.components.connectionManager.openConnection(e,{signal:s})}finally{s.clear()}}}function WD(e){const t=e.metadata.get("last-dial-success");return null==t?0:new Date(Qe(t)).getTime()}class KD extends ns{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??5e3,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),!0===this.relay?.equals(e.detail.relay)&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(e=>{this.addressManager.removeObservedAddr(e)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{const{details:t}=e.detail;"configured"!==t.type&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(UD.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else{if(!BD.exactMatch(e))throw new wS(`Could not listen on p2p-circuit address "${e}"`);{this.log("listen on specific relay server %a",e);const t=AbortSignal.timeout(this.listenTimeout),s=e.decapsulate("/p2p-circuit"),r=await this.connectionManager.openConnection(s,{signal:t});if(!this.reservationStore.hasReservation(r.remotePeer)){this.log("making reservation on peer %p",r.remotePeer);const e=await this.reservationStore.addRelay(r.remotePeer,"configured");this.addedRelay(e)}}}}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(e=>uD(e).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(e=>{this.addressManager.confirmObservedAddr(e,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}class jD extends ns{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new FD,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??100,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??5e3,this.started=!1,this.relayFilter=AE(100),this.reserveQueue=new wD({concurrency:t?.reservationConcurrency??1,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",e=>{null!=[...this.reservations.values()].find(t=>t.connection===e.detail.id)&&this.#q(e.detail.remotePeer).catch(t=>{this.log("could not remove relay %p - %e",e.detail,t)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[e=>e.tags.has(vD)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async e=>{await this.peerStore.merge(e.id,{tags:{[vD]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async e=>this.addRelay(e.id,"discovered"))),this.#W()}).catch(e=>{this.log.error("failed to clean up and redial old relays during afterStart - %e",e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){const e=((e=21)=>{let t="",s=crypto.getRandomValues(new Uint8Array(e|=0));for(;e--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&s[e]];return t})();return this.pendingReservations.push(e),this.#W(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new wS("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new MD("The reservation queue is full");const s=this.reserveQueue.find(e);if(null!=s)return this.log.trace("potential relay peer %p is already in the reservation queue",e),s.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new wS("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{const s=Date.now();try{const s=this.reservations.get(e);if(null!=s){const t=this.connectionManager.getConnections(e);let r=!1;if(0===t.length&&this.log("already have relay reservation with %p but we are no longer connected",e),t.map(e=>e.id).includes(s.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),r=!0),r&&LD(s.reservation.expire)>6e5)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:s};await this.#q(e)}if("discovered"===t&&0===this.pendingReservations.length)throw new ND("Not making reservation on discovered relay because we do not need any more relays");const r=AbortSignal.timeout(this.reservationCompletionTimeout),n=await this.connectionManager.openConnection(e,{signal:r});if(_m.matches(n.remoteAddr))throw new RD("not creating reservation over relayed connection");const i=await this.#K(n,{signal:r}),o=LD(i.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+o).toString());const a=Math.min(Math.max(o-3e5,3e4),Math.pow(2,31)-1),c=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async t=>{this.log.error("could not refresh reservation to relay %p - %e",e,t),await this.#q(e)}).catch(t=>{this.log.error("could not remove expired reservation to relay %p - %e",e,t)})},a);let l;if("discovered"===t){const e=this.pendingReservations.pop();if(null==e)throw new ND("Made reservation on relay but did not need any more discovered relays");l={timeout:c,reservation:i,type:t,connection:n.id,id:e}}else l={timeout:c,reservation:i,type:t,connection:n.id};this.reservations.set(e,l),await this.peerStore.merge(e,{tags:{[vD]:{value:1,ttl:o}}}),this.#W();const h={relay:e,details:l};return this.safeDispatchEvent("relay:created-reservation",{detail:h}),h}catch(r){throw"discovered"===t&&"HadEnoughRelaysError"===r.name||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-s,r),"DialError"!==r.name&&"UnsupportedProtocolError"!==r.name||this.relayFilter.add(e.toMultihash().bytes),this.#q(e).catch(t=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,t)}),r}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return null==e?this.reservations.size:[...this.reservations.values()].reduce((t,s)=>(s.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#K(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const s=await e.newStream(SD,t),r=bD(s).pb(DD);let n;this.log.trace("send RESERVE to %p",e.remotePeer),await r.write({type:DD.Type.RESERVE},t);try{this.log.trace("reading response from %p",e.remotePeer),n=await r.read(t)}catch(e){throw s.abort(e),e}finally{"closed"!==s.status&&await s.close(t)}if(this.log.trace("read response %s",n.status),n.status===PD.OK&&null!=n.reservation){const t=new Set;t.add(e.remoteAddr.toString());for(const s of n.reservation.addrs){let r=uD(s);null==r.getComponents().find(e=>e.code===HE)&&(r=r.encapsulate(`/p2p/${e.remotePeer}`)),r=uD(r.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),t.add(r.toString())}return n.reservation.addrs=[...t].map(e=>uD(e).bytes),n.reservation}const i=`reservation failed with status ${n.status??"undefined"}`;throw this.log.error(i),new Error(i)}async#q(e){const t=this.reservations.get(e);null!=t&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),"discovered"===t.type&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[vD]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#W())}#W(){if(0===this.pendingReservations.length)return this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),void this.safeDispatchEvent("relay:found-enough-relays");this.relayFilter=AE(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}}class HD extends $E{stream;init;constructor(e){super({...e,direction:e.stream.direction}),this.init=e,this.stream=e.stream,this.stream.addEventListener("close",e=>{this.onTransportClosed(e.error)}),this.stream.addEventListener("remoteCloseWrite",e=>{this.onRemoteCloseWrite(),this.close().catch(e=>{this.abort(e)})}),this.stream.addEventListener("message",t=>{e.onDataRead?.(t.data),this.onData(t.data)}),this.stream.addEventListener("drain",()=>{this.safeDispatchEvent("drain")})}sendData(e){return this.init.onDataWrite?.(e),{sentBytes:e.byteLength,canSendMore:this.stream.send(e)}}async sendClose(e){await this.stream.close(e)}sendReset(){this.stream.abort(new Error("An error occurred"))}sendPause(){this.stream.pause()}sendResume(){this.stream.resume()}}function GD(e){return new HD(e)}const QD=300,XD=300;class YD{components;discovery;reservationStore;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.maxInboundStopStreams=t.maxInboundStopStreams??QD,this.maxOutboundStopStreams=t.maxOutboundStopStreams??XD,this.shutdownController=new AbortController,this.discovery=new qD(e,{filter:t.discoveryFilter??$D(4096,.001)}),this.discovery.addEventListener("relay:discover",e=>{this.reservationStore.addRelay(e.detail,"discovered").catch(t=>{"HadEnoughRelaysError"!==t.name&&"RelayQueueFullError"!==t.name&&this.log.error("could not add discovered relay %p - %e",e.detail,t)})}),this.reservationStore=new jD(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1,this.onStop=this.onStop.bind(this)}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[PS]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[xS](){return null!=this.discovery?["@libp2p/identify"]:[]}[IS]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.components.registrar.handle(ED,this.onStop,{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await async function(...e){const t=[];for(const s of e)TS(s)&&t.push(s);await Promise.all(t.map(async e=>{null!=e.beforeStart&&await e.beforeStart()})),await Promise.all(t.map(async e=>{await e.start()})),await Promise.all(t.map(async e=>{null!=e.afterStart&&await e.afterStart()}))}(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await async function(...e){const t=[];for(const s of e)TS(s)&&t.push(s);await Promise.all(t.map(async e=>{null!=e.beforeStop&&await e.beforeStop()})),await Promise.all(t.map(async e=>{await e.stop()})),await Promise.all(t.map(async e=>{null!=e.afterStop&&await e.afterStop()}))}(this.discovery,this.reservationStore),await this.components.registrar.unhandle(ED),this.started=!1}async dial(e,t){const s=e.toString().split("/p2p-circuit"),r=uD(s[0]),n=uD(s[s.length-1]),i=r.getComponents().find(e=>e.code===HE)?.value,o=n.getComponents().find(e=>e.code===HE)?.value;if(null==i||null==o){const t=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${t}`),new bS(`C${t}`)}const a=BS(i),c=BS(o);let l,h=this.components.connectionManager.getConnections(a)[0];null==h?(await this.components.peerStore.merge(a,{multiaddrs:[r]}),t.onProgress?.(new Wa("circuit-relay:open-connection")),h=await this.components.connectionManager.openConnection(a,t)):t.onProgress?.(new Wa("circuit-relay:reuse-connection"));try{t.onProgress?.(new Wa("circuit-relay:open-hop-stream")),l=await h.newStream(SD,t);const s=bD(l).pb(DD);t.onProgress?.(new Wa("circuit-relay:write-connect-message")),await s.write({type:DD.Type.CONNECT,peer:{id:c.toMultihash().bytes,addrs:[uD(n).bytes]}},t),t.onProgress?.(new Wa("circuit-relay:read-connect-response"));const i=await s.read(t);if(i.status!==PD.OK)throw new yS(`failed to connect via relay with status ${i?.status?.toString()??"undefined"}`);const o=new OD(i.limit),a=GD({stream:s.unwrap().unwrap(),remoteAddr:e,localAddr:r.encapsulate(`/p2p-circuit/p2p/${this.components.peerId.toString()}`),onDataRead:o.onData,onDataWrite:o.onData,log:l.log.newScope("circuit-relay:connection")}),u=await this.components.upgrader.upgradeOutbound(a,{...t,limits:o.getLimits()});return u.log("outbound relayed connection established to %p with limits %o, over connection %s",u.remotePeer,i.limit??"none",h.id),u}catch(e){throw this.log.error("circuit relay dial to destination %p via relay %p failed - %e",c,a,e),l?.abort(e),e}}createListener(e){return function(e){return new KD(e)}({peerId:this.components.peerId,connectionManager:this.components.connectionManager,addressManager:this.components.addressManager,reservationStore:this.reservationStore,logger:this.components.logger})}listenFilter(e){return(e=Array.isArray(e)?e:[e]).filter(e=>BD.exactMatch(e)||UD.exactMatch(e))}dialFilter(e){return(e=Array.isArray(e)?e:[e]).filter(e=>_m.exactMatch(e))}async onStop(e,t){const s=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);try{if(!this.reservationStore.hasReservation(t.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.components.transportManager.listen([t.remoteAddr.encapsulate("/p2p-circuit")])}catch(e){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on - %e",e)}const r=bD(e).pb(_D),n=await r.read({signal:s});if(this.log("new circuit relay v2 stop stream from %p with type %s",t.remotePeer,n.type),void 0===n?.type)return this.log.error("type was missing from circuit v2 stop protocol request from %s",t.remotePeer),await r.write({type:_D.Type.STATUS,status:PD.MALFORMED_MESSAGE},{signal:s}),void await e.close({signal:s});if(n.type!==_D.Type.CONNECT)return this.log.error("invalid stop connect request via peer %p",t.remotePeer),await r.write({type:_D.Type.STATUS,status:PD.UNEXPECTED_MESSAGE},{signal:s}),void await e.close({signal:s});if(!(e=>{if(null==e.peer)return!1;try{e.peer.addrs.forEach(uD)}catch{return!1}return!0})(n))return this.log.error("invalid stop connect request via peer %p",t.remotePeer),await r.write({type:_D.Type.STATUS,status:PD.MALFORMED_MESSAGE},{signal:s}),void await e.close({signal:s});const i=US(Pe(n.peer.id));if(!0===await(this.components.connectionGater.denyInboundRelayedConnection?.(t.remotePeer,i)))return this.log.error("connection gater denied inbound relayed connection from %p",t.remotePeer),await r.write({type:_D.Type.STATUS,status:PD.PERMISSION_DENIED},{signal:s}),void await e.close({signal:s});this.log.trace("sending success response to %p",t.remotePeer),await r.write({type:_D.Type.STATUS,status:PD.OK},{signal:s});const o=new OD(n.limit),a=t.remoteAddr.encapsulate(`/p2p-circuit/p2p/${i.toString()}`),c=this.components.addressManager.getAddresses()[0],l=GD({stream:r.unwrap().unwrap(),remoteAddr:a,localAddr:c,onDataRead:o.onData,onDataWrite:o.onData,log:e.log.newScope("circuit-relay:connection")});await this.components.upgrader.upgradeInbound(l,{limits:o.getLimits(),signal:s}),l.log("inbound relayed connection established to %p with limits %o, over connection %s",i,n.limit??"none",t.id)}finally{s?.clear()}}}function JD(e={}){return t=>new YD(t,e)}let ZD=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};class e_ extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}}class t_ extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}}class s_ extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}}class r_ extends Error{static name="StreamBufferError";constructor(e="The stream buffer was full"){super(e),this.name="StreamBufferError"}}class n_ extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}}class i_ extends Event{data;constructor(e,t){super("message",t),this.data=e}}class o_ extends Event{error;local;constructor(e,t,s){super("close",s),this.error=t,this.local=e}}class a_ extends o_{constructor(e,t){super(!0,e,t)}}class c_ extends o_{constructor(e,t){super(!1,e,t)}}const l_=Symbol.for("@libp2p/service-capabilities");class h_ extends Error{static name="MaxEarlyStreamsError";name="MaxEarlyStreamsError"}class u_ extends Error{static name="StreamClosedError";name="StreamClosedError"}function d_(e){return e.reason}async function p_(e,t,s){if(null==t)return e;const r=d_;if(t.aborted)return e.catch(()=>{}),Promise.reject(r(t));let n;try{return await Promise.race([e,new Promise((e,s)=>{n=()=>{s(r(t))},t.addEventListener("abort",n)})])}finally{null!=n&&t.removeEventListener("abort",n)}}const f_=4*Math.pow(2,20);class g_ extends ns{status;timeline;inactivityTimeout;maxReadBufferLength;maxWriteBufferLength;log;direction;maxMessageSize;readStatus;writeStatus;remoteReadStatus;remoteWriteStatus;writableNeedsDrain;readBuffer;writeBuffer;sendingData;onDrainPromise;constructor(e){super(),this.status="open",this.log=e.log,this.direction=e.direction??"outbound",this.inactivityTimeout=e.inactivityTimeout??12e4,this.maxReadBufferLength=e.maxReadBufferLength??f_,this.maxWriteBufferLength=e.maxWriteBufferLength,this.maxMessageSize=e.maxMessageSize,this.readBuffer=new cs,this.writeBuffer=new cs,this.readStatus="readable",this.remoteReadStatus="readable",this.writeStatus="writable",this.remoteWriteStatus="writable",this.sendingData=!1,this.writableNeedsDrain=!1,this.timeline={open:Date.now()},this.processSendQueue=this.processSendQueue.bind(this);this.addEventListener("drain",()=>{this.writableNeedsDrain&&(this.log.trace("drain event received, continue sending data"),this.writableNeedsDrain=!1,this.processSendQueue()),this.onDrainPromise?.resolve()});this.addEventListener("close",e=>{this.onDrainPromise?.reject(e.error??new u_)})}get readBufferLength(){return this.readBuffer.byteLength}get writeBufferLength(){return this.writeBuffer.byteLength}async onDrain(e){return!0!==this.writableNeedsDrain?Promise.resolve():(null==this.onDrainPromise&&(this.onDrainPromise=Promise.withResolvers()),p_(this.onDrainPromise.promise,e?.signal))}async*[Symbol.asyncIterator](){if("readable"!==this.readStatus&&"paused"!==this.readStatus)return;const e=Xl(),t=t=>{e.push(t.data)};this.addEventListener("message",t);const s=t=>{e.end(t.error)};this.addEventListener("close",s);const r=()=>{e.end()};this.addEventListener("remoteCloseWrite",r);try{yield*e}finally{this.removeEventListener("message",t),this.removeEventListener("close",s),this.removeEventListener("remoteCloseWrite",r)}}isReadable(){return"open"===this.status}send(e){if("closed"===this.writeStatus||"closing"===this.writeStatus)throw new s_(`Cannot write to a stream that is ${this.writeStatus}`);return this.log.trace("append %d bytes to write buffer",e.byteLength),this.writeBuffer.append(e),this.processSendQueue()}abort(e){if("aborted"!==this.status&&"reset"!==this.status&&"closed"!==this.status){this.log.error("abort with error - %e",e),this.status="aborted",this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle")),this.writeStatus="closed",this.remoteWriteStatus="closed",this.readStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now();try{this.sendReset(e)}catch(e){this.log("failed to send reset to remote - %e",e)}this.dispatchEvent(new a_(e))}}pause(){if("closed"===this.readStatus||"closing"===this.readStatus)throw new s_("Cannot pause a stream that is closing/closed");"paused"!==this.readStatus&&(this.readStatus="paused",this.sendPause())}resume(){if("closed"===this.readStatus||"closing"===this.readStatus)throw new s_("Cannot resume a stream that is closing/closed");"readable"!==this.readStatus&&(this.readStatus="readable",this.dispatchReadBuffer(),this.sendResume())}push(e){if("closed"===this.readStatus||"closing"===this.readStatus)throw new s_(`Cannot push data onto a stream that is ${this.readStatus}`);0!==e.byteLength&&(this.readBuffer.append(e),"paused"!==this.readStatus&&0!==this.listenerCount("message")?setTimeout(()=>{this.dispatchReadBuffer()},0):this.checkReadBufferLength())}unshift(e){if("closed"===this.readStatus||"closing"===this.readStatus)throw new s_(`Cannot push data onto a stream that is ${this.readStatus}`);0!==e.byteLength&&(this.readBuffer.prepend(e),"paused"!==this.readStatus&&0!==this.listenerCount("message")?setTimeout(()=>{this.dispatchReadBuffer()},0):this.checkReadBufferLength())}onData(e){0!==e.byteLength&&("closing"!==this.readStatus&&"closed"!==this.readStatus?(this.readBuffer.append(e),this.dispatchReadBuffer()):this.log("ignoring data - read status %s",this.readStatus))}addEventListener(...e){super.addEventListener.apply(this,e),"message"===e[0]&&this.readBuffer.byteLength>0&&queueMicrotask(()=>{this.dispatchReadBuffer()})}onRemoteReset(){this.log("remote reset"),this.status="reset",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.timeline.close=Date.now(),0===this.readBuffer.byteLength&&(this.readStatus="closed");const e=new t_;this.dispatchEvent(new c_(e))}onTransportClosed(e){this.log("transport closed"),"readable"===this.readStatus&&0===this.readBuffer.byteLength&&(this.log("close readable end after transport closed and read buffer is empty"),this.readStatus="closed"),"closed"!==this.remoteReadStatus&&(this.remoteReadStatus="closed"),"closed"!==this.remoteWriteStatus&&(this.remoteWriteStatus="closed"),"closed"!==this.writeStatus&&(this.writeStatus="closed"),null!=e?this.abort(e):"open"!==this.status&&"closing"!==this.status||(this.timeline.close=Date.now(),this.status="closed",this.writeStatus="closed",this.remoteWriteStatus="closed",this.remoteReadStatus="closed",this.dispatchEvent(new o_))}onRemoteCloseWrite(){"closed"!==this.remoteWriteStatus&&(this.log.trace("on remote close write"),this.remoteWriteStatus="closed",this.safeDispatchEvent("remoteCloseWrite"),"closed"===this.writeStatus&&this.onTransportClosed())}onRemoteCloseRead(){this.log.trace("on remote close read"),this.remoteReadStatus="closed",this.writeBuffer.byteLength>0&&(this.writeBuffer.consume(this.writeBuffer.byteLength),this.safeDispatchEvent("idle"))}processSendQueue(){if(this.writableNeedsDrain)return this.log.trace("not processing send queue as drain is required"),this.checkWriteBufferLength(),!1;if(0===this.writeBuffer.byteLength)return this.log.trace("not processing send queue as no bytes to send"),!0;if(this.sendingData)return this.log.trace("not processing send queue as already sending data"),!0;this.sendingData=!0,this.log.trace("processing send queue with %d queued bytes",this.writeBuffer.byteLength);try{let e=!0;const t=this.writeBuffer.byteLength;let s=0;for(;this.writeBuffer.byteLength>0;){const t=Math.min(this.maxMessageSize??this.writeBuffer.byteLength,this.writeBuffer.byteLength);if(0===t){e=!1;break}const r=this.writeBuffer.sublist(0,t),n=new cs(r);this.writeBuffer.consume(r.byteLength);const i=this.sendData(r);if(e=i.canSendMore,s+=i.sentBytes,i.sentBytes!==n.byteLength&&(n.consume(i.sentBytes),this.writeBuffer.prepend(n)),!e)break}return e||(this.log.trace("sent %d/%d bytes, pausing sending because underlying stream is full, %d bytes left in the write buffer",s,t,this.writeBuffer.byteLength),this.writableNeedsDrain=!0,this.checkWriteBufferLength()),0===this.writeBuffer.byteLength&&this.safeDispatchEvent("idle"),e}finally{this.sendingData=!1}}dispatchReadBuffer(){try{if(0===this.listenerCount("message"))return void this.log.trace("not dispatching pause buffer as there are no listeners for the message event");if(0===this.readBuffer.byteLength)return void this.log.trace("not dispatching pause buffer as there is no data to dispatch");if("paused"===this.readStatus)return void this.log.trace("not dispatching pause buffer we are paused");if("closing"===this.readStatus||"closed"===this.readStatus)return this.log("dropping %d bytes because the readable end is %s",this.readBuffer.byteLength,this.readStatus),void this.readBuffer.consume(this.readBuffer.byteLength);const e=this.readBuffer.sublist();this.readBuffer.consume(e.byteLength),this.dispatchEvent(new i_(e))}finally{0===this.readBuffer.byteLength&&"closed"===this.remoteWriteStatus&&(this.log("close readable end after dispatching read buffer and remote writable end is closed"),this.readStatus="closed"),this.checkReadBufferLength()}}checkReadBufferLength(){this.readBuffer.byteLength>this.maxReadBufferLength&&this.abort(new r_(`Read buffer length of ${this.readBuffer.byteLength} exceeded limit of ${this.maxReadBufferLength}, read status is ${this.readStatus}`))}checkWriteBufferLength(){null!=this.maxWriteBufferLength&&this.writeBuffer.byteLength>this.maxWriteBufferLength&&this.abort(new r_(`Write buffer length of ${this.writeBuffer.byteLength} exceeded limit of ${this.maxWriteBufferLength}, write status is ${this.writeStatus}`))}onMuxerNeedsDrain(){this.writableNeedsDrain=!0}onMuxerDrain(){this.safeDispatchEvent("drain")}}class m_ extends ns{streams;protocol;status;log;maConn;streamOptions;earlyStreams;maxEarlyStreams;metrics;constructor(e,t){super(),this.maConn=e,this.protocol=t.protocol,this.streams=[],this.earlyStreams=[],this.status="open",this.log=e.log.newScope(t.name),this.streamOptions=t.streamOptions,this.maxEarlyStreams=t.maxEarlyStreams??10,this.metrics=t.metrics;this.maConn.addEventListener("message",e=>{try{this.onData(e.data)}catch(e){this.abort(e),this.maConn.abort(e)}});this.maConn.addEventListener("drain",()=>{this.log("underlying stream drained, signal %d streams to continue writing",this.streams.length),this.streams.forEach(e=>{e.onMuxerDrain()})});this.maConn.addEventListener("close",()=>{this.log("underlying stream closed with status %s and %d streams",this.status,this.streams.length),this.onTransportClosed()})}send(e){const t=this.maConn.send(e);return!1===t&&(this.log("underlying stream saturated, signal %d streams to pause writing",this.streams.length),this.streams.forEach(e=>{e.onMuxerNeedsDrain()})),t}async close(e){"closed"!==this.status&&"closing"!==this.status&&(this.status="closing",await p_(Promise.all([...this.streams].map(async t=>{await t.close(e)})),e?.signal),this.status="closed")}abort(e){"closed"!==this.status&&(this.status="closing",[...this.streams].forEach(t=>{t.abort(e)}),this.status="closed")}onTransportClosed(e){this.status="closing";try{[...this.streams].forEach(t=>{t.onTransportClosed(e)})}catch(e){this.abort(e)}this.status="closed"}async createStream(e){if("open"!==this.status)throw new e_;let t=this.onCreateStream({...this.streamOptions,...e});var s;return null!=(s=t)&&"function"==typeof s.then&&"function"==typeof s.catch&&"function"==typeof s.finally&&(t=await t),this.streams.push(t),this.cleanUpStream(t),t}onRemoteStream(e){if(this.streams.push(e),this.cleanUpStream(e),0===this.listenerCount("stream"))return this.earlyStreams.push(e),void(this.earlyStreams.length>this.maxEarlyStreams&&this.abort(new h_(`Too many early streams were opened - ${this.earlyStreams.length}/${this.maxEarlyStreams}`)));this.safeDispatchEvent("stream",{detail:e})}cleanUpStream(e){e.addEventListener("close",t=>{const s=this.streams.findIndex(t=>t===e);-1!==s&&this.streams.splice(s,1),null!=t.error?t.local?this.metrics?.increment({[`${e.direction}_stream_reset`]:!0}):this.metrics?.increment({[`${e.direction}_stream_abort`]:!0}):this.metrics?.increment({[`${e.direction}_stream_end`]:!0})}),this.metrics?.increment({[`${e.direction}_stream`]:!0})}addEventListener(...e){super.addEventListener.apply(this,e),"stream"===e[0]&&this.earlyStreams.length>0&&queueMicrotask(()=>{this.earlyStreams.forEach(e=>{this.safeDispatchEvent("stream",{detail:e})}),this.earlyStreams=[]})}}class y_ extends g_{id;protocol;constructor(e){super(e),this.id=e.id,this.protocol=e.protocol??""}async close(e){"closing"!==this.writeStatus&&"closed"!==this.writeStatus&&(this.writeStatus="closing",(this.sendingData||this.writeBuffer.byteLength>0)&&(this.log("waiting for write queue to become idle before closing writable end of stream, %d unsent bytes",this.writeBuffer.byteLength),await Nm(this,"idle",{...e,rejectionEvents:["close"]})),this.writableNeedsDrain&&(this.log("waiting for write queue to drain before closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData),await Nm(this,"drain",{...e,rejectionEvents:["close"]}),this.log("write queue drained, closing writable end of stream, %d unsent bytes, sending %s",this.writeBuffer.byteLength,this.sendingData)),await this.sendCloseWrite(e),this.writeStatus="closed",this.log("closed writable end gracefully"),"closed"===this.remoteWriteStatus&&this.onTransportClosed())}async closeRead(e){"closing"!==this.readStatus&&"closed"!==this.readStatus&&(this.readBuffer.byteLength>0&&this.readBuffer.consume(this.readBuffer.byteLength),this.readStatus="closing",await this.sendCloseRead(e),this.readStatus="closed",this.log("closed readable end gracefully"))}}function b_(e,t,s){let r,n,i=!1;function o(){const a={signal:n.signal};if(null!=s?.timeout){const e=ip([n.signal,AbortSignal.timeout(s.timeout)]);a.signal=e}i=!0,Promise.resolve().then(async()=>{await e(a)}).catch(()=>{}).finally(()=>{i=!1,n.signal.aborted||(r=setTimeout(o,t))})}const a=function(e,t){let s;const r=function(){clearTimeout(s),s=setTimeout(function(){s=void 0,e()},t)};return r.start=()=>{},r.stop=()=>{clearTimeout(s)},r}(o,s?.debounce??100);let c=!1;return{setInterval:e=>{t!==e&&(t=e,null!=r&&(clearTimeout(r),r=setTimeout(o,t)))},setTimeout:e=>{s??={},s.timeout=e},run:()=>{i||(clearTimeout(r),a())},start:()=>{c||(c=!0,n=new AbortController,n.signal,!0===s?.runImmediately?queueMicrotask(()=>{o()}):r=setTimeout(o,t))},stop:()=>{clearTimeout(r),n?.abort(),c=!1}}}var w_,v_;!function(e){e[e.Data=0]="Data",e[e.WindowUpdate=1]="WindowUpdate",e[e.Ping=2]="Ping",e[e.GoAway=3]="GoAway"}(w_||(w_={})),function(e){e[e.SYN=1]="SYN",e[e.ACK=2]="ACK",e[e.FIN=4]="FIN",e[e.RST=8]="RST"}(v_||(v_={})),Object.values(v_).filter(e=>"string"!=typeof e);var S_;!function(e){e[e.NormalTermination=0]="NormalTermination",e[e.ProtocolError=1]="ProtocolError",e[e.InternalError=2]="InternalError"}(S_||(S_={}));const E_=12;let D_=class extends Error{static name="ProtocolError";reason;constructor(e,t){super(e),this.name="ProtocolError",this.reason=t}};class __ extends D_{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e,S_.ProtocolError),this.name="InvalidFrameError"}}class T_ extends D_{static name="UnRequestedPingError";constructor(e="Un-requested ping error"){super(e,S_.ProtocolError),this.name="UnRequestedPingError"}}class I_ extends D_{static name="NotMatchingPingError";constructor(e="Not matching ping error"){super(e,S_.ProtocolError),this.name="NotMatchingPingError"}}class C_ extends D_{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e,S_.ProtocolError),this.name="ReceiveWindowExceededError"}}const P_=262144,x_=!0,A_=3e4,k_=1e3,N_=1e3;const R_=2**24;let M_=class{buffer;constructor(){this.buffer=new cs}*emitFrames(e){for(this.buffer.append(e);;){const e=this.readFrame();if(void 0===e)break;yield e}}readFrame(){let e=E_;if(this.buffer.byteLength<E_)return;const t=function(e){if(0!==e[0])throw new __("Invalid frame version");return{type:e[1],flag:(e[2]<<8)+e[3],streamID:e[4]*R_+(e[5]<<16)+(e[6]<<8)+e[7],length:e[8]*R_+(e[9]<<16)+(e[10]<<8)+e[11]}}(this.buffer.subarray(0,E_));if(t.type===w_.Data){if(e+=t.length,this.buffer.byteLength<e)return;const s=this.buffer.sublist(E_,e);return this.buffer.consume(e),{header:t,data:s}}return this.buffer.consume(e),{header:t}}};function L_(e){const t=new Uint8Array(E_);return t[1]=e.type,t[2]=e.flag>>>8,t[3]=e.flag,t[4]=e.streamID>>>24,t[5]=e.streamID>>>16,t[6]=e.streamID>>>8,t[7]=e.streamID,t[8]=e.length>>>24,t[9]=e.length>>>16,t[10]=e.length>>>8,t[11]=e.length,t}var O_;!function(e){e[e.Init=0]="Init",e[e.SYNSent=1]="SYNSent",e[e.SYNReceived=2]="SYNReceived",e[e.Established=3]="Established",e[e.Finished=4]="Finished",e[e.Paused=5]="Paused"}(O_||(O_={}));class B_ extends y_{streamId;state;sendWindowCapacity;recvWindow;recvWindowCapacity;maxStreamWindowSize;epochStart;getRTT;sendFrame;constructor(e){const t=e.initialStreamWindowSize??P_;super({...e,maxMessageSize:t-E_}),this.streamId=e.streamId,this.state=e.state,this.sendWindowCapacity=t,this.recvWindow=t,this.recvWindowCapacity=this.recvWindow,this.maxStreamWindowSize=e.maxStreamWindowSize??16777216,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame;this.addEventListener("close",()=>{this.state=O_.Finished})}sendData(e){const t=e.byteLength;let s=0,r=!0;for(this.log?.trace("send window capacity is %d bytes",this.sendWindowCapacity);e.byteLength>0;){if(0===this.sendWindowCapacity){r=!1,this.log?.trace("sent %d/%d bytes, exhausted send window, waiting for window update",s,t);break}const n=Math.min(this.sendWindowCapacity,e.byteLength),i=this.getSendFlags(),o=e.sublist(0,n);e.consume(n);const a=this.sendFrame({type:w_.Data,flag:i,streamID:this.streamId,length:n},o);if(this.sendWindowCapacity-=n,s+=n,!a){r=a,this.log.trace("sent %d/%d bytes, wait for muxer to have more send capacity",s,t);break}}return{sentBytes:s,canSendMore:r}}sendReset(){this.sendFrame({type:w_.WindowUpdate,flag:v_.RST,streamID:this.streamId,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|v_.FIN;this.sendFrame({type:w_.WindowUpdate,flag:e,streamID:this.streamId,length:0})}async sendCloseRead(e){e?.signal?.throwIfAborted()}sendPause(){this.state=O_.Paused}sendResume(){this.state=O_.Established,this.sendWindowUpdate()}handleWindowUpdate(e){this.processFlags(e.header.flag),this.sendWindowCapacity+=e.header.length,this.maxMessageSize=this.sendWindowCapacity-E_,this.maxMessageSize<0&&(this.maxMessageSize=0),0!==this.maxMessageSize&&this.writeBuffer.byteLength>0&&(this.log?.trace("window update of %d bytes allows more data to be sent, have %d bytes queued, sending data %s",e.header.length,this.writeBuffer.byteLength,this.sendingData),this.safeDispatchEvent("drain"))}handleData(e){if(!function(e){return e.header.type===w_.Data&&null!==e.data}(e))throw new __("Frame was not data frame");if(this.processFlags(e.header.flag),this.recvWindowCapacity<e.header.length)throw new C_("Receive window exceeded");this.recvWindowCapacity-=e.header.length,this.onData(e.data),this.sendWindowUpdate()}processFlags(e){(e&v_.ACK)===v_.ACK&&this.state===O_.SYNSent&&(this.state=O_.Established),(e&v_.FIN)===v_.FIN&&this.onRemoteCloseWrite(),(e&v_.RST)===v_.RST&&this.onRemoteReset()}getSendFlags(){switch(this.state){case O_.Init:return this.state=O_.SYNSent,v_.SYN;case O_.SYNReceived:return this.state=O_.Established,v_.ACK;default:return 0}}sendWindowUpdate(){if(this.state===O_.Paused)return void(this.epochStart=Date.now());const e=this.getSendFlags(),t=Date.now(),s=this.getRTT();if(0===e&&s>-1&&t-this.epochStart<=4*s&&(this.recvWindow=Math.min(2*this.recvWindow,this.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&0===e)return;const r=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:w_.WindowUpdate,flag:e,streamID:this.streamId,length:r})}}function U_(e){return{type:w_[e.type],flags:[(e.flag&v_.SYN)===v_.SYN?"SYN":void 0,(e.flag&v_.ACK)===v_.ACK?"ACK":void 0,(e.flag&v_.FIN)===v_.FIN?"FIN":void 0,(e.flag&v_.RST)===v_.RST?"RST":void 0].filter(Boolean),streamID:e.streamID,length:e.length}}const V_="/yamux/1.0.0";class F_{protocol=V_;_init;constructor(e={}){this._init=e}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[l_]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new z_(e,{...this._init})}}class z_ extends m_{nextStreamID;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;decoder;keepAlive;enableKeepAlive;keepAliveInterval;maxInboundStreams;maxOutboundStreams;constructor(e,t={}){super(e,{...t,protocol:V_,name:"yamux"}),this.client="outbound"===e.direction,function(e){if(null!=e.keepAliveInterval&&e.keepAliveInterval<=0)throw new ZD("keep-alive interval must be positive");if(null!=e.maxInboundStreams&&e.maxInboundStreams<0)throw new ZD("max inbound streams must be larger or equal 0");if(null!=e.maxOutboundStreams&&e.maxOutboundStreams<0)throw new ZD("max outbound streams must be larger or equal 0");if(null!=e.maxMessageSize&&e.maxMessageSize<1024)throw new ZD("MaxMessageSize must be greater than a kilobyte");if(null!=e.streamOptions?.initialStreamWindowSize&&e.streamOptions?.initialStreamWindowSize<P_)throw new ZD("InitialStreamWindowSize must be larger or equal 256 kB");if(null!=e.streamOptions?.maxStreamWindowSize&&null!=e.streamOptions?.initialStreamWindowSize&&e.streamOptions?.maxStreamWindowSize<e.streamOptions?.initialStreamWindowSize)throw new ZD("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(null!=e.streamOptions?.maxStreamWindowSize&&e.streamOptions?.maxStreamWindowSize>2**32-1)throw new ZD("MaxStreamWindowSize must be less than equal MAX_UINT32")}(t),this.enableKeepAlive=t.enableKeepAlive??x_,this.keepAliveInterval=t.keepAliveInterval??A_,this.maxInboundStreams=t.maxInboundStreams??k_,this.maxOutboundStreams=t.maxOutboundStreams??N_,this.decoder=new M_,this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log.trace("muxer created"),this.enableKeepAlive&&(this.log.trace("muxer keepalive enabled interval=%s",this.keepAliveInterval),this.keepAlive=b_(async e=>{try{await this.ping(e)}catch(e){this.log.error("ping error: %s",e)}},this.keepAliveInterval,{runImmediately:!0}),this.keepAlive.start())}onData(e){for(const t of this.decoder.emitFrames(e))this.handleFrame(t)}onCreateStream(){if(void 0!==this.remoteGoAway)throw new e_("Muxer closed remotely");if(void 0!==this.localGoAway)throw new e_("Muxer closed locally");const e=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.maxOutboundStreams)throw new n_("max outbound streams exceeded");this.log.trace("new outgoing stream id=%s",e);const t=this._newStream(e,O_.Init,"outbound");return this.numOutboundStreams++,queueMicrotask(()=>{t.sendWindowUpdate()}),t}async ping(e){if(void 0!==this.remoteGoAway)throw new e_("Muxer closed remotely");if(void 0!==this.localGoAway)throw new e_("Muxer closed locally");if(null!=this.activePing)return p_(this.activePing.promise,e?.signal);this.activePing=Object.assign(Promise.withResolvers(),{id:this.nextPingID++,start:Date.now()}),this.sendPing(this.activePing.id);try{this.rtt=await p_(this.activePing.promise,e?.signal)}finally{this.activePing=void 0}return this.rtt}getRTT(){return this.rtt}async close(e={}){if("open"===this.status)try{const t=e?.reason??S_.NormalTermination;this.log.trace("muxer close reason=%s",S_[t]),await super.close(e),this.sendGoAway(t)}finally{this.keepAlive?.stop()}}abort(e){if("open"===this.status)try{super.abort(e);let t=S_.InternalError;(function(e){return null!==e?.reason})(e)&&(t=e.reason),this.log.error("muxer abort reason=%s error=%s",t,e),this.sendGoAway(t)}finally{this.keepAlive?.stop()}}onTransportClosed(){try{super.onTransportClosed()}finally{this.keepAlive?.stop()}}_newStream(e,t,s){if(null!=this.streams.find(t=>t.streamId===e))throw new ZD("Stream already exists with that id");const r=new B_({...this.streamOptions,id:`${e}`,streamId:e,state:t,direction:s,sendFrame:this.sendFrame.bind(this),log:this.log.newScope(`${s}:${e}`),getRTT:this.getRTT.bind(this)});return r.addEventListener("close",()=>{this.closeStream(e)},{once:!0}),r}closeStream(e){this.client===(e%2==0)?this.numInboundStreams--:this.numOutboundStreams--}handleFrame(e){const{streamID:t,type:s,length:r}=e.header;if(this.log.trace("received frame %o",U_(e.header)),0===t)switch(s){case w_.Ping:return void this.handlePing(e.header);case w_.GoAway:return void this.handleGoAway(r);default:throw new __("Invalid frame type")}else switch(e.header.type){case w_.Data:case w_.WindowUpdate:return void this.handleStreamMessage(e);default:throw new __("Invalid frame type")}}handlePing(e){if(e.flag===v_.SYN)this.log.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,v_.ACK);else{if(e.flag!==v_.ACK)throw new __("Invalid frame flag");this.log.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length)}}handlePingResponse(e){if(void 0===this.activePing)throw new T_("ping not requested");if(this.activePing.id!==e)throw new I_("ping doesn't match our id");this.activePing.resolve(Date.now()-this.activePing.start)}handleGoAway(e){this.log.trace("received GoAway reason=%s",S_[e]??"unknown"),this.remoteGoAway=e,e===S_.NormalTermination?this.onTransportClosed():this.abort(new Error("Remote sent GoAway"))}handleStreamMessage(e){const{streamID:t,flag:s,type:r}=e.header;(s&v_.SYN)===v_.SYN&&this.incomingStream(t);const n=this.streams.find(e=>e.streamId===t);if(void 0!==n)switch(r){case w_.WindowUpdate:return void n.handleWindowUpdate(e);case w_.Data:return void n.handleData(e);default:throw new Error("unreachable")}else this.log.trace("frame for missing stream id=%s",t)}incomingStream(e){if(this.client!==(e%2==0))throw new ZD("Both endpoints are clients");if(this.streams.find(t=>t.streamId===e))return;if(this.log.trace("new incoming stream id=%s",e),void 0!==this.localGoAway)return void this.sendFrame({type:w_.WindowUpdate,flag:v_.RST,streamID:e,length:0});if(this.numInboundStreams>=this.maxInboundStreams)return this.log("maxIncomingStreams exceeded, forcing stream reset"),void this.sendFrame({type:w_.WindowUpdate,flag:v_.RST,streamID:e,length:0});const t=this._newStream(e,O_.SYNReceived,"inbound");this.numInboundStreams++,this.onRemoteStream(t)}sendFrame(e,t){let s;if(e.type===w_.Data){if(null==t)throw new __("Invalid frame");s=new cs(L_(e),t)}else s=L_(e);return this.log.trace("sending frame %o",U_(e)),this.send(s)}sendPing(e,t=v_.SYN){t===v_.SYN?this.log.trace("sending ping request pingId=%s",e):this.log.trace("sending ping response pingId=%s",e),this.sendFrame({type:w_.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=S_.NormalTermination){this.log("sending GoAway reason=%s",S_[e]),this.localGoAway=e,this.sendFrame({type:w_.GoAway,flag:0,streamID:0,length:e})}}function $_(e={}){return()=>new F_(e)}const q_="/floodsub/1.0.0",W_="/meshsub/1.0.0",K_="/meshsub/1.2.0",j_=5e3;let H_=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},G_=class extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}},Q_=class extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}};const X_=Symbol.for("@libp2p/peer-id"),Y_=Symbol.for("@libp2p/service-capabilities"),J_=Symbol.for("@libp2p/service-dependencies"),Z_=Symbol.for("nodejs.util.inspect.custom");let eT=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[X_]=!0;toString(){return null==this.string&&(this.string=G.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Ue.createV1(114,this.multihash)}toJSON(){return this.toString()}equals(e){if(null==e)return!1;if(e instanceof Uint8Array)return a(this.multihash.bytes,e);if("string"==typeof e)return this.toString()===e;if(null!=e?.toMultihash()?.bytes)return a(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[Z_](){return`PeerId(${this.toString()})`}},tT=class extends eT{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},sT=class extends eT{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},rT=class extends eT{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};let nT=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=ke.digest(Ge(this.url))}[Z_](){return`PeerId(${this.url})`}[X_]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return Ue.createV1(2336,this.toMultihash())}toJSON(){return this.toString()}equals(e){return null!=e&&(e instanceof Uint8Array&&(e=Qe(e)),e.toString()===this.toString())}};const iT=2336;function oT(e,t){let s;if("1"!==e.charAt(0)&&"Q"!==e.charAt(0)){if(e.startsWith("k51qzi5uqu5")||e.startsWith("kzwfwjn5ji4")||e.startsWith("k2k4r8")||e.startsWith("bafz"))return function(e){if(null==e?.multihash||null==e.version||1===e.version&&114!==e.code&&e.code!==iT)throw new G_("Supplied PeerID CID is invalid");if(e.code===iT){const t=Qe(e.multihash.digest);return new nT(new URL(t))}return aT(e.multihash)}(Ue.parse(e));throw new H_('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return s=Pe(G.decode(`z${e}`)),aT(s)}function aT(e){if(function(e){return e.code===Me.code}(e))return new tT({multihash:e});if(function(e){return e.code===ke.code}(e))try{const t=jo(e);if("Ed25519"===t.type)return new sT({multihash:e,publicKey:t});if("secp256k1"===t.type)return new rT({multihash:e,publicKey:t})}catch(t){const s=Qe(e.digest);return new nT(new URL(s))}throw new Q_("Supplied PeerID Multihash is invalid")}const cT={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxIdontwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};var lT,hT,uT,dT,pT,fT,gT,mT,yT,bT,wT,vT;!function(e){let t;!function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.subscribe&&(t.uint32(8),t.bool(e.subscribe)),null!=e.topic&&(t.uint32(18),t.string(e.topic)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.subscribe=e.bool();break;case 2:r.topic=e.string();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(e.SubOpts||(e.SubOpts={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.from&&(t.uint32(10),t.bytes(e.from)),null!=e.data&&(t.uint32(18),t.bytes(e.data)),null!=e.seqno&&(t.uint32(26),t.bytes(e.seqno)),null!=e.topic&&""!==e.topic&&(t.uint32(34),t.string(e.topic)),null!=e.signature&&(t.uint32(42),t.bytes(e.signature)),null!=e.key&&(t.uint32(50),t.bytes(e.key)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={topic:""},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.from=e.bytes();break;case 2:r.data=e.bytes();break;case 3:r.seqno=e.bytes();break;case 4:r.topic=e.string();break;case 5:r.signature=e.bytes();break;case 6:r.key=e.bytes();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(e.Message||(e.Message={})),function(t){let s;t.codec=()=>(null==s&&(s=uo((t,s,r={})=>{if(!1!==r.lengthDelimited&&s.fork(),null!=t.ihave)for(const r of t.ihave)s.uint32(10),e.ControlIHave.codec().encode(r,s);if(null!=t.iwant)for(const r of t.iwant)s.uint32(18),e.ControlIWant.codec().encode(r,s);if(null!=t.graft)for(const r of t.graft)s.uint32(26),e.ControlGraft.codec().encode(r,s);if(null!=t.prune)for(const r of t.prune)s.uint32(34),e.ControlPrune.codec().encode(r,s);if(null!=t.idontwant)for(const r of t.idontwant)s.uint32(42),e.ControlIDontWant.codec().encode(r,s);!1!==r.lengthDelimited&&s.ldelim()},(t,s,r={})=>{const n={ihave:[],iwant:[],graft:[],prune:[],idontwant:[]},i=null==s?t.len:t.pos+s;for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(null!=r.limits?.ihave&&n.ihave.length===r.limits.ihave)throw new po('Decode error - map field "ihave" had too many elements');n.ihave.push(e.ControlIHave.codec().decode(t,t.uint32(),{limits:r.limits?.ihave$}));break;case 2:if(null!=r.limits?.iwant&&n.iwant.length===r.limits.iwant)throw new po('Decode error - map field "iwant" had too many elements');n.iwant.push(e.ControlIWant.codec().decode(t,t.uint32(),{limits:r.limits?.iwant$}));break;case 3:if(null!=r.limits?.graft&&n.graft.length===r.limits.graft)throw new po('Decode error - map field "graft" had too many elements');n.graft.push(e.ControlGraft.codec().decode(t,t.uint32(),{limits:r.limits?.graft$}));break;case 4:if(null!=r.limits?.prune&&n.prune.length===r.limits.prune)throw new po('Decode error - map field "prune" had too many elements');n.prune.push(e.ControlPrune.codec().decode(t,t.uint32(),{limits:r.limits?.prune$}));break;case 5:if(null!=r.limits?.idontwant&&n.idontwant.length===r.limits.idontwant)throw new po('Decode error - map field "idontwant" had too many elements');n.idontwant.push(e.ControlIDontWant.codec().decode(t,t.uint32(),{limits:r.limits?.idontwant$}));break;default:t.skipType(7&s)}}return n})),s),t.encode=e=>ro(e,t.codec()),t.decode=(e,s)=>qi(e,t.codec(),s)}(e.ControlMessage||(e.ControlMessage={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{if(!1!==s.lengthDelimited&&t.fork(),null!=e.topicID&&(t.uint32(10),t.string(e.topicID)),null!=e.messageIDs)for(const s of e.messageIDs)t.uint32(18),t.bytes(s);!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={messageIDs:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.topicID=e.string();break;case 2:if(null!=s.limits?.messageIDs&&r.messageIDs.length===s.limits.messageIDs)throw new po('Decode error - map field "messageIDs" had too many elements');r.messageIDs.push(e.bytes());break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(e.ControlIHave||(e.ControlIHave={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{if(!1!==s.lengthDelimited&&t.fork(),null!=e.messageIDs)for(const s of e.messageIDs)t.uint32(10),t.bytes(s);!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={messageIDs:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();if(t>>>3==1){if(null!=s.limits?.messageIDs&&r.messageIDs.length===s.limits.messageIDs)throw new po('Decode error - map field "messageIDs" had too many elements');r.messageIDs.push(e.bytes())}else e.skipType(7&t)}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(e.ControlIWant||(e.ControlIWant={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.topicID&&(t.uint32(10),t.string(e.topicID)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();if(t>>>3==1)r.topicID=e.string();else e.skipType(7&t)}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(e.ControlGraft||(e.ControlGraft={})),function(t){let s;t.codec=()=>(null==s&&(s=uo((t,s,r={})=>{if(!1!==r.lengthDelimited&&s.fork(),null!=t.topicID&&(s.uint32(10),s.string(t.topicID)),null!=t.peers)for(const r of t.peers)s.uint32(18),e.PeerInfo.codec().encode(r,s);null!=t.backoff&&(s.uint32(24),s.uint64Number(t.backoff)),!1!==r.lengthDelimited&&s.ldelim()},(t,s,r={})=>{const n={peers:[]},i=null==s?t.len:t.pos+s;for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:n.topicID=t.string();break;case 2:if(null!=r.limits?.peers&&n.peers.length===r.limits.peers)throw new po('Decode error - map field "peers" had too many elements');n.peers.push(e.PeerInfo.codec().decode(t,t.uint32(),{limits:r.limits?.peers$}));break;case 3:n.backoff=t.uint64Number();break;default:t.skipType(7&s)}}return n})),s),t.encode=e=>ro(e,t.codec()),t.decode=(e,s)=>qi(e,t.codec(),s)}(e.ControlPrune||(e.ControlPrune={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.peerID&&(t.uint32(10),t.bytes(e.peerID)),null!=e.signedPeerRecord&&(t.uint32(18),t.bytes(e.signedPeerRecord)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.peerID=e.bytes();break;case 2:r.signedPeerRecord=e.bytes();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(e.PeerInfo||(e.PeerInfo={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{if(!1!==s.lengthDelimited&&t.fork(),null!=e.messageIDs)for(const s of e.messageIDs)t.uint32(10),t.bytes(s);!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={messageIDs:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();if(t>>>3==1){if(null!=s.limits?.messageIDs&&r.messageIDs.length===s.limits.messageIDs)throw new po('Decode error - map field "messageIDs" had too many elements');r.messageIDs.push(e.bytes())}else e.skipType(7&t)}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(e.ControlIDontWant||(e.ControlIDontWant={})),e.codec=()=>(null==t&&(t=uo((t,s,r={})=>{if(!1!==r.lengthDelimited&&s.fork(),null!=t.subscriptions)for(const r of t.subscriptions)s.uint32(10),e.SubOpts.codec().encode(r,s);if(null!=t.messages)for(const r of t.messages)s.uint32(18),e.Message.codec().encode(r,s);null!=t.control&&(s.uint32(26),e.ControlMessage.codec().encode(t.control,s)),!1!==r.lengthDelimited&&s.ldelim()},(t,s,r={})=>{const n={subscriptions:[],messages:[]},i=null==s?t.len:t.pos+s;for(;t.pos<i;){const s=t.uint32();switch(s>>>3){case 1:if(null!=r.limits?.subscriptions&&n.subscriptions.length===r.limits.subscriptions)throw new po('Decode error - map field "subscriptions" had too many elements');n.subscriptions.push(e.SubOpts.codec().decode(t,t.uint32(),{limits:r.limits?.subscriptions$}));break;case 2:if(null!=r.limits?.messages&&n.messages.length===r.limits.messages)throw new po('Decode error - map field "messages" had too many elements');n.messages.push(e.Message.codec().decode(t,t.uint32(),{limits:r.limits?.messages$}));break;case 3:n.control=e.ControlMessage.codec().decode(t,t.uint32(),{limits:r.limits?.control});break;default:t.skipType(7&s)}}return n})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(lT||(lT={}));class ST{gossip;msgs=new Map;msgIdToStrFn;history=[];notValidatedCount=0;constructor(e,t,s){this.gossip=e,this.msgIdToStrFn=s;for(let e=0;e<t;e++)this.history[e]=[]}get size(){return this.msgs.size}put(e,t,s=!1){const{msgIdStr:r}=e;return!this.msgs.has(r)&&(this.msgs.set(r,{message:t,validated:s,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),s||this.notValidatedCount++,!0)}observeDuplicate(e,t){const s=this.msgs.get(e);null==s||s.validated||s.originatingPeers.add(t)}get(e){return this.msgs.get(this.msgIdToStrFn(e))?.message}getWithIWantCount(e,t){const s=this.msgs.get(e);if(null==s)return null;const r=(s.iwantCounts.get(t)??0)+1;return s.iwantCounts.set(t,r),{msg:s.message,count:r}}getGossipIDs(e){const t=new Map;for(let s=0;s<this.gossip;s++)this.history[s].forEach(s=>{const r=this.msgs.get(s.msgIdStr);if(r?.validated&&e.has(s.topic)){let e=t.get(s.topic);null==e&&(e=[],t.set(s.topic,e)),e.push(s.msgId)}});return t}validate(e){const t=this.msgs.get(e);if(null==t)return null;t.validated||this.notValidatedCount--;const{message:s,originatingPeers:r}=t;return t.validated=!0,t.originatingPeers=new Set,{message:s,originatingPeers:r}}shift(){this.history[this.history.length-1].forEach(e=>{const t=this.msgs.get(e.msgIdStr);null!=t&&(this.msgs.delete(e.msgIdStr),t.validated||this.notValidatedCount--)}),this.history.pop(),this.history.unshift([])}remove(e){const t=this.msgs.get(e);return null==t?null:(this.msgs.delete(e),t)}}function ET(e){switch(e){case rI.Ignore:return dT.Ignore;case rI.Reject:return dT.Reject;default:throw new Error("Unreachable")}}!function(e){e.StrictSign="StrictSign",e.StrictNoSign="StrictNoSign"}(hT||(hT={})),function(e){e[e.Signing=0]="Signing",e[e.Anonymous=1]="Anonymous"}(uT||(uT={})),function(e){e.Error="error",e.Ignore="ignore",e.Reject="reject",e.Blacklisted="blacklisted"}(dT||(dT={})),function(e){e.InvalidSignature="invalid_signature",e.InvalidSeqno="invalid_seqno",e.InvalidPeerId="invalid_peerid",e.SignaturePresent="signature_present",e.SeqnoPresent="seqno_present",e.FromPresent="from_present",e.TransformFailed="transform_failed"}(pT||(pT={})),function(e){e.duplicate="duplicate",e.invalid="invalid",e.valid="valid"}(fT||(fT={})),function(e){e.forward="forward",e.publish="publish"}(gT||(gT={})),function(e){e.Fanout="fanout",e.Random="random",e.Subscribed="subscribed",e.Outbound="outbound",e.NotEnough="not_enough",e.Opportunistic="opportunistic"}(mT||(mT={})),function(e){e.Dc="disconnected",e.BadScore="bad_score",e.Prune="prune",e.Excess="excess"}(yT||(yT={})),function(e){e.GraftBackoff="graft_backoff",e.BrokenPromise="broken_promise",e.MessageDeficit="message_deficit",e.IPColocation="IP_colocation"}(bT||(bT={})),function(e){e.LowScore="low_score",e.MaxIhave="max_ihave",e.MaxIasked="max_iasked"}(wT||(wT={})),function(e){e.graylist="graylist",e.publish="publish",e.gossip="gossip",e.mesh="mesh"}(vT||(vT={}));class DT extends Error{static name="InvalidPeerScoreParamsError";constructor(e="Invalid peer score params"){super(e),this.name="InvalidPeerScoreParamsError"}}const _T={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:36e5},TT={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function IT(e={}){return{..._T,...e,topics:null!=e.topics?Object.entries(e.topics).reduce((e,[t,s])=>(e[t]=function(e={}){return{...TT,...e}}(s),e),{}):{}}}function CT(e){if(e.topicWeight<0)throw new DT("invalid topic weight; must be >= 0");if(0===e.timeInMeshQuantum)throw new DT("invalid TimeInMeshQuantum; must be non zero");if(e.timeInMeshWeight<0)throw new DT("invalid TimeInMeshWeight; must be positive (or 0 to disable)");if(0!==e.timeInMeshWeight&&e.timeInMeshQuantum<=0)throw new DT("invalid TimeInMeshQuantum; must be positive");if(0!==e.timeInMeshWeight&&e.timeInMeshCap<=0)throw new DT("invalid TimeInMeshCap; must be positive");if(e.firstMessageDeliveriesWeight<0)throw new DT("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)");if(0!==e.firstMessageDeliveriesWeight&&(e.firstMessageDeliveriesDecay<=0||e.firstMessageDeliveriesDecay>=1))throw new DT("invalid FirstMessageDeliveriesDecay; must be between 0 and 1");if(0!==e.firstMessageDeliveriesWeight&&e.firstMessageDeliveriesCap<=0)throw new DT("invalid FirstMessageDeliveriesCap; must be positive");if(e.meshMessageDeliveriesWeight>0)throw new DT("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)");if(0!==e.meshMessageDeliveriesWeight&&(e.meshMessageDeliveriesDecay<=0||e.meshMessageDeliveriesDecay>=1))throw new DT("invalid MeshMessageDeliveriesDecay; must be between 0 and 1");if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesCap<=0)throw new DT("invalid MeshMessageDeliveriesCap; must be positive");if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesThreshold<=0)throw new DT("invalid MeshMessageDeliveriesThreshold; must be positive");if(e.meshMessageDeliveriesWindow<0)throw new DT("invalid MeshMessageDeliveriesWindow; must be non-negative");if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesActivation<1e3)throw new DT("invalid MeshMessageDeliveriesActivation; must be at least 1s");if(e.meshFailurePenaltyWeight>0)throw new DT("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)");if(0!==e.meshFailurePenaltyWeight&&(e.meshFailurePenaltyDecay<=0||e.meshFailurePenaltyDecay>=1))throw new DT("invalid MeshFailurePenaltyDecay; must be between 0 and 1");if(e.invalidMessageDeliveriesWeight>0)throw new DT("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)");if(e.invalidMessageDeliveriesDecay<=0||e.invalidMessageDeliveriesDecay>=1)throw new DT("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1")}const PT={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function xT(e={}){return{...PT,...e}}function AT(e,t,s=()=>!0){const r=new Set;if(t<=0)return r;for(const n of e){if(r.size>=t)break;s(n)&&(r.add(n),e.delete(n))}return r}class kT extends Map{getDefault;constructor(e){super(),this.getDefault=e}getOrDefault(e){let t=super.get(e);return void 0===t&&(t=this.getDefault(),this.set(e,t)),t}}function NT(e,t,s,r){let n=0;Object.entries(t.topics).forEach(([e,t])=>{const r=s.topics[e];if(void 0===r)return;let i=0;if(t.inMesh){let e=t.meshTime/r.timeInMeshQuantum;e>r.timeInMeshCap&&(e=r.timeInMeshCap),i+=e*r.timeInMeshWeight}let o=t.firstMessageDeliveries;if(o>r.firstMessageDeliveriesCap&&(o=r.firstMessageDeliveriesCap),i+=o*r.firstMessageDeliveriesWeight,t.meshMessageDeliveriesActive&&t.meshMessageDeliveries<r.meshMessageDeliveriesThreshold){const e=r.meshMessageDeliveriesThreshold-t.meshMessageDeliveries;i+=e*e*r.meshMessageDeliveriesWeight}i+=t.meshFailurePenalty*r.meshFailurePenaltyWeight;i+=t.invalidMessageDeliveries*t.invalidMessageDeliveries*r.invalidMessageDeliveriesWeight,n+=i*r.topicWeight}),s.topicScoreCap>0&&n>s.topicScoreCap&&(n=s.topicScoreCap);const i=s.appSpecificScore(e);if(n+=i*s.appSpecificWeight,t.knownIPs.forEach(e=>{if(s.IPColocationFactorWhitelist.has(e))return;const t=r.get(e),i=null!=t?t.size:0;if(i>s.IPColocationFactorThreshold){const e=i-s.IPColocationFactorThreshold;n+=e*e*s.IPColocationFactorWeight}}),t.behaviourPenalty>s.behaviourPenaltyThreshold){const e=t.behaviourPenalty-s.behaviourPenaltyThreshold;n+=e*e*s.behaviourPenaltyWeight}return n}function RT(e,t){t=t||{};this._capacity=t.capacity,this._head=0,this._tail=0,Array.isArray(e)?this._fromArray(e):(this._capacityMask=3,this._list=new Array(4))}RT.prototype.peekAt=function(e){var t=e;if(t===(0|t)){var s=this.size();if(!(t>=s||t<-s))return t<0&&(t+=s),t=this._head+t&this._capacityMask,this._list[t]}},RT.prototype.get=function(e){return this.peekAt(e)},RT.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]},RT.prototype.peekFront=function(){return this.peek()},RT.prototype.peekBack=function(){return this.peekAt(-1)},Object.defineProperty(RT.prototype,"length",{get:function(){return this.size()}}),RT.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},RT.prototype.unshift=function(e){if(0===arguments.length)return this.size();var t=this._list.length;return this._head=this._head-1+t&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},RT.prototype.shift=function(){var e=this._head;if(e!==this._tail){var t=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),t}},RT.prototype.push=function(e){if(0===arguments.length)return this.size();var t=this._tail;return this._list[t]=e,this._tail=t+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},RT.prototype.pop=function(){var e=this._tail;if(e!==this._head){var t=this._list.length;this._tail=e-1+t&this._capacityMask;var s=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=t>>>2&&this._shrinkArray(),s}},RT.prototype.removeOne=function(e){var t=e;if(t===(0|t)&&this._head!==this._tail){var s=this.size(),r=this._list.length;if(!(t>=s||t<-s)){t<0&&(t+=s),t=this._head+t&this._capacityMask;var n,i=this._list[t];if(e<s/2){for(n=e;n>0;n--)this._list[t]=this._list[t=t-1+r&this._capacityMask];this._list[t]=void 0,this._head=this._head+1+r&this._capacityMask}else{for(n=s-1-e;n>0;n--)this._list[t]=this._list[t=t+1+r&this._capacityMask];this._list[t]=void 0,this._tail=this._tail-1+r&this._capacityMask}return i}}},RT.prototype.remove=function(e,t){var s,r=e,n=t;if(r===(0|r)&&this._head!==this._tail){var i=this.size(),o=this._list.length;if(!(r>=i||r<-i||t<1)){if(r<0&&(r+=i),1===t||!t)return(s=new Array(1))[0]=this.removeOne(r),s;if(0===r&&r+t>=i)return s=this.toArray(),this.clear(),s;var a;for(r+t>i&&(t=i-r),s=new Array(t),a=0;a<t;a++)s[a]=this._list[this._head+r+a&this._capacityMask];if(r=this._head+r&this._capacityMask,e+t===i){for(this._tail=this._tail-t+o&this._capacityMask,a=t;a>0;a--)this._list[r=r+1+o&this._capacityMask]=void 0;return s}if(0===e){for(this._head=this._head+t+o&this._capacityMask,a=t-1;a>0;a--)this._list[r=r+1+o&this._capacityMask]=void 0;return s}if(r<i/2){for(this._head=this._head+e+t+o&this._capacityMask,a=e;a>0;a--)this.unshift(this._list[r=r-1+o&this._capacityMask]);for(r=this._head-1+o&this._capacityMask;n>0;)this._list[r=r-1+o&this._capacityMask]=void 0,n--;e<0&&(this._tail=r)}else{for(this._tail=r,r=r+t+o&this._capacityMask,a=i-(t+e);a>0;a--)this.push(this._list[r++]);for(r=this._tail;n>0;)this._list[r=r+1+o&this._capacityMask]=void 0,n--}return this._head<2&&this._tail>1e4&&this._tail<=o>>>2&&this._shrinkArray(),s}}},RT.prototype.splice=function(e,t){var s=e;if(s===(0|s)){var r=this.size();if(s<0&&(s+=r),!(s>r)){if(arguments.length>2){var n,i,o,a=arguments.length,c=this._list.length,l=2;if(!r||s<r/2){for(i=new Array(s),n=0;n<s;n++)i[n]=this._list[this._head+n&this._capacityMask];for(0===t?(o=[],s>0&&(this._head=this._head+s+c&this._capacityMask)):(o=this.remove(s,t),this._head=this._head+s+c&this._capacityMask);a>l;)this.unshift(arguments[--a]);for(n=s;n>0;n--)this.unshift(i[n-1])}else{var h=(i=new Array(r-(s+t))).length;for(n=0;n<h;n++)i[n]=this._list[this._head+s+t+n&this._capacityMask];for(0===t?(o=[],s!=r&&(this._tail=this._head+s+c&this._capacityMask)):(o=this.remove(s,t),this._tail=this._tail-h+c&this._capacityMask);l<a;)this.push(arguments[l++]);for(n=0;n<h;n++)this.push(i[n])}return o}return this.remove(s,t)}}},RT.prototype.clear=function(){this._list=new Array(this._list.length),this._head=0,this._tail=0},RT.prototype.isEmpty=function(){return this._head===this._tail},RT.prototype.toArray=function(){return this._copyArray(!1)},RT.prototype._fromArray=function(e){var t=e.length,s=this._nextPowerOf2(t);this._list=new Array(s),this._capacityMask=s-1,this._tail=t;for(var r=0;r<t;r++)this._list[r]=e[r]},RT.prototype._copyArray=function(e,t){var s=this._list,r=s.length,n=this.length;if((t|=n)==n&&this._head<this._tail)return this._list.slice(this._head,this._tail);var i,o=new Array(t),a=0;if(e||this._head>this._tail){for(i=this._head;i<r;i++)o[a++]=s[i];for(i=0;i<this._tail;i++)o[a++]=s[i]}else for(i=this._head;i<this._tail;i++)o[a++]=s[i];return o},RT.prototype._growArray=function(){if(0!=this._head){var e=this._copyArray(!0,this._list.length<<1);this._tail=this._list.length,this._head=0,this._list=e}else this._tail=this._list.length,this._list.length<<=1;this._capacityMask=this._capacityMask<<1|1},RT.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1},RT.prototype._nextPowerOf2=function(e){var t=1<<Math.log(e)/Math.log(2)+1;return Math.max(t,4)};var MT,LT=t(RT);!function(e){e[e.unknown=0]="unknown",e[e.valid=1]="valid",e[e.invalid=2]="invalid",e[e.ignored=3]="ignored"}(MT||(MT={}));class OT{records;queue;constructor(){this.records=new Map,this.queue=new LT}getRecord(e){return this.records.get(e)}ensureRecord(e){let t=this.records.get(e);if(null!=t)return t;t={status:MT.unknown,firstSeenTsMs:Date.now(),validated:0,peers:new Set},this.records.set(e,t);const s={msgId:e,expire:Date.now()+12e4};return this.queue.push(s),t}gc(){const e=Date.now();let t=this.queue.peekFront();for(;null!=t&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}class BT{params;metrics;peerStats=new Map;peerIPs=new kT(()=>new Set);scoreCache=new Map;deliveryRecords=new OT;_backgroundInterval;scoreCacheValidityMs;computeScore;log;constructor(e,t,s,r){this.params=e,this.metrics=t,function(e){for(const[t,s]of Object.entries(e.topics))try{CT(s)}catch(e){throw new DT(`invalid score parameters for topic ${t}: ${e.message}`)}if(e.topicScoreCap<0)throw new DT("invalid topic score cap; must be positive (or 0 for no cap)");if(null===e.appSpecificScore||void 0===e.appSpecificScore)throw new DT("missing application specific score function");if(e.IPColocationFactorWeight>0)throw new DT("invalid IPColocationFactorWeight; must be negative (or 0 to disable)");if(0!==e.IPColocationFactorWeight&&e.IPColocationFactorThreshold<1)throw new DT("invalid IPColocationFactorThreshold; must be at least 1");if(e.behaviourPenaltyWeight>0)throw new DT("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)");if(0!==e.behaviourPenaltyWeight&&(e.behaviourPenaltyDecay<=0||e.behaviourPenaltyDecay>=1))throw new DT("invalid BehaviourPenaltyDecay; must be between 0 and 1");if(e.decayInterval<1e3)throw new DT("invalid DecayInterval; must be at least 1s");if(e.decayToZero<=0||e.decayToZero>=1)throw new DT("invalid DecayToZero; must be between 0 and 1")}(e),this.scoreCacheValidityMs=r.scoreCacheValidityMs,this.computeScore=r.computeScore??NT,this.log=s.forComponent("libp2p:gossipsub:score")}get size(){return this.peerStats.size}start(){null==this._backgroundInterval?(this._backgroundInterval=setInterval(()=>{this.background()},this.params.decayInterval),this.log("started")):this.log("Peer score already running")}stop(){null!=this._backgroundInterval?(clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),this.log("stopped")):this.log("Peer score already stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map(([e,t])=>[e,t]))}messageFirstSeenTimestampMs(e){const t=this.deliveryRecords.getRecord(e);return null!=t?t.firstSeenTsMs:null}refreshScores(){const e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach((s,r)=>{s.connected?(Object.entries(s.topics).forEach(([s,r])=>{const n=this.params.topics[s];void 0!==n&&(r.firstMessageDeliveries*=n.firstMessageDeliveriesDecay,r.firstMessageDeliveries<t&&(r.firstMessageDeliveries=0),r.meshMessageDeliveries*=n.meshMessageDeliveriesDecay,r.meshMessageDeliveries<t&&(r.meshMessageDeliveries=0),r.meshFailurePenalty*=n.meshFailurePenaltyDecay,r.meshFailurePenalty<t&&(r.meshFailurePenalty=0),r.invalidMessageDeliveries*=n.invalidMessageDeliveriesDecay,r.invalidMessageDeliveries<t&&(r.invalidMessageDeliveries=0),r.inMesh&&(r.meshTime=e-r.graftTime,r.meshTime>n.meshMessageDeliveriesActivation&&(r.meshMessageDeliveriesActive=!0)))}),s.behaviourPenalty*=this.params.behaviourPenaltyDecay,s.behaviourPenalty<t&&(s.behaviourPenalty=0)):e>s.expire&&(this.removeIPsForPeer(r,s.knownIPs),this.peerStats.delete(r),this.scoreCache.delete(r))})}score(e){this.metrics?.scoreFnCalls.inc();const t=this.peerStats.get(e);if(null==t)return 0;const s=Date.now(),r=this.scoreCache.get(e);if(null!=r&&r.cacheUntil>s)return r.score;this.metrics?.scoreFnRuns.inc();const n=this.computeScore(e,t,this.params,this.peerIPs),i=s+this.scoreCacheValidityMs;return null!=r?(this.metrics?.scoreCachedDelta.observe(Math.abs(n-r.score)),r.score=n,r.cacheUntil=i):this.scoreCache.set(e,{score:n,cacheUntil:i}),n}addPenalty(e,t,s){const r=this.peerStats.get(e);null!=r&&(r.behaviourPenalty+=t,this.metrics?.onScorePenalty(s))}addPeer(e){const t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}addIP(e,t){const s=this.peerStats.get(e);null!=s&&s.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}removeIP(e,t){const s=this.peerStats.get(e);null!=s&&s.knownIPs.delete(t);const r=this.peerIPs.get(t);null!=r&&(r.delete(e),0===r.size&&this.peerIPs.delete(t))}removePeer(e){const t=this.peerStats.get(e);if(null!=t){if(this.score(e)>0)return this.removeIPsForPeer(e,t.knownIPs),void this.peerStats.delete(e);Object.entries(t.topics).forEach(([e,t])=>{t.firstMessageDeliveries=0;const s=this.params.topics[e].meshMessageDeliveriesThreshold;if(t.inMesh&&t.meshMessageDeliveriesActive&&t.meshMessageDeliveries<s){const e=s-t.meshMessageDeliveries;t.meshFailurePenalty+=e*e}t.inMesh=!1,t.meshMessageDeliveriesActive=!1}),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){const s=this.peerStats.get(e);if(null!=s){const e=this.getPtopicStats(s,t);null!=e&&(e.inMesh=!0,e.graftTime=Date.now(),e.meshTime=0,e.meshMessageDeliveriesActive=!1)}}prune(e,t){const s=this.peerStats.get(e);if(null!=s){const e=this.getPtopicStats(s,t);if(null!=e){const s=this.params.topics[t].meshMessageDeliveriesThreshold;if(e.meshMessageDeliveriesActive&&e.meshMessageDeliveries<s){const t=s-e.meshMessageDeliveries;e.meshFailurePenalty+=t*t}e.meshMessageDeliveriesActive=!1,e.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,s){this.markFirstMessageDelivery(e,s);const r=this.deliveryRecords.ensureRecord(t),n=Date.now();r.status===MT.unknown?(r.status=MT.valid,r.validated=n,r.peers.forEach(t=>{t!==e.toString()&&this.markDuplicateMessageDelivery(t,s)})):this.log("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,n-r.firstSeenTsMs,MT[r.status])}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,s,r){switch(r){case dT.Error:return void this.markInvalidMessageDelivery(e,s);case dT.Blacklisted:return}const n=this.deliveryRecords.ensureRecord(t);if(n.status===MT.unknown){if(r===dT.Ignore)return n.status=MT.ignored,void n.peers.clear();n.status=MT.invalid,this.markInvalidMessageDelivery(e,s),n.peers.forEach(e=>{this.markInvalidMessageDelivery(e,s)}),n.peers.clear()}else this.log("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-n.firstSeenTsMs,MT[n.status])}duplicateMessage(e,t,s){const r=this.deliveryRecords.ensureRecord(t);if(!r.peers.has(e))switch(r.status){case MT.unknown:r.peers.add(e);break;case MT.valid:r.peers.add(e),this.markDuplicateMessageDelivery(e,s,r.validated);break;case MT.invalid:this.markInvalidMessageDelivery(e,s);case MT.ignored:}}markInvalidMessageDelivery(e,t){const s=this.peerStats.get(e);if(null!=s){const e=this.getPtopicStats(s,t);null!=e&&(e.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){const s=this.peerStats.get(e);if(null!=s){const e=this.getPtopicStats(s,t);if(null!=e){let s=this.params.topics[t].firstMessageDeliveriesCap;e.firstMessageDeliveries=Math.min(s,e.firstMessageDeliveries+1),e.inMesh&&(s=this.params.topics[t].meshMessageDeliveriesCap,e.meshMessageDeliveries=Math.min(s,e.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,s){const r=this.peerStats.get(e);if(null!=r){const e=void 0!==s?Date.now():0,n=this.getPtopicStats(r,t);if(null!=n&&n.inMesh){const r=this.params.topics[t];if(void 0!==s){const n=e-s,i=n>r.meshMessageDeliveriesWindow;if(this.metrics?.onDuplicateMsgDelivery(t,n,i),i)return}const i=r.meshMessageDeliveriesCap;n.meshMessageDeliveries=Math.min(i,n.meshMessageDeliveries+1)}}}removeIPsForPeer(e,t){for(const s of t){const t=this.peerIPs.get(s);null!=t&&(t.delete(e),0===t.size&&this.peerIPs.delete(s))}}getPtopicStats(e,t){let s=e.topics[t];return void 0!==s?s:void 0!==this.params.topics[t]?(s={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=s,s):null}}function UT(e,t,s,r,n){let i=0;const o=new Map;if(Object.entries(t.topics).forEach(([e,t])=>{const r=n.get(e)??"unknown",a=s.topics[e];if(void 0===a)return;let c=o.get(r);null==c&&(c={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},o.set(r,c));let l=0,h=0,u=0,d=0,p=0;if(t.inMesh){l+=Math.max(t.meshTime/a.timeInMeshQuantum,a.timeInMeshCap)*a.timeInMeshWeight}let f=t.firstMessageDeliveries;if(f>a.firstMessageDeliveriesCap&&(f=a.firstMessageDeliveriesCap),h+=f*a.firstMessageDeliveriesWeight,t.meshMessageDeliveriesActive&&t.meshMessageDeliveries<a.meshMessageDeliveriesThreshold){const e=a.meshMessageDeliveriesThreshold-t.meshMessageDeliveries;u+=e*e*a.meshMessageDeliveriesWeight}d+=t.meshFailurePenalty*a.meshFailurePenaltyWeight;p+=t.invalidMessageDeliveries*t.invalidMessageDeliveries*a.invalidMessageDeliveriesWeight,i+=(l+h+u+d+p)*a.topicWeight,c.p1w+=l,c.p2w+=h,c.p3w+=u,c.p3bw+=d,c.p4w+=p}),s.topicScoreCap>0&&i>s.topicScoreCap){i=s.topicScoreCap;const e=s.topicScoreCap/i;for(const t of o.values())t.p1w*=e,t.p2w*=e,t.p3w*=e,t.p3bw*=e,t.p4w*=e}let a=0,c=0,l=0;a+=s.appSpecificScore(e)*s.appSpecificWeight,t.knownIPs.forEach(e=>{if(s.IPColocationFactorWhitelist.has(e))return;const t=r.get(e),n=null!=t?t.size:0;if(n>s.IPColocationFactorThreshold){const e=n-s.IPColocationFactorThreshold;c+=e*e*s.IPColocationFactorWeight}});return l+=t.behaviourPenalty*t.behaviourPenalty*s.behaviourPenaltyWeight,i+=a+c+l,{byTopic:o,p5w:a,p6w:c,p7w:l,score:i}}function VT(e){const t=e.getComponents(),s={};let r=0;if("ip6zone"===t[r]?.name&&(s.zone=`${t[r].value}`,r++),"ip4"===t[r].name||"ip6"===t[r].name||"dns"===t[r].name||"dns4"===t[r].name||"dns6"===t[r].name?(s.type=t[r].name,s.host=t[r].value,r++):"dnsaddr"===t[r].name&&(s.type=t[r].name,s.host=`_dnsaddr.${t[r].value}`,r++),"tcp"!==t[r]?.name&&"udp"!==t[r]?.name||(s.protocol="tcp"===t[r].name?"tcp":"udp",s.port=parseInt(`${t[r].value}`),r++),"ipcidr"===t[r]?.name&&("ip4"===s.type?s.cidr=parseInt(`${t[r].value}`):"ip6"===s.type&&(s.cidr=`${t[r].value}`),r++),null==s.type||null==s.host)throw new H_(`Multiaddr ${e} was not an IPv4, IPv6, DNS, DNS4, DNS6 or DNSADDR address`);return"tls"===t[r]?.name&&"sni"===t[r+1]?.name&&(s.sni=t[r+1].value,r+=2),s}function FT(...e){const t=e.map(e=>{return t=e,null!=t?.addEventListener?function(e){const t=Xl();let s;const r=e=>{t.push(e.data)},n=()=>{t.end(),e.removeEventListener("message",r),e.removeEventListener("close",i),e.removeEventListener("remoteCloseWrite",n)},i=o=>{t.end(o.error),null!=o.error&&s?.reject(o.error),e.removeEventListener("message",r),e.removeEventListener("close",i),e.removeEventListener("remoteCloseWrite",n)};return e.addEventListener("message",r),e.addEventListener("close",i,{once:!0}),e.addEventListener("remoteCloseWrite",n,{once:!0}),{source:t,async sink(t){const r=async function*(){yield*t}();for(;;){s=Promise.withResolvers();const{done:t,value:n}=await Promise.race([r.next(),s.promise]);if("closing"===e.writeStatus||"closed"===e.writeStatus)break;if(null!=n&&(e.send(n)||await Promise.race([Nm(e,"drain",{rejectionEvents:["close"]})])),!0===t)break}await e.close()}}}(e):e;var t});return qm(...t)}class zT{rawStream;constructor(e,t,s){this.rawStream=e,null!=s.maxBufferSize&&(e.maxWriteBufferLength=s.maxBufferSize),e.addEventListener("close",e=>{null!=e.error&&t(e.error)})}get protocol(){return this.rawStream.protocol}async push(e){return this.pushPrefixed(wf.single(e))}pushPrefixed(e){this.rawStream.send(e)}async close(e){await this.rawStream.close(e).catch(e=>{this.rawStream.abort(e)})}}class $T{source;rawStream;closeController;constructor(e,t={}){this.rawStream=e,this.closeController=new AbortController,this.closeController.signal.addEventListener("abort",()=>{e.close().catch(t=>{e.abort(t)})}),this.source=FT(this.rawStream,e=>Ef(e,t))}async close(){this.closeController.abort()}}class qT{gossipsubIWantFollowupMs;msgIdToStrFn;metrics;promises=new Map;requestMsByMsg=new Map;requestMsByMsgExpire;constructor(e,t,s){this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=s,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){const s=t[Math.floor(Math.random()*t.length)],r=this.msgIdToStrFn(s);let n=this.promises.get(r);null==n&&(n=new Map,this.promises.set(r,n));const i=Date.now();n.has(e)||(n.set(e,i+this.gossipsubIWantFollowupMs),null!=this.metrics&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(r)||this.requestMsByMsg.set(r,i)))}getBrokenPromises(){const e=Date.now(),t=new Map;let s=0;return this.promises.forEach((r,n)=>{r.forEach((n,i)=>{n<e&&(t.set(i,(t.get(i)??0)+1),r.delete(i),s++)}),0===r.size&&this.promises.delete(n)}),this.metrics?.iwantPromiseBroken.inc(s),t}deliverMessage(e,t=!1){this.trackMessage(e);const s=this.promises.get(e);null!=s&&(this.promises.delete(e),null!=this.metrics&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(s.size)))}rejectMessage(e,t){this.trackMessage(e),t!==dT.Error&&this.promises.delete(e)}clear(){this.promises.clear()}prune(){const e=Date.now()-this.requestMsByMsgExpire;let t=0;for(const[s,r]of this.requestMsByMsg.entries()){if(!(r<e))break;this.requestMsByMsg.delete(s),t++}this.metrics?.iwantMessagePruned.inc(t)}trackMessage(e){if(null!=this.metrics){const t=this.requestMsByMsg.get(e);void 0!==t&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}}const WT=Ge("libp2p-pubsub:");function KT(e=[],t){return{subscriptions:[],messages:e,control:void 0!==t?{graft:t.graft??[],prune:t.prune??[],ihave:t.ihave??[],iwant:t.iwant??[],idontwant:t.idontwant??[]}:void 0}}function jT(e){return void 0===e.control&&(e.control={graft:[],prune:[],ihave:[],iwant:[],idontwant:[]}),e}function HT(e){if(e.length<=1)return e;const t=()=>Math.floor(Math.random()*Math.floor(e.length));for(let s=0;s<e.length;s++){const r=t(),n=e[s];e[s]=e[r],e[r]=n}return e}function GT(e){return Qe(e,"base64")}function QT(e){if("signed"!==e.type)throw new Error("expected signed message type");if(null==e.sequenceNumber)throw Error("missing seqno field");return((e,t)=>{const s=Ge(t.toString(16).padStart(16,"0"),"base16"),r=Ho(e),n=new Uint8Array(r.byteLength+s.length);return n.set(r,0),n.set(s,r.byteLength),n})(e.from.publicKey??e.key,e.sequenceNumber)}async function XT(e){return Me.encode(e.data)}function YT(e){if(function(e){try{return VT(e),!0}catch{return!1}}(e)){const t=VT(e);switch(t.type){case"ip4":case"ip6":return t.host}}return null}class JT{entries=new Map;validityMs;constructor(e){this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){return!!this.entries.has(e)||(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){const e=Date.now();for(const[t,s]of this.entries.entries()){if(!(s.validUntilMs<e))break;this.entries.delete(t)}}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return null!=t&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}}var ZT;!function(e){e[e.started=0]="started",e[e.stopped=1]="stopped"}(ZT||(ZT={}));class eI extends ns{globalSignaturePolicy;protocols=[K_,"/meshsub/1.1.0",W_];publishConfig;dataTransform;peers=new Map;streamsInbound=new Map;streamsOutbound=new Map;outboundInflightQueue=Xl({objectMode:!0});direct=new Set;floodsubPeers=new Set;seenCache;acceptFromWhitelist=new Map;topics=new Map;subscriptions=new Set;mesh=new Map;fanout=new Map;fanoutLastpub=new Map;gossip=new Map;control=new Map;peerhave=new Map;iasked=new Map;backoff=new Map;outbound=new Map;msgIdFn;fastMsgIdFn;msgIdToStrFn;fastMsgIdCache;publishedMessageIds;mcache;score;topicValidators=new Map;log;heartbeatTicks=0;gossipTracer;idontwantCounts=new Map;idontwants=new Map;components;directPeerInitial=null;static multicodec=K_;opts;decodeRpcLimits;metrics;status={code:ZT.stopped};maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;allowedTopics;heartbeatTimer=null;constructor(e,t={}){super();const s={fallbackToFloodsub:!0,floodPublish:!0,batchPublish:!1,tagMeshPeers:!0,doPX:!1,directPeers:[],D:6,Dlo:4,Dhi:12,Dscore:4,Dout:2,Dlazy:6,heartbeatInterval:1e3,fanoutTTL:6e4,mcacheLength:5,mcacheGossip:3,seenTTL:12e4,gossipsubIWantFollowupMs:3e3,prunePeers:16,pruneBackoff:6e4,unsubcribeBackoff:1e4,graftFloodThreshold:1e4,opportunisticGraftPeers:2,opportunisticGraftTicks:60,directConnectTicks:300,gossipFactor:.25,idontwantMinDataSize:512,idontwantMaxMessages:512,...t,scoreParams:IT(t.scoreParams),scoreThresholds:xT(t.scoreThresholds)};if(this.components=e,this.decodeRpcLimits=s.decodeRpcLimits??cT,this.globalSignaturePolicy=s.globalSignaturePolicy??tI,s.fallbackToFloodsub&&this.protocols.push(q_),this.log=e.logger.forComponent(s.debugName??"libp2p:gossipsub"),this.opts=s,this.direct=new Set(s.directPeers.map(e=>e.id.toString())),this.seenCache=new JT({validityMs:s.seenTTL}),this.publishedMessageIds=new JT({validityMs:s.seenTTL}),null!=t.msgIdFn)this.msgIdFn=t.msgIdFn;else switch(this.globalSignaturePolicy){case tI:this.msgIdFn=QT;break;case sI:this.msgIdFn=XT;break;default:throw new Error(`Invalid globalSignaturePolicy: ${this.globalSignaturePolicy}`)}if(null!=t.fastMsgIdFn&&(this.fastMsgIdFn=t.fastMsgIdFn,this.fastMsgIdCache=new JT({validityMs:s.seenTTL})),this.msgIdToStrFn=t.msgIdToStrFn??GT,this.mcache=t.messageCache??new ST(s.mcacheGossip,s.mcacheLength,this.msgIdToStrFn),null!=t.dataTransform&&(this.dataTransform=t.dataTransform),null!=t.metricsRegister){if(null==t.metricsTopicStrToLabel)throw Error("Must set metricsTopicStrToLabel with metrics");const e=Math.max(...Object.values(s.scoreParams.topics).map(e=>e.meshMessageDeliveriesWindow),1e3),r=function(e,t,s){return{protocolsEnabled:e.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:e.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:e.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:e.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEventsFanout:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_fanout_total",help:"Number of times we include peers in a topic mesh for fanout reasons",labelNames:["topic"]}),meshPeerInclusionEventsRandom:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_random_total",help:"Number of times we include peers in a topic mesh for random reasons",labelNames:["topic"]}),meshPeerInclusionEventsSubscribed:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_subscribed_total",help:"Number of times we include peers in a topic mesh for subscribed reasons",labelNames:["topic"]}),meshPeerInclusionEventsOutbound:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_outbound_total",help:"Number of times we include peers in a topic mesh for outbound reasons",labelNames:["topic"]}),meshPeerInclusionEventsNotEnough:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_not_enough_total",help:"Number of times we include peers in a topic mesh for not_enough reasons",labelNames:["topic"]}),meshPeerInclusionEventsOpportunistic:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_opportunistic_total",help:"Number of times we include peers in a topic mesh for opportunistic reasons",labelNames:["topic"]}),meshPeerInclusionEventsUnknown:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_unknown_total",help:"Number of times we include peers in a topic mesh for unknown reasons",labelNames:["topic"]}),meshPeerChurnEventsDisconnected:e.gauge({name:"gossipsub_peer_churn_events_disconnected_total",help:"Number of times we remove peers in a topic mesh for disconnected reasons",labelNames:["topic"]}),meshPeerChurnEventsBadScore:e.gauge({name:"gossipsub_peer_churn_events_bad_score_total",help:"Number of times we remove peers in a topic mesh for bad_score reasons",labelNames:["topic"]}),meshPeerChurnEventsPrune:e.gauge({name:"gossipsub_peer_churn_events_prune_total",help:"Number of times we remove peers in a topic mesh for prune reasons",labelNames:["topic"]}),meshPeerChurnEventsExcess:e.gauge({name:"gossipsub_peer_churn_events_excess_total",help:"Number of times we remove peers in a topic mesh for excess reasons",labelNames:["topic"]}),meshPeerChurnEventsUnknown:e.gauge({name:"gossipsub_peer_churn_events_unknown_total",help:"Number of times we remove peers in a topic mesh for unknown reasons",labelNames:["topic"]}),peersPerProtocol:e.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:e.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:e.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),acceptedMessagesTotal:e.gauge({name:"gossipsub_accepted_messages_total",help:"Total accepted messages for each topic",labelNames:["topic"]}),ignoredMessagesTotal:e.gauge({name:"gossipsub_ignored_messages_total",help:"Total ignored messages for each topic",labelNames:["topic"]}),rejectedMessagesTotal:e.gauge({name:"gossipsub_rejected_messages_total",help:"Total rejected messages for each topic",labelNames:["topic"]}),unknownValidationResultsTotal:e.gauge({name:"gossipsub_unknown_validation_results_total",help:"Total unknown validation results for each topic",labelNames:["topic"]}),asyncValidationMcacheHit:e.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),asyncValidationDelayFromFirstSeenSec:e.histogram({name:"gossipsub_async_validation_delay_from_first_seen",help:"Async validation report delay from first seen in second",buckets:[.01,.03,.1,.3,1,3,10]}),asyncValidationUnknownFirstSeen:e.gauge({name:"gossipsub_async_validation_unknown_first_seen_count_total",help:"Async validation report unknown first seen value for message"}),peerReadStreamError:e.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:e.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:e.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:e.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:e.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:e.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:e.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:e.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:e.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:e.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:e.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:e.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:e.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:e.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:e.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:e.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:e.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:e.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:e.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:e.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:e.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:e.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),rpcSentIDontWant:e.gauge({name:"gossipsub_rpc_sent_idontwant_total",help:"RPC sent"}),msgPublishCount:e.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeersByTopic:e.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),directPeersPublishedTotal:e.gauge({name:"gossipsub_direct_peers_published_total",help:"Total direct peers that we publish a msg to",labelNames:["topic"]}),floodsubPeersPublishedTotal:e.gauge({name:"gossipsub_floodsub_peers_published_total",help:"Total floodsub peers that we publish a msg to",labelNames:["topic"]}),meshPeersPublishedTotal:e.gauge({name:"gossipsub_mesh_peers_published_total",help:"Total mesh peers that we publish a msg to",labelNames:["topic"]}),fanoutPeersPublishedTotal:e.gauge({name:"gossipsub_fanout_peers_published_total",help:"Total fanout peers that we publish a msg to",labelNames:["topic"]}),msgPublishBytes:e.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgPublishTime:e.histogram({name:"gossipsub_msg_publish_seconds",help:"Total time in seconds to publish a message",buckets:[.001,.002,.005,.01,.1,.5,1],labelNames:["topic"]}),msgForwardCount:e.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:e.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:e.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:e.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),prevalidationInvalidTotal:e.gauge({name:"gossipsub_pre_validation_invalid_total",help:"Total count of invalid messages received",labelNames:["topic"]}),prevalidationValidTotal:e.gauge({name:"gossipsub_pre_validation_valid_total",help:"Total count of valid messages received",labelNames:["topic"]}),prevalidationDuplicateTotal:e.gauge({name:"gossipsub_pre_validation_duplicate_total",help:"Total count of duplicate messages received",labelNames:["topic"]}),prevalidationUnknownTotal:e.gauge({name:"gossipsub_pre_validation_unknown_status_total",help:"Total count of unknown_status messages received",labelNames:["topic"]}),msgReceivedInvalid:e.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["error"]}),msgReceivedInvalidByTopic:e.gauge({name:"gossipsub_msg_received_invalid_by_topic_total",help:"Tracks specific invalid message by topic",labelNames:["topic"]}),duplicateMsgDeliveryDelay:e.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*s.maxMeshMessageDeliveriesWindowSec,.5*s.maxMeshMessageDeliveriesWindowSec,Number(s.maxMeshMessageDeliveriesWindowSec),2*s.maxMeshMessageDeliveriesWindowSec,4*s.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:e.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:e.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:e.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:e.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:e.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:e.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:e.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores"}),scoreWeights:e.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:e.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:e.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:e.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*s.behaviourPenaltyThreshold,.5*s.behaviourPenaltyThreshold,Number(s.behaviourPenaltyThreshold),2*s.behaviourPenaltyThreshold,4*s.behaviourPenaltyThreshold]}),ihaveRcvIgnored:e.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:e.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:e.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:e.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:e.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),idontwantRcvMsgids:e.gauge({name:"gossipsub_idontwant_rcv_msgids_total",help:"Total received IDONTWANT messages"}),idontwantRcvDonthaveMsgids:e.gauge({name:"gossipsub_idontwant_rcv_dont_have_msgids_total",help:"Total received IDONTWANT messageIDs that we do not have in mcache"}),iwantPromiseStarted:e.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:e.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:e.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:e.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:e.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:e.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:e.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*s.gossipPromiseExpireSec,Number(s.gossipPromiseExpireSec),2*s.gossipPromiseExpireSec,4*s.gossipPromiseExpireSec]}),iwantPromiseUntracked:e.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),connectedPeersBackoffSec:e.histogram({name:"gossipsub_connected_peers_backoff_seconds",help:"Backoff time in seconds",buckets:[1,2,4,10,20,60,120]}),cacheSize:e.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:e.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:e.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:e.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:e.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:t,toTopic(e){return this.topicStrToLabel.get(e)??e},onJoin(e){this.topicSubscriptionStatus.set({topicStr:e},1),this.meshPeerCounts.set({topicStr:e},0)},onLeave(e){this.topicSubscriptionStatus.set({topicStr:e},0),this.meshPeerCounts.set({topicStr:e},0)},onAddToMesh(e,t,s){const r=this.toTopic(e);switch(t){case mT.Fanout:this.meshPeerInclusionEventsFanout.inc({topic:r},s);break;case mT.Random:this.meshPeerInclusionEventsRandom.inc({topic:r},s);break;case mT.Subscribed:this.meshPeerInclusionEventsSubscribed.inc({topic:r},s);break;case mT.Outbound:this.meshPeerInclusionEventsOutbound.inc({topic:r},s);break;case mT.NotEnough:this.meshPeerInclusionEventsNotEnough.inc({topic:r},s);break;case mT.Opportunistic:this.meshPeerInclusionEventsOpportunistic.inc({topic:r},s);break;default:this.meshPeerInclusionEventsUnknown.inc({topic:r},s)}},onRemoveFromMesh(e,t,s){const r=this.toTopic(e);switch(t){case yT.Dc:this.meshPeerChurnEventsDisconnected.inc({topic:r},s);break;case yT.BadScore:this.meshPeerChurnEventsBadScore.inc({topic:r},s);break;case yT.Prune:this.meshPeerChurnEventsPrune.inc({topic:r},s);break;case yT.Excess:this.meshPeerChurnEventsExcess.inc({topic:r},s);break;default:this.meshPeerChurnEventsUnknown.inc({topic:r},s)}},onReportValidation(e,t,s){if(this.asyncValidationMcacheHit.inc({hit:null!=e?"hit":"miss"}),null!=e){const s=this.toTopic(e.message.topic);switch(t){case rI.Accept:this.acceptedMessagesTotal.inc({topic:s});break;case rI.Ignore:this.ignoredMessagesTotal.inc({topic:s});break;case rI.Reject:this.rejectedMessagesTotal.inc({topic:s});break;default:this.unknownValidationResultsTotal.inc({topic:s})}}null!=s?this.asyncValidationDelayFromFirstSeenSec.observe((Date.now()-s)/1e3):this.asyncValidationUnknownFirstSeen.inc()},onScorePenalty(e){this.scoringPenalties.inc({penalty:e},1)},onIhaveRcv(e,t,s){const r=this.toTopic(e);this.ihaveRcvMsgids.inc({topic:r},t),this.ihaveRcvNotSeenMsgids.inc({topic:r},s)},onIwantRcv(e,t){for(const[t,s]of e){const e=this.toTopic(t);this.iwantRcvMsgids.inc({topic:e},s)}this.iwantRcvDonthaveMsgids.inc(t)},onIdontwantRcv(e,t){this.idontwantRcvMsgids.inc(e),this.idontwantRcvDonthaveMsgids.inc(t)},onForwardMsg(e,t){const s=this.toTopic(e);this.msgForwardCount.inc({topic:s},1),this.msgForwardPeers.inc({topic:s},t)},onPublishMsg(e,t,s,r,n){const i=this.toTopic(e);this.msgPublishCount.inc({topic:i},1),this.msgPublishBytes.inc({topic:i},s*r),this.msgPublishPeersByTopic.inc({topic:i},s),this.directPeersPublishedTotal.inc({topic:i},t.direct),this.floodsubPeersPublishedTotal.inc({topic:i},t.floodsub),this.meshPeersPublishedTotal.inc({topic:i},t.mesh),this.fanoutPeersPublishedTotal.inc({topic:i},t.fanout),this.msgPublishTime.observe({topic:i},n/1e3)},onMsgRecvPreValidation(e){const t=this.toTopic(e);this.msgReceivedPreValidation.inc({topic:t},1)},onMsgRecvError(e){const t=this.toTopic(e);this.msgReceivedError.inc({topic:t},1)},onPrevalidationResult(e,t){const s=this.toTopic(e);switch(t){case fT.duplicate:this.prevalidationDuplicateTotal.inc({topic:s});break;case fT.invalid:this.prevalidationInvalidTotal.inc({topic:s});break;case fT.valid:this.prevalidationValidTotal.inc({topic:s});break;default:this.prevalidationUnknownTotal.inc({topic:s})}},onMsgRecvInvalid(e,t){const s=this.toTopic(e),r=t.reason===dT.Error?t.error:t.reason;this.msgReceivedInvalid.inc({error:r},1),this.msgReceivedInvalidByTopic.inc({topic:s},1)},onDuplicateMsgDelivery(e,t,s){const r=this.toTopic(e);this.duplicateMsgDeliveryDelay.observe({topic:r},t/1e3),s&&this.duplicateMsgLateDelivery.inc({topic:r},1)},onPublishDuplicateMsg(e){const t=this.toTopic(e);this.duplicateMsgIgnored.inc({topic:t},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(e,t){this.rpcRecvBytes.inc(t),this.rpcRecvCount.inc(1),null!=e.subscriptions&&this.rpcRecvSubscription.inc(e.subscriptions.length),null!=e.messages&&this.rpcRecvMessage.inc(e.messages.length),null!=e.control&&(this.rpcRecvControl.inc(1),null!=e.control.ihave&&this.rpcRecvIHave.inc(e.control.ihave.length),null!=e.control.iwant&&this.rpcRecvIWant.inc(e.control.iwant.length),null!=e.control.graft&&this.rpcRecvGraft.inc(e.control.graft.length),null!=e.control.prune&&this.rpcRecvPrune.inc(e.control.prune.length))},onRpcSent(e,t){if(this.rpcSentBytes.inc(t),this.rpcSentCount.inc(1),null!=e.subscriptions&&this.rpcSentSubscription.inc(e.subscriptions.length),null!=e.messages&&this.rpcSentMessage.inc(e.messages.length),null!=e.control){const t=e.control.ihave?.length??0,s=e.control.iwant?.length??0,r=e.control.graft?.length??0,n=e.control.prune?.length??0,i=e.control.idontwant?.length??0;t>0&&this.rpcSentIHave.inc(t),s>0&&this.rpcSentIWant.inc(s),r>0&&this.rpcSentGraft.inc(r),n>0&&this.rpcSentPrune.inc(n),i>0&&this.rpcSentIDontWant.inc(i),(t>0||s>0||r>0||n>0||i>0)&&this.rpcSentControl.inc(1)}},registerScores(e,t){let s=0,r=0,n=0,i=0;for(const o of e)o>=t.graylistThreshold&&s++,o>=t.publishThreshold&&r++,o>=t.gossipThreshold&&n++,o>=0&&i++;this.peersByScoreThreshold.set({threshold:vT.graylist},s),this.peersByScoreThreshold.set({threshold:vT.publish},r),this.peersByScoreThreshold.set({threshold:vT.gossip},n),this.peersByScoreThreshold.set({threshold:vT.mesh},i),this.score.set(e)},registerScoreWeights(e){for(const[t,s]of e.byTopic)this.scoreWeights.set({topic:t,p:"p1"},s.p1w),this.scoreWeights.set({topic:t,p:"p2"},s.p2w),this.scoreWeights.set({topic:t,p:"p3"},s.p3w),this.scoreWeights.set({topic:t,p:"p3b"},s.p3bw),this.scoreWeights.set({topic:t,p:"p4"},s.p4w);this.scoreWeights.set({p:"p5"},e.p5w),this.scoreWeights.set({p:"p6"},e.p6w),this.scoreWeights.set({p:"p7"},e.p7w)},registerScorePerMesh(e,t){const s=new Map;e.forEach((e,t)=>{const r=this.topicStrToLabel.get(t)??"unknown";let n=s.get(r);null==n&&(n=new Set,s.set(r,n)),e.forEach(e=>n?.add(e))});for(const[e,r]of s){const s=[];r.forEach(e=>{s.push(t.get(e)??0)}),this.scorePerMesh.set({topic:e},s)}}}}(t.metricsRegister,t.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:s.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:e/1e3});r.mcacheSize.addCollect(()=>{this.onScrapeMetrics(r)});for(const e of this.protocols)r.protocolsEnabled.set({protocol:e},1);this.metrics=r}else this.metrics=null;this.gossipTracer=new qT(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new BT(this.opts.scoreParams,this.metrics,this.components.logger,{scoreCacheValidityMs:s.heartbeatInterval}),this.maxInboundStreams=t.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams,this.runOnLimitedConnection=t.runOnLimitedConnection,this.allowedTopics=null!=s.allowedTopics?new Set(s.allowedTopics):null}[Symbol.toStringTag]="@chainsafe/libp2p-gossipsub";[Y_]=["@libp2p/pubsub"];[J_]=["@libp2p/identify"];getPeers(){return[...this.peers.values()]}isStarted(){return this.status.code===ZT.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=function(e,t,s){switch(e){case tI:return{type:uT.Signing,author:t,key:Ho(s.publicKey),privateKey:s};case sI:return{type:uT.Anonymous};default:throw new Error(`Unknown signature policy "${e}"`)}}(this.globalSignaturePolicy,this.components.peerId,this.components.privateKey),this.outboundInflightQueue=Xl({objectMode:!0}),qm(this.outboundInflightQueue,async e=>{for await(const{peerId:t,connection:s}of e)await this.createOutboundStream(t,s)}).catch(e=>{this.log.error("outbound inflight queue error",e)}),await Promise.all(this.opts.directPeers.map(async e=>{await this.components.peerStore.merge(e.id,{multiaddrs:e.addrs})}));const e=this.components.registrar;await Promise.all(this.protocols.map(async t=>e.handle(t,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection})));const t={onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this),notifyOnLimitedConnection:this.runOnLimitedConnection},s=await Promise.all(this.protocols.map(async s=>e.register(s,t))),r=setTimeout(this.runHeartbeat,100);this.status={code:ZT.started,registrarTopologyIds:s,heartbeatTimeout:r,hearbeatStartMs:Date.now()+100},this.score.start(),this.directPeerInitial=setTimeout(()=>{Promise.resolve().then(async()=>{await Promise.all(Array.from(this.direct).map(async e=>this.connect(e)))}).catch(e=>{this.log(e)})},1e3),this.opts.tagMeshPeers&&(this.addEventListener("gossipsub:graft",this.tagMeshPeer),this.addEventListener("gossipsub:prune",this.untagMeshPeer)),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==ZT.started)return;const{registrarTopologyIds:e}=this.status;this.status={code:ZT.stopped},this.opts.tagMeshPeers&&(this.removeEventListener("gossipsub:graft",this.tagMeshPeer),this.removeEventListener("gossipsub:prune",this.untagMeshPeer));const t=this.components.registrar;await Promise.all(this.protocols.map(async e=>t.unhandle(e))),e.forEach(e=>{t.unregister(e)}),this.outboundInflightQueue.end();const s=[];for(const e of this.streamsOutbound.values())s.push(e.close());this.streamsOutbound.clear();for(const e of this.streamsInbound.values())s.push(e.close());this.streamsInbound.clear(),await Promise.all(s),this.peers.clear(),this.subscriptions.clear(),null!=this.heartbeatTimer&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),null!=this.fastMsgIdCache&&this.fastMsgIdCache.clear(),null!=this.directPeerInitial&&clearTimeout(this.directPeerInitial),this.idontwantCounts.clear(),this.idontwants.clear(),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream(e,t){if(!this.isStarted())return;const s=t.remotePeer;this.addPeer(s,t.direction,t.remoteAddr),this.createInboundStream(s,e),this.outboundInflightQueue.push({peerId:s,connection:t})}onPeerConnected(e,t){this.metrics?.newConnectionCount.inc({status:t.status}),this.isStarted()&&"open"===t.status&&(this.addPeer(e,t.direction,t.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:t}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,t){if(!this.isStarted())return;const s=e.toString();if(this.peers.has(s)&&!this.streamsOutbound.has(s))try{const r=new zT(await t.newStream(this.protocols,{runOnLimitedConnection:this.runOnLimitedConnection}),e=>{this.log.error("outbound pipe error",e)},{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(s,r);const n=r.protocol;n===q_&&this.floodsubPeers.add(s),this.metrics?.peersPerProtocol.inc({protocol:n},1),this.subscriptions.size>0&&(this.log("send subscriptions to",s),this.sendSubscriptions(s,Array.from(this.subscriptions),!0))}catch(e){this.log.error("createOutboundStream error",e)}}createInboundStream(e,t){if(!this.isStarted())return;const s=e.toString();if(!this.peers.has(s))return;const r=this.streamsInbound.get(s);void 0!==r&&(this.log("replacing existing inbound steam %s",s),r.close().catch(e=>{this.log.error(e)})),this.log("create inbound stream %s",s);const n=new $T(t,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(s,n),this.pipePeerReadStream(e,n.source).catch(e=>{this.log(e)})}addPeer(e,t,s){const r=e.toString();if(!this.peers.has(r)){this.peers.set(r,e),this.score.addPeer(r);const n=YT(s);null!==n?this.score.addIP(r,n):this.log("Added peer has no IP in current address %s %s",r,s.toString()),this.outbound.has(r)||this.outbound.set(r,"outbound"===t)}}removePeer(e){const t=e.toString();if(!this.peers.has(t))return;this.log("delete peer %p",e),this.peers.delete(t);const s=this.streamsOutbound.get(t),r=this.streamsInbound.get(t);null!=s&&this.metrics?.peersPerProtocol.inc({protocol:s.protocol},-1),s?.close().catch(e=>{this.log.error(e)}),r?.close().catch(e=>{this.log.error(e)}),this.streamsOutbound.delete(t),this.streamsInbound.delete(t);for(const e of this.topics.values())e.delete(t);for(const[e,s]of this.mesh)s.delete(t)&&this.metrics?.onRemoveFromMesh(e,yT.Dc,1);for(const e of this.fanout.values())e.delete(t);this.floodsubPeers.delete(t),this.gossip.delete(t),this.control.delete(t),this.outbound.delete(t),this.idontwantCounts.delete(t),this.idontwants.delete(t),this.score.removePeer(t),this.acceptFromWhitelist.delete(t)}get started(){return this.status.code===ZT.started}getMeshPeers(e){const t=this.mesh.get(e);return null!=t?Array.from(t):[]}getSubscribers(e){const t=this.topics.get(e);return(null!=t?Array.from(t):[]).map(e=>this.peers.get(e)??oT(e))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,t){try{await qm(t,async t=>{for await(const s of t)try{const t=s.subarray(),r=lT.decode(t,{limits:{subscriptions:this.decodeRpcLimits.maxSubscriptions,messages:this.decodeRpcLimits.maxMessages,control$:{ihave:this.decodeRpcLimits.maxIhaveMessageIDs,iwant:this.decodeRpcLimits.maxIwantMessageIDs,graft:this.decodeRpcLimits.maxControlMessages,prune:this.decodeRpcLimits.maxControlMessages,prune$:{peers:this.decodeRpcLimits.maxPeerInfos},idontwant:this.decodeRpcLimits.maxControlMessages,idontwant$:{messageIDs:this.decodeRpcLimits.maxIdontwantMessageIDs}}}});if(this.metrics?.onRpcRecv(r,t.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(e,r)}catch(e){this.metrics?.onRpcRecvError(),this.log(e)}else this.handleReceivedRpc(e,r).catch(e=>{this.metrics?.onRpcRecvError(),this.log(e)})}catch(e){this.metrics?.onRpcDataError(),this.log(e)}})}catch(t){this.metrics?.onPeerReadStreamError(),this.handlePeerReadStreamError(t,e)}}handlePeerReadStreamError(e,t){this.log.error(e),this.onPeerDisconnected(t)}async handleReceivedRpc(e,t){if(!this.acceptFrom(e.toString()))return this.log("received message from unacceptable peer %p",e),void this.metrics?.rpcRecvNotAccepted.inc();const s=null!=t.subscriptions?t.subscriptions.length:0,r=null!=t.messages?t.messages.length:0;let n=0,i=0,o=0,a=0;if(null!=t.control&&(null!=t.control.ihave&&(n=t.control.ihave.length),null!=t.control.iwant&&(i=t.control.iwant.length),null!=t.control.graft&&(o=t.control.graft.length),null!=t.control.prune&&(a=t.control.prune.length)),this.log(`rpc.from ${e.toString()} subscriptions ${s} messages ${r} ihave ${n} iwant ${i} graft ${o} prune ${a}`),null!=t.subscriptions&&t.subscriptions.length>0){const s=[];t.subscriptions.forEach(t=>{const r=t.topic,n=!0===t.subscribe;if(null!=r){if(null!=this.allowedTopics&&!this.allowedTopics.has(r))return;this.handleReceivedSubscription(e,r,n),s.push({topic:r,subscribe:n})}}),this.safeDispatchEvent("subscription-change",{detail:{peerId:e,subscriptions:s}})}for(const s of t.messages){if(null!=this.allowedTopics&&!this.allowedTopics.has(s.topic))continue;const t=this.handleReceivedMessage(e,s).catch(e=>{this.metrics?.onMsgRecvError(s.topic),this.log(e)});this.opts.awaitRpcMessageHandler&&await t}null!=t.control&&await this.handleControlMessage(e.toString(),t.control)}handleReceivedSubscription(e,t,s){this.log("subscription update from %p topic %s",e,t);let r=this.topics.get(t);null==r&&(r=new Set,this.topics.set(t,r)),s?r.add(e.toString()):r.delete(e.toString())}async handleReceivedMessage(e,t){this.metrics?.onMsgRecvPreValidation(t.topic);const s=await this.validateReceivedMessage(e,t);this.metrics?.onPrevalidationResult(t.topic,s.code);const r=s.code;switch(r){case fT.duplicate:return this.score.duplicateMessage(e.toString(),s.msgIdStr,t.topic),this.gossipTracer.deliverMessage(s.msgIdStr,!0),void this.mcache.observeDuplicate(s.msgIdStr,e.toString());case fT.invalid:if(null!=s.msgIdStr){const r=s.msgIdStr;this.score.rejectMessage(e.toString(),r,t.topic,s.reason),this.gossipTracer.rejectMessage(r,s.reason)}else this.score.rejectInvalidMessage(e.toString(),t.topic);return void this.metrics?.onMsgRecvInvalid(t.topic,s);case fT.valid:if(this.score.validateMessage(s.messageId.msgIdStr),this.gossipTracer.deliverMessage(s.messageId.msgIdStr),this.mcache.put(s.messageId,t,!this.opts.asyncValidation),this.subscriptions.has(t.topic)){this.components.peerId.equals(e)&&!this.opts.emitSelf||(super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:e,msgId:s.messageId.msgIdStr,msg:s.msg}})),super.dispatchEvent(new CustomEvent("message",{detail:s.msg})))}this.opts.asyncValidation||this.forwardMessage(s.messageId.msgIdStr,t,e.toString());break;default:throw new Error(`Invalid validation result: ${r}`)}}async validateReceivedMessage(e,t){const s=this.fastMsgIdFn?.(t),r=void 0!==s?this.fastMsgIdCache?.get(s):void 0;if(null!=r)return{code:fT.duplicate,msgIdStr:r};const n=await async function(e,t){switch(e){case sI:return null!=t.signature?{valid:!1,error:pT.SignaturePresent}:null!=t.seqno?{valid:!1,error:pT.SeqnoPresent}:null!=t.key?{valid:!1,error:pT.FromPresent}:{valid:!0,message:{type:"unsigned",topic:t.topic,data:t.data??new Uint8Array(0)}};case tI:{if(null==t.seqno)return{valid:!1,error:pT.InvalidSeqno};if(8!==t.seqno.length)return{valid:!1,error:pT.InvalidSeqno};if(null==t.signature)return{valid:!1,error:pT.InvalidSignature};if(null==t.from)return{valid:!1,error:pT.InvalidPeerId};let e,s;try{e=aT(Pe(t.from))}catch(e){return{valid:!1,error:pT.InvalidPeerId}}if(null!=t.key){if(s=Ko(t.key),void 0!==e.publicKey&&!s.equals(e.publicKey))return{valid:!1,error:pT.InvalidPeerId}}else{if(null==e.publicKey)return{valid:!1,error:pT.InvalidPeerId};s=e.publicKey}const r={from:t.from,data:t.data,seqno:t.seqno,topic:t.topic,signature:void 0,key:void 0},n=u([WT,lT.Message.encode(r)]);return await s.verify(n,t.signature)?{valid:!0,message:{type:"signed",from:e,data:t.data??new Uint8Array(0),sequenceNumber:BigInt(`0x${Qe(t.seqno,"base16")}`),topic:t.topic,signature:t.signature,key:null!=t.key?Ko(t.key):s}}:{valid:!1,error:pT.InvalidSignature}}default:throw new Error("Unreachable")}}(this.globalSignaturePolicy,t);if(!n.valid)return{code:fT.invalid,reason:dT.Error,error:n.error};const i=n.message;try{null!=this.dataTransform&&(i.data=this.dataTransform.inboundTransform(t.topic,i.data))}catch(e){return this.log("Invalid message, transform failed",e),{code:fT.invalid,reason:dT.Error,error:pT.TransformFailed}}const o=await this.msgIdFn(i),a=this.msgIdToStrFn(o),c={msgId:o,msgIdStr:a};if(void 0!==s&&null!=this.fastMsgIdCache){this.fastMsgIdCache.put(s,a)&&this.metrics?.fastMsgIdCacheCollision.inc()}if(this.seenCache.has(a))return{code:fT.duplicate,msgIdStr:a};this.seenCache.put(a),(t.data?.length??0)>=this.opts.idontwantMinDataSize&&this.sendIDontWants(o,t.topic,e.toString());const l=this.topicValidators.get(t.topic);if(null!=l){let t;try{t=await l(e,i)}catch(e){const s=e.code;"ERR_TOPIC_VALIDATOR_IGNORE"===s&&(t=rI.Ignore),t="ERR_TOPIC_VALIDATOR_REJECT"===s?rI.Reject:rI.Ignore}if(t!==rI.Accept)return{code:fT.invalid,reason:ET(t),msgIdStr:a}}return{code:fT.valid,messageId:c,msg:i}}getScore(e){return this.score.score(e)}sendSubscriptions(e,t,s){this.sendRpc(e,{subscriptions:t.map(e=>({topic:e,subscribe:s})),messages:[]})}async handleControlMessage(e,t){if(void 0===t)return;const s=t.ihave?.length>0?this.handleIHave(e,t.ihave):[],r=t.iwant?.length>0?this.handleIWant(e,t.iwant):[],n=t.graft?.length>0?await this.handleGraft(e,t.graft):[];if(t.prune?.length>0&&await this.handlePrune(e,t.prune),t.idontwant?.length>0&&this.handleIdontwant(e,t.idontwant),0===s.length&&0===r.length&&0===n.length)return;const i=this.sendRpc(e,KT(r,{iwant:s,prune:n})),o=s[0]?.messageIDs;null!=o&&(i?this.gossipTracer.addPromise(e,o):this.metrics?.iwantPromiseUntracked.inc(1))}acceptFrom(e){if(this.direct.has(e))return!0;const t=Date.now(),s=this.acceptFromWhitelist.get(e);if(null!=s&&s.messagesAccepted<128&&s.acceptUntil>=t)return s.messagesAccepted+=1,!0;const r=this.score.score(e);return r>=0?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:t+1e3}):this.acceptFromWhitelist.delete(e),r>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,t){if(0===t.length)return[];const s=this.score.score(e);if(s<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,s),this.metrics?.ihaveRcvIgnored.inc({reason:wT.LowScore}),[];const r=(this.peerhave.get(e)??0)+1;if(this.peerhave.set(e,r),r>10)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,r),this.metrics?.ihaveRcvIgnored.inc({reason:wT.MaxIhave}),[];const n=this.iasked.get(e)??0;if(n>=j_)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,n),this.metrics?.ihaveRcvIgnored.inc({reason:wT.MaxIasked}),[];const i=new Map;if(t.forEach(({topicID:e,messageIDs:t})=>{if(null==e||null==t||!this.mesh.has(e))return;let s=0;t.forEach(e=>{const t=this.msgIdToStrFn(e);this.seenCache.has(t)||(i.set(t,e),s++)}),this.metrics?.onIhaveRcv(e,t.length,s)}),0===i.size)return[];let o=i.size;o+n>j_&&(o=j_-n),this.log("IHAVE: Asking for %d out of %d messages from %s",o,i.size,e);let a=Array.from(i.values());return HT(a),a=a.slice(0,o),this.iasked.set(e,n+o),[{messageIDs:a}]}handleIWant(e,t){if(0===t.length)return[];const s=this.score.score(e);if(s<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,s),[];const r=new Map,n=new Map;let i=0;return t.forEach(({messageIDs:t})=>{t?.forEach(t=>{const s=this.msgIdToStrFn(t),o=this.mcache.getWithIWantCount(s,e);null!=o?(n.set(o.msg.topic,1+(n.get(o.msg.topic)??0)),o.count>3?this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,t):r.set(s,o.msg)):i++})}),this.metrics?.onIwantRcv(n,i),0===r.size?(this.log("IWANT: Could not provide any wanted messages to %s",e),[]):(this.log("IWANT: Sending %d messages to %s",r.size,e),Array.from(r.values()))}async handleGraft(e,t){const s=[],r=this.score.score(e),n=Date.now();let i=this.opts.doPX;if(t.forEach(({topicID:t})=>{if(null==t)return;const o=this.mesh.get(t);if(null==o)return void(i=!1);if(o.has(e))return;const a=this.backoff.get(t)?.get(e);if(this.direct.has(e))this.log("GRAFT: ignoring request from direct peer %s",e),s.push(t),i=!1;else if("number"==typeof a&&n<a){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,bT.GraftBackoff),i=!1;const r=a+this.opts.graftFloodThreshold-this.opts.pruneBackoff;n<r&&this.score.addPenalty(e,1,bT.GraftBackoff),this.addBackoff(e,t),s.push(t)}else r<0?(this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,r,t),s.push(t),i=!1,this.addBackoff(e,t)):o.size>=this.opts.Dhi&&!this.outbound.get(e)?(s.push(t),this.addBackoff(e,t)):(this.log("GRAFT: Add mesh link from %s in %s",e,t),this.score.graft(e,t),o.add(e),this.metrics?.onAddToMesh(t,mT.Subscribed,1));this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:e,topic:t,direction:"inbound"}})}),0===s.length)return[];return Promise.all(s.map(async t=>this.makePrune(e,t,i,false)))}async handlePrune(e,t){const s=this.score.score(e);for(const{topicID:r,backoff:n,peers:i}of t){if(null==r)continue;const t=this.mesh.get(r);if(null==t)return;this.log("PRUNE: Remove mesh link to %s in %s",e,r),this.score.prune(e,r),t.has(e)&&(t.delete(e),this.metrics?.onRemoveFromMesh(r,yT.Prune,1)),"number"==typeof n&&n>0?this.doAddBackoff(e,r,1e3*n):this.addBackoff(e,r),null!=i&&i.length>0&&(s<this.opts.scoreThresholds.acceptPXThreshold?this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,s,r):await this.pxConnect(i)),this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:e,topic:r,direction:"inbound"}})}}handleIdontwant(e,t){let s=this.idontwantCounts.get(e)??0;if(s>=this.opts.idontwantMaxMessages)return;const r=s;let n=this.idontwants.get(e);null==n&&(n=new Map,this.idontwants.set(e,n));let i=0;e:for(const{messageIDs:e}of t)for(const t of e){if(s>=this.opts.idontwantMaxMessages)break e;s++;const e=this.msgIdToStrFn(t);n.set(e,this.heartbeatTicks),this.mcache.msgs.has(e)||i++}this.idontwantCounts.set(e,s);const o=s-r;this.metrics?.onIdontwantRcv(o,i)}addBackoff(e,t){this.doAddBackoff(e,t,this.opts.pruneBackoff)}doAddBackoff(e,t,s){let r=this.backoff.get(t);null==r&&(r=new Map,this.backoff.set(t,r));const n=Date.now()+s;(r.get(e)??0)<n&&r.set(e,n)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach((e,t)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",t,e),this.score.addPenalty(t,e,bT.BrokenPromise)})}clearBackoff(){if(this.heartbeatTicks%15!=0)return;const e=Date.now();this.backoff.forEach((t,s)=>{t.forEach((s,r)=>{s+1*this.opts.heartbeatInterval<e&&t.delete(r)}),0===t.size&&this.backoff.delete(s)})}async directConnect(){const e=[];this.direct.forEach(t=>{this.streamsOutbound.has(t)||e.push(t)}),await Promise.all(e.map(async e=>this.connect(e)))}async pxConnect(e){e.length>this.opts.prunePeers&&(HT(e),e=e.slice(0,this.opts.prunePeers));const t=[];await Promise.all(e.map(async e=>{if(null==e.peerID)return;const s=aT(Pe(e.peerID)),r=s.toString();if(!this.peers.has(r))if(null!=e.signedPeerRecord)try{if(!await this.components.peerStore.consumePeerRecord(e.signedPeerRecord,{expectedPeer:s}))return void this.log("bogus peer record obtained through px: could not add peer record to address book");t.push(r)}catch(e){this.log("bogus peer record obtained through px: invalid signature or not a peer record")}else t.push(r)})),0!==t.length&&await Promise.all(t.map(async e=>this.connect(e)))}async connect(e){this.log("Initiating connection with %s",e);const t=oT(e),s=await this.components.connectionManager.openConnection(t);for(const e of this.protocols)for(const r of this.components.registrar.getTopologies(e))r.onConnect?.(t,s)}subscribe(e){if(this.status.code!==ZT.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(const t of this.peers.keys())this.sendSubscriptions(t,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==ZT.started)throw new Error("Pubsub is not started");const t=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,t),t)for(const t of this.peers.keys())this.sendSubscriptions(t,[e],!1);this.leave(e)}join(e){if(this.status.code!==ZT.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),this.metrics?.onJoin(e);const t=new Set,s=this.backoff.get(e),r=this.fanout.get(e);if(null!=r&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),r.forEach(e=>{!this.direct.has(e)&&this.score.score(e)>=0&&!0!==s?.has(e)&&t.add(e)}),this.metrics?.onAddToMesh(e,mT.Fanout,t.size)),t.size<this.opts.D){const r=t.size,n=this.getRandomGossipPeers(e,this.opts.D,e=>!t.has(e)&&!this.direct.has(e)&&this.score.score(e)>=0&&!0!==s?.has(e));n.forEach(e=>{t.add(e)}),this.metrics?.onAddToMesh(e,mT.Random,t.size-r)}this.mesh.set(e,t),t.forEach(t=>{this.log("JOIN: Add mesh link to %s in %s",t,e),this.sendGraft(t,e)})}leave(e){if(this.status.code!==ZT.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),this.metrics?.onLeave(e);const t=this.mesh.get(e);null!=t&&(Promise.all(Array.from(t).map(async t=>{this.log("LEAVE: Remove mesh link to %s in %s",t,e),await this.sendPrune(t,e)})).catch(e=>{this.log("Error sending prunes to mesh peers",e)}),this.mesh.delete(e))}selectPeersToForward(e,t,s){const r=new Set,n=this.topics.get(e);null!=n&&(this.direct.forEach(e=>{n.has(e)&&t!==e&&!s?.has(e)&&r.add(e)}),this.floodsubPeers.forEach(e=>{n.has(e)&&t!==e&&!s?.has(e)&&this.score.score(e)>=this.opts.scoreThresholds.publishThreshold&&r.add(e)}));const i=this.mesh.get(e);return null!=i&&i.size>0&&i.forEach(e=>{t===e||s?.has(e)||r.add(e)}),r}selectPeersToPublish(e){const t=new Set,s={direct:0,floodsub:0,mesh:0,fanout:0},r=this.topics.get(e);if(null!=r)if(this.opts.floodPublish)r.forEach(e=>{this.direct.has(e)?(t.add(e),s.direct++):this.score.score(e)>=this.opts.scoreThresholds.publishThreshold&&(t.add(e),s.floodsub++)});else{this.direct.forEach(e=>{r.has(e)&&(t.add(e),s.direct++)}),this.floodsubPeers.forEach(e=>{r.has(e)&&this.score.score(e)>=this.opts.scoreThresholds.publishThreshold&&(t.add(e),s.floodsub++)});const n=this.mesh.get(e);if(null!=n&&n.size>0){if(n.forEach(e=>{t.add(e),s.mesh++}),n.size<this.opts.D){const r=this.getRandomGossipPeers(e,this.opts.D-n.size,e=>!n.has(e)&&!this.direct.has(e)&&!this.floodsubPeers.has(e)&&this.score.score(e)>=this.opts.scoreThresholds.publishThreshold);r.forEach(e=>{t.add(e),s.mesh++})}}else{const r=this.fanout.get(e);if(null!=r&&r.size>0)r.forEach(e=>{t.add(e),s.fanout++});else{const r=this.getRandomGossipPeers(e,this.opts.D,e=>this.score.score(e)>=this.opts.scoreThresholds.publishThreshold);r.size>0&&(this.fanout.set(e,r),r.forEach(e=>{t.add(e),s.fanout++}))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:t,tosendCount:s}}forwardMessage(e,t,s,r){null!=s&&this.score.deliverMessage(s,e,t.topic);const n=this.selectPeersToForward(t.topic,s,r);n.forEach(e=>{this.sendRpc(e,KT([t]))}),this.metrics?.onForwardMsg(t.topic,n.size)}async publish(e,t,s){const r=Date.now(),n=null!=this.dataTransform?this.dataTransform.outboundTransform(e,t):t;if(null==this.publishConfig)throw Error("PublishError.Uninitialized");const{raw:i,msg:o}=await async function(e,t,s,r){switch(e.type){case uT.Signing:{const n={from:e.author.toMultihash().bytes,data:r,seqno:go(8),topic:t,signature:void 0,key:void 0},i=u([WT,lT.Message.encode(n)]);return n.signature=await e.privateKey.sign(i),n.key=e.key,{raw:n,msg:{type:"signed",from:e.author,data:s,sequenceNumber:BigInt(`0x${Qe(n.seqno??new Uint8Array(0),"base16")}`),topic:t,signature:n.signature,key:Ko(n.key)}}}case uT.Anonymous:return{raw:{from:void 0,data:r,seqno:void 0,topic:t,signature:void 0,key:void 0},msg:{type:"unsigned",data:s,topic:t}};default:throw new Error("Unreachable")}}(this.publishConfig,e,t,n),a=await this.msgIdFn(o),c=this.msgIdToStrFn(a),l=s?.ignoreDuplicatePublishError??this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(c)){if(l)return this.metrics?.onPublishDuplicateMsg(e),{recipients:[]};throw Error("PublishError.Duplicate")}const{tosend:h,tosendCount:d}=this.selectPeersToPublish(e),p=this.opts.emitSelf&&this.subscriptions.has(e),f=s?.allowPublishToZeroTopicPeers??this.opts.allowPublishToZeroTopicPeers;if(0===h.size&&!f&&!p)throw Error("PublishError.NoPeersSubscribedToTopic");this.seenCache.put(c),this.mcache.put({msgId:a,msgIdStr:c},i,!0),this.gossipTracer.deliverMessage(c),this.publishedMessageIds.put(c);const g=s?.batchPublish??this.opts.batchPublish,m=KT([i]);if(g)this.sendRpcInBatch(h,m);else for(const e of h){this.sendRpc(e,m)||h.delete(e)}const y=Date.now()-r;return this.metrics?.onPublishMsg(e,d,h.size,null!=i.data?i.data.length:0,y),p&&(h.add(this.components.peerId.toString()),super.dispatchEvent(new CustomEvent("gossipsub:message",{detail:{propagationSource:this.components.peerId,msgId:c,msg:o}})),super.dispatchEvent(new CustomEvent("message",{detail:o}))),{recipients:Array.from(h.values()).map(e=>this.peers.get(e)??oT(e))}}sendRpcInBatch(e,t){const s=lT.encode(t),r=wf.single(s);for(const n of e){const i=this.streamsOutbound.get(n);if(null!=i){try{i.pushPrefixed(r)}catch(t){e.delete(n),this.log.error(`Cannot send rpc to ${n}`,t)}this.metrics?.onRpcSent(t,s.length)}else this.log(`Cannot send RPC to ${n} as there is no open stream to it available`),e.delete(n)}}reportMessageValidationResult(e,t,s){let r;if(s===rI.Accept){if(r=this.mcache.validate(e),null!=r){const{message:s,originatingPeers:n}=r;this.score.deliverMessage(t,e,s.topic),this.forwardMessage(e,r.message,t,n)}}else if(r=this.mcache.remove(e),null!=r){const n=ET(s),{message:i,originatingPeers:o}=r;this.score.rejectMessage(t,e,i.topic,n);for(const t of o)this.score.rejectMessage(t,e,i.topic,n)}const n=this.score.messageFirstSeenTimestampMs(e);this.metrics?.onReportValidation(r,s,n)}sendGraft(e,t){const s=KT([],{graft:[{topicID:t}]});this.sendRpc(e,s)}async sendPrune(e,t){const s=KT([],{prune:[await this.makePrune(e,t,this.opts.doPX,!0)]});this.sendRpc(e,s)}sendIDontWants(e,t,s){const r=this.mesh.get(t);if(null==r)return;const n=new Set(r);n.delete(s);for(const e of n)this.streamsOutbound.get(e)?.protocol!==K_&&n.delete(e);const i=KT([],{idontwant:[{messageIDs:[e]}]});this.sendRpcInBatch(n,i)}sendRpc(e,t){const s=this.streamsOutbound.get(e);if(null==s)return this.log(`Cannot send RPC to ${e} as there is no open stream to it available`),!1;const r=this.control.get(e);null!=r&&(this.piggybackControl(e,t,r),this.control.delete(e));const n=this.gossip.get(e);null!=n&&(this.piggybackGossip(e,t,n),this.gossip.delete(e));const i=lT.encode(t);try{s.push(i)}catch(t){return this.log.error(`Cannot send rpc to ${e}`,t),null!=r&&this.control.set(e,r),null!=n&&this.gossip.set(e,n),!1}if(this.metrics?.onRpcSent(t,i.length),null!=t.control?.graft)for(const s of t.control?.graft)null!=s.topicID&&this.safeDispatchEvent("gossipsub:graft",{detail:{peerId:e,topic:s.topicID,direction:"outbound"}});if(null!=t.control?.prune)for(const s of t.control?.prune)null!=s.topicID&&this.safeDispatchEvent("gossipsub:prune",{detail:{peerId:e,topic:s.topicID,direction:"outbound"}});return!0}piggybackControl(e,t,s){const r=jT(t);for(const t of s.graft)null!=t.topicID&&this.mesh.get(t.topicID)?.has(e)&&r.control.graft.push(t);for(const t of s.prune)null==t.topicID||this.mesh.get(t.topicID)?.has(e)||r.control.prune.push(t)}piggybackGossip(e,t,s){jT(t).control.ihave=s}async sendGraftPrune(e,t,s){const r=this.opts.doPX,n=!1;for(const[i,o]of e){const e=o.map(e=>({topicID:e}));let a=[];const c=t.get(i);null!=c&&(a=await Promise.all(c.map(async e=>this.makePrune(i,e,r&&!s.get(i),n))),t.delete(i)),this.sendRpc(i,KT([],{graft:e,prune:a}))}for(const[e,i]of t){const t=await Promise.all(i.map(async t=>this.makePrune(e,t,r&&!s.get(e),n)));this.sendRpc(e,KT([],{prune:t}))}}emitGossip(e){const t=this.mcache.getGossipIDs(new Set(e.keys()));for(const[s,r]of e)this.doEmitGossip(s,r,t.get(s)??[])}doEmitGossip(e,t,s){if(0===s.length)return;if(HT(s),s.length>j_&&this.log("too many messages for gossip; will truncate IHAVE list (%d messages)",s.length),0===t.size)return;let r=this.opts.Dlazy;const n=this.opts.gossipFactor*t.size;let i=t;n>r&&(r=n),r>i.size?r=i.size:i=HT(Array.from(i)).slice(0,r),i.forEach(t=>{let r=s;s.length>j_&&(r=HT(r.slice()).slice(0,j_)),this.pushGossip(t,{topicID:e,messageIDs:r})})}flush(){for(const[e,t]of this.gossip.entries())this.gossip.delete(e),this.sendRpc(e,KT([],{ihave:t}));for(const[e,t]of this.control.entries()){this.control.delete(e);const s=KT([],{graft:t.graft,prune:t.prune});this.sendRpc(e,s)}}pushGossip(e,t){this.log("Add gossip to %s",e);const s=this.gossip.get(e)??[];this.gossip.set(e,s.concat(t))}async makePrune(e,t,s,r){if(this.score.prune(e,t),this.streamsOutbound.get(e)?.protocol===W_)return{topicID:t,peers:[]};const n=r?this.opts.unsubcribeBackoff:this.opts.pruneBackoff,i=n/1e3;if(this.doAddBackoff(e,t,n),!s)return{topicID:t,peers:[],backoff:i};const o=this.getRandomGossipPeers(t,this.opts.prunePeers,t=>t!==e&&this.score.score(t)>=0),a=await Promise.all(Array.from(o).map(async e=>{const t=this.peers.get(e)??oT(e);let s;try{s=await this.components.peerStore.get(t)}catch(e){if("NotFoundError"!==e.name)throw e}return{peerID:t.toMultihash().bytes,signedPeerRecord:s?.peerRecordEnvelope}}));return{topicID:t,peers:a,backoff:i}}runHeartbeat=()=>{const e=this.metrics?.heartbeatDuration.startTimer();this.heartbeat().catch(e=>{this.log("Error running heartbeat",e)}).finally(()=>{if(null!=e&&e(),this.status.code===ZT.started){clearTimeout(this.status.heartbeatTimeout);let e=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;e<.25*this.opts.heartbeatInterval&&(e+=this.opts.heartbeatInterval,this.metrics?.heartbeatSkipped.inc()),this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,e)}})};async heartbeat(){const{D:e,Dlo:t,Dhi:s,Dscore:r,Dout:n,fanoutTTL:i}=this.opts;this.heartbeatTicks++;const o=new Map,a=e=>{let t=o.get(e);return void 0===t&&(t=this.score.score(e),o.set(e,t)),t},c=new Map,l=new Map,h=new Map;this.clearBackoff(),this.peerhave.clear(),this.metrics?.cacheSize.set({cache:"iasked"},this.iasked.size),this.iasked.clear(),this.applyIwantPenalties(),this.idontwantCounts.clear();for(const e of this.idontwants.values())for(const[t,s]of e)this.heartbeatTicks-s>=this.opts.mcacheLength&&e.delete(t);this.heartbeatTicks%this.opts.directConnectTicks===0&&await this.directConnect(),this.fastMsgIdCache?.prune(),this.seenCache.prune(),this.gossipTracer.prune(),this.publishedMessageIds.prune();const u=new Map;this.mesh.forEach((i,o)=>{const d=this.topics.get(o),p=new Set,f=new Set;if(u.set(o,f),null!=d){const e=HT(Array.from(d)),t=this.backoff.get(o);for(const s of e){const e=this.streamsOutbound.get(s);if(null!=e&&this.protocols.includes(e.protocol)&&!i.has(s)&&!this.direct.has(s)){const e=a(s);!0!==t?.has(s)&&e>=0&&p.add(s),e>=this.opts.scoreThresholds.gossipThreshold&&f.add(s)}}}const g=(e,t)=>{this.log("HEARTBEAT: Remove mesh link to %s in %s",e,o),this.addBackoff(e,o),i.delete(e),a(e)>=this.opts.scoreThresholds.gossipThreshold&&f.add(e),this.metrics?.onRemoveFromMesh(o,t,1);const s=l.get(e);null==s?l.set(e,[o]):s.push(o)},m=(e,t)=>{this.log("HEARTBEAT: Add mesh link to %s in %s",e,o),this.score.graft(e,o),i.add(e),f.delete(e),this.metrics?.onAddToMesh(o,t,1);const s=c.get(e);null==s?c.set(e,[o]):s.push(o)};if(i.forEach(e=>{const t=a(e);t<0&&(this.log("HEARTBEAT: Prune peer %s with negative score: score=%d, topic=%s",e,t,o),g(e,yT.BadScore),h.set(e,!0))}),i.size<t){const t=function(e,t){return AT(e,t,()=>!0)}(p,e-i.size);t.forEach(e=>{m(e,mT.NotEnough)})}if(i.size>s){let t=Array.from(i);t.sort((e,t)=>a(t)-a(e)),t=t.slice(0,r).concat(HT(t.slice(r)));let s=0;if(t.slice(0,e).forEach(e=>{this.outbound.get(e)&&s++}),s<n){const r=e=>{const s=t[e];for(let s=e;s>0;s--)t[s]=t[s-1];t[0]=s};if(s>0){let n=s;for(let s=1;s<e&&n>0;s++)this.outbound.get(t[s])&&(r(s),n--)}let n=e-s;for(let s=e;s<t.length&&n>0;s++)this.outbound.get(t[s])&&(r(s),n--)}t.slice(e).forEach(e=>{g(e,yT.Excess)})}if(i.size>=t){let e=0;if(i.forEach(t=>{this.outbound.get(t)&&e++}),e<n){const t=AT(p,n-e,e=>!0===this.outbound.get(e));t.forEach(e=>{m(e,mT.Outbound)})}}if(this.heartbeatTicks%this.opts.opportunisticGraftTicks===0&&i.size>1){const e=Array.from(i).sort((e,t)=>a(e)-a(t)),t=Math.floor(i.size/2),s=a(e[t]);if(s<this.opts.scoreThresholds.opportunisticGraftThreshold){const e=AT(p,this.opts.opportunisticGraftPeers,e=>a(e)>s);for(const t of e)this.log("HEARTBEAT: Opportunistically graft peer %s on topic %s",t,o),m(t,mT.Opportunistic)}}});const d=Date.now();this.fanoutLastpub.forEach((e,t)=>{e+i<d&&(this.fanout.delete(t),this.fanoutLastpub.delete(t))}),this.fanout.forEach((t,s)=>{const r=this.topics.get(s);t.forEach(e=>{(!r?.has(e)||a(e)<this.opts.scoreThresholds.publishThreshold)&&t.delete(e)});const n=this.topics.get(s),i=[],o=new Set;if(u.set(s,o),null!=n){const e=HT(Array.from(n));for(const s of e){const e=this.streamsOutbound.get(s);if(null!=e&&this.protocols.includes(e.protocol)&&!t.has(s)&&!this.direct.has(s)){const e=a(s);e>=this.opts.scoreThresholds.publishThreshold&&i.push(s),e>=this.opts.scoreThresholds.gossipThreshold&&o.add(s)}}}if(t.size<e){const s=e-t.size;i.slice(0,s).forEach(e=>{t.add(e),o?.delete(e)})}}),this.emitGossip(u),await this.sendGraftPrune(c,l,h),this.flush(),this.mcache.shift(),this.dispatchEvent(new CustomEvent("gossipsub:heartbeat"))}getRandomGossipPeers(e,t,s=()=>!0){const r=this.topics.get(e);if(null==r)return new Set;let n=[];return r.forEach(e=>{const t=this.streamsOutbound.get(e);null!=t&&this.protocols.includes(t.protocol)&&s(e)&&n.push(e)}),n=HT(n),t>0&&n.length>t&&(n=n.slice(0,t)),new Set(n)}onScrapeMetrics(e){e.mcacheSize.set(this.mcache.size),e.mcacheNotValidatedCount.set(this.mcache.notValidatedCount),e.cacheSize.set({cache:"direct"},this.direct.size),e.cacheSize.set({cache:"seenCache"},this.seenCache.size),e.cacheSize.set({cache:"fastMsgIdCache"},this.fastMsgIdCache?.size??0),e.cacheSize.set({cache:"publishedMessageIds"},this.publishedMessageIds.size),e.cacheSize.set({cache:"mcache"},this.mcache.size),e.cacheSize.set({cache:"score"},this.score.size),e.cacheSize.set({cache:"gossipTracer.promises"},this.gossipTracer.size),e.cacheSize.set({cache:"gossipTracer.requests"},this.gossipTracer.requestMsByMsgSize),e.cacheSize.set({cache:"topics"},this.topics.size),e.cacheSize.set({cache:"subscriptions"},this.subscriptions.size),e.cacheSize.set({cache:"mesh"},this.mesh.size),e.cacheSize.set({cache:"fanout"},this.fanout.size),e.cacheSize.set({cache:"peers"},this.peers.size),e.cacheSize.set({cache:"streamsOutbound"},this.streamsOutbound.size),e.cacheSize.set({cache:"streamsInbound"},this.streamsInbound.size),e.cacheSize.set({cache:"acceptFromWhitelist"},this.acceptFromWhitelist.size),e.cacheSize.set({cache:"gossip"},this.gossip.size),e.cacheSize.set({cache:"control"},this.control.size),e.cacheSize.set({cache:"peerhave"},this.peerhave.size),e.cacheSize.set({cache:"outbound"},this.outbound.size);let t=0;const s=Date.now();e.connectedPeersBackoffSec.reset();for(const r of this.backoff.values()){t+=r.size;for(const[t,n]of r.entries())this.peers.has(t)&&e.connectedPeersBackoffSec.observe(Math.max(0,n-s)/1e3)}e.cacheSize.set({cache:"backoff"},t);let r=0;for(const e of this.idontwants.values())r+=e.size;e.cacheSize.set({cache:"idontwants"},r);for(const[t,s]of this.topics)e.topicPeersCount.set({topicStr:t},s.size);for(const[t,s]of this.mesh)e.meshPeerCounts.set({topicStr:t},s.size);const n=[],i=new Map;e.behaviourPenalty.reset();for(const t of this.peers.keys()){const s=this.score.score(t);n.push(s),i.set(t,s),e.behaviourPenalty.observe(this.score.peerStats.get(t)?.behaviourPenalty??0)}e.registerScores(n,this.opts.scoreThresholds),e.registerScorePerMesh(this.mesh,i);const o=function(e,t,s,r,n){const i={byTopic:new Map,p5w:[],p6w:[],p7w:[],score:[]};for(const o of e){const e=t.get(o);if(null!=e){const t=UT(o,e,s,r,n);for(const[e,s]of t.byTopic){let t=i.byTopic.get(e);null==t&&(t={p1w:[],p2w:[],p3w:[],p3bw:[],p4w:[]},i.byTopic.set(e,t)),t.p1w.push(s.p1w),t.p2w.push(s.p2w),t.p3w.push(s.p3w),t.p3bw.push(s.p3bw),t.p4w.push(s.p4w)}i.p5w.push(t.p5w),i.p6w.push(t.p6w),i.p7w.push(t.p7w),i.score.push(t.score)}else i.p5w.push(0),i.p6w.push(0),i.p7w.push(0),i.score.push(0)}return i}(this.peers.keys(),this.score.peerStats,this.score.params,this.score.peerIPs,e.topicStrToLabel);e.registerScoreWeights(o)}tagMeshPeer=e=>{const{peerId:t,topic:s}=e.detail;this.components.peerStore.merge(this.peers.get(t)??oT(t),{tags:{[s]:{value:100}}}).catch(e=>{this.log.error("Error tagging peer %s with topic %s",t,s,e)})};untagMeshPeer=e=>{const{peerId:t,topic:s}=e.detail;this.components.peerStore.merge(this.peers.get(t)??oT(t),{tags:{[s]:void 0}}).catch(e=>{this.log.error("Error untagging peer %s with topic %s",t,s,e)})}}const tI="StrictSign",sI="StrictNoSign";var rI;function nI(e={}){return t=>new eI(t,e)}!function(e){e.Accept="accept",e.Ignore="ignore",e.Reject="reject"}(rI||(rI={}));const iI=Symbol.for("@libp2p/content-routing");class oI extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}}let aI=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};class cI extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}}class lI extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}}let hI=class extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}},uI=class extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}},dI=class extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}},pI=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}},fI=class extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}};const gI=Symbol.for("@libp2p/peer-discovery"),mI=Symbol.for("@libp2p/peer-id"),yI=Symbol.for("@libp2p/peer-routing");function bI(e){return null!=e&&"function"==typeof e.start&&"function"==typeof e.stop}async function wI(...e){const t=[];for(const s of e)bI(s)&&t.push(s);await Promise.all(t.map(async e=>{null!=e.beforeStart&&await e.beforeStart()})),await Promise.all(t.map(async e=>{await e.start()})),await Promise.all(t.map(async e=>{null!=e.afterStart&&await e.afterStart()}))}async function vI(...e){const t=[];for(const s of e)bI(s)&&t.push(s);await Promise.all(t.map(async e=>{null!=e.beforeStop&&await e.beforeStop()})),await Promise.all(t.map(async e=>{await e.stop()})),await Promise.all(t.map(async e=>{null!=e.afterStop&&await e.afterStop()}))}const SI=Symbol.for("@libp2p/service-capabilities"),EI=Symbol.for("@libp2p/service-dependencies"),DI={hash:e=>Number(Il(e,{size:32})),hashV:(e,t)=>function(e){let t=e.toString(16);t.length%2==1&&(t=`0${t}`);return Ge(t,"base16")}(DI.hash(e,t))};class _I{fp;h;seed;constructor(e,t,s,r=2){if(r>64)throw new TypeError("Invalid Fingerprint Size");const n=t.hashV(e,s),i=c(r);for(let e=0;e<i.length;e++)i[e]=n[e];0===i.length&&(i[0]=7),this.fp=i,this.h=t,this.seed=s}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array&&a(this.fp,e.fp)}}function TI(e,t){return Math.floor(Math.random()*(t-e))+e}class II{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof _I))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof _I))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(null==this.contents[t])return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof _I))throw new TypeError("Invalid Fingerprint");const t=TI(0,this.contents.length-1),s=this.contents[t];return this.contents[t]=e,s}remove(e){if(!(e instanceof _I))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(t=>e.equals(t));return t>-1&&(this.contents[t]=null,!0)}}class CI{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??DI,this.seed=e.seed??TI(0,Math.pow(2,10))}add(e){"string"==typeof e&&(e=Ge(e));const t=new _I(e,this.hash,this.seed,this.fingerprintSize),s=this.hash.hash(e,this.seed)%this.filterSize,r=(s^t.hash())%this.filterSize;if(null==this.buckets[s]&&(this.buckets[s]=new II(this.bucketSize)),null==this.buckets[r]&&(this.buckets[r]=new II(this.bucketSize)),this.buckets[s].add(t)||this.buckets[r].add(t))return this.count++,!0;const n=[s,r];let i=n[TI(0,n.length-1)];null==this.buckets[i]&&(this.buckets[i]=new II(this.bucketSize));for(let e=0;e<500;e++){const e=this.buckets[i].swap(t);if(null!=e&&(i=(i^e.hash())%this.filterSize,null==this.buckets[i]&&(this.buckets[i]=new II(this.bucketSize)),this.buckets[i].add(e)))return this.count++,!0}return!1}has(e){"string"==typeof e&&(e=Ge(e));const t=new _I(e,this.hash,this.seed,this.fingerprintSize),s=this.hash.hash(e,this.seed)%this.filterSize,r=this.buckets[s]?.has(t)??!1;if(r)return r;const n=(s^t.hash())%this.filterSize;return this.buckets[n]?.has(t)??!1}remove(e){"string"==typeof e&&(e=Ge(e));const t=new _I(e,this.hash,this.seed,this.fingerprintSize),s=this.hash.hash(e,this.seed)%this.filterSize,r=this.buckets[s]?.remove(t)??!1;if(r)return this.count--,r;const n=(s^t.hash())%this.filterSize,i=this.buckets[n]?.remove(t)??!1;return i&&this.count--,i}get reliable(){return Math.floor(this.count/this.filterSize*100)<=90}}const PI={1:.5,2:.84,4:.95,8:.98};function xI(e,t=.001){const s=function(e=.001){return e>.002?2:e>1e-5?4:8}(t),r=PI[s];return{filterSize:Math.round(e/r),bucketSize:s,fingerprintSize:Math.min(Math.ceil(Math.log2(1/t)+Math.log2(2*s)),64)}}class AI{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??DI,this.seed=e.seed??TI(0,Math.pow(2,10)),this.filterSeries=[new CI({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if("string"==typeof e&&(e=Ge(e)),this.has(e))return!0;let t=this.filterSeries.find(e=>e.reliable);if(null==t){const e=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new CI({filterSize:e,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){"string"==typeof e&&(e=Ge(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){"string"==typeof e&&(e=Ge(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}const kI=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"].map(e=>new lu(e));function NI(e){for(const t of kI)if(t.contains(e))return!0;return!1}function RI(e){return gc(e)?NI(e):/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(e)?function(e){const t=e.split(":");if(t.length<2)return!1;const s=t[t.length-1].padStart(4,"0"),r=t[t.length-2].padStart(4,"0");return NI(`${parseInt(r.substring(0,2),16)}.${parseInt(r.substring(2),16)}.${parseInt(s.substring(0,2),16)}.${parseInt(s.substring(2),16)}`)}(e):function(e){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)}(e)?function(e){const t=e.split(":");return NI(t[t.length-1])}(e):mc(e)?function(e){return/^::$/.test(e)||/^::1$/.test(e)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(e)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(e)||/^ff([0-9a-fA-F]{2,2}):/i.test(e)}(e):void 0}function MI(e){try{const t=function(e){const t=e.getComponents(),s={};let r=0;if("ip6zone"===t[r]?.name&&(s.zone=`${t[r].value}`,r++),"ip4"===t[r].name||"ip6"===t[r].name||"dns"===t[r].name||"dns4"===t[r].name||"dns6"===t[r].name?(s.type=t[r].name,s.host=t[r].value,r++):"dnsaddr"===t[r].name&&(s.type=t[r].name,s.host=`_dnsaddr.${t[r].value}`,r++),"tcp"!==t[r]?.name&&"udp"!==t[r]?.name||(s.protocol="tcp"===t[r].name?"tcp":"udp",s.port=parseInt(`${t[r].value}`),r++),"ipcidr"===t[r]?.name&&("ip4"===s.type?s.cidr=parseInt(`${t[r].value}`):"ip6"===s.type&&(s.cidr=`${t[r].value}`),r++),null==s.type||null==s.host)throw new aI(`Multiaddr ${e} was not an IPv4, IPv6, DNS, DNS4, DNS6 or DNSADDR address`);return"tls"===t[r]?.name&&"sni"===t[r+1]?.name&&(s.sni=t[r+1].value,r+=2),s}(e);switch(t.type){case"ip4":case"ip6":return RI(t.host)??!1;default:return"localhost"===t.host}}catch{return!1}}function LI(e,t){let s;const r=function(){clearTimeout(s),s=setTimeout(function(){s=void 0,e()},t)};return r.start=()=>{},r.stop=()=>{clearTimeout(s)},r}class OI extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}let BI=class extends Error{static name="UnexpectedEOFError";name="UnexpectedEOFError"};function UI(e){return e.reason}async function VI(e,t,s){if(null==t)return e;const r=UI;if(t.aborted)return e.catch(()=>{}),Promise.reject(r(t));let n;try{return await Promise.race([e,new Promise((e,s)=>{n=()=>{s(r(t))},t.addEventListener("abort",n)})])}finally{null!=n&&t.removeEventListener("abort",n)}}class FI{deferred;signal;constructor(e){this.signal=e,this.deferred=jl(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new oI)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}class zI{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=`${parseInt(String(1e9*Math.random()),10).toString()}${Date.now()}`,this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((e,t)=>e&&!0===t.signal?.aborted,!0)&&(this.controller.abort(new oI),this.cleanup())}async join(e={}){const t=new FI(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await VI(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}}class $I extends ns{concurrency;maxSize;queue;pending;sort;paused;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.paused=!1,null!=e.metricName&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=LI(this.emitEmpty.bind(this),1),this.emitIdle=LI(this.emitIdle.bind(this),1)}emitEmpty(){0===this.size&&this.safeDispatchEvent("empty")}emitIdle(){0===this.running&&this.safeDispatchEvent("idle")}pause(){this.paused=!0}resume(){this.paused&&(this.paused=!1,this.tryToStartAnother())}tryToStartAnother(){if(this.paused)return!1;if(0===this.size)return this.emitEmpty(),0===this.running&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if("queued"===t.status){e=t;break}return null!=e&&(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),null!=this.sort&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new OI;const s=new zI(e,t);return this.enqueue(s),this.safeDispatchEvent("add"),this.tryToStartAnother(),s.join(t).then(e=>(this.safeDispatchEvent("completed",{detail:e}),this.safeDispatchEvent("success",{detail:{job:s,result:e}}),e)).catch(e=>{if("queued"===s.status)for(let e=0;e<this.queue.length;e++)if(this.queue[e]===s){this.queue.splice(e,1);break}throw this.safeDispatchEvent("failure",{detail:{job:s,error:e}}),e})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new oI)}),this.clear()}async onEmpty(e){0!==this.size&&await Nm(this,"empty",e)}async onSizeLessThan(e,t){this.size<e||await Nm(this,"next",{...t,filter:()=>this.size<e})}async onIdle(e){0===this.pending&&0===this.size||await Nm(this,"idle",e)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=Xl({objectMode:!0}),s=e=>{null!=e?this.abort():this.clear(),t.end(e)},r=e=>{null!=e.detail&&t.push(e.detail)},n=e=>{s(e.detail.error)},i=()=>{s()},o=()=>{s(new oI("Queue aborted"))};this.addEventListener("completed",r),this.addEventListener("failure",n),this.addEventListener("idle",i),e?.signal?.addEventListener("abort",o);try{yield*t}finally{this.removeEventListener("completed",r),this.removeEventListener("failure",n),this.removeEventListener("idle",i),e?.signal?.removeEventListener("abort",o),s()}}}class qI{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(null!=this.previousTime){const s=this.alpha(t,this.previousTime),r=e-this.movingAverage,n=s*r;this.movingAverage=s*e+(1-s)*this.movingAverage,this.variance=(1-s)*(this.variance+r*n),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+s*r}else this.movingAverage=e;this.previousTime=t}}class WI{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){const t=e.interval??5e3;this.success=new qI(t),this.failure=new qI(t),this.next=new qI(t),this.failureMultiplier=e.failureMultiplier??2,this.timeoutMultiplier=e.timeoutMultiplier??1.2,this.minTimeout=e.minTimeout??5e3,this.maxTimeout=e.maxTimeout??6e4,null!=e.metricName&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);const s=AbortSignal.timeout(t),r=ip([e.signal,s]);return r.start=Date.now(),r.timeout=t,r}cleanUp(e){const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}let KI=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},jI=class extends Error{static name="ValidationError";name="ValidationError"},HI=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"},GI=class extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"};function QI(e){return t=>Qe(t,e)}function XI(e){return t=>Ge(t,e)}function YI(e){return new DataView(e.buffer).getUint16(e.byteOffset).toString()}function JI(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,"string"==typeof e?parseInt(e):e),new Uint8Array(t)}function ZI(e){const t=e.subarray(0,e.length-2),s=e.subarray(e.length-2);return`${Qe(t,"base32")}:${YI(s)}`}const eC=function(e){e=e.toString().trim();const t=new Uint8Array(4);return e.split(/\./g).forEach((e,s)=>{const r=parseInt(e,10);if(isNaN(r)||r<0||r>255)throw new KI("Invalid byte value in IP address");t[s]=r}),t};const tC=Object.values(qe).map(e=>e.decoder),sC=function(){let e=tC[0].or(tC[1]);return tC.slice(2).forEach(t=>e=e.or(t)),e}();const rC=function(...e){return t=>{for(const s of e)s(t)}}(function(e){if(parseInt(e).toString()!==e)throw new jI("Value must be an integer")},function(e){if(e<0)throw new jI("Value must be a positive integer, or zero")},function(e){return t=>{if(t>e)throw new jI(`Value must be smaller than or equal to ${e}`)}}(65535)),nC=-1;const iC=new class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(t="string"==typeof e?this.protocolsByName.get(e):this.protocolsByCode.get(e),null==t)throw new GI(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);null!=t&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(e=>{this.protocolsByName.delete(e)}))}},oC=[{code:4,name:"ip4",size:32,valueToBytes:eC,bytesToValue:function(e){if(4!==e.byteLength)throw new KI("IPv4 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s++)t.push(e[s]);return t.join(".")},validate:e=>{if(!gc(e))throw new jI(`Invalid IPv4 address "${e}"`)}},{code:6,name:"tcp",size:16,valueToBytes:JI,bytesToValue:YI,validate:rC},{code:273,name:"udp",size:16,valueToBytes:JI,bytesToValue:YI,validate:rC},{code:33,name:"dccp",size:16,valueToBytes:JI,bytesToValue:YI,validate:rC},{code:41,name:"ip6",size:128,valueToBytes:function(e){let t=0;const s=(e=e.toString().trim()).split(":",8);let r;for(r=0;r<s.length;r++){let e;gc(s[r])&&(e=eC(s[r]),s[r]=Qe(e.subarray(0,2),"base16")),null!=e&&++r<8&&s.splice(r,0,Qe(e.subarray(2,4),"base16"))}if(""===s[0])for(;s.length<8;)s.unshift("0");else if(""===s[s.length-1])for(;s.length<8;)s.push("0");else if(s.length<8){for(r=0;r<s.length&&""!==s[r];r++);const e=[r,1];for(r=9-s.length;r>0;r--)e.push("0");s.splice.apply(s,e)}const n=new Uint8Array(t+16);for(r=0;r<s.length;r++){""===s[r]&&(s[r]="0");const e=parseInt(s[r],16);if(isNaN(e)||e<0||e>65535)throw new KI("Invalid byte value in IP address");n[t++]=e>>8&255,n[t++]=255&e}return n},bytesToValue:function(e){if(16!==e.byteLength)throw new KI("IPv6 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s+=2){const r=e[s],n=e[s+1],i=`${r.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}`;t.push(i)}const s=t.join(":");try{const e=new URL(`http://[${s}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new KI(`Invalid IPv6 address "${s}"`)}},stringToValue:function(e){try{const t=new URL(`http://[${e}]`);return t.hostname.substring(1,t.hostname.length-1)}catch{throw new KI(`Invalid IPv6 address "${e}"`)}},validate:e=>{if(!mc(e))throw new jI(`Invalid IPv6 address "${e}"`)}},{code:42,name:"ip6zone",size:nC},{code:43,name:"ipcidr",size:8,bytesToValue:QI("base10"),valueToBytes:XI("base10")},{code:53,name:"dns",size:nC},{code:54,name:"dns4",size:nC},{code:55,name:"dns6",size:nC},{code:56,name:"dnsaddr",size:nC},{code:132,name:"sctp",size:16,valueToBytes:JI,bytesToValue:YI,validate:rC},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:nC,stringToValue:e=>decodeURIComponent(e),valueToString:e=>encodeURIComponent(e)},{code:421,name:"p2p",aliases:["ipfs"],size:nC,bytesToValue:QI("base58btc"),valueToBytes:e=>e.startsWith("Q")||e.startsWith("1")?XI("base58btc")(e):Ue.parse(e).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:ZI,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const s=Ge(t[0],"base32"),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=JI(r);return u([s,n],s.length+n.length)}},{code:445,name:"onion3",size:296,bytesToValue:ZI,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const s=L.decode(`b${t[0]}`),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=JI(r);return u([s,n],s.length+n.length)}},{code:446,name:"garlic64",size:nC},{code:447,name:"garlic32",size:nC},{code:448,name:"tls"},{code:449,name:"sni",size:nC},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:nC,bytesToValue:function(e){return t=>e.encoder.encode(t)}(Z),valueToBytes:function(e){return sC.decode(e)}},{code:480,name:"http"},{code:481,name:"http-path",size:nC,stringToValue:e=>`/${decodeURIComponent(e)}`,valueToString:e=>encodeURIComponent(e.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:nC}];function aC(e,t,s){return null==e.size||0===e.size?0:e.size>0?e.size/8:Ci(t,s)}oC.forEach(e=>{iC.addProtocol(e)});const cC=Symbol.for("nodejs.util.inspect.custom"),lC=Symbol.for("@multiformats/multiaddr");function hC(e){if(null==e&&(e="/"),function(e){return Boolean(e?.[lC])}(e))return e.getComponents();if(e instanceof Uint8Array)return function(e){const t=[];let s=0;for(;s<e.length;){const r=Ci(e,s),n=iC.getProtocol(r),i=Di(r),o=aC(n,e,s+i);let a=0;o>0&&n.size===nC&&(a=Di(o));const c=i+a+o,l={code:r,name:n.name,bytes:e.subarray(s,s+c)};if(o>0){const t=s+i+a,r=e.subarray(t,t+o);l.value=n.bytesToValue?.(r)??Qe(r)}t.push(l),s+=c}return t}(e);if("string"==typeof e)return""===(e=e.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""))&&(e="/"),function(e){if("/"!==e.charAt(0))throw new KI('String multiaddr must start with "/"');const t=[];let s="protocol",r="",n="";for(let i=1;i<e.length;i++){const o=e.charAt(i);"/"!==o&&("protocol"===s?n+=e.charAt(i):r+=e.charAt(i));const a=i===e.length-1;if("/"===o||a){const e=iC.getProtocol(n);if("protocol"===s){if(null==e.size||0===e.size){t.push({code:e.code,name:e.name}),r="",n="",s="protocol";continue}if(a)throw new KI(`Component ${n} was missing value`);s="value"}else if("value"===s){const i={code:e.code,name:e.name};if(null!=e.size&&0!==e.size){if(""===r)throw new KI(`Component ${n} was missing value`);i.value=e.stringToValue?.(r)??r}t.push(i),r="",n="",s="protocol"}}}if(""!==n&&""!==r)throw new KI("Incomplete multiaddr");return t}(e);if(Array.isArray(e))return e;throw new KI("Must be a string, Uint8Array, Component[], or another Multiaddr")}let uC=class e{[lC]=!0;#L;#O;#B;constructor(e="/",t={}){this.#L=hC(e),!1!==t.validate&&function(e){e.getComponents().forEach(e=>{const t=iC.getProtocol(e.code);null!=e.value&&t.validate?.(e.value)})}(this)}get bytes(){return null==this.#B&&(this.#B=function(e){let t=0;const s=[];for(const r of e){if(null==r.bytes){const e=iC.getProtocol(r.code),t=Di(r.code);let s,n=0,i=0;null!=r.value&&(s=e.valueToBytes?.(r.value)??Ge(r.value),n=s.byteLength,e.size===nC&&(i=Di(n)));const o=new Uint8Array(t+i+n);let a=0;_i(r.code,o,a),a+=t,null!=s&&(e.size===nC&&(_i(n,o,a),a+=i),o.set(s,a)),r.bytes=o}s.push(r.bytes),t+=r.bytes.byteLength}return u(s,t)}(this.#L)),this.#B}toString(){return null==this.#O&&(this.#O=`/${this.#L.flatMap(e=>{if(null==e.value)return e.name;const t=iC.getProtocol(e.code);if(null==t)throw new KI(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`),this.#O}toJSON(){return this.toString()}getComponents(){return[...this.#L.map(e=>({...e}))]}encapsulate(t){const s=new e(t);return new e([...this.#L,...s.getComponents()],{validate:!1})}decapsulate(t){const s=t.toString(),r=this.toString(),n=r.lastIndexOf(s);if(n<0)throw new HI(`Address ${this.toString()} does not contain subaddress: ${s}`);return new e(r.slice(0,n),{validate:!1})}decapsulateCode(t){let s;for(let e=this.#L.length-1;e>-1;e--)if(this.#L[e].code===t){s=e;break}return new e(this.#L.slice(0,s),{validate:!1})}equals(e){return a(this.bytes,e.bytes)}[cC](){return`Multiaddr(${this.toString()})`}};function dC(e){return new uC(e)}let pC=class extends Error{static name="UnwrappedError";name="UnwrappedError"},fC=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},gC=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},mC=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function yC(e){return function(e){return"function"==typeof e?.closeRead}(e)?"writable"!==e.remoteWriteStatus&&0===e.readBufferLength:!!function(e){return"function"==typeof e?.close}(e)&&"open"!==e.status}function bC(e,t={}){const s=function(e,t){const s=t?.maxBufferSize??4194304,r=new cs;let n,i=!1;if(o=e,null==o?.addEventListener||null==o?.removeEventListener||null==o?.send||null==o?.push||null==o?.log)throw new aI("Argument should be a Stream or a Multiaddr");var o;const a=e=>{if(r.append(e.data),r.byteLength>s){const e=r.byteLength;r.consume(r.byteLength),n?.reject(new Error(`Read buffer overflow - ${e} > ${s}`))}n?.resolve()};e.addEventListener("message",a);const c=e=>{null!=e.error?n?.reject(e.error):n?.resolve()};e.addEventListener("close",c);const l=()=>{n?.resolve()};e.addEventListener("remoteCloseWrite",l);const h={readBuffer:r,async read(t){if(!0===i)throw new pC("Stream was unwrapped");if(yC(e)){if(null==t?.bytes)return null;if(r.byteLength<t.bytes)throw e.log.error("closed after reading %d/%d bytes",r.byteLength,t.bytes),new BI(`Unexpected EOF - stream closed after reading ${r.byteLength}/${t.bytes} bytes`)}const s=t?.bytes??1;for(n=Promise.withResolvers();;){if(r.byteLength>=s){n.resolve();break}if(await VI(n.promise,t?.signal),yC(e)){if(0===r.byteLength&&null==t?.bytes)return null;break}n=Promise.withResolvers()}const o=t?.bytes??r.byteLength;if(r.byteLength<o){if(yC(e))throw e.log.error("closed while reading %d/%d bytes",r.byteLength,o),new BI(`Unexpected EOF - stream closed while reading ${r.byteLength}/${o} bytes`);return h.read(t)}const a=r.sublist(0,o);return r.consume(o),a},async write(t,s){if(!0===i)throw new pC("Stream was unwrapped");e.send(t)||await Nm(e,"drain",{signal:s?.signal,rejectionEvents:["close"]})},unwrap:()=>(i||(i=!0,e.removeEventListener("message",a),e.removeEventListener("close",c),e.removeEventListener("remoteCloseWrite",l),r.byteLength>0&&(e.log("stream unwrapped with %d unread bytes",r.byteLength),e.push(r))),e)};return h}(e,t);null!=t.maxDataLength&&null==t.maxLengthLength&&(t.maxLengthLength=Di(t.maxDataLength));const r=t?.lengthDecoder??Ci,n=t?.lengthEncoder??Ii;return{async read(n){let i=-1;const o=new cs;for(;;){const e=await s.read({...n,bytes:1});if(null==e)break;o.append(e);try{i=r(o)}catch(e){if(e instanceof RangeError)continue;throw e}if(i<0)throw new fC("Invalid message length");if(null!=t?.maxLengthLength&&o.byteLength>t.maxLengthLength)throw new mC(`Message length length too long - ${o.byteLength} > ${t.maxLengthLength}`);if(i>-1)break}if(null!=t?.maxDataLength&&i>t.maxDataLength)throw new gC(`Message length too long - ${i} > ${t.maxDataLength}`);const a=await s.read({...n,bytes:i});if(null==a)throw e.log.error("tried to read %d bytes but the stream closed",i),new BI(`Unexpected EOF - tried to read ${i} bytes but the stream closed`);if(a.byteLength!==i)throw e.log.error("read %d/%d bytes before the stream closed",a.byteLength,i),new BI(`Unexpected EOF - read ${a.byteLength}/${i} bytes before the stream closed`);return a},async write(e,t){await s.write(new cs(n(e.byteLength),e),t)},async writeV(e,t){const r=new cs(...e.flatMap(e=>[n(e.byteLength),e]));await s.write(r,t)},unwrap:()=>s.unwrap()}}function wC(e,t){const s=bC(e,t),r={read:async(e,t)=>{const r=await s.read(t);return e.decode(r)},write:async(e,t,r)=>{await s.write(t.encode(e),r)},writeV:async(e,t,r)=>{await s.writeV(e.map(e=>t.encode(e)),r)},pb:e=>({read:async t=>r.read(e,t),write:async(t,s)=>r.write(t,e,s),writeV:async(t,s)=>r.writeV(t,e,s),unwrap:()=>r}),unwrap:()=>s.unwrap()};return r}class vC extends $I{has(e){return null!=this.find(e)}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}const SC=36e5,EC=48*SC,DC=SC,_C=SC,TC="keep-alive-kad-dht";var IC,CC,PC,xC,AC,kC,NC,RC;function MC(e){const t=e.getUTCFullYear(),s=String(e.getUTCMonth()+1).padStart(2,"0"),r=String(e.getUTCDate()).padStart(2,"0"),n=String(e.getUTCHours()).padStart(2,"0"),i=String(e.getUTCMinutes()).padStart(2,"0"),o=String(e.getUTCSeconds()).padStart(2,"0"),a=e.getUTCMilliseconds();return`${t}-${s}-${r}T${n}:${i}:${o}.${String(1e3*a*1e3).padStart(9,"0")}Z`}!function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.key&&e.key.byteLength>0&&(t.uint32(10),t.bytes(e.key)),null!=e.value&&e.value.byteLength>0&&(t.uint32(18),t.bytes(e.value)),null!=e.timeReceived&&""!==e.timeReceived&&(t.uint32(42),t.string(e.timeReceived)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={key:c(0),value:c(0),timeReceived:""},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.key=e.bytes();break;case 2:r.value=e.bytes();break;case 5:r.timeReceived=e.string();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(IC||(IC={}));class LC{key;value;timeReceived;constructor(e,t,s){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=s}serialize(){return IC.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:MC(this.timeReceived)}}static deserialize(e){const t=IC.decode(e);return new LC(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=function(e){const t=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),s=String(e).trim().match(t);if(null==s)throw new Error("Invalid format");const r=parseInt(s[1],10),n=parseInt(s[2],10)-1,i=parseInt(s[3],10),o=parseInt(s[4],10),a=parseInt(s[5],10),c=parseInt(s[6],10),l=parseInt(s[7].slice(0,-6),10);return new Date(Date.UTC(r,n,i,o,a,c,l))}(e.timeReceived);if(null==e.key)throw new Error("key missing from deserialized object");if(null==e.value)throw new Error("value missing from deserialized object");return new LC(e.key,e.value,t)}}function OC(e,t){let s=0;if(null!=e[Symbol.asyncIterator])return async function*(){for await(const r of e)yield t(r,s++)}();const r=su(e),{value:n,done:i}=r.next();if(!0===i)return function*(){}();const o=t(n,s++);if("function"==typeof o.then)return async function*(){yield await o;for(const e of r)yield t(e,s++)}();const a=t;return function*(){yield o;for(const e of r)yield a(e,s++)}()}class BC extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}}class UC extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}}class VC extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}}function FC(e,t={}){const s={...e,name:"SEND_QUERY",type:0,messageName:e.type,messageType:e.type};return t.onProgress?.(new CustomEvent("kad-dht:query:send-query",{detail:s})),s}function zC(e,t={}){const s={...e,name:"PEER_RESPONSE",type:1,messageName:e.messageType,closer:e.closer??[],providers:e.providers??[]};return t.onProgress?.(new CustomEvent("kad-dht:query:peer-response",{detail:s})),s}function $C(e,t={}){const s={...e,name:"FINAL_PEER",type:2};return t.onProgress?.(new CustomEvent("kad-dht:query:final-peer",{detail:s})),s}function qC(e,t={}){const s={...e,name:"QUERY_ERROR",type:3};return t.onProgress?.(new CustomEvent("kad-dht:query:query-error",{detail:s})),s}function WC(e,t={}){const s={...e,name:"PROVIDER",type:4};return t.onProgress?.(new CustomEvent("kad-dht:query:provider",{detail:s})),s}function KC(e,t={}){const s={...e,name:"VALUE",type:5};return t.onProgress?.(new CustomEvent("kad-dht:query:value",{detail:s})),s}function jC(e,t={}){const s={...e,name:"DIAL_PEER",type:7};return t.onProgress?.(new CustomEvent("kad-dht:query:dial-peer",{detail:s})),s}!function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{!1!==s.lengthDelimited&&t.fork(),null!=e.key&&(t.uint32(10),t.bytes(e.key)),null!=e.value&&(t.uint32(18),t.bytes(e.value)),null!=e.author&&(t.uint32(26),t.bytes(e.author)),null!=e.signature&&(t.uint32(34),t.bytes(e.signature)),null!=e.timeReceived&&(t.uint32(42),t.string(e.timeReceived)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.key=e.bytes();break;case 2:r.value=e.bytes();break;case 3:r.author=e.bytes();break;case 4:r.signature=e.bytes();break;case 5:r.timeReceived=e.string();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(CC||(CC={})),function(e){e.PUT_VALUE="PUT_VALUE",e.GET_VALUE="GET_VALUE",e.ADD_PROVIDER="ADD_PROVIDER",e.GET_PROVIDERS="GET_PROVIDERS",e.FIND_NODE="FIND_NODE",e.PING="PING"}(PC||(PC={})),function(e){e[e.PUT_VALUE=0]="PUT_VALUE",e[e.GET_VALUE=1]="GET_VALUE",e[e.ADD_PROVIDER=2]="ADD_PROVIDER",e[e.GET_PROVIDERS=3]="GET_PROVIDERS",e[e.FIND_NODE=4]="FIND_NODE",e[e.PING=5]="PING"}(xC||(xC={})),(PC||(PC={})).codec=()=>ho(xC),function(e){e.NOT_CONNECTED="NOT_CONNECTED",e.CONNECTED="CONNECTED",e.CAN_CONNECT="CAN_CONNECT",e.CANNOT_CONNECT="CANNOT_CONNECT"}(AC||(AC={})),function(e){e[e.NOT_CONNECTED=0]="NOT_CONNECTED",e[e.CONNECTED=1]="CONNECTED",e[e.CAN_CONNECT=2]="CAN_CONNECT",e[e.CANNOT_CONNECT=3]="CANNOT_CONNECT"}(kC||(kC={})),function(e){e.codec=()=>ho(kC)}(AC||(AC={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{if(!1!==s.lengthDelimited&&t.fork(),null!=e.id&&e.id.byteLength>0&&(t.uint32(10),t.bytes(e.id)),null!=e.multiaddrs)for(const s of e.multiaddrs)t.uint32(18),t.bytes(s);null!=e.connection&&(t.uint32(24),AC.codec().encode(e.connection,t)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={id:c(0),multiaddrs:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.id=e.bytes();break;case 2:if(null!=s.limits?.multiaddrs&&r.multiaddrs.length===s.limits.multiaddrs)throw new po('Decode error - map field "multiaddrs" had too many elements');r.multiaddrs.push(e.bytes());break;case 3:r.connection=AC.codec().decode(e);break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(NC||(NC={})),function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{if(!1!==s.lengthDelimited&&t.fork(),null!=e.type&&0!==xC[e.type]&&(t.uint32(8),PC.codec().encode(e.type,t)),null!=e.clusterLevel&&(t.uint32(80),t.int32(e.clusterLevel)),null!=e.key&&(t.uint32(18),t.bytes(e.key)),null!=e.record&&(t.uint32(26),t.bytes(e.record)),null!=e.closer)for(const s of e.closer)t.uint32(66),NC.codec().encode(s,t);if(null!=e.providers)for(const s of e.providers)t.uint32(74),NC.codec().encode(s,t);!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={type:PC.PUT_VALUE,closer:[],providers:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.type=PC.codec().decode(e);break;case 10:r.clusterLevel=e.int32();break;case 2:r.key=e.bytes();break;case 3:r.record=e.bytes();break;case 8:if(null!=s.limits?.closer&&r.closer.length===s.limits.closer)throw new po('Decode error - map field "closer" had too many elements');r.closer.push(NC.codec().decode(e,e.uint32(),{limits:s.limits?.closer$}));break;case 9:if(null!=s.limits?.providers&&r.providers.length===s.limits.providers)throw new po('Decode error - map field "providers" had too many elements');r.providers.push(NC.codec().decode(e,e.uint32(),{limits:s.limits?.providers$}));break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(RC||(RC={}));const HC={pk:function(e,t){return 0}};async function GC(e,t,s){const r=t.key,n=Qe(r).split("/");if(n.length<3)return;const i=e[n[1].toString()];if(null==i)throw new aI(`No validator available for key type "${n[1]}"`);await i(r,t.value,s)}const QC={pk:async(e,t,s)=>{if(!(e instanceof Uint8Array))throw new aI('"key" must be a Uint8Array');if(e.byteLength<5)throw new aI("Invalid public key record");if("/pk/"!==Qe(e.subarray(0,4)))throw new aI("key was not prefixed with /pk/");const r=Ko(t);if(!a(e.slice(4),r.toMultihash().bytes))throw new aI("public key does not match passed in key")}},XC=Symbol.for("nodejs.util.inspect.custom");let YC=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[mI]=!0;toString(){return null==this.string&&(this.string=G.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Ue.createV1(114,this.multihash)}toJSON(){return this.toString()}equals(e){if(null==e)return!1;if(e instanceof Uint8Array)return a(this.multihash.bytes,e);if("string"==typeof e)return this.toString()===e;if(null!=e?.toMultihash()?.bytes)return a(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[XC](){return`PeerId(${this.toString()})`}},JC=class extends YC{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},ZC=class extends YC{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},eP=class extends YC{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};let tP=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=ke.digest(Ge(this.url))}[XC](){return`PeerId(${this.url})`}[mI]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return Ue.createV1(2336,this.toMultihash())}toJSON(){return this.toString()}equals(e){return null!=e&&(e instanceof Uint8Array&&(e=Qe(e)),e.toString()===this.toString())}};const sP=2336;function rP(e,t){let s;if("1"!==e.charAt(0)&&"Q"!==e.charAt(0)){if(e.startsWith("k51qzi5uqu5")||e.startsWith("kzwfwjn5ji4")||e.startsWith("k2k4r8")||e.startsWith("bafz"))return function(e){if(null==e?.multihash||null==e.version||1===e.version&&114!==e.code&&e.code!==sP)throw new hI("Supplied PeerID CID is invalid");if(e.code===sP){const t=Qe(e.multihash.digest);return new tP(new URL(t))}return iP(e.multihash)}(Ue.parse(e));throw new aI('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return s=Pe(G.decode(`z${e}`)),iP(s)}function nP(e){if("Ed25519"===e.type)return new ZC({multihash:e.toCID().multihash,publicKey:e});if("secp256k1"===e.type)return new eP({multihash:e.toCID().multihash,publicKey:e});if("RSA"===e.type)return new JC({multihash:e.toCID().multihash,publicKey:e});throw new fI}function iP(e){if(function(e){return e.code===Me.code}(e))return new JC({multihash:e});if(function(e){return e.code===ke.code}(e))try{const t=jo(e);if("Ed25519"===t.type)return new ZC({multihash:e,publicKey:t});if("secp256k1"===t.type)return new eP({multihash:e,publicKey:t})}catch(t){const s=Qe(e.digest);return new tP(new URL(s))}throw new uI("Supplied PeerID Multihash is invalid")}const oP="/",aP=(new TextEncoder).encode(oP),cP=aP[0];class lP{_buf;constructor(e,t){if("string"==typeof e)this._buf=Ge(e);else{if(!(e instanceof Uint8Array))throw new Error("Invalid key, should be String of Uint8Array");this._buf=e}if(null==t&&(t=!0),t&&this.clean(),0===this._buf.byteLength||this._buf[0]!==cP)throw new Error("Invalid key")}toString(e="utf8"){return Qe(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new lP(e.join(oP))}static random(){return new lP(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||"string"==typeof e?new lP(e):"function"==typeof e.uint8Array?new lP(e.uint8Array()):null}clean(){if(null!=this._buf&&0!==this._buf.byteLength||(this._buf=aP),this._buf[0]!==cP){const e=new Uint8Array(this._buf.byteLength+1);e.fill(cP,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===cP;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),s=e.list();for(let e=0;e<t.length;e++){if(s.length<e+1)return!1;const r=t[e],n=s[e];if(r<n)return!0;if(r>n)return!1}return t.length<s.length}reverse(){return lP.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(oP).slice(1)}type(){return function(e){const t=e.split(":");if(t.length<2)return"";return t.slice(0,-1).join(":")}(this.baseNamespace())}name(){return function(e){const t=e.split(":");return t[t.length-1]}(this.baseNamespace())}instance(e){return new lP(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(oP)||(e+=oP),e+=this.type(),new lP(e)}parent(){const e=this.list();return 1===e.length?new lP(oP):new lP(e.slice(0,-1).join(oP))}child(e){return this.toString()===oP?e:e.toString()===oP?this:new lP(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()!==this.toString()&&e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()!==this.toString()&&this.toString().startsWith(e.toString())}isTopLevel(){return 1===this.list().length}concat(...e){return lP.withNamespaces([...this.namespaces(),...(t=e.map(e=>e.namespaces()),[].concat(...t))]);var t}}const hP=Ge("/pk/");function uP(e){return{...e,multiaddrs:e.multiaddrs.filter(e=>!MI(e))}}async function dP(e,t){const s=await Me.digest(e);return t?.signal?.throwIfAborted(),s.digest}async function pP(e,t){return dP(e.toMultihash().bytes,t)}function fP(e,t){return new lP(`${e}/${Qe(t,"base32")}`,!1)}function gP(e,t){const s=new Date;return new LC(e,t,s).serialize()}function mP(e){const t=e.toString().split("/"),s=t.pop(),r=t.pop();if(null==s||null==r)throw new Error(`incorrectly formatted provider entry key in datastore: ${e.toString()}`);return{cid:Ue.createV1(85,Pe(Ge(r,"base32"))),peerId:rP(s)}}function yP(e,t,s){const r=[e,"string"==typeof t?t:Qe(t.multihash.bytes,"base32")];return null!=s&&r.push(s.toString()),new lP(r.join("/"))}function bP(e){return new Date(Ci(e))}function wP(e,t,s){return async function*(...r){const n=t.queryTime?.timer(s),i=t.errorTime?.timer(s);let o=!1;try{t.queries?.increment({[s]:!0}),yield*e(...r)}catch(e){throw o=!0,i?.(),t.errors?.increment({[s]:!0}),e}finally{t.queries?.decrement({[s]:!0}),o||n?.()}}}function vP(e,t,s){return async function(...r){const n=t?.queryTime?.timer(s),i=t?.errorTime?.timer(s);let o=!1;try{return t.queries?.increment({[s]:!0}),await e(...r)}catch(e){throw o=!0,i?.(),t.errors?.increment({[s]:!0}),e}finally{t.queries?.decrement({[s]:!0}),o||n?.()}}}class SP{log;components;validators;selectors;peerRouting;queryManager;network;datastorePrefix;constructor(e,t){const{validators:s,selectors:r,peerRouting:n,queryManager:i,network:o,logPrefix:a}=t;this.components=e,this.log=e.logger.forComponent(`${a}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=s,this.selectors=r,this.peerRouting=n,this.queryManager=i,this.network=o,this.get=e.metrics?.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1})??this.get,this.put=e.metrics?.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2})??this.put}async getLocal(e,t){this.log("getLocal %b",e);const s=fP(this.datastorePrefix,e);this.log("fetching record for key %k",s);const r=await this.components.datastore.get(s,t);this.log("found %k in local datastore",s);const n=LC.deserialize(r);return await GC(this.validators,n,t),n}async*sendCorrectionRecord(e,t,s,r){this.log("sendCorrection for %b",e);const n=gP(e,s);for(const{value:i,from:o}of t){if(a(i,s)){this.log("record was ok");continue}if(this.components.peerId.equals(o)){try{const t=fP(this.datastorePrefix,e);this.log(`Storing corrected record for key ${t.toString()}`),await this.components.datastore.put(t,n.subarray(),r)}catch(e){this.log.error("failed error correcting self - %e",e)}continue}let t=!1;const c={type:PC.PUT_VALUE,key:e,record:n};for await(const e of this.network.sendRequest(o,c,r))"PEER_RESPONSE"===e.name&&null!=e.record&&a(e.record.value,LC.deserialize(n).value)&&(t=!0),yield e;if(!t)throw new BC("Could not send correction");this.log.error("failed error correcting entry")}}async*put(e,t,s){this.log("put key %b value %b",e,t);const r=gP(e,t),n=fP(this.datastorePrefix,e);this.log(`storing record for key ${n.toString()}`),await this.components.datastore.put(n,r.subarray(),s),yield*qm(this.peerRouting.getClosestPeers(e,{...s,signal:s.signal}),t=>OC(t,t=>async()=>{if("FINAL_PEER"!==t.name)return[t];const n=[],i={type:PC.PUT_VALUE,key:e,record:r};this.log("send put to %p",t.peer.id);for await(const e of this.network.sendRequest(t.peer.id,i,{...s,path:t.path}))n.push(e),"PEER_RESPONSE"===e.name&&(null!=e.record&&a(e.record.value,LC.deserialize(r).value)||n.push(qC({from:t.peer.id,error:new BC("Value not put correctly"),path:e.path},s)));return n}),e=>Qp(e,{ordered:!1,concurrency:10}),async function*(e){for await(const t of e)yield*t})}async*get(e,t){this.log("get %b",e);const s=[];for await(const r of this.getMany(e,t))"VALUE"!==r.name?yield r:s.push(r);if(0===s.length)return;const r=s.map(e=>e.value);let n=0;try{n=function(e,t,s){if(0===s.length)throw new aI("No records given");const r=Qe(t).split("/");if(r.length<3)throw new aI("Record key does not have a selector function");const n=e[r[1].toString()];if(null==n)throw new VC(`No selector function configured for key type "${r[1]}"`);return 1===s.length?0:n(t,s)}(this.selectors,e,r)}catch(e){if("InvalidParametersError"!==e.name)throw e}const i=r[n];if(this.log("GetValue %b %b",e,i),null==i)throw new lI("Best value was not found");yield*this.sendCorrectionRecord(e,s,i,{...t,path:{index:-1,queued:0,running:0,total:0}}),yield s[n]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const s=await this.getLocal(e,t);yield KC({value:s.value,from:this.components.peerId,path:{index:-1,running:0,queued:0,total:0}},t)}catch(t){this.log("error getting local value for %b",e,t)}const s=this;yield*this.queryManager.run(e,async function*({peer:r,signal:n,path:i}){for await(const o of s.peerRouting.getValueOrPeers(r.id,e,{...t,signal:n,path:i}))yield o,"PEER_RESPONSE"===o.name&&null!=o.record&&(yield KC({from:r.id,value:o.record.value,path:i},t))},t)}}function EP(e,t){const s={[Symbol.iterator]:()=>s,next:()=>{const s=e.next(),r=s.value;if(!0===s.done||null==r){return{done:!0,value:void 0}}return{done:!1,value:t(r)}}};return s}function DP(e){return iP(Pe(G.decode(`z${e}`)))}class _P{map;constructor(e){if(this.map=new Map,null!=e)for(const[t,s]of e.entries())this.map.set(t.toString(),{key:t,value:s})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return EP(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,s)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return EP(this.map.values(),e=>e.key)}values(){return EP(this.map.values(),e=>e.value)}get size(){return this.map.size}}class TP{set;constructor(e){if(this.set=new Set,null!=e)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return EP(this.set.entries(),e=>{const t=DP(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const s=DP(t);e(s,s,this)})}has(e){return this.set.has(e.toString())}values(){return EP(this.set.values(),e=>DP(e))}intersection(e){const t=new TP;for(const s of e)this.has(s)&&t.add(s);return t}difference(e){const t=new TP;for(const s of this)e.has(s)||t.add(s);return t}union(e){const t=new TP;for(const s of e)t.add(s);for(const e of this)t.add(e);return t}}class IP extends _P{metric;constructor(e){super();const{name:t,metrics:s}=e;this.metric=s.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function CP(e,t){const s={id:e.id.toMultihash().bytes,multiaddrs:(e.multiaddrs??[]).map(e=>e.bytes),connection:t};return s}function PP(e){if(null==e.id)throw new Error("Invalid peer in message");return{id:iP(Pe(e.id)),multiaddrs:(e.multiaddrs??[]).map(e=>dC(e))}}class xP{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){const{network:s,peerRouting:r,queryManager:n,routingTable:i,providers:o,logPrefix:a}=t;this.components=e,this.log=e.logger.forComponent(`${a}:content-routing`),this.network=s,this.peerRouting=r,this.queryManager=n,this.routingTable=i,this.providers=o,this.findProviders=e.metrics?.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(e,t)=>("PROVIDER"===e.name&&(t.providers??=[],t.providers.push(...e.providers.map(e=>e.id.toString()))),t)})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(e,t)=>("PEER_RESPONSE"===e.name&&"ADD_PROVIDER"===e.messageName&&(t.providers??=[],t.providers.push(e.from.toString())),t)})??this.provide}async*provide(e,t,s={}){this.log("provide %s",e);const r=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId,s);const n={type:PC.ADD_PROVIDER,key:r,providers:[CP({id:this.components.peerId,multiaddrs:t})]};let i=0;const o=this;const a=Xl({objectMode:!0}),c=new $I({concurrency:10});c.addEventListener("idle",()=>{a.end()}),c.addEventListener("failure",e=>{this.log.error("error publishing provider record to peer - %e",e.detail.error)}),c.add(async()=>{const t=[];for await(const e of this.peerRouting.getClosestPeers(r,s))a.push(e),"FINAL_PEER"===e.name&&t.push(e);t.forEach(t=>{c.add(async()=>{for await(const r of async function*(t){try{o.log("sending provider record for %s to %p",e,t.peer.id);for await(const r of o.network.sendMessage(t.peer.id,n,{...s,path:t.path}))"PEER_RESPONSE"===r.name&&(o.log("sent provider record for %s to %p",e,t.peer.id),i++),yield r}catch(e){o.log.error("error sending provide record to peer %p - %e",t.peer.id,e),yield qC({from:t.peer.id,error:e,path:t.path},s)}}(t))a.push(r)}).catch(e=>{this.log.error("error publishing provider record to peer - %e",e)})})}).catch(e=>{a.end(e)}),yield*a,this.log("sent provider records to %d peers",i)}async*findProviders(e,t){const s=this.routingTable.kBucketSize;let r=0;const n=e.multihash.bytes,i=this;this.log("findProviders %c",e);const o=await this.providers.getProviders(e,t);if(o.length>0){const e=[];for(const r of o.slice(0,s))try{const s=await this.components.peerStore.get(r,t);e.push({id:r,multiaddrs:s.addresses.map(({multiaddr:e})=>e)})}catch(e){if("NotFoundError"!==e.name)throw e;this.log("no peer store entry for %p",r)}if(yield zC({from:this.components.peerId,messageType:PC.GET_PROVIDERS,providers:e,path:{index:-1,queued:0,running:0,total:0}},t),yield WC({from:this.components.peerId,providers:e,path:{index:-1,queued:0,running:0,total:0}},t),r+=e.length,r>=s)return}const a=async function*({peer:e,signal:s,path:r}){const o={type:PC.GET_PROVIDERS,key:n};yield*i.network.sendRequest(e.id,o,{...t,signal:s,path:r})},c=new TP(o);for await(const i of this.queryManager.run(n,a,t))if(yield i,"PEER_RESPONSE"===i.name){this.log("Found %d provider entries for %c and %d closer peers",i.providers.length,e,i.closer.length);const n=[];for(const e of i.providers)c.has(e.id)||(c.add(e.id),n.push(e));if(n.length>0&&(yield WC({from:i.from,providers:n,path:i.path},t),r+=n.length,r>=s))return}}}class AP extends ns{log;protocol;running;components;timeout;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=t.protocol,this.timeout=new WI({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=e.metrics?.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs:([e,t],s)=>({...s,to:e.toString(),"message type":`${t.type}`}),getAttributesFromYieldedValue:(e,t)=>("PEER_RESPONSE"===e.name&&(e.providers.length>0&&e.providers.forEach((e,s)=>{t[`providers-${s}`]=e.id.toString()}),e.closer.length>0&&e.closer.forEach((e,s)=>{t[`closer-${s}`]=e.id.toString()})),t)})??this.sendRequest,this.sendMessage=e.metrics?.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs:([e,t],s)=>({...s,to:e.toString(),"message type":`${t.type}`}),getAttributesFromYieldedValue:(e,t)=>("PEER_RESPONSE"===e.name&&(e.providers.length>0&&e.providers.forEach((e,s)=>{t[`providers-${s}`]=e.id.toString()}),e.closer.length>0&&e.closer.forEach((e,s)=>{t[`closer-${s}`]=e.id.toString()})),t)})??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,s){if(!this.running)return;const r=t.type;if(null==r)throw new aI("Message type was missing");let n;const i=this.timeout.getTimeoutSignal(s);s={...s,signal:i};try{this.metrics.operations?.increment({[r]:!0}),this.log("dialling %p",e),yield jC({peer:e,path:s.path},s),n=await this.components.connectionManager.openStream(e,this.protocol,s),this.log("sending %s to %p",t.type,e),yield FC({to:e,type:r,path:s.path},s);const i=await this._writeReadMessage(n,t,s);n.close(s).catch(t=>{this.log.error("error closing stream to %p - %e",e,t),n?.abort(t)}),yield zC({from:e,messageType:i.type,closer:i.closer.map(PP),providers:i.providers.map(PP),record:null==i.record?void 0:LC.deserialize(i.record),path:s.path},s)}catch(i){this.metrics.errors?.increment({[r]:!0}),n?.abort(i),!0!==s.signal?.aborted&&this.log.error("could not send %s to %p - %e",t.type,e,i),yield qC({from:e,error:i,path:s.path},s)}finally{this.timeout.cleanUp(i)}}async*sendMessage(e,t,s){if(!this.running)return;const r=t.type;if(null==r)throw new aI("Message type was missing");let n;const i=this.timeout.getTimeoutSignal(s);s={...s,signal:i};try{this.metrics.operations?.increment({[r]:!0}),this.log("dialling %p",e),yield jC({peer:e,path:s.path},s),n=await this.components.connectionManager.openStream(e,this.protocol,s),this.log("sending %s to %p",t.type,e),yield FC({to:e,type:r,path:s.path},s),await this._writeMessage(n,t,s),n.close(s).catch(t=>{this.log.error("error closing stream to %p - %e",e,t),n?.abort(t)}),yield zC({from:e,messageType:r,path:s.path},s)}catch(t){this.metrics.errors?.increment({[r]:!0}),n?.abort(t),yield qC({from:e,error:t,path:s.path},s)}finally{this.timeout.cleanUp(i)}}async _writeMessage(e,t,s){const r=wC(e);await r.write(t,RC,s)}async _writeReadMessage(e,t,s){const r=wC(e);await r.write(t,RC,s);const n=await r.read(RC,s);return n.closer.forEach(e=>{this.safeDispatchEvent("peer",{detail:PP(e)})}),n.providers.forEach(e=>{this.safeDispatchEvent("peer",{detail:PP(e)})}),n}}function kP(e,t){if(e.byteLength!==t.byteLength)throw new Error("Inputs should have the same length");for(let s=0;s<e.byteLength;s++)if(e[s]!==t[s])return e[s]<t[s]?-1:1;return 0}class NP{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return[...this.peerDistances]}async add(e,t={index:-1,queued:0,running:0,total:0},s){const r=await pP(e.id,s);this.addWithKadId(e,r,t)}addWithKadId(e,t,s={index:-1,queued:0,running:0,total:0}){if(null!=this.peerDistances.find(t=>t.peer.id.equals(e.id)))return;const r={peer:e,distance:h(this.originDhtKey,t),path:s};if(this.peerDistances.length===this.capacity){const e=this.peerDistances[this.peerDistances.length-1];if(null!=e&&-1!==kP(r.distance,e.distance))return}let n=!1;for(let e=0;e<this.peerDistances.length;e++){const t=kP(this.peerDistances[e].distance,r.distance);if(0===t||1===t){n=!0,this.peerDistances.splice(e,0,r);break}}n||this.peerDistances.push(r),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e,t){if(0===this.length)return!0;return-1===kP(h(await pP(e,t),this.originDhtKey),this.peerDistances[this.peerDistances.length-1].distance)}async anyCloser(e,t){return 0!==e.length&&Promise.any(e.map(async e=>this.isCloser(e,t)))}}class RP{log;routingTable;network;validators;queryManager;components;constructor(e,t){this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=e.metrics?.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async findPeerLocal(e,t){let s;const r=await this.routingTable.find(e,t);if(null!=r){this.log("findPeerLocal found %p in routing table",e);try{s=await this.components.peerStore.get(r,t)}catch(e){if("NotFoundError"!==e.name)throw e}}if(null==s)try{s=await this.components.peerStore.get(e,t)}catch(e){if("NotFoundError"!==e.name)throw e}if(null!=s)return this.log("findPeerLocal found %p in peer store",e),{id:s.id,multiaddrs:s.addresses.map(e=>e.multiaddr)}}async*_getValueSingle(e,t,s){const r={type:PC.GET_VALUE,key:t};yield*this.network.sendRequest(e,r,s)}async*getPublicKeyFromNode(e,t={}){const s=function(e){return u([hP,e.toMultihash().bytes])}(e),r={index:-1,queued:0,running:0,total:0};for await(const n of this._getValueSingle(e,s,{...t,path:r}))if(yield n,"PEER_RESPONSE"===n.name&&null!=n.record){const s=nP(Ko(n.record.value));if(!s.equals(e))throw new cI("public key does not match id");if(null==s.publicKey)throw new cI("public key missing");yield KC({from:e,value:n.record.value,path:r},t)}throw new BC(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),!1!==t.useCache){const s=await this.findPeerLocal(e,t);if(null!=s)return this.log("found local"),void(yield $C({from:this.components.peerId,peer:s,path:{index:-1,queued:0,running:0,total:0}},t))}let s=!1;if(!1!==t.useNetwork){const r=this,n=async function*({peer:s,signal:n,path:i}){const o={type:PC.FIND_NODE,key:e.toMultihash().bytes};for await(const a of r.network.sendRequest(s.id,o,{...t,signal:n,path:i}))if(yield a,"PEER_RESPONSE"===a.name){const s=a.closer.find(t=>t.id.equals(e));null!=s&&(yield $C({from:a.from,peer:s,path:a.path},t))}};for await(const r of this.queryManager.run(e.toMultihash().bytes,n,t))"FINAL_PEER"===r.name&&(s=!0),yield r}if(!s)throw new lI("Not found")}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const s=await dP(e,t),r=new NP(s,this.routingTable.kBucketSize),n=this;yield*this.queryManager.run(e,async function*({peer:s,path:i,peerKadId:o,signal:a}){n.log("getClosestPeers asking %p",s.id);const c={type:PC.FIND_NODE,key:e};yield*n.network.sendRequest(s.id,c,{...t,signal:a,path:i}),r.addWithKadId(s,o,i)},t),this.log("found %d peers close to %b",r.length,e);for(let{peer:e,path:s}of r.peers)try{if(0===e.multiaddrs.length&&(e=await n.components.peerStore.getInfo(e.id,t)),0===e.multiaddrs.length)continue;yield $C({from:this.components.peerId,peer:await n.components.peerStore.getInfo(e.id,t),path:{index:s.index,queued:0,running:0,total:0}},t)}catch{continue}}async*getValueOrPeers(e,t,s){for await(const r of this._getValueSingle(e,t,s)){if("PEER_RESPONSE"===r.name&&null!=r.record)try{await this._verifyRecordOnline(r.record,s)}catch(e){const t="invalid record received, discarded";this.log(t),yield qC({from:r.from,error:new BC(t),path:s.path},s);continue}yield r}}async _verifyRecordOnline(e,t){if(null==e.timeReceived)throw new UC("invalid record received");await GC(this.validators,new LC(e.key,e.value,e.timeReceived),t)}async getClosestPeersOffline(e,t){const s=[];try{const r=iP(Pe(e)),n=await this.components.peerStore.get(r,t);s.push({id:n.id,multiaddrs:n.addresses.map(({multiaddr:e})=>e)})}catch{}const r=await dP(e,t),n=this.routingTable.closestPeers(r,t);for(const e of n)try{s.push(await this.components.peerStore.getInfo(e,t))}catch(e){if("NotFoundError"!==e.name)throw e}return s.length>0?this.log("getClosestPeersOffline returning the %d closest peer(s) we know to %b",s.length,e):this.log("getClosestPeersOffline could not any peers close to %b with %d peers in the routing table",e,this.routingTable.size),s}}class MP{log;datastore;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore}async addProvider(e,t,s){this.log.trace("%p provides %s",t,e),await this.writeProviderEntry(e,t,s)}async removeProvider(e,t,s){const r=yP(this.datastorePrefix,e,t);this.log.trace("%p no longer provides %s",t,e),await this.datastore.delete(r,s)}async getProviders(e,t){this.log.trace("get providers for %c",e);const s=await this.loadProviders(e,t);return this.log.trace("got %d providers for %c",s.size,e),[...s.keys()]}async writeProviderEntry(e,t,s){const r=yP(this.datastorePrefix,e,t),n=Ii(s?.time?.getTime()??Date.now());await this.datastore.put(r,n,s)}async loadProviders(e,t){const s=new _P,r=yP(this.datastorePrefix,e);for await(const e of this.datastore.query({prefix:r.toString()},t)){const{peerId:t}=mP(e.key);s.set(t,bP(e.value))}return s}}async function*LP(e){const{key:t,startingPeers:s,ourPeerId:r,query:n,alpha:i,path:o,numPaths:a,log:c,peersSeen:l,connectionManager:u,signal:d}=e,p=Xl({objectMode:!0}),f=new $I({concurrency:i,sort:(e,t)=>kP(e.options.distance,t.options.distance)});f.addEventListener("idle",()=>{p.push(function(e,t={}){const s={...e,name:"PATH_ENDED",type:8};return t.onProgress?.(new CustomEvent("kad-dht:query:path-ended",{detail:s})),s}({path:{index:o,queued:f.queued,running:f.running,total:f.size}},e)),p.end()}),f.addEventListener("failure",e=>{c.error("error during query - %e",e.detail.error)});const g=()=>{f.abort(),p.end(new oI)};d.addEventListener("abort",g);try{const m=await dP(t,{signal:d});function y(s,i){if(null==s)return;l.add(s.id.toMultihash().bytes);const g=h(i,m);f.add(async()=>{try{for await(const b of n({...e,key:t,peer:s,path:{index:o,queued:f.queued,running:f.running,total:f.size},numPaths:a,peerKadId:i,signal:d})){if("PEER_RESPONSE"===b.name)for(const e of b.closer){if(l.has(e.id.toMultihash().bytes)){c("already seen %p in query",e.id);continue}if(r.equals(e.id)){c("not querying ourselves");continue}if(!await u.isDialable(e.multiaddrs)){c("not querying undialable peer");continue}const n=await pP(e.id,{signal:d});-1===kP(h(n,m),g)?(c("querying closer peer %p",e.id),y(e,n)):c("skipping %p as they are not closer to %b than %p",e.id,t,s.id)}p.push({...b,path:{index:o,queued:f.queued,running:f.running,total:f.size}})}}catch(t){p.push(qC({from:s.id,error:t,path:{index:o,queued:f.queued,running:f.running-1,total:f.size-1}},e))}},{distance:g}).catch(e=>{c.error("error during query - %e",e)})}await Promise.all(s.map(async e=>{y({id:e,multiaddrs:[]},await pP(e,{signal:d}))})),yield*p}finally{d.removeEventListener("abort",g)}}class OP{disjointPaths;alpha;shutDownController;running;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;allowQueryWithZeroPeers;constructor(e,t){this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??20,this.alpha=t.alpha??10,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.allowQueryWithZeroPeers=t.allowQueryWithZeroPeers??!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,s={}){if(!this.running)throw new Error("QueryManager not started");if(null==s.signal){const e=AbortSignal.timeout(18e4);s={...s,signal:e}}const r=new AbortController,n=ip([this.shutDownController.signal,r.signal,s.signal]);r.signal;const i=this.logger.forComponent(`${this.logPrefix}:query:`+Qe(e,"base58btc"));let o=!1;try{0!==this.routingTable.size||this.allowQueryWithZeroPeers||(i("routing table was empty, waiting for some peers before running%s query",!0===s.isSelfQuery?" self":""),await Nm(this.routingTable,"peer:add",{signal:n,filter:e=>!this.peerId.equals(e.detail)}),i("routing table has peers, continuing with%s query",!0===s.isSelfQuery?" self":"")),!0!==s.isSelfQuery&&null!=this.initialQuerySelfHasRun&&(i("waiting for initial self query before continuing"),await VI(this.initialQuerySelfHasRun.promise,n),this.initialQuerySelfHasRun=void 0),i("query:start");const r=await dP(e,{signal:n}),a=this.routingTable.closestPeers(r,{count:this.routingTable.kBucketSize}),c=a.sort(()=>Math.random()>.5?1:-1).reduce((e,t,s)=>(e[s%this.disjointPaths].push(t),e),new Array(this.disjointPaths).fill(0).map(()=>[])).filter(e=>e.length>0);if(0===a.length)return void i.error("running query with no peers");const l=function(e,t=.001){return new AI({...xI(e,t)})}(1024),h=c.map((r,o)=>LP({...s,key:e,startingPeers:r,ourPeerId:this.peerId,signal:n,query:t,path:o,numPaths:c.length,alpha:this.alpha,log:i,peersSeen:l,onProgress:s.onProgress,connectionManager:this.connectionManager}));for await(const e of jp(...h)){if("QUERY_ERROR"===e.name&&i.error("query error - %e",e.error),"PEER_RESPONSE"===e.name)for(const t of[...e.closer,...e.providers])await this.connectionManager.isDialable(t.multiaddrs,{signal:n})&&await this.routingTable.add(t.id,{signal:n});n.throwIfAborted(),yield e}o=!0}catch(e){if(this.running)throw e}finally{o||(i("query exited early"),r.abort()),n.clear(),i("query finished")}}}function BP(e){if(null!=e[Symbol.asyncIterator])return(async()=>{let t=0;for await(const s of e)t++;return t})();{let t=0;for(const s of e)t++;return t}}class UP{log;peerId;peerRouting;events;count;interval;initialInterval;queryTimeout;running;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.events=e.events,this.running=!1,this.peerRouting=t.peerRouting,this.count=t.count??20,this.interval=t.interval??3e5,this.initialInterval=t.initialInterval??1e3,this.queryTimeout=t.queryTimeout??5e3,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=vP(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query - %e",e)})},this.initialInterval))}stop(){this.running=!1,null!=this.timeoutId&&clearTimeout(this.timeoutId),null!=this.controller&&this.controller.abort()}async querySelf(){if(this.running){if(null!=this.querySelfPromise)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=jl(),this.running){this.controller=new AbortController;const e=[this.controller.signal];if(null==this.initialQuerySelfHasRun){const t=AbortSignal.timeout(this.queryTimeout);e.push(t)}const t=ip(e);this.controller.signal;try{this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const e=Date.now(),s=await qm(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),e=>iu(e,this.count),async e=>BP(e));t?.throwIfAborted();const r=Date.now()-e;this.log("self-query found %d peers in %dms",s,r),this.events.dispatchEvent(new CustomEvent("kad-dht:query:self",{detail:{peers:s,duration:r}}))}catch(e){this.log.error("self-query error - %e",e)}finally{t.clear(),null!=this.initialQuerySelfHasRun&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query - %e",e)})},this.interval))}else this.log("skip self-query because we are not started")}}class VP extends ns{log;reprovideQueue;maxQueueSize;datastore;timeout;reprovideTimeout;running;shutdownController;reprovideThreshold;contentRouting;datastorePrefix;addressManager;validity;interval;peerId;constructor(e,t){super(),this.log=e.logger.forComponent(`${t.logPrefix}:reprovider`),this.peerId=e.peerId,this.reprovideQueue=new $I({concurrency:t.concurrency??10,metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new WI({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=e.datastore,this.addressManager=e.addressManager,this.datastorePrefix=`${t.datastorePrefix}/provider`,this.reprovideThreshold=t.threshold??864e5,this.maxQueueSize=t.maxQueueSize??16384,this.validity=t.validity??EC,this.interval=t.interval??DC,this.contentRouting=t.contentRouting,this.running=!1,this.reprovide=vP(this.reprovide.bind(this),t.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.processRecords({signal:AbortSignal.timeout(_C)}).catch(e=>{this.log.error("error running process to reprovide/cleanup - %e",e)})},this.interval))}stop(){this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),this.shutdownController?.abort()}async processRecords(e){try{this.safeDispatchEvent("reprovide:start"),this.log("starting reprovide/cleanup");for await(const t of this.datastore.query({prefix:this.datastorePrefix},e))try{const{cid:s,peerId:r}=mP(t.key),n=bP(t.value).getTime()+this.validity,i=Date.now(),o=i>n,a=this.peerId.equals(r);this.log.trace("comparing: %d (now) < %d (expires) = %s %s",i,n,o,o?"(expired)":"(valid)"),o&&!a&&await this.datastore.delete(t.key,e),this.shouldReprovide(a,n)&&(this.log("reproviding %c as it is within the reprovide threshold (%d)",s,this.reprovideThreshold),this.queueReprovide(s).catch(e=>{this.log.error("could not reprovide %c - %e",s,e)}))}catch(e){this.log.error("error processing datastore key %s - %s",t.key,e.message)}this.log("reprovide/cleanup successful")}finally{this.safeDispatchEvent("reprovide:end"),this.running&&(this.log("queuing next re-provide/cleanup run in %d ms",this.interval),this.timeout=setTimeout(()=>{this.processRecords({signal:AbortSignal.timeout(_C)}).catch(e=>{this.log.error("error running re-provide - %e",e)})},this.interval))}}shouldReprovide(e,t){if(!e)return!1;const s=Date.now();return t<s||t-s<this.reprovideThreshold}async queueReprovide(e,t){if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",e),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize,t);const s=this.reprovideQueue.queue.find(t=>t.options.cid.equals(e));if(null!=s)return this.log.trace("not adding %c to re-provide queue - already in queue",e),s.join();this.log.trace("adding %c to re-provide queue",e),this.reprovideQueue.add(async t=>{if(t.signal?.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",e);const s=this.reprovideTimeout.getTimeoutSignal(t);try{await this.reprovide(t.cid,t)}finally{this.reprovideTimeout.cleanUp(s)}this.log.trace("re-provided %c",e)},{signal:this.shutdownController?.signal,cid:e}).catch(t=>{this.log.error("could not re-provide key %c - %e",e,t)})}async reprovide(e,t){await tu(this.contentRouting.provide(e,this.addressManager.getAddresses(),t))}}class FP{routingTable;components;closestPeers;newPeers;refreshInterval;peerSetSize;timeout;closeTagName;closeTagValue;log;running;constructor(e,t){this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??5e3,this.peerSetSize=t.peerSetSize??20,this.closeTagName=t.closeTagName??"kad-close",this.closeTagValue=t.closeTagValue??50,this.closestPeers=new TP,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;const e=await pP(this.components.peerId);this.newPeers=new NP(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(e=>{this.log.error("error updating peer tags - %e",e)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){this.newPeers?.add({id:e.detail,multiaddrs:[]}).catch(e=>{this.log.error("error adding peer to distance list - %e",e)})}async updatePeerTags(){const e=new TP(this.newPeers?.peers.map(({peer:e})=>e.id)),t=e.difference(this.closestPeers),s=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async e=>{await this.components.peerStore.merge(e,{tags:{[this.closeTagName]:{value:this.closeTagValue},[TC]:{value:1}}})}),...[...s].map(async e=>{await this.components.peerStore.merge(e,{tags:{[this.closeTagName]:void 0,[TC]:void 0}})})])}}function zP(e){return Array.isArray(e?.peers)}class $P{peerId;root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;lastPingThreshold;ping;verify;onAdd;onRemove;onMove;addingPeerMap;constructor(e,t){this.peerId=e.peerId,this.prefixLength=t.prefixLength??WP,this.kBucketSize=t.kBucketSize??qP,this.splitThreshold=t.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=t.numberOfOldContactsToPing??KP,this.lastPingThreshold=t.lastPingThreshold??HP,this.ping=t.ping,this.verify=t.verify,this.onAdd=t.onAdd,this.onRemove=t.onRemove,this.addingPeerMap=function(e){const{name:t,metrics:s}=e;let r;return r=null!=s?new IP({name:t,metrics:s}):new _P,r}({name:`${t.metricsPrefix}_adding_peer_map`,metrics:e.metrics}),this.root={prefix:"",depth:0,peers:[]}}async start(){await this.addSelfPeer(this.peerId)}stop(){this.addingPeerMap.clear(),this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e,t){this.localPeer={peerId:e,kadId:await pP(e,t),lastPing:Date.now()}}async add(e,t){const s={peerId:e,kadId:await pP(e,t),lastPing:0},r=this.addingPeerMap.get(e);if(null!=r)return r;try{const r=this._add(s,t);this.addingPeerMap.set(e,r),await r}finally{this.addingPeerMap.delete(e)}}async _add(e,t){const s=this._determineBucket(e.kadId);if(this._indexOf(s,e.kadId)>-1)return;if(s.peers.length===this.splitThreshold&&s.depth<this.prefixLength)return await this._split(s,t),void await this._add(e,t);if(s.peers.length<this.kBucketSize){if(!function(e,t){return e.lastPing<Date.now()-t}(e,this.lastPingThreshold))return s.peers.push(e),void await(this.onAdd?.(e,s,t));return void(await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t)))}const r=s.peers.filter(e=>!e.peerId.equals(this.localPeer?.peerId)&&!(e.lastPing>Date.now()-this.lastPingThreshold)).sort((e,t)=>e.lastPing<t.lastPing?-1:e.lastPing>t.lastPing?1:0).slice(0,this.numberOfNodesToPing);let n=!1;for await(const e of this.ping(r,t))n=!0,await this.remove(e.kadId,t);n&&await this._add(e,t)}*closest(e,t){const s=new NP(e,t?.count??this.kBucketSize);for(const e of this.toIterable())!0!==t?.exclude?.some(t=>t.equals(e.peerId))&&s.addWithKadId({id:e.peerId,multiaddrs:[]},e.kadId);yield*OC(s.peers,({peer:e})=>e.id)}count(){return function e(t){if(zP(t))return t.peers.length;let s=0;return null!=t.left&&(s+=e(t.left)),null!=t.right&&(s+=e(t.right)),s}(this.root)}get(e){const t=this._determineBucket(e),s=this._indexOf(t,e);return t.peers[s]}async remove(e,t){const s=this._determineBucket(e),r=this._indexOf(s,e);if(r>-1){const e=s.peers.splice(r,1)[0];await(this.onRemove?.(e,s,t))}}*toIterable(){yield*function*e(t){zP(t)?yield*t.peers:(yield*e(t.left),yield*e(t.right))}(this.root)}distance(e,t){return BigInt("0x"+Qe(h(e,t),"base16"))}_determineBucket(e){const t=Qe(e,"base2");return function e(s,r=0){return zP(s)?s:e("0"===t[r]?s.left:s.right,r+1)}(this.root)}_indexOf(e,t){return e.peers.findIndex(e=>a(e.kadId,t))}async _split(e,t){const s={prefix:"0",depth:e.depth+1,peers:[]},r={prefix:"1",depth:e.depth+1,peers:[]};for(const n of e.peers){"0"===Qe(n.kadId,"base2")[e.depth]?(s.peers.push(n),await(this.onMove?.(n,e,s,t))):(r.peers.push(n),await(this.onMove?.(n,e,r,t)))}!function(e,t,s){delete e.peers,e.left=t,e.right=s,""===e.prefix&&(delete e.depth,delete e.prefix)}(e,s,r)}}const qP=20,WP=6,KP=3,jP="kad-peer",HP=6e5;class GP extends ns{kBucketSize;kb;network;closestPeerTagger;log;components;running;pingNewContactTimeout;pingNewContactQueue;pingOldContactTimeout;pingOldContactQueue;populateFromDatastoreOnStart;populateFromDatastoreLimit;protocol;peerTagName;peerTagValue;metrics;shutdownController;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??qP,this.running=!1,this.protocol=t.protocol,this.network=t.network,this.peerTagName=t.peerTagName??jP,this.peerTagValue=t.peerTagValue??1,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=t.populateFromDatastoreOnStart??true,this.populateFromDatastoreLimit=t.populateFromDatastoreLimit??1e3,this.shutdownController=new AbortController,this.shutdownController.signal,this.pingOldContactQueue=new vC({concurrency:t.pingOldContactConcurrency??20,metricName:`${t.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:t.pingOldContactMaxQueueSize??100}),this.pingOldContactTimeout=new WI({...t.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new vC({concurrency:t.pingNewContactConcurrency??20,metricName:`${t.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:t.pingNewContactMaxQueueSize??100}),this.pingNewContactTimeout=new WI({...t.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new $P(e,{kBucketSize:t.kBucketSize,prefixLength:t.prefixLength,splitThreshold:t.splitThreshold,numberOfOldContactsToPing:t.numberOfOldContactsToPing,lastPingThreshold:t.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved,metricsPrefix:t.metricsPrefix}),this.closestPeerTagger=new FP(this.components,{logPrefix:t.logPrefix,routingTable:this,peerSetSize:t.closestPeerSetSize,refreshInterval:t.closestPeerSetRefreshInterval,closeTagName:t.closeTagName,closeTagValue:t.closeTagValue}),null!=this.components.metrics&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${t.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,await wI(this.closestPeerTagger,this.kb))}async afterStart(){let e=0;Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;const t=ip([this.shutdownController.signal,AbortSignal.timeout(2e4)]);try{for(const s of await this.components.peerStore.all({filters:[e=>e.protocols.includes(this.protocol)&&e.tags.has(jP)],limit:this.populateFromDatastoreLimit,signal:t})){if(!this.running)return;try{await this.add(s.id,{signal:t}),e++}catch(e){this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(s.id,{tags:{[this.peerTagName]:void 0}})}}}finally{t.clear()}this.log("added %d peer store peers to the routing table",e)}).catch(t=>{this.log.error("error adding %d, peer store peers to the routing table - %e",e,t)})}async stop(){this.running=!1,await vI(this.closestPeerTagger,this.kb),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort(),this.shutdownController.abort()}async peerAdded(e,t,s){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}},s),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:e.peerId})}async peerRemoved(e,t,s){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:void 0}},s),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:e.peerId})}async*pingOldContacts(e,t){if(!this.running)return;const s=[];for(const r of e)null!=this.kb.get(r.kadId)?(this.metrics?.kadBucketEvents.increment({ping_old_contact:!0}),s.push(async()=>{const e=this.pingOldContactQueue.find(r.peerId);if(null!=e){this.log("asked to ping contact %p was already being pinged",r.peerId);return await e.join(t)?void 0:r}if(!await this.pingOldContactQueue.add(async e=>{const t=this.pingOldContactTimeout.getTimeoutSignal(),s=ip([t,this.shutdownController.signal,e?.signal]);try{return await this.pingContact(r,e)}catch{return this.metrics?.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(t),s.clear()}},{peerId:r.peerId,signal:t?.signal}))return r})):this.log("asked to ping contact %p that was not in routing table",r.peerId);for await(const e of Qp(s))null!=e&&(yield e)}async verifyNewContact(e,t){const s=this.pingNewContactTimeout.getTimeoutSignal(),r=ip([s,this.shutdownController.signal,t?.signal]);try{const t=this.pingNewContactQueue.find(e.peerId);return null!=t?(this.log("joining existing ping to add new peer %p to routing table",e.peerId),await t.join({signal:r})):await this.pingNewContactQueue.add(async t=>(this.metrics?.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",e.peerId),this.pingContact(e,t)),{peerId:e.peerId,signal:r})}catch(t){return this.log.trace("tried to add peer %p but they were not online",e.peerId),this.metrics?.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(s),r.clear()}}async pingContact(e,t){try{return this.log("pinging contact %p",e.peerId),await this.components.ping.ping(e.peerId,t),this.log("contact %p ping ok",e.peerId),this.safeDispatchEvent("peer:ping",{detail:e.peerId}),!0}catch(t){return this.log("error pinging old contact %p - %e",e.peerId,t),!1}}get size(){return null==this.kb?0:this.kb.count()}async find(e,t){const s=await pP(e,t);return this.kb.get(s)?.peerId}closestPeer(e){const t=this.closestPeers(e,{count:1});if(t.length>0)return t[0]}closestPeers(e,t){return null==this.kb?[]:[...this.kb.closest(e,t)]}async add(e,t){if(null==this.kb)throw new Error("RoutingTable is not started");await this.kb.add(e,t)}async remove(e,t){if(null==this.kb)throw new Error("RoutingTable is not started");const s=await pP(e,t);await this.kb.remove(s,t)}updateMetrics(){if(null==this.metrics||null==this.kb)return;let e=0,t=0,s=0,r=20,n=0;!function i(o){if(zP(o))return o.depth>s&&(s=o.depth),t++,e+=o.peers.length,o.peers.length<r&&(r=o.peers.length),void(o.peers.length>n&&(n=o.peers.length));i(o.left),i(o.right)}(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMinOccupancy.update(r),this.metrics.routingTableKadBucketMaxOccupancy.update(n),this.metrics.routingTableKadBucketMaxDepth.update(s)}}var QP=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782];class XP{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){const{peerRouting:s,routingTable:r,refreshInterval:n,refreshQueryTimeout:i,logPrefix:o}=t;this.log=e.logger.forComponent(`${o}:routing-table:refresh`),this.peerRouting=s,this.routingTable=r,this.refreshInterval=n??3e5,this.refreshQueryTimeout=i??3e4,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){null!=this.refreshTimeoutId&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1,t){this.log("refreshing routing table");const s=this._maxCommonPrefix(),r=this._getTrackedCommonPrefixLengthsForRefresh(s);this.log(`max common prefix length ${s}`),this.log(`tracked CPLs [ ${r.map(e=>e.toISOString()).join(", ")} ]`),Promise.all(r.map(async(n,i)=>{try{if(await this._refreshCommonPrefixLength(i,n,e,t),0===this._numPeersForCpl(s)){const s=Math.min(2*(i+1),r.length-1);for(let r=i+1;r<s+1;r++)try{await this._refreshCommonPrefixLength(r,n,e,t)}catch(e){this.log.error("failed to refresh entries with common prefix length %d - %e",r,e)}}}catch(e){this.log.error("failed to refresh entries with common prefix length - %e",e)}})).catch(e=>{this.log.error("failed to refresh table - %e",e)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),null!=this.refreshTimeoutId.unref&&this.refreshTimeoutId.unref()}).catch(e=>{this.log.error("failed to set refresh timeout - %e",e)})}async _refreshCommonPrefixLength(e,t,s,r){if(!s&&t.getTime()>Date.now()-this.refreshInterval)return void this.log("not running refresh for cpl %s as time since last refresh not above interval",e);const n=this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,n,this.routingTable.size);const i=ip([r?.signal,AbortSignal.timeout(this.refreshQueryTimeout)]);try{const t=await BP(this.peerRouting.getClosestPeers(n.toMultihash().bytes,{signal:i}));this.log(`found ${t} peers that were close to imaginary peer %p`,n),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,n,this.routingTable.size)}finally{i.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>15&&(e=15);const t=[];for(let s=0;s<=e;s++)t[s]=this.commonPrefixLengthRefreshedAt[s]??new Date;return t}_generateRandomPeerId(e){if(null==this.routingTable.kb)throw new Error("Routing table not started");if(null==this.routingTable.kb.localPeer)throw new Error("Local peer not set");const t=go(2),s=(t[1]<<8)+t[0];return iP(Pe(this._makePeerId(this.routingTable.kb.localPeer.kadId,s,e)))}_makePeerId(e,t,s){if(s>15)throw new Error("Cannot generate peer ID for common prefix length greater than 15");const r=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1),n=65535<<16-(s+1),i=QP[(r^32768>>s)&n|t&~n],o=new ArrayBuffer(34),a=new DataView(o,0,o.byteLength);return a.setUint8(0,Me.code),a.setUint8(1,32),a.setUint32(2,i,!1),new Uint8Array(a.buffer,a.byteOffset,a.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const s of this._prefixLengths())s===e&&t++;return t}*_prefixLengths(){if(null!=this.routingTable.kb?.localPeer)for(const{kadId:e}of this.routingTable.kb.toIterable()){const t=h(this.routingTable.kb.localPeer.kadId,e);let s=0;for(const e of t){if(0!==e)break;s++}yield s}}}class YP{peerId;providers;peerStore;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(null==t.key||0===t.key.length)throw new dI("Missing key");let s;try{s=Ue.decode(t.key)}catch(e){throw new dI("Invalid CID")}null!=t.providers&&0!==t.providers.length||this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,s),await Promise.all(t.providers.map(async t=>{const r=iP(Pe(t.id)),n=t.multiaddrs.map(e=>dC(e));e.equals(r)?t.multiaddrs.length<1?this.log("no valid addresses for provider %p. Ignore",e):(this.log.trace("received provider %p for %s (addrs %s)",e,s,n),await this.providers.addProvider(s,r),await this.peerStore.merge(r,{multiaddrs:n})):this.log("invalid provider peer %p from %p",t.id,e)}))}}class JP{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){const{peerRouting:s,logPrefix:r}=t;this.log=e.logger.forComponent(`${r}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=s,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){this.log("incoming request from %p for peers close to %b",e,t.key);try{if(null==t.key)throw new dI("Invalid FIND_NODE message received - key was missing");const s=await this.peerRouting.getClosestPeersOffline(t.key,{exclude:[e,this.peerId]});a(this.peerId.toMultihash().bytes,t.key)&&s.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(e=>e.decapsulateCode(421))});const r={type:PC.FIND_NODE,clusterLevel:t.clusterLevel,closer:s.map(this.peerInfoMapper).filter(({multiaddrs:e})=>e.length).map(e=>({id:e.id.toMultihash().bytes,multiaddrs:e.multiaddrs.map(e=>e.bytes)})),providers:[]};return 0===r.closer.length?this.log("could not find any peers closer to %b for %p",t.key,e):this.log("found %d peers close to %b for %p",r.closer.length,t.key,e),r}catch(s){throw this.log("error during finding peers closer to %b for %p - %e",t.key,e,s),s}}}class ZP{peerId;peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){const{peerRouting:s,providers:r,logPrefix:n}=t;this.log=e.logger.forComponent(`${n}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=s,this.providers=r,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(null==t.key)throw new dI("Invalid GET_PROVIDERS message received - key was missing");let s;try{s=Ue.decode(t.key)}catch(e){throw new dI("Invalid CID")}this.log("%p asking for providers for %s",e,s);const[r,n]=await Promise.all([Wl(OC(await this.providers.getProviders(s),async e=>{const t=await this.peerStore.get(e),s={id:t.id,multiaddrs:t.addresses.map(({multiaddr:e})=>e)};return s})),this.peerRouting.getClosestPeersOffline(t.key)]),i={type:PC.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:n.map(this.peerInfoMapper).filter(({id:e,multiaddrs:t})=>t.length>0).map(e=>({id:e.id.toMultihash().bytes,multiaddrs:e.multiaddrs.map(e=>e.bytes)})),providers:r.map(this.peerInfoMapper).filter(({id:e,multiaddrs:t})=>t.length>0).map(e=>({id:e.id.toMultihash().bytes,multiaddrs:e.multiaddrs.map(e=>e.bytes)}))};return this.log("got %s providers %s closerPeers",i.providers.length,i.closer.length),i}async _getAddresses(e){return[]}}class ex{peerStore;datastore;peerRouting;log;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){const s=t.key;if(this.log("%p asked for key %b",e,s),null==s||0===s.length)throw new dI("Invalid key");const r={type:PC.GET_VALUE,key:s,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(function(e){return"/pk/"===Qe(e.subarray(0,4))}(s)){this.log("is public key");const e=function(e){return iP(Pe(e.subarray(4)))}(s);let t;try{const s=await this.peerStore.get(e);if(null==s.id.publicKey)throw new lI("No public key found in key book");t=Ho(s.id.publicKey)}catch(e){if("NotFoundError"!==e.name)throw e}if(null!=t)return this.log("returning found public key"),r.record=new LC(s,t,new Date).serialize(),r}const[n,i]=await Promise.all([this._checkLocalDatastore(s),this.peerRouting.getClosestPeersOffline(s)]);return null!=n&&(this.log("had record for %b in local datastore",s),r.record=n.serialize()),i.length>0&&(this.log("had %s closer peers in routing table",i.length),r.closer=i.map(e=>({id:e.id.toMultihash().bytes,multiaddrs:e.multiaddrs.map(e=>e.bytes)}))),r}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);const t=fP(this.datastorePrefix,e);let s;try{s=await this.datastore.get(t)}catch(e){if("NotFoundError"===e.name)return;throw e}const r=LC.deserialize(s);if(!(null==r.timeReceived||Date.now()-r.timeReceived.getTime()>EC))return r;await this.datastore.delete(t)}}class tx{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}}class sx{components;validators;log;datastorePrefix;constructor(e,t){const{validators:s}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=s}async handle(e,t){const s=t.key;if(this.log("%p asked us to store value for key %b",e,s),null==t.record)throw this.log.error("empty record from %p",e),new dI(`Empty record from: ${e}`);try{const e=LC.deserialize(t.record);await GC(this.validators,e),e.timeReceived=new Date;const r=fP(this.datastorePrefix,e.key);await this.components.datastore.put(r,e.serialize().subarray()),this.log("put record for %b into datastore under key %k",s,r)}catch(e){this.log("did not put record for key %b into datastore %o",s,e)}return t}}class rx{handlers;log;metrics;incomingMessageTimeout;constructor(e,t){this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`),rpcTime:e.metrics?.registerMetricGroup(`${t.metricsPrefix}_inbound_rpc_time_seconds`,{label:"operation"})},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.incomingMessageTimeout=t.incomingMessageTimeout??1e4,this.handlers={[PC.GET_VALUE.toString()]:new ex(e,t),[PC.PUT_VALUE.toString()]:new sx(e,t),[PC.FIND_NODE.toString()]:new JP(e,t),[PC.ADD_PROVIDER.toString()]:new YP(e,t),[PC.GET_PROVIDERS.toString()]:new ZP(e,t),[PC.PING.toString()]:new tx(e,t)}}async handleMessage(e,t){const s=this.handlers[t.type];if(null!=s)try{return this.metrics.operations?.increment({[t.type]:!0}),await s.handle(e,t)}catch{this.metrics.errors?.increment({[t.type]:!0})}else this.log.error(`no handler found for message type: ${t.type}`)}async onIncomingStream(e,t){const s=()=>{e.abort(new pI)};let r=AbortSignal.timeout(this.incomingMessageTimeout);r.addEventListener("abort",s);const n=wC(e).pb(RC);for(;;){if("readable"!==e.readStatus){await e.close({signal:r});break}const i=await n.read({signal:r}),o=this.metrics?.rpcTime?.timer(i.type.toString()),a=this.metrics?.rpcTime?.timer(i.type.toString());let c=!1;try{this.log("incoming %s from %p",i.type,t.remotePeer);const e=await this.handleMessage(t.remotePeer,i);null!=e&&await n.write(e,{signal:r})}catch(e){throw c=!0,a?.(),e}finally{c||o?.()}r.removeEventListener("abort",s),r=AbortSignal.timeout(this.incomingMessageTimeout),r.addEventListener("abort",s)}}}class nx extends ns{log;components;protocol;running;registrarId;constructor(e,t){super();const{protocol:s,logPrefix:r}=t;this.components=e,this.log=e.logger.forComponent(`${r}:topology-listener`),this.running=!1,this.protocol=s}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:e}))}}))}async stop(){this.running=!1,null!=this.registrarId&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class ix{dht;constructor(e){this.dht=e}async provide(e,t={}){await tu(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(const s of this.dht.findProviders(e,t))"PROVIDER"===s.name&&(yield*s.providers.map(e=>({...e,routing:"kad-dht"})))}async put(e,t,s){await tu(this.dht.put(e,t,s))}async get(e,t){for await(const s of this.dht.get(e,t))if("VALUE"===s.name)return s.value;throw new lI("Could not find value for key")}}class ox{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(const s of this.dht.findPeer(e,t))if("FINAL_PEER"===s.name)return s.peer;throw new lI("Peer not found")}async*getClosestPeers(e,t={}){for await(const s of this.dht.getClosestPeers(e,t))"FINAL_PEER"===s.name&&(yield s.peer)}}class ax extends ns{k;a;d;protocol;routingTable;providers;network;peerRouting;components;log;running;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;reprovider;onPeerConnectTimeout;constructor(e,t={}){super();const s=t.logPrefix??"libp2p:kad-dht",r=t.datastorePrefix??"/dht",n=t.metricsPrefix??"libp2p_kad_dht",i={queries:e.metrics?.registerMetricGroup(`${n}_operations_total`,{label:"operation"}),errors:e.metrics?.registerCounterGroup(`${n}_operation_errors_total`,{label:"operation"}),queryTime:e.metrics?.registerMetricGroup(`${n}_operation_time_seconds`,{label:"operation"}),errorTime:e.metrics?.registerMetricGroup(`${n}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=e,this.log=e.logger.forComponent(s),this.k=t.kBucketSize??qP,this.a=t.alpha??10,this.d=t.disjointPaths??this.a,this.protocol=t.protocol??"/ipfs/kad/1.0.0",this.clientMode=t.clientMode??!0,this.maxInboundStreams=t.maxInboundStreams??32,this.maxOutboundStreams=t.maxOutboundStreams??64,this.peerInfoMapper=t.peerInfoMapper??uP,this.onPeerConnectTimeout=t.onPeerConnectTimeout??1e4,this.providers=new MP(e,{...t.providers,logPrefix:s,datastorePrefix:r}),this.validators={...QC,...t.validators},this.selectors={...HC,...t.selectors},this.network=new AP(e,{protocol:this.protocol,logPrefix:s,metricsPrefix:n}),this.routingTable=new GP(e,{kBucketSize:this.k,pingOldContactTimeout:t.pingOldContactTimeout,pingOldContactConcurrency:t.pingOldContactConcurrency,pingOldContactMaxQueueSize:t.pingOldContactMaxQueueSize,pingNewContactTimeout:t.pingNewContactTimeout,pingNewContactConcurrency:t.pingNewContactConcurrency,pingNewContactMaxQueueSize:t.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:s,metricsPrefix:n,prefixLength:t.prefixLength,splitThreshold:t.kBucketSplitThreshold,network:this.network});const o=jl();!0===t.allowQueryWithZeroPeers&&o.resolve(),this.queryManager=new OP(e,{disjointPaths:this.d,alpha:this.a,logPrefix:s,metricsPrefix:n,initialQuerySelfHasRun:o,routingTable:this.routingTable,allowQueryWithZeroPeers:t.allowQueryWithZeroPeers}),this.peerRouting=new RP(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:s}),this.contentFetching=new SP(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:s,datastorePrefix:r}),this.contentRouting=new xP(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:s}),this.routingTableRefresh=new XP(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:s}),this.rpc=new rx(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:s,metricsPrefix:n,datastorePrefix:r,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new nx(e,{protocol:this.protocol,logPrefix:s}),this.querySelf=new UP(e,{peerRouting:this.peerRouting,interval:t.querySelfInterval,initialInterval:t.initialQuerySelfInterval,logPrefix:s,initialQuerySelfHasRun:o,operationMetrics:i}),this.reprovider=new VP(e,{...t.reprovide,logPrefix:s,metricsPrefix:n,datastorePrefix:r,contentRouting:this.contentRouting,operationMetrics:i}),this.network.addEventListener("peer",e=>{const t=e.detail;this.onPeerConnect(t).catch(e=>{this.log.error("could not add %p to routing table - %e",t.id,e)}),this.dispatchEvent(new CustomEvent("peer",{detail:t}))}),this.topologyListener.addEventListener("peer",e=>{const t=e.detail;Promise.resolve().then(async()=>{const e=await this.components.peerStore.get(t),s={id:t,multiaddrs:e.addresses.map(({multiaddr:e})=>e),protocols:e.protocols};await this.onPeerConnect(s)}).catch(e=>{this.log.error("could not add %p to routing table - %e",t,e)})}),this.dhtPeerRouting=new ox(this),this.dhtContentRouting=new ix(this),null==t.clientMode&&e.events.addEventListener("self:peer:update",e=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const t=e.detail.peer.addresses.some(({multiaddr:e})=>!MI(e)&&!_m.exactMatch(e)),s=this.getMode();t&&"client"===s?await this.setMode("server"):"server"!==s||t||await this.setMode("client")}).catch(e=>{this.log.error("error setting dht server mode - %e",e)})}),this.get=wP(this.get.bind(this),i,"GET_VALUE"),this.findProviders=wP(this.findProviders.bind(this),i,"FIND_PROVIDERS"),this.findPeer=wP(this.findPeer.bind(this),i,"FIND_PEER"),this.getClosestPeers=wP(this.getClosestPeers.bind(this),i,"GET_CLOSEST_PEERS"),this.provide=wP(this.provide.bind(this),i,"PROVIDE"),this.put=wP(this.put.bind(this),i,"PUT_VALUE")}[Symbol.toStringTag]="@libp2p/kad-dht";[SI]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery","@libp2p/kad-dht"];[EI]=["@libp2p/identify","@libp2p/ping"];get[iI](){return this.dhtContentRouting}get[yI](){return this.dhtPeerRouting}get[gI](){return this}async onPeerConnect(e){if(this.log.trace("peer %p connected",e.id,e.multiaddrs),0===(e=this.peerInfoMapper(e)).multiaddrs.length)return void this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(e=>e.toString()));const t=AbortSignal.timeout(this.onPeerConnectTimeout);try{await this.routingTable.add(e.id,{signal:t})}catch(t){this.log.error("could not add %p to routing table - %e",e.id,t)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e,t){e!==this.getMode()||!0===t?.force?(await this.components.registrar.unhandle(this.protocol,t),e!==this.getMode()||!0===t?.force?"client"===e?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{signal:t?.signal,maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams})):this.log("already in %s mode",e)):this.log("already in %s mode",e)}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",{force:!0}),await wI(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await wI(this.querySelf))}async stop(){this.running=!1,await vI(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(e,t,s={}){yield*this.contentFetching.put(e,t,s)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async cancelReprovide(e,t){await this.providers.removeProvider(e,this.components.peerId,t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(e){this.routingTableRefresh.refreshTable(!0,e)}}var cx;function lx(e={}){return t=>new ax(t,e)}!function(e){e[e.SEND_QUERY=0]="SEND_QUERY",e[e.PEER_RESPONSE=1]="PEER_RESPONSE",e[e.FINAL_PEER=2]="FINAL_PEER",e[e.QUERY_ERROR=3]="QUERY_ERROR",e[e.PROVIDER=4]="PROVIDER",e[e.VALUE=5]="VALUE",e[e.ADD_PEER=6]="ADD_PEER",e[e.DIAL_PEER=7]="DIAL_PEER",e[e.PATH_ENDED=8]="PATH_ENDED"}(cx||(cx={}));let hx=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}},ux=class extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}},dx=class extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}};const px=Symbol.for("@libp2p/peer-discovery"),fx=Symbol.for("@libp2p/peer-id"),gx=Symbol.for("@libp2p/service-capabilities"),mx=Symbol.for("nodejs.util.inspect.custom");let yx=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[fx]=!0;toString(){return null==this.string&&(this.string=G.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Ue.createV1(114,this.multihash)}toJSON(){return this.toString()}equals(e){if(null==e)return!1;if(e instanceof Uint8Array)return a(this.multihash.bytes,e);if("string"==typeof e)return this.toString()===e;if(null!=e?.toMultihash()?.bytes)return a(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[mx](){return`PeerId(${this.toString()})`}},bx=class extends yx{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}},wx=class extends yx{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}},vx=class extends yx{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}};let Sx=class{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=ke.digest(Ge(this.url))}[mx](){return`PeerId(${this.url})`}[fx]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return Ue.createV1(2336,this.toMultihash())}toJSON(){return this.toString()}equals(e){return null!=e&&(e instanceof Uint8Array&&(e=Qe(e)),e.toString()===this.toString())}};const Ex=2336;function Dx(e,t){let s;if("1"!==e.charAt(0)&&"Q"!==e.charAt(0)){if(e.startsWith("k51qzi5uqu5")||e.startsWith("kzwfwjn5ji4")||e.startsWith("k2k4r8")||e.startsWith("bafz"))return function(e){if(null==e?.multihash||null==e.version||1===e.version&&114!==e.code&&e.code!==Ex)throw new ux("Supplied PeerID CID is invalid");if(e.code===Ex){const t=Qe(e.multihash.digest);return new Sx(new URL(t))}return _x(e.multihash)}(Ue.parse(e));throw new hx('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return s=Pe(G.decode(`z${e}`)),_x(s)}function _x(e){if(function(e){return e.code===Me.code}(e))return new bx({multihash:e});if(function(e){return e.code===ke.code}(e))try{const t=jo(e);if("Ed25519"===t.type)return new wx({multihash:e,publicKey:t});if("secp256k1"===t.type)return new vx({multihash:e,publicKey:t})}catch(t){const s=Qe(e.digest);return new Sx(new URL(s))}throw new dx("Supplied PeerID Multihash is invalid")}let Tx=class extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"},Ix=class extends Error{static name="ValidationError";name="ValidationError"},Cx=class extends Error{static name="InvalidParametersError";name="InvalidParametersError"},Px=class extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"};function xx(e){return t=>Qe(t,e)}function Ax(e){return t=>Ge(t,e)}function kx(e){return new DataView(e.buffer).getUint16(e.byteOffset).toString()}function Nx(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,"string"==typeof e?parseInt(e):e),new Uint8Array(t)}function Rx(e){const t=e.subarray(0,e.length-2),s=e.subarray(e.length-2);return`${Qe(t,"base32")}:${kx(s)}`}const Mx=function(e){e=e.toString().trim();const t=new Uint8Array(4);return e.split(/\./g).forEach((e,s)=>{const r=parseInt(e,10);if(isNaN(r)||r<0||r>255)throw new Tx("Invalid byte value in IP address");t[s]=r}),t};const Lx=Object.values(qe).map(e=>e.decoder),Ox=function(){let e=Lx[0].or(Lx[1]);return Lx.slice(2).forEach(t=>e=e.or(t)),e}();const Bx=function(...e){return t=>{for(const s of e)s(t)}}(function(e){if(parseInt(e).toString()!==e)throw new Ix("Value must be an integer")},function(e){if(e<0)throw new Ix("Value must be a positive integer, or zero")},function(e){return t=>{if(t>e)throw new Ix(`Value must be smaller than or equal to ${e}`)}}(65535)),Ux=-1;const Vx=new class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(t="string"==typeof e?this.protocolsByName.get(e):this.protocolsByCode.get(e),null==t)throw new Px(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);null!=t&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(e=>{this.protocolsByName.delete(e)}))}},Fx=[{code:4,name:"ip4",size:32,valueToBytes:Mx,bytesToValue:function(e){if(4!==e.byteLength)throw new Tx("IPv4 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s++)t.push(e[s]);return t.join(".")},validate:e=>{if(!gc(e))throw new Ix(`Invalid IPv4 address "${e}"`)}},{code:6,name:"tcp",size:16,valueToBytes:Nx,bytesToValue:kx,validate:Bx},{code:273,name:"udp",size:16,valueToBytes:Nx,bytesToValue:kx,validate:Bx},{code:33,name:"dccp",size:16,valueToBytes:Nx,bytesToValue:kx,validate:Bx},{code:41,name:"ip6",size:128,valueToBytes:function(e){let t=0;const s=(e=e.toString().trim()).split(":",8);let r;for(r=0;r<s.length;r++){let e;gc(s[r])&&(e=Mx(s[r]),s[r]=Qe(e.subarray(0,2),"base16")),null!=e&&++r<8&&s.splice(r,0,Qe(e.subarray(2,4),"base16"))}if(""===s[0])for(;s.length<8;)s.unshift("0");else if(""===s[s.length-1])for(;s.length<8;)s.push("0");else if(s.length<8){for(r=0;r<s.length&&""!==s[r];r++);const e=[r,1];for(r=9-s.length;r>0;r--)e.push("0");s.splice.apply(s,e)}const n=new Uint8Array(t+16);for(r=0;r<s.length;r++){""===s[r]&&(s[r]="0");const e=parseInt(s[r],16);if(isNaN(e)||e<0||e>65535)throw new Tx("Invalid byte value in IP address");n[t++]=e>>8&255,n[t++]=255&e}return n},bytesToValue:function(e){if(16!==e.byteLength)throw new Tx("IPv6 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s+=2){const r=e[s],n=e[s+1],i=`${r.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}`;t.push(i)}const s=t.join(":");try{const e=new URL(`http://[${s}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new Tx(`Invalid IPv6 address "${s}"`)}},stringToValue:function(e){try{const t=new URL(`http://[${e}]`);return t.hostname.substring(1,t.hostname.length-1)}catch{throw new Tx(`Invalid IPv6 address "${e}"`)}},validate:e=>{if(!mc(e))throw new Ix(`Invalid IPv6 address "${e}"`)}},{code:42,name:"ip6zone",size:Ux},{code:43,name:"ipcidr",size:8,bytesToValue:xx("base10"),valueToBytes:Ax("base10")},{code:53,name:"dns",size:Ux},{code:54,name:"dns4",size:Ux},{code:55,name:"dns6",size:Ux},{code:56,name:"dnsaddr",size:Ux},{code:132,name:"sctp",size:16,valueToBytes:Nx,bytesToValue:kx,validate:Bx},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:Ux,stringToValue:e=>decodeURIComponent(e),valueToString:e=>encodeURIComponent(e)},{code:421,name:"p2p",aliases:["ipfs"],size:Ux,bytesToValue:xx("base58btc"),valueToBytes:e=>e.startsWith("Q")||e.startsWith("1")?Ax("base58btc")(e):Ue.parse(e).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:Rx,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const s=Ge(t[0],"base32"),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=Nx(r);return u([s,n],s.length+n.length)}},{code:445,name:"onion3",size:296,bytesToValue:Rx,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const s=L.decode(`b${t[0]}`),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=Nx(r);return u([s,n],s.length+n.length)}},{code:446,name:"garlic64",size:Ux},{code:447,name:"garlic32",size:Ux},{code:448,name:"tls"},{code:449,name:"sni",size:Ux},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:Ux,bytesToValue:function(e){return t=>e.encoder.encode(t)}(Z),valueToBytes:function(e){return Ox.decode(e)}},{code:480,name:"http"},{code:481,name:"http-path",size:Ux,stringToValue:e=>`/${decodeURIComponent(e)}`,valueToString:e=>encodeURIComponent(e.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:Ux}];function zx(e,t,s){return null==e.size||0===e.size?0:e.size>0?e.size/8:Ci(t,s)}Fx.forEach(e=>{Vx.addProtocol(e)});const $x=Symbol.for("nodejs.util.inspect.custom"),qx=Symbol.for("@multiformats/multiaddr");function Wx(e){if(null==e&&(e="/"),function(e){return Boolean(e?.[qx])}(e))return e.getComponents();if(e instanceof Uint8Array)return function(e){const t=[];let s=0;for(;s<e.length;){const r=Ci(e,s),n=Vx.getProtocol(r),i=Di(r),o=zx(n,e,s+i);let a=0;o>0&&n.size===Ux&&(a=Di(o));const c=i+a+o,l={code:r,name:n.name,bytes:e.subarray(s,s+c)};if(o>0){const t=s+i+a,r=e.subarray(t,t+o);l.value=n.bytesToValue?.(r)??Qe(r)}t.push(l),s+=c}return t}(e);if("string"==typeof e)return""===(e=e.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""))&&(e="/"),function(e){if("/"!==e.charAt(0))throw new Tx('String multiaddr must start with "/"');const t=[];let s="protocol",r="",n="";for(let i=1;i<e.length;i++){const o=e.charAt(i);"/"!==o&&("protocol"===s?n+=e.charAt(i):r+=e.charAt(i));const a=i===e.length-1;if("/"===o||a){const e=Vx.getProtocol(n);if("protocol"===s){if(null==e.size||0===e.size){t.push({code:e.code,name:e.name}),r="",n="",s="protocol";continue}if(a)throw new Tx(`Component ${n} was missing value`);s="value"}else if("value"===s){const i={code:e.code,name:e.name};if(null!=e.size&&0!==e.size){if(""===r)throw new Tx(`Component ${n} was missing value`);i.value=e.stringToValue?.(r)??r}t.push(i),r="",n="",s="protocol"}}}if(""!==n&&""!==r)throw new Tx("Incomplete multiaddr");return t}(e);if(Array.isArray(e))return e;throw new Tx("Must be a string, Uint8Array, Component[], or another Multiaddr")}let Kx=class e{[qx]=!0;#L;#O;#B;constructor(e="/",t={}){this.#L=Wx(e),!1!==t.validate&&function(e){e.getComponents().forEach(e=>{const t=Vx.getProtocol(e.code);null!=e.value&&t.validate?.(e.value)})}(this)}get bytes(){return null==this.#B&&(this.#B=function(e){let t=0;const s=[];for(const r of e){if(null==r.bytes){const e=Vx.getProtocol(r.code),t=Di(r.code);let s,n=0,i=0;null!=r.value&&(s=e.valueToBytes?.(r.value)??Ge(r.value),n=s.byteLength,e.size===Ux&&(i=Di(n)));const o=new Uint8Array(t+i+n);let a=0;_i(r.code,o,a),a+=t,null!=s&&(e.size===Ux&&(_i(n,o,a),a+=i),o.set(s,a)),r.bytes=o}s.push(r.bytes),t+=r.bytes.byteLength}return u(s,t)}(this.#L)),this.#B}toString(){return null==this.#O&&(this.#O=`/${this.#L.flatMap(e=>{if(null==e.value)return e.name;const t=Vx.getProtocol(e.code);if(null==t)throw new Tx(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`),this.#O}toJSON(){return this.toString()}getComponents(){return[...this.#L.map(e=>({...e}))]}encapsulate(t){const s=new e(t);return new e([...this.#L,...s.getComponents()],{validate:!1})}decapsulate(t){const s=t.toString(),r=this.toString(),n=r.lastIndexOf(s);if(n<0)throw new Cx(`Address ${this.toString()} does not contain subaddress: ${s}`);return new e(r.slice(0,n),{validate:!1})}decapsulateCode(t){let s;for(let e=this.#L.length-1;e>-1;e--)if(this.#L[e].code===t){s=e;break}return new e(this.#L.slice(0,s),{validate:!1})}equals(e){return a(this.bytes,e.bytes)}[$x](){return`Multiaddr(${this.toString()})`}};class jx extends ns{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(null==t.list||0===t.list.length)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??1e3,this.list=t.list.map(e=>new Kx(e)).filter(e=>{if(!Em.matches(e))return this.log.error("invalid multiaddr %a",e),!1;const t=e.getComponents().findLast(e=>421===e.code)?.value;return null!=t||(this.log.error("invalid bootstrap multiaddr without peer id"),!1)}).map(e=>({id:Dx(e.getComponents().findLast(e=>421===e.code)?.value??""),multiaddrs:[e]})),this._init=t}[px]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[gx]=["@libp2p/peer-discovery"];isStarted(){return Boolean(this.timer)}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error("failed to discover bootstrap peers - %e",e)})},this.timeout))}async _discoverBootstrapPeers(){if(null!=this.timer)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??"bootstrap"]:{value:this._init.tagValue??50,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),null==this.timer)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p - %e",e.id,t)})}}stop(){null!=this.timer&&clearTimeout(this.timer),this.timer=void 0}}function Hx(e){return t=>new jx(t,e)}let Gx=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};class Qx extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}}class Xx extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}}class Yx extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}}class Jx extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}}const Zx=Symbol.for("@libp2p/peer-id"),eA=Symbol.for("@libp2p/service-capabilities");function tA(e){const t=e.getComponents(),s={};let r=0;if("ip6zone"===t[r]?.name&&(s.zone=`${t[r].value}`,r++),"ip4"===t[r].name||"ip6"===t[r].name||"dns"===t[r].name||"dns4"===t[r].name||"dns6"===t[r].name?(s.type=t[r].name,s.host=t[r].value,r++):"dnsaddr"===t[r].name&&(s.type=t[r].name,s.host=`_dnsaddr.${t[r].value}`,r++),"tcp"!==t[r]?.name&&"udp"!==t[r]?.name||(s.protocol="tcp"===t[r].name?"tcp":"udp",s.port=parseInt(`${t[r].value}`),r++),"ipcidr"===t[r]?.name&&("ip4"===s.type?s.cidr=parseInt(`${t[r].value}`):"ip6"===s.type&&(s.cidr=`${t[r].value}`),r++),null==s.type||null==s.host)throw new Gx(`Multiaddr ${e} was not an IPv4, IPv6, DNS, DNS4, DNS6 or DNSADDR address`);return"tls"===t[r]?.name&&"sni"===t[r+1]?.name&&(s.sni=t[r+1].value,r+=2),s}function sA(e){try{const r=tA(e);return"ip6"===r.type&&(t="2000::/3",s=r.host,new $c(t).contains(s))}catch{return!1}var t,s}const rA=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"].map(e=>new lu(e));function nA(e){for(const t of rA)if(t.contains(e))return!0;return!1}function iA(e){return gc(e)?nA(e):/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(e)?function(e){const t=e.split(":");if(t.length<2)return!1;const s=t[t.length-1].padStart(4,"0"),r=t[t.length-2].padStart(4,"0");return nA(`${parseInt(r.substring(0,2),16)}.${parseInt(r.substring(2),16)}.${parseInt(s.substring(0,2),16)}.${parseInt(s.substring(2),16)}`)}(e):function(e){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)}(e)?function(e){const t=e.split(":");return nA(t[t.length-1])}(e):mc(e)?function(e){return/^::$/.test(e)||/^::1$/.test(e)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(e)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(e)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(e)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(e)||/^ff([0-9a-fA-F]{2,2}):/i.test(e)}(e):void 0}class oA extends Error{static name="UnexpectedEOFError";name="UnexpectedEOFError"}function aA(e){return e.reason}async function cA(e,t,s){if(null==t)return e;const r=aA;if(t.aborted)return e.catch(()=>{}),Promise.reject(r(t));let n;try{return await Promise.race([e,new Promise((e,s)=>{n=()=>{s(r(t))},t.addEventListener("abort",n)})])}finally{null!=n&&t.removeEventListener("abort",n)}}class lA extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"}let hA=class extends Error{static name="ValidationError";name="ValidationError"};class uA extends Error{static name="InvalidParametersError";name="InvalidParametersError"}class dA extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"}function pA(e){return t=>Qe(t,e)}function fA(e){return t=>Ge(t,e)}function gA(e){return new DataView(e.buffer).getUint16(e.byteOffset).toString()}function mA(e){const t=new ArrayBuffer(2);return new DataView(t).setUint16(0,"string"==typeof e?parseInt(e):e),new Uint8Array(t)}function yA(e){const t=e.subarray(0,e.length-2),s=e.subarray(e.length-2);return`${Qe(t,"base32")}:${gA(s)}`}const bA=function(e){e=e.toString().trim();const t=new Uint8Array(4);return e.split(/\./g).forEach((e,s)=>{const r=parseInt(e,10);if(isNaN(r)||r<0||r>255)throw new lA("Invalid byte value in IP address");t[s]=r}),t};const wA=Object.values(qe).map(e=>e.decoder),vA=function(){let e=wA[0].or(wA[1]);return wA.slice(2).forEach(t=>e=e.or(t)),e}();const SA=function(...e){return t=>{for(const s of e)s(t)}}(function(e){if(parseInt(e).toString()!==e)throw new hA("Value must be an integer")},function(e){if(e<0)throw new hA("Value must be a positive integer, or zero")},function(e){return t=>{if(t>e)throw new hA(`Value must be smaller than or equal to ${e}`)}}(65535)),EA=-1;const DA=new class{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(t="string"==typeof e?this.protocolsByName.get(e):this.protocolsByCode.get(e),null==t)throw new dA(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);null!=t&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(e=>{this.protocolsByName.delete(e)}))}},_A=[{code:4,name:"ip4",size:32,valueToBytes:bA,bytesToValue:function(e){if(4!==e.byteLength)throw new lA("IPv4 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s++)t.push(e[s]);return t.join(".")},validate:e=>{if(!gc(e))throw new hA(`Invalid IPv4 address "${e}"`)}},{code:6,name:"tcp",size:16,valueToBytes:mA,bytesToValue:gA,validate:SA},{code:273,name:"udp",size:16,valueToBytes:mA,bytesToValue:gA,validate:SA},{code:33,name:"dccp",size:16,valueToBytes:mA,bytesToValue:gA,validate:SA},{code:41,name:"ip6",size:128,valueToBytes:function(e){let t=0;const s=(e=e.toString().trim()).split(":",8);let r;for(r=0;r<s.length;r++){let e;gc(s[r])&&(e=bA(s[r]),s[r]=Qe(e.subarray(0,2),"base16")),null!=e&&++r<8&&s.splice(r,0,Qe(e.subarray(2,4),"base16"))}if(""===s[0])for(;s.length<8;)s.unshift("0");else if(""===s[s.length-1])for(;s.length<8;)s.push("0");else if(s.length<8){for(r=0;r<s.length&&""!==s[r];r++);const e=[r,1];for(r=9-s.length;r>0;r--)e.push("0");s.splice.apply(s,e)}const n=new Uint8Array(t+16);for(r=0;r<s.length;r++){""===s[r]&&(s[r]="0");const e=parseInt(s[r],16);if(isNaN(e)||e<0||e>65535)throw new lA("Invalid byte value in IP address");n[t++]=e>>8&255,n[t++]=255&e}return n},bytesToValue:function(e){if(16!==e.byteLength)throw new lA("IPv6 address was incorrect length");const t=[];for(let s=0;s<e.byteLength;s+=2){const r=e[s],n=e[s+1],i=`${r.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}`;t.push(i)}const s=t.join(":");try{const e=new URL(`http://[${s}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new lA(`Invalid IPv6 address "${s}"`)}},stringToValue:function(e){try{const t=new URL(`http://[${e}]`);return t.hostname.substring(1,t.hostname.length-1)}catch{throw new lA(`Invalid IPv6 address "${e}"`)}},validate:e=>{if(!mc(e))throw new hA(`Invalid IPv6 address "${e}"`)}},{code:42,name:"ip6zone",size:EA},{code:43,name:"ipcidr",size:8,bytesToValue:pA("base10"),valueToBytes:fA("base10")},{code:53,name:"dns",size:EA},{code:54,name:"dns4",size:EA},{code:55,name:"dns6",size:EA},{code:56,name:"dnsaddr",size:EA},{code:132,name:"sctp",size:16,valueToBytes:mA,bytesToValue:gA,validate:SA},{code:301,name:"udt"},{code:302,name:"utp"},{code:400,name:"unix",size:EA,stringToValue:e=>decodeURIComponent(e),valueToString:e=>encodeURIComponent(e)},{code:421,name:"p2p",aliases:["ipfs"],size:EA,bytesToValue:pA("base58btc"),valueToBytes:e=>e.startsWith("Q")||e.startsWith("1")?fA("base58btc")(e):Ue.parse(e).multihash.bytes},{code:444,name:"onion",size:96,bytesToValue:yA,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(16!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion address.`);const s=Ge(t[0],"base32"),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=mA(r);return u([s,n],s.length+n.length)}},{code:445,name:"onion3",size:296,bytesToValue:yA,valueToBytes:function(e){const t=e.split(":");if(2!==t.length)throw new Error(`failed to parse onion addr: ["'${t.join('", "')}'"]' does not contain a port number`);if(56!==t[0].length)throw new Error(`failed to parse onion addr: ${t[0]} not a Tor onion3 address.`);const s=L.decode(`b${t[0]}`),r=parseInt(t[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const n=mA(r);return u([s,n],s.length+n.length)}},{code:446,name:"garlic64",size:EA},{code:447,name:"garlic32",size:EA},{code:448,name:"tls"},{code:449,name:"sni",size:EA},{code:454,name:"noise"},{code:460,name:"quic"},{code:461,name:"quic-v1"},{code:465,name:"webtransport"},{code:466,name:"certhash",size:EA,bytesToValue:function(e){return t=>e.encoder.encode(t)}(Z),valueToBytes:function(e){return vA.decode(e)}},{code:480,name:"http"},{code:481,name:"http-path",size:EA,stringToValue:e=>`/${decodeURIComponent(e)}`,valueToString:e=>encodeURIComponent(e.substring(1))},{code:443,name:"https"},{code:477,name:"ws"},{code:478,name:"wss"},{code:479,name:"p2p-websocket-star"},{code:277,name:"p2p-stardust"},{code:275,name:"p2p-webrtc-star"},{code:276,name:"p2p-webrtc-direct"},{code:280,name:"webrtc-direct"},{code:281,name:"webrtc"},{code:290,name:"p2p-circuit"},{code:777,name:"memory",size:EA}];function TA(e,t,s){return null==e.size||0===e.size?0:e.size>0?e.size/8:Ci(t,s)}_A.forEach(e=>{DA.addProtocol(e)});const IA=Symbol.for("nodejs.util.inspect.custom"),CA=Symbol.for("@multiformats/multiaddr");function PA(e){if(null==e&&(e="/"),function(e){return Boolean(e?.[CA])}(e))return e.getComponents();if(e instanceof Uint8Array)return function(e){const t=[];let s=0;for(;s<e.length;){const r=Ci(e,s),n=DA.getProtocol(r),i=Di(r),o=TA(n,e,s+i);let a=0;o>0&&n.size===EA&&(a=Di(o));const c=i+a+o,l={code:r,name:n.name,bytes:e.subarray(s,s+c)};if(o>0){const t=s+i+a,r=e.subarray(t,t+o);l.value=n.bytesToValue?.(r)??Qe(r)}t.push(l),s+=c}return t}(e);if("string"==typeof e)return""===(e=e.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""))&&(e="/"),function(e){if("/"!==e.charAt(0))throw new lA('String multiaddr must start with "/"');const t=[];let s="protocol",r="",n="";for(let i=1;i<e.length;i++){const o=e.charAt(i);"/"!==o&&("protocol"===s?n+=e.charAt(i):r+=e.charAt(i));const a=i===e.length-1;if("/"===o||a){const e=DA.getProtocol(n);if("protocol"===s){if(null==e.size||0===e.size){t.push({code:e.code,name:e.name}),r="",n="",s="protocol";continue}if(a)throw new lA(`Component ${n} was missing value`);s="value"}else if("value"===s){const i={code:e.code,name:e.name};if(null!=e.size&&0!==e.size){if(""===r)throw new lA(`Component ${n} was missing value`);i.value=e.stringToValue?.(r)??r}t.push(i),r="",n="",s="protocol"}}}if(""!==n&&""!==r)throw new lA("Incomplete multiaddr");return t}(e);if(Array.isArray(e))return e;throw new lA("Must be a string, Uint8Array, Component[], or another Multiaddr")}class xA{[CA]=!0;#L;#O;#B;constructor(e="/",t={}){this.#L=PA(e),!1!==t.validate&&function(e){e.getComponents().forEach(e=>{const t=DA.getProtocol(e.code);null!=e.value&&t.validate?.(e.value)})}(this)}get bytes(){return null==this.#B&&(this.#B=function(e){let t=0;const s=[];for(const r of e){if(null==r.bytes){const e=DA.getProtocol(r.code),t=Di(r.code);let s,n=0,i=0;null!=r.value&&(s=e.valueToBytes?.(r.value)??Ge(r.value),n=s.byteLength,e.size===EA&&(i=Di(n)));const o=new Uint8Array(t+i+n);let a=0;_i(r.code,o,a),a+=t,null!=s&&(e.size===EA&&(_i(n,o,a),a+=i),o.set(s,a)),r.bytes=o}s.push(r.bytes),t+=r.bytes.byteLength}return u(s,t)}(this.#L)),this.#B}toString(){return null==this.#O&&(this.#O=`/${this.#L.flatMap(e=>{if(null==e.value)return e.name;const t=DA.getProtocol(e.code);if(null==t)throw new lA(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`),this.#O}toJSON(){return this.toString()}getComponents(){return[...this.#L.map(e=>({...e}))]}encapsulate(e){const t=new xA(e);return new xA([...this.#L,...t.getComponents()],{validate:!1})}decapsulate(e){const t=e.toString(),s=this.toString(),r=s.lastIndexOf(t);if(r<0)throw new uA(`Address ${this.toString()} does not contain subaddress: ${t}`);return new xA(s.slice(0,r),{validate:!1})}decapsulateCode(e){let t;for(let s=this.#L.length-1;s>-1;s--)if(this.#L[s].code===e){t=s;break}return new xA(this.#L.slice(0,t),{validate:!1})}equals(e){return a(this.bytes,e.bytes)}[IA](){return`Multiaddr(${this.toString()})`}}function AA(e){return new xA(e)}class kA extends Error{static name="UnwrappedError";name="UnwrappedError"}class NA extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"}class RA extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}class MA extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}function LA(e){return function(e){return"function"==typeof e?.closeRead}(e)?"writable"!==e.remoteWriteStatus&&0===e.readBufferLength:!!function(e){return"function"==typeof e?.close}(e)&&"open"!==e.status}function OA(e,t={}){const s=function(e,t){const s=t?.maxBufferSize??4194304,r=new cs;let n,i=!1;if(o=e,null==o?.addEventListener||null==o?.removeEventListener||null==o?.send||null==o?.push||null==o?.log)throw new Gx("Argument should be a Stream or a Multiaddr");var o;const a=e=>{if(r.append(e.data),r.byteLength>s){const e=r.byteLength;r.consume(r.byteLength),n?.reject(new Error(`Read buffer overflow - ${e} > ${s}`))}n?.resolve()};e.addEventListener("message",a);const c=e=>{null!=e.error?n?.reject(e.error):n?.resolve()};e.addEventListener("close",c);const l=()=>{n?.resolve()};e.addEventListener("remoteCloseWrite",l);const h={readBuffer:r,async read(t){if(!0===i)throw new kA("Stream was unwrapped");if(LA(e)){if(null==t?.bytes)return null;if(r.byteLength<t.bytes)throw e.log.error("closed after reading %d/%d bytes",r.byteLength,t.bytes),new oA(`Unexpected EOF - stream closed after reading ${r.byteLength}/${t.bytes} bytes`)}const s=t?.bytes??1;for(n=Promise.withResolvers();;){if(r.byteLength>=s){n.resolve();break}if(await cA(n.promise,t?.signal),LA(e)){if(0===r.byteLength&&null==t?.bytes)return null;break}n=Promise.withResolvers()}const o=t?.bytes??r.byteLength;if(r.byteLength<o){if(LA(e))throw e.log.error("closed while reading %d/%d bytes",r.byteLength,o),new oA(`Unexpected EOF - stream closed while reading ${r.byteLength}/${o} bytes`);return h.read(t)}const a=r.sublist(0,o);return r.consume(o),a},async write(t,s){if(!0===i)throw new kA("Stream was unwrapped");e.send(t)||await Nm(e,"drain",{signal:s?.signal,rejectionEvents:["close"]})},unwrap:()=>(i||(i=!0,e.removeEventListener("message",a),e.removeEventListener("close",c),e.removeEventListener("remoteCloseWrite",l),r.byteLength>0&&(e.log("stream unwrapped with %d unread bytes",r.byteLength),e.push(r))),e)};return h}(e,t);null!=t.maxDataLength&&null==t.maxLengthLength&&(t.maxLengthLength=Di(t.maxDataLength));const r=t?.lengthDecoder??Ci,n=t?.lengthEncoder??Ii;return{async read(n){let i=-1;const o=new cs;for(;;){const e=await s.read({...n,bytes:1});if(null==e)break;o.append(e);try{i=r(o)}catch(e){if(e instanceof RangeError)continue;throw e}if(i<0)throw new NA("Invalid message length");if(null!=t?.maxLengthLength&&o.byteLength>t.maxLengthLength)throw new MA(`Message length length too long - ${o.byteLength} > ${t.maxLengthLength}`);if(i>-1)break}if(null!=t?.maxDataLength&&i>t.maxDataLength)throw new RA(`Message length too long - ${i} > ${t.maxDataLength}`);const a=await s.read({...n,bytes:i});if(null==a)throw e.log.error("tried to read %d bytes but the stream closed",i),new oA(`Unexpected EOF - tried to read ${i} bytes but the stream closed`);if(a.byteLength!==i)throw e.log.error("read %d/%d bytes before the stream closed",a.byteLength,i),new oA(`Unexpected EOF - read ${a.byteLength}/${i} bytes before the stream closed`);return a},async write(e,t){await s.write(new cs(n(e.byteLength),e),t)},async writeV(e,t){const r=new cs(...e.flatMap(e=>[n(e.byteLength),e]));await s.write(r,t)},unwrap:()=>s.unwrap()}}function BA(e,t){const s=OA(e,t),r={read:async(e,t)=>{const r=await s.read(t);return e.decode(r)},write:async(e,t,r)=>{await s.write(t.encode(e),r)},writeV:async(e,t,r)=>{await s.writeV(e.map(e=>t.encode(e)),r)},pb:e=>({read:async t=>r.read(e,t),write:async(t,s)=>r.write(t,e,s),writeV:async(t,s)=>r.writeV(t,e,s),unwrap:()=>r}),unwrap:()=>s.unwrap()};return r}var UA;!function(e){let t;e.codec=()=>(null==t&&(t=uo((e,t,s={})=>{if(!1!==s.lengthDelimited&&t.fork(),null!=e.protocolVersion&&(t.uint32(42),t.string(e.protocolVersion)),null!=e.agentVersion&&(t.uint32(50),t.string(e.agentVersion)),null!=e.publicKey&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.listenAddrs)for(const s of e.listenAddrs)t.uint32(18),t.bytes(s);if(null!=e.observedAddr&&(t.uint32(34),t.bytes(e.observedAddr)),null!=e.protocols)for(const s of e.protocols)t.uint32(26),t.string(s);null!=e.signedPeerRecord&&(t.uint32(66),t.bytes(e.signedPeerRecord)),!1!==s.lengthDelimited&&t.ldelim()},(e,t,s={})=>{const r={listenAddrs:[],protocols:[]},n=null==t?e.len:e.pos+t;for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 5:r.protocolVersion=e.string();break;case 6:r.agentVersion=e.string();break;case 1:r.publicKey=e.bytes();break;case 2:if(null!=s.limits?.listenAddrs&&r.listenAddrs.length===s.limits.listenAddrs)throw new po('Decode error - map field "listenAddrs" had too many elements');r.listenAddrs.push(e.bytes());break;case 4:r.observedAddr=e.bytes();break;case 3:if(null!=s.limits?.protocols&&r.protocols.length===s.limits.protocols)throw new po('Decode error - map field "protocols" had too many elements');r.protocols.push(e.string());break;case 8:r.signedPeerRecord=e.bytes();break;default:e.skipType(7&t)}}return r})),t),e.encode=t=>ro(t,e.codec()),e.decode=(t,s)=>qi(t,e.codec(),s)}(UA||(UA={}));const VA=Symbol.for("nodejs.util.inspect.custom");class FA{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[Zx]=!0;toString(){return null==this.string&&(this.string=G.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Ue.createV1(114,this.multihash)}toJSON(){return this.toString()}equals(e){if(null==e)return!1;if(e instanceof Uint8Array)return a(this.multihash.bytes,e);if("string"==typeof e)return this.toString()===e;if(null!=e?.toMultihash()?.bytes)return a(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[VA](){return`PeerId(${this.toString()})`}}class zA extends FA{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}}class $A extends FA{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}}class qA extends FA{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}}class WA{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=ke.digest(Ge(this.url))}[VA](){return`PeerId(${this.url})`}[Zx]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return Ue.createV1(2336,this.toMultihash())}toJSON(){return this.toString()}equals(e){return null!=e&&(e instanceof Uint8Array&&(e=Qe(e)),e.toString()===this.toString())}}function KA(e){if(function(e){return e.code===Me.code}(e))return new zA({multihash:e});if(function(e){return e.code===ke.code}(e))try{const t=jo(e);if("Ed25519"===t.type)return new $A({multihash:e,publicKey:t});if("secp256k1"===t.type)return new qA({multihash:e,publicKey:t})}catch(t){const s=Qe(e.digest);return new WA(new URL(s))}throw new Xx("Supplied PeerID Multihash is invalid")}function jA(e){if(null==e?.multihash||null==e.version||1===e.version&&114!==e.code&&2336!==e.code)throw new Qx("Supplied PeerID CID is invalid");if(2336===e.code){const t=Qe(e.multihash.digest);return new WA(new URL(t))}return KA(e.multihash)}const HA={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:8192,runOnConnectionOpen:!0,runOnLimitedConnection:!0};async function GA(e,t,s,r,n){if(s("received identify from %p",r.remotePeer),null==n)throw new Yx("message was null or undefined");const i={};if(n.listenAddrs.length>0&&(i.addresses=n.listenAddrs.map(e=>({isCertified:!1,multiaddr:AA(e)}))),n.protocols.length>0&&(i.protocols=n.protocols),null!=n.publicKey){const e=Ko(n.publicKey),t=function(e){if("Ed25519"===e.type)return new $A({multihash:e.toCID().multihash,publicKey:e});if("secp256k1"===e.type)return new qA({multihash:e.toCID().multihash,publicKey:e});if("RSA"===e.type)return new zA({multihash:e.toCID().multihash,publicKey:e});throw new Jx}(e);if(!t.equals(r.remotePeer))throw new Yx("public key did not match remote PeerId");i.publicKey=e}let o;if(null!=n.signedPeerRecord){s.trace("received signedPeerRecord from %p",r.remotePeer);let t=n.signedPeerRecord;const a=await zS.openAndCertify(t,SE.DOMAIN);let c=SE.createFromProtobuf(a.payload);const l=jA(a.publicKey.toCID());if(!c.peerId.equals(l))throw new Yx("signing key does not match PeerId in the PeerRecord");if(!r.remotePeer.equals(c.peerId))throw new Yx("signing key does not match remote PeerId");let h;try{h=await e.get(c.peerId)}catch(e){if("NotFoundError"!==e.name)throw e}if(null!=h&&(i.metadata=h.metadata,null!=h.peerRecordEnvelope)){const e=zS.createFromProtobuf(h.peerRecordEnvelope),r=SE.createFromProtobuf(e.payload);r.seqNumber>=c.seqNumber&&(s("sequence number was lower or equal to existing sequence number - stored: %d received: %d",r.seqNumber,c.seqNumber),c=r,t=h.peerRecordEnvelope)}i.peerRecordEnvelope=t,i.addresses=c.multiaddrs.map(e=>({isCertified:!0,multiaddr:e})),o={seq:c.seqNumber,addresses:c.multiaddrs}}else s("%p did not send a signed peer record",r.remotePeer);if(s.trace("patching %p with",r.remotePeer,i),await e.patch(r.remotePeer,i),null!=n.agentVersion||null!=n.protocolVersion){const t={};null!=n.agentVersion&&(t.AgentVersion=Ge(n.agentVersion)),null!=n.protocolVersion&&(t.ProtocolVersion=Ge(n.protocolVersion)),s.trace("merging %p metadata",r.remotePeer,t),await e.merge(r.remotePeer,{metadata:t})}const a={peerId:r.remotePeer,protocolVersion:n.protocolVersion,agentVersion:n.agentVersion,publicKey:n.publicKey,listenAddrs:n.listenAddrs.map(e=>AA(e)),observedAddr:null==n.observedAddr?void 0:AA(n.observedAddr),protocols:n.protocols,signedPeerRecord:o,connection:r};return t.safeDispatchEvent("peer:identify",{detail:a}),a}class QA{host;components;protocol;started;timeout;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.components=e,this.log=t.log,this.timeout=t.timeout??HA.timeout,this.maxInboundStreams=t.maxInboundStreams??HA.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??HA.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??HA.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??HA.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??HA.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??HA.protocolPrefix}/0.1.0`,agentVersion:e.nodeInfo.userAgent},this.handleProtocol=this.handleProtocol.bind(this)}isStarted(){return this.started}async start(){this.started||(await this.components.peerStore.merge(this.components.peerId,{metadata:{AgentVersion:Ge(this.host.agentVersion),ProtocolVersion:Ge(this.host.protocolVersion)}}),await this.components.registrar.handle(this.protocol,this.handleProtocol,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}}class XA extends QA{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??HA.protocolPrefix}/id/1.0.0`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??HA.runOnConnectionOpen)&&e.events.addEventListener("connection:open",e=>{const t=e.detail;this.identify(t).catch(()=>{})})}[eA]=["@libp2p/identify"];async _identify(e,t={}){let s,r;if(null==t.signal){const e=AbortSignal.timeout(this.timeout);t={...t,signal:e}}this.log("run identify on new connection %a",e.remoteAddr);try{s=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection}),r=s.log.newScope("identify");const n=BA(s,{maxDataLength:this.maxMessageSize}).pb(UA),i=await n.read(t);return await n.unwrap().unwrap().close(t),i}catch(e){throw r?.error("identify failed - %e",e),s?.abort(e),e}}async identify(e,t={}){const s=await this._identify(e,t),{publicKey:r,protocols:n,observedAddr:i}=s;if(null==r)throw new Yx("Public key was missing from identify message");const o=jA(Ko(r).toCID());if(!e.remotePeer.equals(o))throw new Yx("Identified peer does not match the expected peer");if(this.components.peerId.equals(o))throw new Yx("Identified peer is our own peer id?");return this.maybeAddObservedAddress(i),this.log("completed for peer %p and protocols %o",o,n),GA(this.components.peerStore,this.components.events,this.log,e,s)}maybeAddObservedAddress(e){const t=function(e){if(null!=e&&e.length>0)try{return AA(e)}catch{}}(e);if(null==t)return;if(this.log.trace("our observed address was %a",t),function(e){try{const t=tA(e);switch(t.type){case"ip4":case"ip6":return iA(t.host)??!1;default:return"localhost"===t.host}}catch{return!1}}(t))return;const s=t.getComponents();41!==s[0].code&&(42!==s[0].code||41!==s[1].code)||sA(t)?hm.exactMatch(t)||(this.log.trace("storing the observed address"),this.components.addressManager.addObservedAddr(t)):this.log.trace("our observed address was IPv6 but not a global unicast address")}async handleProtocol(e,t){const s=e.log.newScope("identify");s("responding to identify");const r=AbortSignal.timeout(this.timeout),n=await this.components.peerStore.get(this.components.peerId,{signal:r}),i=this.components.addressManager.getAddresses().map(e=>e.decapsulateCode(421));let o=n.peerRecordEnvelope;if(i.length>0&&null==o){const e=new SE({peerId:this.components.peerId,multiaddrs:i});o=(await zS.seal(e,this.components.privateKey,{signal:r})).marshal().subarray()}let a=t.remoteAddr.bytes;am.matches(t.remoteAddr)||(a=void 0);const c=BA(e).pb(UA);s("send response"),await c.write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:Ho(this.components.privateKey.publicKey),listenAddrs:i.map(e=>e.bytes),signedPeerRecord:o,observedAddr:a,protocols:n.protocols},{signal:r}),s("close write"),await c.unwrap().unwrap().close({signal:r})}}function YA(e={}){return t=>new XA(t,e)}class JA extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}}class ZA extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}}const ek=Symbol.for("@libp2p/service-capabilities");function tk(e){return e.reason}class sk{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;constructor(e,t={}){this.components=e,this.started=!1,this.protocol=`/${t.protocolPrefix??"ipfs"}/ping/1.0.0`,this.timeout=t.timeout??1e4,this.maxInboundStreams=t.maxInboundStreams??2,this.maxOutboundStreams=t.maxOutboundStreams??1,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handlePing=this.handlePing.bind(this)}[Symbol.toStringTag]="@libp2p/ping";[ek]=["@libp2p/ping"];async start(){await this.components.registrar.handle(this.protocol,this.handlePing,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}async handlePing(e,t){const s=e.log.newScope("ping");s.trace("ping from %p",t.remotePeer);const r=AbortSignal.timeout(this.timeout);r.addEventListener("abort",()=>{e.abort(new ZA("Ping timed out"))});const n=Date.now();for await(const t of e){if("open"!==e.status){s("stream status changed to %s",e.status);break}e.send(t)||(s("waiting for stream to drain"),await Nm(e,"drain",{rejectionEvents:["close"],signal:r}),s("stream drained"))}s("ping from %p complete in %dms",t.remotePeer,Date.now()-n),await e.close({signal:r})}async ping(e,t={}){const s=go(32),r=await this.components.connectionManager.openStream(e,this.protocol,{runOnLimitedConnection:this.runOnLimitedConnection,...t}),n=r.log.newScope("ping");try{const e=Date.now(),n=Promise.withResolvers(),i=new cs,o=c=>{if(i.append(c.data),32===i.byteLength){r.removeEventListener("message",o);const c=Date.now()-e;Promise.all([r.closeRead(t)]).then(()=>{if(!a(s,i.subarray()))throw new JA(`Received wrong ping ack after ${c}ms`);n.resolve(c)}).catch(e=>{r.abort(e),n.reject(e)})}};return r.addEventListener("message",o),r.send(s),await r.close(t),await async function(e,t){if(null==t)return e;const s=tk;if(t.aborted)return e.catch(()=>{}),Promise.reject(s(t));let r;try{return await Promise.race([e,new Promise((e,n)=>{r=()=>{n(s(t))},t.addEventListener("abort",r)})])}finally{null!=r&&t.removeEventListener("abort",r)}}(n.promise,t.signal)}catch(t){throw n.error("error while pinging %o - %e",e,t),r?.abort(t),t}finally{r?.close()}}}function rk(e={}){return t=>new sk(t,e)}async function nk(e={}){const t=e.bootstrap||Xe;var s;return await async function(e={}){e.privateKey??=await Wo();const t=new Af({...await el(e),peerId:(s=e.privateKey,Aa(s.publicKey))});var s;return!1!==e.start&&await t.start(),t}({addresses:{listen:["/webrtc"]},transports:[(s={rtcConfiguration:{iceServers:[{urls:["stun:stun.l.google.com:19302"]},{urls:["stun:stun1.l.google.com:19302"]},{urls:["stun:stun2.l.google.com:19302"]},{urls:["stun:global.stun.twilio.com:3478"]}]}},e=>new ky(e,s)),lS(),JD({discoverRelays:1})],connectionEncryption:[fv()],streamMuxers:[$_()],peerDiscovery:t.length>0?[Hx({list:t,timeout:3e3})]:[],services:{identify:YA(),ping:rk(),pubsub:nI({...Ze,...e.gossipsub,allowPublishToZeroTopicPeers:!0}),dht:lx({clientMode:!0,protocolPrefix:"/konomi"})},connectionManager:{minConnections:e.minConnections||et.minConnections,maxConnections:e.maxConnections||et.maxConnections}})}class ik{constructor(e){this.libp2p=e,this._started=!1,this._eventHandlers=new Map}static async create(e={}){const t=await nk(e);return new ik(t)}async start(){this._started||(await this.libp2p.start(),this._started=!0,console.log("ðŸŒ P2P Node started:",this.peerId))}async stop(){this._started&&(await this.libp2p.stop(),this._started=!1)}get peerId(){return this.libp2p.peerId.toString()}get multiaddrs(){return this.libp2p.getMultiaddrs().map(e=>e.toString())}get pubsub(){return this.libp2p.services.pubsub}get dht(){return this.libp2p.services.dht}getConnectedPeers(){return this.libp2p.getPeers().map(e=>e.toString())}getConnections(){return this.libp2p.getConnections()}async dial(e){return this.libp2p.dial(e)}async hangUp(e){return this.libp2p.hangUp(e)}subscribe(e){this.pubsub.subscribe(e)}unsubscribe(e){this.pubsub.unsubscribe(e)}async publish(e,t){await this.pubsub.publish(e,t)}getSubscribers(e){return this.pubsub.getSubscribers(e).map(e=>e.toString())}getTopics(){return this.pubsub.getTopics()}on(e,t){switch(this._eventHandlers.has(e)||this._eventHandlers.set(e,new Set),this._eventHandlers.get(e).add(t),e){case"peer:connect":this.libp2p.addEventListener("peer:connect",t);break;case"peer:disconnect":this.libp2p.addEventListener("peer:disconnect",t);break;case"peer:discovery":this.libp2p.addEventListener("peer:discovery",t);break;case"message":this.pubsub.addEventListener("message",t);break;case"subscription-change":this.pubsub.addEventListener("subscription-change",t)}}off(e,t){switch(this._eventHandlers.has(e)&&this._eventHandlers.get(e).delete(t),e){case"peer:connect":this.libp2p.removeEventListener("peer:connect",t);break;case"peer:disconnect":this.libp2p.removeEventListener("peer:disconnect",t);break;case"peer:discovery":this.libp2p.removeEventListener("peer:discovery",t);break;case"message":this.pubsub.removeEventListener("message",t);break;case"subscription-change":this.pubsub.removeEventListener("subscription-change",t)}}async handle(e,t){await this.libp2p.handle(e,t)}async unhandle(e){await this.libp2p.unhandle(e)}async dialProtocol(e,t){return this.libp2p.dialProtocol(e,t)}get isStarted(){return this._started}get connectionCount(){return this.getConnections().length}}let ok=null;async function ak(e={}){return ok||(ok=await ik.create(e)),ok}async function ck(e={}){const t=await ak(e);return await t.start(),t}const lk={WEBRTC:"webrtc",WEBSOCKET:"websocket",CIRCUIT_RELAY:"circuit-relay"};function hk(e){return Kc(e)}function uk(e){const t="string"==typeof e?e:e.toString();return t.includes("/webrtc")?lk.WEBRTC:t.includes("/p2p-circuit")?lk.CIRCUIT_RELAY:t.includes("/ws")||t.includes("/wss")?lk.WEBSOCKET:null}function dk(e){return("string"==typeof e?e:e.toString()).includes("/p2p-circuit")}function pk(e){return("string"==typeof e?e:e.toString()).includes("/webrtc")}function fk(e){const t="string"==typeof e?e:e.toString();return t.includes("/ws")||t.includes("/wss")}class gk{constructor(){this.measurements=[],this.maxMeasurements=100}addMeasurement(e){this.measurements.push({latency:e,timestamp:Date.now()}),this.measurements.length>this.maxMeasurements&&this.measurements.shift()}getAverageLatency(){if(0===this.measurements.length)return-1;const e=this.measurements.reduce((e,t)=>e+t.latency,0);return Math.round(e/this.measurements.length)}getJitter(){if(this.measurements.length<2)return 0;const e=this.getAverageLatency(),t=this.measurements.reduce((t,s)=>t+Math.pow(s.latency-e,2),0)/this.measurements.length;return Math.round(Math.sqrt(t))}getQualityScore(){const e=this.getAverageLatency(),t=this.getJitter();if(e<0)return 0;let s=100-Math.min(e/5,100),r=Math.min(t/2,30);return Math.max(0,Math.round(s-r))}getQualityLabel(){const e=this.getQualityScore();return e>=80?"excellent":e>=60?"good":e>=40?"fair":e>=20?"poor":"bad"}}class mk{constructor(){this.samples=[],this.maxSamples=50}addSample(e,t){if(t<=0)return;const s=e/t*1e3;this.samples.push({bytesPerSecond:s,timestamp:Date.now()}),this.samples.length>this.maxSamples&&this.samples.shift()}getEstimate(){if(0===this.samples.length)return 0;const e=[...this.samples].sort((e,t)=>e.bytesPerSecond-t.bytesPerSecond);return e[Math.floor(.75*e.length)].bytesPerSecond}getReadable(){const e=this.getEstimate();return e>=1048576?`${(e/1048576).toFixed(1)} MB/s`:e>=1024?`${(e/1024).toFixed(1)} KB/s`:`${Math.round(e)} B/s`}}class yk{constructor(e){this.node=e,this.qualities=new Map,this.bandwidth=new mk}getQuality(e){return this.qualities.has(e)||this.qualities.set(e,new gk),this.qualities.get(e)}recordLatency(e,t){this.getQuality(e).addMeasurement(t)}recordTransfer(e,t){this.bandwidth.addSample(e,t)}getBestPeers(e=10){return this.node.getConnectedPeers().map(e=>({peerId:e,score:this.getQuality(e).getQualityScore()})).sort((e,t)=>t.score-e.score).slice(0,e).map(e=>e.peerId)}cleanup(e=36e5){const t=Date.now(),s=new Set(this.node.getConnectedPeers());for(const[r,n]of this.qualities)if(!s.has(r)){const s=n.measurements[n.measurements.length-1];(!s||t-s.timestamp>e)&&this.qualities.delete(r)}}}class bk{constructor(e,t={}){this.node=e,this.peerStore=t.peerStore||new It,this.announceInterval=t.announceInterval||3e4,this.rooms=new Set,this._announceTimer=null,this._handlers=new Map,this._started=!1}async start(){this._started||(this._started=!0,this.node.subscribe(Je.DISCOVERY),this._onMessage=this._handleMessage.bind(this),this.node.on("message",this._onMessage),this._onPeerConnect=this._handlePeerConnect.bind(this),this.node.on("peer:connect",this._onPeerConnect),this._onPeerDiscovery=this._handlePeerDiscovery.bind(this),this.node.on("peer:discovery",this._onPeerDiscovery),this._startAnnouncing(),console.log("ðŸ” Discovery started"))}async stop(){this._started&&(this._started=!1,this._announceTimer&&(clearInterval(this._announceTimer),this._announceTimer=null),this.node.unsubscribe(Je.DISCOVERY),this._onMessage&&this.node.off("message",this._onMessage),this._onPeerConnect&&this.node.off("peer:connect",this._onPeerConnect),this._onPeerDiscovery&&this.node.off("peer:discovery",this._onPeerDiscovery),console.log("ðŸ” Discovery stopped"))}_startAnnouncing(){this._announce(),this._announceTimer=setInterval(()=>{this._announce()},this.announceInterval)}async _announce(){if(!this._started)return;const e={type:"announce",peerId:this.node.peerId,addrs:this.node.multiaddrs,rooms:Array.from(this.rooms),ts:Date.now()};try{const t=Ge(JSON.stringify(e));await this.node.publish(Je.DISCOVERY,t)}catch(e){console.warn("Failed to announce:",e.message)}}_handleMessage(e){const{topic:t,data:s}=e.detail;if(t===Je.DISCOVERY)try{const e=JSON.parse(Qe(s));this._processAnnouncement(e)}catch(e){console.warn("Failed to parse discovery message:",e.message)}}_processAnnouncement(e){if("announce"!==e.type)return;if(e.peerId===this.node.peerId)return;const t=new Tt({id:e.peerId,addrs:e.addrs||[],seen:e.ts||Date.now()});this.peerStore.add(t),this._emit("peer:discovered",{peerId:e.peerId,addrs:e.addrs,rooms:e.rooms})}_handlePeerConnect(e){const t=e.detail.toString(),s=new Tt({id:t,seen:Date.now()});this.peerStore.add(s),this._emit("peer:connected",{peerId:t})}_handlePeerDiscovery(e){const t=new Tt({id:e.detail.id.toString(),addrs:e.detail.multiaddrs?.map(e=>e.toString())||[],seen:Date.now()});this.peerStore.add(t),this._emit("peer:discovered",{peerId:t.id,addrs:t.addrs})}joinRoom(e){this.rooms.add(e),this._announce()}leaveRoom(e){this.rooms.delete(e)}findRoomPeers(e){const t=Je.ROOM_PREFIX+e;return this.node.getSubscribers(t).map(e=>this.peerStore.get(e)).filter(Boolean)}getPeers(){return this.peerStore.all()}getConnectedPeers(){const e=new Set(this.node.getConnectedPeers());return this.peerStore.all().filter(t=>e.has(t.id))}async findPeer(e){try{const t=await this.node.dht.findPeer(e);if(t){const s=new Tt({id:e,addrs:t.multiaddrs?.map(e=>e.toString())||[],seen:Date.now()});return this.peerStore.add(s),s}}catch(e){console.warn("DHT findPeer failed:",e.message)}return null}on(e,t){this._handlers.has(e)||this._handlers.set(e,new Set),this._handlers.get(e).add(t)}off(e,t){this._handlers.has(e)&&this._handlers.get(e).delete(t)}_emit(e,t){if(this._handlers.has(e))for(const s of this._handlers.get(e))try{s(t)}catch(e){console.error("Event handler error:",e)}}pruneStale(e=3e5){this.peerStore.pruneStale(e)}}class wk{constructor(e,t){this.node=e,this.roomId=t,this.topic=Je.ROOM_PREFIX+t,this.members=new Map,this._handler=null}async start(){this.node.subscribe(this.topic),this._handler=e=>{if(e.detail.topic===this.topic)try{const t=JSON.parse(Qe(e.detail.data));"presence"===t.type&&this.members.set(t.peerId,t.ts)}catch(e){}},this.node.on("message",this._handler),this._announcePresence()}async stop(){this.node.unsubscribe(this.topic),this._handler&&this.node.off("message",this._handler),this.members.clear()}async _announcePresence(){const e={type:"presence",peerId:this.node.peerId,ts:Date.now()};try{await this.node.publish(this.topic,Ge(JSON.stringify(e)))}catch(e){console.warn("Failed to announce room presence:",e.message)}}getMembers(){const e=Date.now(),t=[];for(const[s,r]of this.members)e-r<6e4?t.push(s):this.members.delete(s);return t}}const vk={NONE:"none",PENDING:"pending",ACTIVE:"active",EXPIRED:"expired",FAILED:"failed"};class Sk{constructor(e,t={}){this.node=e,this.maxReservations=t.maxReservations||3,this.reservationTTL=t.reservationTTL||36e5,this.reservations=new Map,this.relayAddrs=new Map,this._checkTimer=null,this._started=!1}async start(){this._started||(this._started=!0,this._checkTimer=setInterval(()=>{this._checkReservations()},6e4),console.log("ðŸ“¡ Relay manager started"))}async stop(){this._started&&(this._started=!1,this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=null),this.reservations.clear(),this.relayAddrs.clear(),console.log("ðŸ“¡ Relay manager stopped"))}addRelay(e,t){this.relayAddrs.set(e,t)}removeRelay(e){this.relayAddrs.delete(e),this.reservations.delete(e)}async requestReservation(e){if(this.reservations.size>=this.maxReservations){let e=null,t=1/0;for(const[s,r]of this.reservations)r.createdAt<t&&(e=s,t=r.createdAt);e&&this.reservations.delete(e)}this.reservations.set(e,{status:vk.PENDING,createdAt:Date.now(),expiresAt:Date.now()+this.reservationTTL});try{const t=this.relayAddrs.get(e);return t&&await this.node.dial(t),this.reservations.set(e,{status:vk.ACTIVE,createdAt:Date.now(),expiresAt:Date.now()+this.reservationTTL}),!0}catch(t){return this.reservations.set(e,{status:vk.FAILED,createdAt:Date.now(),error:t.message}),!1}}getRelayAddrFor(e){for(const[t,s]of this.reservations)if(s.status===vk.ACTIVE){const s=this.relayAddrs.get(t);if(s)return`${s}/p2p-circuit/p2p/${e}`}return null}getActiveRelays(){const e=[];for(const[t,s]of this.reservations)s.status===vk.ACTIVE&&e.push(t);return e}_checkReservations(){const e=Date.now();for(const[t,s]of this.reservations)s.status===vk.ACTIVE&&s.expiresAt<e&&(this.reservations.set(t,{...s,status:vk.EXPIRED}),this.requestReservation(t))}async connectViaRelay(e){const t=this.getRelayAddrFor(e);if(!t)return console.warn("No active relay available"),!1;try{return await this.node.dial(t),!0}catch(e){return console.warn("Relay connection failed:",e.message),!1}}async autoConnect(){const e=this.node.getConnectedPeers();for(const t of e){const e=this.node.getConnections();for(const s of e)if(s.remotePeer.toString()===t){const e=s.remoteAddr.toString();(e.includes("/ws")||e.includes("/wss"))&&(this.addRelay(t,e),await this.requestReservation(t));break}}}getStats(){const e={total:this.reservations.size,active:0,pending:0,expired:0,failed:0};for(const[,t]of this.reservations)switch(t.status){case vk.ACTIVE:e.active++;break;case vk.PENDING:e.pending++;break;case vk.EXPIRED:e.expired++;break;case vk.FAILED:e.failed++}return e}}const Ek={DIRECT:"direct",HOLE_PUNCH:"hole-punch",RELAY:"relay",TURN:"turn"},Dk={UNKNOWN:"unknown",OPEN:"open",FULL_CONE:"full-cone",RESTRICTED:"restricted",PORT_RESTRICTED:"port-restricted",SYMMETRIC:"symmetric"};class _k{constructor(e,t={}){this.node=e,this.relayManager=t.relayManager,this.timeout=t.timeout||1e4,this.natType=Dk.UNKNOWN,this.publicAddrs=[],this._connectionAttempts=new Map}async connect(e,t=[]){const s={peerId:e,startTime:Date.now(),strategies:[]};this._connectionAttempts.set(e,s);try{if((await this._tryDirect(e,t)).success)return s.strategies.push({type:Ek.DIRECT,success:!0}),{success:!0,strategy:Ek.DIRECT};s.strategies.push({type:Ek.DIRECT,success:!1});if((await this._tryHolePunch(e)).success)return s.strategies.push({type:Ek.HOLE_PUNCH,success:!0}),{success:!0,strategy:Ek.HOLE_PUNCH};if(s.strategies.push({type:Ek.HOLE_PUNCH,success:!1}),this.relayManager){if((await this._tryRelay(e)).success)return s.strategies.push({type:Ek.RELAY,success:!0}),{success:!0,strategy:Ek.RELAY};s.strategies.push({type:Ek.RELAY,success:!1})}return{success:!1,strategy:null}}finally{s.endTime=Date.now(),s.duration=s.endTime-s.startTime}}async _tryDirect(e,t){const s=t.filter(e=>!dk(e)),r=s.sort((e,t)=>fk(e)&&!fk(t)?-1:!fk(e)&&fk(t)?1:0);for(const e of r)try{return await Promise.race([this.node.dial(e),this._timeoutPromise()]),{success:!0,addr:e}}catch(e){}return{success:!1}}async _tryHolePunch(e){try{const t=`/webrtc/p2p/${e}`;return await Promise.race([this.node.dial(t),this._timeoutPromise()]),{success:!0}}catch(e){return{success:!1,error:e.message}}}async _tryRelay(e){if(!this.relayManager)return{success:!1,error:"No relay manager"};try{return{success:await this.relayManager.connectViaRelay(e)}}catch(e){return{success:!1,error:e.message}}}_timeoutPromise(){return new Promise((e,t)=>{setTimeout(()=>t(new Error("Connection timeout")),this.timeout)})}async detectNATType(){const e=this.node.multiaddrs.some(e=>{const t=e.toString?e.toString():e;return!(t.includes("127.0.0.1")||t.includes("/ip4/10.")||t.includes("/ip4/192.168.")||t.includes("/ip4/172."))});return this.natType=e?Dk.OPEN:Dk.RESTRICTED,this.natType}isBehindNAT(){return this.natType!==Dk.OPEN&&this.natType!==Dk.UNKNOWN}getConnectionStats(){const e={attempts:this._connectionAttempts.size,successful:0,failed:0,byStrategy:{}};for(const[,t]of this._connectionAttempts){const s=t.strategies[t.strategies.length-1];s?.success?(e.successful++,e.byStrategy[s.type]=(e.byStrategy[s.type]||0)+1):e.failed++}return e}getAverageConnectionTime(){let e=0,t=0;for(const[,s]of this._connectionAttempts)s.duration&&(e+=s.duration,t++);return t>0?Math.round(e/t):0}cleanup(e=36e5){const t=Date.now();for(const[s,r]of this._connectionAttempts)r.endTime&&t-r.endTime>e&&this._connectionAttempts.delete(s)}}class Tk{constructor(){this.candidates=new Map,this.stunServers=["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302","stun:global.stun.twilio.com:3478"]}getIceServers(){return this.stunServers.map(e=>({urls:[e]}))}addCandidate(e,t){this.candidates.has(e)||this.candidates.set(e,[]),this.candidates.get(e).push(t)}getCandidates(e){return this.candidates.get(e)||[]}clearCandidates(e){this.candidates.delete(e)}analyzeCandidates(e){const t=this.getCandidates(e),s={host:0,srflx:0,relay:0,prflx:0};for(const e of t){const t=e.type||"unknown";void 0!==s[t]&&s[t]++}return s}}var Ik={},Ck={},Pk={},xk={},Ak={},kk=Nk("undefined"!=typeof Buffer&&Buffer)||Nk(e.Buffer)||Nk("undefined"!=typeof window&&window.Buffer)||e.Buffer;function Nk(e){return e&&e.isBuffer&&e}var Rk,Mk={}.toString,Lk=Array.isArray||function(e){return"[object Array]"==Mk.call(e)},Ok={exports:{}};var Bk,Uk={exports:{}};var Vk,Fk={exports:{}};var zk,$k,qk={},Wk={};function Kk(){if(zk)return qk;zk=1;var e,t=Wk;qk.copy=o,qk.slice=a,qk.toString=function(e,r,i){var o=!n&&s.isBuffer(this)?this.toString:t.toString;return o.apply(this,arguments)},qk.write=(e="write",function(){var s=this[e]||t[e];return s.apply(this,arguments)});var s=jk(),r=s.global,n=s.hasBuffer&&"TYPED_ARRAY_SUPPORT"in r,i=n&&!r.TYPED_ARRAY_SUPPORT;function o(e,r,n,o){var c=s.isBuffer(this),l=s.isBuffer(e);if(c&&l)return this.copy(e,r,n,o);if(i||c||l||!s.isView(this)||!s.isView(e))return t.copy.call(this,e,r,n,o);var h=n||null!=o?a.call(this,n,o):this;return e.set(h,r),h.length}function a(e,t){var r=this.slice||!i&&this.subarray;if(r)return r.call(this,e,t);var n=s.alloc.call(this,t-e);return o.call(this,n,0,e,t),n}return qk}function jk(){return $k||($k=1,function(e){var t=e.global=kk,s=e.hasBuffer=t&&!!t.isBuffer,r=e.hasArrayBuffer="undefined"!=typeof ArrayBuffer,n=e.isArray=Lk;e.isArrayBuffer=r?function(e){return e instanceof ArrayBuffer||d(e)}:g;var i=e.isBuffer=s?t.isBuffer:g,o=e.isView=r?ArrayBuffer.isView||m("ArrayBuffer","buffer"):g;e.alloc=u,e.concat=function(t,s){s||(s=0,Array.prototype.forEach.call(t,function(e){s+=e.length}));var r=this!==e&&this||t[0],n=u.call(r,s),i=0;return Array.prototype.forEach.call(t,function(e){i+=h.copy.call(e,n,i)}),n},e.from=function(e){return"string"==typeof e?p.call(this,e):f(this).from(e)};var a=e.Array=function(){if(Rk)return Ok.exports;Rk=1;var e=jk(),t=Ok.exports=s(0);function s(e){return new Array(e)}return t.alloc=s,t.concat=e.concat,t.from=function(s){if(!e.isBuffer(s)&&e.isView(s))s=e.Uint8Array.from(s);else if(e.isArrayBuffer(s))s=new Uint8Array(s);else{if("string"==typeof s)return e.from.call(t,s);if("number"==typeof s)throw new TypeError('"value" argument must not be a number')}return Array.prototype.slice.call(s)},Ok.exports}(),c=e.Buffer=function(){if(Bk)return Uk.exports;Bk=1;var e=jk(),t=e.global,s=Uk.exports=e.hasBuffer?r(0):[];function r(e){return new t(e)}return s.alloc=e.hasBuffer&&t.alloc||r,s.concat=e.concat,s.from=function(r){if(!e.isBuffer(r)&&e.isView(r))r=e.Uint8Array.from(r);else if(e.isArrayBuffer(r))r=new Uint8Array(r);else{if("string"==typeof r)return e.from.call(s,r);if("number"==typeof r)throw new TypeError('"value" argument must not be a number')}return t.from&&1!==t.from.length?t.from(r):new t(r)},Uk.exports}(),l=e.Uint8Array=function(){if(Vk)return Fk.exports;Vk=1;var e=jk(),t=Fk.exports=e.hasArrayBuffer?s(0):[];function s(e){return new Uint8Array(e)}return t.alloc=s,t.concat=e.concat,t.from=function(s){if(e.isView(s)){var r=s.byteOffset,n=s.byteLength;(s=s.buffer).byteLength!==n&&(s.slice?s=s.slice(r,r+n):(s=new Uint8Array(s)).byteLength!==n&&(s=Array.prototype.slice.call(s,r,r+n)))}else{if("string"==typeof s)return e.from.call(t,s);if("number"==typeof s)throw new TypeError('"value" argument must not be a number')}return new Uint8Array(s)},Fk.exports}(),h=e.prototype=Kk();function u(e){return f(this).alloc(e)}var d=m("ArrayBuffer");function p(e){var t=3*e.length,s=u.call(this,t),r=h.write.call(s,e);return t!==r&&(s=h.slice.call(s,0,r)),s}function f(e){return i(e)?c:o(e)?l:n(e)?a:s?c:r?l:a}function g(){return!1}function m(e,t){return e="[object "+e+"]",function(s){return null!=s&&{}.toString.call(t?s[t]:s)===e}}}(Ak)),Ak}Wk.copy=function(e,t,s,r){var n;s||(s=0);r||0===r||(r=this.length);t||(t=0);var i=r-s;if(e===this&&s<t&&t<r)for(n=i-1;n>=0;n--)e[n+t]=this[n+s];else for(n=0;n<i;n++)e[n+t]=this[n+s];return i},Wk.toString=function(e,t,s){var r=this,n=0|t;s||(s=r.length);var i="",o=0;for(;n<s;)(o=r[n++])<128?i+=String.fromCharCode(o):(192==(224&o)?o=(31&o)<<6|63&r[n++]:224==(240&o)?o=(15&o)<<12|(63&r[n++])<<6|63&r[n++]:240==(248&o)&&(o=(7&o)<<18|(63&r[n++])<<12|(63&r[n++])<<6|63&r[n++]),o>=65536?(o-=65536,i+=String.fromCharCode((o>>>10)+55296,56320+(1023&o))):i+=String.fromCharCode(o));return i},Wk.write=function(e,t){var s=this,r=t||(t|=0),n=e.length,i=0,o=0;for(;o<n;)(i=e.charCodeAt(o++))<128?s[r++]=i:i<2048?(s[r++]=192|i>>>6,s[r++]=128|63&i):i<55296||i>57343?(s[r++]=224|i>>>12,s[r++]=128|i>>>6&63,s[r++]=128|63&i):(i=65536+(i-55296<<10|e.charCodeAt(o++)-56320),s[r++]=240|i>>>18,s[r++]=128|i>>>12&63,s[r++]=128|i>>>6&63,s[r++]=128|63&i);return r-t},xk.ExtBuffer=function e(t,s){if(!(this instanceof e))return new e(t,s);this.buffer=Hk.from(t),this.type=s};var Hk=jk();var Gk,Qk={};var Xk={},Yk={};!function(e){var t,s="undefined",r=s!==typeof Buffer&&Buffer,n=s!==typeof Uint8Array&&Uint8Array,i=s!==typeof ArrayBuffer&&ArrayBuffer,o=[0,0,0,0,0,0,0,0],a=Array.isArray||function(e){return!!e&&"[object Array]"==Object.prototype.toString.call(e)},c=4294967296;function l(a,l,v){var S=l?0:4,E=l?4:0,D=l?0:3,_=l?1:2,T=l?2:1,I=l?3:0,C=l?m:b,P=l?y:w,x=N.prototype,A="is"+a,k="_"+A;return x.buffer=void 0,x.offset=0,x[k]=!0,x.toNumber=R,x.toString=function(e){var t=this.buffer,s=this.offset,r=L(t,s+S),n=L(t,s+E),i="",o=!v&&2147483648&r;for(o&&(r=~r,n=c-n),e=e||10;;){var a=r%e*c+n;if(r=Math.floor(r/e),n=Math.floor(a/e),i=(a%e).toString(e)+i,!r&&!n)break}return o&&(i="-"+i),i},x.toJSON=R,x.toArray=h,r&&(x.toBuffer=u),n&&(x.toArrayBuffer=d),N[A]=function(e){return!(!e||!e[k])},e[a]=N,N;function N(e,r,a,l){return this instanceof N?function(e,r,a,l,h){n&&i&&(r instanceof i&&(r=new n(r)),l instanceof i&&(l=new n(l))),r||a||l||t?(p(r,a)||(h=a,l=r,a=0,r=new(t||Array)(8)),e.buffer=r,e.offset=a|=0,s!==typeof l&&("string"==typeof l?function(e,t,s,r){var n=0,i=s.length,o=0,a=0;"-"===s[0]&&n++;for(var l=n;n<i;){var h=parseInt(s[n++],r);if(!(h>=0))break;a=a*r+h,o=o*r+Math.floor(a/c),a%=c}l&&(o=~o,a?a=c-a:o++),M(e,t+S,o),M(e,t+E,a)}(r,a,l,h||10):p(l,h)?f(r,a,l,h):"number"==typeof h?(M(r,a+S,l),M(r,a+E,h)):l>0?C(r,a,l):l<0?P(r,a,l):f(r,a,o,0))):e.buffer=g(o,0)}(this,e,r,a,l):new N(e,r,a,l)}function R(){var e=this.buffer,t=this.offset,s=L(e,t+S),r=L(e,t+E);return v||(s|=0),s?s*c+r:r}function M(e,t,s){e[t+I]=255&s,s>>=8,e[t+T]=255&s,s>>=8,e[t+_]=255&s,s>>=8,e[t+D]=255&s}function L(e,t){return 16777216*e[t+D]+(e[t+_]<<16)+(e[t+T]<<8)+e[t+I]}}function h(e){var s=this.buffer,r=this.offset;return t=null,!1!==e&&0===r&&8===s.length&&a(s)?s:g(s,r)}function u(e){var s=this.buffer,n=this.offset;if(t=r,!1!==e&&0===n&&8===s.length&&Buffer.isBuffer(s))return s;var i=new r(8);return f(i,0,s,n),i}function d(e){var s=this.buffer,r=this.offset,o=s.buffer;if(t=n,!1!==e&&0===r&&o instanceof i&&8===o.byteLength)return o;var a=new n(8);return f(a,0,s,r),a.buffer}function p(e,t){var s=e&&e.length;return t|=0,s&&t+8<=s&&"string"!=typeof e[t]}function f(e,t,s,r){t|=0,r|=0;for(var n=0;n<8;n++)e[t++]=255&s[r++]}function g(e,t){return Array.prototype.slice.call(e,t,t+8)}function m(e,t,s){for(var r=t+8;r>t;)e[--r]=255&s,s/=256}function y(e,t,s){var r=t+8;for(s++;r>t;)e[--r]=255&-s^255,s/=256}function b(e,t,s){for(var r=t+8;t<r;)e[t++]=255&s,s/=256}function w(e,t,s){var r=t+8;for(s++;t<r;)e[t++]=255&-s^255,s/=256}l("Uint64BE",!0,!0),l("Int64BE",!0,!1),l("Uint64LE",!1,!0),l("Int64LE",!1,!1)}("string"!=typeof Yk.nodeName?Yk:e||{});for(var Jk={},Zk={
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
read:function(e,t,s,r,n){var i,o,a=8*n-r-1,c=(1<<a)-1,l=c>>1,h=-7,u=s?n-1:0,d=s?-1:1,p=e[t+u];for(u+=d,i=p&(1<<-h)-1,p>>=-h,h+=a;h>0;i=256*i+e[t+u],u+=d,h-=8);for(o=i&(1<<-h)-1,i>>=-h,h+=r;h>0;o=256*o+e[t+u],u+=d,h-=8);if(0===i)i=1-l;else{if(i===c)return o?NaN:1/0*(p?-1:1);o+=Math.pow(2,r),i-=l}return(p?-1:1)*o*Math.pow(2,i-r)},write:function(e,t,s,r,n,i){var o,a,c,l=8*i-n-1,h=(1<<l)-1,u=h>>1,d=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,p=r?0:i-1,f=r?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,o=h):(o=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-o))<1&&(o--,c*=2),(t+=o+u>=1?d/c:d*Math.pow(2,1-u))*c>=2&&(o++,c/=2),o+u>=h?(a=0,o=h):o+u>=1?(a=(t*c-1)*Math.pow(2,n),o+=u):(a=t*Math.pow(2,u-1)*Math.pow(2,n),o=0));n>=8;e[s+p]=255&a,p+=f,a/=256,n-=8);for(o=o<<n|a,l+=n;l>0;e[s+p]=255&o,p+=f,o/=256,l-=8);e[s+p-f]|=128*g}},eN={},tN=eN.uint8=new Array(256),sN=0;sN<=255;sN++)tN[sN]=rN(sN);function rN(e){return function(t){var s=t.reserve(1);t.buffer[s]=e}}var nN=Zk,iN=Yk.Uint64BE,oN=Yk.Int64BE,aN=eN.uint8,cN=jk(),lN=cN.global,hN=cN.hasBuffer&&"TYPED_ARRAY_SUPPORT"in lN&&!lN.TYPED_ARRAY_SUPPORT,uN=cN.hasBuffer&&lN.prototype||{};function dN(){var e=aN.slice();return e[196]=pN(196),e[197]=fN(197),e[198]=gN(198),e[199]=pN(199),e[200]=fN(200),e[201]=gN(201),e[202]=mN(202,4,uN.writeFloatBE||wN,!0),e[203]=mN(203,8,uN.writeDoubleBE||vN,!0),e[204]=pN(204),e[205]=fN(205),e[206]=gN(206),e[207]=mN(207,8,yN),e[208]=pN(208),e[209]=fN(209),e[210]=gN(210),e[211]=mN(211,8,bN),e[217]=pN(217),e[218]=fN(218),e[219]=gN(219),e[220]=fN(220),e[221]=gN(221),e[222]=fN(222),e[223]=gN(223),e}function pN(e){return function(t,s){var r=t.reserve(2),n=t.buffer;n[r++]=e,n[r]=s}}function fN(e){return function(t,s){var r=t.reserve(3),n=t.buffer;n[r++]=e,n[r++]=s>>>8,n[r]=s}}function gN(e){return function(t,s){var r=t.reserve(5),n=t.buffer;n[r++]=e,n[r++]=s>>>24,n[r++]=s>>>16,n[r++]=s>>>8,n[r]=s}}function mN(e,t,s,r){return function(n,i){var o=n.reserve(t+1);n.buffer[o++]=e,s.call(n.buffer,i,o,r)}}function yN(e,t){new iN(this,t,e)}function bN(e,t){new oN(this,t,e)}function wN(e,t){nN.write(this,e,t,!1,23,4)}function vN(e,t){nN.write(this,e,t,!1,52,8)}Jk.getWriteToken=function(e){return e&&e.uint8array?((t=dN())[202]=mN(202,4,wN),t[203]=mN(203,8,vN),t):hN||cN.hasBuffer&&e&&e.safe?function(){var e=aN.slice();return e[196]=mN(196,1,lN.prototype.writeUInt8),e[197]=mN(197,2,lN.prototype.writeUInt16BE),e[198]=mN(198,4,lN.prototype.writeUInt32BE),e[199]=mN(199,1,lN.prototype.writeUInt8),e[200]=mN(200,2,lN.prototype.writeUInt16BE),e[201]=mN(201,4,lN.prototype.writeUInt32BE),e[202]=mN(202,4,lN.prototype.writeFloatBE),e[203]=mN(203,8,lN.prototype.writeDoubleBE),e[204]=mN(204,1,lN.prototype.writeUInt8),e[205]=mN(205,2,lN.prototype.writeUInt16BE),e[206]=mN(206,4,lN.prototype.writeUInt32BE),e[207]=mN(207,8,yN),e[208]=mN(208,1,lN.prototype.writeInt8),e[209]=mN(209,2,lN.prototype.writeInt16BE),e[210]=mN(210,4,lN.prototype.writeInt32BE),e[211]=mN(211,8,bN),e[217]=mN(217,1,lN.prototype.writeUInt8),e[218]=mN(218,2,lN.prototype.writeUInt16BE),e[219]=mN(219,4,lN.prototype.writeUInt32BE),e[220]=mN(220,2,lN.prototype.writeUInt16BE),e[221]=mN(221,4,lN.prototype.writeUInt32BE),e[222]=mN(222,2,lN.prototype.writeUInt16BE),e[223]=mN(223,4,lN.prototype.writeUInt32BE),e}():dN();var t};var SN=Lk,EN=Yk.Uint64BE,DN=Yk.Int64BE,_N=jk(),TN=Kk(),IN=Jk,CN=eN.uint8,PN=xk.ExtBuffer,xN="undefined"!=typeof Uint8Array,AN="undefined"!=typeof Map,kN=[];kN[1]=212,kN[2]=213,kN[4]=214,kN[8]=215,kN[16]=216,Xk.getWriteType=function(e){var t=IN.getWriteToken(e),s=e&&e.useraw,r=xN&&e&&e.binarraybuffer,n=r?_N.isArrayBuffer:_N.isBuffer,i=r?function(e,t){h(e,new Uint8Array(t))}:h,o=AN&&e&&e.usemap?function(e,s){if(!(s instanceof Map))return u(e,s);var r=s.size,n=r<16?128+r:r<=65535?222:223;t[n](e,r);var i=e.codec.encode;s.forEach(function(t,s,r){i(e,s),i(e,t)})}:u,a={boolean:function(e,s){var r=s?195:194;t[r](e,s)},function:l,number:function(e,s){var r,n=0|s;if(s!==n)return void t[r=203](e,s);r=-32<=n&&n<=127?255&n:0<=n?n<=255?204:n<=65535?205:206:-128<=n?208:-32768<=n?209:210;t[r](e,n)},object:s?function(e,s){if(n(s))return function(e,s){var r=s.length,n=r<32?160+r:r<=65535?218:219;t[n](e,r),e.send(s)}(e,s);c(e,s)}:c,string:function(e){return s;function s(s,r){var n=r.length,i=5+3*n;s.offset=s.reserve(i);var o=s.buffer,a=e(n),c=s.offset+a;n=TN.write.call(o,r,c);var l=e(n);if(a!==l){var h=c+l-a,u=c+n;TN.copy.call(o,o,h,c,u)}t[1===l?160+n:l<=3?215+l:219](s,n),s.offset+=n}}(s?function(e){return e<32?1:e<=65535?3:5}:function(e){return e<32?1:e<=255?2:e<=65535?3:5}),symbol:l,undefined:l};return a;function c(e,s){if(null===s)return l(e,s);if(n(s))return i(e,s);if(SN(s))return function(e,s){var r=s.length,n=r<16?144+r:r<=65535?220:221;t[n](e,r);for(var i=e.codec.encode,o=0;o<r;o++)i(e,s[o])}(e,s);if(EN.isUint64BE(s))return function(e,s){t[207](e,s.toArray())}(e,s);if(DN.isInt64BE(s))return function(e,s){t[211](e,s.toArray())}(e,s);var r=e.codec.getExtPacker(s);if(r&&(s=r(s)),s instanceof PN)return function(e,s){var r=s.buffer,n=r.length,i=kN[n]||(n<255?199:n<=65535?200:201);t[i](e,n),CN[s.type](e),e.send(r)}(e,s);o(e,s)}function l(e,s){t[192](e,s)}function h(e,s){var r=s.length;t[r<255?196:r<=65535?197:198](e,r),e.send(s)}function u(e,s){var r=Object.keys(s),n=r.length;t[n<16?128+n:n<=65535?222:223](e,n);var i=e.codec.encode;r.forEach(function(t){i(e,t),i(e,s[t])})}};var NN={},RN=Lk;NN.createCodec=UN,NN.install=function(e){for(var t in e)ON.prototype[t]=BN(ON.prototype[t],e[t])},NN.filter=function(e){return RN(e)?function(e){return e=e.slice(),function(s){return e.reduce(t,s)};function t(e,t){return t(e)}}(e):e};var MN,LN=jk();function ON(e){if(!(this instanceof ON))return new ON(e);this.options=e,this.init()}function BN(e,t){return e&&t?function(){return e.apply(this,arguments),t.apply(this,arguments)}:e||t}function UN(e){return new ON(e)}function VN(){if(MN)return Pk;MN=1;var e=xk.ExtBuffer,t=function(){if(Gk)return Qk;Gk=1,Qk.setExtPackers=function(e){e.addExtPacker(14,Error,[c,i]),e.addExtPacker(1,EvalError,[c,i]),e.addExtPacker(2,RangeError,[c,i]),e.addExtPacker(3,ReferenceError,[c,i]),e.addExtPacker(4,SyntaxError,[c,i]),e.addExtPacker(5,TypeError,[c,i]),e.addExtPacker(6,URIError,[c,i]),e.addExtPacker(10,RegExp,[a,i]),e.addExtPacker(11,Boolean,[o,i]),e.addExtPacker(12,String,[o,i]),e.addExtPacker(13,Date,[Number,i]),e.addExtPacker(15,Number,[o,i]),"undefined"!=typeof Uint8Array&&(e.addExtPacker(17,Int8Array,r),e.addExtPacker(18,Uint8Array,r),e.addExtPacker(19,Int16Array,r),e.addExtPacker(20,Uint16Array,r),e.addExtPacker(21,Int32Array,r),e.addExtPacker(22,Uint32Array,r),e.addExtPacker(23,Float32Array,r),"undefined"!=typeof Float64Array&&e.addExtPacker(24,Float64Array,r),"undefined"!=typeof Uint8ClampedArray&&e.addExtPacker(25,Uint8ClampedArray,r),e.addExtPacker(26,ArrayBuffer,r),e.addExtPacker(29,DataView,r)),t.hasBuffer&&e.addExtPacker(27,s,t.from)};var e,t=jk(),s=t.global,r=t.Uint8Array.from,n={name:1,message:1,stack:1,columnNumber:1,fileName:1,lineNumber:1};function i(t){return e||(e=eR().encode),e(t)}function o(e){return e.valueOf()}function a(e){(e=RegExp.prototype.toString.call(e).split("/")).shift();var t=[e.pop()];return t.unshift(e.join("/")),t}function c(e){var t={};for(var s in n)t[s]=e[s];return t}return Qk}(),s=Xk,r=NN;function n(){var e=this.options;return this.encode=function(e){var t=s.getWriteType(e);return function(e,s){var r=t[typeof s];if(!r)throw new Error('Unsupported type "'+typeof s+'": '+s);r(e,s)}}(e),e&&e.preset&&t.setExtPackers(this),this}return r.install({addExtPacker:function(t,s,n){n=r.filter(n);var i=s.name;if(i&&"Object"!==i){(this.extPackers||(this.extPackers={}))[i]=o}else{(this.extEncoderList||(this.extEncoderList=[])).unshift([s,o])}function o(s){return n&&(s=n(s)),new e(s,t)}},getExtPacker:function(e){var t=this.extPackers||(this.extPackers={}),s=e.constructor,r=s&&s.name&&t[s.name];if(r)return r;for(var n=this.extEncoderList||(this.extEncoderList=[]),i=n.length,o=0;o<i;o++){var a=n[o];if(s===a[0])return a[1]}},init:n}),Pk.preset=n.call(r.preset),Pk}ON.prototype.init=function(){var e=this.options;return e&&e.uint8array&&(this.bufferish=LN.Uint8Array),this},NN.preset=UN({preset:!0});var FN={};FN.FlexDecoder=KN,FN.FlexEncoder=jN;var zN,$N,qN=jk(),WN="BUFFER_SHORTAGE";function KN(){if(!(this instanceof KN))return new KN}function jN(){if(!(this instanceof jN))return new jN}function HN(){throw new Error("method not implemented: write()")}function GN(){throw new Error("method not implemented: fetch()")}function QN(){return this.buffers&&this.buffers.length?(this.flush(),this.pull()):this.fetch()}function XN(e){(this.buffers||(this.buffers=[])).push(e)}function YN(){return(this.buffers||(this.buffers=[])).shift()}function JN(e){return function(t){for(var s in e)t[s]=e[s];return t}}function ZN(){if(zN)return Ck;zN=1,Ck.EncodeBuffer=t;var e=VN().preset;function t(e){if(!(this instanceof t))return new t(e);if(e&&(this.options=e,e.codec)){var s=this.codec=e.codec;s.bufferish&&(this.bufferish=s.bufferish)}}return FN.FlexEncoder.mixin(t.prototype),t.prototype.codec=e,t.prototype.write=function(e){this.codec.encode(this,e)},Ck}function eR(){if($N)return Ik;$N=1,Ik.encode=function(t,s){var r=new e(s);return r.write(t),r.read()};var e=ZN().EncodeBuffer;return Ik}KN.mixin=JN({bufferish:qN,write:function(e){var t=this.offset?qN.prototype.slice.call(this.buffer,this.offset):this.buffer;this.buffer=t?e?this.bufferish.concat([t,e]):t:e,this.offset=0},fetch:GN,flush:function(){for(;this.offset<this.buffer.length;){var e,t=this.offset;try{e=this.fetch()}catch(e){if(e&&e.message!=WN)throw e;this.offset=t;break}this.push(e)}},push:XN,pull:YN,read:QN,reserve:function(e){var t=this.offset,s=t+e;if(s>this.buffer.length)throw new Error(WN);return this.offset=s,t},offset:0}),KN.mixin(KN.prototype),jN.mixin=JN({bufferish:qN,write:HN,fetch:function(){var e=this.start;if(e<this.offset){var t=this.start=this.offset;return qN.prototype.slice.call(this.buffer,e,t)}},flush:function(){for(;this.start<this.offset;){var e=this.fetch();e&&this.push(e)}},push:XN,pull:function(){var e=this.buffers||(this.buffers=[]),t=e.length>1?this.bufferish.concat(e):e[0];return e.length=0,t},read:QN,reserve:function(e){var t=0|e;if(this.buffer){var s=this.buffer.length,r=0|this.offset,n=r+t;if(n<s)return this.offset=n,r;this.flush(),e=Math.max(e,Math.min(2*s,this.maxBufferSize))}return e=Math.max(e,this.minBufferSize),this.buffer=this.bufferish.alloc(e),this.start=0,this.offset=t,0},send:function(e){var t=e.length;if(t>this.minBufferSize)this.flush(),this.push(e);else{var s=this.reserve(t);qN.prototype.copy.call(e,this.buffer,s)}},maxBufferSize:65536,minBufferSize:2048,offset:0,start:0}),jN.mixin(jN.prototype);var tR,sR={},rR={},nR={},iR={};var oR={},aR=Zk,cR=Yk.Uint64BE,lR=Yk.Int64BE;oR.getReadFormat=function(e){var t=hR.hasArrayBuffer&&e&&e.binarraybuffer,s=e&&e.int64,r={map:dR&&e&&e.usemap?gR:fR,array:mR,str:yR,bin:t?wR:bR,ext:vR,uint8:SR,uint16:DR,uint32:TR,uint64:CR(8,s?AR:PR),int8:ER,int16:_R,int32:IR,int64:CR(8,s?kR:xR),float32:CR(4,NR),float64:CR(8,RR)};return r},oR.readUint8=SR;var hR=jk(),uR=Kk(),dR="undefined"!=typeof Map,pR=!0;function fR(e,t){var s,r={},n=new Array(t),i=new Array(t),o=e.codec.decode;for(s=0;s<t;s++)n[s]=o(e),i[s]=o(e);for(s=0;s<t;s++)r[n[s]]=i[s];return r}function gR(e,t){var s,r=new Map,n=new Array(t),i=new Array(t),o=e.codec.decode;for(s=0;s<t;s++)n[s]=o(e),i[s]=o(e);for(s=0;s<t;s++)r.set(n[s],i[s]);return r}function mR(e,t){for(var s=new Array(t),r=e.codec.decode,n=0;n<t;n++)s[n]=r(e);return s}function yR(e,t){var s=e.reserve(t),r=s+t;return uR.toString.call(e.buffer,"utf-8",s,r)}function bR(e,t){var s=e.reserve(t),r=s+t,n=uR.slice.call(e.buffer,s,r);return hR.from(n)}function wR(e,t){var s=e.reserve(t),r=s+t,n=uR.slice.call(e.buffer,s,r);return hR.Uint8Array.from(n).buffer}function vR(e,t){var s=e.reserve(t+1),r=e.buffer[s++],n=s+t,i=e.codec.getExtUnpacker(r);if(!i)throw new Error("Invalid ext type: "+(r?"0x"+r.toString(16):r));return i(uR.slice.call(e.buffer,s,n))}function SR(e){var t=e.reserve(1);return e.buffer[t]}function ER(e){var t=e.reserve(1),s=e.buffer[t];return 128&s?s-256:s}function DR(e){var t=e.reserve(2),s=e.buffer;return s[t++]<<8|s[t]}function _R(e){var t=e.reserve(2),s=e.buffer,r=s[t++]<<8|s[t];return 32768&r?r-65536:r}function TR(e){var t=e.reserve(4),s=e.buffer;return 16777216*s[t++]+(s[t++]<<16)+(s[t++]<<8)+s[t]}function IR(e){var t=e.reserve(4),s=e.buffer;return s[t++]<<24|s[t++]<<16|s[t++]<<8|s[t]}function CR(e,t){return function(s){var r=s.reserve(e);return t.call(s.buffer,r,pR)}}function PR(e){return new cR(this,e).toNumber()}function xR(e){return new lR(this,e).toNumber()}function AR(e){return new cR(this,e)}function kR(e){return new lR(this,e)}function NR(e){return aR.read(this,e,!1,23,4)}function RR(e){return aR.read(this,e,!1,52,8)}var MR,LR,OR,BR={},UR=oR;function VR(e){var t,s=new Array(256);for(t=0;t<=127;t++)s[t]=FR(t);for(t=128;t<=143;t++)s[t]=$R(t-128,e.map);for(t=144;t<=159;t++)s[t]=$R(t-144,e.array);for(t=160;t<=191;t++)s[t]=$R(t-160,e.str);for(s[192]=FR(null),s[193]=null,s[194]=FR(!1),s[195]=FR(!0),s[196]=zR(e.uint8,e.bin),s[197]=zR(e.uint16,e.bin),s[198]=zR(e.uint32,e.bin),s[199]=zR(e.uint8,e.ext),s[200]=zR(e.uint16,e.ext),s[201]=zR(e.uint32,e.ext),s[202]=e.float32,s[203]=e.float64,s[204]=e.uint8,s[205]=e.uint16,s[206]=e.uint32,s[207]=e.uint64,s[208]=e.int8,s[209]=e.int16,s[210]=e.int32,s[211]=e.int64,s[212]=$R(1,e.ext),s[213]=$R(2,e.ext),s[214]=$R(4,e.ext),s[215]=$R(8,e.ext),s[216]=$R(16,e.ext),s[217]=zR(e.uint8,e.str),s[218]=zR(e.uint16,e.str),s[219]=zR(e.uint32,e.str),s[220]=zR(e.uint16,e.array),s[221]=zR(e.uint32,e.array),s[222]=zR(e.uint16,e.map),s[223]=zR(e.uint32,e.map),t=224;t<=255;t++)s[t]=FR(t-256);return s}function FR(e){return function(){return e}}function zR(e,t){return function(s){var r=e(s);return t(s,r)}}function $R(e,t){return function(s){return t(s,e)}}function qR(){if(MR)return nR;MR=1;var e=xk.ExtBuffer,t=function(){if(tR)return iR;tR=1,iR.setExtUnpackers=function(e){e.addExtUnpacker(14,[n,o(Error)]),e.addExtUnpacker(1,[n,o(EvalError)]),e.addExtUnpacker(2,[n,o(RangeError)]),e.addExtUnpacker(3,[n,o(ReferenceError)]),e.addExtUnpacker(4,[n,o(SyntaxError)]),e.addExtUnpacker(5,[n,o(TypeError)]),e.addExtUnpacker(6,[n,o(URIError)]),e.addExtUnpacker(10,[n,i]),e.addExtUnpacker(11,[n,a(Boolean)]),e.addExtUnpacker(12,[n,a(String)]),e.addExtUnpacker(13,[n,a(Date)]),e.addExtUnpacker(15,[n,a(Number)]),"undefined"!=typeof Uint8Array&&(e.addExtUnpacker(17,a(Int8Array)),e.addExtUnpacker(18,a(Uint8Array)),e.addExtUnpacker(19,[c,a(Int16Array)]),e.addExtUnpacker(20,[c,a(Uint16Array)]),e.addExtUnpacker(21,[c,a(Int32Array)]),e.addExtUnpacker(22,[c,a(Uint32Array)]),e.addExtUnpacker(23,[c,a(Float32Array)]),"undefined"!=typeof Float64Array&&e.addExtUnpacker(24,[c,a(Float64Array)]),"undefined"!=typeof Uint8ClampedArray&&e.addExtUnpacker(25,a(Uint8ClampedArray)),e.addExtUnpacker(26,c),e.addExtUnpacker(29,[c,a(DataView)])),t.hasBuffer&&e.addExtUnpacker(27,a(s))};var e,t=jk(),s=t.global,r={name:1,message:1,stack:1,columnNumber:1,fileName:1,lineNumber:1};function n(t){return e||(e=KR().decode),e(t)}function i(e){return RegExp.apply(null,e)}function o(e){return function(t){var s=new e;for(var n in r)s[n]=t[n];return s}}function a(e){return function(t){return new e(t)}}function c(e){return new Uint8Array(e).buffer}return iR}(),s=oR.readUint8,r=BR,n=NN;function i(){var e=this.options;return this.decode=function(e){var t=r.getReadToken(e);return function(e){var r=s(e),n=t[r];if(!n)throw new Error("Invalid type: "+(r?"0x"+r.toString(16):r));return n(e)}}(e),e&&e.preset&&t.setExtUnpackers(this),this}return n.install({addExtUnpacker:function(e,t){(this.extUnpackers||(this.extUnpackers=[]))[e]=n.filter(t)},getExtUnpacker:function(t){return(this.extUnpackers||(this.extUnpackers=[]))[t]||function(s){return new e(s,t)}},init:i}),nR.preset=i.call(n.preset),nR}function WR(){if(LR)return rR;LR=1,rR.DecodeBuffer=t;var e=qR().preset;function t(e){if(!(this instanceof t))return new t(e);if(e&&(this.options=e,e.codec)){var s=this.codec=e.codec;s.bufferish&&(this.bufferish=s.bufferish)}}return FN.FlexDecoder.mixin(t.prototype),t.prototype.codec=e,t.prototype.fetch=function(){return this.codec.decode(this)},rR}function KR(){if(OR)return sR;OR=1,sR.decode=function(t,s){var r=new e(s);return r.write(t),r.read()};var e=WR().DecodeBuffer;return sR}BR.getReadToken=function(e){var t=UR.getReadFormat(e);return e&&e.useraw?function(e){var t,s=VR(e).slice();for(s[217]=s[196],s[218]=s[197],s[219]=s[198],t=160;t<=191;t++)s[t]=$R(t-160,e.bin);return s}(t):VR(t)};var jR,HR={exports:{}};
/**
 * event-lite.js - Light-weight EventEmitter (less than 1KB when gzipped)
 *
 * @copyright Yusuke Kawasaki
 * @license MIT
 * @constructor
 * @see https://github.com/kawanet/event-lite
 * @see http://kawanet.github.io/event-lite/EventLite.html
 * @example
 * var EventLite = require("event-lite");
 *
 * function MyClass() {...}             // your class
 *
 * EventLite.mixin(MyClass.prototype);  // import event methods
 *
 * var obj = new MyClass();
 * obj.on("foo", function() {...});     // add event listener
 * obj.once("bar", function() {...});   // add one-time event listener
 * obj.emit("foo");                     // dispatch event
 * obj.emit("bar");                     // dispatch another event
 * obj.off("foo");                      // remove event listener
 */jR=HR,function(e){jR.exports=e;var t="listeners",s={on:function(e,t){return i(this,e).push(t),this},once:function(e,t){var s=this;return r.originalListener=t,i(s,e).push(r),s;function r(){n.call(s,e,r),t.apply(this,arguments)}},off:n,emit:function(e,t){var s=this,r=i(s,e,!0);if(!r)return!1;var n=arguments.length;if(1===n)r.forEach(function(e){e.call(s)});else if(2===n)r.forEach(function(e){e.call(s,t)});else{var o=Array.prototype.slice.call(arguments,1);r.forEach(function(e){e.apply(s,o)})}return!!r.length}};function r(e){for(var t in s)e[t]=s[t];return e}function n(e,s){var r,o=this;if(arguments.length){if(s){if(r=i(o,e,!0)){if(!(r=r.filter(function(e){return e!==s&&e.originalListener!==s})).length)return n.call(o,e);o[t][e]=r}}else if((r=o[t])&&(delete r[e],!Object.keys(r).length))return n.call(o)}else delete o[t];return o}function i(e,s,r){if(!r||e[t]){var n=e[t]||(e[t]={});return n[s]||(n[s]=[])}}r(e.prototype),e.mixin=r}(function e(){if(!(this instanceof e))return new e});var GR=HR.exports,QR=GR,XR=ZN().EncodeBuffer;function YR(e){if(!(this instanceof YR))return new YR(e);XR.call(this,e)}YR.prototype=new XR,QR.mixin(YR.prototype),YR.prototype.encode=function(e){this.write(e),this.emit("data",this.read())},YR.prototype.end=function(e){arguments.length&&this.encode(e),this.flush(),this.emit("end")};var JR=GR,ZR=WR().DecodeBuffer;function eM(e){if(!(this instanceof eM))return new eM(e);ZR.call(this,e)}eM.prototype=new ZR,JR.mixin(eM.prototype),eM.prototype.decode=function(e){arguments.length&&this.write(e),this.flush()},eM.prototype.push=function(e){this.emit("data",e)},eM.prototype.end=function(e){this.decode(e),this.emit("end")},qR(),VN(),NN.createCodec,qR(),VN(),NN.preset;var tM=eR().encode;KR().decode;const sM={REQUEST:"req",RESPONSE:"res",STREAM:"stream",EVENT:"event"};function rM(){const e=new Uint8Array(8);return crypto.getRandomValues(e),Array.from(e).map(e=>e.toString(16).padStart(2,"0")).join("")}function nM(e){const t={id:rM(),v:1,type:e.type||sM.REQUEST,from:e.from,to:e.to||null,action:e.action||null,payload:e.payload,replyTo:e.replyTo||null,ts:Date.now(),sig:null};if(e.secretKey){const s=tM({id:t.id,v:t.v,type:t.type,from:t.from,to:t.to,action:t.action,payload:t.payload,replyTo:t.replyTo,ts:t.ts});t.sig=o.sign.detached(s,e.secretKey)}return t}function iM(e,t,s,r,n=null){return nM({type:sM.RESPONSE,from:e,to:t,replyTo:s,payload:r,secretKey:n})}class oM{constructor(e,t={}){this.peerId=e,this.timeout=t.timeout||3e4,this.pending=new Map,this.handlers=new Map,this.onSend=t.onSend||(()=>{}),this.keyPair=t.keyPair||null}on(e,t){this.handlers.set(e,t)}off(e){this.handlers.delete(e)}async call(e,t,s){const r=function(e,t,s,r,n=null){return nM({type:sM.REQUEST,from:e,to:t,action:s,payload:r,secretKey:n})}(this.peerId,e,t,s,this.keyPair?.secretKey);return new Promise((e,s)=>{const n=setTimeout(()=>{this.pending.delete(r.id),s(new Error(`Request timeout: ${t}`))},this.timeout);this.pending.set(r.id,{resolve:t=>{clearTimeout(n),e(t)},reject:e=>{clearTimeout(n),s(e)}}),this.onSend(r)})}emit(e,t){const s=function(e,t,s,r=null){return nM({type:sM.EVENT,from:e,action:t,payload:s,secretKey:r})}(this.peerId,e,t,this.keyPair?.secretKey);this.onSend(s)}async receive(e){const t=function(e){const t=[];e.id&&"string"==typeof e.id||t.push("missing or invalid id"),e.v&&1===e.v||t.push("unsupported protocol version"),Object.values(sM).includes(e.type)||t.push("invalid message type"),e.from&&"string"==typeof e.from||t.push("missing or invalid from"),e.type!==sM.REQUEST||e.action||t.push("request missing action"),e.type!==sM.RESPONSE||e.replyTo||t.push("response missing replyTo"),e.ts&&"number"==typeof e.ts||t.push("missing or invalid timestamp");const s=Date.now()-e.ts;return Math.abs(s)>3e5&&t.push("message timestamp too old or future"),{valid:0===t.length,errors:t}}(e);if(t.valid){if(e.type===sM.RESPONSE){const t=this.pending.get(e.replyTo);return void(t&&(this.pending.delete(e.replyTo),e.payload?.error?t.reject(new Error(e.payload.error)):t.resolve(e.payload)))}if(e.type===sM.REQUEST){const t=this.handlers.get(e.action);if(!t){const t=iM(this.peerId,e.from,e.id,{error:`Unknown action: ${e.action}`},this.keyPair?.secretKey);return void this.onSend(t)}try{const s=await t(e.payload,e),r=iM(this.peerId,e.from,e.id,s,this.keyPair?.secretKey);this.onSend(r)}catch(t){const s=iM(this.peerId,e.from,e.id,{error:t.message},this.keyPair?.secretKey);this.onSend(s)}return}if(e.type===sM.EVENT){const t=this.handlers.get(e.action);if(t)try{await t(e.payload,e)}catch(e){console.error("Event handler error:",e)}return}if(e.type===sM.STREAM){const t=this.handlers.get("__stream__");if(t)try{await t(e.payload,e)}catch(e){console.error("Stream handler error:",e)}}}else console.warn("Invalid message:",t.errors)}}const aM={IDLE:"idle",DIALING:"dialing",RINGING:"ringing",CONNECTING:"connecting",ACTIVE:"active",HOLD:"hold",ENDED:"ended",FAILED:"failed"},cM={VOICE:"voice",VIDEO:"video",EMERGENCY:"emergency"},lM={HANGUP:"hangup",REJECTED:"rejected",BUSY:"busy",NO_ANSWER:"no_answer",NETWORK_ERROR:"network_error",TIMEOUT:"timeout"},hM={CALL_OFFER:"call:offer",CALL_ANSWER:"call:answer",CALL_REJECT:"call:reject",CALL_HANGUP:"call:hangup",CALL_BUSY:"call:busy",CALL_HOLD:"call:hold",CALL_RESUME:"call:resume",ICE_CANDIDATE:"ice:candidate",SDP_OFFER:"sdp:offer",SDP_ANSWER:"sdp:answer",ROUTE_REQUEST:"route:request",ROUTE_REPLY:"route:reply",ROUTE_ERROR:"route:error",REGISTER:"presence:register",HEARTBEAT:"presence:heartbeat",LOOKUP:"presence:lookup",FOUND:"presence:found"},uM={OPUS:{name:"opus",rate:48e3,channels:2,bitrate:32e3},G722:{name:"G722",rate:16e3,channels:1,bitrate:64e3},PCMU:{name:"PCMU",rate:8e3,channels:1,bitrate:64e3}},dM={VP8:{name:"VP8",width:640,height:480,fps:30},VP9:{name:"VP9",width:1280,height:720,fps:30},H264:{name:"H264",width:1920,height:1080,fps:30}};class pM{constructor(e={}){this.id=e.id||crypto.randomUUID(),this.phoneNumber=e.phoneNumber||this._generateNumber(),this.displayName=e.displayName||"Anonymous",this.peers=new Map,this.routes=new Map,this.pendingRoutes=new Map,this.activeCalls=new Map,this.callHistory=[],this.peerConnections=new Map,this.localStream=null,this.remoteStreams=new Map,this.config={maxHops:e.maxHops||10,routeTimeout:e.routeTimeout||5e3,heartbeatInterval:e.heartbeatInterval||3e4,ringTimeout:e.ringTimeout||3e4,iceServers:e.iceServers||[{urls:"stun:stun.l.google.com:19302"}]},this.protocol=new oM(this.id,{onSend:e=>this._broadcast(e)}),this._setupHandlers()}_generateNumber(){const e=Math.floor(1e7*Math.random()).toString().padStart(7,"0");return`555-${e.slice(0,3)}-${e.slice(3)}`}async call(e,t=cM.VOICE){const s=crypto.randomUUID(),r={id:s,type:t,direction:"outgoing",state:aM.DIALING,target:e,startTime:Date.now(),connectTime:null,endTime:null};this.activeCalls.set(s,r);if(!await this._findRoute(e))throw r.state=aM.FAILED,r.endReason=lM.NETWORK_ERROR,this._endCall(s),new Error("No route to target");const n=await this._createPeerConnection(s,!0),i=await n.createOffer();return await n.setLocalDescription(i),await this._routeMessage(e,{type:hM.CALL_OFFER,callId:s,callType:t,from:this.id,fromNumber:this.phoneNumber,fromName:this.displayName,sdp:i.sdp}),r.state=aM.RINGING,this._emit("call:outgoing",r),setTimeout(()=>{r.state===aM.RINGING&&(r.state=aM.FAILED,r.endReason=lM.NO_ANSWER,this._endCall(s))},this.config.ringTimeout),r}async answer(e){const t=this.activeCalls.get(e);if(!t||"incoming"!==t.direction)throw new Error("Invalid call");t.state=aM.CONNECTING;const s=await this._createPeerConnection(e,!1);await s.setRemoteDescription({type:"offer",sdp:t.sdpOffer});const r=await s.createAnswer();return await s.setLocalDescription(r),await this._routeMessage(t.from,{type:hM.CALL_ANSWER,callId:e,from:this.id,sdp:r.sdp}),t.state=aM.ACTIVE,t.connectTime=Date.now(),this._emit("call:connected",t),t}async reject(e){const t=this.activeCalls.get(e);t&&(await this._routeMessage(t.from,{type:hM.CALL_REJECT,callId:e,from:this.id}),t.state=aM.ENDED,t.endReason=lM.REJECTED,this._endCall(e))}async hangup(e){const t=this.activeCalls.get(e);if(!t)return;const s="outgoing"===t.direction?t.target:t.from;await this._routeMessage(s,{type:hM.CALL_HANGUP,callId:e,from:this.id}),t.state=aM.ENDED,t.endReason=lM.HANGUP,this._endCall(e)}async hold(e){const t=this.activeCalls.get(e);if(!t||t.state!==aM.ACTIVE)return;t.state=aM.HOLD;const s="outgoing"===t.direction?t.target:t.from;await this._routeMessage(s,{type:hM.CALL_HOLD,callId:e,from:this.id}),this.localStream&&this.localStream.getTracks().forEach(e=>e.enabled=!1),this._emit("call:hold",t)}async resume(e){const t=this.activeCalls.get(e);if(!t||t.state!==aM.HOLD)return;t.state=aM.ACTIVE;const s="outgoing"===t.direction?t.target:t.from;await this._routeMessage(s,{type:hM.CALL_RESUME,callId:e,from:this.id}),this.localStream&&this.localStream.getTracks().forEach(e=>e.enabled=!0),this._emit("call:resumed",t)}mute(e,t=!0){this.localStream&&this.localStream.getAudioTracks().forEach(e=>e.enabled=!t),this._emit("call:muted",{callId:e,muted:t})}async _createPeerConnection(e,t){const s=new RTCPeerConnection({iceServers:this.config.iceServers});if(this.peerConnections.set(e,s),!this.localStream){const t=this.activeCalls.get(e),s={audio:!0,video:t?.type===cM.VIDEO};this.localStream=await navigator.mediaDevices.getUserMedia(s)}return this.localStream.getTracks().forEach(e=>{s.addTrack(e,this.localStream)}),s.onicecandidate=async t=>{if(t.candidate){const s=this.activeCalls.get(e),r="outgoing"===s.direction?s.target:s.from;await this._routeMessage(r,{type:hM.ICE_CANDIDATE,callId:e,from:this.id,candidate:t.candidate})}},s.ontrack=t=>{this.remoteStreams.set(e,t.streams[0]),this._emit("call:stream",{callId:e,stream:t.streams[0]})},s.onconnectionstatechange=()=>{const t=this.activeCalls.get(e);t&&"disconnected"===s.connectionState&&(t.state=aM.FAILED,t.endReason=lM.NETWORK_ERROR,this._endCall(e))},s}async _findRoute(e){if(this.peers.has(e))return{nextHop:e,hops:1};if(this.routes.has(e)){const t=this.routes.get(e);if(Date.now()-t.timestamp<6e4)return t}return new Promise((t,s)=>{const r=crypto.randomUUID();this.pendingRoutes.set(r,{resolve:t,reject:s,targetId:e}),this._broadcast({type:hM.ROUTE_REQUEST,requestId:r,target:e,origin:this.id,hops:0,path:[this.id]}),setTimeout(()=>{this.pendingRoutes.has(r)&&(this.pendingRoutes.delete(r),s(new Error("Route not found")))},this.config.routeTimeout)})}async _routeMessage(e,t){if(this.peers.has(e))return this._sendToPeer(e,t);const s=this.routes.get(e);if(s)return this._sendToPeer(s.nextHop,{...t,_route:{target:e,hops:s.hops}});const r=await this._findRoute(e);if(r)return this._sendToPeer(r.nextHop,{...t,_route:{target:e,hops:r.hops}});throw new Error("No route to target")}_setupHandlers(){this.protocol.on(hM.CALL_OFFER,e=>{const t={id:e.callId,type:e.callType,direction:"incoming",state:aM.RINGING,from:e.from,fromNumber:e.fromNumber,fromName:e.fromName,sdpOffer:e.sdp,startTime:Date.now()};this.activeCalls.set(e.callId,t),this._emit("call:incoming",t)}),this.protocol.on(hM.CALL_ANSWER,async e=>{const t=this.activeCalls.get(e.callId);if(!t)return;const s=this.peerConnections.get(e.callId);s&&await s.setRemoteDescription({type:"answer",sdp:e.sdp}),t.state=aM.ACTIVE,t.connectTime=Date.now(),this._emit("call:connected",t)}),this.protocol.on(hM.CALL_REJECT,e=>{const t=this.activeCalls.get(e.callId);t&&(t.state=aM.ENDED,t.endReason=lM.REJECTED,this._endCall(e.callId))}),this.protocol.on(hM.CALL_HANGUP,e=>{const t=this.activeCalls.get(e.callId);t&&(t.state=aM.ENDED,t.endReason=lM.HANGUP,this._endCall(e.callId))}),this.protocol.on(hM.ICE_CANDIDATE,async e=>{const t=this.peerConnections.get(e.callId);t&&e.candidate&&await t.addIceCandidate(e.candidate)}),this.protocol.on(hM.ROUTE_REQUEST,e=>{if(e.origin!==this.id){if(e.target===this.id){const t=[...e.path].reverse();return void this._sendRouteReply(e.requestId,e.origin,t)}e.hops<this.config.maxHops&&this._broadcast({...e,hops:e.hops+1,path:[...e.path,this.id]})}}),this.protocol.on(hM.ROUTE_REPLY,e=>{const t=this.pendingRoutes.get(e.requestId);if(t){const s={nextHop:e.path[1],hops:e.path.length-1,path:e.path,timestamp:Date.now()};this.routes.set(e.target,s),t.resolve(s),this.pendingRoutes.delete(e.requestId)}}),this.protocol.on(hM.CALL_HOLD,e=>{const t=this.activeCalls.get(e.callId);t&&(t.state=aM.HOLD,this._emit("call:hold",t))}),this.protocol.on(hM.CALL_RESUME,e=>{const t=this.activeCalls.get(e.callId);t&&(t.state=aM.ACTIVE,this._emit("call:resumed",t))})}_sendRouteReply(e,t,s){const r=s[1];this.peers.has(r)&&this._sendToPeer(r,{type:hM.ROUTE_REPLY,requestId:e,target:this.id,origin:t,path:s})}addPeer(e,t){this.peers.set(e,{id:e,transport:t,connectedAt:Date.now(),lastSeen:Date.now()}),t.onmessage=e=>{try{const t=JSON.parse(e);this.protocol.receive(t)}catch(e){console.error("Failed to parse message:",e)}},t.onclose=()=>{this.peers.delete(e),this._emit("peer:disconnected",e)},this._emit("peer:connected",e)}_sendToPeer(e,t){const s=this.peers.get(e);s?.transport&&(s.transport.send(JSON.stringify(t)),s.lastSeen=Date.now())}_broadcast(e){const t=JSON.stringify(e);for(const[,e]of this.peers)e.transport&&e.transport.send(t)}_endCall(e){const t=this.activeCalls.get(e);if(!t)return;t.endTime=Date.now(),t.duration=t.connectTime?Math.floor((t.endTime-t.connectTime)/1e3):0,this.callHistory.unshift({...t,timestamp:Date.now()}),this.callHistory.length>100&&this.callHistory.pop();const s=this.peerConnections.get(e);s&&(s.close(),this.peerConnections.delete(e)),this.remoteStreams.delete(e),this.activeCalls.delete(e),this._emit("call:ended",t)}_listeners=new Map;on(e,t){return this._listeners.has(e)||this._listeners.set(e,new Set),this._listeners.get(e).add(t),()=>this._listeners.get(e).delete(t)}_emit(e,t){const s=this._listeners.get(e);if(s)for(const e of s)try{e(t)}catch(e){console.error(e)}}async destroy(){for(const[e]of this.activeCalls)await this.hangup(e);this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=null);for(const[,e]of this.peerConnections)e.close();this.peerConnections.clear();for(const[,e]of this.peers)e.transport?.close&&e.transport.close();this.peers.clear()}}class fM{constructor(e={}){this.namespace=e.namespace||"konocell",this.nodes=new Map,this.directory=new Map}register(e){return this.nodes.set(e.id,e),this.directory.set(e.phoneNumber,e.id),e.on("call:ended",e=>{console.log(`[MeshCell] Call ended: ${e.id} (${e.duration}s)`)}),this}lookup(e){const t=this.directory.get(e);return t?this.nodes.get(t):null}connect(e,t){const s=this._createMockTransport(),r=this._createMockTransport();s.send=e=>r.onmessage?.(e),r.send=e=>s.onmessage?.(e),e.addPeer(t.id,s),t.addPeer(e.id,r)}_createMockTransport(){return{send:()=>{},close:()=>{},onmessage:null,onclose:null}}getStats(){return{nodes:this.nodes.size,directory:this.directory.size,activeCalls:Array.from(this.nodes.values()).reduce((e,t)=>e+t.activeCalls.size,0)}}}const gM="outbound",mM={QUEUED:"queued",RINGING:"ringing",IN_PROGRESS:"in-progress",COMPLETED:"completed",BUSY:"busy",FAILED:"failed",NO_ANSWER:"no-answer",CANCELED:"canceled"},yM={QUEUED:"queued",SENDING:"sending",SENT:"sent",DELIVERED:"delivered",UNDELIVERED:"undelivered",FAILED:"failed"},bM={telnyx:{name:"Telnyx",type:"sip",rates:{voice:.002,sms:.004},features:["voice","sms","mms","fax","numbers"],sipDomain:"sip.telnyx.com"},voipms:{name:"VoIP.ms",type:"sip",rates:{voice:.001,sms:.002},features:["voice","sms","numbers"],sipDomain:"atlanta.voip.ms"},bandwidth:{name:"Bandwidth",type:"sip",rates:{voice:.0025,sms:.003},features:["voice","sms","mms","numbers","911"],sipDomain:"sip.bandwidth.com"},signalwire:{name:"SignalWire",type:"sip",rates:{voice:.002,sms:.0035},features:["voice","sms","mms","video","fax"],sipDomain:"sip.signalwire.com"},flowroute:{name:"Flowroute",type:"sip",rates:{voice:.00124,sms:.0025},features:["voice","sms","mms","numbers"],sipDomain:"sip.flowroute.com"},didlogic:{name:"DIDLogic",type:"sip",rates:{voice:.001,sms:.002},features:["voice","sms","numbers"],sipDomain:"sip.didlogic.net"},bulkvs:{name:"BulkVS",type:"sip",rates:{voice:9e-4,sms:.002},features:["voice","sms","numbers"],sipDomain:"sip.bulkvs.com"},mesh:{name:"KP2P Mesh",type:"mesh",rates:{voice:0,sms:0,mms:0},features:["voice","video","sms","mms","file","unlimited"],sipDomain:null}};class wM{constructor(e={}){this.provider=e.provider,this.username=e.username,this.password=e.password,this.domain=e.domain||bM[e.provider]?.sipDomain,this.registrar=e.registrar||`sip:${this.domain}`,this.proxyUri=e.proxyUri||`sip:${this.domain}`,this.registered=!1,this.calls=new Map,this.ua=null,this.onIncomingCall=null,this.onCallStatus=null}async init(){return console.log(`[SIP] Connecting to ${this.domain}...`),new Promise(e=>{setTimeout(()=>{this.registered=!0,console.log(`[SIP] Registered as ${this.username}@${this.domain}`),e(!0)},1e3)})}async call(e,t={}){if(!this.registered)throw new Error("Not registered");const s=crypto.randomUUID(),r={id:s,direction:gM,from:t.from||this.username,to:e,status:mM.QUEUED,startTime:Date.now(),answerTime:null,endTime:null,duration:0};return this.calls.set(s,r),console.log(`[SIP] Calling ${e}...`),setTimeout(()=>this._updateCallStatus(s,mM.RINGING),500),setTimeout(()=>this._updateCallStatus(s,mM.IN_PROGRESS),2e3),r}async answer(e,t={}){const s=this.calls.get(e);if(!s)throw new Error("Call not found");return s.answerTime=Date.now(),this._updateCallStatus(e,mM.IN_PROGRESS),s}async hangup(e){const t=this.calls.get(e);if(t)return t.endTime=Date.now(),t.duration=t.answerTime?Math.floor((t.endTime-t.answerTime)/1e3):0,this._updateCallStatus(e,mM.COMPLETED),t}async sendDTMF(e,t){console.log(`[SIP] Sending DTMF: ${t}`)}_updateCallStatus(e,t){const s=this.calls.get(e);s&&(s.status=t,this.onCallStatus?.(s))}async destroy(){this.registered=!1,this.calls.clear()}}class vM{constructor(e={}){this.providers=new Map,this.defaultProvider=e.defaultProvider,this.webhookUrl=e.webhookUrl,this.queue=[],this.sent=new Map}addProvider(e,t){return this.providers.set(e,{name:e,...t,available:!0,lastError:null}),this}async send(e){const{to:t,from:s,body:r,provider:n}=e,i=crypto.randomUUID(),o={id:i,to:this._normalizeNumber(t),from:s,body:r,status:yM.QUEUED,provider:null,createdAt:Date.now(),sentAt:null,deliveredAt:null,errorCode:null,errorMessage:null},a=this._selectProvider(t,n);if(!a)return o.status=yM.FAILED,o.errorMessage="No provider available",o;o.provider=a.name,this.sent.set(i,o);try{await this._sendViaProvider(a,o),o.status=yM.SENT,o.sentAt=Date.now()}catch(e){o.status=yM.FAILED,o.errorMessage=e.message}return this._triggerWebhook("sms.status",o),o}_selectProvider(e,t){if(t&&this.providers.has(t)){const e=this.providers.get(t);if(e.available)return e}const s=Array.from(this.providers.values()).filter(e=>e.available).sort((e,t)=>(e.rates?.sms||999)-(t.rates?.sms||999));return s[0]||null}async _sendViaProvider(e,t){switch(console.log(`[SMS] Sending via ${e.name}: ${t.to}`),e.type){case"api":return this._sendViaAPI(e,t);case"smpp":return this._sendViaSMPP(e,t);case"mesh":return this._sendViaMesh(t);default:throw new Error(`Unknown provider type: ${e.type}`)}}async _sendViaAPI(e,t){const s=await fetch(e.endpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({to:t.to,from:t.from,text:t.body})});if(!s.ok)throw new Error(`API error: ${s.status}`);return s.json()}async _sendViaSMPP(e,t){console.log("[SMS] SMPP send not implemented")}async _sendViaMesh(e){console.log("[SMS] Routing via mesh network")}handleIncoming(e,t){const s={id:crypto.randomUUID(),direction:"incoming",from:t.from,to:t.to,body:t.body||t.text,provider:e.name,receivedAt:Date.now()};return this._triggerWebhook("sms.incoming",s),s}_normalizeNumber(e){const t=e.replace(/\D/g,"");return 10===t.length?`+1${t}`:(11===t.length&&t[0],`+${t}`)}_triggerWebhook(e,t){this.webhookUrl&&fetch(this.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({event:e,data:t,timestamp:Date.now()})}).catch(e=>console.error("[Webhook] Failed:",e))}}class SM{constructor(){this.instructions=[]}say(e,t={}){return this.instructions.push({type:"say",text:e,voice:t.voice||"alice",language:t.language||"en-US"}),this}play(e,t={}){return this.instructions.push({type:"play",url:e,loop:t.loop||1}),this}gather(e={}){return this.instructions.push({type:"gather",numDigits:e.numDigits,timeout:e.timeout||5,action:e.action,method:e.method||"POST",finishOnKey:e.finishOnKey||"#"}),this}dial(e,t={}){return this.instructions.push({type:"dial",number:e,callerId:t.callerId,timeout:t.timeout||30,record:t.record||!1,action:t.action}),this}record(e={}){return this.instructions.push({type:"record",maxLength:e.maxLength||3600,action:e.action,transcribe:e.transcribe||!1,playBeep:e.playBeep??!0}),this}conference(e,t={}){return this.instructions.push({type:"conference",name:e,muted:t.muted||!1,startOnEnter:t.startOnEnter??!0,endOnExit:t.endOnExit||!1,waitUrl:t.waitUrl}),this}hangup(){return this.instructions.push({type:"hangup"}),this}pause(e=1){return this.instructions.push({type:"pause",length:e}),this}redirect(e,t="POST"){return this.instructions.push({type:"redirect",url:e,method:t}),this}reject(e="rejected"){return this.instructions.push({type:"reject",reason:e}),this}toXML(){let e='<?xml version="1.0" encoding="UTF-8"?>\n<Response>\n';for(const t of this.instructions)e+=this._instructionToXML(t);return e+="</Response>",e}toJSON(){return{instructions:this.instructions}}_instructionToXML(e){switch(e.type){case"say":return`  <Say voice="${e.voice}" language="${e.language}">${e.text}</Say>\n`;case"play":return`  <Play loop="${e.loop}">${e.url}</Play>\n`;case"gather":return`  <Gather numDigits="${e.numDigits}" timeout="${e.timeout}" action="${e.action}" finishOnKey="${e.finishOnKey}"/>\n`;case"dial":return`  <Dial callerId="${e.callerId}" timeout="${e.timeout}">${e.number}</Dial>\n`;case"record":return`  <Record maxLength="${e.maxLength}" transcribe="${e.transcribe}"/>\n`;case"hangup":return"  <Hangup/>\n";case"pause":return`  <Pause length="${e.length}"/>\n`;case"redirect":return`  <Redirect method="${e.method}">${e.url}</Redirect>\n`;case"reject":return`  <Reject reason="${e.reason}"/>\n`;default:return""}}}class EM{constructor(e={}){this.accountId=e.accountId||crypto.randomUUID(),this.authToken=e.authToken||this._generateToken(),this.sipClients=new Map,this.smsGateway=new vM({webhookUrl:e.smsWebhook}),this.numbers=new Map,this.webhooks={voice:e.voiceWebhook,sms:e.smsWebhook,status:e.statusWebhook},this.routes=[],this.cdr=[]}async addTrunk(e,t){const s=new wM({provider:e,...t});return s.onIncomingCall=t=>this._handleIncomingCall(e,t),s.onCallStatus=e=>this._handleCallStatus(e),await s.init(),this.sipClients.set(e,s),this}addSMSProvider(e,t){return this.smsGateway.addProvider(e,t),this}async provisionNumber(e,t={}){const s={number:this._normalizeNumber(e),provider:t.provider,voiceUrl:t.voiceUrl,smsUrl:t.smsUrl,capabilities:t.capabilities||["voice","sms"],provisionedAt:Date.now()};return this.numbers.set(s.number,s),s}async call(e){const{to:t,from:s,url:r,method:n="POST",statusCallback:i}=e,o=this._selectTrunk(t);if(!o)throw new Error("No trunk available");const a=this.sipClients.get(o),c=await a.call(t,{from:s});return r&&this._fetchAndExecuteTwiML(c.id,r,n),{sid:c.id,to:c.to,from:c.from,status:c.status,direction:c.direction,startTime:new Date(c.startTime).toISOString()}}async sendSMS(e){const t=await this.smsGateway.send(e);return{sid:t.id,to:t.to,from:e.from,body:e.body,status:t.status,dateCreated:new Date(t.createdAt).toISOString()}}getCall(e){for(const[,t]of this.sipClients){const s=t.calls.get(e);if(s)return this._formatCall(s)}return null}async updateCall(e,t){for(const[,s]of this.sipClients)if(s.calls.has(e))return"completed"===t.status&&await s.hangup(e),t.url&&await this._fetchAndExecuteTwiML(e,t.url,t.method),this.getCall(e);throw new Error("Call not found")}getAccount(){return{sid:this.accountId,type:"konotel",status:"active",numbers:this.numbers.size,trunks:this.sipClients.size}}_selectTrunk(e){for(const[e,t]of this.sipClients)if(t.registered)return e;return null}async _fetchAndExecuteTwiML(e,t,s){try{const r=await fetch(t,{method:s});await r.text();console.log(`[VoiceML] Executing for call ${e}`)}catch(e){console.error("[VoiceML] Failed to fetch:",e)}}_handleIncomingCall(e,t){const s=this.numbers.get(t.to);s?.voiceUrl&&this._fetchAndExecuteTwiML(t.id,s.voiceUrl,"POST")}_handleCallStatus(e){e.status===mM.COMPLETED&&this.cdr.push({...e,endTime:Date.now()}),this.webhooks.status&&fetch(this.webhooks.status,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this._formatCall(e))}).catch(()=>{})}_formatCall(e){return{sid:e.id,to:e.to,from:e.from,status:e.status,direction:e.direction,duration:e.duration,startTime:new Date(e.startTime).toISOString(),endTime:e.endTime?new Date(e.endTime).toISOString():null}}_normalizeNumber(e){const t=e.replace(/\D/g,"");return 10===t.length?`+1${t}`:(11===t.length&&t[0],`+${t}`)}_generateToken(){return"kt_"+crypto.randomUUID().replace(/-/g,"")}}function DM(e){return{createCall:async t=>e.call({to:t.body.To,from:t.body.From,url:t.body.Url,method:t.body.Method,statusCallback:t.body.StatusCallback}),getCall:async t=>e.getCall(t.params.CallSid),updateCall:async t=>e.updateCall(t.params.CallSid,{status:t.body.Status,url:t.body.Url,method:t.body.Method}),sendMessage:async t=>e.sendSMS({to:t.body.To,from:t.body.From,body:t.body.Body}),getAccount:async t=>e.getAccount()}}const _M={WIFI_DIRECT:"wifi-direct",WIFI_MESH:"wifi-mesh",BLUETOOTH:"bluetooth",BLE_MESH:"ble-mesh",LORA:"lora",ZIGBEE:"zigbee",WEBRTC:"webrtc",WEBSOCKET:"websocket",HTTP:"http",WEBTORRENT:"webtorrent",SMS:"sms",USSD:"ussd",DATA:"cellular-data",AUDIO:"audio-modem",DTMF:"dtmf",QR_CODE:"qr-code",NFC:"nfc",USB:"usb",HAM_RADIO:"ham-radio",SATELLITE:"satellite",HF_RADIO:"hf-radio",SNEAKERNET:"sneakernet",PAPER:"paper-code"},TM={[_M.WIFI_DIRECT]:{range:100,bandwidth:"high",realtime:!0,cost:0},[_M.WIFI_MESH]:{range:500,bandwidth:"high",realtime:!0,cost:0},[_M.BLUETOOTH]:{range:10,bandwidth:"medium",realtime:!0,cost:0},[_M.BLE_MESH]:{range:100,bandwidth:"low",realtime:!0,cost:0},[_M.LORA]:{range:15e3,bandwidth:"very-low",realtime:!1,cost:0},[_M.WEBRTC]:{range:"global",bandwidth:"high",realtime:!0,cost:0},[_M.SMS]:{range:"global",bandwidth:"very-low",realtime:!1,cost:"per-msg"},[_M.AUDIO]:{range:10,bandwidth:"very-low",realtime:!0,cost:0},[_M.HAM_RADIO]:{range:"global",bandwidth:"low",realtime:!0,cost:0},[_M.SATELLITE]:{range:"global",bandwidth:"medium",realtime:!0,cost:"high"},[_M.SNEAKERNET]:{range:"unlimited",bandwidth:"high",realtime:!1,cost:0}},IM={EMERGENCY:0,URGENT:1,NORMAL:2,BULK:3,BACKGROUND:4},CM={TEXT:"text",VOICE:"voice",VIDEO:"video",FILE:"file",ACK:"ack",PING:"ping",ROUTE:"route",ANNOUNCE:"announce",BUNDLE:"bundle",FRAGMENT:"fragment",CUSTODY:"custody"};class PM{constructor(e={}){this.id=e.id||crypto.randomUUID(),this.type=e.type||CM.TEXT,this.priority=e.priority??IM.NORMAL,this.from=e.from,this.to=e.to,this.toGroup=e.toGroup,this.payload=e.payload,this.encoding=e.encoding||"utf8",this.compressed=e.compressed||!1,this.encrypted=e.encrypted||!1,this.hops=e.hops||0,this.maxHops=e.maxHops||20,this.path=e.path||[],this.ttl=e.ttl||864e5,this.created=e.created||Date.now(),this.expires=e.expires||Date.now()+this.ttl,this.bundle=e.bundle||null,this.fragment=e.fragment||null,this.custodyRequired=e.custodyRequired||!1,this.delivered=e.delivered||!1,this.deliveredAt=e.deliveredAt||null,this.acks=e.acks||[]}serialize(e="json"){const t={i:this.id,t:this.type,p:this.priority,f:this.from,o:this.to,g:this.toGroup,d:this.payload,e:this.encoding,c:this.compressed,x:this.encrypted,h:this.hops,m:this.maxHops,a:this.path,r:this.created,s:this.expires};switch(e){case"json":default:return JSON.stringify(t);case"msgpack":return this._msgpack(t);case"binary":return this._toBinary(t);case"base64":return btoa(JSON.stringify(t));case"hex":return this._toHex(JSON.stringify(t))}}static deserialize(e,t="json"){let s;switch(t){case"json":default:s=JSON.parse(e);break;case"base64":s=JSON.parse(atob(e));break;case"hex":s=JSON.parse(PM._fromHex(e))}return new PM({id:s.i,type:s.t,priority:s.p,from:s.f,to:s.o,toGroup:s.g,payload:s.d,encoding:s.e,compressed:s.c,encrypted:s.x,hops:s.h,maxHops:s.m,path:s.a,created:s.r,expires:s.s})}_toHex(e){return Array.from(e).map(e=>e.charCodeAt(0).toString(16).padStart(2,"0")).join("")}static _fromHex(e){return e.match(/.{2}/g).map(e=>String.fromCharCode(parseInt(e,16))).join("")}fragment(e=140){const t=this.serialize("base64"),s=[],r=Math.ceil(t.length/e);for(let n=0;n<r;n++){const i=t.slice(n*e,(n+1)*e);s.push(new PM({type:CM.FRAGMENT,from:this.from,to:this.to,priority:this.priority,payload:i,fragment:{id:this.id,index:n,total:r}}))}return s}static reassemble(e){e.sort((e,t)=>e.fragment.index-t.fragment.index);const t=e.map(e=>e.payload).join("");return PM.deserialize(t,"base64")}}class xM{constructor(e,t={}){this.type=e,this.options=t,this.available=!1,this.connected=!1,this.peers=new Map,this.onMessage=null,this.onPeer=null}async init(){throw new Error("Not implemented")}async send(e,t){throw new Error("Not implemented")}async broadcast(e){throw new Error("Not implemented")}async discover(){throw new Error("Not implemented")}async destroy(){throw new Error("Not implemented")}getCapabilities(){return TM[this.type]||{}}}class AM extends xM{constructor(e={}){super(_M.SMS,e),this.gateway=e.gateway,this.phoneNumber=e.phoneNumber,this.maxMessageSize=140}async init(){return("sms"in navigator||this.gateway)&&(this.available=!0),this.available}async send(e,t){if(!this.available)throw new Error("SMS not available");if(t.serialize().length>this.maxMessageSize){const s=t.fragment(this.maxMessageSize);for(const t of s)await this._sendSMS(e,t.serialize("base64"))}else await this._sendSMS(e,t.serialize("base64"))}async _sendSMS(e,t){this.gateway?await fetch(this.gateway,{method:"POST",body:JSON.stringify({to:e,body:t,from:this.phoneNumber})}):"sms"in navigator&&await navigator.sms.send(e,t)}handleIncoming(e,t){try{const s=PM.deserialize(t,"base64");this.onMessage?.(e,s)}catch(s){this._bufferFragment(e,t)}}_fragmentBuffer=new Map;_bufferFragment(e,t){try{const s=PM.deserialize(t,"base64");if(s.type===CM.FRAGMENT){const t=`${e}:${s.fragment.id}`;this._fragmentBuffer.has(t)||this._fragmentBuffer.set(t,[]);const r=this._fragmentBuffer.get(t);if(r.push(s),r.length===s.fragment.total){const s=PM.reassemble(r);this._fragmentBuffer.delete(t),this.onMessage?.(e,s)}}}catch(e){console.error("Failed to parse fragment:",e)}}}class kM extends xM{constructor(e={}){super(_M.LORA,e),this.frequency=e.frequency||915,this.spreadingFactor=e.sf||7,this.bandwidth=e.bw||125,this.serialPort=null}async init(){if("serial"in navigator)try{this.serialPort=await navigator.serial.requestPort(),await this.serialPort.open({baudRate:115200}),this.available=!0,this._startReading()}catch(e){console.error("LoRa init failed:",e)}return this.available}async send(e,t){if(!this.serialPort)throw new Error("LoRa not available");const s=t.serialize("hex"),r=this.serialPort.writable.getWriter();await r.write((new TextEncoder).encode(`AT+SEND=${e},${s}\r\n`)),r.releaseLock()}async broadcast(e){return this.send("255",e)}async _startReading(){const e=this.serialPort.readable.getReader();let t="";for(;;){const{value:s,done:r}=await e.read();if(r)break;t+=(new TextDecoder).decode(s);const n=t.split("\r\n");t=n.pop();for(const e of n)if(e.startsWith("+RCV=")){const t=e.match(/\+RCV=(\d+),(\d+),(.+)/);if(t){const[,e,s,r]=t;try{const t=PM.deserialize(r,"hex");this.onMessage?.(e,t)}catch(e){console.error("Failed to parse LoRa message:",e)}}}}}async destroy(){this.serialPort&&await this.serialPort.close()}}class NM extends xM{constructor(e={}){super(_M.AUDIO,e),this.sampleRate=44100,this.baseFreq=e.baseFreq||1e3,this.freqStep=e.freqStep||100,this.bitDuration=e.bitDuration||.1,this.audioContext=null}async init(){try{this.audioContext=new AudioContext({sampleRate:this.sampleRate}),this.available=!0}catch(e){console.error("Audio init failed:",e)}return this.available}async send(e,t){const s=t.serialize("hex"),r=this.audioContext.createOscillator(),n=this.audioContext.createGain();r.connect(n),n.connect(this.audioContext.destination),r.start();for(let e=0;e<s.length;e++){const t=parseInt(s[e],16);r.frequency.setValueAtTime(this.baseFreq+t*this.freqStep,this.audioContext.currentTime+e*this.bitDuration)}r.frequency.setValueAtTime(this.baseFreq-this.freqStep,this.audioContext.currentTime+s.length*this.bitDuration),setTimeout(()=>r.stop(),(s.length+1)*this.bitDuration*1e3)}async startListening(){const e=await navigator.mediaDevices.getUserMedia({audio:!0}),t=this.audioContext.createMediaStreamSource(e),s=this.audioContext.createAnalyser();s.fftSize=2048,t.connect(s);const r=s.frequencyBinCount,n=new Uint8Array(r),i=()=>{s.getByteFrequencyData(n);let e=0,t=0;for(let s=0;s<r;s++)n[s]>t&&(t=n[s],e=s);const o=e*this.sampleRate/s.fftSize;if(o>=this.baseFreq&&t>100){const e=Math.round((o-this.baseFreq)/this.freqStep);e>=0&&e<=15&&this._bufferBit(e.toString(16))}requestAnimationFrame(i)};i()}_receiveBuffer="";_lastBitTime=0;_bufferBit(e){const t=Date.now();if(t-this._lastBitTime>2e3*this.bitDuration&&this._receiveBuffer.length>0){try{const e=PM.deserialize(this._receiveBuffer,"hex");this.onMessage?.("audio",e)}catch(e){}this._receiveBuffer=""}this._receiveBuffer+=e,this._lastBitTime=t}}class RM{constructor(e={}){this.nodeId=e.nodeId||crypto.randomUUID(),this.storage=e.storage||new Map,this.maxStorage=e.maxStorage||104857600,this.currentStorage=0}async store(e){const t=e.id,s=e.serialize().length;return this.currentStorage+s>this.maxStorage&&await this._evict(s),this.storage.set(t,{message:e,size:s,storedAt:Date.now(),attempts:0,lastAttempt:null}),this.currentStorage+=s,t}getMessagesFor(e){const t=[];for(const[,s]of this.storage)(s.message.to===e||s.message.toGroup)&&t.push(s.message);return t}markDelivered(e){const t=this.storage.get(e);t&&(this.currentStorage-=t.size,this.storage.delete(e))}getForwardable(e=[]){const t=[];for(const[,s]of this.storage)s.message.delivered||e.includes(s.message.from)||t.push(s.message);return t}async _evict(e){const t=Array.from(this.storage.entries()).sort((e,t)=>e[1].message.priority!==t[1].message.priority?t[1].message.priority-e[1].message.priority:e[1].storedAt-t[1].storedAt);let s=0;for(const[r,n]of t){if(s>=e)break;n.message.priority!==IM.EMERGENCY&&(n.message.expires>Date.now()||(s+=n.size,this.currentStorage-=n.size,this.storage.delete(r)))}}cleanup(){const e=Date.now();for(const[t,s]of this.storage)s.message.expires<e&&(this.currentStorage-=s.size,this.storage.delete(t))}}class MM{constructor(e={}){this.id=e.id||crypto.randomUUID(),this.name=e.name||"Anonymous",this.transports=new Map,this.store=new RM({nodeId:this.id}),this.peers=new Map,this.handlers=new Map,this.pendingAcks=new Map,this.config={autoForward:e.autoForward??!0,epidemicRouting:e.epidemicRouting??!0,encryptByDefault:e.encryptByDefault??!0}}addTransport(e){return e.onMessage=(t,s)=>this._handleMessage(t,s,e.type),e.onPeer=t=>this._handlePeer(t,e.type),this.transports.set(e.type,e),this}async init(){await Promise.allSettled(Array.from(this.transports.values()).map(e=>e.init())),console.log("[FreeComm] Transport status:");for(const[e,t]of this.transports)console.log(`  ${e}: ${t.available?"âœ“":"âœ—"}`);return this._startPeriodicTasks(),this}async send(e,t,s={}){const r=new PM({from:this.id,to:e,type:s.type||CM.TEXT,priority:s.priority??IM.NORMAL,payload:t,encrypted:s.encrypted??this.config.encryptByDefault}),n=this._findBestTransport(e,r.priority);if(n&&n.connected)try{return await n.send(e,r),{status:"sent",transport:n.type}}catch(e){console.error(`Send failed on ${n.type}:`,e)}return await this.store.store(r),{status:"stored",messageId:r.id}}_findBestTransport(e,t){const s=this.peers.get(e);if(!s)return null;const r=Array.from(this.transports.values()).filter(e=>e.available&&s.transports?.includes(e.type)).sort((e,s)=>{const r=e.getCapabilities(),n=s.getCapabilities();return t===IM.EMERGENCY&&r.realtime!==n.realtime?r.realtime?-1:1:r.cost!==n.cost?(r.cost||0)-(n.cost||0):0});return r[0]||null}_handleMessage(e,t,s){this._updatePeer(e,s),t.to===this.id?(this._deliverLocal(t),t.custodyRequired&&this._sendAck(e,t.id,s)):this.config.autoForward&&this._forward(t),this.config.epidemicRouting&&this._exchangeMessages(e,s)}_deliverLocal(e){const t=this.handlers.get(e.type);t&&t(e),this._emit("message",e)}async _forward(e){if(e.hops>=e.maxHops)return;e.hops++,e.path.push(this.id),await this.store.store(e);const t=this._findBestTransport(e.to,e.priority);if(t)try{await t.send(e.to,e),this.store.markDelivered(e.id)}catch(e){}}async _exchangeMessages(e,t){const s=this.transports.get(t);if(!s)return;const r=this.store.getMessagesFor(e);for(const t of r)try{await s.send(e,t)}catch(e){}}_updatePeer(e,t){this.peers.has(e)||this.peers.set(e,{id:e,transports:[],lastSeen:Date.now()});const s=this.peers.get(e);s.lastSeen=Date.now(),s.transports.includes(t)||s.transports.push(t)}_handlePeer(e,t){this._updatePeer(e,t),this._emit("peer",{id:e,transport:t})}on(e,t){return this.handlers.set(e,t),this}_startPeriodicTasks(){setInterval(()=>this.store.cleanup(),6e4),setInterval(()=>this._tryDeliverStored(),3e4),setInterval(()=>this._discover(),6e4)}async _tryDeliverStored(){for(const[e,t]of this.peers){const s=this.store.getMessagesFor(e);if(0!==s.length)for(const r of t.transports){const t=this.transports.get(r);if(t?.available)for(const r of s)try{await t.send(e,r),this.store.markDelivered(r.id)}catch(e){break}}}}async _discover(){for(const e of this.transports.values())if(e.available&&e.discover)try{await e.discover()}catch(e){}}_listeners=new Map;_emit(e,t){(this._listeners.get(e)||[]).forEach(e=>e(t))}onEvent(e,t){return this._listeners.has(e)||this._listeners.set(e,[]),this._listeners.get(e).push(t),()=>{const s=this._listeners.get(e),r=s.indexOf(t);r>=0&&s.splice(r,1)}}async destroy(){for(const e of this.transports.values())await(e.destroy?.())}}const LM=()=>new Map,OM=e=>{const t=LM();return e.forEach((e,s)=>{t.set(s,e)}),t},BM=(e,t,s)=>{let r=e.get(t);return void 0===r&&e.set(t,r=s()),r},UM=()=>new Set,VM=e=>e[e.length-1],FM=(e,t)=>{for(let s=0;s<t.length;s++)e.push(t[s])},zM=Array.from,$M=(e,t)=>{for(let s=0;s<e.length;s++)if(!t(e[s],s,e))return!1;return!0},qM=(e,t)=>{for(let s=0;s<e.length;s++)if(t(e[s],s,e))return!0;return!1},WM=Array.isArray;class KM{constructor(){this._observers=LM()}on(e,t){return BM(this._observers,e,UM).add(t),t}once(e,t){const s=(...r)=>{this.off(e,s),t(...r)};this.on(e,s)}off(e,t){const s=this._observers.get(e);void 0!==s&&(s.delete(t),0===s.size&&this._observers.delete(e))}emit(e,t){return zM((this._observers.get(e)||LM()).values()).forEach(e=>e(...t))}destroy(){this._observers=LM()}}class jM{constructor(){this._observers=LM()}on(e,t){BM(this._observers,e,UM).add(t)}once(e,t){const s=(...r)=>{this.off(e,s),t(...r)};this.on(e,s)}off(e,t){const s=this._observers.get(e);void 0!==s&&(s.delete(t),0===s.size&&this._observers.delete(e))}emit(e,t){return zM((this._observers.get(e)||LM()).values()).forEach(e=>e(...t))}destroy(){this._observers=LM()}}const HM=Math.floor,GM=Math.abs,QM=(e,t)=>e<t?e:t,XM=(e,t)=>e>t?e:t,YM=e=>0!==e?e<0:1/e<0,JM=64,ZM=128,eL=127,tL=Number.MAX_SAFE_INTEGER,sL=Number.MIN_SAFE_INTEGER,rL=Number.isInteger||(e=>"number"==typeof e&&isFinite(e)&&HM(e)===e),nL=String.fromCharCode,iL=/^\s*/g,oL=/([A-Z])/g,aL=(e,t)=>(e=>e.replace(iL,""))(e.replace(oL,e=>`${t}${(e=>e.toLowerCase())(e)}`)),cL="undefined"!=typeof TextEncoder?new TextEncoder:null,lL=cL?e=>cL.encode(e):e=>{const t=unescape(encodeURIComponent(e)),s=t.length,r=new Uint8Array(s);for(let e=0;e<s;e++)r[e]=t.codePointAt(e);return r};let hL="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});hL&&1===hL.decode(new Uint8Array).length&&(hL=null);const uL=(e,t)=>((e,t)=>{const s=new Array(e);for(let r=0;r<e;r++)s[r]=t(r,s);return s})(t,()=>e).join("");class dL{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const pL=()=>new dL,fL=e=>{const t=new Uint8Array((e=>{let t=e.cpos;for(let s=0;s<e.bufs.length;s++)t+=e.bufs[s].length;return t})(e));let s=0;for(let r=0;r<e.bufs.length;r++){const n=e.bufs[r];t.set(n,s),s+=n.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),s),t},gL=(e,t)=>{const s=e.cbuf.length;e.cpos===s&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(2*s),e.cpos=0),e.cbuf[e.cpos++]=t},mL=gL,yL=(e,t)=>{for(;t>eL;)gL(e,ZM|eL&t),t=HM(t/128);gL(e,eL&t)},bL=(e,t)=>{const s=YM(t);for(s&&(t=-t),gL(e,(t>63?ZM:0)|(s?JM:0)|63&t),t=HM(t/64);t>0;)gL(e,(t>eL?ZM:0)|eL&t),t=HM(t/128)},wL=new Uint8Array(3e4),vL=wL.length/3,SL=cL&&cL.encodeInto?(e,t)=>{if(t.length<vL){const s=cL.encodeInto(t,wL).written||0;yL(e,s);for(let t=0;t<s;t++)gL(e,wL[t])}else DL(e,lL(t))}:(e,t)=>{const s=unescape(encodeURIComponent(t)),r=s.length;yL(e,r);for(let t=0;t<r;t++)gL(e,s.codePointAt(t))},EL=(e,t)=>{const s=e.cbuf.length,r=e.cpos,n=QM(s-r,t.length),i=t.length-n;e.cbuf.set(t.subarray(0,n),r),e.cpos+=n,i>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(XM(2*s,i)),e.cbuf.set(t.subarray(n)),e.cpos=i)},DL=(e,t)=>{yL(e,t.byteLength),EL(e,t)},_L=(e,t)=>{((e,t)=>{const s=e.cbuf.length;s-e.cpos<t&&(e.bufs.push(new Uint8Array(e.cbuf.buffer,0,e.cpos)),e.cbuf=new Uint8Array(2*XM(s,t)),e.cpos=0)})(e,t);const s=new DataView(e.cbuf.buffer,e.cpos,t);return e.cpos+=t,s},TL=new DataView(new ArrayBuffer(4)),IL=(e,t)=>{switch(typeof t){case"string":gL(e,119),SL(e,t);break;case"number":rL(t)&&GM(t)<=2147483647?(gL(e,125),bL(e,t)):(s=t,TL.setFloat32(0,s),TL.getFloat32(0)===s?(gL(e,124),((e,t)=>{_L(e,4).setFloat32(0,t,!1)})(e,t)):(gL(e,123),((e,t)=>{_L(e,8).setFloat64(0,t,!1)})(e,t)));break;case"bigint":gL(e,122),((e,t)=>{_L(e,8).setBigInt64(0,t,!1)})(e,t);break;case"object":if(null===t)gL(e,126);else if(WM(t)){gL(e,117),yL(e,t.length);for(let s=0;s<t.length;s++)IL(e,t[s])}else if(t instanceof Uint8Array)gL(e,116),DL(e,t);else{gL(e,118);const s=Object.keys(t);yL(e,s.length);for(let r=0;r<s.length;r++){const n=s[r];SL(e,n),IL(e,t[n])}}break;case"boolean":gL(e,t?120:121);break;default:gL(e,127)}var s};class CL extends dL{constructor(e){super(),this.w=e,this.s=null,this.count=0}write(e){this.s===e?this.count++:(this.count>0&&yL(this,this.count-1),this.count=1,this.w(this,e),this.s=e)}}const PL=e=>{e.count>0&&(bL(e.encoder,1===e.count?e.s:-e.s),e.count>1&&yL(e.encoder,e.count-2))};class xL{constructor(){this.encoder=new dL,this.s=0,this.count=0}write(e){this.s===e?this.count++:(PL(this),this.count=1,this.s=e)}toUint8Array(){return PL(this),fL(this.encoder)}}const AL=e=>{if(e.count>0){const t=2*e.diff+(1===e.count?0:1);bL(e.encoder,t),e.count>1&&yL(e.encoder,e.count-2)}};class kL{constructor(){this.encoder=new dL,this.s=0,this.count=0,this.diff=0}write(e){this.diff===e-this.s?(this.s=e,this.count++):(AL(this),this.count=1,this.diff=e-this.s,this.s=e)}toUint8Array(){return AL(this),fL(this.encoder)}}class NL{constructor(){this.sarr=[],this.s="",this.lensE=new xL}write(e){this.s+=e,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(e.length)}toUint8Array(){const e=new dL;return this.sarr.push(this.s),this.s="",SL(e,this.sarr.join("")),EL(e,this.lensE.toUint8Array()),fL(e)}}const RL=e=>new Error(e),ML=()=>{throw RL("Method unimplemented")},LL=()=>{throw RL("Unexpected case")},OL=RL("Unexpected end of array"),BL=RL("Integer out of Range");class UL{constructor(e){this.arr=e,this.pos=0}}const VL=e=>new UL(e),FL=e=>((e,t)=>{const s=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,s})(e,$L(e)),zL=e=>e.arr[e.pos++],$L=e=>{let t=0,s=1;const r=e.arr.length;for(;e.pos<r;){const r=e.arr[e.pos++];if(t+=(r&eL)*s,s*=128,r<ZM)return t;if(t>tL)throw BL}throw OL},qL=e=>{let t=e.arr[e.pos++],s=63&t,r=64;const n=(t&JM)>0?-1:1;if(0===(t&ZM))return n*s;const i=e.arr.length;for(;e.pos<i;){if(t=e.arr[e.pos++],s+=(t&eL)*r,r*=128,t<ZM)return n*s;if(s>tL)throw BL}throw OL},WL=hL?e=>hL.decode(FL(e)):e=>{let t=$L(e);if(0===t)return"";{let s=String.fromCodePoint(zL(e));if(--t<100)for(;t--;)s+=String.fromCodePoint(zL(e));else for(;t>0;){const r=t<1e4?t:1e4,n=e.arr.subarray(e.pos,e.pos+r);e.pos+=r,s+=String.fromCodePoint.apply(null,n),t-=r}return decodeURIComponent(escape(s))}},KL=(e,t)=>{const s=new DataView(e.arr.buffer,e.arr.byteOffset+e.pos,t);return e.pos+=t,s},jL=[e=>{},e=>null,qL,e=>KL(e,4).getFloat32(0,!1),e=>KL(e,8).getFloat64(0,!1),e=>KL(e,8).getBigInt64(0,!1),e=>!1,e=>!0,WL,e=>{const t=$L(e),s={};for(let r=0;r<t;r++){s[WL(e)]=HL(e)}return s},e=>{const t=$L(e),s=[];for(let r=0;r<t;r++)s.push(HL(e));return s},FL],HL=e=>jL[127-zL(e)](e);class GL extends UL{constructor(e,t){super(e),this.reader=t,this.s=null,this.count=0}read(){var e;return 0===this.count&&(this.s=this.reader(this),(e=this).pos!==e.arr.length?this.count=$L(this)+1:this.count=-1),this.count--,this.s}}class QL extends UL{constructor(e){super(e),this.s=0,this.count=0}read(){if(0===this.count){this.s=qL(this);const e=YM(this.s);this.count=1,e&&(this.s=-this.s,this.count=$L(this)+2)}return this.count--,this.s}}class XL extends UL{constructor(e){super(e),this.s=0,this.count=0,this.diff=0}read(){if(0===this.count){const e=qL(this),t=1&e;this.diff=HM(e/2),this.count=1,t&&(this.count=$L(this)+2)}return this.s+=this.diff,this.count--,this.s}}class YL{constructor(e){this.decoder=new QL(e),this.str=WL(this.decoder),this.spos=0}read(){const e=this.spos+this.decoder.read(),t=this.str.slice(this.spos,e);return this.spos=e,t}}const JL=crypto.getRandomValues.bind(crypto),ZL=()=>JL(new Uint32Array(1))[0],eO=[1e7]+-1e3+-4e3+-8e3+-1e11,tO=()=>eO.replace(/[018]/g,e=>(e^ZL()&15>>e/4).toString(16)),sO=Date.now,rO=e=>new Promise(e);Promise.all.bind(Promise);const nO=e=>void 0===e?null:e;let iO=new class{constructor(){this.map=new Map}setItem(e,t){this.map.set(e,t)}getItem(e){return this.map.get(e)}},oO=!0;try{"undefined"!=typeof localStorage&&localStorage&&(iO=localStorage,oO=!1)}catch(tl){}const aO=iO,cO=Symbol("Equality"),lO=(e,t)=>e===t||!!e?.[cO]?.(t)||!1,hO=Object.assign,uO=Object.keys,dO=e=>uO(e).length,pO=(e,t)=>{for(const s in e)if(!t(e[s],s))return!1;return!0},fO=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),gO=Object.freeze,mO=e=>{for(const t in e){const s=e[t];"object"!=typeof s&&"function"!=typeof s||mO(e[t])}return gO(e)},yO=(e,t,s=0)=>{try{for(;s<e.length;s++)e[s](...t)}finally{s<e.length&&yO(e,t,s+1)}},bO=e=>e,wO=(e,t)=>{if(e===t)return!0;if(null==e||null==t||e.constructor!==t.constructor&&(e.constructor||Object)!==(t.constructor||Object))return!1;if(null!=e[cO])return e[cO](t);switch(e.constructor){case ArrayBuffer:e=new Uint8Array(e),t=new Uint8Array(t);case Uint8Array:if(e.byteLength!==t.byteLength)return!1;for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!1;break;case Set:if(e.size!==t.size)return!1;for(const s of e)if(!t.has(s))return!1;break;case Map:if(e.size!==t.size)return!1;for(const s of e.keys())if(!t.has(s)||!wO(e.get(s),t.get(s)))return!1;break;case void 0:case Object:if(dO(e)!==dO(t))return!1;for(const s in e)if(!fO(e,s)||!wO(e[s],t[s]))return!1;break;case Array:if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(!wO(e[s],t[s]))return!1;break;default:return!1}return!0},vO="undefined"!=typeof process&&process.release&&/node|io\.js/.test(process.release.name)&&"[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);let SO;const EO=e=>(()=>{if(void 0===SO)if(vO){SO=LM();const e=process.argv;let t=null;for(let s=0;s<e.length;s++){const r=e[s];"-"===r[0]?(null!==t&&SO.set(t,""),t=r):null!==t&&(SO.set(t,r),t=null)}null!==t&&SO.set(t,"")}else"object"==typeof location?(SO=LM(),(location.search||"?").slice(1).split("&").forEach(e=>{if(0!==e.length){const[t,s]=e.split("=");SO.set(`--${aL(t,"-")}`,s),SO.set(`-${aL(t,"-")}`,s)}})):SO=LM();return SO})().has(e),DO=e=>nO(vO?process.env[e.toUpperCase().replaceAll("-","_")]:aO.getItem(e)),_O=e=>EO("--"+e)||null!==DO(e),TO=_O("production"),IO=vO&&((e,t)=>t.includes(e))(process.env.FORCE_COLOR,["true","1","2"]),CO=IO||!EO("--no-colors")&&!_O("no-color")&&(!vO||process.stdout.isTTY)&&(!vO||EO("--color")||null!==DO("COLORTERM")||(DO("TERM")||"").includes("color")),PO=e=>{const t=(s=e.byteLength,new Uint8Array(s));var s;return t.set(e),t};class xO{constructor(e,t){this.left=e,this.right=t}}const AO=(e,t)=>new xO(e,t),kO=e=>e.next()>=.5,NO=(e,t,s)=>HM(e.next()*(s+1-t)+t),RO=(e,t,s)=>HM(e.next()*(s+1-t)+t),MO=(e,t,s)=>RO(e,t,s),LO=e=>nL(MO(e,97,122)),OO=(e,t)=>t[MO(e,0,t.length-1)],BO=Symbol("0schema");class UO{constructor(){this._rerrs=[]}extend(e,t,s,r=null){this._rerrs.push({path:e,expected:t,has:s,message:r})}toString(){const e=[];for(let t=this._rerrs.length-1;t>0;t--){const s=this._rerrs[t];e.push(uL(" ",2*(this._rerrs.length-t))+`${null!=s.path?`[${s.path}] `:""}${s.has} doesn't match ${s.expected}. ${s.message}`)}return e.join("\n")}}const VO=(e,t)=>e===t||null!=e&&null!=t&&e.constructor===t.constructor&&(e[cO]?lO(e,t):WM(e)?$M(e,e=>qM(t,t=>VO(e,t))):!!(e=>"object"==typeof e)(e)&&pO(e,(e,s)=>VO(e,t[s])));class FO{static _dilutes=!1;extends(e){let[t,s]=[this.shape,e.shape];return this.constructor._dilutes&&([s,t]=[t,s]),VO(t,s)}equals(e){return this.constructor===e.constructor&&wO(this.shape,e.shape)}[BO](){return!0}[cO](e){return this.equals(e)}validate(e){return this.check(e)}check(e,t){ML()}get nullable(){return gB(this,AB)}get optional(){return new YO(this)}cast(e){return MB(e,this),e}expect(e){return MB(e,this),e}}class zO extends FO{constructor(e,t){super(),this.shape=e,this._c=t}check(e,t=void 0){const s=e?.constructor===this.shape&&(null==this._c||this._c(e));return!s&&t?.extend(null,this.shape.name,e?.constructor.name,e?.constructor!==this.shape?"Constructor match failed":"Check failed"),s}}const $O=(e,t=null)=>new zO(e,t);$O(zO);class qO extends FO{constructor(e){super(),this.shape=e}check(e,t){const s=this.shape(e);return!s&&t?.extend(null,"custom prop",e?.constructor.name,"failed to check custom prop"),s}}const WO=e=>new qO(e);$O(qO);class KO extends FO{constructor(e){super(),this.shape=e}check(e,t){const s=this.shape.some(t=>t===e);return!s&&t?.extend(null,this.shape.join(" | "),e.toString()),s}}const jO=(...e)=>new KO(e),HO=$O(KO),GO=RegExp.escape||(e=>e.replace(/[().|&,$^[\]]/g,e=>"\\"+e)),QO=e=>TB.check(e)?[GO(e)]:HO.check(e)?e.shape.map(e=>e+""):_B.check(e)?["[+-]?\\d+.?\\d*"]:IB.check(e)?[".*"]:mB.check(e)?e.shape.map(QO).flat(1):void LL();$O(class extends FO{constructor(e){super(),this.shape=e,this._r=new RegExp("^"+e.map(QO).map(e=>`(${e.join("|")})`).join("")+"$")}check(e,t){const s=null!=this._r.exec(e);return!s&&t?.extend(null,this._r.toString(),e.toString(),"String doesn't match string template."),s}});const XO=Symbol("optional");class YO extends FO{constructor(e){super(),this.shape=e}check(e,t){const s=void 0===e||this.shape.check(e);return!s&&t?.extend(null,"undefined (optional)","()"),s}get[XO](){return!0}}const JO=$O(YO);$O(class extends FO{check(e,t){return t?.extend(null,"never",typeof e),!1}});class ZO extends FO{constructor(e,t=!1){super(),this.shape=e,this._isPartial=t}static _dilutes=!0;get partial(){return new ZO(this.shape,!0)}check(e,t){return null==e?(t?.extend(null,"object","null"),!1):pO(this.shape,(s,r)=>{const n=this._isPartial&&!fO(e,r)||s.check(e[r],t);return!n&&t?.extend(r.toString(),s.toString(),typeof e[r],"Object property does not match"),n})}}const eB=$O(ZO),tB=WO(e=>null!=e&&(e.constructor===Object||null==e.constructor));class sB extends FO{constructor(e,t){super(),this.shape={keys:e,values:t}}check(e,t){return null!=e&&pO(e,(s,r)=>{const n=this.shape.keys.check(r,t);return!n&&t?.extend(r+"","Record",typeof e,n?"Key doesn't match schema":"Value doesn't match value"),n&&this.shape.values.check(s,t)})}}const rB=(e,t)=>new sB(e,t),nB=$O(sB);class iB extends FO{constructor(e){super(),this.shape=e}check(e,t){return null!=e&&pO(this.shape,(s,r)=>{const n=s.check(e[r],t);return!n&&t?.extend(r.toString(),"Tuple",typeof s),n})}}$O(iB);class oB extends FO{constructor(e){super(),this.shape=1===e.length?e[0]:new fB(e)}check(e,t){const s=WM(e)&&$M(e,e=>this.shape.check(e));return!s&&t?.extend(null,"Array",""),s}}const aB=(...e)=>new oB(e),cB=$O(oB),lB=WO(e=>WM(e));class hB extends FO{constructor(e,t){super(),this.shape=e,this._c=t}check(e,t){const s=e instanceof this.shape&&(null==this._c||this._c(e));return!s&&t?.extend(null,this.shape.name,e?.constructor.name),s}}$O(hB);const uB=((e,t=null)=>new hB(e,t))(FO);const dB=$O(class extends FO{constructor(e){super(),this.len=e.length-1,this.args=((...e)=>new iB(e))(...e.slice(-1)),this.res=e[this.len]}check(e,t){const s=e.constructor===Function&&e.length<=this.len;return!s&&t?.extend(null,"function",typeof e),s}}),pB=WO(e=>"function"==typeof e);$O(class extends FO{constructor(e){super(),this.shape=e}check(e,t){const s=$M(this.shape,s=>s.check(e,t));return!s&&t?.extend(null,"Intersectinon",typeof e),s}},e=>e.shape.length>0);class fB extends FO{static _dilutes=!0;constructor(e){super(),this.shape=e}check(e,t){const s=qM(this.shape,s=>s.check(e,t));return t?.extend(null,"Union",typeof e),s}}const gB=(...e)=>e.findIndex(e=>mB.check(e))>=0?gB(...e.map(e=>RB(e)).map(e=>mB.check(e)?e.shape:[e]).flat(1)):1===e.length?e[0]:new fB(e),mB=$O(fB),yB=()=>!0,bB=WO(yB),wB=$O(qO,e=>e.shape===yB),vB=WO(e=>"bigint"==typeof e),SB=WO(e=>e===vB),EB=WO(e=>"symbol"==typeof e);WO(e=>e===EB);const DB=WO(e=>"number"==typeof e),_B=WO(e=>e===DB),TB=WO(e=>"string"==typeof e),IB=WO(e=>e===TB),CB=WO(e=>"boolean"==typeof e),PB=WO(e=>e===CB),xB=jO(void 0);$O(KO,e=>1===e.shape.length&&void 0===e.shape[0]),jO(void 0);const AB=jO(null),kB=$O(KO,e=>1===e.shape.length&&null===e.shape[0]);$O(Uint8Array),$O(zO,e=>e.shape===Uint8Array);const NB=gB(DB,TB,AB,xB,vB,CB,EB);(()=>{const e=aB(bB),t=rB(TB,bB),s=gB(DB,TB,AB,CB,e,t);e.shape=s,t.shape.values=s})();const RB=e=>{if(uB.check(e))return e;if(tB.check(e)){const t={};for(const s in e)t[s]=RB(e[s]);return new ZO(t)}return lB.check(e)?gB(...e.map(RB)):NB.check(e)?jO(e):pB.check(e)?$O(e):void LL()},MB=TO?()=>{}:(e,t)=>{const s=new UO;if(!t.check(e,s))throw RL(`Expected value to be of type ${t.constructor.name}.\n${s.toString()}`)};class LB{constructor(e){this.patterns=[],this.$state=e}if(e,t){return this.patterns.push({if:RB(e),h:t}),this}else(e){return this.if(bB,e)}done(){return(e,t)=>{for(let s=0;s<this.patterns.length;s++){const r=this.patterns[s];if(r.if.check(e))return r.h(e,t)}throw RL("Unhandled pattern")}}}const OB=(BB=bB,new LB(BB)).if(_B,(e,t)=>NO(t,sL,tL)).if(IB,(e,t)=>((e,t=0,s=20)=>{const r=MO(e,t,s);let n="";for(let t=0;t<r;t++)n+=LO(e);return n})(t)).if(PB,(e,t)=>kO(t)).if(SB,(e,t)=>BigInt(NO(t,sL,tL))).if(mB,(e,t)=>UB(t,OO(t,e.shape))).if(eB,(e,t)=>{const s={};for(const r in e.shape){let n=e.shape[r];if(JO.check(n)){if(kO(t))continue;n=n.shape}s[r]=OB(n,t)}return s}).if(cB,(e,t)=>{const s=[],r=RO(t,0,42);for(let n=0;n<r;n++)s.push(UB(t,e.shape));return s}).if(HO,(e,t)=>OO(t,e.shape)).if(kB,(e,t)=>null).if(dB,(e,t)=>{const s=UB(t,e.res);return()=>s}).if(wB,(e,t)=>UB(t,OO(t,[DB,TB,AB,xB,vB,CB,aB(DB),rB(gB("a","b","c"),DB)]))).if(nB,(e,t)=>{const s={},r=NO(t,0,3);for(let n=0;n<r;n++){const r=UB(t,e.shape.keys),n=UB(t,e.shape.values);s[r]=n}return s}).done();var BB;const UB=(e,t)=>OB(RB(t),e),VB="undefined"!=typeof document?document:{};WO(e=>e.nodeType===WB),"undefined"!=typeof DOMParser&&new DOMParser,WO(e=>e.nodeType===zB),WO(e=>e.nodeType===$B);const FB=e=>((e,t)=>{const s=[];for(const[r,n]of e)s.push(t(n,r));return s})(e,(e,t)=>`${t}:${e};`).join(""),zB=VB.ELEMENT_NODE,$B=VB.TEXT_NODE,qB=VB.DOCUMENT_NODE,WB=VB.DOCUMENT_FRAGMENT_NODE;WO(e=>e.nodeType===qB);const KB=Symbol,jB=KB(),HB=KB(),GB=KB(),QB=KB(),XB=KB(),YB=KB(),JB=KB(),ZB=KB(),eU=KB(),tU={[jB]:AO("font-weight","bold"),[HB]:AO("font-weight","normal"),[GB]:AO("color","blue"),[XB]:AO("color","green"),[QB]:AO("color","grey"),[YB]:AO("color","red"),[JB]:AO("color","purple"),[ZB]:AO("color","orange"),[eU]:AO("color","black")},sU=CO?e=>{1===e.length&&e[0]?.constructor===Function&&(e=e[0]());const t=[],s=[],r=LM();let n=[],i=0;for(;i<e.length;i++){const n=e[i],o=tU[n];if(void 0!==o)r.set(o.left,o.right);else{if(void 0===n)break;if(n.constructor!==String&&n.constructor!==Number)break;{const e=FB(r);i>0||e.length>0?(t.push("%c"+n),s.push(e)):t.push(n)}}}for(i>0&&(n=s,n.unshift(t.join("")));i<e.length;i++){const t=e[i];t instanceof Symbol||n.push(t)}return n}:e=>{1===e.length&&e[0]?.constructor===Function&&(e=e[0]());const t=[],s=[];let r=0;for(;r<e.length;r++){const s=e[r];if(void 0===s)break;if(s.constructor===String||s.constructor===Number)t.push(s);else if(s.constructor===Object)break}for(r>0&&s.push(t.join(""));r<e.length;r++){const t=e[r];t instanceof Symbol||s.push(t)}return s},rU=(...e)=>{console.warn(...sU(e)),e.unshift(ZB),nU.forEach(t=>t.print(e))},nU=UM(),iU=e=>({[Symbol.iterator](){return this},next:e}),oU=(e,t)=>iU(()=>{const{done:s,value:r}=e.next();return{done:s,value:s?void 0:t(r)}});class aU{constructor(e,t){this.clock=e,this.len=t}}class cU{constructor(){this.clients=new Map}}const lU=(e,t,s)=>t.clients.forEach((t,r)=>{const n=e.doc.store.clients.get(r);if(null!=n){const r=n[n.length-1],i=r.id.clock+r.length;for(let r=0,o=t[r];r<t.length&&o.clock<i;o=t[++r])nV(e,n,o.clock,o.len,s)}}),hU=(e,t)=>{const s=e.clients.get(t.client);return void 0!==s&&null!==((e,t)=>{let s=0,r=e.length-1;for(;s<=r;){const n=HM((s+r)/2),i=e[n],o=i.clock;if(o<=t){if(t<o+i.len)return n;s=n+1}else r=n-1}return null})(s,t.clock)},uU=e=>{e.clients.forEach(e=>{let t,s;for(e.sort((e,t)=>e.clock-t.clock),t=1,s=1;t<e.length;t++){const r=e[s-1],n=e[t];r.clock+r.len>=n.clock?r.len=XM(r.len,n.clock+n.len-r.clock):(s<t&&(e[s]=n),s++)}e.length=s})},dU=e=>{const t=new cU;for(let s=0;s<e.length;s++)e[s].clients.forEach((r,n)=>{if(!t.clients.has(n)){const i=r.slice();for(let t=s+1;t<e.length;t++)FM(i,e[t].clients.get(n)||[]);t.clients.set(n,i)}});return uU(t),t},pU=(e,t,s,r)=>{BM(e.clients,t,()=>[]).push(new aU(s,r))},fU=e=>{const t=new cU;return e.clients.forEach((e,s)=>{const r=[];for(let t=0;t<e.length;t++){const s=e[t];if(s.deleted){const n=s.id.clock;let i=s.length;if(t+1<e.length)for(let s=e[t+1];t+1<e.length&&s.deleted;s=e[1+ ++t])i+=s.length;r.push(new aU(n,i))}}r.length>0&&t.clients.set(s,r)}),t},gU=(e,t)=>{yL(e.restEncoder,t.clients.size),zM(t.clients.entries()).sort((e,t)=>t[0]-e[0]).forEach(([t,s])=>{e.resetDsCurVal(),yL(e.restEncoder,t);const r=s.length;yL(e.restEncoder,r);for(let t=0;t<r;t++){const r=s[t];e.writeDsClock(r.clock),e.writeDsLen(r.len)}})},mU=e=>{const t=new cU,s=$L(e.restDecoder);for(let r=0;r<s;r++){e.resetDsCurVal();const s=$L(e.restDecoder),r=$L(e.restDecoder);if(r>0){const n=BM(t.clients,s,()=>[]);for(let t=0;t<r;t++)n.push(new aU(e.readDsClock(),e.readDsLen()))}}return t},yU=(e,t,s)=>{const r=new cU,n=$L(e.restDecoder);for(let i=0;i<n;i++){e.resetDsCurVal();const n=$L(e.restDecoder),i=$L(e.restDecoder),o=s.clients.get(n)||[],a=YU(s,n);for(let s=0;s<i;s++){const s=e.readDsClock(),i=s+e.readDsLen();if(s<a){a<i&&pU(r,n,a,i-a);let e=ZU(o,s),c=o[e];for(!c.deleted&&c.id.clock<s&&(o.splice(e+1,0,HF(t,c,s-c.id.clock)),e++);e<o.length&&(c=o[e++],c.id.clock<i);)c.deleted||(i<c.id.clock+c.length&&o.splice(e,0,HF(t,c,i-c.id.clock)),c.delete(t))}else pU(r,n,s,i-s)}}if(r.clients.size>0){const e=new CU;return yL(e.restEncoder,0),gU(e,r),e.toUint8Array()}return null},bU=ZL;class wU extends KM{constructor({guid:e=tO(),collectionid:t=null,gc:s=!0,gcFilter:r=()=>!0,meta:n=null,autoLoad:i=!1,shouldLoad:o=!0}={}){super(),this.gc=s,this.gcFilter=r,this.clientID=bU(),this.guid=e,this.collectionid=t,this.share=new Map,this.store=new QU,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=o,this.autoLoad=i,this.meta=n,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=rO(e=>{this.on("load",()=>{this.isLoaded=!0,e(this)})});const a=()=>rO(e=>{const t=s=>{void 0!==s&&!0!==s||(this.off("sync",t),e())};this.on("sync",t)});this.on("sync",e=>{!1===e&&this.isSynced&&(this.whenSynced=a()),this.isSynced=void 0===e||!0===e,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=a()}load(){const e=this._item;null===e||this.shouldLoad||hV(e.parent.doc,e=>{e.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(zM(this.subdocs).map(e=>e.guid))}transact(e,t=null){return hV(this,e,t)}get(e,t=LV){const s=BM(this.share,e,()=>{const e=new t;return e._integrate(this,null),e}),r=s.constructor;if(t!==LV&&r!==t){if(r===LV){const r=new t;r._map=s._map,s._map.forEach(e=>{for(;null!==e;e=e.left)e.parent=r}),r._start=s._start;for(let e=r._start;null!==e;e=e.right)e.parent=r;return r._length=s._length,this.share.set(e,r),r._integrate(this,null),r}throw new Error(`Type with the name ${e} has already been defined with a different constructor`)}return s}getArray(e=""){return this.get(e,ZV)}getText(e=""){return this.get(e,yF)}getMap(e=""){return this.get(e,tF)}getXmlElement(e=""){return this.get(e,vF)}getXmlFragment(e=""){return this.get(e,wF)}toJSON(){const e={};return this.share.forEach((t,s)=>{e[s]=t.toJSON()}),e}destroy(){this.isDestroyed=!0,zM(this.subdocs).forEach(e=>e.destroy());const e=this._item;if(null!==e){this._item=null;const t=e.content;t.doc=new wU({guid:this.guid,...t.opts,shouldLoad:!1}),t.doc._item=e,hV(e.parent.doc,s=>{const r=t.doc;e.deleted||s.subdocsAdded.add(r),s.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}}class vU{constructor(e){this.restDecoder=e}resetDsCurVal(){}readDsClock(){return $L(this.restDecoder)}readDsLen(){return $L(this.restDecoder)}}class SU extends vU{readLeftID(){return KU($L(this.restDecoder),$L(this.restDecoder))}readRightID(){return KU($L(this.restDecoder),$L(this.restDecoder))}readClient(){return $L(this.restDecoder)}readInfo(){return zL(this.restDecoder)}readString(){return WL(this.restDecoder)}readParentInfo(){return 1===$L(this.restDecoder)}readTypeRef(){return $L(this.restDecoder)}readLen(){return $L(this.restDecoder)}readAny(){return HL(this.restDecoder)}readBuf(){return PO(FL(this.restDecoder))}readJSON(){return JSON.parse(WL(this.restDecoder))}readKey(){return WL(this.restDecoder)}}class EU{constructor(e){this.dsCurrVal=0,this.restDecoder=e}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=$L(this.restDecoder),this.dsCurrVal}readDsLen(){const e=$L(this.restDecoder)+1;return this.dsCurrVal+=e,e}}class DU extends EU{constructor(e){super(e),this.keys=[],$L(e),this.keyClockDecoder=new XL(FL(e)),this.clientDecoder=new QL(FL(e)),this.leftClockDecoder=new XL(FL(e)),this.rightClockDecoder=new XL(FL(e)),this.infoDecoder=new GL(FL(e),zL),this.stringDecoder=new YL(FL(e)),this.parentInfoDecoder=new GL(FL(e),zL),this.typeRefDecoder=new QL(FL(e)),this.lenDecoder=new QL(FL(e))}readLeftID(){return new qU(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new qU(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return 1===this.parentInfoDecoder.read()}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return HL(this.restDecoder)}readBuf(){return FL(this.restDecoder)}readJSON(){return HL(this.restDecoder)}readKey(){const e=this.keyClockDecoder.read();if(e<this.keys.length)return this.keys[e];{const e=this.stringDecoder.read();return this.keys.push(e),e}}}class _U{constructor(){this.restEncoder=pL()}toUint8Array(){return fL(this.restEncoder)}resetDsCurVal(){}writeDsClock(e){yL(this.restEncoder,e)}writeDsLen(e){yL(this.restEncoder,e)}}class TU extends _U{writeLeftID(e){yL(this.restEncoder,e.client),yL(this.restEncoder,e.clock)}writeRightID(e){yL(this.restEncoder,e.client),yL(this.restEncoder,e.clock)}writeClient(e){yL(this.restEncoder,e)}writeInfo(e){mL(this.restEncoder,e)}writeString(e){SL(this.restEncoder,e)}writeParentInfo(e){yL(this.restEncoder,e?1:0)}writeTypeRef(e){yL(this.restEncoder,e)}writeLen(e){yL(this.restEncoder,e)}writeAny(e){IL(this.restEncoder,e)}writeBuf(e){DL(this.restEncoder,e)}writeJSON(e){SL(this.restEncoder,JSON.stringify(e))}writeKey(e){SL(this.restEncoder,e)}}class IU{constructor(){this.restEncoder=pL(),this.dsCurrVal=0}toUint8Array(){return fL(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(e){const t=e-this.dsCurrVal;this.dsCurrVal=e,yL(this.restEncoder,t)}writeDsLen(e){0===e&&LL(),yL(this.restEncoder,e-1),this.dsCurrVal+=e}}class CU extends IU{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new kL,this.clientEncoder=new xL,this.leftClockEncoder=new kL,this.rightClockEncoder=new kL,this.infoEncoder=new CL(mL),this.stringEncoder=new NL,this.parentInfoEncoder=new CL(mL),this.typeRefEncoder=new xL,this.lenEncoder=new xL}toUint8Array(){const e=pL();return yL(e,0),DL(e,this.keyClockEncoder.toUint8Array()),DL(e,this.clientEncoder.toUint8Array()),DL(e,this.leftClockEncoder.toUint8Array()),DL(e,this.rightClockEncoder.toUint8Array()),DL(e,fL(this.infoEncoder)),DL(e,this.stringEncoder.toUint8Array()),DL(e,fL(this.parentInfoEncoder)),DL(e,this.typeRefEncoder.toUint8Array()),DL(e,this.lenEncoder.toUint8Array()),EL(e,fL(this.restEncoder)),fL(e)}writeLeftID(e){this.clientEncoder.write(e.client),this.leftClockEncoder.write(e.clock)}writeRightID(e){this.clientEncoder.write(e.client),this.rightClockEncoder.write(e.clock)}writeClient(e){this.clientEncoder.write(e)}writeInfo(e){this.infoEncoder.write(e)}writeString(e){this.stringEncoder.write(e)}writeParentInfo(e){this.parentInfoEncoder.write(e?1:0)}writeTypeRef(e){this.typeRefEncoder.write(e)}writeLen(e){this.lenEncoder.write(e)}writeAny(e){IL(this.restEncoder,e)}writeBuf(e){DL(this.restEncoder,e)}writeJSON(e){IL(this.restEncoder,e)}writeKey(e){const t=this.keyMap.get(e);void 0===t?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(e)):this.keyClockEncoder.write(t)}}const PU=(e,t,s)=>{const r=new Map;s.forEach((e,s)=>{YU(t,s)>e&&r.set(s,e)}),XU(t).forEach((e,t)=>{s.has(t)||r.set(t,0)}),yL(e.restEncoder,r.size),zM(r.entries()).sort((e,t)=>t[0]-e[0]).forEach(([s,r])=>{((e,t,s,r)=>{r=XM(r,t[0].id.clock);const n=ZU(t,r);yL(e.restEncoder,t.length-n),e.writeClient(s),yL(e.restEncoder,r);const i=t[n];i.write(e,r-i.id.clock);for(let s=n+1;s<t.length;s++)t[s].write(e,0)})(e,t.clients.get(s),s,r)})},xU=(e,t,s,r=new DU(e))=>hV(t,e=>{e.local=!1;let t=!1;const s=e.doc,n=s.store,i=((e,t)=>{const s=LM(),r=$L(e.restDecoder);for(let n=0;n<r;n++){const r=$L(e.restDecoder),n=new Array(r),i=e.readClient();let o=$L(e.restDecoder);s.set(i,{i:0,refs:n});for(let s=0;s<r;s++){const r=e.readInfo();switch(31&r){case 0:{const t=e.readLen();n[s]=new TF(KU(i,o),t),o+=t;break}case 10:{const t=$L(e.restDecoder);n[s]=new ZF(KU(i,o),t),o+=t;break}default:{const a=!(192&r),c=new XF(KU(i,o),null,(r&ZM)===ZM?e.readLeftID():null,null,(r&JM)===JM?e.readRightID():null,a?e.readParentInfo()?t.get(e.readString()):e.readLeftID():null,!a||32&~r?null:e.readString(),YF(e,r));n[s]=c,o+=c.length}}}}return s})(r,s),o=((e,t,s)=>{const r=[];let n=zM(s.keys()).sort((e,t)=>e-t);if(0===n.length)return null;const i=()=>{if(0===n.length)return null;let e=s.get(n[n.length-1]);for(;e.refs.length===e.i;){if(n.pop(),!(n.length>0))return null;e=s.get(n[n.length-1])}return e};let o=i();if(null===o)return null;const a=new QU,c=new Map,l=(e,t)=>{const s=c.get(e);(null==s||s>t)&&c.set(e,t)};let h=o.refs[o.i++];const u=new Map,d=()=>{for(const e of r){const t=e.id.client,r=s.get(t);r?(r.i--,a.clients.set(t,r.refs.slice(r.i)),s.delete(t),r.i=0,r.refs=[]):a.clients.set(t,[e]),n=n.filter(e=>e!==t)}r.length=0};for(;;){if(h.constructor!==ZF){const n=BM(u,h.id.client,()=>YU(t,h.id.client))-h.id.clock;if(n<0)r.push(h),l(h.id.client,h.id.clock-1),d();else{const i=h.getMissing(e,t);if(null!==i){r.push(h);const e=s.get(i)||{refs:[],i:0};if(e.refs.length!==e.i){h=e.refs[e.i++];continue}l(i,YU(t,i)),d()}else(0===n||n<h.length)&&(h.integrate(e,n),u.set(h.id.client,h.id.clock+h.length))}}if(r.length>0)h=r.pop();else if(null!==o&&o.i<o.refs.length)h=o.refs[o.i++];else{if(o=i(),null===o)break;h=o.refs[o.i++]}}if(a.clients.size>0){const e=new CU;return PU(e,a,new Map),yL(e.restEncoder,0),{missing:c,update:e.toUint8Array()}}return null})(e,n,i),a=n.pendingStructs;if(a){for(const[e,s]of a.missing)if(s<YU(n,e)){t=!0;break}if(o){for(const[e,t]of o.missing){const s=a.missing.get(e);(null==s||s>t)&&a.missing.set(e,t)}a.update=wV([a.update,o.update])}}else n.pendingStructs=o;const c=yU(r,e,n);if(n.pendingDs){const t=new DU(VL(n.pendingDs));$L(t.restDecoder);const s=yU(t,e,n);n.pendingDs=c&&s?wV([c,s]):c||s}else n.pendingDs=c;if(t){const t=n.pendingStructs.update;n.pendingStructs=null,AU(e.doc,t)}},s,!1),AU=(e,t,s,r=DU)=>{const n=VL(t);xU(n,e,s,new r(n))},kU=(e,t,s)=>AU(e,t,s,SU),NU=(e,t=new Uint8Array([0]),s=new CU)=>{((e,t,s=new Map)=>{PU(e,t.store,s),gU(e,fU(t.store))})(s,e,MU(t));const r=[s.toUint8Array()];if(e.store.pendingDs&&r.push(e.store.pendingDs),e.store.pendingStructs&&r.push(vV(e.store.pendingStructs.update,t)),r.length>1){if(s.constructor===TU)return yV(r.map((e,t)=>0===t?e:_V(e)));if(s.constructor===CU)return wV(r)}return r[0]},RU=(e,t)=>NU(e,t,new TU),MU=e=>(e=>{const t=new Map,s=$L(e.restDecoder);for(let r=0;r<s;r++){const s=$L(e.restDecoder),r=$L(e.restDecoder);t.set(s,r)}return t})(new vU(VL(e))),LU=(e,t)=>(yL(e.restEncoder,t.size),zM(t.entries()).sort((e,t)=>t[0]-e[0]).forEach(([t,s])=>{yL(e.restEncoder,t),yL(e.restEncoder,s)}),e),OU=(e,t=new IU)=>(e instanceof Map?LU(t,e):((e,t)=>{LU(e,XU(t.store))})(t,e),t.toUint8Array()),BU=e=>OU(e,new _U);class UU{constructor(){this.l=[]}}const VU=()=>new UU,FU=(e,t)=>e.l.push(t),zU=(e,t)=>{const s=e.l,r=s.length;e.l=s.filter(e=>t!==e),r===e.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},$U=(e,t,s)=>yO(e.l,[t,s]);class qU{constructor(e,t){this.client=e,this.clock=t}}const WU=(e,t)=>e===t||null!==e&&null!==t&&e.client===t.client&&e.clock===t.clock,KU=(e,t)=>new qU(e,t),jU=(e,t)=>{for(;null!==t;){if(t.parent===e)return!0;t=t.parent._item}return!1},HU=(e,t)=>void 0===t?!e.deleted:t.sv.has(e.id.client)&&(t.sv.get(e.id.client)||0)>e.id.clock&&!hU(t.ds,e.id),GU=(e,t)=>{const s=BM(e.meta,GU,UM),r=e.doc.store;s.has(t)||(t.sv.forEach((t,s)=>{t<YU(r,s)&&sV(e,KU(s,t))}),lU(e,t.ds,e=>{}),s.add(t))};class QU{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const XU=e=>{const t=new Map;return e.clients.forEach((e,s)=>{const r=e[e.length-1];t.set(s,r.id.clock+r.length)}),t},YU=(e,t)=>{const s=e.clients.get(t);if(void 0===s)return 0;const r=s[s.length-1];return r.id.clock+r.length},JU=(e,t)=>{let s=e.clients.get(t.id.client);if(void 0===s)s=[],e.clients.set(t.id.client,s);else{const e=s[s.length-1];if(e.id.clock+e.length!==t.id.clock)throw LL()}s.push(t)},ZU=(e,t)=>{let s=0,r=e.length-1,n=e[r],i=n.id.clock;if(i===t)return r;let o=HM(t/(i+n.length-1)*r);for(;s<=r;){if(n=e[o],i=n.id.clock,i<=t){if(t<i+n.length)return o;s=o+1}else r=o-1;o=HM((s+r)/2)}throw LL()},eV=(e,t)=>{const s=e.clients.get(t.client);return s[ZU(s,t.clock)]},tV=(e,t,s)=>{const r=ZU(t,s),n=t[r];return n.id.clock<s&&n instanceof XF?(t.splice(r+1,0,HF(e,n,s-n.id.clock)),r+1):r},sV=(e,t)=>{const s=e.doc.store.clients.get(t.client);return s[tV(e,s,t.clock)]},rV=(e,t,s)=>{const r=t.clients.get(s.client),n=ZU(r,s.clock),i=r[n];return s.clock!==i.id.clock+i.length-1&&i.constructor!==TF&&r.splice(n+1,0,HF(e,i,s.clock-i.id.clock+1)),i},nV=(e,t,s,r,n)=>{if(0===r)return;const i=s+r;let o,a=tV(e,t,s);do{o=t[a++],i<o.id.clock+o.length&&tV(e,t,i),n(o)}while(a<t.length&&t[a].id.clock<i)};class iV{constructor(e,t,s){this.doc=e,this.deleteSet=new cU,this.beforeState=XU(e.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=t,this.meta=new Map,this.local=s,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}}const oV=(e,t)=>!(0===t.deleteSet.clients.size&&!((e,t)=>{for(const[s,r]of e)if(t(r,s))return!0;return!1})(t.afterState,(e,s)=>t.beforeState.get(s)!==e))&&(uU(t.deleteSet),((e,t)=>{PU(e,t.doc.store,t.beforeState)})(e,t),gU(e,t.deleteSet),!0),aV=(e,t,s)=>{const r=t._item;(null===r||r.id.clock<(e.beforeState.get(r.id.client)||0)&&!r.deleted)&&BM(e.changed,t,UM).add(s)},cV=(e,t)=>{let s=e[t],r=e[t-1],n=t;for(;n>0&&(r.deleted===s.deleted&&r.constructor===s.constructor&&r.mergeWith(s));s=r,r=e[--n-1])s instanceof XF&&null!==s.parentSub&&s.parent._map.get(s.parentSub)===s&&s.parent._map.set(s.parentSub,r);const i=t-n;return i&&e.splice(t+1-i,i),i},lV=(e,t)=>{if(t<e.length){const s=e[t],r=s.doc,n=r.store,i=s.deleteSet,o=s._mergeStructs;try{uU(i),s.afterState=XU(s.doc.store),r.emit("beforeObserverCalls",[s,r]);const e=[];s.changed.forEach((t,r)=>e.push(()=>{null!==r._item&&r._item.deleted||r._callObserver(s,t)})),e.push(()=>{s.changedParentTypes.forEach((e,t)=>{t._dEH.l.length>0&&(null===t._item||!t._item.deleted)&&(e=e.filter(e=>null===e.target._item||!e.target._item.deleted),e.forEach(e=>{e.currentTarget=t,e._path=null}),e.sort((e,t)=>e.path.length-t.path.length),$U(t._dEH,e,s))})}),e.push(()=>r.emit("afterTransaction",[s,r])),yO(e,[]),s._needFormattingCleanup&&fF(s)}finally{r.gc&&((e,t,s)=>{for(const[r,n]of e.clients.entries()){const e=t.clients.get(r);for(let r=n.length-1;r>=0;r--){const i=n[r],o=i.clock+i.len;for(let r=ZU(e,i.clock),n=e[r];r<e.length&&n.id.clock<o;n=e[++r]){const n=e[r];if(i.clock+i.len<=n.id.clock)break;n instanceof XF&&n.deleted&&!n.keep&&s(n)&&n.gc(t,!1)}}}})(i,n,r.gcFilter),((e,t)=>{e.clients.forEach((e,s)=>{const r=t.clients.get(s);for(let t=e.length-1;t>=0;t--){const s=e[t];for(let e=QM(r.length-1,1+ZU(r,s.clock+s.len-1)),t=r[e];e>0&&t.id.clock>=s.clock;t=r[e])e-=1+cV(r,e)}})})(i,n),s.afterState.forEach((e,t)=>{const r=s.beforeState.get(t)||0;if(r!==e){const e=n.clients.get(t),s=XM(ZU(e,r),1);for(let t=e.length-1;t>=s;)t-=1+cV(e,t)}});for(let e=o.length-1;e>=0;e--){const{client:t,clock:s}=o[e].id,r=n.clients.get(t),i=ZU(r,s);i+1<r.length&&cV(r,i+1)>1||i>0&&cV(r,i)}if(s.local||s.afterState.get(r.clientID)===s.beforeState.get(r.clientID)||(((...e)=>{console.log(...sU(e)),nU.forEach(t=>t.print(e))})(ZB,jB,"[yjs] ",HB,YB,"Changed the client-id because another client seems to be using it."),r.clientID=bU()),r.emit("afterTransactionCleanup",[s,r]),r._observers.has("update")){const e=new TU;oV(e,s)&&r.emit("update",[e.toUint8Array(),s.origin,r,s])}if(r._observers.has("updateV2")){const e=new CU;oV(e,s)&&r.emit("updateV2",[e.toUint8Array(),s.origin,r,s])}const{subdocsAdded:a,subdocsLoaded:c,subdocsRemoved:l}=s;(a.size>0||l.size>0||c.size>0)&&(a.forEach(e=>{e.clientID=r.clientID,null==e.collectionid&&(e.collectionid=r.collectionid),r.subdocs.add(e)}),l.forEach(e=>r.subdocs.delete(e)),r.emit("subdocs",[{loaded:c,added:a,removed:l},r,s]),l.forEach(e=>e.destroy())),e.length<=t+1?(r._transactionCleanups=[],r.emit("afterAllTransactions",[r,e])):lV(e,t+1)}}},hV=(e,t,s=null,r=!0)=>{const n=e._transactionCleanups;let i=!1,o=null;null===e._transaction&&(i=!0,e._transaction=new iV(e,s,r),n.push(e._transaction),1===n.length&&e.emit("beforeAllTransactions",[e]),e.emit("beforeTransaction",[e._transaction,e]));try{o=t(e._transaction)}finally{if(i){const t=e._transaction===n[0];e._transaction=null,t&&lV(n,0)}}return o};class uV{constructor(e,t){this.insertions=t,this.deletions=e,this.meta=new Map}}const dV=(e,t,s)=>{lU(e,s.deletions,s=>{s instanceof XF&&t.scope.some(t=>t===e.doc||jU(t,s))&&jF(s,!1)})},pV=(e,t,s)=>{let r=null;const n=e.doc,i=e.scope;hV(n,s=>{for(;t.length>0&&null===e.currStackItem;){const r=n.store,o=t.pop(),a=new Set,c=[];let l=!1;lU(s,o.insertions,e=>{if(e instanceof XF){if(null!==e.redone){let{item:t,diff:n}=KF(r,e.id);n>0&&(t=sV(s,KU(t.id.client,t.id.clock+n))),e=t}!e.deleted&&i.some(t=>t===s.doc||jU(t,e))&&c.push(e)}}),lU(s,o.deletions,e=>{e instanceof XF&&i.some(t=>t===s.doc||jU(t,e))&&!hU(o.insertions,e.id)&&a.add(e)}),a.forEach(t=>{l=null!==QF(s,t,a,o.insertions,e.ignoreRemoteMapChanges,e)||l});for(let t=c.length-1;t>=0;t--){const r=c[t];e.deleteFilter(r)&&(r.delete(s),l=!0)}e.currStackItem=l?o:null}s.changed.forEach((e,t)=>{e.has(null)&&t._searchMarker&&(t._searchMarker.length=0)}),r=s},e);const o=e.currStackItem;if(null!=o){const t=r.changedParentTypes;e.emit("stack-item-popped",[{stackItem:o,type:s,changedParentTypes:t,origin:e},e]),e.currStackItem=null}return o};class fV extends KM{constructor(e,{captureTimeout:t=500,captureTransaction:s=e=>!0,deleteFilter:r=()=>!0,trackedOrigins:n=new Set([null]),ignoreRemoteMapChanges:i=!1,doc:o=(WM(e)?e[0].doc:e instanceof wU?e:e.doc)}={}){super(),this.scope=[],this.doc=o,this.addToScope(e),this.deleteFilter=r,n.add(this),this.trackedOrigins=n,this.captureTransaction=s,this.undoStack=[],this.redoStack=[],this.undoing=!1,this.redoing=!1,this.currStackItem=null,this.lastChange=0,this.ignoreRemoteMapChanges=i,this.captureTimeout=t,this.afterTransactionHandler=e=>{if(!(this.captureTransaction(e)&&this.scope.some(t=>e.changedParentTypes.has(t)||t===this.doc)&&(this.trackedOrigins.has(e.origin)||e.origin&&this.trackedOrigins.has(e.origin.constructor))))return;const t=this.undoing,s=this.redoing,r=t?this.redoStack:this.undoStack;t?this.stopCapturing():s||this.clear(!1,!0);const n=new cU;e.afterState.forEach((t,s)=>{const r=e.beforeState.get(s)||0,i=t-r;i>0&&pU(n,s,r,i)});const i=sO();let o=!1;if(this.lastChange>0&&i-this.lastChange<this.captureTimeout&&r.length>0&&!t&&!s){const t=r[r.length-1];t.deletions=dU([t.deletions,e.deleteSet]),t.insertions=dU([t.insertions,n])}else r.push(new uV(e.deleteSet,n)),o=!0;t||s||(this.lastChange=i),lU(e,e.deleteSet,t=>{t instanceof XF&&this.scope.some(s=>s===e.doc||jU(s,t))&&jF(t,!0)});const a=[{stackItem:r[r.length-1],origin:e.origin,type:t?"redo":"undo",changedParentTypes:e.changedParentTypes},this];o?this.emit("stack-item-added",a):this.emit("stack-item-updated",a)},this.doc.on("afterTransaction",this.afterTransactionHandler),this.doc.on("destroy",()=>{this.destroy()})}addToScope(e){const t=new Set(this.scope);(e=WM(e)?e:[e]).forEach(e=>{t.has(e)||(t.add(e),(e instanceof LV?e.doc!==this.doc:e!==this.doc)&&rU("[yjs#509] Not same Y.Doc"),this.scope.push(e))})}addTrackedOrigin(e){this.trackedOrigins.add(e)}removeTrackedOrigin(e){this.trackedOrigins.delete(e)}clear(e=!0,t=!0){(e&&this.canUndo()||t&&this.canRedo())&&this.doc.transact(s=>{e&&(this.undoStack.forEach(e=>dV(s,this,e)),this.undoStack=[]),t&&(this.redoStack.forEach(e=>dV(s,this,e)),this.redoStack=[]),this.emit("stack-cleared",[{undoStackCleared:e,redoStackCleared:t}])})}stopCapturing(){this.lastChange=0}undo(){let e;this.undoing=!0;try{e=pV(this,this.undoStack,"undo")}finally{this.undoing=!1}return e}redo(){let e;this.redoing=!0;try{e=pV(this,this.redoStack,"redo")}finally{this.redoing=!1}return e}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}destroy(){this.trackedOrigins.delete(this),this.doc.off("afterTransaction",this.afterTransactionHandler),super.destroy()}}class gV{constructor(e,t){this.gen=function*(e){const t=$L(e.restDecoder);for(let s=0;s<t;s++){const t=$L(e.restDecoder),s=e.readClient();let r=$L(e.restDecoder);for(let n=0;n<t;n++){const t=e.readInfo();if(10===t){const t=$L(e.restDecoder);yield new ZF(KU(s,r),t),r+=t}else if(31&t){const n=!(192&t),i=new XF(KU(s,r),null,(t&ZM)===ZM?e.readLeftID():null,null,(t&JM)===JM?e.readRightID():null,n?e.readParentInfo()?e.readString():e.readLeftID():null,!n||32&~t?null:e.readString(),YF(e,t));yield i,r+=i.length}else{const t=e.readLen();yield new TF(KU(s,r),t),r+=t}}}}(e),this.curr=null,this.done=!1,this.filterSkips=t,this.next()}next(){do{this.curr=this.gen.next().value||null}while(this.filterSkips&&null!==this.curr&&this.curr.constructor===ZF);return this.curr}}class mV{constructor(e){this.currClient=0,this.startClock=0,this.written=0,this.encoder=e,this.clientStructs=[]}}const yV=e=>wV(e,SU,TU),bV=(e,t)=>{if(e.constructor===TF){const{client:s,clock:r}=e.id;return new TF(KU(s,r+t),e.length-t)}if(e.constructor===ZF){const{client:s,clock:r}=e.id;return new ZF(KU(s,r+t),e.length-t)}{const s=e,{client:r,clock:n}=s.id;return new XF(KU(r,n+t),null,KU(r,n+t-1),null,s.rightOrigin,s.parent,s.parentSub,s.content.splice(t))}},wV=(e,t=DU,s=CU)=>{if(1===e.length)return e[0];const r=e.map(e=>new t(VL(e)));let n=r.map(e=>new gV(e,!0)),i=null;const o=new s,a=new mV(o);for(;n=n.filter(e=>null!==e.curr),n.sort((e,t)=>{if(e.curr.id.client===t.curr.id.client){const s=e.curr.id.clock-t.curr.id.clock;return 0===s?e.curr.constructor===t.curr.constructor?0:e.curr.constructor===ZF?1:-1:s}return t.curr.id.client-e.curr.id.client}),0!==n.length;){const e=n[0],t=e.curr.id.client;if(null!==i){let s=e.curr,r=!1;for(;null!==s&&s.id.clock+s.length<=i.struct.id.clock+i.struct.length&&s.id.client>=i.struct.id.client;)s=e.next(),r=!0;if(null===s||s.id.client!==t||r&&s.id.clock>i.struct.id.clock+i.struct.length)continue;if(t!==i.struct.id.client)EV(a,i.struct,i.offset),i={struct:s,offset:0},e.next();else if(i.struct.id.clock+i.struct.length<s.id.clock)if(i.struct.constructor===ZF)i.struct.length=s.id.clock+s.length-i.struct.id.clock;else{EV(a,i.struct,i.offset);const e=s.id.clock-i.struct.id.clock-i.struct.length;i={struct:new ZF(KU(t,i.struct.id.clock+i.struct.length),e),offset:0}}else{const t=i.struct.id.clock+i.struct.length-s.id.clock;t>0&&(i.struct.constructor===ZF?i.struct.length-=t:s=bV(s,t)),i.struct.mergeWith(s)||(EV(a,i.struct,i.offset),i={struct:s,offset:0},e.next())}}else i={struct:e.curr,offset:0},e.next();for(let s=e.curr;null!==s&&s.id.client===t&&s.id.clock===i.struct.id.clock+i.struct.length&&s.constructor!==ZF;s=e.next())EV(a,i.struct,i.offset),i={struct:s,offset:0}}null!==i&&(EV(a,i.struct,i.offset),i=null),DV(a);const c=r.map(e=>mU(e)),l=dU(c);return gU(o,l),o.toUint8Array()},vV=(e,t,s=DU,r=CU)=>{const n=MU(t),i=new r,o=new mV(i),a=new s(VL(e)),c=new gV(a,!1);for(;c.curr;){const e=c.curr,t=e.id.client,s=n.get(t)||0;if(c.curr.constructor!==ZF)if(e.id.clock+e.length>s)for(EV(o,e,XM(s-e.id.clock,0)),c.next();c.curr&&c.curr.id.client===t;)EV(o,c.curr,0),c.next();else for(;c.curr&&c.curr.id.client===t&&c.curr.id.clock+c.curr.length<=s;)c.next();else c.next()}DV(o);const l=mU(a);return gU(i,l),i.toUint8Array()},SV=e=>{e.written>0&&(e.clientStructs.push({written:e.written,restEncoder:fL(e.encoder.restEncoder)}),e.encoder.restEncoder=pL(),e.written=0)},EV=(e,t,s)=>{e.written>0&&e.currClient!==t.id.client&&SV(e),0===e.written&&(e.currClient=t.id.client,e.encoder.writeClient(t.id.client),yL(e.encoder.restEncoder,t.id.clock+s)),t.write(e.encoder,s),e.written++},DV=e=>{SV(e);const t=e.encoder.restEncoder;yL(t,e.clientStructs.length);for(let s=0;s<e.clientStructs.length;s++){const r=e.clientStructs[s];yL(t,r.written),EL(t,r.restEncoder)}},_V=e=>((e,t,s,r)=>{const n=new s(VL(e)),i=new gV(n,!1),o=new r,a=new mV(o);for(let e=i.curr;null!==e;e=i.next())EV(a,t(e),0);DV(a);const c=mU(n);return gU(o,c),o.toUint8Array()})(e,bO,DU,TU),TV="You must not compute changes after the event-handler fired.";class IV{constructor(e,t){this.target=e,this.currentTarget=e,this.transaction=t,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=CV(this.currentTarget,this.target))}deletes(e){return hU(this.transaction.deleteSet,e.id)}get keys(){if(null===this._keys){if(0===this.transaction.doc._transactionCleanups.length)throw RL(TV);const e=new Map,t=this.target;this.transaction.changed.get(t).forEach(s=>{if(null!==s){const r=t._map.get(s);let n,i;if(this.adds(r)){let e=r.left;for(;null!==e&&this.adds(e);)e=e.left;if(this.deletes(r)){if(null===e||!this.deletes(e))return;n="delete",i=VM(e.content.getContent())}else null!==e&&this.deletes(e)?(n="update",i=VM(e.content.getContent())):(n="add",i=void 0)}else{if(!this.deletes(r))return;n="delete",i=VM(r.content.getContent())}e.set(s,{action:n,oldValue:i})}}),this._keys=e}return this._keys}get delta(){return this.changes.delta}adds(e){return e.id.clock>=(this.transaction.beforeState.get(e.id.client)||0)}get changes(){let e=this._changes;if(null===e){if(0===this.transaction.doc._transactionCleanups.length)throw RL(TV);const t=this.target,s=UM(),r=UM(),n=[];e={added:s,deleted:r,delta:n,keys:this.keys};if(this.transaction.changed.get(t).has(null)){let e=null;const i=()=>{e&&n.push(e)};for(let n=t._start;null!==n;n=n.right)n.deleted?this.deletes(n)&&!this.adds(n)&&(null!==e&&void 0!==e.delete||(i(),e={delete:0}),e.delete+=n.length,r.add(n)):this.adds(n)?(null!==e&&void 0!==e.insert||(i(),e={insert:[]}),e.insert=e.insert.concat(n.content.getContent()),s.add(n)):(null!==e&&void 0!==e.retain||(i(),e={retain:0}),e.retain+=n.length);null!==e&&void 0===e.retain&&i()}this._changes=e}return e}}const CV=(e,t)=>{const s=[];for(;null!==t._item&&t!==e;){if(null!==t._item.parentSub)s.unshift(t._item.parentSub);else{let e=0,r=t._item.parent._start;for(;r!==t._item&&null!==r;)!r.deleted&&r.countable&&(e+=r.length),r=r.right;s.unshift(e)}t=t._item.parent}return s},PV=()=>{rU("Invalid access: Add Yjs type to a document before reading data.")};let xV=0;class AV{constructor(e,t){e.marker=!0,this.p=e,this.index=t,this.timestamp=xV++}}const kV=(e,t,s)=>{e.p.marker=!1,e.p=t,t.marker=!0,e.index=s,e.timestamp=xV++},NV=(e,t)=>{if(null===e._start||0===t||null===e._searchMarker)return null;const s=0===e._searchMarker.length?null:e._searchMarker.reduce((e,s)=>GM(t-e.index)<GM(t-s.index)?e:s);let r=e._start,n=0;for(null!==s&&(r=s.p,n=s.index,(e=>{e.timestamp=xV++})(s));null!==r.right&&n<t;){if(!r.deleted&&r.countable){if(t<n+r.length)break;n+=r.length}r=r.right}for(;null!==r.left&&n>t;)r=r.left,!r.deleted&&r.countable&&(n-=r.length);for(;null!==r.left&&r.left.id.client===r.id.client&&r.left.id.clock+r.left.length===r.id.clock;)r=r.left,!r.deleted&&r.countable&&(n-=r.length);return null!==s&&GM(s.index-n)<r.parent.length/80?(kV(s,r,n),s):((e,t,s)=>{if(e.length>=80){const r=e.reduce((e,t)=>e.timestamp<t.timestamp?e:t);return kV(r,t,s),r}{const r=new AV(t,s);return e.push(r),r}})(e._searchMarker,r,n)},RV=(e,t,s)=>{for(let r=e.length-1;r>=0;r--){const n=e[r];if(s>0){let t=n.p;for(t.marker=!1;t&&(t.deleted||!t.countable);)t=t.left,t&&!t.deleted&&t.countable&&(n.index-=t.length);if(null===t||!0===t.marker){e.splice(r,1);continue}n.p=t,t.marker=!0}(t<n.index||s>0&&t===n.index)&&(n.index=XM(t,n.index+s))}},MV=(e,t,s)=>{const r=e,n=t.changedParentTypes;for(;BM(n,e,()=>[]).push(s),null!==e._item;)e=e._item.parent;$U(r._eH,s,t)};class LV{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=VU(),this._dEH=VU(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(e,t){this.doc=e,this._item=t}_copy(){throw ML()}clone(){throw ML()}_write(e){}get _first(){let e=this._start;for(;null!==e&&e.deleted;)e=e.right;return e}_callObserver(e,t){!e.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(e){FU(this._eH,e)}observeDeep(e){FU(this._dEH,e)}unobserve(e){zU(this._eH,e)}unobserveDeep(e){zU(this._dEH,e)}toJSON(){}}const OV=(e,t,s)=>{e.doc??PV(),t<0&&(t=e._length+t),s<0&&(s=e._length+s);let r=s-t;const n=[];let i=e._start;for(;null!==i&&r>0;){if(i.countable&&!i.deleted){const e=i.content.getContent();if(e.length<=t)t-=e.length;else{for(let s=t;s<e.length&&r>0;s++)n.push(e[s]),r--;t=0}}i=i.right}return n},BV=e=>{e.doc??PV();const t=[];let s=e._start;for(;null!==s;){if(s.countable&&!s.deleted){const e=s.content.getContent();for(let s=0;s<e.length;s++)t.push(e[s])}s=s.right}return t},UV=(e,t)=>{let s=0,r=e._start;for(e.doc??PV();null!==r;){if(r.countable&&!r.deleted){const n=r.content.getContent();for(let r=0;r<n.length;r++)t(n[r],s++,e)}r=r.right}},VV=(e,t)=>{const s=[];return UV(e,(r,n)=>{s.push(t(r,n,e))}),s},FV=e=>{let t=e._start,s=null,r=0;return{[Symbol.iterator](){return this},next:()=>{if(null===s){for(;null!==t&&t.deleted;)t=t.right;if(null===t)return{done:!0,value:void 0};s=t.content.getContent(),r=0,t=t.right}const e=s[r++];return s.length<=r&&(s=null),{done:!1,value:e}}}},zV=(e,t)=>{e.doc??PV();const s=NV(e,t);let r=e._start;for(null!==s&&(r=s.p,t-=s.index);null!==r;r=r.right)if(!r.deleted&&r.countable){if(t<r.length)return r.content.getContent()[t];t-=r.length}},$V=(e,t,s,r)=>{let n=s;const i=e.doc,o=i.clientID,a=i.store,c=null===s?t._start:s.right;let l=[];const h=()=>{l.length>0&&(n=new XF(KU(o,YU(a,o)),n,n&&n.lastId,c,c&&c.id,t,null,new MF(l)),n.integrate(e,0),l=[])};r.forEach(s=>{if(null===s)l.push(s);else switch(s.constructor){case Number:case Object:case Boolean:case Array:case String:l.push(s);break;default:switch(h(),s.constructor){case Uint8Array:case ArrayBuffer:n=new XF(KU(o,YU(a,o)),n,n&&n.lastId,c,c&&c.id,t,null,new IF(new Uint8Array(s))),n.integrate(e,0);break;case wU:n=new XF(KU(o,YU(a,o)),n,n&&n.lastId,c,c&&c.id,t,null,new xF(s)),n.integrate(e,0);break;default:if(!(s instanceof LV))throw new Error("Unexpected content type in insert operation");n=new XF(KU(o,YU(a,o)),n,n&&n.lastId,c,c&&c.id,t,null,new WF(s)),n.integrate(e,0)}}}),h()},qV=()=>RL("Length exceeded!"),WV=(e,t,s,r)=>{if(s>t._length)throw qV();if(0===s)return t._searchMarker&&RV(t._searchMarker,s,r.length),$V(e,t,null,r);const n=s,i=NV(t,s);let o=t._start;for(null!==i&&(o=i.p,0===(s-=i.index)&&(o=o.prev,s+=o&&o.countable&&!o.deleted?o.length:0));null!==o;o=o.right)if(!o.deleted&&o.countable){if(s<=o.length){s<o.length&&sV(e,KU(o.id.client,o.id.clock+s));break}s-=o.length}return t._searchMarker&&RV(t._searchMarker,n,r.length),$V(e,t,o,r)},KV=(e,t,s,r)=>{if(0===r)return;const n=s,i=r,o=NV(t,s);let a=t._start;for(null!==o&&(a=o.p,s-=o.index);null!==a&&s>0;a=a.right)!a.deleted&&a.countable&&(s<a.length&&sV(e,KU(a.id.client,a.id.clock+s)),s-=a.length);for(;r>0&&null!==a;)a.deleted||(r<a.length&&sV(e,KU(a.id.client,a.id.clock+r)),a.delete(e),r-=a.length),a=a.right;if(r>0)throw qV();t._searchMarker&&RV(t._searchMarker,n,-i+r)},jV=(e,t,s)=>{const r=t._map.get(s);void 0!==r&&r.delete(e)},HV=(e,t,s,r)=>{const n=t._map.get(s)||null,i=e.doc,o=i.clientID;let a;if(null==r)a=new MF([r]);else switch(r.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:a=new MF([r]);break;case Uint8Array:a=new IF(r);break;case wU:a=new xF(r);break;default:if(!(r instanceof LV))throw new Error("Unexpected content type");a=new WF(r)}new XF(KU(o,YU(i.store,o)),n,n&&n.lastId,null,null,t,s,a).integrate(e,0)},GV=(e,t)=>{e.doc??PV();const s=e._map.get(t);return void 0===s||s.deleted?void 0:s.content.getContent()[s.length-1]},QV=e=>{const t={};return e.doc??PV(),e._map.forEach((e,s)=>{e.deleted||(t[s]=e.content.getContent()[e.length-1])}),t},XV=(e,t)=>{e.doc??PV();const s=e._map.get(t);return void 0!==s&&!s.deleted},YV=e=>(e.doc??PV(),((e,t)=>iU(()=>{let s;do{s=e.next()}while(!s.done&&!t(s.value));return s}))(e._map.entries(),e=>!e[1].deleted));class JV extends IV{}class ZV extends LV{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(e){const t=new ZV;return t.push(e),t}_integrate(e,t){super._integrate(e,t),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new ZV}clone(){const e=new ZV;return e.insert(0,this.toArray().map(e=>e instanceof LV?e.clone():e)),e}get length(){return this.doc??PV(),this._length}_callObserver(e,t){super._callObserver(e,t),MV(this,e,new JV(this,e))}insert(e,t){null!==this.doc?hV(this.doc,s=>{WV(s,this,e,t)}):this._prelimContent.splice(e,0,...t)}push(e){null!==this.doc?hV(this.doc,t=>{((e,t,s)=>{let r=(t._searchMarker||[]).reduce((e,t)=>t.index>e.index?t:e,{index:0,p:t._start}).p;if(r)for(;r.right;)r=r.right;$V(e,t,r,s)})(t,this,e)}):this._prelimContent.push(...e)}unshift(e){this.insert(0,e)}delete(e,t=1){null!==this.doc?hV(this.doc,s=>{KV(s,this,e,t)}):this._prelimContent.splice(e,t)}get(e){return zV(this,e)}toArray(){return BV(this)}slice(e=0,t=this.length){return OV(this,e,t)}toJSON(){return this.map(e=>e instanceof LV?e.toJSON():e)}map(e){return VV(this,e)}forEach(e){UV(this,e)}[Symbol.iterator](){return FV(this)}_write(e){e.writeTypeRef(BF)}}class eF extends IV{constructor(e,t,s){super(e,t),this.keysChanged=s}}class tF extends LV{constructor(e){super(),this._prelimContent=null,this._prelimContent=void 0===e?new Map:new Map(e)}_integrate(e,t){super._integrate(e,t),this._prelimContent.forEach((e,t)=>{this.set(t,e)}),this._prelimContent=null}_copy(){return new tF}clone(){const e=new tF;return this.forEach((t,s)=>{e.set(s,t instanceof LV?t.clone():t)}),e}_callObserver(e,t){MV(this,e,new eF(this,e,t))}toJSON(){this.doc??PV();const e={};return this._map.forEach((t,s)=>{if(!t.deleted){const r=t.content.getContent()[t.length-1];e[s]=r instanceof LV?r.toJSON():r}}),e}get size(){return[...YV(this)].length}keys(){return oU(YV(this),e=>e[0])}values(){return oU(YV(this),e=>e[1].content.getContent()[e[1].length-1])}entries(){return oU(YV(this),e=>[e[0],e[1].content.getContent()[e[1].length-1]])}forEach(e){this.doc??PV(),this._map.forEach((t,s)=>{t.deleted||e(t.content.getContent()[t.length-1],s,this)})}[Symbol.iterator](){return this.entries()}delete(e){null!==this.doc?hV(this.doc,t=>{jV(t,this,e)}):this._prelimContent.delete(e)}set(e,t){return null!==this.doc?hV(this.doc,s=>{HV(s,this,e,t)}):this._prelimContent.set(e,t),t}get(e){return GV(this,e)}has(e){return XV(this,e)}clear(){null!==this.doc?hV(this.doc,e=>{this.forEach(function(t,s,r){jV(e,r,s)})}):this._prelimContent.clear()}_write(e){e.writeTypeRef(UF)}}const sF=(e,t)=>e===t||"object"==typeof e&&"object"==typeof t&&e&&t&&((e,t)=>e===t||dO(e)===dO(t)&&pO(e,(e,s)=>(void 0!==e||fO(t,s))&&lO(t[s],e)))(e,t);class rF{constructor(e,t,s,r){this.left=e,this.right=t,this.index=s,this.currentAttributes=r}forward(){if(null===this.right&&LL(),this.right.content.constructor===kF)this.right.deleted||aF(this.currentAttributes,this.right.content);else this.right.deleted||(this.index+=this.right.length);this.left=this.right,this.right=this.right.right}}const nF=(e,t,s)=>{for(;null!==t.right&&s>0;){if(t.right.content.constructor===kF)t.right.deleted||aF(t.currentAttributes,t.right.content);else t.right.deleted||(s<t.right.length&&sV(e,KU(t.right.id.client,t.right.id.clock+s)),t.index+=t.right.length,s-=t.right.length);t.left=t.right,t.right=t.right.right}return t},iF=(e,t,s,r)=>{const n=new Map,i=r?NV(t,s):null;if(i){const t=new rF(i.p.left,i.p,i.index,n);return nF(e,t,s-i.index)}{const r=new rF(null,t._start,0,n);return nF(e,r,s)}},oF=(e,t,s,r)=>{for(;null!==s.right&&(!0===s.right.deleted||s.right.content.constructor===kF&&sF(r.get(s.right.content.key),s.right.content.value));)s.right.deleted||r.delete(s.right.content.key),s.forward();const n=e.doc,i=n.clientID;r.forEach((r,o)=>{const a=s.left,c=s.right,l=new XF(KU(i,YU(n.store,i)),a,a&&a.lastId,c,c&&c.id,t,null,new kF(o,r));l.integrate(e,0),s.right=l,s.forward()})},aF=(e,t)=>{const{key:s,value:r}=t;null===r?e.delete(s):e.set(s,r)},cF=(e,t)=>{for(;null!==e.right&&(e.right.deleted||e.right.content.constructor===kF&&sF(t[e.right.content.key]??null,e.right.content.value));)e.forward()},lF=(e,t,s,r)=>{const n=e.doc,i=n.clientID,o=new Map;for(const a in r){const c=r[a],l=s.currentAttributes.get(a)??null;if(!sF(l,c)){o.set(a,l);const{left:r,right:h}=s;s.right=new XF(KU(i,YU(n.store,i)),r,r&&r.lastId,h,h&&h.id,t,null,new kF(a,c)),s.right.integrate(e,0),s.forward()}}return o},hF=(e,t,s,r,n)=>{s.currentAttributes.forEach((e,t)=>{void 0===n[t]&&(n[t]=null)});const i=e.doc,o=i.clientID;cF(s,n);const a=lF(e,t,s,n),c=r.constructor===String?new LF(r):r instanceof LV?new WF(r):new AF(r);let{left:l,right:h,index:u}=s;t._searchMarker&&RV(t._searchMarker,s.index,c.getLength()),h=new XF(KU(o,YU(i.store,o)),l,l&&l.lastId,h,h&&h.id,t,null,c),h.integrate(e,0),s.right=h,s.index=u,s.forward(),oF(e,t,s,a)},uF=(e,t,s,r,n)=>{const i=e.doc,o=i.clientID;cF(s,n);const a=lF(e,t,s,n);e:for(;null!==s.right&&(r>0||a.size>0&&(s.right.deleted||s.right.content.constructor===kF));){if(!s.right.deleted)switch(s.right.content.constructor){case kF:{const{key:t,value:i}=s.right.content,o=n[t];if(void 0!==o){if(sF(o,i))a.delete(t);else{if(0===r)break e;a.set(t,i)}s.right.delete(e)}else s.currentAttributes.set(t,i);break}default:r<s.right.length&&sV(e,KU(s.right.id.client,s.right.id.clock+r)),r-=s.right.length}s.forward()}if(r>0){let n="";for(;r>0;r--)n+="\n";s.right=new XF(KU(o,YU(i.store,o)),s.left,s.left&&s.left.lastId,s.right,s.right&&s.right.id,t,null,new LF(n)),s.right.integrate(e,0),s.forward()}oF(e,t,s,a)},dF=(e,t,s,r,n)=>{let i=t;const o=LM();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===kF){const e=i.content;o.set(e.key,e)}i=i.right}let a=0,c=!1;for(;t!==i;){if(s===t&&(c=!0),!t.deleted){const s=t.content;switch(s.constructor){case kF:{const{key:i,value:l}=s,h=r.get(i)??null;o.get(i)===s&&h!==l||(t.delete(e),a++,c||(n.get(i)??null)!==l||h===l||(null===h?n.delete(i):n.set(i,h))),c||t.deleted||aF(n,s);break}}}t=t.right}return a},pF=e=>{let t=0;return hV(e.doc,s=>{let r=e._start,n=e._start,i=LM();const o=OM(i);for(;n;){if(!1===n.deleted)if(n.content.constructor===kF)aF(o,n.content);else t+=dF(s,r,n,i,o),i=OM(o),r=n;n=n.right}}),t},fF=e=>{const t=new Set,s=e.doc;for(const[r,n]of e.afterState.entries()){const i=e.beforeState.get(r)||0;n!==i&&nV(e,s.store.clients.get(r),i,n,e=>{e.deleted||e.content.constructor!==kF||e.constructor===TF||t.add(e.parent)})}hV(s,s=>{lU(e,e.deleteSet,e=>{if(e instanceof TF||!e.parent._hasFormatting||t.has(e.parent))return;const r=e.parent;e.content.constructor===kF?t.add(r):((e,t)=>{for(;t&&t.right&&(t.right.deleted||!t.right.countable);)t=t.right;const s=new Set;for(;t&&(t.deleted||!t.countable);){if(!t.deleted&&t.content.constructor===kF){const r=t.content.key;s.has(r)?t.delete(e):s.add(r)}t=t.left}})(s,e)});for(const e of t)pF(e)})},gF=(e,t,s)=>{const r=s,n=OM(t.currentAttributes),i=t.right;for(;s>0&&null!==t.right;){if(!1===t.right.deleted)switch(t.right.content.constructor){case WF:case AF:case LF:s<t.right.length&&sV(e,KU(t.right.id.client,t.right.id.clock+s)),s-=t.right.length,t.right.delete(e)}t.forward()}i&&dF(e,i,t.right,n,t.currentAttributes);const o=(t.left||t.right).parent;return o._searchMarker&&RV(o._searchMarker,t.index,-r+s),t};class mF extends IV{constructor(e,t,s){super(e,t),this.childListChanged=!1,this.keysChanged=new Set,s.forEach(e=>{null===e?this.childListChanged=!0:this.keysChanged.add(e)})}get changes(){if(null===this._changes){const e={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=e}return this._changes}get delta(){if(null===this._delta){const e=this.target.doc,t=[];hV(e,e=>{const s=new Map,r=new Map;let n=this.target._start,i=null;const o={};let a="",c=0,l=0;const h=()=>{if(null!==i){let e=null;switch(i){case"delete":l>0&&(e={delete:l}),l=0;break;case"insert":("object"==typeof a||a.length>0)&&(e={insert:a},s.size>0&&(e.attributes={},s.forEach((t,s)=>{null!==t&&(e.attributes[s]=t)}))),a="";break;case"retain":c>0&&(e={retain:c},(e=>{for(const t in e)return!1;return!0})(o)||(e.attributes=hO({},o))),c=0}e&&t.push(e),i=null}};for(;null!==n;){switch(n.content.constructor){case WF:case AF:this.adds(n)?this.deletes(n)||(h(),i="insert",a=n.content.getContent()[0],h()):this.deletes(n)?("delete"!==i&&(h(),i="delete"),l+=1):n.deleted||("retain"!==i&&(h(),i="retain"),c+=1);break;case LF:this.adds(n)?this.deletes(n)||("insert"!==i&&(h(),i="insert"),a+=n.content.str):this.deletes(n)?("delete"!==i&&(h(),i="delete"),l+=n.length):n.deleted||("retain"!==i&&(h(),i="retain"),c+=n.length);break;case kF:{const{key:t,value:a}=n.content;if(this.adds(n)){if(!this.deletes(n)){const c=s.get(t)??null;sF(c,a)?null!==a&&n.delete(e):("retain"===i&&h(),sF(a,r.get(t)??null)?delete o[t]:o[t]=a)}}else if(this.deletes(n)){r.set(t,a);const e=s.get(t)??null;sF(e,a)||("retain"===i&&h(),o[t]=e)}else if(!n.deleted){r.set(t,a);const s=o[t];void 0!==s&&(sF(s,a)?null!==s&&n.delete(e):("retain"===i&&h(),null===a?delete o[t]:o[t]=a))}n.deleted||("insert"===i&&h(),aF(s,n.content));break}}n=n.right}for(h();t.length>0;){const e=t[t.length-1];if(void 0===e.retain||void 0!==e.attributes)break;t.pop()}}),this._delta=t}return this._delta}}class yF extends LV{constructor(e){super(),this._pending=void 0!==e?[()=>this.insert(0,e)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??PV(),this._length}_integrate(e,t){super._integrate(e,t);try{this._pending.forEach(e=>e())}catch(e){console.error(e)}this._pending=null}_copy(){return new yF}clone(){const e=new yF;return e.applyDelta(this.toDelta()),e}_callObserver(e,t){super._callObserver(e,t);const s=new mF(this,e,t);MV(this,e,s),!e.local&&this._hasFormatting&&(e._needFormattingCleanup=!0)}toString(){this.doc??PV();let e="",t=this._start;for(;null!==t;)!t.deleted&&t.countable&&t.content.constructor===LF&&(e+=t.content.str),t=t.right;return e}toJSON(){return this.toString()}applyDelta(e,{sanitize:t=!0}={}){null!==this.doc?hV(this.doc,s=>{const r=new rF(null,this._start,0,new Map);for(let n=0;n<e.length;n++){const i=e[n];if(void 0!==i.insert){const o=t||"string"!=typeof i.insert||n!==e.length-1||null!==r.right||"\n"!==i.insert.slice(-1)?i.insert:i.insert.slice(0,-1);("string"!=typeof o||o.length>0)&&hF(s,this,r,o,i.attributes||{})}else void 0!==i.retain?uF(s,this,r,i.retain,i.attributes||{}):void 0!==i.delete&&gF(s,r,i.delete)}}):this._pending.push(()=>this.applyDelta(e))}toDelta(e,t,s){this.doc??PV();const r=[],n=new Map,i=this.doc;let o="",a=this._start;function c(){if(o.length>0){const e={};let t=!1;n.forEach((s,r)=>{t=!0,e[r]=s});const s={insert:o};t&&(s.attributes=e),r.push(s),o=""}}const l=()=>{for(;null!==a;){if(HU(a,e)||void 0!==t&&HU(a,t))switch(a.content.constructor){case LF:{const r=n.get("ychange");void 0===e||HU(a,e)?void 0===t||HU(a,t)?void 0!==r&&(c(),n.delete("ychange")):void 0!==r&&r.user===a.id.client&&"added"===r.type||(c(),n.set("ychange",s?s("added",a.id):{type:"added"})):void 0!==r&&r.user===a.id.client&&"removed"===r.type||(c(),n.set("ychange",s?s("removed",a.id):{type:"removed"})),o+=a.content.str;break}case WF:case AF:{c();const e={insert:a.content.getContent()[0]};if(n.size>0){const t={};e.attributes=t,n.forEach((e,s)=>{t[s]=e})}r.push(e);break}case kF:HU(a,e)&&(c(),aF(n,a.content))}a=a.right}c()};return e||t?hV(i,s=>{e&&GU(s,e),t&&GU(s,t),l()},"cleanup"):l(),r}insert(e,t,s){if(t.length<=0)return;const r=this.doc;null!==r?hV(r,r=>{const n=iF(r,this,e,!s);s||(s={},n.currentAttributes.forEach((e,t)=>{s[t]=e})),hF(r,this,n,t,s)}):this._pending.push(()=>this.insert(e,t,s))}insertEmbed(e,t,s){const r=this.doc;null!==r?hV(r,r=>{const n=iF(r,this,e,!s);hF(r,this,n,t,s||{})}):this._pending.push(()=>this.insertEmbed(e,t,s||{}))}delete(e,t){if(0===t)return;const s=this.doc;null!==s?hV(s,s=>{gF(s,iF(s,this,e,!0),t)}):this._pending.push(()=>this.delete(e,t))}format(e,t,s){if(0===t)return;const r=this.doc;null!==r?hV(r,r=>{const n=iF(r,this,e,!1);null!==n.right&&uF(r,this,n,t,s)}):this._pending.push(()=>this.format(e,t,s))}removeAttribute(e){null!==this.doc?hV(this.doc,t=>{jV(t,this,e)}):this._pending.push(()=>this.removeAttribute(e))}setAttribute(e,t){null!==this.doc?hV(this.doc,s=>{HV(s,this,e,t)}):this._pending.push(()=>this.setAttribute(e,t))}getAttribute(e){return GV(this,e)}getAttributes(){return QV(this)}_write(e){e.writeTypeRef(VF)}}class bF{constructor(e,t=()=>!0){this._filter=t,this._root=e,this._currentNode=e._start,this._firstCall=!0,e.doc??PV()}[Symbol.iterator](){return this}next(){let e=this._currentNode,t=e&&e.content&&e.content.type;if(null!==e&&(!this._firstCall||e.deleted||!this._filter(t)))do{if(t=e.content.type,e.deleted||t.constructor!==vF&&t.constructor!==wF||null===t._start)for(;null!==e;){const t=e.next;if(null!==t){e=t;break}e=e.parent===this._root?null:e.parent._item}else e=t._start}while(null!==e&&(e.deleted||!this._filter(e.content.type)));return this._firstCall=!1,null===e?{value:void 0,done:!0}:(this._currentNode=e,{value:e.content.type,done:!1})}}class wF extends LV{constructor(){super(),this._prelimContent=[]}get firstChild(){const e=this._first;return e?e.content.getContent()[0]:null}_integrate(e,t){super._integrate(e,t),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new wF}clone(){const e=new wF;return e.insert(0,this.toArray().map(e=>e instanceof LV?e.clone():e)),e}get length(){return this.doc??PV(),null===this._prelimContent?this._length:this._prelimContent.length}createTreeWalker(e){return new bF(this,e)}querySelector(e){e=e.toUpperCase();const t=new bF(this,t=>t.nodeName&&t.nodeName.toUpperCase()===e).next();return t.done?null:t.value}querySelectorAll(e){return e=e.toUpperCase(),zM(new bF(this,t=>t.nodeName&&t.nodeName.toUpperCase()===e))}_callObserver(e,t){MV(this,e,new SF(this,t,e))}toString(){return VV(this,e=>e.toString()).join("")}toJSON(){return this.toString()}toDOM(e=document,t={},s){const r=e.createDocumentFragment();return void 0!==s&&s._createAssociation(r,this),UV(this,n=>{r.insertBefore(n.toDOM(e,t,s),null)}),r}insert(e,t){null!==this.doc?hV(this.doc,s=>{WV(s,this,e,t)}):this._prelimContent.splice(e,0,...t)}insertAfter(e,t){if(null!==this.doc)hV(this.doc,s=>{const r=e&&e instanceof LV?e._item:e;$V(s,this,r,t)});else{const s=this._prelimContent,r=null===e?0:s.findIndex(t=>t===e)+1;if(0===r&&null!==e)throw RL("Reference item not found");s.splice(r,0,...t)}}delete(e,t=1){null!==this.doc?hV(this.doc,s=>{KV(s,this,e,t)}):this._prelimContent.splice(e,t)}toArray(){return BV(this)}push(e){this.insert(this.length,e)}unshift(e){this.insert(0,e)}get(e){return zV(this,e)}slice(e=0,t=this.length){return OV(this,e,t)}forEach(e){UV(this,e)}_write(e){e.writeTypeRef(zF)}}class vF extends wF{constructor(e="UNDEFINED"){super(),this.nodeName=e,this._prelimAttrs=new Map}get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_integrate(e,t){super._integrate(e,t),this._prelimAttrs.forEach((e,t)=>{this.setAttribute(t,e)}),this._prelimAttrs=null}_copy(){return new vF(this.nodeName)}clone(){const e=new vF(this.nodeName);return((e,t)=>{for(const s in e)t(e[s],s)})(this.getAttributes(),(t,s)=>{e.setAttribute(s,t)}),e.insert(0,this.toArray().map(e=>e instanceof LV?e.clone():e)),e}toString(){const e=this.getAttributes(),t=[],s=[];for(const t in e)s.push(t);s.sort();const r=s.length;for(let n=0;n<r;n++){const r=s[n];t.push(r+'="'+e[r]+'"')}const n=this.nodeName.toLocaleLowerCase();return`<${n}${t.length>0?" "+t.join(" "):""}>${super.toString()}</${n}>`}removeAttribute(e){null!==this.doc?hV(this.doc,t=>{jV(t,this,e)}):this._prelimAttrs.delete(e)}setAttribute(e,t){null!==this.doc?hV(this.doc,s=>{HV(s,this,e,t)}):this._prelimAttrs.set(e,t)}getAttribute(e){return GV(this,e)}hasAttribute(e){return XV(this,e)}getAttributes(e){return e?((e,t)=>{const s={};return e._map.forEach((e,r)=>{let n=e;for(;null!==n&&(!t.sv.has(n.id.client)||n.id.clock>=(t.sv.get(n.id.client)||0));)n=n.left;null!==n&&HU(n,t)&&(s[r]=n.content.getContent()[n.length-1])}),s})(this,e):QV(this)}toDOM(e=document,t={},s){const r=e.createElement(this.nodeName),n=this.getAttributes();for(const e in n){const t=n[e];"string"==typeof t&&r.setAttribute(e,t)}return UV(this,n=>{r.appendChild(n.toDOM(e,t,s))}),void 0!==s&&s._createAssociation(r,this),r}_write(e){e.writeTypeRef(FF),e.writeKey(this.nodeName)}}class SF extends IV{constructor(e,t,s){super(e,s),this.childListChanged=!1,this.attributesChanged=new Set,t.forEach(e=>{null===e?this.childListChanged=!0:this.attributesChanged.add(e)})}}class EF extends tF{constructor(e){super(),this.hookName=e}_copy(){return new EF(this.hookName)}clone(){const e=new EF(this.hookName);return this.forEach((t,s)=>{e.set(s,t)}),e}toDOM(e=document,t={},s){const r=t[this.hookName];let n;return n=void 0!==r?r.createDom(this):document.createElement(this.hookName),n.setAttribute("data-yjs-hook",this.hookName),void 0!==s&&s._createAssociation(n,this),n}_write(e){e.writeTypeRef($F),e.writeKey(this.hookName)}}class DF extends yF{get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_copy(){return new DF}clone(){const e=new DF;return e.applyDelta(this.toDelta()),e}toDOM(e=document,t,s){const r=e.createTextNode(this.toString());return void 0!==s&&s._createAssociation(r,this),r}toString(){return this.toDelta().map(e=>{const t=[];for(const s in e.attributes){const r=[];for(const t in e.attributes[s])r.push({key:t,value:e.attributes[s][t]});r.sort((e,t)=>e.key<t.key?-1:1),t.push({nodeName:s,attrs:r})}t.sort((e,t)=>e.nodeName<t.nodeName?-1:1);let s="";for(let e=0;e<t.length;e++){const r=t[e];s+=`<${r.nodeName}`;for(let e=0;e<r.attrs.length;e++){const t=r.attrs[e];s+=` ${t.key}="${t.value}"`}s+=">"}s+=e.insert;for(let e=t.length-1;e>=0;e--)s+=`</${t[e].nodeName}>`;return s}).join("")}toJSON(){return this.toString()}_write(e){e.writeTypeRef(qF)}}class _F{constructor(e,t){this.id=e,this.length=t}get deleted(){throw ML()}mergeWith(e){return!1}write(e,t,s){throw ML()}integrate(e,t){throw ML()}}class TF extends _F{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor===e.constructor&&(this.length+=e.length,!0)}integrate(e,t){t>0&&(this.id.clock+=t,this.length-=t),JU(e.doc.store,this)}write(e,t){e.writeInfo(0),e.writeLen(this.length-t)}getMissing(e,t){return null}}class IF{constructor(e){this.content=e}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new IF(this.content)}splice(e){throw ML()}mergeWith(e){return!1}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeBuf(this.content)}getRef(){return 3}}class CF{constructor(e){this.len=e}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new CF(this.len)}splice(e){const t=new CF(this.len-e);return this.len=e,t}mergeWith(e){return this.len+=e.len,!0}integrate(e,t){pU(e.deleteSet,t.id.client,t.id.clock,this.len),t.markDeleted()}delete(e){}gc(e){}write(e,t){e.writeLen(this.len-t)}getRef(){return 1}}const PF=(e,t)=>new wU({guid:e,...t,shouldLoad:t.shouldLoad||t.autoLoad||!1});class xF{constructor(e){e._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=e;const t={};this.opts=t,e.gc||(t.gc=!1),e.autoLoad&&(t.autoLoad=!0),null!==e.meta&&(t.meta=e.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new xF(PF(this.doc.guid,this.opts))}splice(e){throw ML()}mergeWith(e){return!1}integrate(e,t){this.doc._item=t,e.subdocsAdded.add(this.doc),this.doc.shouldLoad&&e.subdocsLoaded.add(this.doc)}delete(e){e.subdocsAdded.has(this.doc)?e.subdocsAdded.delete(this.doc):e.subdocsRemoved.add(this.doc)}gc(e){}write(e,t){e.writeString(this.doc.guid),e.writeAny(this.opts)}getRef(){return 9}}class AF{constructor(e){this.embed=e}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new AF(this.embed)}splice(e){throw ML()}mergeWith(e){return!1}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeJSON(this.embed)}getRef(){return 5}}class kF{constructor(e,t){this.key=e,this.value=t}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new kF(this.key,this.value)}splice(e){throw ML()}mergeWith(e){return!1}integrate(e,t){const s=t.parent;s._searchMarker=null,s._hasFormatting=!0}delete(e){}gc(e){}write(e,t){e.writeKey(this.key),e.writeJSON(this.value)}getRef(){return 6}}class NF{constructor(e){this.arr=e}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new NF(this.arr)}splice(e){const t=new NF(this.arr.slice(e));return this.arr=this.arr.slice(0,e),t}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){const s=this.arr.length;e.writeLen(s-t);for(let r=t;r<s;r++){const t=this.arr[r];e.writeString(void 0===t?"undefined":JSON.stringify(t))}}getRef(){return 2}}const RF="development"===DO("node_env");class MF{constructor(e){this.arr=e,RF&&mO(e)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new MF(this.arr)}splice(e){const t=new MF(this.arr.slice(e));return this.arr=this.arr.slice(0,e),t}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){const s=this.arr.length;e.writeLen(s-t);for(let r=t;r<s;r++){const t=this.arr[r];e.writeAny(t)}}getRef(){return 8}}class LF{constructor(e){this.str=e}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new LF(this.str)}splice(e){const t=new LF(this.str.slice(e));this.str=this.str.slice(0,e);const s=this.str.charCodeAt(e-1);return s>=55296&&s<=56319&&(this.str=this.str.slice(0,e-1)+"ï¿½",t.str="ï¿½"+t.str.slice(1)),t}mergeWith(e){return this.str+=e.str,!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeString(0===t?this.str:this.str.slice(t))}getRef(){return 4}}const OF=[e=>new ZV,e=>new tF,e=>new yF,e=>new vF(e.readKey()),e=>new wF,e=>new EF(e.readKey()),e=>new DF],BF=0,UF=1,VF=2,FF=3,zF=4,$F=5,qF=6;class WF{constructor(e){this.type=e}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new WF(this.type._copy())}splice(e){throw ML()}mergeWith(e){return!1}integrate(e,t){this.type._integrate(e.doc,t)}delete(e){let t=this.type._start;for(;null!==t;)t.deleted?t.id.clock<(e.beforeState.get(t.id.client)||0)&&e._mergeStructs.push(t):t.delete(e),t=t.right;this.type._map.forEach(t=>{t.deleted?t.id.clock<(e.beforeState.get(t.id.client)||0)&&e._mergeStructs.push(t):t.delete(e)}),e.changed.delete(this.type)}gc(e){let t=this.type._start;for(;null!==t;)t.gc(e,!0),t=t.right;this.type._start=null,this.type._map.forEach(t=>{for(;null!==t;)t.gc(e,!0),t=t.left}),this.type._map=new Map}write(e,t){this.type._write(e)}getRef(){return 7}}const KF=(e,t)=>{let s,r=t,n=0;do{n>0&&(r=KU(r.client,r.clock+n)),s=eV(e,r),n=r.clock-s.id.clock,r=s.redone}while(null!==r&&s instanceof XF);return{item:s,diff:n}},jF=(e,t)=>{for(;null!==e&&e.keep!==t;)e.keep=t,e=e.parent._item},HF=(e,t,s)=>{const{client:r,clock:n}=t.id,i=new XF(KU(r,n+s),t,KU(r,n+s-1),t.right,t.rightOrigin,t.parent,t.parentSub,t.content.splice(s));return t.deleted&&i.markDeleted(),t.keep&&(i.keep=!0),null!==t.redone&&(i.redone=KU(t.redone.client,t.redone.clock+s)),t.right=i,null!==i.right&&(i.right.left=i),e._mergeStructs.push(i),null!==i.parentSub&&null===i.right&&i.parent._map.set(i.parentSub,i),t.length=s,i},GF=(e,t)=>qM(e,e=>hU(e.deletions,t)),QF=(e,t,s,r,n,i)=>{const o=e.doc,a=o.store,c=o.clientID,l=t.redone;if(null!==l)return sV(e,l);let h,u=t.parent._item,d=null;if(null!==u&&!0===u.deleted){if(null===u.redone&&(!s.has(u)||null===QF(e,u,s,r,n,i)))return null;for(;null!==u.redone;)u=sV(e,u.redone)}const p=null===u?t.parent:u.content.type;if(null===t.parentSub){for(d=t.left,h=t;null!==d;){let t=d;for(;null!==t&&t.parent._item!==u;)t=null===t.redone?null:sV(e,t.redone);if(null!==t&&t.parent._item===u){d=t;break}d=d.left}for(;null!==h;){let t=h;for(;null!==t&&t.parent._item!==u;)t=null===t.redone?null:sV(e,t.redone);if(null!==t&&t.parent._item===u){h=t;break}h=h.right}}else if(h=null,t.right&&!n){for(d=t;null!==d&&null!==d.right&&(d.right.redone||hU(r,d.right.id)||GF(i.undoStack,d.right.id)||GF(i.redoStack,d.right.id));)for(d=d.right;d.redone;)d=sV(e,d.redone);if(d&&null!==d.right)return null}else d=p._map.get(t.parentSub)||null;const f=YU(a,c),g=KU(c,f),m=new XF(g,d,d&&d.lastId,h,h&&h.id,p,t.parentSub,t.content.copy());return t.redone=g,jF(m,!0),m.integrate(e,0),m};class XF extends _F{constructor(e,t,s,r,n,i,o,a){super(e,a.getLength()),this.origin=s,this.left=t,this.right=r,this.rightOrigin=n,this.parent=i,this.parentSub=o,this.redone=null,this.content=a,this.info=this.content.isCountable()?2:0}set marker(e){(8&this.info)>0!==e&&(this.info^=8)}get marker(){return(8&this.info)>0}get keep(){return(1&this.info)>0}set keep(e){this.keep!==e&&(this.info^=1)}get countable(){return(2&this.info)>0}get deleted(){return(4&this.info)>0}set deleted(e){this.deleted!==e&&(this.info^=4)}markDeleted(){this.info|=4}getMissing(e,t){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=YU(t,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=YU(t,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===qU&&this.id.client!==this.parent.client&&this.parent.clock>=YU(t,this.parent.client))return this.parent.client;if(this.origin&&(this.left=rV(e,t,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=sV(e,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===TF||this.right&&this.right.constructor===TF)this.parent=null;else if(this.parent){if(this.parent.constructor===qU){const e=eV(t,this.parent);e.constructor===TF?this.parent=null:this.parent=e.content.type}}else this.left&&this.left.constructor===XF?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===XF&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);return null}integrate(e,t){if(t>0&&(this.id.clock+=t,this.left=rV(e,e.doc.store,KU(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(t),this.length-=t),this.parent){if(!this.left&&(!this.right||null!==this.right.left)||this.left&&this.left.right!==this.right){let t,s=this.left;if(null!==s)t=s.right;else if(null!==this.parentSub)for(t=this.parent._map.get(this.parentSub)||null;null!==t&&null!==t.left;)t=t.left;else t=this.parent._start;const r=new Set,n=new Set;for(;null!==t&&t!==this.right;){if(n.add(t),r.add(t),WU(this.origin,t.origin)){if(t.id.client<this.id.client)s=t,r.clear();else if(WU(this.rightOrigin,t.rightOrigin))break}else{if(null===t.origin||!n.has(eV(e.doc.store,t.origin)))break;r.has(eV(e.doc.store,t.origin))||(s=t,r.clear())}t=t.right}this.left=s}if(null!==this.left){const e=this.left.right;this.right=e,this.left.right=this}else{let e;if(null!==this.parentSub)for(e=this.parent._map.get(this.parentSub)||null;null!==e&&null!==e.left;)e=e.left;else e=this.parent._start,this.parent._start=this;this.right=e}null!==this.right?this.right.left=this:null!==this.parentSub&&(this.parent._map.set(this.parentSub,this),null!==this.left&&this.left.delete(e)),null===this.parentSub&&this.countable&&!this.deleted&&(this.parent._length+=this.length),JU(e.doc.store,this),this.content.integrate(e,this),aV(e,this.parent,this.parentSub),(null!==this.parent._item&&this.parent._item.deleted||null!==this.parentSub&&null!==this.right)&&this.delete(e)}else new TF(this.id,this.length).integrate(e,0)}get next(){let e=this.right;for(;null!==e&&e.deleted;)e=e.right;return e}get prev(){let e=this.left;for(;null!==e&&e.deleted;)e=e.left;return e}get lastId(){return 1===this.length?this.id:KU(this.id.client,this.id.clock+this.length-1)}mergeWith(e){if(this.constructor===e.constructor&&WU(e.origin,this.lastId)&&this.right===e&&WU(this.rightOrigin,e.rightOrigin)&&this.id.client===e.id.client&&this.id.clock+this.length===e.id.clock&&this.deleted===e.deleted&&null===this.redone&&null===e.redone&&this.content.constructor===e.content.constructor&&this.content.mergeWith(e.content)){const t=this.parent._searchMarker;return t&&t.forEach(t=>{t.p===e&&(t.p=this,!this.deleted&&this.countable&&(t.index-=this.length))}),e.keep&&(this.keep=!0),this.right=e.right,null!==this.right&&(this.right.left=this),this.length+=e.length,!0}return!1}delete(e){if(!this.deleted){const t=this.parent;this.countable&&null===this.parentSub&&(t._length-=this.length),this.markDeleted(),pU(e.deleteSet,this.id.client,this.id.clock,this.length),aV(e,t,this.parentSub),this.content.delete(e)}}gc(e,t){if(!this.deleted)throw LL();this.content.gc(e),t?((e,t,s)=>{const r=e.clients.get(t.id.client);r[ZU(r,t.id.clock)]=s})(e,this,new TF(this.id,this.length)):this.content=new CF(this.length)}write(e,t){const s=t>0?KU(this.id.client,this.id.clock+t-1):this.origin,r=this.rightOrigin,n=this.parentSub,i=31&this.content.getRef()|(null===s?0:ZM)|(null===r?0:JM)|(null===n?0:32);if(e.writeInfo(i),null!==s&&e.writeLeftID(s),null!==r&&e.writeRightID(r),null===s&&null===r){const t=this.parent;if(void 0!==t._item){const s=t._item;if(null===s){const s=(e=>{for(const[t,s]of e.doc.share.entries())if(s===e)return t;throw LL()})(t);e.writeParentInfo(!0),e.writeString(s)}else e.writeParentInfo(!1),e.writeLeftID(s.id)}else t.constructor===String?(e.writeParentInfo(!0),e.writeString(t)):t.constructor===qU?(e.writeParentInfo(!1),e.writeLeftID(t)):LL();null!==n&&e.writeString(n)}this.content.write(e,t)}}const YF=(e,t)=>JF[31&t](e),JF=[()=>{LL()},e=>new CF(e.readLen()),e=>{const t=e.readLen(),s=[];for(let r=0;r<t;r++){const t=e.readString();"undefined"===t?s.push(void 0):s.push(JSON.parse(t))}return new NF(s)},e=>new IF(e.readBuf()),e=>new LF(e.readString()),e=>new AF(e.readJSON()),e=>new kF(e.readKey(),e.readJSON()),e=>new WF(OF[e.readTypeRef()](e)),e=>{const t=e.readLen(),s=[];for(let r=0;r<t;r++)s.push(e.readAny());return new MF(s)},e=>new xF(PF(e.readString(),e.readAny())),()=>{LL()}];class ZF extends _F{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor===e.constructor&&(this.length+=e.length,!0)}integrate(e,t){LL()}write(e,t){e.writeInfo(10),yL(e.restEncoder,this.length-t)}getMissing(e,t){return null}}const ez="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},tz="__ $YJS$ __";!0===ez[tz]&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438"),ez[tz]=!0;const sz=3e4;class rz extends jM{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const e=sO();null!==this.getLocalState()&&15e3<=e-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const t=[];this.meta.forEach((s,r)=>{r!==this.clientID&&sz<=e-s.lastUpdated&&this.states.has(r)&&t.push(r)}),t.length>0&&nz(this,t,"timeout")},HM(3e3)),e.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){const t=this.clientID,s=this.meta.get(t),r=void 0===s?0:s.clock+1,n=this.states.get(t);null===e?this.states.delete(t):this.states.set(t,e),this.meta.set(t,{clock:r,lastUpdated:sO()});const i=[],o=[],a=[],c=[];null===e?c.push(t):null==n?null!=e&&i.push(t):(o.push(t),wO(n,e)||a.push(t)),(i.length>0||a.length>0||c.length>0)&&this.emit("change",[{added:i,updated:a,removed:c},"local"]),this.emit("update",[{added:i,updated:o,removed:c},"local"])}setLocalStateField(e,t){const s=this.getLocalState();null!==s&&this.setLocalState({...s,[e]:t})}getStates(){return this.states}}const nz=(e,t,s)=>{const r=[];for(let s=0;s<t.length;s++){const n=t[s];if(e.states.has(n)){if(e.states.delete(n),n===e.clientID){const t=e.meta.get(n);e.meta.set(n,{clock:t.clock+1,lastUpdated:sO()})}r.push(n)}}r.length>0&&(e.emit("change",[{added:[],updated:[],removed:r},s]),e.emit("update",[{added:[],updated:[],removed:r},s]))},iz=(e,t,s=e.states)=>{const r=t.length,n=pL();yL(n,r);for(let i=0;i<r;i++){const r=t[i],o=s.get(r)||null,a=e.meta.get(r).clock;yL(n,r),yL(n,a),SL(n,JSON.stringify(o))}return fL(n)},oz={SYNC_REQUEST:0,SYNC_RESPONSE:1,UPDATE:2,AWARENESS:3};class az{constructor(e,t,s,r={}){this.doc=e,this.roomId=t,this.node=s,this.topic=Je.ROOM_PREFIX+t,this.awarenessInterval=r.awarenessInterval||rt.awarenessInterval,this.updateDebounce=r.updateDebounce||rt.updateDebounce,this.awareness=new rz(e),this._synced=!1,this._destroyed=!1,this._pendingUpdates=[],this._updateTimeout=null,this._awarenessInterval=null,this._messageHandler=null,this._onMessage=this._onMessage.bind(this),this._onDocUpdate=this._onDocUpdate.bind(this),this._onAwarenessUpdate=this._onAwarenessUpdate.bind(this),this._init()}_init(){this.node.subscribe(this.topic),this._messageHandler=e=>this._onMessage(e),this.node.on("message",this._messageHandler),this.doc.on("update",this._onDocUpdate),this.awareness.on("update",this._onAwarenessUpdate),this._requestSync(),this._startAwarenessInterval(),console.log(`ðŸ“„ Provider initialized for room: ${this.roomId}`)}_onMessage(e){if(!this._destroyed&&e.detail.topic===this.topic)try{const t=function(e){const t=JSON.parse(Qe(e));return t.data&&(t.data=new Uint8Array(t.data)),t}(e.detail.data);this._handleMessage(t)}catch(e){console.warn("Failed to decode sync message:",e.message)}}_handleMessage(e){switch(e.type){case oz.SYNC_REQUEST:this._handleSyncRequest(e);break;case oz.SYNC_RESPONSE:this._handleSyncResponse(e);break;case oz.UPDATE:this._handleUpdate(e);break;case oz.AWARENESS:this._handleAwarenessUpdate(e)}}_handleSyncRequest(e){const t=e.data,s=RU(this.doc,t);this._broadcast({type:oz.SYNC_RESPONSE,from:this.node.peerId,data:s})}_handleSyncResponse(e){try{kU(this.doc,e.data,this),this._synced=!0}catch(e){console.warn("Failed to apply sync response:",e.message)}}_handleUpdate(e){try{kU(this.doc,e.data,this)}catch(e){console.warn("Failed to apply update:",e.message)}}_handleAwarenessUpdate(e){try{((e,t,s)=>{const r=VL(t),n=sO(),i=[],o=[],a=[],c=[],l=$L(r);for(let t=0;t<l;t++){const t=$L(r);let s=$L(r);const l=JSON.parse(WL(r)),h=e.meta.get(t),u=e.states.get(t),d=void 0===h?0:h.clock;(d<s||d===s&&null===l&&e.states.has(t))&&(null===l?t===e.clientID&&null!=e.getLocalState()?s++:e.states.delete(t):e.states.set(t,l),e.meta.set(t,{clock:s,lastUpdated:n}),void 0===h&&null!==l?i.push(t):void 0!==h&&null===l?c.push(t):null!==l&&(wO(l,u)||a.push(t),o.push(t)))}(i.length>0||a.length>0||c.length>0)&&e.emit("change",[{added:i,updated:a,removed:c},s]),(i.length>0||o.length>0||c.length>0)&&e.emit("update",[{added:i,updated:o,removed:c},s])})(this.awareness,e.data,this)}catch(e){console.warn("Failed to apply awareness update:",e.message)}}_onDocUpdate(e,t){this._destroyed||t!==this&&(this._pendingUpdates.push(e),this._updateTimeout&&clearTimeout(this._updateTimeout),this._updateTimeout=setTimeout(()=>{this._flushUpdates()},this.updateDebounce))}_flushUpdates(){if(0===this._pendingUpdates.length)return;const e=yV(this._pendingUpdates);this._pendingUpdates=[],this._broadcast({type:oz.UPDATE,from:this.node.peerId,data:e})}_onAwarenessUpdate({added:e,updated:t,removed:s}){if(this._destroyed)return;const r=[...e,...t,...s],n=iz(this.awareness,r);this._broadcast({type:oz.AWARENESS,from:this.node.peerId,data:n})}_requestSync(){const e=BU(this.doc);this._broadcast({type:oz.SYNC_REQUEST,from:this.node.peerId,data:e})}_startAwarenessInterval(){this._awarenessInterval=setInterval(()=>{if(this._destroyed)return;const e=[this.doc.clientID],t=iz(this.awareness,e);this._broadcast({type:oz.AWARENESS,from:this.node.peerId,data:t})},this.awarenessInterval)}async _broadcast(e){if(!this._destroyed)try{const t=function(e){return Ge(JSON.stringify({...e,data:e.data?Array.from(e.data):null}))}(e);await this.node.publish(this.topic,t)}catch(e){console.warn("Failed to broadcast:",e.message)}}setAwarenessState(e){this.awareness.setLocalState(e)}getLocalAwarenessState(){return this.awareness.getLocalState()}getAwarenessStates(){return this.awareness.getStates()}getConnectedPeers(){return this.node.getSubscribers(this.topic)}get isSynced(){return this._synced}sync(){this._requestSync()}destroy(){this._destroyed||(this._destroyed=!0,this._awarenessInterval&&clearInterval(this._awarenessInterval),this._updateTimeout&&clearTimeout(this._updateTimeout),this.doc.off("update",this._onDocUpdate),this.awareness.off("update",this._onAwarenessUpdate),this._messageHandler&&this.node.off("message",this._messageHandler),this.node.unsubscribe(this.topic),this.awareness.destroy(),console.log(`ðŸ“„ Provider destroyed for room: ${this.roomId}`))}}function cz(e,t,s={}){const r=s.doc||new wU;return{doc:r,provider:new az(r,e,t,s)}}const lz={ACTIVE:"active",IDLE:"idle",AWAY:"away",OFFLINE:"offline"},hz=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#98D8C8","#F7DC6F","#BB8FCE","#85C1E9","#F8B500","#00CED1","#FF69B4","#7FFF00","#FF4500","#1E90FF"];function uz(){return hz[Math.floor(Math.random()*hz.length)]}class dz{constructor(e,t={}){this.awareness=e,this.timeout=t.timeout||rt.awarenessTimeout,this._user=null,this._idleTimeout=null,this._awayTimeout=null,this._lastActivity=Date.now(),this._onActivity=this._onActivity.bind(this),this._checkIdle=this._checkIdle.bind(this)}setUser(e){this._user={name:e.name||"Anonymous",color:e.color||uz(),avatar:e.avatar||null,...e},this._updateAwareness()}getUser(){return this._user}setCursor(e){this._updateAwareness({cursor:e}),this._onActivity()}setSelection(e){this._updateAwareness({selection:e}),this._onActivity()}setCustomState(e){this._updateAwareness({custom:e}),this._onActivity()}_updateAwareness(e={}){const t=this.awareness.getLocalState()||{};this.awareness.setLocalState({user:this._user,state:this._getPresenceState(),lastActive:this._lastActivity,...t,...e})}_getPresenceState(){const e=Date.now()-this._lastActivity;return e>3e5?lz.AWAY:e>6e4?lz.IDLE:lz.ACTIVE}_onActivity(){this._lastActivity=Date.now(),this._updateAwareness()}startTracking(){"undefined"!=typeof document&&(document.addEventListener("mousemove",this._onActivity),document.addEventListener("keypress",this._onActivity),document.addEventListener("click",this._onActivity),document.addEventListener("scroll",this._onActivity)),this._idleInterval=setInterval(this._checkIdle,3e4)}stopTracking(){"undefined"!=typeof document&&(document.removeEventListener("mousemove",this._onActivity),document.removeEventListener("keypress",this._onActivity),document.removeEventListener("click",this._onActivity),document.removeEventListener("scroll",this._onActivity)),this._idleInterval&&clearInterval(this._idleInterval)}_checkIdle(){this._updateAwareness()}getUsers(){const e=this.awareness.getStates(),t=[];for(const[s,r]of e)r?.user&&t.push({clientId:s,...r.user,state:r.state||lz.ACTIVE,cursor:r.cursor,selection:r.selection,lastActive:r.lastActive});return t}getActiveUsers(){return this.getUsers().filter(e=>e.state===lz.ACTIVE||e.state===lz.IDLE)}getUserCount(){return this.getUsers().length}removeStaleUsers(){const e=Date.now(),t=this.awareness.getStates();for(const[s,r]of t)r?.lastActive&&e-r.lastActive>this.timeout&&this.awareness.setLocalStateField(s,null)}onChange(e){this.awareness.on("change",e)}offChange(e){this.awareness.off("change",e)}}class pz{constructor(e,t){this.container=e,this.awareness=t,this.cursors=new Map}start(){this.awareness.onChange(this._update.bind(this)),this._update()}stop(){this.cursors.forEach(e=>e.remove()),this.cursors.clear()}_update(){const e=this.awareness.getActiveUsers(),t=this.awareness.awareness.clientID;for(const s of e){if(s.clientId===t)continue;if(!s.cursor)continue;let e=this.cursors.get(s.clientId);e||(e=this._createCursorElement(s),this.container.appendChild(e),this.cursors.set(s.clientId,e)),this._updateCursorElement(e,s)}const s=new Set(e.map(e=>e.clientId));for(const[e,t]of this.cursors)s.has(e)||(t.remove(),this.cursors.delete(e))}_createCursorElement(e){const t=document.createElement("div");return t.className="konomi-cursor",t.innerHTML=`\n      <svg width="24" height="24" viewBox="0 0 24 24" fill="${e.color}">\n        <path d="M5.65 0L18.15 12.5L12.4 12.5L18.15 22.5L15.4 24L9.65 14L5.65 18.5L5.65 0Z"/>\n      </svg>\n      <span class="konomi-cursor-label" style="background: ${e.color}">${e.name}</span>\n    `,t.style.cssText="\n      position: absolute;\n      pointer-events: none;\n      z-index: 9999;\n      transition: transform 0.1s ease-out;\n    ",t}_updateCursorElement(e,t){t.cursor?(e.style.transform=`translate(${t.cursor.x}px, ${t.cursor.y}px)`,e.style.display="block"):e.style.display="none"}}const fz={DISCONNECTED:"disconnected",CONNECTING:"connecting",CONNECTED:"connected",SYNCING:"syncing",SYNCED:"synced"};class gz{constructor(e,t,s={}){this.id=e,this.node=t,this.topic=Je.ROOM_PREFIX+e,this.doc=new wU,this.provider=new az(this.doc,e,t,s),this.awareness=new dz(this.provider.awareness,s),this._state=fz.DISCONNECTED,this._handlers=new Map,this._meta=this.doc.getMap("_meta"),this._init(s)}_init(e){e.user?this.awareness.setUser(e.user):this.awareness.setUser({name:"Anonymous",color:uz()}),this.doc.on("update",()=>{this._state!==fz.SYNCED&&this.provider.isSynced&&this._setState(fz.SYNCED)}),this._setState(fz.CONNECTED),this.awareness.startTracking()}get state(){return this._state}_setState(e){if(this._state!==e){const t=this._state;this._state=e,this._emit("state",{oldState:t,newState:e})}}getMap(e){return this.doc.getMap(e)}getArray(e){return this.doc.getArray(e)}getText(e){return this.doc.getText(e)}getXmlFragment(e){return this.doc.getXmlFragment(e)}getMeta(){return this._meta.toJSON()}setMeta(e,t){this._meta.set(e,t)}getPeers(){return this.provider.getConnectedPeers()}getUsers(){return this.awareness.getActiveUsers()}setUser(e){this.awareness.setUser(e)}setCursor(e){this.awareness.setCursor(e)}transact(e,t=null){this.doc.transact(e,t)}createUndoManager(e){return new fV(e)}export(){return RU(this.doc)}import(e){kU(this.doc,e)}getInviteLink(){return"undefined"!=typeof location?`${location.origin}${location.pathname}#${this.id}`:`#${this.id}`}on(e,t){this._handlers.has(e)||this._handlers.set(e,new Set),this._handlers.get(e).add(t),"update"===e&&this.doc.on("update",t)}off(e,t){this._handlers.has(e)&&this._handlers.get(e).delete(t),"update"===e&&this.doc.off("update",t)}_emit(e,t){if(this._handlers.has(e))for(const s of this._handlers.get(e))try{s(t)}catch(e){console.error("Room event handler error:",e)}}sync(){this.provider.sync()}leave(){this._setState(fz.DISCONNECTED),this.awareness.stopTracking(),this.provider.destroy()}destroy(){this.leave(),this.doc.destroy(),this._handlers.clear()}}class mz{constructor(e){this.node=e,this.rooms=new Map}join(e,t={}){if(this.rooms.has(e))return this.rooms.get(e);const s=new gz(e,this.node,t);return this.rooms.set(e,s),s}leave(e){const t=this.rooms.get(e);t&&(t.leave(),this.rooms.delete(e))}get(e){return this.rooms.get(e)}has(e){return this.rooms.has(e)}all(){return Array.from(this.rooms.values())}leaveAll(){for(const e of this.rooms.values())e.leave();this.rooms.clear()}destroy(){for(const e of this.rooms.values())e.destroy();this.rooms.clear()}}class yz{constructor(e,t,s={}){this.docName=e,this.doc=t,this.storeName=s.storeName||"rooms",this._store=null,this._synced=!1,this._saveTimeout=null,this._saveDebounce=s.saveDebounce||1e3,this._onUpdate=this._onUpdate.bind(this),this._init()}async _init(){this._store=await Ht(),await this._load(),this.doc.on("update",this._onUpdate),this._synced=!0}get synced(){return this._synced}async _load(){try{const e=await this._store.get(this.storeName,this.docName);if(e?.state){const t=new Uint8Array(e.state);kU(this.doc,t,"persistence")}}catch(e){console.warn("Failed to load document:",e.message)}}_onUpdate(e,t){"persistence"!==t&&(this._saveTimeout&&clearTimeout(this._saveTimeout),this._saveTimeout=setTimeout(()=>{this._save()},this._saveDebounce))}async _save(){try{const e=RU(this.doc);await this._store.put(this.storeName,{id:this.docName,state:Array.from(e),lastSync:Date.now()})}catch(e){console.warn("Failed to save document:",e.message)}}async save(){return this._saveTimeout&&(clearTimeout(this._saveTimeout),this._saveTimeout=null),this._save()}async clear(){await this._store.delete(this.storeName,this.docName)}destroy(){this._saveTimeout&&clearTimeout(this._saveTimeout),this.doc.off("update",this._onUpdate),this._save()}}class bz{constructor(e={}){this._store=null,this.storeName="offline-queue",this._initialized=!1}async init(){this._initialized||(this._store=await Ht(),this._initialized=!0)}async add(e){return await this.init(),this._store.put(this.storeName,{...e,ts:Date.now(),retries:0})}async getAll(){return await this.init(),this._store.getAll(this.storeName)}async getPending(){await this.init();return(await this.getAll()).filter(e=>!e.synced)}async markSynced(e){await this.init();const t=await this._store.get(this.storeName,e);t&&await this._store.put(this.storeName,{...t,synced:!0,syncedAt:Date.now()})}async remove(e){await this.init(),await this._store.delete(this.storeName,e)}async clear(){await this.init(),await this._store.clear(this.storeName)}async incrementRetry(e){await this.init();const t=await this._store.get(this.storeName,e);t&&await this._store.put(this.storeName,{...t,retries:(t.retries||0)+1,lastRetry:Date.now()})}async size(){return await this.init(),this._store.count(this.storeName)}}class wz{constructor(e){this.room=e,this.persistence=null,this.offlineQueue=new bz,this._online="undefined"==typeof navigator||navigator.onLine,this._syncInterval=null}async start(e={}){this.persistence=new yz(this.room.id,this.room.doc,e),await this.offlineQueue.init(),"undefined"!=typeof window&&(window.addEventListener("online",this._onOnline.bind(this)),window.addEventListener("offline",this._onOffline.bind(this))),this._syncInterval=setInterval(()=>{this._checkSync()},3e4),this._online&&await this._processPending()}stop(){this.persistence&&this.persistence.destroy(),this._syncInterval&&clearInterval(this._syncInterval),"undefined"!=typeof window&&(window.removeEventListener("online",this._onOnline),window.removeEventListener("offline",this._onOffline))}async _onOnline(){this._online=!0,await this._processPending()}_onOffline(){this._online=!1}async _processPending(){const e=await this.offlineQueue.getPending();for(const t of e)try{await this.offlineQueue.markSynced(t.id)}catch(e){await this.offlineQueue.incrementRetry(t.id)}}async _checkSync(){this._online&&(this.room.sync(),this.persistence&&await this.persistence.save())}async save(){this.persistence&&await this.persistence.save()}get isOnline(){return this._online}async getPendingCount(){return this.offlineQueue.size()}}const vz={OFFER:"offer",ANSWER:"answer",CANDIDATE:"candidate",RENEGOTIATE:"renegotiate",CLOSE:"close"};class Sz{constructor(e,t={}){this.node=e,this.timeout=t.timeout||3e4,this._handlers=new Map,this._pending=new Map,this._messageHandler=null,this._started=!1}async start(){if(this._started)return;this._started=!0;const e=Je.SIGNAL_PREFIX+this.node.peerId;this.node.subscribe(e),this._messageHandler=e=>this._onMessage(e),this.node.on("message",this._messageHandler),console.log("ðŸ“¶ Signal manager started")}async stop(){if(!this._started)return;this._started=!1;const e=Je.SIGNAL_PREFIX+this.node.peerId;this.node.unsubscribe(e),this._messageHandler&&this.node.off("message",this._messageHandler),this._handlers.clear(),this._pending.clear(),console.log("ðŸ“¶ Signal manager stopped")}_onMessage(e){const t=Je.SIGNAL_PREFIX+this.node.peerId;if(e.detail.topic===t)try{const t=JSON.parse(Qe(e.detail.data));this._handleSignal(t)}catch(e){console.warn("Failed to parse signal message:",e.message)}}_handleSignal(e){const t=this._handlers.get(e.from);t?t(e):(this._pending.has(e.from)||this._pending.set(e.from,[]),this._pending.get(e.from).push(e))}async send(e,t){const s=Je.SIGNAL_PREFIX+e,r={type:t.type,from:this.node.peerId,to:e,sdp:t.sdp,candidate:t.candidate,ts:Date.now()};try{await this.node.publish(s,Ge(JSON.stringify(r)))}catch(e){throw console.warn("Failed to send signal:",e.message),e}}async sendOffer(e,t){await this.send(e,{type:vz.OFFER,sdp:t.sdp})}async sendAnswer(e,t){await this.send(e,{type:vz.ANSWER,sdp:t.sdp})}async sendCandidate(e,t){await this.send(e,{type:vz.CANDIDATE,candidate:t.toJSON()})}onSignal(e,t){this._handlers.set(e,t);const s=this._pending.get(e);if(s){this._pending.delete(e);for(const e of s)t(e)}}offSignal(e){this._handlers.delete(e),this._pending.delete(e)}waitForSignal(e,t){return new Promise((s,r)=>{const n=setTimeout(()=>{this.offSignal(e),r(new Error("Signal timeout"))},this.timeout);this.onSignal(e,r=>{t&&r.type!==t||(clearTimeout(n),this.offSignal(e),s(r))})})}}class Ez{constructor(e,t,s={}){this.signal=e,this.peerId=t,this.isInitiator=s.isInitiator||!1,this.pc=null,this.dataChannel=null,this._handlers=new Map}createConnection(){return this.pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]}),this.pc.onicecandidate=e=>{e.candidate&&this.signal.sendCandidate(this.peerId,e.candidate)},this.pc.onconnectionstatechange=()=>{this._emit("connectionState",this.pc.connectionState)},this.pc.ondatachannel=e=>{this.dataChannel=e.channel,this._setupDataChannel()},this.signal.onSignal(this.peerId,e=>this._handleSignal(e)),this.pc}async _handleSignal(e){try{switch(e.type){case vz.OFFER:await this.pc.setRemoteDescription({type:"offer",sdp:e.sdp});const t=await this.pc.createAnswer();await this.pc.setLocalDescription(t),await this.signal.sendAnswer(this.peerId,t);break;case vz.ANSWER:await this.pc.setRemoteDescription({type:"answer",sdp:e.sdp});break;case vz.CANDIDATE:e.candidate&&await this.pc.addIceCandidate(new RTCIceCandidate(e.candidate))}}catch(e){console.error("Signal handling error:",e)}}async negotiate(){if(!this.isInitiator)return;this.dataChannel=this.pc.createDataChannel("konomi",{ordered:!0}),this._setupDataChannel();const e=await this.pc.createOffer();await this.pc.setLocalDescription(e),await this.signal.sendOffer(this.peerId,e)}_setupDataChannel(){this.dataChannel&&(this.dataChannel.onopen=()=>{this._emit("open")},this.dataChannel.onclose=()=>{this._emit("close")},this.dataChannel.onmessage=e=>{this._emit("message",e.data)},this.dataChannel.onerror=e=>{this._emit("error",e)})}send(e){"open"===this.dataChannel?.readyState&&this.dataChannel.send(e)}close(){this.signal.offSignal(this.peerId),this.dataChannel&&this.dataChannel.close(),this.pc&&this.pc.close()}on(e,t){this._handlers.has(e)||this._handlers.set(e,new Set),this._handlers.get(e).add(t)}_emit(e,t){if(this._handlers.has(e))for(const s of this._handlers.get(e))s(t)}}const Dz={STATE_VECTOR:0,STATE_DIFF:1,UPDATE:2,REQUEST_FULL:3};function _z(e){return Ge(JSON.stringify({type:e.type,data:e.data?Array.from(e.data):null}))}function Tz(e){const t=JSON.parse(Qe(e));return t.data&&(t.data=new Uint8Array(t.data)),t}class Iz{constructor(e,t){this.node=e,this.doc=t,this.protocol=Ye.SYNC,this._started=!1}async start(){this._started||(this._started=!0,await this.node.handle(this.protocol,this._handleStream.bind(this)),console.log("ðŸ”„ Sync protocol started"))}async stop(){this._started&&(this._started=!1,await this.node.unhandle(this.protocol),console.log("ðŸ”„ Sync protocol stopped"))}async _handleStream({stream:e}){try{const t=[];for await(const s of e.source)t.push(s);const s=new Uint8Array(t.reduce((e,t)=>e+t.length,0));let r=0;for(const e of t)s.set(e,r),r+=e.length;const n=Tz(s),i=this._processMessage(n);if(i){const t=_z(i);await e.sink([t])}}catch(e){console.warn("Sync stream error:",e.message)}finally{e.close()}}_processMessage(e){switch(e.type){case Dz.STATE_VECTOR:const t=RU(this.doc,e.data);return{type:Dz.STATE_DIFF,data:t};case Dz.STATE_DIFF:case Dz.UPDATE:return kU(this.doc,e.data,"sync-protocol"),null;case Dz.REQUEST_FULL:return{type:Dz.STATE_DIFF,data:RU(this.doc)};default:return null}}async syncWithPeer(e){try{const t=await this.node.dialProtocol(e,this.protocol),s=BU(this.doc),r=_z({type:Dz.STATE_VECTOR,data:s});await t.sink([r]);const n=[];for await(const e of t.source)n.push(e);if(n.length>0){const e=new Uint8Array(n.reduce((e,t)=>e+t.length,0));let t=0;for(const s of n)e.set(s,t),t+=s.length;const s=Tz(e);s.type===Dz.STATE_DIFF&&kU(this.doc,s.data,"sync-protocol")}return t.close(),!0}catch(t){return console.warn(`Sync with ${e} failed:`,t.message),!1}}async sendUpdate(e,t){try{const s=await this.node.dialProtocol(e,this.protocol),r=_z({type:Dz.UPDATE,data:t});return await s.sink([r]),s.close(),!0}catch(t){return console.warn(`Send update to ${e} failed:`,t.message),!1}}async requestFullState(e){try{const t=await this.node.dialProtocol(e,this.protocol),s=_z({type:Dz.REQUEST_FULL,data:null});await t.sink([s]);const r=[];for await(const e of t.source)r.push(e);if(r.length>0){const e=new Uint8Array(r.reduce((e,t)=>e+t.length,0));let t=0;for(const s of r)e.set(s,t),t+=s.length;const s=Tz(e);s.type===Dz.STATE_DIFF&&kU(this.doc,s.data,"sync-protocol")}return t.close(),!0}catch(t){return console.warn(`Request full state from ${e} failed:`,t.message),!1}}}const Cz={compare(e,t){const s=MU(e),r=MU(t),n=[],i=[];for(const[e,t]of s){const s=r.get(e)||0;t>s&&n.push({client:e,diff:t-s})}for(const[e,t]of r){const r=s.get(e)||0;t>r&&i.push({client:e,diff:t-r})}return{ahead:n,behind:i,equal:0===n.length&&0===i.length}},merge(e){const t=new Map;for(const s of e){const e=MU(s);for(const[s,r]of e){const e=t.get(s)||0;t.set(s,Math.max(e,r))}}return t}},Pz={REQUEST:0,METADATA:1,CHUNK:2,ACK:3,COMPLETE:4,ERROR:5,CANCEL:6},xz={PENDING:"pending",TRANSFERRING:"transferring",COMPLETE:"complete",ERROR:"error",CANCELLED:"cancelled"};async function Az(e){const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(e=>e.toString(16).padStart(2,"0")).join("")}class kz{constructor(e,t,s={}){this.node=e,this.store=t,this.protocol=Ye.BLOB,this.chunkSize=s.chunkSize||65536,this._transfers=new Map,this._handlers=new Map,this._started=!1}async start(){this._started||(this._started=!0,await this.node.handle(this.protocol,this._handleStream.bind(this)),console.log("ðŸ“¦ Blob protocol started"))}async stop(){if(this._started){this._started=!1,await this.node.unhandle(this.protocol);for(const[,e]of this._transfers)e.state=xz.CANCELLED;this._transfers.clear(),console.log("ðŸ“¦ Blob protocol stopped")}}async _handleStream({stream:e,connection:t}){const s=t.remotePeer.toString();try{const t=[];for await(const s of e.source){t.push(s);break}if(0===t.length)return void e.close();const r=JSON.parse(Qe(t[0]));switch(r.type){case Pz.REQUEST:await this._handleRequest(e,r,s);break;case Pz.METADATA:await this._handleMetadata(e,r,s);break;default:e.close()}}catch(t){console.warn("Blob stream error:",t.message),e.close()}}async _handleRequest(e,t,s){const{hash:r}=t,n=await this.store.get(r);if(!n)return await e.sink([Ge(JSON.stringify({type:Pz.ERROR,error:"Blob not found"}))]),void e.close();const i={type:Pz.METADATA,hash:r,size:n.length,chunks:Math.ceil(n.length/this.chunkSize)};await e.sink([Ge(JSON.stringify(i))]);for(let t=0;t<i.chunks;t++){const s=t*this.chunkSize,r=Math.min(s+this.chunkSize,n.length),i=n.slice(s,r),o={type:Pz.CHUNK,index:t,data:Array.from(i)};await e.sink([Ge(JSON.stringify(o))])}await e.sink([Ge(JSON.stringify({type:Pz.COMPLETE,hash:r}))]),e.close()}async _handleMetadata(e,t,s){e.close()}async requestBlob(e,t,s){const r=`${e}:${t}`,n={id:r,hash:t,peerId:e,state:xz.PENDING,progress:0,chunks:[],startTime:Date.now()};this._transfers.set(r,n);try{const i=await this.node.dialProtocol(e,this.protocol),o={type:Pz.REQUEST,hash:t};await i.sink([Ge(JSON.stringify(o))]),n.state=xz.TRANSFERRING;let a=null;const c=[];for await(const e of i.source){const o=JSON.parse(Qe(e));switch(o.type){case Pz.ERROR:throw new Error(o.error);case Pz.METADATA:a=o,c.length=o.chunks;break;case Pz.CHUNK:c[o.index]=new Uint8Array(o.data),n.progress=(o.index+1)/a.chunks,s&&s(n.progress);break;case Pz.COMPLETE:const e=c.reduce((e,t)=>e+t.length,0),l=new Uint8Array(e);let h=0;for(const e of c)l.set(e,h),h+=e.length;if(await Az(l)!==t)throw new Error("Hash mismatch");return await this.store.put(l),n.state=xz.COMPLETE,n.endTime=Date.now(),i.close(),this._transfers.delete(r),l}}throw new Error("Transfer incomplete")}catch(e){throw n.state=xz.ERROR,n.error=e.message,this._transfers.delete(r),e}}async share(e,t={}){const s=await Az(e);return await this.store.put(e),s}getTransfer(e){return this._transfers.get(e)}getActiveTransfers(){return Array.from(this._transfers.values()).filter(e=>e.state===xz.TRANSFERRING)}cancelTransfer(e){const t=this._transfers.get(e);t&&(t.state=xz.CANCELLED,this._transfers.delete(e))}}class Nz{constructor(e,t=65536){this.file=e,this.chunkSize=t,this.offset=0}get totalChunks(){return Math.ceil(this.file.size/this.chunkSize)}async next(){if(this.offset>=this.file.size)return{done:!0};const e=this.file.slice(this.offset,this.offset+this.chunkSize),t=await e.arrayBuffer(),s=new Uint8Array(t),r=Math.floor(this.offset/this.chunkSize);return this.offset+=this.chunkSize,{done:!1,value:s,index:r}}reset(){this.offset=0}[Symbol.asyncIterator](){return{next:()=>this.next()}}}const Rz={REQUEST:"request",RESPONSE:"response",ERROR:"error",NOTIFICATION:"notification"};class Mz extends Error{constructor(e,t,s=null){super(t),this.code=e,this.data=s,this.name="RPCError"}toJSON(){return{code:this.code,message:this.message,data:this.data}}}const Lz={PARSE_ERROR:-32700,INVALID_REQUEST:-32600,METHOD_NOT_FOUND:-32601,INVALID_PARAMS:-32602,INTERNAL_ERROR:-32603,TIMEOUT:-32e3,CANCELLED:-32001};class Oz{constructor(e,t={}){this.node=e,this.protocol=Ye.RPC,this.timeout=t.timeout||3e4,this._methods=new Map,this._pending=new Map,this._started=!1}async start(){this._started||(this._started=!0,await this.node.handle(this.protocol,this._handleStream.bind(this)),console.log("ðŸ“ž RPC protocol started"))}async stop(){if(this._started){this._started=!1,await this.node.unhandle(this.protocol);for(const[,e]of this._pending)clearTimeout(e.timeout),e.reject(new Mz(Lz.CANCELLED,"RPC stopped"));this._pending.clear(),this._methods.clear(),console.log("ðŸ“ž RPC protocol stopped")}}register(e,t){this._methods.set(e,t)}unregister(e){this._methods.delete(e)}async _handleStream({stream:e,connection:t}){const s=t.remotePeer.toString();try{const t=[];for await(const s of e.source)t.push(s);if(0===t.length)return void e.close();const r=new Uint8Array(t.reduce((e,t)=>e+t.length,0));let n=0;for(const e of t)r.set(e,n),n+=e.length;const i=JSON.parse(Qe(r));if(i.type===Rz.REQUEST){const t=await this._handleRequest(i,{peerId:s});await e.sink([Ge(JSON.stringify(t))])}else i.type===Rz.NOTIFICATION?await this._handleNotification(i,{peerId:s}):i.type!==Rz.RESPONSE&&i.type!==Rz.ERROR||this._handleResponse(i);e.close()}catch(t){console.warn("RPC stream error:",t.message);try{const s={type:Rz.ERROR,error:{code:Lz.INTERNAL_ERROR,message:t.message}};await e.sink([Ge(JSON.stringify(s))])}catch{}e.close()}}async _handleRequest(e,t){const{id:s,method:r,params:n}=e,i=this._methods.get(r);if(!i)return{type:Rz.ERROR,id:s,error:{code:Lz.METHOD_NOT_FOUND,message:`Method not found: ${r}`}};try{const e=await i(n,t);return{type:Rz.RESPONSE,id:s,result:e}}catch(e){return{type:Rz.ERROR,id:s,error:e instanceof Mz?e.toJSON():{code:Lz.INTERNAL_ERROR,message:e.message}}}}async _handleNotification(e,t){const{method:s,params:r}=e,n=this._methods.get(s);if(n)try{await n(r,t)}catch(e){console.warn(`Notification handler error for ${s}:`,e.message)}}_handleResponse(e){const{id:t,result:s,error:r}=e,n=this._pending.get(t);n&&(clearTimeout(n.timeout),this._pending.delete(t),r?n.reject(new Mz(r.code,r.message,r.data)):n.resolve(s))}async call(e,t,s=null){const r=bt(gt(8)),n={type:Rz.REQUEST,id:r,method:t,params:s};return new Promise(async(t,s)=>{const i=setTimeout(()=>{this._pending.delete(r),s(new Mz(Lz.TIMEOUT,"Request timeout"))},this.timeout);this._pending.set(r,{resolve:t,reject:s,timeout:i});try{const t=await this.node.dialProtocol(e,this.protocol);await t.sink([Ge(JSON.stringify(n))]);const s=[];for await(const e of t.source)s.push(e);if(t.close(),s.length>0){const e=new Uint8Array(s.reduce((e,t)=>e+t.length,0));let t=0;for(const r of s)e.set(r,t),t+=r.length;const n=JSON.parse(Qe(e));this._handleResponse({...n,id:r})}}catch(e){clearTimeout(i),this._pending.delete(r),s(new Mz(Lz.INTERNAL_ERROR,e.message))}})}async notify(e,t,s=null){const r={type:Rz.NOTIFICATION,method:t,params:s};try{const t=await this.node.dialProtocol(e,this.protocol);await t.sink([Ge(JSON.stringify(r))]),t.close()}catch(t){console.warn(`Failed to send notification to ${e}:`,t.message)}}async broadcast(e,t,s=null){await Promise.allSettled(e.map(e=>this.notify(e,t,s)))}async callAll(e,t=null){const s=this.node.getConnectedPeers(),r=new Map;return await Promise.allSettled(s.map(async s=>{try{const n=await this.call(s,e,t);r.set(s,{success:!0,result:n})}catch(e){r.set(s,{success:!1,error:e})}})),r}}class Bz{constructor(e,t){this.rpc=e,this.peerId=t}async call(e,t){return this.rpc.call(this.peerId,e,t)}async notify(e,t){return this.rpc.notify(this.peerId,e,t)}}const Uz={L4:{id:4,name:"Business",scope:"Planning, ERP",time:"days-months"},L3:{id:3,name:"MOM",scope:"MES, Execution",time:"shifts-days"},L2:{id:2,name:"Control",scope:"Supervision",time:"sec-hours"},L1:{id:1,name:"Sensing",scope:"Direct Control",time:"ms-sec"},L0:{id:0,name:"Process",scope:"Physical",time:"continuous"}},Vz={STOPPED:"stopped",IDLE:"idle",STARTING:"starting",EXECUTE:"execute",COMPLETING:"completing",COMPLETE:"complete",RESETTING:"resetting",HOLDING:"holding",HELD:"held",UNHOLDING:"unholding",STOPPING:"stopping",ABORTING:"aborting",ABORTED:"aborted",CLEARING:"clearing"},Fz={[Vz.STOPPED]:{start:Vz.IDLE,abort:Vz.ABORTING},[Vz.IDLE]:{start:Vz.STARTING,stop:Vz.STOPPING,abort:Vz.ABORTING},[Vz.STARTING]:{_auto:Vz.EXECUTE,hold:Vz.HOLDING,abort:Vz.ABORTING},[Vz.EXECUTE]:{complete:Vz.COMPLETING,hold:Vz.HOLDING,stop:Vz.STOPPING,abort:Vz.ABORTING},[Vz.COMPLETING]:{_auto:Vz.COMPLETE,abort:Vz.ABORTING},[Vz.COMPLETE]:{reset:Vz.RESETTING,abort:Vz.ABORTING},[Vz.RESETTING]:{_auto:Vz.IDLE,abort:Vz.ABORTING},[Vz.HOLDING]:{_auto:Vz.HELD,abort:Vz.ABORTING},[Vz.HELD]:{unhold:Vz.UNHOLDING,abort:Vz.ABORTING},[Vz.UNHOLDING]:{_auto:Vz.EXECUTE,abort:Vz.ABORTING},[Vz.STOPPING]:{_auto:Vz.STOPPED,abort:Vz.ABORTING},[Vz.ABORTING]:{_auto:Vz.ABORTED},[Vz.ABORTED]:{clear:Vz.CLEARING},[Vz.CLEARING]:{_auto:Vz.STOPPED}},zz={PRODUCTION:"production",MAINTENANCE:"maintenance",MANUAL:"manual",AUTOMATIC:"automatic",SEMIAUTO:"semiauto"},$z={BIRTH:"BIRTH",DEATH:"DEATH",DATA:"DATA",CMD:"CMD",STATE:"STATE",ALARM:"ALARM"},qz={P1:{id:1,name:"Emergency",response:"<1min",color:"#CC0000"},P2:{id:2,name:"High",response:"<10min",color:"#FF6600"},P3:{id:3,name:"Medium",response:"<1hr",color:"#FFCC00"},P4:{id:4,name:"Low",response:"Shift",color:"#00CCCC"}},Wz={GOOD:192,BAD:0,UNCERTAIN:64};function Kz(e,t=Wz.GOOD,s=null){return{v:e,q:t,t:Date.now(),unit:s}}class jz{constructor(e){this.id=e.id||crypto.randomUUID(),this.name=e.name,this.path=e.path||this.name,this.level=e.level||Uz.L2,this.parent=e.parent||null,this.children=new Map,this.state=Vz.STOPPED,this.mode=zz.AUTOMATIC,this.metrics=new Map,this.alarms=new Map,this.listeners=new Map,this.props=e.props||{}}getPath(){return this.parent?`${this.parent.getPath()}/${this.name}`:this.name}addChild(e){return e.parent=this,e.path=`${this.getPath()}/${e.name}`,this.children.set(e.name,e),e}getChild(e){return this.children.get(e)}navigate(e){const t=e.split("/").filter(e=>e);let s=this;for(const e of t)if(s=s.getChild(e),!s)return null;return s}setMetric(e,t,s=Wz.GOOD,r=null){const n=Kz(t,s,r);return this.metrics.set(e,n),this._emit($z.DATA,{metric:e,...n}),n}getMetric(e){return this.metrics.get(e)}transition(e){const t=Fz[this.state];if(!t)return!1;const s=t[e];if(!s)return!1;const r=this.state;return this.state=s,this._emit($z.STATE,{from:r,to:s,command:e}),this._checkAutoTransition(),!0}_checkAutoTransition(){const e=Fz[this.state];e?._auto&&setTimeout(()=>{const t=e._auto,s=this.state;this.state=t,this._emit($z.STATE,{from:s,to:t,command:"_auto"}),this._checkAutoTransition()},100)}raiseAlarm(e,t,s="P3"){const r={id:e,message:t,priority:qz[s],state:"UNACK",timestamp:Date.now(),ackTime:null,ackUser:null};return this.alarms.set(e,r),this._emit($z.ALARM,r),r}ackAlarm(e,t="system"){const s=this.alarms.get(e);return s&&(s.state="ACKED",s.ackTime=Date.now(),s.ackUser=t,this._emit($z.ALARM,s)),s}clearAlarm(e){const t=this.alarms.get(e);t&&(t.state="CLEAR",this.alarms.delete(e),this._emit($z.ALARM,{...t,state:"CLEAR"}))}on(e,t){return this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t),()=>this.listeners.get(e).delete(t)}_emit(e,t){const s={type:e,source:this.getPath(),timestamp:Date.now(),data:t},r=this.listeners.get(e);if(r)for(const e of r)try{e(s)}catch(e){console.error(e)}this.parent&&this.parent._emit(e,t)}toBirth(){return{type:$z.BIRTH,id:this.id,name:this.name,path:this.getPath(),level:this.level,state:this.state,mode:this.mode,metrics:Object.fromEntries(this.metrics),alarms:Object.fromEntries(this.alarms),children:Array.from(this.children.keys()),props:this.props,timestamp:Date.now()}}toJSON(){return{id:this.id,name:this.name,path:this.getPath(),level:this.level,state:this.state,mode:this.mode,children:Array.from(this.children.values()).map(e=>e.toJSON())}}}class Hz extends jz{constructor(e,t={}){super({name:e,level:Uz.L4,props:t})}addSite(e,t={}){return this.addChild(new Gz(e,t))}}class Gz extends jz{constructor(e,t={}){super({name:e,level:Uz.L4,props:t})}addArea(e,t={}){return this.addChild(new Qz(e,t))}}class Qz extends jz{constructor(e,t={}){super({name:e,level:Uz.L3,props:t})}addWorkCenter(e,t={}){return this.addChild(new Xz(e,t))}}class Xz extends jz{constructor(e,t={}){super({name:e,level:Uz.L2,props:t})}addWorkUnit(e,t={}){return this.addChild(new Yz(e,t))}}class Yz extends jz{constructor(e,t={}){super({name:e,level:Uz.L2,props:t})}addEquipment(e,t,s={}){return this.addChild(new Jz(e,t,s))}}class Jz extends jz{constructor(e,t,s={}){super({name:e,level:Uz.L1,props:s}),this.type=t}toJSON(){return{...super.toJSON(),type:this.type}}}function Zz(){const e=new Hz("Acme Corp"),t=e.addSite("Plant1").addArea("Packaging").addWorkCenter("Line1"),s=t.addWorkUnit("Filler");s.addEquipment("InfeedConveyor","Conveyor"),s.addEquipment("FillerHead","Filler"),s.addEquipment("OutfeedConveyor","Conveyor"),s.addEquipment("LevelSensor","Sensor");const r=t.addWorkUnit("Capper");return r.addEquipment("CapperHead","Capper"),r.addEquipment("TorqueSensor","Sensor"),e}class e${constructor(e={}){this.id=e.id||"sandbox-"+Math.random().toString(36).slice(2,10),this.timeout=e.timeout||5e3,this.maxMemory=e.maxMemory||52428800,this.worker=null,this.pending=new Map,this.msgId=0,this.ready=!1,this.onMessage=e.onMessage||(()=>{})}async start(){if(this.worker)return;const e=new Blob(["\n\"use strict\";\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PHASE 1: LOCKDOWN - Remove dangerous globals IMMEDIATELY\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Block network access\nself.fetch = undefined;\nself.XMLHttpRequest = undefined;\nself.WebSocket = undefined;\nself.EventSource = undefined;\nself.Request = undefined;\nself.Response = undefined;\n\n// Block dynamic code execution\nself.eval = undefined;\nself.Function = (function() {\n  const F = Function;\n  return function() { throw new Error('Function constructor blocked'); };\n})();\n\n// Block importing external scripts\nself.importScripts = undefined;\n\n// Block timers that could be used for timing attacks (keep basic ones)\n// self.setInterval - keep for agent loops\n// self.setTimeout - keep for delays\n\n// Block storage\nself.indexedDB = undefined;\nself.caches = undefined;\n\n// Block other potentially dangerous APIs\nself.Notification = undefined;\nself.BroadcastChannel = undefined; // Only parent controls channels\nself.SharedArrayBuffer = undefined;\nself.Atomics = undefined;\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PHASE 2: SANDBOX RUNTIME\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst sandbox = {\n  id: null,\n  started: Date.now(),\n  messageCount: 0,\n  memory: {},  // sandboxed key-value store\n};\n\n// Allowed operations the sandbox can perform\nconst operations = {\n  // Echo for testing\n  ping: (payload) => ({ pong: payload, ts: Date.now() }),\n\n  // Sandboxed memory operations\n  get: (key) => sandbox.memory[key],\n  set: ({ key, value }) => { sandbox.memory[key] = value; return true; },\n  del: (key) => { delete sandbox.memory[key]; return true; },\n  keys: () => Object.keys(sandbox.memory),\n\n  // Computation (safe)\n  compute: (expr) => {\n    // Only allow basic math expressions, no function calls\n    if (!/^[\\d\\s+\\-*/().]+$/.test(expr)) {\n      throw new Error('Invalid expression');\n    }\n    // Still risky but contained - real impl would use math parser\n    return eval(expr); // This eval is on validated math only\n  },\n\n  // JSON operations\n  parse: (str) => JSON.parse(str),\n  stringify: (obj) => JSON.stringify(obj),\n\n  // String operations\n  split: ({ str, sep }) => str.split(sep),\n  join: ({ arr, sep }) => arr.join(sep),\n  match: ({ str, pattern }) => str.match(new RegExp(pattern)),\n  replace: ({ str, pattern, replacement }) => str.replace(new RegExp(pattern, 'g'), replacement),\n\n  // Array operations\n  map: ({ arr, fn }) => arr.map(fn), // fn must be serialized\n  filter: ({ arr, fn }) => arr.filter(fn),\n  reduce: ({ arr, fn, init }) => arr.reduce(fn, init),\n  sort: (arr) => [...arr].sort(),\n\n  // Stats\n  stats: () => ({\n    id: sandbox.id,\n    uptime: Date.now() - sandbox.started,\n    messages: sandbox.messageCount,\n    memoryKeys: Object.keys(sandbox.memory).length,\n  }),\n};\n\n// Re-enable eval ONLY for compute operation (limited)\nconst safeEval = eval;\n\n// Message handler\nself.onmessage = (e) => {\n  sandbox.messageCount++;\n  const { id, op, payload } = e.data;\n\n  // Init message sets sandbox ID\n  if (op === '__init__') {\n    sandbox.id = payload.id;\n    self.postMessage({ id, ok: true, result: { ready: true, id: sandbox.id } });\n    return;\n  }\n\n  // Kill message terminates worker\n  if (op === '__kill__') {\n    self.postMessage({ id, ok: true, result: { killed: true } });\n    self.close();\n    return;\n  }\n\n  // Execute operation\n  try {\n    if (!operations[op]) {\n      throw new Error('Unknown operation: ' + op);\n    }\n    const result = operations[op](payload);\n    self.postMessage({ id, ok: true, result });\n  } catch (err) {\n    self.postMessage({ id, ok: false, error: err.message });\n  }\n};\n\n// Signal ready\nself.postMessage({ id: '__boot__', ok: true, result: { booted: true } });\n"],{type:"application/javascript"}),t=URL.createObjectURL(e);this.worker=new Worker(t),URL.revokeObjectURL(t),this.worker.onmessage=e=>{const{id:t,ok:s,result:r,error:n}=e.data;if("__boot__"===t)return;const i=this.pending.get(t);i&&(this.pending.delete(t),s?i.resolve(r):i.reject(new Error(n))),this.onMessage({id:t,ok:s,result:r,error:n})},this.worker.onerror=e=>{console.error("Sandbox error:",e.message)},await this._send("__init__",{id:this.id}),this.ready=!0}_send(e,t){return new Promise((s,r)=>{const n=++this.msgId,i=setTimeout(()=>{this.pending.delete(n),r(new Error(`Sandbox timeout: ${e}`))},this.timeout);this.pending.set(n,{resolve:e=>{clearTimeout(i),s(e)},reject:e=>{clearTimeout(i),r(e)}}),this.worker.postMessage({id:n,op:e,payload:t})})}async exec(e,t){if(!this.ready)throw new Error("Sandbox not started");return this._send(e,t)}async ping(e){return this.exec("ping",e)}async get(e){return this.exec("get",e)}async set(e,t){return this.exec("set",{key:e,value:t})}async del(e){return this.exec("del",e)}async keys(){return this.exec("keys")}async compute(e){return this.exec("compute",e)}async stats(){return this.exec("stats")}async stop(){if(this.worker){try{await this._send("__kill__",{})}catch(e){}this.worker.terminate(),this.worker=null,this.ready=!1}}}function t$(e,t,s,r){return`${e}/${t}/${s}/${r}`.replace(/\/+/g,"/")}function s$(e){const t=e.split("/");return{namespace:t[0],group:t[1],msgType:t[2],path:t.slice(3).join("/")}}class r${constructor(e,t={}){this.node=e,this.namespace=t.namespace||"kp2p",this.group=t.group||"default",this.peers=new Map,this.subscriptions=new Map,this.protocol=null,this.sandbox=null,this.dataChannels=new Map,this.birthSent=!1}getTopic(e){return t$(this.namespace,this.group,e,this.node.getPath())}async start(){return this.sandbox=new e$({id:`mesh-${this.node.id}`}),await this.sandbox.start(),this.protocol=new oM(this.node.id,{onSend:e=>this._broadcast(e)}),this._setupHandlers(),this.node.on($z.DATA,e=>this._onNodeData(e)),this.node.on($z.STATE,e=>this._onNodeState(e)),this.node.on($z.ALARM,e=>this._onNodeAlarm(e)),this}_setupHandlers(){this.protocol.on("data",async(e,t)=>{const{path:s,metric:r,value:n}=e;s===this.node.getPath()&&this.node.setMetric(r,n.v,n.q,n.unit),this._notifySubscribers($z.DATA,e)}),this.protocol.on("cmd",async(e,t)=>{const{path:s,command:r,params:n}=e;if(s===this.node.getPath())return this._executeCommand(r,n);const i=this.node.navigate(s);return i?this._executeCommand(r,n,i):{error:"Node not found"}}),this.protocol.on("state",async(e,t)=>{this._notifySubscribers($z.STATE,e)}),this.protocol.on("birth",async(e,t)=>this.node.toBirth()),this.protocol.on("subscribe",async(e,t)=>{const{topic:s}=e;return this.subscriptions.has(s)||this.subscriptions.set(s,new Set),this.subscriptions.get(s).add(t.from),{subscribed:!0,topic:s}})}async _executeCommand(e,t,s=null){const r=s||this.node;switch(e){case"start":case"stop":case"reset":case"hold":case"unhold":case"abort":case"clear":return{success:r.transition(e),state:r.state};case"setMode":return r.mode=t.mode,{success:!0,mode:r.mode};case"setMetric":return r.setMetric(t.name,t.value,t.quality,t.unit),{success:!0};case"getMetric":return r.getMetric(t.name);case"getState":return{state:r.state,mode:r.mode};case"getBirth":return r.toBirth();default:return"compute"===e?await this.sandbox.compute(t.expr):{error:`Unknown command: ${e}`}}}_onNodeData(e){this.protocol.emit("data",{path:e.source,...e.data})}_onNodeState(e){this.protocol.emit("state",{path:e.source,...e.data})}_onNodeAlarm(e){this.protocol.emit("alarm",{path:e.source,...e.data})}_notifySubscribers(e,t){const s=t$(this.namespace,this.group,e,t.path),r=this.subscriptions.get(s);if(r)for(const e of r){const r=this.dataChannels.get(e);"open"===r?.readyState&&r.send(JSON.stringify({type:sM.EVENT,topic:s,data:t}))}}addPeer(e,t){this.peers.set(e,{id:e,channel:t}),this.dataChannels.set(e,t),t.onmessage=e=>{try{const t=JSON.parse(e.data);this.protocol.receive(t)}catch(e){console.error("Failed to parse message:",e)}},t.onclose=()=>{this.peers.delete(e),this.dataChannels.delete(e)},this.birthSent||(this._sendBirth(),this.birthSent=!0)}_sendBirth(){this.protocol.emit("birth",this.node.toBirth())}_broadcast(e){const t=JSON.stringify(e);for(const[e,s]of this.dataChannels)"open"===s.readyState&&s.send(t)}async subscribe(e,t){return this.protocol.call(e,"subscribe",{topic:t})}async sendCommand(e,t,s,r={}){return this.protocol.call(e,"cmd",{path:t,command:s,params:r})}async requestBirth(e){return this.protocol.call(e,"birth",{})}async stop(){this.protocol.emit("death",{path:this.node.getPath()});for(const[e,t]of this.dataChannels)t.close();this.peers.clear(),this.dataChannels.clear(),await(this.sandbox?.stop())}}class n${constructor(e={}){this.namespace=e.namespace||"kp2p",this.group=e.group||"default",this.nodes=new Map}async addNode(e){const t=new r$(e,{namespace:this.namespace,group:this.group});return await t.start(),this.nodes.set(e.id,t),t}getNode(e){return this.nodes.get(e)}connectNodes(e,t,s,r){const n=this.nodes.get(e),i=this.nodes.get(t);n&&i&&(n.addPeer(t,s),i.addPeer(e,r))}async stopAll(){for(const[e,t]of this.nodes)await t.stop();this.nodes.clear()}}const i$="konomi-p2p-status",o$=`\n  #${i$} {\n    position: fixed;\n    bottom: 16px;\n    right: 16px;\n    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);\n    color: #eee;\n    padding: 12px 16px;\n    border-radius: 12px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;\n    font-size: 13px;\n    z-index: 99999;\n    border: 1px solid rgba(79, 172, 254, 0.3);\n    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);\n    min-width: 180px;\n    transition: all 0.3s ease;\n    user-select: none;\n  }\n\n  #${i$}:hover {\n    transform: translateY(-2px);\n    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.4);\n  }\n\n  #${i$} .header {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    margin-bottom: 8px;\n    padding-bottom: 8px;\n    border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n  }\n\n  #${i$} .status-dot {\n    width: 10px;\n    height: 10px;\n    border-radius: 50%;\n    animation: pulse 2s infinite;\n  }\n\n  #${i$} .status-dot.online {\n    background: #00ff88;\n    box-shadow: 0 0 8px #00ff88;\n  }\n\n  #${i$} .status-dot.connecting {\n    background: #ffd93d;\n    box-shadow: 0 0 8px #ffd93d;\n  }\n\n  #${i$} .status-dot.offline {\n    background: #ff6b6b;\n    box-shadow: 0 0 8px #ff6b6b;\n    animation: none;\n  }\n\n  @keyframes pulse {\n    0%, 100% { opacity: 1; }\n    50% { opacity: 0.5; }\n  }\n\n  #${i$} .title {\n    font-weight: 600;\n    color: #4facfe;\n  }\n\n  #${i$} .stats {\n    display: flex;\n    flex-direction: column;\n    gap: 6px;\n  }\n\n  #${i$} .stat-row {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n  }\n\n  #${i$} .stat-label {\n    color: #888;\n    font-size: 11px;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n  }\n\n  #${i$} .stat-value {\n    color: #fff;\n    font-weight: 500;\n  }\n\n  #${i$} .stat-value.peers {\n    color: #e94560;\n  }\n\n  #${i$} .stat-value.users {\n    color: #4ecdc4;\n  }\n\n  #${i$} .actions {\n    margin-top: 10px;\n    padding-top: 10px;\n    border-top: 1px solid rgba(255, 255, 255, 0.1);\n    display: flex;\n    gap: 8px;\n  }\n\n  #${i$} .btn {\n    flex: 1;\n    padding: 6px 12px;\n    border: none;\n    border-radius: 6px;\n    background: rgba(79, 172, 254, 0.2);\n    color: #4facfe;\n    font-size: 11px;\n    cursor: pointer;\n    transition: all 0.2s ease;\n  }\n\n  #${i$} .btn:hover {\n    background: rgba(79, 172, 254, 0.3);\n  }\n\n  #${i$} .btn:active {\n    transform: scale(0.95);\n  }\n\n  #${i$} .minimized {\n    cursor: pointer;\n  }\n\n  #${i$}.mini {\n    min-width: auto;\n    padding: 8px 12px;\n  }\n\n  #${i$}.mini .stats,\n  #${i$}.mini .actions {\n    display: none;\n  }\n\n  #${i$} .user-list {\n    margin-top: 8px;\n    padding-top: 8px;\n    border-top: 1px solid rgba(255, 255, 255, 0.1);\n  }\n\n  #${i$} .user-item {\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    font-size: 11px;\n    margin-bottom: 4px;\n  }\n\n  #${i$} .user-dot {\n    width: 8px;\n    height: 8px;\n    border-radius: 50%;\n  }\n\n  #${i$} .user-name {\n    color: #ccc;\n  }\n`;function a$(e){c$();const t=document.createElement("style");t.id=`${i$}-styles`,t.textContent=o$,document.head.appendChild(t);const s=document.createElement("div");s.id=i$,s.innerHTML='\n    <div class="header">\n      <div class="status-dot online"></div>\n      <span class="title">Konomi P2P</span>\n    </div>\n    <div class="stats">\n      <div class="stat-row">\n        <span class="stat-label">Peers</span>\n        <span class="stat-value peers">0</span>\n      </div>\n      <div class="stat-row">\n        <span class="stat-label">Users</span>\n        <span class="stat-value users">0</span>\n      </div>\n      <div class="stat-row">\n        <span class="stat-label">Room</span>\n        <span class="stat-value room" style="font-size: 10px; max-width: 100px; overflow: hidden; text-overflow: ellipsis;"></span>\n      </div>\n    </div>\n    <div class="user-list"></div>\n    <div class="actions">\n      <button class="btn copy-btn">Copy Invite</button>\n      <button class="btn mini-btn">âˆ’</button>\n    </div>\n  ',document.body.appendChild(s);const r=()=>{const t=e.getStats(),r=e.getUsers();s.querySelector(".stat-value.peers").textContent=t.connectedPeers,s.querySelector(".stat-value.users").textContent=t.users,s.querySelector(".stat-value.room").textContent=t.roomId.slice(0,8)+"...";const n=s.querySelector(".status-dot");t.connectedPeers>0?n.className="status-dot online":n.className="status-dot connecting";const i=s.querySelector(".user-list");r.length>0?(i.innerHTML=r.slice(0,5).map(e=>`\n        <div class="user-item">\n          <div class="user-dot" style="background: ${e.color}"></div>\n          <span class="user-name">${e.name}</span>\n        </div>\n      `).join(""),r.length>5&&(i.innerHTML+=`\n          <div class="user-item">\n            <span class="user-name" style="color: #666">+${r.length-5} more</span>\n          </div>\n        `)):i.innerHTML=""};s.querySelector(".copy-btn").addEventListener("click",()=>{const t=e.invite();navigator.clipboard.writeText(t).then(()=>{const e=s.querySelector(".copy-btn");e.textContent="Copied!",setTimeout(()=>{e.textContent="Copy Invite"},2e3)})}),s.querySelector(".mini-btn").addEventListener("click",()=>{s.classList.toggle("mini");s.querySelector(".mini-btn").textContent=s.classList.contains("mini")?"+":"âˆ’"}),r();const n=setInterval(r,1e3);s.dataset.intervalId=n}function c$(){const e=document.getElementById(i$);e&&(e.dataset.intervalId&&clearInterval(parseInt(e.dataset.intervalId)),e.remove());const t=document.getElementById(`${i$}-styles`);t&&t.remove()}function l$(e,t={}){const s=document.createElement("div");s.style.cssText=`\n    position: fixed;\n    bottom: 80px;\n    right: 16px;\n    background: ${"error"===t.type?"#ff6b6b":"#4facfe"};\n    color: white;\n    padding: 12px 20px;\n    border-radius: 8px;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    font-size: 14px;\n    z-index: 99999;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\n    animation: slideIn 0.3s ease;\n  `,s.textContent=e;const r=document.createElement("style");r.textContent="\n    @keyframes slideIn {\n      from { transform: translateX(100%); opacity: 0; }\n      to { transform: translateX(0); opacity: 1; }\n    }\n    @keyframes slideOut {\n      from { transform: translateX(0); opacity: 1; }\n      to { transform: translateX(100%); opacity: 0; }\n    }\n  ",document.head.appendChild(r),document.body.appendChild(s);const n=t.duration||3e3;setTimeout(()=>{s.style.animation="slideOut 0.3s ease",setTimeout(()=>{s.remove(),r.remove()},300)},n)}function h$(e={}){const t=document.createElement("div");t.style.cssText="\n    position: fixed;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background: rgba(0, 0, 0, 0.7);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 100000;\n  ";const s=document.createElement("div");return s.style.cssText="\n    background: #1a1a2e;\n    color: #fff;\n    padding: 24px;\n    border-radius: 12px;\n    max-width: 400px;\n    width: 90%;\n    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n  ",s.innerHTML=`\n    <h3 style="margin: 0 0 16px; color: #4facfe;">${e.title||"Modal"}</h3>\n    <div style="margin-bottom: 20px; color: #ccc; line-height: 1.5;">${e.content||""}</div>\n    <div style="display: flex; gap: 12px; justify-content: flex-end;">\n      ${e.cancelText?`<button class="cancel-btn" style="padding: 10px 20px; border: none; border-radius: 6px; background: #333; color: #fff; cursor: pointer;">${e.cancelText}</button>`:""}\n      <button class="confirm-btn" style="padding: 10px 20px; border: none; border-radius: 6px; background: #4facfe; color: #fff; cursor: pointer;">${e.confirmText||"OK"}</button>\n    </div>\n  `,t.appendChild(s),document.body.appendChild(t),new Promise(e=>{s.querySelector(".confirm-btn").addEventListener("click",()=>{t.remove(),e(!0)});const r=s.querySelector(".cancel-btn");r&&r.addEventListener("click",()=>{t.remove(),e(!1)}),t.addEventListener("click",s=>{s.target===t&&(t.remove(),e(!1))})})}async function u$(e={}){const t=it(e);console.log("ðŸŒ Initializing Konomi P2P...");const s=await es();console.log("ðŸ”‘ Identity loaded:",s.peerId);const r=await Ht(),n=await Gt(),i=await ck(t);console.log("ðŸŒ P2P Node started:",i.peerId);const o=new bk(i,{peerStore:null}),a=new Sk(i),c=new mz(i),l=new Sz(i),h=new kz(i,n),u=new Oz(i);await Promise.all([o.start(),a.start(),l.start(),h.start(),u.start()]);let d=e.roomId;d||"undefined"==typeof location||(d=location.hash.slice(1)||crypto.randomUUID(),location.hash||(location.hash=d)),d=d||crypto.randomUUID();const p=c.join(d,{user:e.user||{name:"Anonymous",color:d$()}}),f=new p$({node:i,identity:s,discovery:o,relay:a,rooms:c,room:p,signal:l,blob:h,rpc:u,store:r,blobStore:n,config:t});return"undefined"!=typeof window&&(window.konomiP2P=f),!1!==e.showUI&&a$(f),"undefined"!=typeof window&&window.addEventListener("hashchange",()=>{const e=location.hash.slice(1);e&&e!==f.roomId&&f.switchRoom(e)}),console.log("ðŸŒ Konomi P2P ready!"),console.log("ðŸ“‹ Room:",d),console.log("ðŸ”— Invite:",f.invite()),f}function d$(){const e=["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#98D8C8","#F7DC6F","#BB8FCE","#85C1E9","#F8B500","#00CED1"];return e[Math.floor(Math.random()*e.length)]}class p${constructor(e){this._node=e.node,this._identity=e.identity,this._discovery=e.discovery,this._relay=e.relay,this._rooms=e.rooms,this._room=e.room,this._signal=e.signal,this._blob=e.blob,this._rpc=e.rpc,this._store=e.store,this._blobStore=e.blobStore,this._config=e.config,this._handlers=new Map}get peerId(){return this._node.peerId}get roomId(){return this._room.id}get node(){return this._node}get doc(){return this._room.doc}get provider(){return this._room.provider}get room(){return this._room}switchRoom(e,t={}){return this._rooms.leave(this._room.id),this._room=this._rooms.join(e,t),"undefined"!=typeof location&&(location.hash=e),this._emit("room:switch",{roomId:e}),this._room}getSharedMap(e){return this._room.getMap(e)}getSharedArray(e){return this._room.getArray(e)}getSharedText(e){return this._room.getText(e)}transact(e,t=null){this._room.transact(e,t)}getPeers(){return this._room.getPeers()}getAllPeers(){return this._node.getConnectedPeers()}getUsers(){return this._room.getUsers()}getAwareness(){return this._room.awareness}setUser(e){this._room.setUser(e)}setCursor(e){this._room.setCursor(e)}invite(){return this._room.getInviteLink()}createRoom(e=null,t={}){e=e||crypto.randomUUID();const s=this._rooms.join(e,t);return{roomId:e,room:s,invite:s.getInviteLink()}}async shareBlob(e,t={}){return this._blob.share(e,t)}async requestBlob(e,t,s){return this._blob.requestBlob(e,t,s)}registerMethod(e,t){this._rpc.register(e,t)}async callPeer(e,t,s){return this._rpc.call(e,t,s)}async broadcast(e,t){return this._rpc.broadcast(this.getPeers(),e,t)}on(e,t){switch(this._handlers.has(e)||this._handlers.set(e,new Set),this._handlers.get(e).add(t),e){case"peer:connect":this._node.on("peer:connect",t);break;case"peer:disconnect":this._node.on("peer:disconnect",t);break;case"update":this._room.on("update",t)}}off(e,t){switch(this._handlers.has(e)&&this._handlers.get(e).delete(t),e){case"peer:connect":this._node.off("peer:connect",t);break;case"peer:disconnect":this._node.off("peer:disconnect",t);break;case"update":this._room.off("update",t)}}_emit(e,t){if(this._handlers.has(e))for(const s of this._handlers.get(e))try{s(t)}catch(e){console.error("Event handler error:",e)}}async stop(){console.log("ðŸŒ Stopping Konomi P2P..."),c$(),await Promise.all([this._discovery.stop(),this._relay.stop(),this._signal.stop(),this._blob.stop(),this._rpc.stop()]),this._rooms.destroy(),await this._node.stop(),"undefined"!=typeof window&&delete window.konomiP2P,console.log("ðŸŒ Konomi P2P stopped")}getStats(){return{peerId:this.peerId,roomId:this.roomId,connectedPeers:this.getAllPeers().length,roomPeers:this.getPeers().length,users:this.getUsers().length,multiaddrs:this._node.multiaddrs}}}class f${constructor(e,t){this.storage=e,this.syncMap=t,this._originalMethods={},this._intercepted=!1}start(){if(!this._intercepted){this._intercepted=!0,this._originalMethods={setItem:this.storage.setItem.bind(this.storage),getItem:this.storage.getItem.bind(this.storage),removeItem:this.storage.removeItem.bind(this.storage),clear:this.storage.clear.bind(this.storage)};for(let e=0;e<this.storage.length;e++){const t=this.storage.key(e),s=this.storage.getItem(t);this.syncMap.set(t,s)}this.storage.setItem=(e,t)=>{this._originalMethods.setItem(e,t),this.syncMap.set(e,t)},this.storage.removeItem=e=>{this._originalMethods.removeItem(e),this.syncMap.delete(e)},this.storage.clear=()=>{this._originalMethods.clear();const e=Array.from(this.syncMap.keys());for(const t of e)this.syncMap.delete(t)},this.syncMap.observe(e=>{e.changes.keys.forEach((e,t)=>{if("delete"===e.action)this._originalMethods.removeItem(t);else{const e=this.syncMap.get(t);e!==this._originalMethods.getItem(t)&&this._originalMethods.setItem(t,e)}})})}}stop(){this._intercepted&&(this._intercepted=!1,this._originalMethods.setItem&&(this.storage.setItem=this._originalMethods.setItem,this.storage.getItem=this._originalMethods.getItem,this.storage.removeItem=this._originalMethods.removeItem,this.storage.clear=this._originalMethods.clear))}}class g${constructor(e={}){this.cache=e.cache||new Map,this.blobStore=e.blobStore,this.peers=e.peers||[],this._originalFetch=null,this._intercepted=!1,this._urlPatterns=e.urlPatterns||[]}start(){this._intercepted||"undefined"!=typeof fetch&&(this._intercepted=!0,this._originalFetch=fetch.bind(window),window.fetch=async(e,t)=>{const s="string"==typeof e?e:e.url;if(!this._shouldIntercept(s))return this._originalFetch(e,t);try{const r=await this._originalFetch(e,t);if(r.ok&&(!t?.method||"GET"===t.method)){const e=r.clone(),t=await e.blob(),n=await t.arrayBuffer();this.cache.set(s,{data:new Uint8Array(n),contentType:r.headers.get("content-type"),timestamp:Date.now()})}return r}catch(e){const t=this.cache.get(s);if(t)return console.log(`ðŸ“¦ Serving from cache: ${s}`),new Response(t.data,{headers:{"Content-Type":t.contentType||"application/octet-stream"}});if(this.blobStore&&this.peers.length>0){const e=await this._tryP2P(s);if(e)return e}throw e}})}stop(){this._intercepted&&(this._intercepted=!1,this._originalFetch&&(window.fetch=this._originalFetch))}_shouldIntercept(e){return 0===this._urlPatterns.length||this._urlPatterns.some(t=>"string"==typeof t?e.includes(t):t instanceof RegExp&&t.test(e))}async _tryP2P(e){return null}addPattern(e){this._urlPatterns.push(e)}clearCache(){this.cache.clear()}}class m${constructor(e){this.syncMap=e,this._originalMethods={},this._intercepted=!1}start(){this._intercepted||"undefined"!=typeof history&&(this._intercepted=!0,this._originalMethods={pushState:history.pushState.bind(history),replaceState:history.replaceState.bind(history)},history.pushState=(e,t,s)=>{this._originalMethods.pushState(e,t,s),this._syncState(e,s)},history.replaceState=(e,t,s)=>{this._originalMethods.replaceState(e,t,s),this._syncState(e,s)},window.addEventListener("popstate",e=>{this._syncState(e.state,location.href)}),this.syncMap.observe(e=>{const t=this.syncMap.get("_url"),s=this.syncMap.get("_state");t&&t!==location.href&&this._originalMethods.replaceState(s,"",t)}))}stop(){this._intercepted&&(this._intercepted=!1,this._originalMethods.pushState&&(history.pushState=this._originalMethods.pushState,history.replaceState=this._originalMethods.replaceState))}_syncState(e,t){this.syncMap.set("_url",t),this.syncMap.set("_state",e)}}class y${constructor(e){this.syncMap=e,this._intercepted=!1}start(){this._intercepted||"undefined"!=typeof document&&(this._intercepted=!0,this._parseCookies(),this.syncMap.observe(e=>{}))}stop(){this._intercepted=!1}_parseCookies(){const e=document.cookie.split(";");for(const t of e){const[e,s]=t.trim().split("=");e&&this.syncMap.set(`cookie:${e}`,decodeURIComponent(s||""))}}}function b$(e,t={}){const s=e.getMap("_localStorage"),r=e.getMap("_sessionStorage"),n=e.getMap("_history"),i=e.getMap("_cookies"),o={localStorage:"undefined"!=typeof localStorage?new f$(localStorage,s):null,sessionStorage:"undefined"!=typeof sessionStorage?new f$(sessionStorage,r):null,history:new m$(n),cookies:new y$(i),fetch:new g$(t.fetch||{})};return{startAll(){Object.values(o).forEach(e=>e?.start())},stopAll(){Object.values(o).forEach(e=>e?.stop())},get:e=>o[e],start(e){o[e]?.start()},stop(e){o[e]?.stop()}}}class w${constructor(e,t,s={}){this.form="string"==typeof e?document.querySelector(e):e,this.syncMap=t,this.prefix=s.prefix||"form:",this.debounce=s.debounce||100,this._handlers=new Map,this._timeout=null,this._started=!1}start(){if(this._started||!this.form)return;this._started=!0;const e=this.form.querySelectorAll("input, textarea, select");e.forEach(e=>{const t=this._getKey(e);this.syncMap.has(t)&&this._setValue(e,this.syncMap.get(t))}),e.forEach(e=>{const t=this._createHandler(e);this._handlers.set(e,t),e.addEventListener("input",t),e.addEventListener("change",t)}),this._observer=e=>{e.changes.keys.forEach((e,t)=>{if(!t.startsWith(this.prefix))return;const s=t.slice(this.prefix.length),r=this.form.querySelector(`[name="${s}"]`);if(r&&this.syncMap.has(t)){const e=this.syncMap.get(t);this._getValue(r)!==e&&this._setValue(r,e)}})},this.syncMap.observe(this._observer)}stop(){if(this._started){this._started=!1;for(const[e,t]of this._handlers)e.removeEventListener("input",t),e.removeEventListener("change",t);this._handlers.clear(),this._observer&&this.syncMap.unobserve(this._observer)}}_createHandler(e){return()=>{this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(()=>{const t=this._getKey(e),s=this._getValue(e);this.syncMap.set(t,s)},this.debounce)}}_getKey(e){return this.prefix+(e.name||e.id||"")}_getValue(e){return"checkbox"===e.type?e.checked:"radio"===e.type?e.checked?e.value:null:e.value}_setValue(e,t){"checkbox"===e.type?e.checked=!!t:"radio"===e.type?e.checked=e.value===t:e.value=t??""}}class v${constructor(e,t,s={}){this.canvas="string"==typeof e?document.querySelector(e):e,this.syncArray=t,this.color=s.color||"#000000",this.lineWidth=s.lineWidth||2,this._ctx=null,this._drawing=!1,this._lastIndex=0,this._started=!1}start(){!this._started&&this.canvas&&(this._started=!0,this._ctx=this.canvas.getContext("2d"),this._replay(),this.canvas.addEventListener("mousedown",this._onMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this._onMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this._onMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseUp.bind(this)),this.canvas.addEventListener("touchstart",this._onTouchStart.bind(this)),this.canvas.addEventListener("touchmove",this._onTouchMove.bind(this)),this.canvas.addEventListener("touchend",this._onTouchEnd.bind(this)),this._observer=()=>{this._replayNew()},this.syncArray.observe(this._observer))}stop(){this._started&&(this._started=!1,this.canvas.removeEventListener("mousedown",this._onMouseDown),this.canvas.removeEventListener("mousemove",this._onMouseMove),this.canvas.removeEventListener("mouseup",this._onMouseUp),this.canvas.removeEventListener("mouseleave",this._onMouseUp),this.canvas.removeEventListener("touchstart",this._onTouchStart),this.canvas.removeEventListener("touchmove",this._onTouchMove),this.canvas.removeEventListener("touchend",this._onTouchEnd),this._observer&&this.syncArray.unobserve(this._observer))}setColor(e){this.color=e}setLineWidth(e){this.lineWidth=e}clear(){for(this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height);this.syncArray.length>0;)this.syncArray.delete(0);this._lastIndex=0}_replay(){const e=this.syncArray.toArray();this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(const t of e)this._drawStroke(t);this._lastIndex=e.length}_replayNew(){const e=this.syncArray.toArray();for(let t=this._lastIndex;t<e.length;t++)this._drawStroke(e[t]);this._lastIndex=e.length}_drawStroke(e){if(this._ctx.beginPath(),this._ctx.strokeStyle=e.color,this._ctx.lineWidth=e.width,this._ctx.lineCap="round",this._ctx.lineJoin="round",e.points.length>0){this._ctx.moveTo(e.points[0].x,e.points[0].y);for(let t=1;t<e.points.length;t++)this._ctx.lineTo(e.points[t].x,e.points[t].y)}this._ctx.stroke()}_onMouseDown(e){this._drawing=!0,this._currentStroke={color:this.color,width:this.lineWidth,points:[{x:e.offsetX,y:e.offsetY}]}}_onMouseMove(e){this._drawing&&(this._currentStroke.points.push({x:e.offsetX,y:e.offsetY}),this._drawStroke(this._currentStroke))}_onMouseUp(){this._drawing&&(this._drawing=!1,this._currentStroke&&this._currentStroke.points.length>1&&this.syncArray.push([this._currentStroke]),this._currentStroke=null)}_onTouchStart(e){e.preventDefault();const t=e.touches[0],s=this.canvas.getBoundingClientRect();this._drawing=!0,this._currentStroke={color:this.color,width:this.lineWidth,points:[{x:t.clientX-s.left,y:t.clientY-s.top}]}}_onTouchMove(e){if(!this._drawing)return;e.preventDefault();const t=e.touches[0],s=this.canvas.getBoundingClientRect();this._currentStroke.points.push({x:t.clientX-s.left,y:t.clientY-s.top}),this._drawStroke(this._currentStroke)}_onTouchEnd(){this._onMouseUp()}}class S${constructor(e,t,s={}){this.element="string"==typeof e?document.querySelector(e):e,this.syncText=t,this.debounce=s.debounce||100,this._timeout=null,this._updating=!1,this._started=!1}start(){!this._started&&this.element&&(this._started=!0,this.syncText.length>0&&(this.element.textContent=this.syncText.toString()),this._onInput=()=>{this._updating||(this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(()=>{this._syncToYjs()},this.debounce))},this.element.addEventListener("input",this._onInput),this._observer=()=>{this._updating||(this._updating=!0,this.element.textContent=this.syncText.toString(),this._updating=!1)},this.syncText.observe(this._observer))}stop(){this._started&&(this._started=!1,this.element.removeEventListener("input",this._onInput),this._observer&&this.syncText.unobserve(this._observer))}_syncToYjs(){this._updating=!0;const e=this.element.textContent;e!==this.syncText.toString()&&(this.syncText.delete(0,this.syncText.length),this.syncText.insert(0,e)),this._updating=!1}}class E${constructor(e,t,s={}){this.list="string"==typeof e?document.querySelector(e):e,this.syncArray=t,this.renderItem=s.renderItem||(e=>{const t=document.createElement("li");return t.textContent="string"==typeof e?e:JSON.stringify(e),t}),this._started=!1}start(){!this._started&&this.list&&(this._started=!0,this._render(),this._observer=()=>{this._render()},this.syncArray.observe(this._observer))}stop(){this._started&&(this._started=!1,this._observer&&this.syncArray.unobserve(this._observer))}add(e){this.syncArray.push([e])}remove(e){this.syncArray.delete(e)}_render(){this.list.innerHTML="";this.syncArray.toArray().forEach((e,t)=>{const s=this.renderItem(e,t);this.list.appendChild(s)})}}function D$(e){return{form:(t,s="form")=>new w$(t,e.getMap(s)),canvas:(t,s="canvas")=>new v$(t,e.getArray(s)),contentEditable:(t,s="content")=>new S$(t,e.getText(s)),list:(t,s="list",r={})=>new E$(t,e.getArray(s),r)}}class _${constructor(e={}){this.swPath=e.swPath||"/service-worker.js",this.syncTag=e.syncTag||"konomi-sync",this._registration=null,this._handlers=new Map,this._initialized=!1}async init(){if(!this._initialized)if("serviceWorker"in navigator)try{this._registration=await navigator.serviceWorker.register(this.swPath),console.log("Service worker registered"),navigator.serviceWorker.addEventListener("message",e=>{this._handleMessage(e.data)}),navigator.serviceWorker.addEventListener("controllerchange",()=>{console.log("Service worker controller changed"),this._emit("controllerchange")}),this._initialized=!0}catch(e){console.error("Service worker registration failed:",e)}else console.warn("Service workers not supported")}async requestSync(){if(!this._registration)return!1;if("sync"in this._registration)try{return await this._registration.sync.register(this.syncTag),console.log("Background sync registered"),!0}catch(e){return console.warn("Background sync registration failed:",e),!1}return console.warn("Background sync not supported"),!1}async requestPeriodicSync(e=432e5){if(!this._registration)return!1;if("periodicSync"in this._registration)try{if("granted"===(await navigator.permissions.query({name:"periodic-background-sync"})).state)return await this._registration.periodicSync.register(this.syncTag,{minInterval:e}),console.log("Periodic sync registered"),!0}catch(e){console.warn("Periodic sync registration failed:",e)}return console.warn("Periodic sync not supported"),!1}async postMessage(e){navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage(e)}async cacheUrls(e){await this.postMessage({type:"CACHE_URLS",urls:e})}async clearCache(){await this.postMessage({type:"CLEAR_CACHE"})}async getCacheSize(){return new Promise(e=>{const t=s=>{"CACHE_SIZE"===s.data.type&&(navigator.serviceWorker.removeEventListener("message",t),e(s.data.size))};navigator.serviceWorker.addEventListener("message",t),this.postMessage({type:"GET_CACHE_SIZE"}),setTimeout(()=>{navigator.serviceWorker.removeEventListener("message",t),e(0)},5e3)})}get isOnline(){return navigator.onLine}_handleMessage(e){if("SYNC_REQUESTED"===e.type)this._emit("sync-requested");else this._emit("message",e)}on(e,t){this._handlers.has(e)||this._handlers.set(e,new Set),this._handlers.get(e).add(t)}off(e,t){this._handlers.has(e)&&this._handlers.get(e).delete(t)}_emit(e,t){if(this._handlers.has(e))for(const s of this._handlers.get(e))try{s(t)}catch(e){console.error("Event handler error:",e)}}async unregister(){this._registration&&(await this._registration.unregister(),this._registration=null,this._initialized=!1)}async update(){this._registration&&await this._registration.update()}async skipWaiting(){await this.postMessage({type:"SKIP_WAITING"})}}class T${constructor(){this._online="undefined"==typeof navigator||navigator.onLine,this._handlers=new Map,"undefined"!=typeof window&&(window.addEventListener("online",()=>this._setOnline(!0)),window.addEventListener("offline",()=>this._setOnline(!1)))}get isOnline(){return this._online}_setOnline(e){this._online!==e&&(this._online=e,this._emit(e?"online":"offline"),this._emit("change",{online:e}))}on(e,t){this._handlers.has(e)||this._handlers.set(e,new Set),this._handlers.get(e).add(t)}off(e,t){this._handlers.has(e)&&this._handlers.get(e).delete(t)}_emit(e,t){if(this._handlers.has(e))for(const s of this._handlers.get(e))try{s(t)}catch(e){console.error("Event handler error:",e)}}}class I${constructor(){this._connection="undefined"!=typeof navigator?navigator.connection||navigator.mozConnection||navigator.webkitConnection:null,this._connection&&this._connection.addEventListener("change",()=>{this._onConnectionChange()})}get effectiveType(){return this._connection?.effectiveType||"unknown"}get downlink(){return this._connection?.downlink||-1}get rtt(){return this._connection?.rtt||-1}get saveData(){return this._connection?.saveData||!1}get qualityLevel(){switch(this.effectiveType){case"4g":return 5;case"3g":return 3;case"2g":return 2;case"slow-2g":return 1;default:return this.downlink>1?4:3}}get qualityLabel(){switch(this.qualityLevel){case 5:return"excellent";case 4:return"good";case 3:return"fair";case 2:return"poor";case 1:return"very poor";default:return"unknown"}}_onConnectionChange(){console.log("Network quality changed:",this.qualityLabel)}}let C$=null,P$=null,x$=null;function A$(){return C$||(C$=new _$),C$}function k$(){return P$||(P$=new T$),P$}function N$(){return x$||(x$=new I$),x$}const R$={vfs:{FileType:{N:"FileType",C:"vfs",D:"Virtual file system node types",V:{F:{N:"file",D:"Regular file",V:1},D:{N:"dir",D:"Directory",V:2},L:{N:"link",D:"Symbolic link",V:3},P:{N:"pipe",D:"Named pipe (FIFO)",V:4},S:{N:"socket",D:"Unix socket",V:5},B:{N:"block",D:"Block device",V:6},C:{N:"char",D:"Character device",V:7}}},Permission:{N:"Permission",C:"vfs",D:"Unix-style permission bits",V:{R:{N:"READ",D:"Read permission",V:4},W:{N:"WRITE",D:"Write permission",V:2},X:{N:"EXEC",D:"Execute permission",V:1},UR:{N:"USR_R",D:"User read",V:256},UW:{N:"USR_W",D:"User write",V:128},UX:{N:"USR_X",D:"User exec",V:64},GR:{N:"GRP_R",D:"Group read",V:32},GW:{N:"GRP_W",D:"Group write",V:16},GX:{N:"GRP_X",D:"Group exec",V:8},OR:{N:"OTH_R",D:"Other read",V:4},OW:{N:"OTH_W",D:"Other write",V:2},OX:{N:"OTH_X",D:"Other exec",V:1}},X:{755:493,644:420,600:384,777:511}},Inode:{N:"Inode",C:"vfs",D:"File system inode (index node)",P:{T:{N:"type",T:"FileType",D:"Node type",R:!0},M:{N:"mode",T:"number",D:"Permission bits",R:!0},U:{N:"uid",T:"number",D:"Owner user ID",R:!0},G:{N:"gid",T:"number",D:"Owner group ID",R:!0},S:{N:"size",T:"number",D:"Size in bytes",R:!0},A:{N:"atime",T:"number",D:"Access time (epoch ms)",R:!0},MT:{N:"mtime",T:"number",D:"Modify time (epoch ms)",R:!0},CT:{N:"ctime",T:"number",D:"Change time (epoch ms)",R:!0},V:{N:"version",T:"number",D:"CRDT version counter",R:!0},D:{N:"data",T:"string",D:"File data (base64 for binary)",O:!0},L:{N:"link",T:"string",D:"Symlink target path",O:!0},C:{N:"children",T:"string[]",D:"Directory entries",O:!0}}},FileDescriptor:{N:"FileDescriptor",C:"vfs",D:"Open file handle",P:{FD:{N:"fd",T:"number",D:"File descriptor number",R:!0},P:{N:"path",T:"string",D:"File path",R:!0},F:{N:"flags",T:"number",D:"Open flags",R:!0},O:{N:"offset",T:"number",D:"Current read/write position",R:!0}},X:{STDIN:0,STDOUT:1,STDERR:2}}},kernel:{ProcessState:{N:"ProcessState",C:"kernel",D:"Process execution states",V:{N:{N:"new",D:"Just created",V:"new"},R:{N:"ready",D:"Ready to run",V:"ready"},X:{N:"running",D:"Currently executing",V:"running"},W:{N:"waiting",D:"Waiting for I/O or event",V:"waiting"},S:{N:"stopped",D:"Stopped by signal",V:"stopped"},Z:{N:"zombie",D:"Terminated, awaiting cleanup",V:"zombie"},D:{N:"dead",D:"Process terminated",V:"dead"}}},Priority:{N:"Priority",C:"kernel",D:"Process scheduling priority",V:{I:{N:"idle",D:"Lowest priority",V:19},L:{N:"low",D:"Below normal",V:10},N:{N:"normal",D:"Default priority",V:0},H:{N:"high",D:"Above normal",V:-10},R:{N:"realtime",D:"Highest priority",V:-20}}},Signal:{N:"Signal",C:"kernel",D:"Unix-style process signals",V:{HUP:{N:"SIGHUP",D:"Hangup",V:1},INT:{N:"SIGINT",D:"Interrupt (Ctrl+C)",V:2},QUIT:{N:"SIGQUIT",D:"Quit",V:3},ILL:{N:"SIGILL",D:"Illegal instruction",V:4},TRAP:{N:"SIGTRAP",D:"Trace/breakpoint trap",V:5},ABRT:{N:"SIGABRT",D:"Abort",V:6},BUS:{N:"SIGBUS",D:"Bus error",V:7},FPE:{N:"SIGFPE",D:"Floating point exception",V:8},KILL:{N:"SIGKILL",D:"Kill (cannot be caught)",V:9},USR1:{N:"SIGUSR1",D:"User signal 1",V:10},SEGV:{N:"SIGSEGV",D:"Segmentation fault",V:11},USR2:{N:"SIGUSR2",D:"User signal 2",V:12},PIPE:{N:"SIGPIPE",D:"Broken pipe",V:13},ALRM:{N:"SIGALRM",D:"Alarm clock",V:14},TERM:{N:"SIGTERM",D:"Termination",V:15},CHLD:{N:"SIGCHLD",D:"Child stopped/terminated",V:17},CONT:{N:"SIGCONT",D:"Continue if stopped",V:18},STOP:{N:"SIGSTOP",D:"Stop (cannot be caught)",V:19},TSTP:{N:"SIGTSTP",D:"Stop from terminal (Ctrl+Z)",V:20}}},IPCType:{N:"IPCType",C:"kernel",D:"Inter-process communication message types",V:{D:{N:"data",D:"Data payload",V:"data"},R:{N:"request",D:"Request/RPC call",V:"request"},P:{N:"response",D:"Response to request",V:"response"},S:{N:"signal",D:"Signal delivery",V:"signal"},E:{N:"event",D:"Event notification",V:"event"},C:{N:"control",D:"Control message",V:"control"}}},Process:{N:"Process",C:"kernel",D:"Process control block",P:{PID:{N:"pid",T:"number",D:"Process ID",R:!0},PPID:{N:"ppid",T:"number",D:"Parent process ID",R:!0},N:{N:"name",T:"string",D:"Process name",R:!0},S:{N:"state",T:"ProcessState",D:"Current state",R:!0},PR:{N:"priority",T:"Priority",D:"Scheduling priority",R:!0},U:{N:"uid",T:"number",D:"User ID",R:!0},G:{N:"gid",T:"number",D:"Group ID",R:!0},CWD:{N:"cwd",T:"string",D:"Current working directory",R:!0},ENV:{N:"env",T:"object",D:"Environment variables",O:!0},FD:{N:"fds",T:"Map<number, FileDescriptor>",D:"Open file descriptors",O:!0},C:{N:"children",T:"number[]",D:"Child PIDs",O:!0},CT:{N:"created",T:"number",D:"Creation time",R:!0},UT:{N:"utime",T:"number",D:"User CPU time",R:!0},ST:{N:"stime",T:"number",D:"System CPU time",R:!0},EC:{N:"exitCode",T:"number",D:"Exit code (if terminated)",O:!0}}},IPCMessage:{N:"IPCMessage",C:"kernel",D:"Inter-process communication message",P:{ID:{N:"id",T:"string",D:"Message ID",R:!0},F:{N:"from",T:"number",D:"Source PID",R:!0},T:{N:"to",T:"number",D:"Destination PID",R:!0},Y:{N:"type",T:"IPCType",D:"Message type",R:!0},D:{N:"data",T:"any",D:"Message payload",O:!0},TS:{N:"timestamp",T:"number",D:"Send time",R:!0},RI:{N:"replyTo",T:"string",D:"Reply-to message ID",O:!0}}}},vm:{VMState:{N:"VMState",C:"vm",D:"Virtual machine states (PackML-inspired)",V:{O:{N:"off",D:"Not running",V:"off"},B:{N:"booting",D:"Starting up",V:"booting"},R:{N:"running",D:"Active and processing",V:"running"},S:{N:"suspended",D:"Paused but resumable",V:"suspended"},M:{N:"migrating",D:"Moving to another node",V:"migrating"},D:{N:"shutting_down",D:"Stopping",V:"shutting_down"},E:{N:"error",D:"Error state",V:"error"}}},VMEvent:{N:"VMEvent",C:"vm",D:"Virtual machine lifecycle events",V:{B:{N:"boot",D:"VM starting",V:"vm:boot"},R:{N:"ready",D:"VM ready",V:"vm:ready"},S:{N:"suspend",D:"VM suspended",V:"vm:suspend"},U:{N:"resume",D:"VM resumed",V:"vm:resume"},M:{N:"migrate",D:"VM migrating",V:"vm:migrate"},D:{N:"shutdown",D:"VM stopping",V:"vm:shutdown"},E:{N:"error",D:"VM error",V:"vm:error"},Y:{N:"sync",D:"State synchronized",V:"vm:sync"},PJ:{N:"peer_join",D:"Peer connected",V:"vm:peer_join"},PL:{N:"peer_leave",D:"Peer disconnected",V:"vm:peer_leave"}}},SyncType:{N:"SyncType",C:"vm",D:"VM-to-VM synchronization message types",V:{VU:{N:"vfs_update",D:"Incremental VFS change",V:"vfs:update"},VF:{N:"vfs_full",D:"Full VFS snapshot",V:"vfs:full"},PS:{N:"proc_spawn",D:"Process spawn notification",V:"proc:spawn"},PK:{N:"proc_kill",D:"Process kill notification",V:"proc:kill"},PM:{N:"proc_migrate",D:"Process migration",V:"proc:migrate"},SU:{N:"shm_update",D:"Shared memory update",V:"shm:update"},HB:{N:"heartbeat",D:"Keepalive message",V:"heartbeat"}}},VMConfig:{N:"VMConfig",C:"vm",D:"Virtual machine configuration",P:{SI:{N:"syncInterval",T:"number",D:"Sync timer interval (ms)",R:!1,X:1e3},HI:{N:"heartbeatInterval",T:"number",D:"Heartbeat interval (ms)",R:!1,X:5e3},MP:{N:"maxProcesses",T:"number",D:"Max concurrent processes",R:!1,X:100},MF:{N:"maxFiles",T:"number",D:"Max open files",R:!1,X:1e4}}},ShmEntry:{N:"ShmEntry",C:"vm",D:"Shared memory entry (CRDT-synced)",P:{V:{N:"value",T:"any",D:"Stored value",R:!0},VE:{N:"version",T:"number",D:"CRDT version counter",R:!0},TS:{N:"timestamp",T:"number",D:"Last update time",R:!0},O:{N:"origin",T:"string",D:"Origin VM ID",R:!0}}},PeerInfo:{N:"PeerInfo",C:"vm",D:"Connected peer information",P:{ID:{N:"id",T:"string",D:"Peer VM ID",R:!0},C:{N:"connected",T:"number",D:"Connection time",R:!0},LS:{N:"lastSeen",T:"number",D:"Last heartbeat time",R:!0}}},VMStats:{N:"VMStats",C:"vm",D:"Virtual machine runtime statistics",P:{P:{N:"processes",T:"number",D:"Active process count",R:!0},F:{N:"files",T:"number",D:"Open file count",R:!0},SM:{N:"syncMessages",T:"number",D:"Sync messages sent",R:!0},BT:{N:"bytesTransferred",T:"number",D:"Total bytes transferred",R:!0}}}}},M$={crypto:{KeyType:{N:"KeyType",C:"crypto",D:"Cryptographic key types",V:{S:{N:"signing",D:"Ed25519 signing key",V:"signing"},B:{N:"box",D:"X25519 encryption key",V:"box"},Y:{N:"symmetric",D:"Shared secret key",V:"symmetric"}}},KeyPair:{N:"KeyPair",C:"crypto",D:"Asymmetric key pair (public + secret)",P:{PK:{N:"publicKey",T:"Uint8Array",D:"Public key bytes",R:!0},SK:{N:"secretKey",T:"Uint8Array",D:"Secret key bytes",R:!0}},X:{SIGN_PK:32,SIGN_SK:64,BOX_PK:32,BOX_SK:32}},KeyBundle:{N:"KeyBundle",C:"crypto",D:"Complete identity key bundle (signing + encryption)",P:{S:{N:"signing",T:"KeyPair",D:"Ed25519 signing key pair",R:!0},B:{N:"box",T:"KeyPair",D:"X25519 encryption key pair",R:!0}}},Encrypted:{N:"Encrypted",C:"crypto",D:"Encrypted payload with nonce",P:{N:{N:"nonce",T:"Uint8Array",D:"Random nonce (24 bytes)",R:!0},C:{N:"ciphertext",T:"Uint8Array",D:"Encrypted data",R:!0}},X:{NONCE_LEN:24}},Signature:{N:"Signature",C:"crypto",D:"Detached Ed25519 signature",P:{S:{N:"sig",T:"Uint8Array",D:"Signature bytes (64)",R:!0},PK:{N:"publicKey",T:"Uint8Array",D:"Signer public key",R:!0},TS:{N:"timestamp",T:"number",D:"Signing time",O:!0}},X:{SIG_LEN:64}}},identity:{IdentityMeta:{N:"IdentityMeta",C:"identity",D:"User-facing identity metadata",P:{N:{N:"name",T:"string",D:"Display name",O:!0},A:{N:"avatar",T:"string",D:"Avatar URL or data URI",O:!0},C:{N:"created",T:"number",D:"Creation timestamp",R:!0}}},Identity:{N:"Identity",C:"identity",D:"Complete cryptographic identity",P:{ID:{N:"peerId",T:"string",D:"Base58-encoded peer ID",R:!0},K:{N:"keyPair",T:"KeyBundle",D:"Signing + encryption keys",R:!0},M:{N:"metadata",T:"IdentityMeta",D:"User metadata",R:!0}}},PublicIdentity:{N:"PublicIdentity",C:"identity",D:"Public identity info (shareable)",P:{ID:{N:"peerId",T:"string",D:"Base58 peer ID",R:!0},PK:{N:"publicKey",T:"string",D:"Base64 signing public key",R:!0},BPK:{N:"boxPublicKey",T:"string",D:"Base64 encryption public key",R:!0},N:{N:"name",T:"string",D:"Display name",O:!0},A:{N:"avatar",T:"string",D:"Avatar URL",O:!0}}}},peer:{PeerStatus:{N:"PeerStatus",C:"peer",D:"Peer connection status",V:{U:{N:"unknown",D:"Unknown/new peer",V:"unknown"},C:{N:"connecting",D:"Connection in progress",V:"connecting"},O:{N:"connected",D:"Actively connected",V:"connected"},D:{N:"disconnected",D:"Previously connected",V:"disconnected"},B:{N:"blocked",D:"Blocked by user",V:"blocked"}}},PeerInfo:{N:"PeerInfo",C:"peer",D:"Information about a known peer",P:{ID:{N:"id",T:"string",D:"Base58 peer ID",R:!0},PK:{N:"publicKey",T:"Uint8Array",D:"Signing public key",O:!0},AD:{N:"addrs",T:"string[]",D:"Known multiaddrs",R:!0},PR:{N:"protocols",T:"string[]",D:"Supported protocols",R:!0},S:{N:"seen",T:"number",D:"Last seen timestamp",R:!0},L:{N:"latency",T:"number",D:"RTT in ms (-1 = unknown)",R:!0},SC:{N:"score",T:"number",D:"Reputation score (-1000 to 1000)",R:!0},TR:{N:"trusted",T:"boolean",D:"Manually trusted",R:!0},BL:{N:"blocked",T:"boolean",D:"Manually blocked",R:!0},M:{N:"metadata",T:"object",D:"Custom metadata",O:!0}},X:{SCORE_MIN:-1e3,SCORE_MAX:1e3,STALE_TIMEOUT:6e4}},PeerAddr:{N:"PeerAddr",C:"peer",D:"Peer network address (multiaddr format)",P:{T:{N:"transport",T:"string",D:"Transport type (tcp, ws, wrtc)",R:!0},H:{N:"host",T:"string",D:"Host or IP",R:!0},P:{N:"port",T:"number",D:"Port number",O:!0},ID:{N:"peerId",T:"string",D:"Target peer ID",O:!0}}}},protocol:{MessageType:{N:"MessageType",C:"protocol",D:"Protocol message types",V:{Q:{N:"request",D:"Request (expects response)",V:"req"},R:{N:"response",D:"Response to request",V:"res"},S:{N:"stream",D:"Streaming data (no response)",V:"stream"},E:{N:"event",D:"Broadcast event",V:"event"}}},Message:{N:"Message",C:"protocol",D:"Protocol message envelope",P:{ID:{N:"id",T:"string",D:"Unique message ID (16 hex chars)",R:!0},V:{N:"v",T:"number",D:"Protocol version",R:!0,X:1},T:{N:"type",T:"MessageType",D:"Message type",R:!0},F:{N:"from",T:"string",D:"Sender peer ID",R:!0},TO:{N:"to",T:"string",D:"Recipient peer ID",O:!0},A:{N:"action",T:"string",D:"Action name (for req/event)",O:!0},P:{N:"payload",T:"any",D:"Message payload",O:!0},RT:{N:"replyTo",T:"string",D:"Original message ID (for response)",O:!0},TS:{N:"ts",T:"number",D:"Timestamp (epoch ms)",R:!0},SG:{N:"sig",T:"Uint8Array",D:"Detached signature",O:!0}},X:{VERSION:1,MAX_AGE:3e5,ID_LEN:16}},ProtocolConfig:{N:"ProtocolConfig",C:"protocol",D:"Protocol handler configuration",P:{TO:{N:"timeout",T:"number",D:"Request timeout (ms)",R:!1,X:3e4},KP:{N:"keyPair",T:"KeyBundle",D:"Signing keys",O:!0}}},PendingRequest:{N:"PendingRequest",C:"protocol",D:"Pending request state",P:{ID:{N:"id",T:"string",D:"Message ID",R:!0},A:{N:"action",T:"string",D:"Requested action",R:!0},TO:{N:"to",T:"string",D:"Target peer",R:!0},TS:{N:"timestamp",T:"number",D:"Request time",R:!0},TM:{N:"timer",T:"number",D:"Timeout timer ID",R:!0}}}}},L$={transport:{TransportType:{N:"TransportType",C:"transport",D:"Network transport protocols",V:{WR:{N:"webrtc",D:"WebRTC peer-to-peer",V:"webrtc"},WS:{N:"websocket",D:"WebSocket to server",V:"websocket"},CR:{N:"circuit_relay",D:"Relay via third peer",V:"circuit-relay"},TC:{N:"tcp",D:"Direct TCP (non-browser)",V:"tcp"},QC:{N:"quic",D:"QUIC transport",V:"quic"}}},QualityLabel:{N:"QualityLabel",C:"transport",D:"Connection quality categories",V:{E:{N:"excellent",D:"Score >= 80",V:"excellent"},G:{N:"good",D:"Score 60-79",V:"good"},F:{N:"fair",D:"Score 40-59",V:"fair"},P:{N:"poor",D:"Score 20-39",V:"poor"},B:{N:"bad",D:"Score < 20",V:"bad"}}},LatencySample:{N:"LatencySample",C:"transport",D:"Single latency measurement",P:{L:{N:"latency",T:"number",D:"RTT in milliseconds",R:!0},TS:{N:"timestamp",T:"number",D:"Measurement time",R:!0}}},BandwidthSample:{N:"BandwidthSample",C:"transport",D:"Bandwidth measurement sample",P:{BPS:{N:"bytesPerSecond",T:"number",D:"Bytes per second",R:!0},TS:{N:"timestamp",T:"number",D:"Measurement time",R:!0}}},ConnectionQuality:{N:"ConnectionQuality",C:"transport",D:"Connection quality metrics",P:{AL:{N:"avgLatency",T:"number",D:"Average latency (ms)",R:!0},J:{N:"jitter",T:"number",D:"Latency variance (ms)",R:!0},S:{N:"score",T:"number",D:"Quality score (0-100)",R:!0},L:{N:"label",T:"QualityLabel",D:"Quality category",R:!0},SC:{N:"sampleCount",T:"number",D:"Number of samples",R:!0}}},Multiaddr:{N:"Multiaddr",C:"transport",D:"Parsed multiaddr components",P:{T:{N:"transport",T:"TransportType",D:"Transport protocol",R:!0},H:{N:"host",T:"string",D:"IP or hostname",O:!0},PT:{N:"port",T:"number",D:"Port number",O:!0},ID:{N:"peerId",T:"string",D:"Peer ID component",O:!0},RL:{N:"relay",T:"boolean",D:"Is relay address",R:!0},R:{N:"raw",T:"string",D:"Raw multiaddr string",R:!0}}}},discovery:{DiscoveryEvent:{N:"DiscoveryEvent",C:"discovery",D:"Peer discovery event types",V:{D:{N:"discovered",D:"Peer found",V:"peer:discovered"},C:{N:"connected",D:"Peer connected",V:"peer:connected"},L:{N:"lost",D:"Peer disconnected",V:"peer:lost"},A:{N:"announce",D:"Self announcement",V:"announce"}}},AnnounceMessage:{N:"AnnounceMessage",C:"discovery",D:"Peer presence announcement",P:{T:{N:"type",T:"string",D:"Message type (announce)",R:!0,X:"announce"},ID:{N:"peerId",T:"string",D:"Announcing peer ID",R:!0},AD:{N:"addrs",T:"string[]",D:"Known multiaddrs",R:!0},RM:{N:"rooms",T:"string[]",D:"Joined room IDs",O:!0},TS:{N:"ts",T:"number",D:"Announcement time",R:!0}}},PresenceMessage:{N:"PresenceMessage",C:"discovery",D:"Room presence announcement",P:{T:{N:"type",T:"string",D:"Message type (presence)",R:!0,X:"presence"},ID:{N:"peerId",T:"string",D:"Peer ID",R:!0},TS:{N:"ts",T:"number",D:"Presence time",R:!0}}},DiscoveryConfig:{N:"DiscoveryConfig",C:"discovery",D:"Discovery manager configuration",P:{AI:{N:"announceInterval",T:"number",D:"Announce interval (ms)",R:!1,X:3e4},ST:{N:"staleTimeout",T:"number",D:"Stale peer timeout (ms)",R:!1,X:3e5}}}},relay:{ReservationStatus:{N:"ReservationStatus",C:"relay",D:"Circuit relay reservation states",V:{N:{N:"none",D:"No reservation",V:"none"},P:{N:"pending",D:"Request in progress",V:"pending"},A:{N:"active",D:"Reservation active",V:"active"},E:{N:"expired",D:"Reservation expired",V:"expired"},F:{N:"failed",D:"Reservation failed",V:"failed"}}},Reservation:{N:"Reservation",C:"relay",D:"Relay reservation information",P:{S:{N:"status",T:"ReservationStatus",D:"Current status",R:!0},C:{N:"createdAt",T:"number",D:"Creation time",R:!0},E:{N:"expiresAt",T:"number",D:"Expiration time",O:!0},ER:{N:"error",T:"string",D:"Error message if failed",O:!0}}},RelayConfig:{N:"RelayConfig",C:"relay",D:"Relay manager configuration",P:{MR:{N:"maxReservations",T:"number",D:"Max concurrent reservations",R:!1,X:3},TL:{N:"reservationTTL",T:"number",D:"Reservation lifetime (ms)",R:!1,X:36e5}}},RelayStats:{N:"RelayStats",C:"relay",D:"Relay connection statistics",P:{T:{N:"total",T:"number",D:"Total reservations",R:!0},A:{N:"active",T:"number",D:"Active count",R:!0},P:{N:"pending",T:"number",D:"Pending count",R:!0},E:{N:"expired",T:"number",D:"Expired count",R:!0},F:{N:"failed",T:"number",D:"Failed count",R:!0}}}},nat:{ConnectionStrategy:{N:"ConnectionStrategy",C:"nat",D:"NAT traversal strategies (priority order)",V:{D:{N:"direct",D:"Direct connection",V:"direct"},H:{N:"hole_punch",D:"UDP hole punching",V:"hole-punch"},R:{N:"relay",D:"Circuit relay",V:"relay"},T:{N:"turn",D:"TURN server relay",V:"turn"}}},NATType:{N:"NATType",C:"nat",D:"Detected NAT type",V:{U:{N:"unknown",D:"Not yet determined",V:"unknown"},O:{N:"open",D:"No NAT / public IP",V:"open"},FC:{N:"full_cone",D:"Full cone NAT (easy)",V:"full-cone"},R:{N:"restricted",D:"Restricted cone NAT",V:"restricted"},PR:{N:"port_restricted",D:"Port-restricted NAT",V:"port-restricted"},S:{N:"symmetric",D:"Symmetric NAT (hardest)",V:"symmetric"}}},ICECandidateType:{N:"ICECandidateType",C:"nat",D:"WebRTC ICE candidate types",V:{H:{N:"host",D:"Local network address",V:"host"},S:{N:"srflx",D:"Server reflexive (STUN)",V:"srflx"},R:{N:"relay",D:"Relay (TURN)",V:"relay"},P:{N:"prflx",D:"Peer reflexive",V:"prflx"}}},ConnectionAttempt:{N:"ConnectionAttempt",C:"nat",D:"NAT traversal connection attempt",P:{ID:{N:"peerId",T:"string",D:"Target peer ID",R:!0},ST:{N:"startTime",T:"number",D:"Attempt start time",R:!0},ET:{N:"endTime",T:"number",D:"Attempt end time",O:!0},D:{N:"duration",T:"number",D:"Total duration (ms)",O:!0},S:{N:"strategies",T:"StrategyResult[]",D:"Tried strategies",R:!0}}},StrategyResult:{N:"StrategyResult",C:"nat",D:"Result of a connection strategy attempt",P:{T:{N:"type",T:"ConnectionStrategy",D:"Strategy used",R:!0},S:{N:"success",T:"boolean",D:"Whether it worked",R:!0},ER:{N:"error",T:"string",D:"Error if failed",O:!0},AD:{N:"addr",T:"string",D:"Address used",O:!0}}},NATStats:{N:"NATStats",C:"nat",D:"NAT traversal statistics",P:{AT:{N:"attempts",T:"number",D:"Total connection attempts",R:!0},SC:{N:"successful",T:"number",D:"Successful connections",R:!0},FL:{N:"failed",T:"number",D:"Failed connections",R:!0},BY:{N:"byStrategy",T:"object",D:"Count by strategy",R:!0},AV:{N:"avgTime",T:"number",D:"Average connection time",R:!0}}},ICEAnalysis:{N:"ICEAnalysis",C:"nat",D:"ICE candidate type breakdown",P:{H:{N:"host",T:"number",D:"Host candidate count",R:!0},S:{N:"srflx",T:"number",D:"STUN candidate count",R:!0},R:{N:"relay",T:"number",D:"TURN candidate count",R:!0},P:{N:"prflx",T:"number",D:"Peer reflexive count",R:!0}}}}},O$={mesh:{MeshState:{N:"MeshState",C:"mesh",D:"WebRTC mesh connection states",V:{D:{N:"disconnected",D:"Not connected to tracker",V:"disconnected"},C:{N:"connecting",D:"Connecting to tracker",V:"connecting"},O:{N:"open",D:"Connected to tracker",V:"open"},R:{N:"reconnecting",D:"Reconnecting after disconnect",V:"reconnecting"}}},DataChannelState:{N:"DataChannelState",C:"mesh",D:"RTCDataChannel ready states",V:{C:{N:"connecting",D:"Channel connecting",V:"connecting"},O:{N:"open",D:"Channel ready",V:"open"},X:{N:"closing",D:"Channel closing",V:"closing"},D:{N:"closed",D:"Channel closed",V:"closed"}}},ICEConnectionState:{N:"ICEConnectionState",C:"mesh",D:"WebRTC ICE connection states",V:{N:{N:"new",D:"Just created",V:"new"},C:{N:"checking",D:"Gathering candidates",V:"checking"},O:{N:"connected",D:"Connection established",V:"connected"},P:{N:"completed",D:"ICE completed",V:"completed"},D:{N:"disconnected",D:"Temporarily disconnected",V:"disconnected"},F:{N:"failed",D:"Connection failed",V:"failed"},X:{N:"closed",D:"Connection closed",V:"closed"}}},SignalType:{N:"SignalType",C:"mesh",D:"WebRTC signaling message types",V:{A:{N:"announce",D:"Room announcement",V:"announce"},O:{N:"offer",D:"SDP offer",V:"offer"},R:{N:"answer",D:"SDP answer",V:"answer"},I:{N:"ice",D:"ICE candidate",V:"ice"}}},MeshAnnounce:{N:"MeshAnnounce",C:"mesh",D:"WebTorrent tracker announce message",P:{A:{N:"action",T:"string",D:"Action type (announce)",R:!0,X:"announce"},H:{N:"info_hash",T:"string",D:"Room hash (SHA-1)",R:!0},ID:{N:"peer_id",T:"string",D:"Local peer ID",R:!0},NW:{N:"numwant",T:"number",D:"Max peers wanted",R:!1,X:10},OF:{N:"offers",T:"Offer[]",D:"SDP offers",O:!0},TO:{N:"to_peer_id",T:"string",D:"Target peer for answer",O:!0},OI:{N:"offer_id",T:"string",D:"Offer ID for answer",O:!0},AN:{N:"answer",T:"Answer",D:"SDP answer",O:!0}}},SDPOffer:{N:"SDPOffer",C:"mesh",D:"WebRTC SDP offer",P:{OI:{N:"offer_id",T:"string",D:"Unique offer ID",R:!0},O:{N:"offer",T:"object",D:"SDP offer object",R:!0}}},SDPAnswer:{N:"SDPAnswer",C:"mesh",D:"WebRTC SDP answer",P:{S:{N:"sdp",T:"string",D:"SDP string",R:!0}}},MeshPeer:{N:"MeshPeer",C:"mesh",D:"Connected mesh peer info",P:{ID:{N:"id",T:"string",D:"Peer ID",R:!0},DC:{N:"dataChannel",T:"RTCDataChannel",D:"Data channel",R:!0},PC:{N:"peerConnection",T:"RTCPeerConnection",D:"Peer connection",R:!0},ST:{N:"state",T:"DataChannelState",D:"Channel state",R:!0},CT:{N:"connectedAt",T:"number",D:"Connection time",O:!0}}}},user:{PresenceState:{N:"PresenceState",C:"user",D:"User online presence states",V:{O:{N:"online",D:"Active",V:"online"},A:{N:"away",D:"Idle/away",V:"away"},B:{N:"busy",D:"Do not disturb",V:"busy"},X:{N:"offline",D:"Disconnected",V:"offline"}}},UserInfo:{N:"UserInfo",C:"user",D:"User presence information",P:{ID:{N:"id",T:"string",D:"User/peer ID",R:!0},N:{N:"name",T:"string",D:"Display name",O:!0},C:{N:"color",T:"string",D:"User color (hex)",O:!0},S:{N:"state",T:"PresenceState",D:"Presence state",R:!1,X:"online"},A:{N:"avatar",T:"string",D:"Avatar URL",O:!0},LS:{N:"lastSeen",T:"number",D:"Last activity time",O:!0}}},UserUpdate:{N:"UserUpdate",C:"user",D:"User presence update message",P:{T:{N:"type",T:"string",D:"Update type",R:!0},U:{N:"user",T:"UserInfo",D:"User data",R:!0},TS:{N:"timestamp",T:"number",D:"Update time",R:!0}},X:{JOIN:"join",LEAVE:"leave",UPDATE:"update"}}},chat:{ChatType:{N:"ChatType",C:"chat",D:"Chat message types",V:{M:{N:"message",D:"Regular chat message",V:"message"},S:{N:"system",D:"System notification",V:"system"},A:{N:"action",D:"Action/emote (/me)",V:"action"},R:{N:"reaction",D:"Emoji reaction",V:"reaction"},T:{N:"thread",D:"Thread reply",V:"thread"}}},ChatMessage:{N:"ChatMessage",C:"chat",D:"Chat message",P:{ID:{N:"id",T:"string",D:"Message ID",R:!0},T:{N:"type",T:"ChatType",D:"Message type",R:!0,X:"message"},F:{N:"from",T:"string",D:"Sender ID",R:!0},N:{N:"name",T:"string",D:"Sender name",O:!0},X:{N:"text",T:"string",D:"Message text",R:!0},TS:{N:"timestamp",T:"number",D:"Send time",R:!0},RT:{N:"replyTo",T:"string",D:"Parent message ID",O:!0},E:{N:"edited",T:"boolean",D:"Was edited",O:!0}}},Reaction:{N:"Reaction",C:"chat",D:"Emoji reaction to message/content",P:{E:{N:"emoji",T:"string",D:"Emoji character",R:!0},F:{N:"from",T:"string",D:"Reactor ID",R:!0},TO:{N:"to",T:"string",D:"Target message/content ID",O:!0},TS:{N:"timestamp",T:"number",D:"Reaction time",R:!0}}},ReactionCounts:{N:"ReactionCounts",C:"chat",D:"Aggregated reaction counts",P:{ID:{N:"targetId",T:"string",D:"Target content ID",R:!0},C:{N:"counts",T:"object",D:"Emoji -> count map",R:!0}},X:{DEFAULT_EMOJIS:["ðŸ‘","â¤ï¸","ðŸŽ‰","ðŸ’¡","ðŸ¤”","ðŸ‘"]}}},status:{ConnectionStatus:{N:"ConnectionStatus",C:"status",D:"Overall connection status",V:{D:{N:"disconnected",D:"Not connected",V:"disconnected"},C:{N:"connecting",D:"Connecting...",V:"connecting"},O:{N:"connected",D:"Connected",V:"connected"},E:{N:"error",D:"Connection error",V:"error"},R:{N:"reconnecting",D:"Reconnecting...",V:"reconnecting"}}},StatusConfig:{N:"StatusConfig",C:"status",D:"Status indicator configuration",P:{L:{N:"labels",T:"object",D:"Status -> label map",R:!1},CL:{N:"colors",T:"object",D:"Status -> color map",O:!0}},X:{DEFAULT_LABELS:{disconnected:"âš« Offline",connecting:"ðŸŸ¡ Connecting...",connected:"ðŸŸ¢ Connected",error:"ðŸ”´ Error",reconnecting:"ðŸŸ¡ Reconnecting..."}}}},laser:{LaserPosition:{N:"LaserPosition",C:"laser",D:"Shared cursor/laser pointer position",P:{ID:{N:"id",T:"string",D:"Pointer owner ID",R:!0},X:{N:"x",T:"number",D:"X coordinate",R:!0},Y:{N:"y",T:"number",D:"Y coordinate",R:!0},C:{N:"color",T:"string",D:"Pointer color",O:!0},V:{N:"visible",T:"boolean",D:"Is visible",R:!1,X:!0}}},LaserUpdate:{N:"LaserUpdate",C:"laser",D:"Laser pointer update message",P:{T:{N:"type",T:"string",D:"Update type",R:!0},P:{N:"position",T:"LaserPosition",D:"Position data",O:!0},ID:{N:"id",T:"string",D:"Pointer ID",R:!0}},X:{MOVE:"move",SHOW:"show",HIDE:"hide"}}},p2p:{P2PMessageType:{N:"P2PMessageType",C:"p2p",D:"P2P data channel message types",V:{C:{N:"chat",D:"Chat message",V:"chat"},U:{N:"user",D:"User update",V:"user"},L:{N:"laser",D:"Laser pointer",V:"laser"},R:{N:"reaction",D:"Reaction",V:"reaction"},S:{N:"sync",D:"State sync",V:"sync"},P:{N:"ping",D:"Keepalive ping",V:"ping"}}},P2PMessage:{N:"P2PMessage",C:"p2p",D:"P2P data channel message envelope",P:{T:{N:"type",T:"P2PMessageType",D:"Message type",R:!0},D:{N:"data",T:"any",D:"Message payload",R:!0},F:{N:"from",T:"string",D:"Sender ID",R:!0},TS:{N:"timestamp",T:"number",D:"Send time",R:!0}}}}},B$={awareness:{PresenceState:{N:"PresenceState",C:"awareness",D:"User activity states",V:{A:{N:"active",D:"Currently active",V:"active"},I:{N:"idle",D:"Idle (1+ min)",V:"idle"},W:{N:"away",D:"Away (5+ min)",V:"away"},O:{N:"offline",D:"Disconnected",V:"offline"}}},AwarenessState:{N:"AwarenessState",C:"awareness",D:"Local awareness state",P:{U:{N:"user",T:"UserInfo",D:"User info",R:1},S:{N:"state",T:"PresenceState",D:"Presence state",R:1},LA:{N:"lastActive",T:"number",D:"Last activity time",R:1},C:{N:"cursor",T:"Cursor",D:"Cursor position",O:1},SL:{N:"selection",T:"Selection",D:"Text selection",O:1},X:{N:"custom",T:"object",D:"Custom state",O:1}}},Cursor:{N:"Cursor",C:"awareness",D:"Cursor position",P:{X:{N:"x",T:"number",D:"X coordinate",R:1},Y:{N:"y",T:"number",D:"Y coordinate",R:1}}},Selection:{N:"Selection",C:"awareness",D:"Text selection range",P:{A:{N:"anchor",T:"number",D:"Selection start",R:1},H:{N:"head",T:"number",D:"Selection end",R:1}}}},provider:{SyncMessageType:{N:"SyncMessageType",C:"provider",D:"Y.js sync message types",V:{Q:{N:"sync_request",D:"Request state vector",V:0},R:{N:"sync_response",D:"State diff response",V:1},U:{N:"update",D:"Incremental update",V:2},A:{N:"awareness",D:"Awareness update",V:3}}},SyncMessage:{N:"SyncMessage",C:"provider",D:"Y.js sync message",P:{T:{N:"type",T:"SyncMessageType",D:"Message type",R:1},F:{N:"from",T:"string",D:"Sender peer ID",R:1},D:{N:"data",T:"Uint8Array",D:"Encoded Y.js data",O:1}}},ProviderConfig:{N:"ProviderConfig",C:"provider",D:"Y.js provider config",P:{AI:{N:"awarenessInterval",T:"number",D:"Awareness broadcast interval",X:15e3},UD:{N:"updateDebounce",T:"number",D:"Update debounce (ms)",X:50}}}},room:{RoomState:{N:"RoomState",C:"room",D:"Collaborative room states",V:{D:{N:"disconnected",D:"Not connected",V:"disconnected"},C:{N:"connecting",D:"Connecting...",V:"connecting"},O:{N:"connected",D:"Connected",V:"connected"},Y:{N:"syncing",D:"Syncing state",V:"syncing"},S:{N:"synced",D:"Fully synced",V:"synced"}}},RoomMeta:{N:"RoomMeta",C:"room",D:"Room metadata",P:{ID:{N:"id",T:"string",D:"Room ID",R:1},N:{N:"name",T:"string",D:"Room name",O:1},O:{N:"owner",T:"string",D:"Owner peer ID",O:1},CR:{N:"created",T:"number",D:"Creation time",O:1}}},RoomUser:{N:"RoomUser",C:"room",D:"User in a room",P:{CI:{N:"clientId",T:"number",D:"Y.js client ID",R:1},N:{N:"name",T:"string",D:"Display name",O:1},C:{N:"color",T:"string",D:"User color",O:1},S:{N:"state",T:"PresenceState",D:"Presence",R:1},CR:{N:"cursor",T:"Cursor",D:"Cursor pos",O:1},LA:{N:"lastActive",T:"number",D:"Last activity",O:1}}}},persistence:{StoredDoc:{N:"StoredDoc",C:"persistence",D:"Persisted Y.js document",P:{ID:{N:"id",T:"string",D:"Document name",R:1},S:{N:"state",T:"number[]",D:"Encoded state (array)",R:1},LS:{N:"lastSync",T:"number",D:"Last sync time",R:1}}},OfflineItem:{N:"OfflineItem",C:"persistence",D:"Offline queue item",P:{ID:{N:"id",T:"number",D:"Item ID",R:1},TS:{N:"ts",T:"number",D:"Queue time",R:1},R:{N:"retries",T:"number",D:"Retry count",X:0},LR:{N:"lastRetry",T:"number",D:"Last retry time",O:1},S:{N:"synced",T:"boolean",D:"Was synced",X:!1},SA:{N:"syncedAt",T:"number",D:"Sync time",O:1}}},PersistenceConfig:{N:"PersistenceConfig",C:"persistence",D:"Persistence provider config",P:{SN:{N:"storeName",T:"string",D:"IndexedDB store",X:"rooms"},SD:{N:"saveDebounce",T:"number",D:"Save debounce (ms)",X:1e3}}}}},U$={signal:{SignalType:{N:"SignalType",C:"signal",D:"WebRTC signaling types",V:{O:{N:"offer",D:"SDP offer",V:"offer"},A:{N:"answer",D:"SDP answer",V:"answer"},C:{N:"candidate",D:"ICE candidate",V:"candidate"},R:{N:"renegotiate",D:"Renegotiation",V:"renegotiate"},X:{N:"close",D:"Close connection",V:"close"}}},SignalMessage:{N:"SignalMessage",C:"signal",D:"WebRTC signal message",P:{T:{N:"type",T:"SignalType",D:"Signal type",R:1},F:{N:"from",T:"string",D:"Sender peer ID",R:1},TO:{N:"to",T:"string",D:"Target peer ID",R:1},S:{N:"sdp",T:"string",D:"SDP data",O:1},C:{N:"candidate",T:"object",D:"ICE candidate",O:1},TS:{N:"ts",T:"number",D:"Timestamp",R:1}}}},rpc:{RPCMessageType:{N:"RPCMessageType",C:"rpc",D:"RPC message types",V:{Q:{N:"request",D:"RPC request",V:"request"},R:{N:"response",D:"RPC response",V:"response"},E:{N:"error",D:"Error response",V:"error"},N:{N:"notification",D:"No response needed",V:"notification"}}},RPCErrorCode:{N:"RPCErrorCode",C:"rpc",D:"JSON-RPC style error codes",V:{PE:{N:"parse_error",D:"Invalid JSON",V:-32700},IR:{N:"invalid_request",D:"Bad request",V:-32600},MNF:{N:"method_not_found",D:"Unknown method",V:-32601},IP:{N:"invalid_params",D:"Bad params",V:-32602},IE:{N:"internal_error",D:"Server error",V:-32603},TO:{N:"timeout",D:"Request timeout",V:-32e3},CN:{N:"cancelled",D:"Request cancelled",V:-32001}}},RPCRequest:{N:"RPCRequest",C:"rpc",D:"RPC request message",P:{T:{N:"type",T:"string",D:"Message type",R:1,X:"request"},ID:{N:"id",T:"string",D:"Request ID",R:1},M:{N:"method",T:"string",D:"Method name",R:1},P:{N:"params",T:"any",D:"Method params",O:1}}},RPCResponse:{N:"RPCResponse",C:"rpc",D:"RPC response message",P:{T:{N:"type",T:"string",D:"Message type",R:1},ID:{N:"id",T:"string",D:"Request ID",R:1},R:{N:"result",T:"any",D:"Method result",O:1},E:{N:"error",T:"RPCError",D:"Error if failed",O:1}}},RPCError:{N:"RPCError",C:"rpc",D:"RPC error object",P:{C:{N:"code",T:"number",D:"Error code",R:1},M:{N:"message",T:"string",D:"Error message",R:1},D:{N:"data",T:"any",D:"Extra data",O:1}}}},blob:{BlobMessageType:{N:"BlobMessageType",C:"blob",D:"Blob transfer message types",V:{Q:{N:"request",D:"Request blob",V:0},M:{N:"metadata",D:"Blob metadata",V:1},C:{N:"chunk",D:"Data chunk",V:2},A:{N:"ack",D:"Acknowledge",V:3},D:{N:"complete",D:"Transfer done",V:4},E:{N:"error",D:"Error",V:5},X:{N:"cancel",D:"Cancel transfer",V:6}}},TransferState:{N:"TransferState",C:"blob",D:"Blob transfer states",V:{P:{N:"pending",D:"Not started",V:"pending"},T:{N:"transferring",D:"In progress",V:"transferring"},C:{N:"complete",D:"Finished",V:"complete"},E:{N:"error",D:"Failed",V:"error"},X:{N:"cancelled",D:"Cancelled",V:"cancelled"}}},BlobMetadata:{N:"BlobMetadata",C:"blob",D:"Blob file metadata",P:{H:{N:"hash",T:"string",D:"SHA-256 hash",R:1},S:{N:"size",T:"number",D:"Size in bytes",R:1},N:{N:"name",T:"string",D:"File name",O:1},T:{N:"type",T:"string",D:"MIME type",O:1},C:{N:"chunks",T:"number",D:"Chunk count",R:1}}},BlobChunk:{N:"BlobChunk",C:"blob",D:"Blob data chunk",P:{T:{N:"type",T:"number",D:"Message type",R:1,X:2},I:{N:"index",T:"number",D:"Chunk index",R:1},D:{N:"data",T:"number[]",D:"Chunk data",R:1}}},TransferInfo:{N:"TransferInfo",C:"blob",D:"Active transfer info",P:{ID:{N:"id",T:"string",D:"Transfer ID",R:1},H:{N:"hash",T:"string",D:"Blob hash",R:1},P:{N:"peerId",T:"string",D:"Remote peer",R:1},S:{N:"state",T:"TransferState",D:"Current state",R:1},PR:{N:"progress",T:"number",D:"Progress 0-1",R:1},ST:{N:"startTime",T:"number",D:"Start time",R:1},ET:{N:"endTime",T:"number",D:"End time",O:1},ER:{N:"error",T:"string",D:"Error message",O:1}}}}},V$={isa95:{ISA95Level:{N:"ISA95Level",C:"isa95",D:"ISA-95 hierarchy levels",V:{L4:{N:"business",D:"Planning/ERP",V:4,X:"days-months"},L3:{N:"mom",D:"MES/Execution",V:3,X:"shifts-days"},L2:{N:"control",D:"Supervision",V:2,X:"sec-hours"},L1:{N:"sensing",D:"Direct Control",V:1,X:"ms-sec"},L0:{N:"process",D:"Physical",V:0,X:"continuous"}}},HierarchyNodeType:{N:"HierarchyNodeType",C:"isa95",D:"ISA-95 node types",V:{E:{N:"enterprise",D:"Top level",V:"enterprise"},S:{N:"site",D:"Plant/Facility",V:"site"},A:{N:"area",D:"Production area",V:"area"},WC:{N:"workcenter",D:"Process cell",V:"workcenter"},WU:{N:"workunit",D:"Unit",V:"workunit"},EQ:{N:"equipment",D:"Leaf node",V:"equipment"}}},HierarchyNode:{N:"HierarchyNode",C:"isa95",D:"ISA-95 hierarchy node",P:{ID:{N:"id",T:"string",D:"Node UUID",R:1},N:{N:"name",T:"string",D:"Node name",R:1},P:{N:"path",T:"string",D:"Full path",R:1},L:{N:"level",T:"ISA95Level",D:"ISA-95 level",R:1},T:{N:"type",T:"HierarchyNodeType",D:"Node type",O:1},S:{N:"state",T:"PackMLState",D:"Current state",R:1,X:"stopped"},M:{N:"mode",T:"EquipmentMode",D:"Operating mode",R:1,X:"automatic"},PR:{N:"props",T:"object",D:"Custom props",O:1}}}},packml:{PackMLState:{N:"PackMLState",C:"packml",D:"PackML equipment states",V:{ST:{N:"stopped",D:"Not running",V:"stopped"},ID:{N:"idle",D:"Ready to start",V:"idle"},SG:{N:"starting",D:"Starting up",V:"starting"},EX:{N:"execute",D:"Running",V:"execute"},CG:{N:"completing",D:"Finishing",V:"completing"},CP:{N:"complete",D:"Done",V:"complete"},RS:{N:"resetting",D:"Resetting",V:"resetting"},HG:{N:"holding",D:"Entering hold",V:"holding"},HD:{N:"held",D:"Held",V:"held"},UH:{N:"unholding",D:"Exiting hold",V:"unholding"},SP:{N:"stopping",D:"Stopping",V:"stopping"},AB:{N:"aborting",D:"Aborting",V:"aborting"},AD:{N:"aborted",D:"Aborted",V:"aborted"},CL:{N:"clearing",D:"Clearing",V:"clearing"}}},EquipmentMode:{N:"EquipmentMode",C:"packml",D:"Equipment operating modes",V:{P:{N:"production",D:"Normal production",V:"production"},M:{N:"maintenance",D:"Maintenance mode",V:"maintenance"},MN:{N:"manual",D:"Manual control",V:"manual"},A:{N:"automatic",D:"Auto control",V:"automatic"},S:{N:"semiauto",D:"Semi-automatic",V:"semiauto"}}}},sparkplug:{SparkplugMsgType:{N:"SparkplugMsgType",C:"sparkplug",D:"Sparkplug-style message types",V:{B:{N:"birth",D:"Node online",V:"BIRTH"},D:{N:"death",D:"Node offline",V:"DEATH"},DT:{N:"data",D:"Data update",V:"DATA"},C:{N:"cmd",D:"Command",V:"CMD"},S:{N:"state",D:"State change",V:"STATE"},A:{N:"alarm",D:"Alarm event",V:"ALARM"}}},Topic:{N:"Topic",C:"sparkplug",D:"Sparkplug topic structure",P:{NS:{N:"namespace",T:"string",D:"Topic namespace",R:1},G:{N:"group",T:"string",D:"Group/site ID",R:1},MT:{N:"msgType",T:"SparkplugMsgType",D:"Message type",R:1},P:{N:"path",T:"string",D:"Node path",R:1}},X:{format:"{namespace}/{group}/{msgType}/{path}"}},BirthMessage:{N:"BirthMessage",C:"sparkplug",D:"Node BIRTH message payload",P:{T:{N:"type",T:"string",D:"Message type",R:1,X:"BIRTH"},ID:{N:"id",T:"string",D:"Node ID",R:1},N:{N:"name",T:"string",D:"Node name",R:1},P:{N:"path",T:"string",D:"Full path",R:1},L:{N:"level",T:"ISA95Level",D:"ISA-95 level",R:1},S:{N:"state",T:"PackMLState",D:"Current state",R:1},M:{N:"mode",T:"EquipmentMode",D:"Operating mode",R:1},MT:{N:"metrics",T:"object",D:"Current metrics",O:1},AL:{N:"alarms",T:"object",D:"Active alarms",O:1},CH:{N:"children",T:"string[]",D:"Child names",O:1},PR:{N:"props",T:"object",D:"Custom props",O:1},TS:{N:"timestamp",T:"number",D:"Birth time",R:1}}}},alarm:{AlarmPriority:{N:"AlarmPriority",C:"alarm",D:"ISA-18.2 alarm priorities",V:{P1:{N:"emergency",D:"Immediate",V:1,X:{rt:"<1min",c:"#CC0000"}},P2:{N:"high",D:"Urgent",V:2,X:{rt:"<10min",c:"#FF6600"}},P3:{N:"medium",D:"Normal",V:3,X:{rt:"<1hr",c:"#FFCC00"}},P4:{N:"low",D:"Deferred",V:4,X:{rt:"Shift",c:"#00CCCC"}}}},AlarmState:{N:"AlarmState",C:"alarm",D:"Alarm acknowledgment states",V:{U:{N:"unack",D:"Unacknowledged",V:"UNACK"},A:{N:"acked",D:"Acknowledged",V:"ACKED"},C:{N:"clear",D:"Cleared",V:"CLEAR"}}},Alarm:{N:"Alarm",C:"alarm",D:"Active alarm",P:{ID:{N:"id",T:"string",D:"Alarm ID",R:1},M:{N:"message",T:"string",D:"Alarm text",R:1},P:{N:"priority",T:"AlarmPriority",D:"Priority level",R:1},S:{N:"state",T:"AlarmState",D:"Ack state",R:1},TS:{N:"timestamp",T:"number",D:"Raise time",R:1},AT:{N:"ackTime",T:"number",D:"Ack time",O:1},AU:{N:"ackUser",T:"string",D:"Ack user",O:1}}}},quality:{QualityCode:{N:"QualityCode",C:"quality",D:"OPC-UA style quality codes",V:{G:{N:"good",D:"Valid data",V:192},B:{N:"bad",D:"Invalid data",V:0},U:{N:"uncertain",D:"Suspect data",V:64}}},Value:{N:"Value",C:"quality",D:"Value with quality and timestamp",P:{V:{N:"v",T:"any",D:"Value",R:1},Q:{N:"q",T:"QualityCode",D:"Quality code",R:1,X:192},T:{N:"t",T:"number",D:"Timestamp",R:1},U:{N:"unit",T:"string",D:"Engineering unit",O:1}}}},mesh:{MeshNodeConfig:{N:"MeshNodeConfig",C:"mesh",D:"Mesh node configuration",P:{NS:{N:"namespace",T:"string",D:"Topic namespace",X:"kp2p"},G:{N:"group",T:"string",D:"Group/site ID",X:"default"}}},MeshPeer:{N:"MeshPeer",C:"mesh",D:"Connected mesh peer",P:{ID:{N:"id",T:"string",D:"Peer ID",R:1},S:{N:"status",T:"string",D:"Connection status",R:1},B:{N:"birthReceived",T:"boolean",D:"Got BIRTH",X:!1}}},MeshSubscription:{N:"MeshSubscription",C:"mesh",D:"Topic subscription",P:{T:{N:"topic",T:"string",D:"Full topic",R:1},P:{N:"peers",T:"string[]",D:"Subscribed peers",R:1}}},MeshCommand:{N:"MeshCommand",C:"mesh",D:"Mesh command types",V:{ST:{N:"start",D:"Start equipment",V:"start"},SP:{N:"stop",D:"Stop equipment",V:"stop"},RS:{N:"reset",D:"Reset equipment",V:"reset"},HD:{N:"hold",D:"Hold operation",V:"hold"},UH:{N:"unhold",D:"Release hold",V:"unhold"},AB:{N:"abort",D:"Emergency abort",V:"abort"},CL:{N:"clear",D:"Clear aborted",V:"clear"},SM:{N:"setMode",D:"Change mode",V:"setMode"},GM:{N:"getMetric",D:"Read metric",V:"getMetric"},SX:{N:"setMetric",D:"Write metric",V:"setMetric"},GS:{N:"getState",D:"Read state",V:"getState"},GB:{N:"getBirth",D:"Request BIRTH",V:"getBirth"},CP:{N:"compute",D:"Sandbox compute",V:"compute"}}},CmdRequest:{N:"CmdRequest",C:"mesh",D:"Command request payload",P:{P:{N:"path",T:"string",D:"Target node path",R:1},C:{N:"command",T:"MeshCommand",D:"Command type",R:1},PA:{N:"params",T:"object",D:"Command params",O:1}}},CmdResponse:{N:"CmdResponse",C:"mesh",D:"Command response payload",P:{S:{N:"success",T:"boolean",D:"Command succeeded",R:1},R:{N:"result",T:"any",D:"Result data",O:1},E:{N:"error",T:"string",D:"Error message",O:1}}}}},F$={web_fetch:{N:"web_fetch",D:"Fetch content from URL. Returns text/HTML.",C:"web",P:[{N:"url",T:"string",D:"URL to fetch",R:!0},{N:"headers",T:"object",D:"Request headers",R:!1}],R:{T:"object",D:"{url, content, status}"}},web_search:{N:"web_search",D:"Search the web. Returns results.",C:"web",P:[{N:"query",T:"string",D:"Search query",R:!0},{N:"limit",T:"integer",D:"Max results",R:!1,V:5}],R:{T:"array",D:"[{title, url, snippet}]"}},file_read:{N:"file_read",D:"Read file contents",C:"file",P:[{N:"path",T:"string",D:"File path",R:!0}],R:{T:"object",D:"{path, content, size}"}},file_write:{N:"file_write",D:"Write content to file",C:"file",P:[{N:"path",T:"string",D:"File path",R:!0},{N:"content",T:"string",D:"Content to write",R:!0},{N:"append",T:"boolean",D:"Append mode",R:!1,V:!1}],R:{T:"object",D:"{path, written, success}"}},file_list:{N:"file_list",D:"List files in directory",C:"file",P:[{N:"path",T:"string",D:"Directory path",R:!1,V:"/"}],R:{T:"object",D:"{path, items:[{name,type,size}]}"}},file_delete:{N:"file_delete",D:"Delete file or directory",C:"file",P:[{N:"path",T:"string",D:"Path to delete",R:!0}],R:{T:"object",D:"{path, deleted}"}},code_run:{N:"code_run",D:"Execute JavaScript code in sandbox",C:"code",P:[{N:"code",T:"string",D:"JS code to run",R:!0},{N:"timeout",T:"integer",D:"Timeout ms",R:!1,V:5e3}],R:{T:"object",D:"{result, type, logs}"}},code_eval:{N:"code_eval",D:"Evaluate expression (math/logic)",C:"code",P:[{N:"expr",T:"string",D:"Expression",R:!0}],R:{T:"object",D:"{result, type}"}},memory_get:{N:"memory_get",D:"Get value from persistent memory",C:"memory",P:[{N:"key",T:"string",D:"Key to retrieve",R:!0}],R:{T:"object",D:"{key, value, found}"}},memory_set:{N:"memory_set",D:"Store value in persistent memory",C:"memory",P:[{N:"key",T:"string",D:"Key to store",R:!0},{N:"value",T:"any",D:"Value to store",R:!0}],R:{T:"object",D:"{key, stored}"}},memory_list:{N:"memory_list",D:"List all memory keys",C:"memory",P:[],R:{T:"array",D:"[keys]"}},memory_clear:{N:"memory_clear",D:"Clear all memory",C:"memory",P:[{N:"prefix",T:"string",D:"Key prefix filter",R:!1}],R:{T:"object",D:"{cleared}"}},json_parse:{N:"json_parse",D:"Parse JSON string",C:"data",P:[{N:"text",T:"string",D:"JSON string",R:!0}],R:{T:"object",D:"{data, error}"}},json_stringify:{N:"json_stringify",D:"Convert to JSON string",C:"data",P:[{N:"data",T:"any",D:"Data to stringify",R:!0},{N:"pretty",T:"boolean",D:"Pretty print",R:!1,V:!1}],R:{T:"string",D:"JSON string"}},sys_time:{N:"sys_time",D:"Get current time",C:"system",P:[{N:"format",T:"string",D:"Format (iso|unix|local)",R:!1,V:"iso"}],R:{T:"string",D:"Formatted time"}},sys_info:{N:"sys_info",D:"Get system information",C:"system",P:[],R:{T:"object",D:"{platform, memory, gpu}"}},tag_read:{N:"tag_read",D:"Read tag value from UNS",C:"tag",P:[{N:"path",T:"string",D:"Tag path",R:!0}],R:{T:"object",D:"{path, value, quality, timestamp}"}},tag_write:{N:"tag_write",D:"Write tag value to UNS",C:"tag",P:[{N:"path",T:"string",D:"Tag path",R:!0},{N:"value",T:"any",D:"Value to write",R:!0}],R:{T:"object",D:"{path, written, quality}"}},tag_browse:{N:"tag_browse",D:"Browse tags at path",C:"tag",P:[{N:"path",T:"string",D:"Browse path",R:!1,V:"/"}],R:{T:"object",D:"{path, tags:[{name, type, hasChildren}]}"}},udt_create:{N:"udt_create",D:"Create UDT instance",C:"tag",P:[{N:"type",T:"string",D:"UDT type name",R:!0},{N:"path",T:"string",D:"Tag path",R:!0},{N:"values",T:"object",D:"Initial values",R:!1}],R:{T:"object",D:"{path, type, created}"}}};function z$(e,t,s=null){return s?{I:t?.id||Date.now().toString(),S:!1,E:s.message||String(s)}:{I:t?.id||Date.now().toString(),S:!0,D:t}}class $${constructor(){this.tools=new Map,this.handlers=new Map}register(e,t){const s=e.N;return this.tools.set(s,e),this.handlers.set(s,t),this}registerAll(e,t){for(const[s,r]of Object.entries(e))t[s]&&this.register(r,t[s]);return this}async execute(e,t){const s=this.handlers.get(e);if(!s)return z$(0,null,new Error(`Unknown tool: ${e}`));try{return z$(0,await s(t))}catch(e){return z$(0,null,e)}}getTools(){return Object.fromEntries(this.tools)}getPrompt(e){return function(e=F$,t={}){const{format:s="full",categories:r=null}=t;let n=Object.values(e);if(r&&(n=n.filter(e=>r.includes(e.C))),"mini"===s)return n.map(e=>{const t=e.P.map(e=>`${e.N}${e.R?"*":"?"}:${e.T}`).join(",");return`${e.N}(${t}): ${e.D}`}).join("\n");let i="Available tools:\n\n";for(const e of n){i+=`### ${e.N}\n`,i+=`${e.D}\n`,i+="Parameters:\n";for(const t of e.P){const e=t.R?"(required)":`(optional, default: ${t.V??"null"})`;i+=`- ${t.N} (${t.T}): ${t.D} ${e}\n`}i+=`Returns: ${e.R.D}\n\n`}return i+='\nTo call a tool, use this format:\n```tool\n{"T":"tool_name","P":{"param1":"value1"}}\n```\n\nAfter a tool returns, continue your response based on the result.\n',i}(this.getTools(),e)}}const q$={flex:"ia.container.flex",coord:"ia.container.coord",col:"ia.container.column",row:"ia.container.row",tab:"ia.container.tab",split:"ia.container.split",dock:"ia.container.docked",card:"ia.container.card",scroll:"ia.container.scroll",tf:"ia.input.text-field",ta:"ia.input.text-area",num:"ia.input.numeric-entry",dd:"ia.input.dropdown",cb:"ia.input.checkbox",rb:"ia.input.radio",tog:"ia.input.toggle",dt:"ia.input.datetime-picker",sl:"ia.input.slider",file:"ia.input.file-upload",lbl:"ia.display.label",img:"ia.display.image",icon:"ia.display.icon",md:"ia.display.markdown",html:"ia.display.html",pdf:"ia.display.pdf-viewer",prog:"ia.display.progress-bar",led:"ia.display.led-display",spark:"ia.display.sparkline",video:"ia.display.video",xy:"ia.chart.xy-chart",pie:"ia.chart.pie-chart",bar:"ia.chart.bar-chart",ts:"ia.chart.time-series",gauge:"ia.chart.gauge",tbl:"ia.display.table",pwr:"ia.display.power-table",tree:"ia.display.tree",btn:"ia.navigation.button",link:"ia.navigation.link",menu:"ia.navigation.menu",tabs:"ia.navigation.tab-strip",bread:"ia.navigation.breadcrumb",view:"ia.display.view",popup:"ia.display.popup",iframe:"ia.display.iframe"};Object.fromEntries(Object.entries(q$).map(([e,t])=>[t,e]));const W$={D:"display",W:"width",H:"height",P:"padding",M:"margin",FD:"flexDirection",JC:"justifyContent",AI:"alignItems",FW:"flexWrap",G:"gap",BG:"backgroundColor",C:"color",BC:"borderColor",B:"border",BR:"borderRadius",BS:"boxShadow",FS:"fontSize",FT:"fontWeight",FF:"fontFamily",TA:"textAlign",O:"overflow",OP:"opacity",CUR:"cursor",TR:"transition",POS:"position",T:"top",L:"left",R:"right",BT:"bottom",Z:"zIndex",MH:"minHeight",MW:"minWidth",XH:"maxHeight",XW:"maxWidth"};Object.fromEntries(Object.entries(W$).map(([e,t])=>[t,e]));const K$={N:"CallState",C:"phone",D:"Phone call states",V:{ID:{N:"idle",D:"No active call",V:"idle"},DL:{N:"dialing",D:"Outgoing call",V:"dialing"},RG:{N:"ringing",D:"Incoming call",V:"ringing"},CN:{N:"connecting",D:"Setting up call",V:"connecting"},AC:{N:"active",D:"Call in progress",V:"active"},HD:{N:"hold",D:"Call on hold",V:"hold"},ED:{N:"ended",D:"Call ended",V:"ended"},FL:{N:"failed",D:"Call failed",V:"failed"}}},j$={N:"CallType",C:"phone",D:"Types of calls",V:{V:{N:"voice",D:"Voice only",V:"voice"},VD:{N:"video",D:"Video call",V:"video"},EM:{N:"emergency",D:"Emergency call",V:"emergency"},CF:{N:"conference",D:"Multi-party",V:"conference"}}},H$={N:"CallDirection",C:"phone",D:"Call direction",V:{I:{N:"incoming",D:"Received call",V:"incoming"},O:{N:"outgoing",D:"Made call",V:"outgoing"},M:{N:"missed",D:"Missed call",V:"missed"}}},G$={N:"CallEndReason",C:"phone",D:"Why call ended",V:{HU:{N:"hangup",D:"Normal hangup",V:"hangup"},RJ:{N:"rejected",D:"Call rejected",V:"rejected"},BS:{N:"busy",D:"Line busy",V:"busy"},NA:{N:"no_answer",D:"No answer",V:"no_answer"},NE:{N:"network_error",D:"Network failed",V:"network_error"},TO:{N:"timeout",D:"Timed out",V:"timeout"}}},Q$={N:"CallRecord",C:"phone",D:"Call history entry",P:{ID:{N:"id",T:"string",D:"Call ID",R:1},T:{N:"type",T:"CallType",D:"Call type",R:1},D:{N:"direction",T:"CallDirection",D:"Direction",R:1},S:{N:"state",T:"CallState",D:"Final state",R:1},P:{N:"peerId",T:"string",D:"Remote peer",R:1},PN:{N:"peerNumber",T:"string",D:"Phone number",O:1},PNM:{N:"peerName",T:"string",D:"Display name",O:1},ST:{N:"startTime",T:"number",D:"Start timestamp",R:1},CT:{N:"connectTime",T:"number",D:"Connect time",O:1},ET:{N:"endTime",T:"number",D:"End timestamp",O:1},DR:{N:"duration",T:"number",D:"Duration (sec)",O:1},ER:{N:"endReason",T:"CallEndReason",D:"End reason",O:1}}},X$={N:"ActiveCall",C:"phone",D:"Currently active call",P:{ID:{N:"id",T:"string",D:"Call ID",R:1},T:{N:"type",T:"CallType",D:"Call type",R:1},D:{N:"direction",T:"CallDirection",D:"Direction",R:1},S:{N:"state",T:"CallState",D:"Current state",R:1},P:{N:"peerId",T:"string",D:"Remote peer",R:1},PN:{N:"peerNumber",T:"string",D:"Phone number",O:1},PNM:{N:"peerName",T:"string",D:"Display name",O:1},M:{N:"muted",T:"boolean",D:"Is muted",X:!1},SP:{N:"speaker",T:"boolean",D:"Speaker on",X:!1},VD:{N:"video",T:"boolean",D:"Video enabled",X:!1},ST:{N:"startTime",T:"number",D:"Start timestamp",R:1}}},Y$={N:"Contact",C:"phone",D:"Phone contact",P:{ID:{N:"id",T:"string",D:"Contact ID",R:1},N:{N:"name",T:"string",D:"Display name",R:1},P:{N:"peerId",T:"string",D:"Mesh peer ID",O:1},PN:{N:"phoneNumber",T:"string",D:"Phone number",O:1},AV:{N:"avatar",T:"string",D:"Avatar URL",O:1},ON:{N:"online",T:"boolean",D:"Is online",X:!1},LS:{N:"lastSeen",T:"number",D:"Last seen time",O:1},F:{N:"favorite",T:"boolean",D:"Is favorite",X:!1},B:{N:"blocked",T:"boolean",D:"Is blocked",X:!1}}},J$={N:"Route",C:"mesh",D:"Network route to peer",P:{T:{N:"target",T:"string",D:"Target peer ID",R:1},NH:{N:"nextHop",T:"string",D:"Next hop peer",R:1},H:{N:"hops",T:"number",D:"Hop count",R:1},P:{N:"path",T:"string[]",D:"Full path",O:1},TS:{N:"timestamp",T:"number",D:"Route timestamp",R:1},Q:{N:"quality",T:"number",D:"Link quality 0-1",O:1}}},Z$={N:"MeshPeer",C:"mesh",D:"Connected mesh peer",P:{ID:{N:"id",T:"string",D:"Peer ID",R:1},N:{N:"name",T:"string",D:"Display name",O:1},T:{N:"transport",T:"string",D:"Transport type",O:1},CT:{N:"connectedAt",T:"number",D:"Connect time",R:1},LS:{N:"lastSeen",T:"number",D:"Last seen",R:1},Q:{N:"quality",T:"number",D:"Signal quality",O:1}}},eq={N:"AudioCodec",C:"codec",D:"Audio codec config",V:{OP:{N:"opus",D:"Opus (best)",V:"opus",X:{rate:48e3,ch:2,br:32e3}},G7:{N:"g722",D:"G.722 HD",V:"G722",X:{rate:16e3,ch:1,br:64e3}},PC:{N:"pcmu",D:"G.711 uLaw",V:"PCMU",X:{rate:8e3,ch:1,br:64e3}}}},tq={N:"VideoCodec",C:"codec",D:"Video codec config",V:{V8:{N:"vp8",D:"VP8",V:"VP8",X:{w:640,h:480,fps:30}},V9:{N:"vp9",D:"VP9 HD",V:"VP9",X:{w:1280,h:720,fps:30}},H4:{N:"h264",D:"H.264",V:"H264",X:{w:1920,h:1080,fps:30}}}},sq={N:"CellSignal",C:"signal",D:"Cell signaling message types",V:{CO:{N:"call_offer",D:"Outgoing call",V:"call:offer"},CA:{N:"call_answer",D:"Accept call",V:"call:answer"},CR:{N:"call_reject",D:"Reject call",V:"call:reject"},CH:{N:"call_hangup",D:"End call",V:"call:hangup"},CB:{N:"call_busy",D:"Line busy",V:"call:busy"},CHL:{N:"call_hold",D:"Put on hold",V:"call:hold"},CRS:{N:"call_resume",D:"Resume call",V:"call:resume"},IC:{N:"ice_candidate",D:"ICE candidate",V:"ice:candidate"},SO:{N:"sdp_offer",D:"SDP offer",V:"sdp:offer"},SA:{N:"sdp_answer",D:"SDP answer",V:"sdp:answer"},RQ:{N:"route_request",D:"Find route",V:"route:request"},RP:{N:"route_reply",D:"Route found",V:"route:reply"},RE:{N:"route_error",D:"Route failed",V:"route:error"}}},rq={N:"CallOffer",C:"signal",D:"Outgoing call offer",P:{T:{N:"type",T:"string",D:"Signal type",R:1,X:"call:offer"},CI:{N:"callId",T:"string",D:"Call ID",R:1},CT:{N:"callType",T:"CallType",D:"Call type",R:1},F:{N:"from",T:"string",D:"Caller peer ID",R:1},FN:{N:"fromNumber",T:"string",D:"Caller number",O:1},FNM:{N:"fromName",T:"string",D:"Caller name",O:1},SDP:{N:"sdp",T:"string",D:"SDP offer",R:1}}},nq={N:"DialpadKey",C:"ui",D:"Dialpad key info",V:{K1:{N:"1",D:"",V:"1"},K2:{N:"2",D:"ABC",V:"2"},K3:{N:"3",D:"DEF",V:"3"},K4:{N:"4",D:"GHI",V:"4"},K5:{N:"5",D:"JKL",V:"5"},K6:{N:"6",D:"MNO",V:"6"},K7:{N:"7",D:"PQRS",V:"7"},K8:{N:"8",D:"TUV",V:"8"},K9:{N:"9",D:"WXYZ",V:"9"},KS:{N:"*",D:"",V:"*"},K0:{N:"0",D:"+",V:"0"},KH:{N:"#",D:"",V:"#"}}},iq={N:"PhoneView",C:"ui",D:"Phone UI views",V:{DP:{N:"dialpad",D:"Number entry",V:"dialpad"},CT:{N:"contacts",D:"Contact list",V:"contacts"},RC:{N:"recent",D:"Call history",V:"recent"},MS:{N:"mesh",D:"Network status",V:"mesh"},AC:{N:"active_call",D:"In-call screen",V:"active_call"},IC:{N:"incoming",D:"Incoming call",V:"incoming"}}},oq={call:{CallState:K$,CallType:j$,CallDirection:H$,CallEndReason:G$,CallRecord:Q$,ActiveCall:X$},contact:{Contact:Y$},mesh:{Route:J$,MeshPeer:Z$},codec:{AudioCodec:eq,VideoCodec:tq},signal:{CellSignal:sq,CallOffer:rq},ui:{DialpadKey:nq,PhoneView:iq}};var aq=Object.freeze({__proto__:null,ACTIVE_CALL_UDT:X$,AUDIO_CODEC_UDT:eq,CALL_DIRECTION_UDT:H$,CALL_END_REASON_UDT:G$,CALL_OFFER_UDT:rq,CALL_RECORD_UDT:Q$,CALL_STATE_UDT:K$,CALL_TYPE_UDT:j$,CELL_SIGNAL_UDT:sq,CONTACT_UDT:Y$,DIALPAD_KEY_UDT:nq,MESH_PEER_UDT:Z$,PHONE_VIEW_UDT:iq,ROUTE_UDT:J$,TELEPHONY_UDTS:oq,VIDEO_CODEC_UDT:tq,default:oq});const cq={os:"../../os/udts.js",core:"../../core/udts.js",network:"../../network/udts.js",p2p:"../../p2p/udts.js",sync:"../../sync/udts.js",protocols:"../../protocols/udts.js",enterprise:"../../enterprise/udts.js",widgets:"../../widgets/udts.js"},lq={llm:{path:"../../llm/tools-udt.js",exportName:"TOOLS"},graphics:{path:"../graphics/udts.js",exports:["TYPE_MAP","STYLE_MAP","SHORTCODES"]}},hq={},uq=new Map;async function dq(e,t){try{const s=await import(t),r=s[`${e.toUpperCase()}_UDTS`]||s.default||s;return uq.set(e,{path:t,udts:r,loaded:!0}),r}catch(s){return console.warn(`[UDT] Failed to load ${e} from ${t}:`,s.message),uq.set(e,{path:t,error:s.message,loaded:!1}),null}}async function pq(){const e=[];for(const[t,s]of Object.entries(cq))e.push(dq(t,s).then(e=>{e&&(hq[t]=e)}));for(const[t,s]of Object.entries(lq))e.push(import(s.path).then(e=>{if(s.exports){hq[t]={};for(const r of s.exports)e[r]&&(hq[t][r]=e[r])}else hq[t]=e[s.exportName]||e.default;uq.set(t,{path:s.path,loaded:!0})}).catch(e=>{console.warn(`[UDT] Failed to load ${t}:`,e.message),uq.set(t,{path:s.path,error:e.message,loaded:!1})}));return await Promise.allSettled(e),hq}function fq(){return Object.fromEntries(uq)}function gq(e,t){hq[e]=t,uq.set(e,{runtime:!0,loaded:!0})}let mq=null;try{mq=await Promise.resolve().then(function(){return aq})}catch(tl){}function yq(e){const t=e.split(".");let s=hq;for(const e of t){if(!s||"object"!=typeof s)return null;s=s[e]}return s}function bq(e=null){const t=[];function s(e,r=""){for(const[n,i]of Object.entries(e)){const e=r?`${r}.${n}`:n;i&&"object"==typeof i&&i.N&&i.C&&i.D?t.push(e):i&&"object"==typeof i&&!Array.isArray(i)&&s(i,e)}}return e&&hq[e]?s(hq[e],e):e||s(hq),t}function wq(){return Object.keys(hq)}function vq(e,t={}){const s=[],r=e.toLowerCase();return function e(t,n=""){for(const[i,o]of Object.entries(t)){const t=n?`${n}.${i}`:i;if(o&&"object"==typeof o&&o.N&&o.C&&o.D){const e=o.N.toLowerCase().includes(r),n=o.D.toLowerCase().includes(r),i=o.C.toLowerCase().includes(r);(e||n||i)&&s.push({path:t,udt:o,matchType:e?"name":n?"description":"category"})}else o&&"object"==typeof o&&!Array.isArray(o)&&e(o,t)}}(hq),s.sort((e,t)=>"name"===e.matchType&&"name"!==t.matchType?-1:"name"!==e.matchType&&"name"===t.matchType?1:0),t.limit?s.slice(0,t.limit):s}function Sq(e){const t={name:e.N,category:e.C,description:e.D};if(e.V){t.values={};for(const[s,r]of Object.entries(e.V))t.values[r.N]={shortcode:s,description:r.D,value:r.V}}if(e.P){t.properties={};for(const[s,r]of Object.entries(e.P))t.properties[r.N]={shortcode:s,type:r.T,description:r.D,required:!!r.R,default:r.X}}return e.X&&(t.constants=e.X),t}function Eq(e,t){if(!t.P)return e;const s={};for(const[r,n]of Object.entries(t.P))void 0!==e[n.N]&&(s[r]=e[n.N]);return s}function Dq(e,t){if(!t.P)return e;const s={};for(const[r,n]of Object.entries(t.P))void 0!==e[r]&&(s[n.N]=e[r]);return s}function _q(e,t){const s=[];if(t.P)for(const[r,n]of Object.entries(t.P)){const t=e[n.N]??e[r];n.R&&void 0===t&&s.push(`Missing required property: ${n.N} (${r})`)}return{valid:0===s.length,errors:s}}function Tq(e,t){return e.V?.[t]?.V}function Iq(e,t){for(const[s,r]of Object.entries(e.V||{}))if(r.V===t)return s;return null}function Cq(e){return e.V?Object.values(e.V).map(e=>e.V):[]}function Pq(e){return e.P?Object.values(e.P).map(e=>e.N):[]}function xq(e){if(!e.P)return{};const t={};for(const[,s]of Object.entries(e.P))void 0!==s.X&&(t[s.N]=s.X);return t}function Aq(e,t={}){const s=Sq(e);let r="";if(r+=`## ${s.name}\n\n`,r+=`**Category:** ${s.category}\n\n`,r+=`${s.description}\n\n`,s.values){r+="### Values\n\n",r+="| Shortcode | Name | Value | Description |\n",r+="|-----------|------|-------|-------------|\n";for(const[e,t]of Object.entries(s.values))r+=`| \`${t.shortcode}\` | ${e} | \`${t.value}\` | ${t.description} |\n`;r+="\n"}if(s.properties){r+="### Properties\n\n",r+="| Shortcode | Name | Type | Required | Default | Description |\n",r+="|-----------|------|------|----------|---------|-------------|\n";for(const[e,t]of Object.entries(s.properties)){const s=t.required?"âœ“":"",n=void 0!==t.default?`\`${JSON.stringify(t.default)}\``:"";r+=`| \`${t.shortcode}\` | ${e} | ${t.type} | ${s} | ${n} | ${t.description} |\n`}r+="\n"}return r}function kq(e){const t=hq[e];if(!t)return"";let s=`# ${e.toUpperCase()} UDTs\n\n`;return function e(t,r=""){for(const[n,i]of Object.entries(t))i&&"object"==typeof i&&i.N&&i.C&&i.D?(s+=Aq(i),s+="---\n\n"):i&&"object"==typeof i&&!Array.isArray(i)&&(r&&(s+=`## ${n}\n\n`),e(i,n))}(t),s}hq.os=R$||R$,hq.core=M$||M$,hq.network=L$||L$,hq.p2p=O$||O$,hq.sync=B$||B$,hq.protocols=U$||U$,hq.enterprise=V$||V$,hq.llm={tools:F$},hq.graphics={TYPE_MAP:q$,STYLE_MAP:W$,SHORTCODES:void 0},mq&&(hq.widgets=mq.TELEPHONY_UDTS||mq.default);const Nq=hq.os,Rq=hq.core,Mq=hq.network,Lq=hq.p2p,Oq=hq.sync,Bq=hq.protocols,Uq=hq.enterprise,Vq=hq.llm?.tools,Fq=hq.widgets,{TYPE_MAP:zq,STYLE_MAP:$q,SHORTCODES:qq}=hq.graphics||{};export{qz as ALARM_PRIORITY,uM as AUDIO_CODEC,Qz as Area,NM as AudioModemAdapter,dz as AwarenessManager,Xe as BOOTSTRAP_PEERS,_$ as BackgroundSyncManager,mk as BandwidthEstimator,Pz as BlobMessageType,kz as BlobProtocol,Kt as BlobStore,lM as CALL_END_REASON,aM as CALL_STATE,mM as CALL_STATUS,cM as CALL_TYPE,hM as CELL_SIGNAL,Rq as CORE_UDTS,v$ as CanvasAdapter,pM as CellNode,Nz as ChunkedReader,gk as ConnectionQuality,T$ as ConnectionStatus,Ek as ConnectionStrategy,S$ as ContentEditableAdapter,y$ as CookieInterceptor,pz as CursorOverlay,bk as DiscoveryManager,Uq as ENTERPRISE_UDTS,Hz as Enterprise,n$ as EnterpriseMesh,Jz as Equipment,Lz as ErrorCode,g$ as FetchInterceptor,w$ as FormAdapter,PM as FreeCommMessage,MM as FreeCommNode,jz as HierarchyNode,m$ as HistoryInterceptor,Tk as ICEManager,Xt as Identity,Yt as IdentityManager,yz as IndexedDBPersistence,vt as KeyPair,EM as KonoTel,p$ as KonomiP2P,az as KonomiP2PProvider,Uz as LEVEL,Vq as LLM_TOOLS,Wt as LRUCache,E$ as ListAdapter,kM as LoRaAdapter,zz as MODE,$z as MSG,CM as MSG_TYPE,fM as MeshCellNetwork,r$ as MeshNode,oz as MessageType,_k as NATManager,Dk as NATType,Mq as NETWORK_UDTS,I$ as NetworkQuality,Nq as OS_UDTS,bz as OfflineQueue,ik as P2PNode,Lq as P2P_UDTS,IM as PRIORITY,Ye as PROTOCOLS,Bq as PROTOCOL_UDTS,Tt as PeerInfo,It as PeerStore,lz as PresenceState,Wz as QUALITY,Bz as RPCClient,Mz as RPCError,Rz as RPCMessageType,Oz as RPCProtocol,Ez as RTCNegotiator,Sk as RelayManager,vk as ReservationStatus,gz as Room,wk as RoomDiscovery,mz as RoomManager,fz as RoomState,qq as SHORTCODES,wM as SIPClient,bM as SIP_PROVIDERS,AM as SMSAdapter,vM as SMSGateway,yM as SMS_STATUS,Vz as STATE,$q as STYLE_MAP,Oq as SYNC_UDTS,Sz as SignalManager,vz as SignalType,Gz as Site,Cz as StateVectorUtils,f$ as StorageInterceptor,qt as Store,RM as StoreAndForward,wz as SyncManager,Dz as SyncMessageType,Iz as SyncProtocol,Fq as TELEPHONY_UDTS,Je as TOPICS,Fz as TRANSITIONS,_M as TRANSPORT,TM as TRANSPORT_CAPS,zq as TYPE_MAP,$$ as ToolRegistry,xz as TransferState,xM as TransportAdapter,yk as TransportManager,lk as TransportType,hq as UDT_REGISTRY,hz as USER_COLORS,dM as VIDEO_CODEC,SM as VoiceML,Xz as WorkCenter,Yz as WorkUnit,ZV as YArray,wU as YDoc,tF as YMap,yF as YText,D$ as createAdapters,it as createConfig,xq as createDefault,Zz as createExampleHierarchy,b$ as createInterceptors,DM as createKonoTelAPI,nk as createNode,St as createPeerId,cz as createRoomProvider,t$ as createTopic,Kz as createValue,ut as decrypt,u$ as default,ct as deriveSharedSecret,ht as encrypt,Dq as expand,Sq as expandUDT,_t as fromBase58,yt as fromBase64,wt as fromHex,at as generateBoxKeyPair,Aq as generateDocs,kq as generateDomainDocs,ot as generateSigningKeyPair,Gt as getBlobStore,k$ as getConnectionStatus,Iq as getEnumShortcode,Tq as getEnumValue,Cq as getEnumValues,Zt as getIdentityManager,fq as getLoadStatus,N$ as getNetworkQuality,ak as getNode,Pq as getPropertyNames,uz as getRandomColor,Ht as getStore,A$ as getSyncManager,uk as getTransportType,yq as getUDT,ft as hash,u$ as injectP2P,a$ as injectStatusUI,dk as isRelayAddr,pk as isWebRTCAddr,fk as isWebSocketAddr,wq as listDomains,bq as listUDTs,pq as loadAllUDTs,es as loadIdentity,Eq as minify,hk as parseMultiaddr,s$ as parseTopic,gt as randomBytes,gq as registerModule,c$ as removeStatusUI,vq as searchUDTs,h$ as showModal,l$ as showToast,dt as sign,ck as startNode,Dt as toBase58,mt as toBase64,bt as toHex,_q as validate,pt as verify};
//# sourceMappingURL=konomi-p2p.min.js.map
